!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@syncfusion/ej2-base"),require("@syncfusion/ej2-popups"),require("@syncfusion/ej2-inputs"),require("@syncfusion/ej2-navigations"),require("@syncfusion/ej2-buttons"),require("@syncfusion/ej2-splitbuttons")):"function"==typeof define&&define.amd?define(["exports","@syncfusion/ej2-base","@syncfusion/ej2-popups","@syncfusion/ej2-inputs","@syncfusion/ej2-navigations","@syncfusion/ej2-buttons","@syncfusion/ej2-splitbuttons"],t):t((e=e||self).ej={},e.ej2Base,e.ej2Popups,e.ej2Inputs,e.ej2Navigations,e.ej2Buttons,e.ej2Splitbuttons)}(this,function(m,T,f,g,c,X,v){"use strict";e.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},e.prototype.addEventListener=function(){this.parent.on("crop",this.cropping,this),this.parent.on("destroyed",this.destroy,this)},e.prototype.removeEventListener=function(){this.parent.off("crop",this.cropping),this.parent.off("destroyed",this.destroy)},e.prototype.cropping=function(e){switch(this.updateCropPvtVar(),e.prop){case"cropCircle":this.cropCircle(e.value.context,e.value.isSave,e.value.isFlip);break;case"setCurrSelPoints":this.setCurrSelPoints(e.value.isSetDimension);break;case"updateRotatePan":this.updateRotatePan();break;case"crop":this.crop(e.value.obj);break;case"calcRatio":this.calcRatio(e.value.obj,e.value.dimension);break;case"getCurrFlipState":this.getCurrFlipState(e.value.panObj);break;case"getPreviousCropCurrentObj":e.value.obj.prevObj=this.prevCropCurrObj;break;case"setPreviousCropCurrentObj":this.prevCropCurrObj=e.value.obj;break;case"setCropDestPoints":this.cropDestPoints=e.value.point;break;case"getTempFlipPanPoint":e.value.obj.point=this.tempFlipPanPoint;break;case"setTempFlipPanPoint":T.isNullOrUndefined(e.value.isAdd)?this.tempFlipPanPoint=e.value.point:(this.tempFlipPanPoint.x+=e.value.point.x,this.tempFlipPanPoint.y+=e.value.point.y);break;case"getPreventScaling":e.value.obj.bool=this.isPreventScaling;break;case"adjustStraightenForShapes":this.adjustStraightenForShapes(e.value.type,e.value.isInitialRotated);break;case"resizeWrapper":this.resizeWrapper();break;case"setTransformCrop":this.isTransformCrop=e.value.bool;break;case"setInitCrop":this.isInitCrop=e.value.bool;break;case"resetZoom":this.resetZoom();break;case"revertTransform":this.revertTransform(e.value.type,e.value.coll);break;case"reset":this.reset()}},e.prototype.getModuleName=function(){return"crop"},e.prototype.updateCropPvtVar=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d"))},e.prototype.reset=function(){this.prevCropCurrObj=null,this.croppedDegree=0,this.cropDestPoints={startX:0,startY:0,width:0,height:0},this.tempFlipPanPoint={x:0,y:0},this.isPreventScaling=!1,this.isInitCrop=!1,this.isTransformCrop=!1},e.prototype.cropImg=function(e){for(var t,o=this.parent,i=T.isNullOrUndefined(e),r=o.element.querySelector("#"+o.element.id+"_nonaspectratio"),n=o.activeObj.activePoint,a=o.img,s=!1,l=0,p=o.rotateFlipColl.length;l<p;l++){var h=o.rotateFlipColl[l];90!==h&&-90!==h||(s=!0)}o.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),(i||r)&&(this.croppedDegree=o.transform.degree),i&&0!==o.transform.degree||s?(this.updateCropObj(),t={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight},o.notify("transform",{prop:"setCurrDestinationPoint",onPropertyChange:!1,value:{point:t}}),this.rotateCrop()):i&&""!==o.transform.currFlipState?(this.updateCropObj(),t={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight},o.notify("transform",{prop:"setCurrDestinationPoint",onPropertyChange:!1,value:{point:t}}),this.flipCrop()):(this.adjustStraightenForShapes("initial",!1),o.notify("draw",{prop:"setTempZoomFactor",onPropertyChange:!1,value:{tempZoomFactor:o.transform.zoomFactor}}),r=this.calcRatio(),!i&&e||(this.updateCropObj(),o.notify("draw",{prop:"resetPanPoints",onPropertyChange:!1}),o.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight},o.notify("transform",{prop:"setCurrDestinationPoint",onPropertyChange:!1,value:{point:t}}),o.currSelectionPoint=T.extend({},o.activeObj,{},!0),this.cropDestPoints={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight}),o.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!(i={width:0,height:0}),value:{width:n.width*r.width,height:n.height*r.height,obj:i,isImgShape:null}}),e=i,this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),o.img={srcLeft:n.startX*r.width-a.destLeft*r.width,srcTop:n.startY*r.height-a.destTop*r.height,srcWidth:n.width*r.width,srcHeight:n.height*r.height,destLeft:(o.lowerCanvas.clientWidth-e.width)/2,destTop:(o.lowerCanvas.clientHeight-e.height+1)/2,destWidth:e.width,destHeight:e.height},t=this.lowerContext.filter,o.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter="none",i=T.extend({},o.activeObj,{},!0),this.cropObjColl(),o.transform.straighten=0,o.activeObj=i,this.cropFreehandDrawColl(),o.shapeColl=[],o.notify("shape",{prop:"updateShapeColl",onPropertyChange:!1}),o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),o.currSelectionPoint&&"crop-circle"===o.currSelectionPoint.shape?this.cropCircle(this.lowerContext):o.isCircleCrop=!1,this.lowerContext.filter=t,o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),o.currObjType.isCustomCrop=!1,o.pan(!1),o.transform.defaultZoomFactor=0)},e.prototype.adjustStraightenForShapes=function(e,t){for(var o=this.parent,i=o.img.destLeft+o.img.destWidth/2,r=o.img.destTop+o.img.destHeight/2,n=0,a=o.objColl;n<a.length;n++){var s,l,p,h,d,c,u,g,v=a[n];-1===["rectangle","ellipse","text","image","redact"].indexOf(v.shape)||!t&&0===v.rotatedAngle||(s=(u=v.activePoint).startX,g=u.startY,l=u.width,u=u.height,c="initial"===e?v.rotatedAngle:-v.rotatedAngle,p=s+l/2-i,h=g+u/2-r,d=Math.cos(c),g=(c=Math.sin(c))*p+d*h+r-g-u/2,v.activePoint.startX+=u=d*p-c*h+i-s-l/2,v.activePoint.startY+=g,v.activePoint.endX+=u,v.activePoint.endY+=g)}},e.prototype.updateCropObj=function(){this.parent.afterCropActions=[];var e={currObj:{}},e=(this.parent.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:e}}),e.currObj);e.straighten=this.parent.transform.straighten,this.parent.cropObj=T.extend({},e,{},!0)},e.prototype.rotateCrop=function(){for(var e,t=this.parent,o=this.getCurrFlipState(),i=t.activeObj.shape||"",r=(t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t.currSelectionPoint=T.extend({},t.activeObj,{},!0),t.objColl.push(t.activeObj),t.activeObj=T.extend({},t.objColl[t.objColl.length-1],{},!0),T.extend({},t.objColl[t.objColl.length-1],{},!0),T.extend({},t.currSelectionPoint,{},!0)),n={bool:null},a=(t.notify("transform",{prop:"getPreventSelect",onPropertyChange:!1,value:{obj:n}}),t.notify("transform",{prop:"setPreventSelect",onPropertyChange:!1,value:{bool:!0}}),T.extend([],t.rotateFlipColl,[],!0)),s=(this.panToSelRangle(!0),e=T.extend({},t.objColl[t.objColl.length-1],{},!0),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:e}}),t.objColl.pop(),t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl.push(t.activeObj),t.transform.straighten),l=(0!==s&&(t.transform.straighten=0,t.straightenBaseImageCanvas(),t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}})),this.resetZoom(),T.extend([],t.afterCropActions,[],!0)),p=(this.revertTransform("initial",a),0!==s&&(t.transform.straighten="horizontal"===o||"vertical"===o?-s:s,t.straightenBaseImageCanvas(),t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),t.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}})),e=T.extend({},t.objColl[t.objColl.length-1],{},!0),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:e}}),t.objColl.pop(),t.transform.degree=0,{isIntersect:null}),h=(t.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),t.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}}),0);0!==s&&p.isIntersect&&50!=++h;)t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.025,zoomPoint:null},isResize:null}),t.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),t.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}});this.cropImg(!0),this.revertTransform("reverse",a),t.afterCropActions=l,t.currSelectionPoint=r,t.notify("transform",{prop:"setPreventSelect",onPropertyChange:!1,value:{bool:n.bool}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),"crop-circle"===i&&this.cropCircle(this.lowerContext),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("draw",{prop:"resetPanPoints",onPropertyChange:!1})},e.prototype.revertTransform=function(e,t){var o=this.parent,i={isRotate:!1};if("initial"===e)for(var r=t.length-1;0<=r;r--)switch(n=t[r]){case 90:o.notify("transform",{prop:"rotate",value:{degree:-90,obj:i}});break;case-90:o.notify("transform",{prop:"rotate",value:{degree:90,obj:i}});break;default:o.notify("transform",{prop:"flipImage",value:{direction:o.toPascalCase(n.toString())}})}else{this.updateFlipState();for(var n,r=0,a=t.length;r<a;r++)switch(n=t[r]){case 90:o.notify("transform",{prop:"rotate",value:{degree:90,obj:i}});break;case-90:o.notify("transform",{prop:"rotate",value:{degree:-90,obj:i}});break;default:o.notify("transform",{prop:"flipImage",value:{direction:o.toPascalCase(n.toString())}})}}},e.prototype.updateFlipState=function(){for(var e=this.parent,t=e.objColl,o=0,i=t.length;o<i;o++)t[o].shapeFlip="";for(var r=e.pointColl,o=0;o<e.freehandCounter;o++)r[o].shapeFlip=""},e.prototype.resetZoom=function(){var e=this.parent;if(0<e.transform.zoomFactor){var t=e.transform.zoomFactor,o=e.isUndoRedo;e.setProperties({zoomSettings:{zoomFactor:10*t}},!0),e.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:e.zoomSettings.zoomFactor}});for(var i=0;i<10*t;i++)e.isUndoRedo=!0,e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null},isResize:null});e.isUndoRedo=o,e.notify("draw",{prop:"resetPanPoints",onPropertyChange:!1})}},e.prototype.flipCrop=function(){var e,t=this.parent,o=(t.notify("transform",{prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!0}}),t.panPoint.totalPannedPoint.x+=this.tempFlipPanPoint.x,t.panPoint.totalPannedPoint.y+=this.tempFlipPanPoint.y,t.transform.currFlipState),i={flipColl:null},i=(t.notify("transform",{prop:"getFlipColl",onPropertyChange:!1,value:{obj:i}}),i.flipColl),r=(t.notify("transform",{prop:"setFlipColl",onPropertyChange:!1,value:{flipColl:[]}}),t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl.push(t.activeObj),0===t.transform.degree&&(r=-t.cropObj.totalPannedPoint.x,e=-t.cropObj.totalPannedPoint.y,t.img.destLeft+=r,t.img.destTop+=e,t.notify("transform",{prop:"drawPannImage",value:{point:{x:r,y:e}}}),t.activeObj=T.extend({},t.objColl[t.objColl.length-1],{},!0),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj}}),t.objColl.pop(),t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl.push(t.activeObj)),this.resetZoom(),t.currSelectionPoint=T.extend({},t.objColl[t.objColl.length-1],{},!0),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),this.lowerContext.filter);t.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.updateFlipState(),t.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:this.getCurrFlipState()}}),t.notify("freehand-draw",{prop:"flipFHDColl",onPropertyChange:!1,value:{value:this.getCurrFlipState()}}),t.activeObj=T.extend({},t.objColl[t.objColl.length-1],{},!0),t.objColl.pop(),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.cropImg(!0),t.notify("transform",{prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!0}}),this.lowerContext.setTransform(1,0,0,1,0,0),t.notify("draw",{prop:"setDestPoints",onPropertyChange:!1}),t.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),t.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=r,t.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),t.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),t.transform.currFlipState=o,t.notify("transform",{prop:"setFlipColl",onPropertyChange:!1,value:{flipColl:i}}),this.lowerContext.filter="none",this.updateFlipState(),t.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:this.getCurrFlipState()}}),t.notify("freehand-draw",{prop:"flipFHDColl",onPropertyChange:!1,value:{value:this.getCurrFlipState()}}),t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=r,(t.currSelectionPoint&&"crop-circle"===t.currSelectionPoint.shape||t.isCircleCrop)&&this.cropCircle(this.lowerContext),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("transform",{prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!1}}),t.notify("draw",{prop:"resetPanPoints",onPropertyChange:!1}),this.tempFlipPanPoint={x:0,y:0}},e.prototype.cropObjColl=function(){var e=this.parent;if(0<e.objColl.length)for(var t=0,o=e.objColl.length;t<o;t++){var i,r,n=(i=e.objColl[t]).activePoint,a=e.activeObj.activePoint,s=a.startX,l=a.startY,p=a.width,a=a.height,h=i.shape;i.imageRatio={startX:(n.startX-s)/p,startY:(n.startY-l)/a,endX:(n.endX-s)/p,endY:(n.endY-l)/a,width:p/n.width,height:a/n.height};switch(h){case"text":r=0===(r=0===i.shapeDegree?e.transform.degree:e.transform.degree-i.shapeDegree)||180===Math.abs(r)?n.width:n.height,i.textSettings.fontRatio=r/i.textSettings.fontSize;break;case"line":case"arrow":this.cropPointCollection(t),"arrow"===h&&e.notify("shape",{prop:"updateArrowRatio",onPropertyChange:!1,value:{obj:i}});break;case"path":this.cropPointCollection(t)}}},e.prototype.cropPointCollection=function(e){for(var t,o,i,r=this.parent,n=r.objColl[e].shape,a=r.activeObj.activePoint,s=r.img,l=s.destLeft,p=s.destTop,h=s.destWidth,s=s.destHeight,d="path"===n?(t=a.startX,o=a.startY,i=a.width,a.height):(t=l,o=p,i=h,s),c=r.objColl[e].pointColl,u=0,g=c.length;u<g;u++)c[u].ratioX=(c[u].x-t)/i,c[u].ratioY=(c[u].y-o)/d},e.prototype.cropFreehandDrawColl=function(){for(var e=this.parent,t=e.activeObj.activePoint,o=t.startX,i=t.startY,r=t.width,n=t.height,a=0;a<e.freehandCounter;a++){e.points=T.extend([],e.pointColl[a].points,[]),e.notify("freehand-draw",{prop:"setPointCounter",onPropertyChange:!1,value:{value:0}});for(var s=e.points.length,l=0;l<s;l++)e.points[l].ratioX=(e.points[l].x-o)/r,e.points[l].ratioY=(e.points[l].y-i)/n}e.notify("freehand-draw",{prop:"updateCropPtsForSel",onPropertyChange:!1})},e.prototype.resetAnnotations=function(){var e=this.parent;e.objColl=[],e.pointColl=[],e.freehandCounter=0,e.notify("freehand-draw",{prop:"resetStraightenPoint"})},e.prototype.setCurrSelPoints=function(e){var t,o,i,r=this.parent,n=(r.allowDownScale=!1,this.cropDestPoints),a=this.lowerContext.filter,s=r.isCropTab,l=(r.img={srcLeft:0,srcTop:0,srcWidth:r.baseImgCanvas.width,srcHeight:r.baseImgCanvas.height,destLeft:n.startX,destTop:n.startY,destWidth:n.width,destHeight:n.height},r.img),p=r.currSelectionPoint,e=(this.lowerContext.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height),e&&r.notify("draw",{prop:"setDestPoints",onPropertyChange:!1}),r.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),0===this.croppedDegree&&0===r.transform.degree&&p&&"crop-circle"!==p.shape&&"crop-square"!==p.shape&&(l.destLeft=n.startX,l.destTop=n.startY,l.destWidth=n.width,l.destHeight=n.height),0===r.transform.degree&&(l.destLeft+=r.panPoint.totalPannedInternalPoint.x,l.destTop+=r.panPoint.totalPannedInternalPoint.y),r.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=a,r.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,context:null,isPreventCircleCrop:!0}}),T.extend([],r.objColl,null,!0)),n=T.extend([],r.pointColl,null,!0),a={straightenPoint:null};r.notify("freehand-draw",{prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:a}}),this.resetAnnotations(),T.isNullOrUndefined(r.activeObj.shape)&&r.cropObj.activeObj.shape&&(r.activeObj=T.extend({},r.cropObj.activeObj,null,!0)),this.panToSelRangle(),r.isCropTab=s,r.objColl=e,r.pointColl=n,r.freehandCounter=r.pointColl.length,a.straightenPoint.x&&a.straightenPoint.y&&r.notify("freehand-draw",{prop:"setStraightenPoint",onPropertyChange:!1,value:{x:a.straightenPoint.x,y:a.straightenPoint.y,ratioX:a.straightenPoint.ratioX,ratioY:a.straightenPoint.ratioY}}),r.cropObj.activeObj.shape?(s={startX:l.destLeft,startY:l.destTop,width:l.destWidth,height:l.destHeight},p&&p.activePoint&&(t=(p=p.activePoint).startX,o=p.startY,i=p.width,p=p.height,l.destLeft=t,l.destTop=o,l.destWidth=i,l.destHeight=p),r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),l.destLeft=s.startX,l.destTop=s.startY,l.destWidth=s.width,l.destHeight=s.height,r.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),e=T.extend([],r.objColl,null,!0),n=T.extend([],r.pointColl,null,!0),r.notify("freehand-draw",{prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:a}}),this.resetAnnotations(),r.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(t={selPointColl:null}),value:{obj:t}}),o=t.selPointColl,r.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),r.cropObj.filter=this.lowerContext.filter,i=T.extend({},r.currSelectionPoint,null,!0),r.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:null}}),r.activeObj=T.extend({},i,null,!0),p=T.extend({},r.activeObj,null,!0),r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),r.currSelectionPoint=null,r.isCircleCrop=!1,0!==r.transform.degree&&(T.isNullOrUndefined(r.activeObj.shape)&&r.cropObj.activeObj.shape&&(r.activeObj=T.extend({},r.cropObj.activeObj,null,!0)),r.notify("transform",{prop:"drawPannedImage",value:{xDiff:0,yDiff:0}}),r.panPoint.currentPannedPoint={x:0,y:0}),r.objColl=e,r.pointColl=n,r.freehandCounter=r.pointColl.length,a.straightenPoint.x&&a.straightenPoint.y&&r.notify("freehand-draw",{prop:"setStraightenPoint",onPropertyChange:!1,value:{x:a.straightenPoint.x,y:a.straightenPoint.y,ratioX:a.straightenPoint.ratioX,ratioY:a.straightenPoint.ratioY}}),r.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:o}}}),r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.adjustStraightenForShapes("reverse",!1),r.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:!0}}),r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),0===r.transform.degree?r.notify("transform",{prop:"drawPannImage",onPropertyChange:!1,value:{point:{x:0,y:0}}}):(T.isNullOrUndefined(r.activeObj.shape)&&r.cropObj.activeObj.shape&&(r.activeObj=T.extend({},r.cropObj.activeObj,null,!0)),r.notify("transform",{prop:"drawPannedImage",value:{xDiff:0,yDiff:0}}),r.panPoint.currentPannedPoint={x:0,y:0}),r.activeObj=p,r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),r.notify("transform",{prop:"setTempPanMove",onPropertyChange:!1,value:{point:null}}),this.isInitCrop||0!==r.transform.degree||""===r.cropObj.currFlipState||0===r.cropObj.cropZoom?this.isInitCrop=!1:(this.isInitCrop=!0,r.notify("draw",{prop:"getStraightenActObj",onPropertyChange:!(l={activeObj:null}),value:{obj:l}}),r.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}),r.notify("draw",{prop:"setStraightenActObj",onPropertyChange:!1,value:{activeObj:l.activeObj}}),r.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"croptransform",isApplyBtn:!1,isCropping:null,isZooming:null,cType:null}}))):(this.adjustStraightenForShapes("reverse",!0),r.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:!0}}),s=this.lowerContext.filter,this.lowerContext.filter="none",r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.lowerContext.filter=s,r.currSelectionPoint=null),document.querySelector(".e-ie-straighten-value-span")&&(document.querySelector(".e-ie-straighten-value-span").innerHTML=r.transform.straighten.toString()+"&#176")},e.prototype.panToSelRangle=function(e){var t=this.parent,o=t.cropObj.totalPannedClientPoint,i=0!==t.transform.degree?e?-o.x:o.x:0,e=0!==t.transform.degree?e?-o.y:o.y:0;0!==t.transform.degree&&(t.panPoint.currentPannedPoint={x:i,y:e},t.notify("transform",{prop:"drawPannedImage",value:{xDiff:i,yDiff:e}}),t.panPoint.currentPannedPoint={x:0,y:0})},e.prototype.cropCircle=function(e,t,o){var i=this.parent,r=i.img,n=r.destLeft,a=r.destTop,s=r.destWidth,r=r.destHeight,l=(o&&""!==i.transform.currFlipState&&i.notify("draw",{prop:"setTransform",onPropertyChange:!1,value:{context:e,value:i.transform.currFlipState,isReverse:null}}),e.filter),n=(e.filter="none",e.globalCompositeOperation="destination-in",e.beginPath(),T.isNullOrUndefined(t)?n+s/2:e.canvas.width/2),a=T.isNullOrUndefined(t)?a+r/2:e.canvas.height/2,r=t?e.canvas.width/2:s/2;e.arc(n,a,r,0,2*Math.PI),e.closePath(),e.fill(),e.restore(),e.globalCompositeOperation="source-over",i.currObjType.isActiveObj=i.isCircleCrop=!0,e.filter=l,o&&""!==i.transform.currFlipState&&i.notify("draw",{prop:"setTransform",onPropertyChange:!1,value:{context:e,value:i.transform.currFlipState,isReverse:null}})},e.prototype.getCurrCropState=function(){var e=this.parent,t="",o={flipColl:null};return e.notify("transform",{prop:"getFlipColl",onPropertyChange:!1,value:{obj:o}}),t=this.getCurrFlipState(),-90!==e.transform.degree&&-270!==e.transform.degree||("horizontal"===t?t="vertical":"vertical"===t&&(t="horizontal")),t=""===t?1<o.flipColl.length?this.getCurrFlipState():e.transform.currFlipState:t},e.prototype.updateRotatePan=function(){var e,t,o,i,r=this.parent;T.isNullOrUndefined(r.panPoint.currentPannedPoint)||(i="",e=r.transform.degree,t=(o=r.panPoint.currentPannedPoint).x,o=o.y,i=0<r.rotateFlipColl.length&&"number"==typeof r.rotateFlipColl[0]&&e<0?this.getCurrCropState():this.getCurrFlipState(),e%90==0&&e%180!=0?90===e||-90===e&&("horizontal"===i||"vertical"===i)||-270===e&&(""===i||"verticalHorizontal"===i||"horizontalVertical"===i)?("horizontal"===i||""===i?r.img.destLeft+=o:r.img.destLeft-=o,""===i||"vertical"===i?r.img.destTop-=t:r.img.destTop+=t):270!==e&&(-270!==e||"horizontal"!==i&&"vertical"!==i)&&(-90!==e||""!==i&&"verticalHorizontal"!==i&&"horizontalVertical"!==i)||(""===i||"horizontal"===i?r.img.destLeft-=o:r.img.destLeft+=o,""===i||"vertical"===i?r.img.destTop+=t:r.img.destTop-=t):180!==e&&-180!==e||(""===i||"vertical"===i?r.img.destLeft-=t:r.img.destLeft+=t,""===i||"horizontal"===i?r.img.destTop-=o:r.img.destTop+=o))},e.prototype.crop=function(e){var t,o=this.parent,i=o.activeObj.activePoint,r=i.startX,n=i.startY,a=i.endX,i=i.endY;!o.disabled&&o.isImageLoaded&&(t={isCropToolbar:o.isCropToolbar},o.currObjType.isUndoAction&&!t.isCropToolbar&&o.notify("undo-redo",{prop:"refreshUrc",value:{bool:null}}),r={cancel:!1,startPoint:{x:r,y:n},endPoint:{x:a,y:i},preventScaling:!1},t.isCropToolbar||(o.trigger("cropping",r),o.editCompleteArgs=r),this.cropEvent(r,e,t))},e.prototype.cropEvent=function(e,t,o){var i,r,n=this.parent;e.cancel||(r=n.activeObj.shape?n.activeObj.shape.split("-"):[],!n.disabled&&n.activeObj.horTopLine&&(n.currObjType.isCustomCrop||0<r.length&&"crop"===r[0])&&(t.isCrop=!0,r=T.extend({},n.cropObj,{},!0),t=T.extend({},this.prevCropCurrObj,{},!0),e.preventScaling?this.isPreventScaling=!0:this.isPreventScaling=!1,this.cropImg(),this.isPreventScaling&&(n.aspectWidth=n.img.destWidth,n.aspectHeight=n.img.destHeight),n.notify("freehand-draw",{prop:"resetStraightenPoint"}),n.isCropTab=!1,n.transform.zoomFactor=0,n.setProperties({zoomSettings:{zoomFactor:1}},!0),n.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:n.zoomSettings.zoomFactor}}),T.Browser.isDevice||this.updateUndoRedoColl(t,r,o),n.notify("transform",{prop:"setCropDimension",onPropertyChange:!1,value:{width:n.cropObj.destPoints.width,height:n.cropObj.destPoints.height}}),e=n.element.querySelector("#"+n.element.id+"_aspectratio"),i=n.element.querySelector("#"+n.element.id+"_nonaspectratio"),n.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),!o.isCropToolbar&&T.isNullOrUndefined(e)&&T.isNullOrUndefined(i)&&n.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:!1,isZooming:null,cType:null}}),this.resizeWrapper(),T.Browser.isDevice)&&this.updateUndoRedoColl(t,r,o))},e.prototype.updateUndoRedoColl=function(e,t,o){var i=this.parent,r={prevCurrSelectionPoint:i.prevCurrSelectionPoint};e.currSelectionPoint=T.extend({},r.prevCurrSelectionPoint,{},!0),i.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"crop",previousObj:e,previousObjColl:e.objColl,previousPointColl:e.pointColl,previousSelPointColl:e.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:i.isCircleCrop}}),o.isCropToolbar||i.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})},e.prototype.resizeWrapper=function(){var e,t=this.parent;T.Browser.isDevice&&(e=(e=t.element).querySelector("#"+e.id+"_contextualToolbarArea"))&&""===e.style.position&&!this.isTransformCrop&&(e.style.position="absolute",t.isStraightening=!1,t.update(),t.notify("filter",{prop:"setAdjustmentValue",value:{adjustmentValue:t.canvasFilter}}))},e.prototype.calcRatio=function(e,t){var o=this.parent,i=o.transform.degree,r=o.img,n=r.destWidth,r=r.destHeight,t=t||o.baseImgCanvas,o=t.width,t=t.height,n=0===i||i%180==0?o/n:t/n,i=0===i||i%180==0?t/r:o/r;return e&&(e.width=n,e.height=i),{width:n,height:i}},e.prototype.getCurrFlipState=function(e){var t=this.parent,o={panRegion:""},i={collection:t.rotateFlipColl};t.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:t.rotateFlipColl,isRotateFlipCollection:!0,obj:i}}),t.rotateFlipColl=i.collection;for(var r=0,n=t.rotateFlipColl.length;r<n;r++)t.notify("transform",{prop:"setCurrPanRegion",onPropertyChange:!1,value:{region:o.panRegion,type:t.rotateFlipColl[r],obj:o}});return e&&(e.panRegion=o.panRegion),o.panRegion};var o=e;function e(e){this.croppedDegree=0,this.cropDestPoints={startX:0,startY:0,width:0,height:0},this.tempFlipPanPoint={x:0,y:0},this.isPreventScaling=!1,this.isInitCrop=!1,this.isTransformCrop=!1,this.parent=e,this.addEventListener()}var Y=function(n,a,s,l){return new(s=s||Promise)(function(e,t){function o(e){try{r(l.next(e))}catch(e){t(e)}}function i(e){try{r(l.throw(e))}catch(e){t(e)}}function r(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(o,i)}r((l=l.apply(n,a||[])).next())})},E=function(i,r){var n,a,s,l={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(o){return function(e){var t=[o,e];if(n)throw new TypeError("Generator is already executing.");for(;l;)try{if(n=1,a&&(s=2&t[0]?a.return:t[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,t[1])).done)return s;switch(a=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,a=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(s=0<(s=l.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3]))l.label=t[1];else if(6===t[0]&&l.label<s[1])l.label=s[1],s=t;else{if(!(s&&l.label<s[2])){s[2]&&l.ops.pop(),l.trys.pop();continue}l.label=s[2],l.ops.push(t)}}t=r.call(i,l)}catch(e){t=[6,e],a=0}finally{n=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},i=(t.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},t.prototype.addEventListener=function(){this.parent.on("draw",this.draw,this),this.parent.on("destroyed",this.destroy,this)},t.prototype.removeEventListener=function(){this.parent.off("draw",this.draw),this.parent.off("destroyed",this.destroy)},t.prototype.draw=function(e){switch(this.updatePrivateVariables(),e.prop){case"drawObject":this.drawObject(e.value.canvas,e.value.obj,e.value.isCropRatio,e.value.points,e.value.isPreventDrag,e.value.saveContext,e.value.isPreventSelection);break;case"updateActiveObject":this.updateActiveObject(e.value.actPoint,e.value.obj,e.value.isMouseMove,e.value.x,e.value.y);break;case"clearOuterCanvas":this.clearOuterCanvas(e.value.context);break;case"setDestPoints":this.setDestPoints();break;case"updateCurrTransState":this.updateCurrTransState(e.value.type,e.value.isPreventDestination,e.value.isRotatePan);break;case"currTransState":this.currTransState(e.value.type,e.value.isPreventDestination,e.value.context,e.value.isPreventCircleCrop);break;case"setTransform":this.setTransform(e.value.context,e.value.value,e.value.isReverse);break;case"render-image":this.renderImage(e.value.isMouseWheel,e.value.isPreventClearRect,e.value.isFrame,e.value.isStraighten);break;case"draw-image-to-canvas":this.drawImgToCanvas(e.value.dimension);break;case"update-canvas":this.updateCanvas();break;case"performCancel":this.performCancel(e.value.isContextualToolbar,e.value.isUndoRedo,e.value.isFinalCancel);break;case"updateFlipPan":this.updateFlipPan(e.value.tempSelectionObj);break;case"select":this.select(e.value.type,e.value.startX,e.value.startY,e.value.width,e.value.height);break;case"callUpdateCurrTransState":this.callUpdateCurrTransState();break;case"resetPanPoints":this.resetPanPoints();break;case"setClientTransDim":this.setClientTransDim(e.value.isPreventDimension);break;case"redrawImgWithObj":this.redrawImgWithObj();break;case"setCurrentObj":this.setCurrentObj(e.value.obj,e.value.isUndoRedo,e.value.isCircleCrop);break;case"performPointZoom":this.performPointZoom(e.value.x,e.value.y,e.value.type,e.value.isResize);break;case"open":this.open(e.value.data);break;case"isInitialLoading":this.isInitialLoading=e.value.isInitialLoading;break;case"isInitialLoaded":this.getInitialLoaded(e.value.object);break;case"fileSelect":this.fileSelect(e.value.inputElement,e.value.args);break;case"getFileName":e.value.obj.fileName=this.fileName,e.value.obj.fileType=this.fileType;break;case"getErrorImage":e.value.obj.isErrorImage=this.isErrorImage;break;case"getInitialZoomValue":e.value.obj.initialZoomValue=this.initZoomValue;break;case"setShapeTextInsert":this.isShapeTextInserted=e.value.bool;break;case"resetCurrentSelectionPoint":this.currSelPoint=null;break;case"setRotateZoom":this.isRotateZoom=e.value.isRotateZoom;break;case"setTempStrokeSettings":this.tempStrokeSettings=e.value.tempStrokeSettings;break;case"setTempTextSettings":this.tempTextSettings=e.value.tempTextSettings;break;case"setTempAdjustmentValue":this.tempAdjValue=e.value.tempAdjustmentValue;break;case"getTempAdjustmentValue":e.value.obj.value=this.tempAdjValue;break;case"setTempFilter":this.tempFilter=e.value.tempFilter;break;case"setTempUndoRedoStep":this.tempUndoRedoStep=e.value.tempUndoRedoStep;break;case"setTempFreehandCounter":this.tempFreehandCounter=e.value.tempFreehandCounter;break;case"setTempCurrentFreehandDrawIndex":this.tempCurrFhdIndex=e.value.tempCurrentFreehandDrawIndex;break;case"setTempZoomFactor":this.tempZoomFactor=e.value.tempZoomFactor;break;case"setCancelAction":this.isCancelAction=e.value.bool;break;case"getRotatedFlipCropSelection":e.value.bool.isSelected=this.rotatedFlipCropSel;break;case"getPrevActObj":e.value.obj.prevActObj=this.prevActObj;break;case"setPrevActObj":this.prevActObj=e.value.prevActObj;break;case"setZoomCropWidth":this.zoomCrop.width=e.value.width,this.zoomCrop.height=e.value.height;break;case"setImageEdited":this.isImageEdited=!0;break;case"reset":this.reset();break;case"setNewPath":this.isNewPath=e.value.bool;break;case"getNewPath":e.value.obj.isNewPath=this.isNewPath;break;case"getArrowDimension":e.value.obj.arrowDimension=T.extend({},this.arrowDimension,{},!0);break;case"setArrowDimension":this.arrowDimension=e.value.arrowDimension;break;case"moveToSelectionRange":this.moveToSelectionRange(e.value.type,e.value.activeObj);break;case"setResizeSelect":this.isResizeSelect=e.value.bool;break;case"applyFrame":this.applyFrame(e.value.ctx,e.value.frame,e.value.preventImg);break;case"drawImage":this.drawImage();break;case"downScaleImgCanvas":this.downScaleImgCanvas(e.value.ctx,e.value.isImgAnnotation,e.value.isHFlip,e.value.isVFlip);break;case"downScale":this.downScale(e.value.canvas,e.value.width,e.value.height);break;case"resetFrameZoom":this.resetFrameZoom(e.value.isOk);break;case"triggerFrameChange":e.value.obj.frameChangeEventArgs=this.triggerFrameChange(e.value.prevFrameSettings);break;case"setImageApply":this.isImageApply=e.value.bool;break;case"zoomToSel":this.zoomToSel(e.value.activeObj,e.value.isToolbar);break;case"getStraightenActObj":e.value.obj.activeObj=this.straightenActObj;break;case"setStraightenActObj":this.straightenActObj=e.value.activeObj;break;case"updateImgCanvasPoints":this.updateImgCanvasPoints();break;case"isLinesIntersect":e.value.obj.isIntersect=this.isLinesIntersect(e.value.obj);break;case"getImageCanvasPoints":e.value.obj.points=this.imgCanvasPoints;break;case"setDestForStraighten":this.setDestForStraighten();break;case"setTempDestForStraighten":this.tempStraightenDestPoints=T.extend({},this.straightenDestPoints,{},!0);break;case"getStraightenInitZoom":e.value.obj.zoomFactor=this.straightenInitZoom;break;case"setStraightenInitZoom":this.straightenInitZoom=e.value.zoomFactor;break;case"isPointsInsideImg":e.value.obj.bool="inside"!==this.checkPointPosition(e.value.x,e.value.y,this.imgCanvasPoints[0].x,this.imgCanvasPoints[0].y,this.imgCanvasPoints[1].x,this.imgCanvasPoints[1].y,this.imgCanvasPoints[2].x,this.imgCanvasPoints[2].y,this.imgCanvasPoints[3].x,this.imgCanvasPoints[3].y);break;case"setIsCropSelect":this.isCropSelect=e.value.bool;break;case"updateCropSelection":this.updateCropSelection();break;case"updateCropSelObj":this.updateCropSelObj();break;case"redrawDownScale":this.redrawDownScale();break;case"updateFinetune":this.updateFinetune();break;case"isSelOutsideImg":e.value.obj.bool=this.isSelOutsideImg();break;case"resetStraightenDestPoints":this.straightenDestPoints=null;break;case"checkPointPosition":e.value.obj.position=this.checkPointPosition(e.value.obj.x,e.value.obj.y,e.value.obj.x1,e.value.obj.y1,e.value.obj.x2,e.value.obj.y2,e.value.obj.x3,e.value.obj.y3,e.value.obj.x4,e.value.obj.y4);break;case"updateTempObjColl":this.tempObjColl=T.extend([],this.parent.objColl,[],!0);break;case"resetTempObjColl":this.tempObjColl=null;break;case"updateTempPointColl":this.tempPointColl=T.extend({},this.parent.pointColl,{},!0);break;case"resetTempPointColl":this.tempPointColl={};break;case"showDialogPopup":this.showDialogPopup();break;case"imageBackgroundColor":this.imageBackgroundColor=e.value.color;break;case"getImageBackgroundColor":e.value.obj.color=this.imageBackgroundColor;break;case"setTempStrokeWidth":this.tempStrokeWidth=e.value.strokeWidth;break;case"setNullExtension":this.isNullExtension=e.value.extension}},t.prototype.getModuleName=function(){return"draw"},t.prototype.updatePrivateVariables=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d")),T.isNullOrUndefined(this.tempZoomFactor)&&(this.tempZoomFactor=e.transform.zoomFactor),""===this.tempTextSettings.fontFamily&&(this.tempTextSettings.fontFamily=e.fontFamily.default)},t.prototype.reset=function(){this.isInitialLoading=this.isErrorImage=this.isNewPath=this.isResizeSelect=!1,this.isShapeTextInserted=!1,this.isImageApply=!1,this.isNullExtension=!0,this.initZoomValue=null,this.tempFilter="",this.origDim={width:0,height:0},this.currSelPoint=null,this.isRotateZoom=!1,this.tempAdjValue="",this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,radius:null,outlineColor:"",outlineWidth:null},this.tempTextSettings={text:"Enter Text",fontFamily:this.parent.fontFamily.default,fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.tempUndoRedoStep=this.tempFreehandCounter=this.tempCurrFhdIndex=0,this.tempZoomFactor=null,this.isCancelAction=!1,this.rotatedFlipCropSel=!1,this.prevActObj=null,this.tempStraightenDestPoints=null,this.arrowDimension={bar:{width:10,height:32,ratioX:null,ratioY:null},arrow:{width:24,height:24,ratioX:null,ratioY:null},arrowSolid:{width:32,height:32,ratioX:null,ratioY:null},circle:{width:10,height:10,ratioX:null,ratioY:null},square:{width:20,height:20,ratioX:null,ratioY:null}},this.straightenActObj=null,this.imgCanvasPoints=[],this.straightenInitZoom=null,this.allowRedactStraighten=!0,this.tempObjColl=[],this.tempPointColl={},this.imageBackgroundColor="",this.tempStrokeWidth=null,this.straightenDestPoints=null,this.isCropSelect=this.isDownScale=this.preventStraightening=!1},t.prototype.redrawDownScale=function(){var e,t=this.parent;t.transform.zoomFactor&&t.transform.zoomFactor<0&&(e=T.extend({},t.activeObj,{},!0),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.isDownScale=!0,this.renderImage(),this.isDownScale=!1,e.shape)&&this.drawObject("duplicate",e)},t.prototype.updateFinetune=function(){var e,t,o,i=this.parent;i.transform.zoomFactor&&i.transform.zoomFactor<0&&(e=this.lowerContext.filter,this.lowerContext.filter="none",i.notify("draw",{prop:"redrawDownScale"}),t=i.inMemoryCanvas.getContext("2d"),o=(o=this.lowerContext).getImageData(0,0,o.canvas.width,o.canvas.height),i.inMemoryCanvas.width=o.width,i.inMemoryCanvas.height=o.height,t.putImageData(o,0,0),this.lowerContext.filter=e,i.notify("draw",{prop:"redrawDownScale"}))},t.prototype.drawImage=function(){this.applyFrame(this.lowerContext,this.parent.frameObj.type)},t.prototype.drawObject=function(e,t,o,i,r,n,a){var s,l=this.parent,p=l.activeObj,h=l.activeObj.activePoint;this.upperContext.clearRect(0,0,l.upperCanvas.width,l.upperCanvas.height),"original"===(e=e.toLowerCase())?s=this.lowerContext:"duplicate"===e?s=this.upperContext:n&&(s=n),!r&&p.shape&&this.setDragLimit(),l.currObjType.shape&&"crop"===l.currObjType.shape.split("-")[0].toLowerCase()&&o&&this.drawCropRatio(),p=l.activeObj,h=l.activeObj.activePoint,T.isNullOrUndefined(p.strokeSettings)&&(l.notify("shape",{prop:"getStrokeSettings",onPropertyChange:!(r={strokeSettings:{}}),value:{obj:r}}),p.strokeSettings=r.strokeSettings),T.isNullOrUndefined(p.strokeSettings.strokeWidth)&&(p.strokeSettings.strokeWidth=2),t&&(l.activeObj=T.extend({},t,{},!0)),i&&i.startX&&i.startY&&i.endX&&i.endY&&i.width&&i.height&&(h.startX=i.startX,h.startY=i.startY,h.endX=i.endX,h.endY=i.endY,h.width=i.width,h.height=i.height),this.updateActiveObject(),p=l.activeObj,h=l.activeObj.activePoint,T.isNullOrUndefined(h.startX)&&T.isNullOrUndefined(h.startY)||(l.currObjType.isText&&(l.notify("shape",{prop:"getKeyHistory",onPropertyChange:!(o={keyHistory:""}),value:{obj:o}}),p.keyHistory=o.keyHistory),r=!1,"original"!==e&&((r=p.shape&&"crop"===p.shape.split("-")[0]?!0:r)&&(i&&i.startX&&i.startY&&i.endX&&i.endY&&i.width&&i.height?(h.startX=i.startX,h.startY=i.startY,h.endX=i.endX,h.endY=i.endY,h.width=i.width,h.height=i.height):h=p.activePoint,this.upperContext.fillStyle="rgb(0, 0, 0, 0.25)",this.upperContext.fillRect(0,0,l.lowerCanvas.width,l.lowerCanvas.height),this.upperContext.clearRect(h.startX,h.startY,h.width,h.height)),!T.isNullOrUndefined(a)||s!==this.lowerContext&&s!==this.upperContext||(this.rotateContext("initial",s),this.drawOuterSelection(s),this.rotateContext("reverse",s))),l.currObjType.isActiveObj=!0,l.notify("shape",{prop:"getKeyHistory",onPropertyChange:!(o={keyHistory:""}),value:{obj:o}}),t?this.drawShapeObj(e,t.shape,n,a):""!==o.keyHistory&&l.currObjType.isText?this.drawShapeObj(e,"text",n,a):p.shape?this.drawShapeObj(e,p.shape,n,a):this.drawShapeObj(e,void 0,n,a),"duplicate"===e&&r&&"crop-circle"!==p.shape&&"none"!==l.frameObj.type&&(this.applyFrame(this.upperContext,l.frameObj.type),this.drawCornerCircles(this.upperContext)))},t.prototype.rotateContext=function(e,t){var o,i=this.parent,r=i.activeObj,n=r.shape,r=r.rotatedAngle,a=i.img,s=a.destLeft,l=a.destTop,p=a.destWidth,a=a.destHeight,h=i.activeObj.activePoint,d=h.startX,c=h.startY,u=h.width,h=h.height;"line"!==n&&"arrow"!==n&&(n="initial"===e?r:-r,e=0!==i.transform.straighten||i.isCropTab?(o=s+p/2,l+a/2):(o=d+u/2,c+h/2),t.translate(o,e),t.rotate(n),t.translate(-o,-e))},t.prototype.setDragLimit=function(){var e,t,o=this.parent,i=o.activeObj.activePoint,r=o.activeObj,n=r.shape,r=r.rotatedAngle;i&&"image"!==n&&"line"!==n&&0===r&&o.activeObj.preventShapeDragOut&&(r=(n=o.img).destLeft,e=n.destTop,t=n.destWidth,n=n.destHeight,i.startX<r?(i.startX=r,i.endX=Math.min(i.startX+i.width,r+t)):i.endX>r+t&&(i.endX=r+t,i.startX=Math.max(i.endX-i.width,r)),i.startY<e?i.startY=e:i.endY>e+n&&(i.endY=e+n,i.startY=Math.max(i.endY-i.height,e)),o.activeObj=this.updateWidthHeight(o.activeObj))},t.prototype.drawCropRatio=function(){var e,t,o,i,r=this.parent,n=r.activeObj.activePoint,a=r.img,s=a.destLeft,l=a.destTop,p=a.destWidth,h=a.destHeight;switch(0<r.transform.zoomFactor&&this.currSelPoint?(a=T.extend({},r.activeObj,{},!0),this.drawCustomSelection("crop-custom",null,null,null,null),0!==r.transform.straighten&&(n=r.activeObj.activePoint),i=r.transform.degree%90==0&&r.transform.degree%180!=0?o=n.width<n.height?n.width:n.height:(o=n.width,n.height),r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),r.activeObj=a,r.currObjType.shape=a.shape,this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.currObjType.isCustomCrop=!1):(o=p,i=h,s<0&&(o+=s),l<0&&(i+=l),s+p>r.lowerCanvas.width&&(o-=s+p-r.lowerCanvas.width),l+h>r.lowerCanvas.height&&(i-=l+h-r.lowerCanvas.height)),r.currObjType.shape.toLowerCase()){case"crop-square":case"crop-circle":r.notify("selection",{prop:"setDragDirection",onPropertyChange:!1,value:{width:o,height:i}}),n=r.activeObj.activePoint,r.lowerCanvas.width<n.endX-n.startX&&(n.startX=7.5,n.endX=r.lowerCanvas.width-7.5),r.lowerCanvas.height<n.endY-n.startY&&(n.startY=7.5,n.endY=r.lowerCanvas.height-7.5),o===p&&i===h&&(n.startX+=s,n.startY+=l,n.endX+=s,n.endY+=l),r.lowerCanvas.width>r.lowerCanvas.height?(n.height=n.endY-n.startY,n.width=n.height,n.endX=n.startX+n.width):(n.width=n.endX-n.startX,n.height=n.width,n.endY=n.startY+n.height);break;case"crop-3:2":e=3,t=2;break;case"crop-4:3":e=4,t=3;break;case"crop-5:4":e=5,t=4;break;case"crop-7:5":e=7,t=5;break;case"crop-16:9":e=16,t=9;break;case"crop-2:3":e=2,t=3;break;case"crop-3:4":e=3,t=4;break;case"crop-4:5":e=4,t=5;break;case"crop-5:7":e=5,t=7;break;case"crop-9:16":e=9,t=16;break;default:e=parseInt(r.currObjType.shape.toLowerCase().split("crop-")[1].split(":")[0]),t=parseInt(r.currObjType.shape.toLowerCase().split("crop-")[1].split(":")[1])}void 0!==e&&void 0!==t&&(r.notify("selection",{prop:"calcShapeRatio",onPropertyChange:!1,value:{x:e,y:t,imgWidth:o,imgHeight:i}}),o===p&&i===h&&this.updatePoints(),n=r.activeObj.activePoint),n.startX<s&&(u=s-n.startX+7.5,n.startX+=u,n.endX+=u),n.startY<l&&(u=l-n.startY+7.5,n.startY+=u,n.endY+=u),r.activeObj=this.updateWidthHeight(r.activeObj),this.adjToCenter(),this.enlargeToImg(),0!==r.transform.straighten&&(this.adjToStraighten(),this.updateActiveObject(r.activeObj.activePoint,r.activeObj));var d={isIntersect:null,arr:null},c=0,n=r.activeObj.activePoint;if(0!==r.transform.straighten)for(;this.isLinesIntersect(d)&&c<100;){c++;var u=+n.width/100;n.startX+=u,n.endX-=u,u=+n.height/100,n.startY+=u,n.endY-=u,n.width=n.endX-n.startX,n.height=n.endY-n.startY,this.updateActiveObject(n,r.activeObj)}this.straightenInitZoom=r.transform.zoomFactor,this.straightenActObj=T.extend({},r.activeObj,{},!0),r.notify("draw",{prop:"resetStraightenDestPoints"}),r.notify("draw",{prop:"setDestForStraighten"})},t.prototype.adjToCenter=function(){var e,t=this.parent,o=t.activeObj.activePoint,i=t.img,r=i.destLeft,n=i.destTop,a=i.destWidth,i=i.destHeight,s=t.lowerCanvas.width/2-(o.endX-o.width/2),t=t.lowerCanvas.height/2-(o.endY-o.height/2);o.startX+=s,o.endX+=s,o.startY+=t,o.endY+=t,o.startX<(7.5<=r?r:7.5)?(e=(7.5<=r?r:0)-o.startX,o.startX+=e,o.endX+=e):o.endX>r+a&&(e=o.endX-(r+a),o.startX-=e,o.endX-=e),o.startY<(7.5<=n?n:7.5)?(e=(7.5<=n?n:0)-o.startY,o.startY+=e,o.endY+=e):o.endY>n+i&&(e=o.endY-(n+i),o.startY-=e,o.endY-=e)},t.prototype.enlargeToImg=function(){var e=this.parent;if(0!==e.transform.straighten&&e.transform.degree%90==0&&e.transform.degree%180!=0)for(var t=e.activeObj.activePoint,o=T.extend({},t,{},!0),i=0;;){i++;var r=5*t.width/100,n=(t.startX-=r,t.endX+=r,r=5*t.height/100,t.startY-=r,t.endY+=r,t.width=t.endX-t.startX,t.height=t.endY-t.startY,this.updateActiveObject(t,e.activeObj),{isIntersect:null,arr:null});if(this.updateImgCanvasPoints(),this.isLinesIntersect(n),n.arr[0]||n.arr[1]||n.arr[2]||n.arr[3]||t.startX<7.5||t.startY<7.5||100===i){r=+(t=T.extend({},o,{},!0)).width/100,t.startX+=r,t.endX-=r,r=+t.height/100,t.startY+=r,t.endY-=r,t.width=t.endX-t.startX,t.height=t.endY-t.startY,this.updateActiveObject(t,e.activeObj);break}o=T.extend({},t,{},!0)}},t.prototype.updateActiveObject=function(e,t,o,i,r){var n=this.parent,a=(e=e||T.extend({},n.activeObj.activePoint,{},!0),t=t||T.extend({},n.activeObj,{},!0),e.width=e.endX-e.startX,e.height=e.endY-e.startY,e.startX),s=e.startY,l=e.endX,p=e.endY,h=e.width/2,d=e.height/2,c=7.5;t.horTopLine={startX:a+(i=i||0),startY:s-(r=r||0),endX:l+i,endY:p+r},t.horBottomLine={startX:a-i,startY:p-r,endX:l-i,endY:p+r},t.verLeftLine={startX:a+i,startY:s-r,endX:a-r,endY:p-r},t.verRightLine={startX:l+i,startY:s+r,endX:l-i,endY:p+r},t.topLeftCircle={startX:a,startY:s,radius:t.horTopLine.endX?c:0},t.topCenterCircle={startX:a+h,startY:s,radius:t.horTopLine.endX?c:0},t.topRightCircle={startX:l,startY:s,radius:t.horTopLine.endX?c:0},t.centerLeftCircle={startX:a,startY:s+d,radius:t.horTopLine.endX?c:0},t.centerRightCircle={startX:l,startY:s+d,radius:t.horTopLine.endX?c:0},t.bottomLeftCircle={startX:a,startY:p,radius:t.horTopLine.endX?c:0},t.bottomCenterCircle={startX:a+h,startY:p,radius:t.horTopLine.endX?c:0},t.bottomRightCircle={startX:l,startY:p,radius:t.horTopLine.endX?c:0},0===t.rotatedAngle&&(t.rotationCirclePoint={x:t.bottomCenterCircle.startX,y:t.bottomCenterCircle.startY+25},t.rotationCirclePoint.ratioX=(t.rotationCirclePoint.x-n.img.destLeft)/n.img.destWidth,t.rotationCirclePoint.ratioY=(t.rotationCirclePoint.y-n.img.destTop)/n.img.destHeight),t.activePoint=e,T.isNullOrUndefined(o)&&(n.activeObj=T.extend({},t,{},!0))},t.prototype.drawOuterSelection=function(e,t){var o,i=this.parent,r=i.activeObj.activePoint,n=i.activeObj,a=(e.lineWidth=.5,T.extend({},n,{},!0));if(((o=n.shape?n.shape.split("-"):o)&&"crop"===o[0]||void 0===n.shape)&&!t&&(this.upperContext.fillStyle="rgb(0, 0, 0, 0.25)",this.upperContext.fillRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),this.upperContext.clearRect(r.startX,r.startY,r.width,r.height)),e.strokeStyle=i.themeColl[i.theme].primaryColor,e.fillStyle=i.themeColl[i.theme].secondaryColor,(0===a.shapeDegree?i.transform.degree:i.transform.degree-a.shapeDegree)<0&&0,"arrow"===n.shape||"line"===n.shape)e.beginPath(),e.moveTo(r.startX,r.startY),e.lineTo(r.endX,r.endY),e.stroke();else if("path"===n.shape){e.beginPath();var s=T.extend({},i.activeObj,{},!0);if(s.pointColl[0]&&(e.moveTo(s.pointColl[0].x,s.pointColl[0].y),1<s.pointColl.length))for(var l=1,p=s.pointColl.length;l<p;l++)r.endX=s.pointColl[l].x,r.endY=s.pointColl[l].y,e.lineTo(r.endX,r.endY);var t={shape:null};i.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:t}}),"path"===t.shape&&(i.activeObj=n=s),e.lineTo(r.endX,r.endY),e.stroke()}else this.drawCornerCircles(e);!i.selectionSettings.showCircle||void 0!==o&&"crop"===o[0]||(t=e.strokeStyle,o=e.fillStyle,e.strokeStyle=i.selectionSettings.strokeColor,e.fillStyle=i.selectionSettings.fillColor,"text"===n.shape?(e.lineWidth*=2,e.beginPath(),this.drawRotationArcLine(e),e.lineTo(n.rotationCirclePoint.x,n.rotationCirclePoint.y),e.stroke(),e.fill(),e.closePath(),e.beginPath(),e.moveTo(n.rotationCirclePoint.x,n.rotationCirclePoint.y),e.arc(n.rotationCirclePoint.x,n.rotationCirclePoint.y,n.bottomCenterCircle.radius,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),e.lineWidth/=2):"redact"!==i.activeObj.shape&&this.drawCenterCircles(e),e.strokeStyle=t,e.fillStyle=o),a.rotationCircleLine=n.rotationCircleLine,i.activeObj=T.extend({},a,{},!0)},t.prototype.drawArrowHead=function(e,t){switch(t?this.parent.activeObj.start:this.parent.activeObj.end){case"arrowSolid":t?this.arrowSolid(e,!0):this.arrowSolid(e,!1);break;case"arrow":t?this.arrow(e,!0):this.arrow(e,!1);break;case"circleSolid":t?this.arrowCircleSolid(e,!0):this.arrowCircleSolid(e,!1);break;case"circle":t?this.arrowCircle(e,!0):this.arrowCircle(e,!1);break;case"bar":t?this.arrowBar(e,!0):this.arrowBar(e,!1);break;case"square":case"squareSolid":t?this.arrowSquareStart(e):this.arrowSquareEnd(e)}},t.prototype.drawShapeObj=function(e,t,o,i){var r,n,a=this.parent,s=a.activeObj.activePoint,l=a.activeObj,p=l.strokeSettings,h=p.strokeColor,d=p.fillColor,c=p.strokeWidth,p=void 0!==t?t:a.currObjType.shape,p=(a.currObjType.shape=p,"original"===e.toLowerCase()?r=this.lowerContext:"duplicate"===e.toLowerCase()?r=this.upperContext:o&&(r=o),a.currObjType.shape.toLowerCase()),u=(-1!==["rectangle","ellipse","line","arrow","path","image","redact"].indexOf(p)&&(l.shape=a.currObjType.shape),r.strokeStyle=h,r.fillStyle="text"===t||"freehanddraw"===t?h:d,s.width/3),g=s.height/3,v=s.endX-s.startX,f=s.endY-s.startY,C=(this.rotateContext("initial",r),r.fillStyle);switch(a.currObjType.shape.toLowerCase()){case"rectangle":this.drawSquareLines(r),T.isNullOrUndefined(i)&&r===this.upperContext&&this.drawOuterSelection(r);break;case"redact":this.drawRedact(r,l),T.isNullOrUndefined(i)&&r===this.upperContext&&this.drawOuterSelection(r),a.currObjType.isRedact=!0;break;case"ellipse":v=Math.abs(v),f=Math.abs(f),r.beginPath(),r.ellipse(s.startX+v/2,s.startY+f/2,v/2,f/2,0,0,2*Math.PI,!1),""!==d&&(r.fillStyle=d,r.fill()),r.ellipse(s.startX+v/2,s.startY+f/2,Math.abs(v/2-c),Math.abs(f/2-c),0,0,2*Math.PI,!1),r.fillStyle=h,r.fill("evenodd"),r.closePath(),T.isNullOrUndefined(i)&&r===this.upperContext&&this.drawOuterSelection(r);break;case"crop-circle":this.shapeCircle(r,v,f);break;case"line":this.shapeLine(r,s.startX,s.startY,s.endX,s.endY),T.isNullOrUndefined(i)&&r===this.upperContext&&this.drawOuterSelection(r);break;case"arrow":(0===l.shapeDegree?a.transform.degree:a.transform.degree-l.shapeDegree)<0&&0,r.fillStyle=r.strokeStyle,T.isNullOrUndefined(l.triangleDirection)&&(l.triangleDirection="right"),T.isNullOrUndefined(l.start)&&(l.start="none"),T.isNullOrUndefined(l.end)&&(l.end="arrowSolid"),this.drawArrowHead(r,!0),this.drawArrowHead(r,!1),"none"===l.end&&"circle"!==l.start&&"square"!==l.start&&this.shapeLine(r,s.startX,s.startY,s.endX,s.endY),r.fillStyle=C,T.isNullOrUndefined(i)&&r===this.upperContext&&this.drawOuterSelection(r);break;case"path":if(1<(n=T.extend({},a.activeObj,{},!0)).pointColl.length){var b={shape:null};if(a.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:b}}),"path"===b.shape&&a.isShapeDrawing)for(var m={x:0,y:0},y=0,P=n.pointColl.length;y<P;y++)T.isNullOrUndefined(n.pointColl[y+1])?(m.x=n.activePoint.endX,m.y=n.activePoint.endY):(m.x=n.pointColl[y+1].x,m.y=n.pointColl[y+1].y),s.startX=n.pointColl[y].x,s.startY=n.pointColl[y].y,s.endX=m.x,s.endY=m.y,a.activeObj=this.updateWidthHeight(a.activeObj),this.shapeLine(r,s.startX,s.startY,s.endX,s.endY),T.Browser.isDevice&&(n.activePoint.endX=m.x,n.activePoint.endY=m.y);else for(y=1,P=n.pointColl.length;y<P;y++)s.startX=n.pointColl[y-1].x,s.startY=n.pointColl[y-1].y,s.endX=n.pointColl[y].x,s.endY=n.pointColl[y].y,a.activeObj=this.updateWidthHeight(a.activeObj),this.shapeLine(r,s.startX,s.startY,s.endX,s.endY);a.activeObj=l=n}else this.shapeLine(r,s.startX,s.startY,s.endX,s.endY);r===this.upperContext&&this.drawOuterSelection(r);break;case"text":this.shapeText(r);break;case"image":this.shapeImage(r),T.isNullOrUndefined(i)&&r===this.upperContext&&this.drawOuterSelection(r);break;case"crop-square":case"crop-3:4":case"crop-4:3":case"crop-6:9":case"crop-9:6":case"crop-9:16":case"crop-16:9":r===this.lowerContext&&(r=this.upperContext),this.drawSelection(u,g),a.currObjType.shape="";break;default:this.drawSelection(u,g)}this.rotateContext("reverse",r)},t.prototype.updatePoints=function(){var e=this.parent,t=e.activeObj.activePoint,o=e.img,i=o.destLeft,o=o.destTop;t.startX+=i,t.startY+=o,t.endX+=i,t.endY+=o,e.activeObj=this.updateWidthHeight(e.activeObj)},t.prototype.updateWidthHeight=function(e){var t=e.activePoint,o=t.startX,i=t.startY,r=t.endX,t=t.endY;return e.activePoint.width=r-o,e.activePoint.height=t-i,e},t.prototype.drawCornerCircles=function(e){var t,o,i=this.parent,r=i.activeObj;e.beginPath(),e.rect(r.activePoint.startX,r.activePoint.startY,r.activePoint.width,r.activePoint.height),e.stroke(),e.closePath(),i.selectionSettings.showCircle&&(t=e.strokeStyle,o=e.fillStyle,e.strokeStyle=i.selectionSettings.strokeColor,e.fillStyle=i.selectionSettings.fillColor,e.lineWidth*=2,e.beginPath(),e.moveTo(r.topLeftCircle.startX,r.topLeftCircle.startY),e.arc(r.topLeftCircle.startX,r.topLeftCircle.startY,r.topLeftCircle.radius,0,2*Math.PI),e.moveTo(r.topRightCircle.startX,r.topRightCircle.startY),e.arc(r.topRightCircle.startX,r.topRightCircle.startY,r.topRightCircle.radius,0,2*Math.PI),e.moveTo(r.bottomLeftCircle.startX,r.bottomLeftCircle.startY),e.arc(r.bottomLeftCircle.startX,r.bottomLeftCircle.startY,r.bottomLeftCircle.radius,0,2*Math.PI),e.moveTo(r.bottomRightCircle.startX,r.bottomRightCircle.startY),e.arc(r.bottomRightCircle.startX,r.bottomRightCircle.startY,r.bottomRightCircle.radius,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),e.lineWidth/=2,e.strokeStyle=t,e.fillStyle=o)},t.prototype.drawCenterCircles=function(e){var t=this.parent,o=t.activeObj.activePoint,i=t.activeObj;if(e.lineWidth*=2,e.beginPath(),"arrow"===i.shape||"line"===i.shape)e.moveTo(o.startX,o.startY),e.arc(o.startX,o.startY,i.topCenterCircle.radius,0,2*Math.PI),e.moveTo(o.endX,o.endY),e.arc(o.endX,o.endY,i.bottomCenterCircle.radius,0,2*Math.PI);else if("path"===i.shape){var r=T.extend({},t.activeObj,{},!0);if(1<r.pointColl.length)for(var n=1,a=r.pointColl.length;n<a;n++)o.startX=r.pointColl[n-1].x,o.startY=r.pointColl[n-1].y,o.endX=r.pointColl[n].x,o.endY=r.pointColl[n].y,e.moveTo(o.startX,o.startY),e.arc(o.startX,o.startY,i.topCenterCircle.radius,0,2*Math.PI),e.moveTo(o.endX,o.endY),e.arc(o.endX,o.endY,i.bottomCenterCircle.radius,0,2*Math.PI);var s={shape:null};t.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:s}}),"path"===s.shape&&(t.activeObj=i=r),e.moveTo(o.startX,o.startY),e.arc(o.startX,o.startY,i.topCenterCircle.radius,0,2*Math.PI),e.moveTo(o.endX,o.endY),e.arc(o.endX,o.endY,i.bottomCenterCircle.radius,0,2*Math.PI)}else this.drawRotationArcLine(e),e.lineTo(i.rotationCirclePoint.x,i.rotationCirclePoint.y);e.stroke(),e.fill(),e.closePath(),"arrow"!==i.shape&&"line"!==i.shape&&"path"!==i.shape&&(e.beginPath(),e.moveTo(i.rotationCirclePoint.x,i.rotationCirclePoint.y),e.arc(i.rotationCirclePoint.x,i.rotationCirclePoint.y,i.bottomCenterCircle.radius,0,2*Math.PI),e.stroke(),e.fill(),e.closePath()),e.lineWidth/=2},t.prototype.drawRotationArcLine=function(e){var t=this.parent,o=t.activeObj,i=(T.isNullOrUndefined(o.rotationCircleLine)&&(o.rotationCircleLine=22.5),!1),r=!1,t=0===o.shapeDegree?t.transform.degree:t.transform.degree-o.shapeDegree;if(t<0&&(t=360+t),o.flipObjColl)for(var n=0,a=o.flipObjColl.length;n<a;n++){var s=o.flipObjColl[n].toLowerCase();"horizontal"===s?i=!0:"vertical"===s&&(r=!0)}switch(t){case 0:case 360:r?(o.rotationCirclePoint={x:o.topCenterCircle.startX,y:o.topCenterCircle.startY-o.rotationCircleLine},e.moveTo(o.rotationCirclePoint.x,o.rotationCirclePoint.y+o.rotationCircleLine)):(o.rotationCirclePoint={x:o.bottomCenterCircle.startX,y:o.bottomCenterCircle.startY+o.rotationCircleLine},e.moveTo(o.rotationCirclePoint.x,o.rotationCirclePoint.y-o.rotationCircleLine));break;case 90:case-270:i?(o.rotationCirclePoint={x:o.centerRightCircle.startX+o.rotationCircleLine,y:o.centerLeftCircle.startY},e.moveTo(o.rotationCirclePoint.x-o.rotationCircleLine,o.rotationCirclePoint.y)):(o.rotationCirclePoint={x:o.centerLeftCircle.startX-o.rotationCircleLine,y:o.centerLeftCircle.startY},e.moveTo(o.rotationCirclePoint.x+o.rotationCircleLine,o.rotationCirclePoint.y));break;case 180:case-180:r?(o.rotationCirclePoint={x:o.bottomCenterCircle.startX,y:o.bottomCenterCircle.startY+o.rotationCircleLine},e.moveTo(o.rotationCirclePoint.x,o.rotationCirclePoint.y-o.rotationCircleLine)):(o.rotationCirclePoint={x:o.topCenterCircle.startX,y:o.topCenterCircle.startY-o.rotationCircleLine},e.moveTo(o.rotationCirclePoint.x,o.rotationCirclePoint.y+o.rotationCircleLine));break;case 270:case-90:i?(o.rotationCirclePoint={x:o.centerLeftCircle.startX-o.rotationCircleLine,y:o.centerLeftCircle.startY},e.moveTo(o.rotationCirclePoint.x+o.rotationCircleLine,o.rotationCirclePoint.y)):(o.rotationCirclePoint={x:o.centerRightCircle.startX+o.rotationCircleLine,y:o.centerLeftCircle.startY},e.moveTo(o.rotationCirclePoint.x-o.rotationCircleLine,o.rotationCirclePoint.y))}},t.prototype.drawSquareLines=function(e){var t=this.parent,o=t.activeObj,i=o.activePoint,r=i.startX,n=i.startY,a=i.width,i=i.height,s=o.strokeSettings,l=s.fillColor,p=s.strokeColor,h=s.strokeWidth,s=s.radius,o=("crop"===(d=o.shape?o.shape.split("-"):d)[0]?e.strokeStyle="#fff":e.strokeStyle=p,e.beginPath(),{width:0,height:0}),d=(t.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:o,dimension:{width:e.canvas.width,height:e.canvas.height}}}),e.canvas.id===t.element.id+"_tempCanvas"),c=t.transform.zoomFactor,d=d?10*s*((o.width+o.height)/2):10*s,o=d+d*c;null!==s?t.isSafari?this.drawRoundedRect(e,r,n,a,i,o):e.roundRect(r,n,a,i,o):e.rect(r,n,a,i),""!==l&&(e.fillStyle=l,e.fill()),null!==s?t.isSafari?this.drawRoundedRect(e,r+h,n+h,a-2*h,i-2*h,o):e.roundRect(r+h,n+h,a-2*h,i-2*h,o):e.rect(r+h,n+h,a-2*h,i-2*h),e.fillStyle=p,e.fill("evenodd"),e.closePath()},t.prototype.drawRoundedRect=function(e,t,o,i,r,n){n=Math.max(0,Math.min(n,i/2,r/2));e.moveTo(t+n,o),e.arcTo(t+i,o,t+i,o+r,n),e.arcTo(t+i,o+r,o,o+r,n),e.arcTo(t,o+r,t,o,n),e.arcTo(t,o,t+i,o,n),e.closePath()},t.prototype.drawSelection=function(e,t){var o=this.parent,i=o.activeObj,r=i.activePoint,n=r.startX,a=r.startY,s=r.endX,r=r.endY;this.upperContext.strokeStyle=o.themeColl[o.theme].primaryColor,this.upperContext.beginPath(),i.horTopInnerLine={startX:n,startY:a+t,endX:s,endY:r+t},i.horBottomInnerLine={startX:n,startY:a+2*t,endX:s,endY:r+2*t},i.verLeftInnerLine={startX:n+e,startY:a,endX:n+e,endY:r},i.verRightInnerLine={startX:n+2*e,startY:a,endX:n+2*e,endY:r},this.upperContext.moveTo(i.horTopInnerLine.startX,i.horTopInnerLine.startY),this.upperContext.lineTo(i.horTopInnerLine.endX,i.horTopInnerLine.startY),this.upperContext.moveTo(i.horBottomInnerLine.startX,i.horBottomInnerLine.startY),this.upperContext.lineTo(i.horBottomInnerLine.endX,i.horBottomInnerLine.startY),this.upperContext.moveTo(i.verLeftInnerLine.startX,i.verLeftInnerLine.startY),this.upperContext.lineTo(i.verLeftInnerLine.endX,i.verLeftInnerLine.endY),this.upperContext.moveTo(i.verRightInnerLine.startX,i.verRightInnerLine.startY),this.upperContext.lineTo(i.verRightInnerLine.endX,i.verRightInnerLine.endY),this.upperContext.stroke(),this.upperContext.closePath()},t.prototype.shapeCircle=function(e,t,o){var i=this.parent,r=i.activeObj.activePoint,n=r.startX,a=r.startY,s=r.endX,l=r.endY,r=r.width,p=(e.strokeStyle=i.themeColl[i.theme].primaryColor,e.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),e.fillStyle="rgb(0, 0, 0, 0.25)",e.fillRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),e.lineWidth);e.lineWidth=2,e.beginPath(),e.ellipse(i.activeObj.horTopLine.startX+t/2,i.activeObj.horTopLine.startY+o/2,t/2,o/2,0,0,2*Math.PI,!1),e.stroke(),e.closePath(),e.save(),e.beginPath(),e.arc((s-n)/2+n,(l-a)/2+a,r/2,0,2*Math.PI),e.closePath(),e.clip(),e.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),e.restore(),e.lineWidth=p,this.drawOuterSelection(e,!0),i.currObjType.shape=""},t.prototype.shapeLine=function(e,t,o,i,r){var n=e.lineWidth;e.lineWidth=this.parent.activeObj.strokeSettings.strokeWidth,e.beginPath(),e.moveTo(t,o),e.lineTo(i,r),e.stroke(),e.lineWidth=n},t.prototype.manipulateSaveCtx=function(e,t,o){var i;return e!==this.lowerContext&&e!==this.upperContext&&(this.parent.notify("crop",{prop:"calcRatio",onPropertyChange:!(i={width:0,height:0}),value:{obj:i,dimension:{width:e.canvas.width,height:e.canvas.height}}}),t&&(t*=i.width),o)&&(o*=i.height),{x:t,y:o}},t.prototype.arrow=function(e,t){var o=this.parent.activeObj,i=o.activePoint,r=i.startX,n=i.startY,a=i.endX,i=i.endY,s=o.strokeSettings.strokeWidth,l=(e.lineWidth=s,this.arrowDimension.arrow.width),p=this.arrowDimension.arrow.height,h=this.manipulateSaveCtx(e,l,p),l=h.x+s,p=h.y+s,h=(this.dx=a-r,this.dy=i-n,e.fillStyle=o.strokeSettings.strokeColor,Math.atan2(this.dy,this.dx)),s="arrow"===o.start,d="arrow"===o.end,c="circle"===o.end||"square"===o.end,u="circle"===o.start||"square"===o.start;((t&&"left"===o.triangleDirection||"right"===o.triangleDirection)&&(s&&"none"===o.end||s&&!c&&!u)||!t&&(d&&"none"===o.start||!s&&!c&&!u))&&this.shapeLine(e,r,n,a,i),t&&"left"===o.triangleDirection||!t&&"right"===o.triangleDirection?(e.translate(a,i),e.rotate(h),this.shapeLine(e,0,0,-l,p/2),this.shapeLine(e,0,0,-l,-p/2),e.rotate(-h),e.translate(-a,-i)):(t&&"right"===o.triangleDirection||!t&&"left"===o.triangleDirection)&&(e.translate(r,n),e.rotate(h),this.shapeLine(e,0,0,l,p/2),this.shapeLine(e,0,0,l,-p/2),e.rotate(-h),e.translate(-r,-n))},t.prototype.arrowSolid=function(e,t){var o=this.parent.activeObj,i=o.strokeSettings.strokeWidth,r=o.activePoint,n=r.startX,a=r.startY,s=r.endX,r=r.endY,l=this.arrowDimension.arrowSolid.width,p=this.arrowDimension.arrowSolid.height,h=this.manipulateSaveCtx(e,l,p),l=h.x+i,p=h.y+i,h=(this.dx=s-n,this.dy=r-a,Math.atan2(this.dy,this.dx)),d="arrowSolid"===o.start,c="arrowSolid"===o.end,u="circle"===o.end||"square"===o.end,g="circle"===o.start||"square"===o.start;(t&&d&&"none"===o.end||d&&!u&&!g||!t&&(c&&"none"===o.start||!d&&!u&&!g))&&this.shapeLine(e,n,a,s,r),t&&"left"===o.triangleDirection||!t&&"right"===o.triangleDirection?(e.translate(s,r),e.rotate(h),e.beginPath(),e.moveTo(i,0),e.lineTo(p/2-l,p/2),e.lineTo(p/2-l,-p/2),e.closePath(),e.fill(),e.rotate(-h),e.translate(-s,-r),o.rotatedAngle=h):(t&&"right"===o.triangleDirection||!t&&"left"===o.triangleDirection)&&(e.translate(n,a),e.rotate(h),e.beginPath(),e.moveTo(0-i,0),e.lineTo(l-p/2,p/2),e.lineTo(l-p/2,-p/2),e.closePath(),e.fill(),e.rotate(-h),e.translate(-n,-a),o.rotatedAngle=h)},t.prototype.arrowSquareStart=function(e){var t=this.parent.activeObj,o=t.strokeSettings.strokeWidth,i=t.activePoint,r=i.startX,n=i.startY,a=i.endX,i=i.endY,s="square"===t.start,l="circle"===t.end,p="squareSolid"===t.start,h="circleSolid"===t.end,s=((s&&"none"===t.end||s&&!l&&"square"!==t.start||p&&h)&&this.shapeLine(e,r,n,a,i),e.lineWidth=o,e.beginPath(),e.fillStyle=t.strokeSettings.strokeColor,this.arrowDimension.square.width),l=this.arrowDimension.square.height,p=this.manipulateSaveCtx(e,s,l),s=p.x+o,l=p.y+o,h=(this.dx=a-r,this.dy=i-n,Math.atan2(this.dy,this.dx));"left"===t.triangleDirection?(e.translate(a,i),e.rotate(h),"squareSolid"===t.start&&e.fillRect(l/2-s,-l/2,s,l),e.strokeRect(l/2-s,-l/2,s,l),e.rotate(-h),e.translate(-a,-i),this.squareStartIntersectX1=a-l/2*Math.cos(h),this.squareStartIntersectY1=i-l/2*Math.sin(h),"square"===t.start&&"square"!==t.end&&"circle"!==t.end?this.shapeLine(e,r,n,this.squareStartIntersectX1,this.squareStartIntersectY1):"square"===t.start&&"circle"===t.end?this.shapeLine(e,this.endCircleIntersectX1,this.endCircleIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1):"squareSolid"===t.start&&"squareSolid"===t.end&&this.shapeLine(e,r,n,a,i)):"right"===t.triangleDirection&&(e.lineWidth=o,e.fillStyle=t.strokeSettings.strokeColor,"squareSolid"===t.start&&"squareSolid"===t.end&&this.shapeLine(e,r,n,a,i),e.translate(r,n),e.rotate(h),"squareSolid"===t.start&&e.fillRect(l/2-s,-l/2,s,l),e.strokeRect(l/2-s,-l/2,s,l),e.rotate(-h),e.translate(-r,-n),t.rotatedAngle=h,this.squareStartIntersectX1=r+l/2*Math.cos(h),this.squareStartIntersectY1=n+l/2*Math.sin(h),"square"===t.start&&"square"!==t.end&&"circle"!==t.end&&this.shapeLine(e,a,i,this.squareStartIntersectX1,this.squareStartIntersectY1),"square"===t.start)&&"circle"===t.end&&this.shapeLine(e,this.endCircleIntersectX1,this.endCircleIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1)},t.prototype.arrowSquareEnd=function(e){var t=this.parent.activeObj,o=t.activePoint,i=o.startX,r=o.startY,n=o.endX,o=o.endY,a=t.strokeSettings.strokeWidth,s=this.arrowDimension.square.width,l=this.arrowDimension.square.height,p=this.manipulateSaveCtx(e,s,l),s=p.x+a,l=p.y+a,p=(this.dx=n-i,this.dy=o-r,Math.atan2(this.dy,this.dx));e.lineWidth=a,"right"===t.triangleDirection?(e.fillStyle=t.strokeSettings.strokeColor,"squareSolid"===t.end&&"none"===t.start&&this.shapeLine(e,i,r,n,o),e.translate(n,o),e.rotate(p),"squareSolid"===t.end&&e.fillRect(l/2-s,-l/2,s,l),e.strokeRect(l/2-s,-l/2,s,l),e.rotate(-p),e.translate(-n,-o),t.rotatedAngle=p,this.squareEndIntersectX1=n-l/2*Math.cos(p),this.squareEndIntersectY1=o-l/2*Math.sin(p),"square"===t.end&&"square"!==t.start&&"circle"!==t.start?this.shapeLine(e,i,r,this.squareEndIntersectX1,this.squareEndIntersectY1):"circle"===t.start&&"square"===t.end?this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.startCircleIntersectX1,this.startCircleIntersectY1):"square"===t.start&&"square"===t.end&&this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1)):"left"===t.triangleDirection&&(e.translate(i,r),e.rotate(p),"squareSolid"===t.end&&e.fillRect(l/2-s,-l/2,s,l),e.strokeRect(l/2-s,-l/2,s,l),e.rotate(-p),e.translate(-i,-r),t.rotatedAngle=p,this.squareEndIntersectX1=i+l/2*Math.cos(p),this.squareEndIntersectY1=r+l/2*Math.sin(p),"square"===t.end&&"square"!==t.start&&"circle"!==t.start?this.shapeLine(e,n,o,this.squareEndIntersectX1,this.squareEndIntersectY1):"circle"===t.start&&"square"===t.end?this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.startCircleIntersectX1,this.startCircleIntersectY1):"square"===t.start&&"square"===t.end?this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1):"squareSolid"===t.end&&"none"===t.start&&this.shapeLine(e,i,r,n,o))},t.prototype.arrowCircle=function(e,t){var o,i,r,n,a,s,l,p,h=this.parent,d=h.activeObj,c=d.activePoint,u=c.startX,g=c.startY,v=c.endX,c=c.endY,f=d.strokeSettings.strokeWidth;t&&"left"===d.triangleDirection||!t&&"right"===d.triangleDirection?(e.lineWidth=f,o=this.arrowDimension.circle.width,o=this.manipulateSaveCtx(e,o,null).x+f,e.beginPath(),e.arc(v,c,o,0,2*Math.PI),e.stroke(),e.closePath(),this.dx=v-u,this.dy=c-g,i=this.dx*this.dx+this.dy*this.dy,0<=(n=(r=2*(this.dx*(u-v)+this.dy*(g-c)))*r-4*i*((u-v)*(u-v)+(g-c)*(g-c)-o*o))&&(e.fillStyle=d.strokeSettings.strokeColor,a=(-r-Math.sqrt(n))/(2*i),s=u+this.dx*a,l=g+this.dy*a,t?(this.startCircleIntersectX1=s,this.startCircleIntersectY1=l,this.endCircleIntersectX1=v-this.dx*a,this.endCircleIntersectY1=c-this.dy*a,e.beginPath(),e.fill(),e.beginPath(),"circle"===d.start&&"circle"===d.end?this.shapeLine(e,this.startCircleIntersectX1,this.startCircleIntersectY1,this.endCircleIntersectX1,this.endCircleIntersectY1):"circle"===d.start&&"circle"!==d.end&&"square"!==d.end&&this.shapeLine(e,u,g,this.startCircleIntersectX1,this.startCircleIntersectY1),e.stroke(),e.closePath()):(this.endCircleIntersectX1=s,this.endCircleIntersectY1=l,"circle"===d.end&&"circle"!==d.start&&"square"!==d.start&&this.shapeLine(e,u,g,this.endCircleIntersectX1,this.endCircleIntersectY1))),p=Math.atan2(this.dy,this.dx),h.activeObj.rotatedAngle=p):(t&&"right"===d.triangleDirection||!t&&"left"===d.triangleDirection)&&(e.lineWidth=f,o=this.arrowDimension.circle.width,o=this.manipulateSaveCtx(e,o,null).x+f,e.beginPath(),e.arc(u,g,o,0,2*Math.PI),e.stroke(),e.closePath(),this.dx=u-v,this.dy=g-c,i=this.dx*this.dx+this.dy*this.dy,0<=(n=(r=2*(this.dx*(v-u)+this.dy*(c-g)))*r-4*i*((v-u)*(v-u)+(c-g)*(c-g)-o*o))&&(e.fillStyle=d.strokeSettings.strokeColor,a=(-r-Math.sqrt(n))/(2*i),s=v+this.dx*a,l=c+this.dy*a,t?(this.startCircleIntersectX1=s,this.startCircleIntersectY1=l,this.endCircleIntersectX1=u-this.dx*a,this.endCircleIntersectY1=g-this.dy*a,"circle"===d.start&&"circle"===d.end?this.shapeLine(e,this.endCircleIntersectX1,this.endCircleIntersectY1,this.startCircleIntersectX1,this.startCircleIntersectY1):"circle"===d.start&&"circle"!==d.end&&"square"!==d.end&&this.shapeLine(e,v,c,this.startCircleIntersectX1,this.startCircleIntersectY1)):(this.endCircleIntersectX1=s,this.endCircleIntersectY1=l,e.beginPath(),e.fill(),e.beginPath(),"circle"===d.end&&"circle"!==d.start&&"square"!==d.start&&this.shapeLine(e,v,c,this.endCircleIntersectX1,this.endCircleIntersectY1))),p=Math.atan2(this.dy,this.dx),h.activeObj.rotatedAngle=p)},t.prototype.arrowCircleSolid=function(e,t){var o,i=this.parent.activeObj,r=i.activePoint,n=r.startX,a=r.startY,s=r.endX,r=r.endY,l="circleSolid"===i.start,p=i.strokeSettings.strokeWidth;t&&"left"===i.triangleDirection||!t&&"right"===i.triangleDirection?(e.lineWidth=p,e.beginPath(),e.fillStyle=i.strokeSettings.strokeColor,(t&&l&&"none"===i.end||l&&"circle"!==i.end&&"square"!==i.end||!t&&"circleSolid"===i.end&&"none"===i.start)&&this.shapeLine(e,n,a,s,r),o=this.arrowDimension.circle.width,o=this.manipulateSaveCtx(e,o,null).x+p,this.dx=s-n,this.dy=r-a,e.save(),e.beginPath(),e.arc(s,r,o,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),i.rotatedAngle=Math.atan2(this.dy,this.dx)):(t&&"right"===i.triangleDirection||!t&&"left"===i.triangleDirection)&&(e.lineWidth=p,e.beginPath(),e.fillStyle=i.strokeSettings.strokeColor,(t&&l&&"none"===i.end||l&&"circle"!==i.end&&"square"!==i.end||!t&&"circleSolid"===i.end&&"none"===i.start)&&this.shapeLine(e,n,a,s,r),o=this.arrowDimension.circle.width,o=this.manipulateSaveCtx(e,o,null).x+p,this.dx=s-n,this.dy=r-a,e.save(),e.beginPath(),e.arc(n,a,o,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),i.rotatedAngle=Math.atan2(this.dy,this.dx))},t.prototype.arrowBar=function(e,t){var o,i,r,n,a=this.parent,s=a.activeObj,l=s.activePoint,p=l.startX,h=l.startY,d=l.endX,l=l.endY,c=s.strokeSettings.strokeWidth;t&&"left"===s.triangleDirection||!t&&"right"===s.triangleDirection?(e.lineWidth=c,e.beginPath(),e.fillStyle=s.strokeSettings.strokeColor,(t&&"bar"===s.start&&"none"===s.end||"bar"===s.start&&"circle"!==s.end&&"square"!==s.end||!t&&("bar"===s.end&&"none"===s.start||"bar"===s.end&&"circle"!==s.start&&"square"!==s.start))&&this.shapeLine(e,p,h,d,l),o=this.arrowDimension.bar.width,i=this.arrowDimension.bar.height,o=(r=this.manipulateSaveCtx(e,o,i)).x+c,i=r.y+c,this.dx=d-p,this.dy=l-h,n=Math.atan2(this.dy,this.dx),e.translate(d,l),e.rotate(n),e.fillRect(i/4-o,-i/2,o,i),e.rotate(-n),e.translate(-d,-l),s.rotatedAngle=n):(t&&"right"===s.triangleDirection||!t&&"left"===s.triangleDirection)&&(e.lineWidth=c,e.beginPath(),e.fillStyle=s.strokeSettings.strokeColor,(t&&"bar"===s.start&&"none"===s.end||"bar"===s.start&&"circle"!==s.end&&"square"!==s.end||!t&&"bar"===s.end&&"none"===s.start)&&this.shapeLine(e,p,h,d,l),o=this.arrowDimension.bar.width,i=this.arrowDimension.bar.height,o=(r=this.manipulateSaveCtx(e,o,i)).x+c,i=r.y+c,this.dx=d-p,this.dy=l-h,n=Math.atan2(this.dy,this.dx),e.translate(p,h),e.rotate(n),e.fillRect(i/4-o,-i/2,o,i),e.rotate(-n),e.translate(-p,-h),a.activeObj.rotatedAngle=n)},t.prototype.shapeImage=function(e){var t=this.parent,o=t.activeObj,i=o.activePoint,r=i.startX,n=i.startY,a=i.width,i=i.height,s=o.imageCanvas.getContext("2d"),l=(e===this.lowerContext&&this.isImageApply&&(t.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!(l={width:0,height:0}),value:{width:o.imageElement.width,height:o.imageElement.height,obj:l,isImgShape:null}}),a<l.width/5||i<l.height/5)&&(s.clearRect(0,0,o.imageCanvas.width,o.imageCanvas.height),t.notify("selection",{prop:"applyTransformToImg",onPropertyChange:!1,value:{ctx:s}}),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("selection",{prop:"setImageClarity",onPropertyChange:!1,value:{bool:!1}}),this.isImageApply=!1),{startX:0,startY:0,width:0,height:0}),s=(l.width=a,l.height=i,4===o.flipObjColl.length&&(o.flipObjColl=[],o.shapeFlip=""),l.startX=(a-l.width)/2+r,l.startY=(i-l.height)/2+n,e.globalAlpha);e.globalAlpha=o.opacity,o.rotateFlipColl&&0<o.rotateFlipColl.length?this.rotateImage(e):e.drawImage(o.imageCanvas,l.startX,l.startY,l.width,l.height),e.globalAlpha=s,t.currObjType.isText=!1},t.prototype.shapeText=function(e){var t=this.parent,o=e.filter,i=t.activeObj,r=i.activePoint,n=r.startX,a=r.startY,s=r.width,l=r.height,p=i.keyHistory.split("\n"),r=i.textSettings,h=r.fontFamily,d=r.bold,c=r.italic,u=i.textSettings.fontSize,g=((u+.25*u)*p.length-u*p.length)/p.length,r=(e.filter="none",e.fillStyle);""!==i.strokeSettings.fillColor&&(e.fillStyle=i.strokeSettings.fillColor,e.fillRect(i.activePoint.startX,i.activePoint.startY,i.activePoint.width,i.activePoint.height)),e.fillStyle=r;for(var v=0;v<p.length;v++){var f=p[v],C=(v+1)*u*.85+v*g,b=(-360===t.transform.degree&&(t.transform.degree=0),0===t.transform.degree||180===t.transform.degree?l<u&&(u=i.textSettings.fontSize=l-.1*l):s<u&&(u=i.textSettings.fontSize=s-.1*s),e.strokeStyle=i.strokeSettings.outlineColor,e.fillStyle=i.strokeSettings.strokeColor,e.lineWidth),m={width:0,height:0},y=(t.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:m,dimension:{width:e.canvas.width,height:e.canvas.height}}}),m=m,e.canvas.id===t.element.id+"_tempCanvas"),P=Math.max(1,i.strokeSettings.outlineWidth/2),P=(/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$|^[a-zA-Z]+$/.test(i.strokeSettings.outlineColor)?(e.lineWidth=P*(.5*(y?Math.floor((u-1)/60):Math.floor((u-1)/16))+.5),y&&(e.lineWidth*=(m.width+m.height)/2,0!==t.transform.degree)&&(e.lineWidth/=1.8)):e.lineWidth=1,"");d&&(P="bold "),c&&(P="italic "),e.font=(P=d&&c?"italic bold ":P)+u+"px "+h,4===i.flipObjColl.length&&(i.flipObjColl=[],i.shapeFlip=""),i.rotateFlipColl&&0<i.rotateFlipColl.length?this.rotateText(e):(e.strokeText(f,n+.1*u,a+C),e.fillText(f,n+.1*u,a+C)),e.lineWidth=b}e.filter=o,t.currObjType.isText=!1,this.upperContext===e&&this.drawOuterSelection(e)},t.prototype.updateActPoint=function(e,t){var o=this.parent,i=o.activeObj,r=i.activePoint;return"horizontal"===e.toLowerCase()?r.startX<=t.canvas.width/2?(r.startX=t.canvas.width/2+(t.canvas.width/2-r.endX),r.endX=r.startX+r.width,this.updateActiveObject(r,i),o.activeObj=i):r.startX>=t.canvas.width/2&&(r.startX=t.canvas.width-r.endX,r.endX=r.startX+r.width,this.updateActiveObject(r,i),o.activeObj=i):"vertical"===e.toLowerCase()&&(r.startY<=t.canvas.height/2?(r.startY=t.canvas.height/2+(t.canvas.height/2-r.endY),r.endY=r.startY+r.height,this.updateActiveObject(r,i),o.activeObj=i):r.startY>=t.canvas.height/2&&(r.startY=t.canvas.height-r.endY,r.endY=r.startY+r.height,this.updateActiveObject(r,i),o.activeObj=i)),r},t.prototype.rotateImage=function(e){var t,o=this.parent,i=o.activeObj,r=T.extend({},o.activeObj,null,!0),n=0===i.shapeDegree?o.transform.degree:o.transform.degree-i.shapeDegree,a={startX:0,startY:0,width:0,height:0},s=(a.width=(n=(n=-450===n?-90:n)<0?360+n:n)%90==0&&n%180!=0?i.activePoint.height:i.activePoint.width,a.height=n%90==0&&n%180!=0?i.activePoint.width:i.activePoint.height,a.startX=i.activePoint.startX,a.startY=i.activePoint.startY,a.startX),l=a.startY;e.save();for(var p=0,h=i.rotateFlipColl.length;p<h;p++){var d=i.rotateFlipColl[p];"number"==typeof d?(t=d,a.width=(t=(t=-450===t?-90:t)<0?360+t:t)%90==0&&t%180!=0?i.activePoint.height:i.activePoint.width,a.height=t%90==0&&t%180!=0?i.activePoint.width:i.activePoint.height,e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*d),e.translate(-e.canvas.height/2,-e.canvas.width/2),t%90==0&&t%270!=0||0===t?(l=e.canvas.width-(i.activePoint.startX+i.activePoint.width),l+=(i.activePoint.width-a.height)/2,s=a.startY):t%270==0&&(s=e.canvas.height-(i.activePoint.startY+i.activePoint.height),s+=(i.activePoint.height-a.width)/2,l=a.startX),a.startX=s,a.startY=l,i.activePoint.startX=s,i.activePoint.startY=l,i.activePoint.endX=i.activePoint.startX+a.width,i.activePoint.endY=i.activePoint.startY+a.height,i=this.updateWidthHeight(i)):("horizontal"===d&&n%90==0&&n%180!=0?d="vertical":"vertical"===d&&n%90==0&&n%180!=0&&(d="horizontal"),"horizontal"===d?(e.translate(e.canvas.width,0),e.scale(-1,1),i.activePoint=this.updateActPoint("horizontal",e)):"vertical"===d&&(e.translate(0,e.canvas.height),e.scale(1,-1),i.activePoint=this.updateActPoint("vertical",e)),a.startX=i.activePoint.startX,a.startY=i.activePoint.startY),a.startX=i.activePoint.startX,a.startY=i.activePoint.startY,s=a.startX,l=a.startY}0!==i.rotatedAngle&&o.notify("shape",{prop:"setPointCollForShapeRotation",onPropertyChange:!1,value:{obj:i}}),e.drawImage(i.imageCanvas,a.startX,a.startY,a.width,a.height),e.restore(),o.activeObj=r,360!==o.transform.degree&&-360!==o.transform.degree||(o.transform.degree=0)},t.prototype.rotateText=function(e){var t,o=this.parent,i=o.activeObj,r=T.extend({},o.activeObj,null,!0),n=o.activeObj.activePoint,a=0===i.shapeDegree?o.transform.degree:o.transform.degree-i.shapeDegree,s={startX:0,startY:0,width:0,height:0},l=(s.width=(a=(a=-450===a?-90:a)<0?360+a:a)%90==0&&a%180!=0?n.height:n.width,s.height=a%90==0&&a%180!=0?n.width:n.height,s.startX=n.startX,s.startY=n.startY,s.startX),p=s.startY;e.save();for(var h=0,d=i.rotateFlipColl.length;h<d;h++){var c=i.rotateFlipColl[h];"number"==typeof c?(t=c,s.width=(t=(t=-450===t?-90:t)<0?360+t:t)%90==0&&t%180!=0?n.height:n.width,s.height=t%90==0&&t%180!=0?n.width:n.height,e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*c),e.translate(-e.canvas.height/2,-e.canvas.width/2),t%90==0&&t%270!=0||0===t?(p=e.canvas.width-n.endX,l=n.startY):t%270==0&&(l=e.canvas.height-n.endY,p=n.startX),s.startX=l,s.startY=p,n.startX=l,n.startY=p,n.endX=n.startX+s.width,n.endY=n.startY+s.height,i=this.updateWidthHeight(i)):("horizontal"===c&&a%90==0&&a%180!=0?c="vertical":"vertical"===c&&a%90==0&&a%180!=0&&(c="horizontal"),"horizontal"===c?(e.translate(e.canvas.width,0),e.scale(-1,1)):"vertical"===c&&(e.translate(0,e.canvas.height),e.scale(1,-1)),i.activePoint=n=this.updateActPoint(c,e),s.startX=n.startX,s.startY=n.startY),s.startX=n.startX,s.startY=n.startY,l=s.startX,p=s.startY}0!==i.rotatedAngle&&o.notify("shape",{prop:"setPointCollForShapeRotation",onPropertyChange:!1,value:{obj:i}}),p+=.4*i.textSettings.fontSize,this.textFlipDegree(e,l,p),e.restore(),o.activeObj=r,360!==o.transform.degree&&-360!==o.transform.degree||(o.transform.degree=0)},t.prototype.textFlipDegree=function(e,t,o){for(var i=this.parent.activeObj,r=i.keyHistory.split("\n"),n=i.textSettings.fontSize,a=.85*n+(n*r.length-n*r.length)/r.length,s=0,l=r.length;s<l;s++){var p=r[s];0<s&&(1===s&&(a-=.85*n),a+=n+.15*n),e.strokeText(p,t+.15*n,o+a+(0<s?.25*n:.35*-n)),e.fillText(p,t+.15*n,o+a+(0<s?.25*n:.35*-n))}},t.prototype.clearOuterCanvas=function(e){var t=this.parent,o=t.img,i=o.destLeft,r=o.destTop,n=o.destWidth,o=o.destHeight,a=0<r?r:0;e.clearRect(0,0,0<i?i:0,t.lowerCanvas.height),e.clearRect(i+n,0,t.lowerCanvas.width-(i+n),t.lowerCanvas.height),e.clearRect(0,0,t.lowerCanvas.width,a),e.clearRect(0,r+o,t.lowerCanvas.width,t.lowerCanvas.height-(r+o)),""!==t.transform.currFlipState&&(t.img.destLeft=i,t.img.destTop=r)},t.prototype.setDestPoints=function(){var e,t,o=this.parent,i=o.transform,r=i.degree,i=i.zoomFactor;r%90==0&&r%180!=0?(o.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!(t={width:0,height:0}),value:{width:o.img.srcHeight,height:o.img.srcWidth,obj:t,isImgShape:null}}),e=t,this.isRotateZoom&&(e.width+=e.width*i,e.height+=e.height*i,o.img.destWidth=e.height,o.img.destHeight=e.width),o.img.destLeft=(o.lowerCanvas.clientWidth-e.height)/2,o.img.destTop=(o.lowerCanvas.clientHeight-e.width)/2,o.img.destWidth=e.height,o.img.destHeight=e.width):(o.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!(t={width:0,height:0}),value:{width:o.img.srcWidth,height:o.img.srcHeight,obj:t,isImgShape:null}}),e=t,this.isRotateZoom&&(e.width+=e.width*i,e.height+=e.height*i,o.img.destWidth=e.width,o.img.destHeight=e.height),o.img.destLeft=(o.lowerCanvas.clientWidth-e.width)/2,o.img.destTop=0===r?(o.lowerCanvas.clientHeight-e.height+1)/2:(o.lowerCanvas.clientHeight-e.height)/2,o.img.destWidth=e.width,o.img.destHeight=e.height)},t.prototype.updateCurrTransState=function(e,t,o,i){var r=this.parent,n=r.img.destLeft,a=r.img.destTop;"initial"===e&&(this.lowerContext.setTransform(1,0,0,1,0,0),T.isNullOrUndefined(t))&&this.setDestPoints(),r.isCircleCrop||r.currSelectionPoint&&"crop-circle"===r.currSelectionPoint.shape?(this.currTransState(e,!0,null,o),0===r.transform.degree&&""===r.transform.currFlipState&&0===r.transform.straighten&&T.isNullOrUndefined(i)&&(r.img.destLeft=n,r.img.destTop=a),o&&(r.img.destLeft+=r.panPoint.totalPannedClientPoint.x,r.img.destTop+=r.panPoint.totalPannedClientPoint.y),r.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),o&&(r.img.destLeft-=r.panPoint.totalPannedClientPoint.x,r.img.destTop-=r.panPoint.totalPannedClientPoint.y)):(this.currTransState(e,null,null,o),0===r.transform.degree&&""===r.transform.currFlipState&&0===r.transform.straighten&&T.isNullOrUndefined(i)&&(r.img.destLeft=n,r.img.destTop=a))},t.prototype.currTransState=function(e,t,o,i){var r=this.parent;o=o||this.lowerContext,"initial"===e?this.setTransformColl(o,e):"reverse"===e&&(this.setTransformColl(o,e),this.setClientTransDim(t),r.isCircleCrop||r.currSelectionPoint&&"crop-circle"===r.currSelectionPoint.shape&&T.isNullOrUndefined(i))&&(i&&(r.img.destLeft+=r.panPoint.totalPannedClientPoint.x,r.img.destTop+=r.panPoint.totalPannedClientPoint.y),r.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),i)&&(r.img.destLeft-=r.panPoint.totalPannedClientPoint.x,r.img.destTop-=r.panPoint.totalPannedClientPoint.y)},t.prototype.setTransformColl=function(e,t){var o=this.parent;if("initial"===t)for(var i=0,r=o.rotateFlipColl.length;i<r;i++)this.setTransform(e,o.rotateFlipColl[i]);else if("reverse"===t)for(i=o.rotateFlipColl.length-1;0<=i;i--)this.setTransform(e,o.rotateFlipColl[i],!0)},t.prototype.setTransform=function(e,t,o){var i=this.parent;switch(o&&90===t?t=-90:o&&-90===t&&(t=90),"horizontal"===t&&i.transform.degree%90==0&&i.transform.degree%180!=0?t="vertical":"vertical"===t&&i.transform.degree%90==0&&i.transform.degree%180!=0&&(t="horizontal"),i.notify("transform",{prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!0}}),i.notify("transform",{prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!0}}),T.isNullOrUndefined(o)&&e.clearRect(0,0,e.canvas.width,e.canvas.height),t){case 90:case-90:e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*t),e.translate(-e.canvas.width/2,-e.canvas.height/2);break;case"horizontal":e.translate(e.canvas.width,0),e.scale(-1,1);break;case"vertical":e.translate(0,e.canvas.height),e.scale(1,-1)}i.notify("transform",{prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!1}}),i.notify("transform",{prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!1}})},t.prototype.drawImgToCanvas=function(e){var t=this.parent,e=(this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.img.destWidth=e.width,t.img.destHeight=e.height,this.isInitialLoading&&(t.notify("filter",{prop:"initFilter",onPropertyChange:!1}),this.isInitialLoading=!1),this.lowerContext.filter);this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.drawImage(),(t.currSelectionPoint&&"crop-circle"===t.currSelectionPoint.shape||t.isCircleCrop)&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),this.lowerContext.filter=e},t.prototype.renderImage=function(e,t,o,i){var r=this.parent;r.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),T.isNullOrUndefined(t)&&(this.upperContext.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height),this.lowerContext.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height)),e?this.setTransformColl(this.lowerContext,"initial"):(0!==r.transform.zoomFactor&&(this.isRotateZoom=!0),this.updateCurrTransState("initial",null,null,i)),r.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),this.drawImage(),r.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),e?this.setTransformColl(this.lowerContext,"reverse"):(this.updateCurrTransState("reverse",null,null,i),this.isRotateZoom=!1),o?r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}):r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.clearOuterCanvas(this.lowerContext),(r.isCircleCrop||r.currSelectionPoint&&"crop-circle"===r.currSelectionPoint.shape)&&r.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})},t.prototype.imageOnLoad=function(s){var l=this,p=this.parent,h=this;p.baseImg.src=s,p.baseImg.onload=function(){p.imgSrc=s,p.isUndoRedo||p.notify("filter",{prop:"update-finetunes",onPropertyChange:!1}),h.lowerContext.drawImage(p.baseImg,0,0,h.parent.lowerCanvas.width,h.parent.lowerCanvas.height);var e,t,o,i,r=!1,n=!1,a=(p.isImageUpdated&&(a=(e=p.img).srcWidth,e=e.srcHeight,t=(o=p.baseImgCanvas).width,o=o.height,r=a!==t||e!==o,n=p.baseImg.width===t&&p.baseImg.height===o),f.hideSpinner(p.element),p.element.style.opacity="1",h.updateBaseImgCanvas(),{fileName:l.fileName,fileType:l.fileType,isValidImage:!0});h.updateCanvas(r,n),p.currObjType.isUndoZoom&&(p.currObjType.isUndoZoom=!1,h.parent.lowerCanvas.style.display="block"),p.isUndoRedo=l.isErrorImage=!1,T.Browser.isDevice?(p.notify("toolbar",{prop:"destroy-top-toolbar",onPropertyChange:!1}),p.notify("toolbar",{prop:"destroy-bottom-toolbar",onPropertyChange:!1}),i={isApplyBtn:!1,isDevice:T.Browser.isDevice,isOkBtn:null,isResize:null,isFrame:null,isMainToolbar:!0},p.notify("toolbar",{prop:"init-main-toolbar",onPropertyChange:!1,value:i}),p.notify("toolbar",{prop:"create-bottom-toolbar",onPropertyChange:!1})):(p.notify("toolbar",{prop:"destroy-top-toolbar",onPropertyChange:!1}),p.notify("toolbar",{prop:"init-main-toolbar",onPropertyChange:!(i={isApplyBtn:!1,isDevice:!1,isOkBtn:null}),value:i})),p.isImageLoaded&&"0.5"!==p.element.style.opacity&&(p.trigger("fileOpened",a),p.triggerEditCompleteEvent({action:"file-open",actionEventArgs:a}))},p.baseImg.onerror=function(){f.hideSpinner(p.element),h.isErrorImage=!0,h.errorLoading()}},t.prototype.errorLoading=function(){this.parent.trigger("fileOpened",{fileName:null,fileType:null,isValidImage:!1})},t.prototype.updateBaseImgCanvas=function(){var e=this.parent;e.baseImgCanvas.width=e.baseImg.width,e.baseImgCanvas.height=e.baseImg.height,e.baseImgCanvas.getContext("2d").drawImage(e.baseImg,0,0)},t.prototype.updateCanvas=function(e,t){var o=this.parent,t=(o.isImageUpdated&&e?!t&&e&&(o.img.srcLeft=0,o.img.srcTop=0,o.img.srcWidth=o.baseImgCanvas.width,o.img.srcHeight=o.baseImgCanvas.height,o.currSelectionPoint=null,o.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",straighten:0,destPoints:{startX:0,startY:0,width:0,height:0},srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:!1,zoomFactor:0,previousZoomValue:0,aspectWidth:null,aspectHeight:null,frame:"none",straightenZoom:0,adjustmentLevel:{brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},currentFilter:""}):(o.img.srcWidth=o.baseImgCanvas.width,o.img.srcHeight=o.baseImgCanvas.height),{width:0,height:0}),e=(o.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:o.img.srcWidth,height:o.img.srcHeight,obj:t,isImgShape:null}}),t),t=(o.img.destLeft=(o.lowerCanvas.clientWidth-e.width)/2,o.img.destTop=(o.lowerCanvas.clientHeight-e.height+1)/2,this.drawImgToCanvas(e),this.origDim.width=o.img.destWidth,this.origDim.height=o.img.destHeight,this.zoomCrop.width=o.img.destWidth,this.zoomCrop.height=o.img.destHeight,o.notify("transform",{prop:"setCropDimension",onPropertyChange:!1,value:{width:o.img.destWidth,height:o.img.destHeight}}),{startX:o.img.destLeft,startY:o.img.destTop,width:o.img.destWidth,height:o.img.destHeight}),e=(o.notify("crop",{prop:"setCropDestPoints",onPropertyChange:!1,value:{point:t}}),this.lowerContext.filter);this.lowerContext.filter="none",o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=e,0<o.img.destWidth&&0<o.img.destHeight&&(o.isImageLoaded=!0),o.isUndoRedo&&""!==o.transform.currFlipState&&o.notify("transform",{prop:"flipImage",onPropertyChange:!1,value:{direction:o.toPascalCase(o.transform.currFlipState)}}),o.disabled&&o.element.setAttribute("class","e-disabled"),1===o.zoomSettings.zoomFactor&&!o.zoomSettings.zoomPoint||o.zoom(o.zoomSettings.zoomFactor,o.zoomSettings.zoomPoint),T.isNullOrUndefined(this.initZoomValue)&&(this.initZoomValue=o.zoomSettings.zoomFactor),this.isImageEdited=!1},t.prototype.resetFrameZoom=function(e){var t,o=this.parent;T.isNullOrUndefined(o.tempFrameZoomLevel)||(t=o.tempFrameZoomLevel,o.tempFrameZoomLevel=null,o.notify("transform",{prop:"resetZoom",onPropertyChange:!1}),o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:t,zoomPoint:null,isResize:!0}}),t=o.cancelCropSelection,e&&t&&(t.previousObj.frameObj=T.extend({},o.frameObj,null,!0),t.currentObj.frameObj=T.extend({},o.frameObj,null,!0),t.previousObj.frame=t.currentObj.frame=o.frameObj.type),this.updateCropSelObj(),o.cancelCropSelection=null)},t.prototype.performCancel=function(e,t,o){var i=this.parent;o&&(i.noPushUndo=!1);var r,n=i.isStraightening,a=(e=e||!1,{bool:!1}),t=(i.allowDownScale=!0,i.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:a}}),T.isNullOrUndefined(t)&&JSON.stringify(i.frameObj)!==JSON.stringify(i.tempFrameObj)&&(T.extend(i.frameObj,i.tempFrameObj),this.renderImage(null,null,!0)),this.resetFrameZoom(!1),{action:""}),e=(a.bool?(i.notify(t.action="freehand-draw",{prop:"cancelFhd",onPropertyChange:!1}),i.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),i.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})):"block"===i.textArea.style.display||"inline-block"===i.textArea.style.display?(t.action="text-editing",i.textArea.style.display="none",i.textArea.value="",i.textArea.style.transform="",this.prevActObj?(i.activeObj=this.prevActObj,this.prevActObj=null):(i.activeObj.strokeSettings=this.tempStrokeSettings,i.activeObj.textSettings=this.tempTextSettings),i.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}}),this.isShapeTextInserted&&i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),i.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}}),i.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),i.notify("selection",{prop:"setTempActObj",onPropertyChange:!1,value:{obj:i.activeObj}}),i.drawingShape&&i.enableShapeDrawing(i.toPascalCase(i.drawingShape),!0)):i.activeObj.shape&&"redact"===i.activeObj.shape||!((!T.Browser.isDevice||T.Browser.isDevice&&!n)&&document.querySelector("#"+i.element.id+"_sliderWrapper")||i.currObjType.isFiltered)?i.activeObj.shape&&"redact"===i.activeObj.shape||!e||T.Browser.isDevice&&(!T.Browser.isDevice||n)?(this.cancelItems(t),0<i.transform.zoomFactor?(i.togglePan=!0,i.notify("selection",{prop:"setDragCanvas",value:{bool:!0}})):(i.togglePan=!1,i.notify("selection",{prop:"setDragCanvas",value:{bool:!1}}))):i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!(r={type:"main",isApplyBtn:null,isCropping:null,isZooming:null}),value:r}):(t.action=i.isFinetuneBtnClick?"fine-tune":"filter",this.lowerContext.filter=this.tempAdjValue,i.canvasFilter=this.tempAdjValue,i.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.tempAdjValue}}),i.initialAdjustmentValue=this.tempAdjValue,1<this.lowerContext.filter.split(" ").length&&"1"===this.lowerContext.filter.split(" ")[0].split("(")[1].split(")")[0]&&i.notify("filter",{prop:"setBrightnessAdjusted",onPropertyChange:!1,value:{isBrightnessAdjusted:!1}}),i.currentFilter=this.tempFilter,i.notify("filter",{prop:"setBevelFilter",onPropertyChange:!1,value:{bevelFilter:this.lowerContext.filter}}),this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),this.redrawImgWithObj(),i.currObjType.isFiltered=!1,i.notify("filter",{prop:"getTempAdjustmentLevel",onPropertyChange:!(a={tempAdjustmentLevel:null}),value:{obj:a}}),i.notify("filter",{prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:T.extend({},a.tempAdjustmentLevel,{},!0)}}),i.notify("undo-redo",{prop:"setUndoRedoStep",onPropertyChange:!1,value:{step:this.tempUndoRedoStep}}),i.upperCanvas.style.cursor=i.cursor="default",i.currObjType.isCustomCrop=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,radius:null,outlineColor:"",outlineWidth:null},this.clearOuterCanvas(this.lowerContext),(i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape||i.isCircleCrop)&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),r={type:"main",isApplyBtn:null,isCropping:null,isZooming:null},i.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:r}),i.activeObj.shape&&"image"===i.activeObj.shape&&i.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),i.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}}),i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.drawingShape&&(i.drawingShape=null,i.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}))),this.isShapeTextInserted=!1,this.isNewPath=!1,i.notify("toolbar",{prop:"refresh-dropdown-btn",value:{isDisabled:!1}}),i.notify("toolbar",{prop:"setCurrentToolbar",value:{type:"main"}}),o&&(i.noPushUndo=!1),i.drawingShape=null,i.notify("draw",{prop:"resetTempObjColl"}),i.notify("draw",{prop:"resetTempPointColl"}),i.isMaskImage=i.isFinetuneBtnClick=!1,{action:"cancel",actionEventArgs:t});i.triggerEditCompleteEvent(e)},t.prototype.cancelItems=function(e){var t,o=this.parent,i=!1,r=o.element.id,n=o.element.querySelector("#"+r+"_aspectratio"),r=o.element.querySelector("#"+r+"_nonaspectratio");switch((i=void 0===(t=void 0!==o.activeObj.shape?o.activeObj.shape.split("-"):t)&&o.currObjType.isCustomCrop||void 0!==t&&"crop"===t[0]?!0:i)&&o.isCropTab&&(o.isCropTab=!1,o.transform.zoomFactor=o.transform.defaultZoomFactor),o.isResize&&(n||r||"resize-toolbar"===o.currentToolbar)&&(e.action="resize",o.notify("selection",{prop:"getNumTextValue",onPropertyChange:!(t={width:null,height:null}),value:{obj:t}}),n={x:t.width,y:t.height},r=o.element.querySelector("#"+o.element.id+"_aspectratio"),t=o.element.querySelector(".e-ie-toolbar-aspect-ratio-btn"),n.x&&n.y&&!T.isNullOrUndefined(o.aspectWidth)&&(r||t&&!t.classList.contains("e-hidden")?o.notify("transform",{prop:"resizeImage",value:{width:o.aspectWidth,height:o.aspectHeight}}):(n=o.currObjType.isUndoAction,o.currObjType.isUndoAction=!1,o.notify("transform",{prop:"resizeCrop",value:{width:o.aspectWidth,height:o.aspectHeight}}),o.currObjType.isUndoAction=n)),r={prevCropObj:o.prevCropObj},t={prevObj:o.prevObj},o.notify("toolbar",{prop:"getPrevCropObj",onPropertyChange:!1,value:{obj:r}}),o.notify("toolbar",{prop:"getPrevObj",onPropertyChange:!1,value:{obj:t}}),r.prevCropObj&&t.prevObj&&(o.objColl=[],o.pointColl=[],o.freehandCounter=0,o.cropObj=T.extend({},r.prevCropObj,{},!0),this.setCurrentObj(t.prevObj),o.objColl=t.prevObj.objColl,o.pointColl=t.prevObj.pointColl,o.freehandCounter=o.pointColl.length,o.transform.straighten=0,o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),n=o.currSelectionPoint?T.extend({},o.currSelectionPoint,{},!0):null,o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-o.transform.zoomFactor,zoomPoint:null,isResize:!0}}),o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:t.prevObj.defaultZoom,zoomPoint:null,isResize:!0}}),o.currSelectionPoint=n,t.prevObj.zoomFactor&&o.setProperties({zoomSettings:{zoomFactor:t.prevObj.zoomFactor}},!0),o.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:o.zoomSettings.zoomFactor}})),o.isResize=!1,o.notify("transform",{prop:"setResizedImgAngle",onPropertyChange:!1,value:{angle:null}}),r=o.isCropTab,o.isCropTab=!1,this.updateCropSelObj(),o.cancelCropSelection=null,o.isCropTab=r),!0){case o.togglePen:e.action="freehand-draw",this.cancelPen();break;case"text"===o.activeObj.shape:e.action="text",this.cancelText();break;case-1!==["rectangle","ellipse","line","arrow","path","image","redact"].indexOf(o.activeObj.shape):e.action=o.activeObj.shape,this.cancelShape(),o.currObjType.isRedact=!1;break;case i:e.action="crop-selection",this.cancelSelection();break;default:o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}})}o.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),o.upperCanvas.style.cursor=o.cursor="default",o.currObjType.isCustomCrop=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,radius:null,outlineColor:"",outlineWidth:null};o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:!1,isZooming:null}})},t.prototype.cancelPen=function(){var e=this.parent,t=(this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.togglePen=!1,e.upperCanvas.style.cursor=e.cursor="default",T.extend([],e.pointColl,[],!0));e.pointColl={};for(var o=0;o<this.tempFreehandCounter;o++)e.pointColl[o]=t[o];e.freehandCounter=this.tempFreehandCounter,e.notify("freehand-draw",{prop:"setCurrentFreehandDrawIndex",value:{value:this.tempCurrFhdIndex}}),e.activeObj.strokeSettings=this.tempStrokeSettings,e.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:e.activeObj.strokeSettings,strokeColor:null,fillColor:null,strokeWidth:null,radius:null}}),e.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:this.tempStrokeWidth}}),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}}),e.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!1}}),e.objColl=T.extend([],this.tempObjColl,[],!0),e.pointColl=T.extend([],this.tempPointColl,[],!0),e.freehandCounter=e.pointColl.length,this.tempPointColl={},this.renderImage(),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok",isCancel:!0}})},t.prototype.cancelText=function(){var e,t,o=this.parent;o.notify("shape",{prop:"setTextSettings",onPropertyChange:!1,value:{textSettings:this.tempTextSettings,fontFamily:null,fontSize:null}}),o.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:this.tempStrokeSettings,strokeColor:null,fillColor:null,strokeWidth:null,radius:null}}),!T.isNullOrUndefined(o.activeObj.currIndex)&&(o.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:t={appliedUndoRedoColl:[]}}}),e=t.appliedUndoRedoColl.length,t=t.appliedUndoRedoColl[e-1],this.prevActObj)&&t&&t.currentObjColl.length&&t.currentObjColl[t.currentObjColl.length-1].currIndex===this.prevActObj.currIndex?(o.activeObj=this.prevActObj,this.prevActObj=null):(o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height)),o.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),this.tempTextSettings={text:"Enter Text",fontFamily:o.fontFamily.default,fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},o.objColl=T.extend([],this.tempObjColl,[],!0),o.pointColl=T.extend([],this.tempPointColl,[],!0),this.renderImage(),this.tempObjColl=[],o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok",isCancel:!0}})},t.prototype.cancelShape=function(){var e=this.parent;if(e.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:this.tempStrokeSettings,strokeColor:null,fillColor:null,strokeWidth:null,radius:null}}),T.isNullOrUndefined(e.activeObj.currIndex))e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height);else{if(this.isNewPath)e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height);else{for(var t={appliedUndoRedoColl:[]},o=(e.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:t}}),void 0),i=0,r=t.appliedUndoRedoColl.length;i<r;i++)for(var n=t.appliedUndoRedoColl[i].currentObjColl,a=0,s=n.length;a<s;a++)if(this.prevActObj&&this.prevActObj.currIndex&&n[a].currIndex===this.prevActObj.currIndex){o=n[0];break}this.prevActObj&&o?(e.activeObj=this.prevActObj,this.prevActObj=null,e.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:e.activeObj}}),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}}),e.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}})):(e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height));var l={undoRedoStep:null};e.notify("undo-redo",{prop:"getUndoRedoStep",value:{obj:l}}),t.appliedUndoRedoColl[l.undoRedoStep-1]?e.objColl=T.extend([],t.appliedUndoRedoColl[l.undoRedoStep-1].currentObjColl,[],!0):e.objColl=[]}this.renderImage()}e.currObjType.isDragging=!1,e.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),e.objColl=T.extend([],this.tempObjColl,[],!0),e.pointColl=T.extend([],this.tempPointColl,[],!0),this.renderImage(),this.tempObjColl=[],e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok",isCancel:!0}})},t.prototype.cancelSelection=function(){var e,t=this.parent;t.cancelCropSelection&&(e={value:t.tempStraighten},t.transform.straighten=e.value,t.straightenBaseImageCanvas(),t.notify("freehand-draw",{prop:"resetStraightenPoint"}),t.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),t.notify("draw",{prop:"setStraightenActObj",value:{activeObj:t.activeObj}}),t.notify("crop",{prop:"resizeWrapper"}),this.updateCropSelObj(),this.tempStraightenDestPoints)&&JSON.stringify(this.tempStraightenDestPoints)!==JSON.stringify(this.straightenDestPoints)&&(this.straightenDestPoints=T.extend({},this.tempStraightenDestPoints,{},!0))},t.prototype.updateCropSelObj=function(){var e=this.parent;e.cancelCropSelection&&(e.cropObj=T.extend({},e.cancelCropSelection.previousCropObj,{},!0),e.afterCropActions=e.cancelCropSelection.previousObj.afterCropActions,e.notify("undo-redo",{prop:"undoDefault",onPropertyChange:!1,value:{obj:e.cancelCropSelection}}),e.currSelectionPoint=T.extend({},e.cancelCropSelection.previousCropObj.activeObj,!0),e.currSelectionPoint&&T.isNullOrUndefined(e.currSelectionPoint.shape)&&(e.currSelectionPoint=null),this.clearOuterCanvas(this.lowerContext),e.isCircleCrop||e.currSelectionPoint&&"crop-circle"===e.currSelectionPoint.shape)&&e.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})},t.prototype.updateCropSelection=function(){var e=this.parent,t={currObj:{}},t=(e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:t}}),t.currObj),o=(t.objColl=T.extend([],e.objColl,[],!0),t.pointColl=T.extend([],e.pointColl,[],!0),t.afterCropActions=T.extend([],e.afterCropActions,[],!0),{selPointColl:null});e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:o}}),t.selPointColl=T.extend([],o.selPointColl,[],!0),e.cancelCropSelection={operation:"cropTransform",previousObj:t,currentObj:t,previousObjColl:t.objColl,currentObjColl:t.objColl,previousPointColl:t.pointColl,currentPointColl:t.pointColl,previousSelPointColl:t.selPointColl,currentSelPointColl:t.selPointColl,previousCropObj:T.extend({},e.cropObj,{},!0),currentCropObj:T.extend({},e.cropObj,{},!0),previousText:null,currentText:null,filter:null,isCircleCrop:e.isCircleCrop}},t.prototype.updateFlipPan=function(e){var t,o=this.parent;""!==o.transform.currFlipState&&(t=this.lowerContext.filter,o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),o.notify("transform",{prop:"rotatedFlip",onPropertyChange:!1}),this.lowerContext.filter="none",o.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=t,this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),e)&&this.drawObject("duplicate",e)},t.prototype.select=function(e,t,o,i,r){var n,a,s=this.parent;e=e.toLowerCase(),!s.disabled&&s.isImageLoaded&&(s.allowDownScale=!1,s.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(a={currObj:{}}),value:{object:a}}),(a=a.currObj).objColl=T.extend([],s.objColl,[],!0),a.pointColl=T.extend([],s.pointColl,[],!0),a.afterCropActions=s.afterCropActions,s.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(n={selPointColl:null}),value:{obj:n}}),a.selPointColl=T.extend([],n.selPointColl,[],!0),s.notify("crop",{prop:"setPreviousCropCurrentObj",onPropertyChange:!1,value:{obj:a}}),0<s.transform.zoomFactor&&s.activeObj.shape&&"crop"===s.activeObj.shape.split("-")[0]&&T.isNullOrUndefined(this.currSelPoint)&&(this.currSelPoint=T.extend({},s.activeObj,{},!0)),n=!1,((a=void 0)===(a=void 0!==s.activeObj.shape?s.activeObj.shape.split("-"):a)&&s.currObjType.isCustomCrop||void 0!==a&&"crop"===a[0])&&(n=!0),s.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(a={currObj:{}}),value:{object:a}}),(a=a.currObj).objColl=T.extend([],s.objColl,[],!0),a.pointColl=T.extend([],s.pointColl,[],!0),a.afterCropActions=T.extend([],s.afterCropActions,[],!0),s.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),s.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),s.notify("shape",{prop:"setKeyHistory",onPropertyChange:!1,value:{keyHistory:""}}),this.upperContext.clearRect(0,0,s.upperCanvas.width,s.upperCanvas.height),s.upperCanvas.style.display="block",s.currSelectionPoint||0!==s.transform.defaultZoomFactor||0!==s.transform.degree&&0!==s.panPoint.totalPannedInternalPoint.x&&0!==s.panPoint.totalPannedInternalPoint.y&&!n?(s.isCircleCrop=!1,0===s.transform.defaultZoomFactor||this.isResizeSelect||(a=s.isCropTab,s.isCropTab=!1,s.notify("transform",{prop:"resetZoom",onPropertyChange:!1}),s.isCropTab=a,this.resetPanPoints()),s.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),s.isCropTab=!0,s.isCircleCrop=!1,this.isResizeSelect||s.notify("crop",{prop:"setCurrSelPoints",onPropertyChange:!1,value:{isSetDimension:!0}}),s.transform.zoomFactor=s.transform.cropZoomFactor,T.isNullOrUndefined(s.cropObj.activeObj.shape)&&(s.currObjType.shape="crop-"+e,this.drawNewSelection(e,t,o,i,r))):(this.isCropSelect?this.isCropSelect=!1:(s.notify("crop",{prop:"adjustStraightenForShapes",onPropertyChange:!1,value:{type:"reverse",isInitialRotated:!0}}),s.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),this.renderImage()),"custom"===e&&(s.currObjType.shape=""),this.drawNewSelection(e,t,o,i,r)))},t.prototype.drawNewSelection=function(e,t,o,i,r){var n,a=this.parent,e="crop-"+e.toLowerCase();"crop-custom"==e?""!==a.currObjType.shape&&"crop-custom"!==a.currObjType.shape||(this.drawCustomSelection("crop-custom",t,o,i,r),this.adjToStraighten(),this.updateSelectionInsert(),a.isStraightening&&(this.straightenActObj=T.extend({},a.activeObj,{},!0),this.straightenInitZoom=a.transform.zoomFactor)):"crop-canvas"==e?(a.upperCanvas.style.display="block",a.notify("selection",{prop:"setDragCanvas",value:{bool:!0}})):(a.currObjType.isCustomCrop=!1,a.currObjType.shape=e,i&&r?n={startX:t,startY:o,endX:t+i,endY:o+r,width:i,height:r}:i&&"crop-circle"==e&&(n={startX:t,startY:o,endX:t+i,endY:o+i,width:i,height:i}),a.activeObj.shape=e,this.updateSelectionInsert(n))},t.prototype.updateSelectionInsert=function(e){var t=this.parent,o=t.activeObj.activePoint,i={shapeSettingsObj:{}},i=(t.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:i}}),{type:t.getSelectionType(i.shapeSettingsObj.type),startX:i.shapeSettingsObj.startX,startY:i.shapeSettingsObj.startY,width:i.shapeSettingsObj.width,height:i.shapeSettingsObj.height}),i={action:"insert",previousSelectionSettings:i,currentSelectionSettings:i};t.trigger("selectionChanging",i),t.editCompleteArgs=i,t.notify("shape",{prop:"updSelChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:i.currentSelectionSettings}}),"Custom"===i.currentSelectionSettings.type?this.drawObject("duplicate",t.activeObj,null,null,!0):(0===o.startX&&0===o.startY&&0===o.width&&0===o.height||(e={startX:o.startX,startY:o.startY,endX:o.endX,endY:o.endY,width:o.width,height:o.height}),this.drawObject("duplicate",null,!0,e))},t.prototype.drawCustomSelection=function(e,t,o,i,r){var n,a,s,l,p,h,d,c,u,g,v,f=this.parent,C=f.activeObj.activePoint;f.currObjType.isCustomCrop=!0,this.upperContext.clearRect(0,0,f.upperCanvas.width,f.upperCanvas.height),f.currObjType.shape=f.activeObj.shape=e.toLowerCase(),T.isNullOrUndefined(t)||T.isNullOrUndefined(o)||T.isNullOrUndefined(i)||T.isNullOrUndefined(r)?i&&r?(p=(e=f.img).destLeft,h=e.destTop,d=e.destWidth,c=e.destHeight,C.width=i,C.height=r,C.startX=p+(d/2-i/2),C.startY=h+(c/2-r/2)):(T.isNullOrUndefined(f.transform.zoomFactor)||0===f.transform.zoomFactor?(g=(e=f.img).destLeft,n=e.destTop,u=e.destWidth,e=e.destHeight,a=f.lowerCanvas.width,s=f.lowerCanvas.height,l=C,0<=g&&0<=n?(l.startX=g,l.startY=n,l.endX=g+u,l.endY=n+e):0<=g?(l.startX=g,l.startY=7.5,l.endX=g+u,l.endY=s-15):0<=n?(l.startX=7.5,l.startY=n,l.endX=a-15,l.endY=n+e):(l.startX=7.5,l.startY=7.5,l.endX=a-15,l.endY=s-15)):(u=(g=f.img).destLeft,n=g.destTop,e=g.destWidth,a=g.destHeight,l=f.lowerCanvas.width,s=f.lowerCanvas.height,(g=C).startX=Math.max(0<u?u:7.5,u),g.startY=Math.max(0<n?n:7.5,n),g.endX=Math.min(u+e+15<l?u+e-15:l-15,u+e),g.endY=Math.min(n+a+15<s?n+a-15:s-15,n+a)),p=(l=f.img).destLeft,h=l.destTop,d=l.destWidth,c=l.destHeight,u=f.lowerCanvas.clientWidth,e=f.lowerCanvas.clientHeight,(g=C).startX=Math.max(g.startX,p),g.startY=Math.max(g.startY,h),g.endX=Math.min(g.endX,p+d),g.endY=Math.min(g.endY,h+c),0<f.transform.straighten?(this.imgCanvasPoints[0].x>g.startX&&(g.startX=this.imgCanvasPoints[0].x),this.imgCanvasPoints[0].y>g.startY&&(g.startY=this.imgCanvasPoints[0].y),this.imgCanvasPoints[2].x<g.endX&&(g.endX=this.imgCanvasPoints[2].x),this.imgCanvasPoints[2].y<g.endY&&(g.endY=this.imgCanvasPoints[2].x)):f.transform.straighten<0&&(this.imgCanvasPoints[3].x>g.startX&&(g.startX=this.imgCanvasPoints[3].x),this.imgCanvasPoints[3].y<g.startY&&(g.startY=this.imgCanvasPoints[3].y),this.imgCanvasPoints[1].x<g.endX&&(g.endX=this.imgCanvasPoints[1].x),this.imgCanvasPoints[1].y>g.endY)&&(g.endY=this.imgCanvasPoints[1].x),g.startX===p&&u<p+d&&(g.endX=u-15),g.startY===h&&e<h+c&&(g.endY=e-15),f.activeObj.activePoint.startX>f.activeObj.activePoint.endX&&(v=f.activeObj.activePoint.startX,f.activeObj.activePoint.startX=f.activeObj.activePoint.endX,f.activeObj.activePoint.endX=v),f.activeObj.activePoint.startY>f.activeObj.activePoint.endY&&(v=f.activeObj.activePoint.startY,f.activeObj.activePoint.startY=f.activeObj.activePoint.endY,f.activeObj.activePoint.endY=v),f.activeObj=this.updateWidthHeight(f.activeObj),this.updateActiveObject(C,f.activeObj),this.adjActObj()):(C.startX=t,C.startY=o,C.endX=t+i,C.endY=o+r,C.width=i,C.height=r),this.updateSelectionInsert()},t.prototype.adjToStraighten=function(){var e,t=this.parent;0!==t.transform.straighten&&t.isStraightening&&((e=t.activeObj.activePoint).startX+=7.5,e.startY+=7.5,e.endX-=7.5,e.endY-=7.5,t.activeObj=this.updateWidthHeight(t.activeObj))},t.prototype.adjActObj=function(){var e=this.parent;if(0!==e.transform.straighten)for(var t=e.activeObj.activePoint,o=T.extend({},t,{},!0),i=0;;){i++;var r={isIntersect:null,arr:null};if(e.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),e.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:r}}),r.arr[0]||r.arr[1]||r.arr[2]||r.arr[3]||100===i){t=T.extend({},o,{},!0);break}o=T.extend({},t,{},!0),t.startX-=5,t.endX+=5,t.width=t.endX-t.startX,this.updateActiveObject(t,e.activeObj)}},t.prototype.callUpdateCurrTransState=function(){var e=this.parent,t=T.extend([],e.objColl,[],!0),o=T.extend({},e.activeObj,{},!0),i=(e.objColl=[],e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.isRotateZoom=!0,this.updateCurrTransState("initial"),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),0===e.transform.degree&&0<e.rotateFlipColl.length&&(e.img.destLeft+=e.panPoint.totalPannedPoint.x,e.img.destTop+=e.panPoint.totalPannedPoint.y),e.img.destLeft+=e.panPoint.totalPannedInternalPoint.x,e.img.destTop+=e.panPoint.totalPannedInternalPoint.y,this.lowerContext.filter),t=(0===e.transform.degree&&e.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),this.drawImage(),this.updateCurrTransState("reverse"),0===e.transform.degree&&0<e.rotateFlipColl.length&&(e.img.destLeft+=e.panPoint.totalPannedPoint.x,e.img.destTop+=e.panPoint.totalPannedPoint.y),this.isRotateZoom=!1,e.objColl=t,e.togglePen),r=(e.togglePen=!1,this.lowerContext.filter="none",{penStrokeWidth:null});e.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:r}}),e.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),e.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:r.penStrokeWidth}}),e.img.destLeft+=e.panPoint.totalPannedInternalPoint.x,e.img.destTop+=e.panPoint.totalPannedInternalPoint.y,e.img.destLeft-=e.panPoint.totalPannedInternalPoint.x,e.img.destTop-=e.panPoint.totalPannedInternalPoint.y,e.togglePen=t,this.lowerContext.filter=i,e.activeObj=o},t.prototype.resetPanPoints=function(){this.parent.panPoint.totalPannedPoint={x:0,y:0},this.parent.panPoint.totalPannedClientPoint={x:0,y:0},this.parent.panPoint.totalPannedInternalPoint={x:0,y:0}},t.prototype.setClientTransDim=function(e){var t,o=this.parent;o.transform.degree%90==0&&o.transform.degree%180!=0?(o.img.destLeft=(o.lowerCanvas.clientWidth-o.img.destHeight)/2,o.img.destTop=(o.lowerCanvas.clientHeight-o.img.destWidth+1)/2,t=o.img.destWidth,o.img.destWidth=o.img.destHeight,o.img.destHeight=t):T.isNullOrUndefined(e)&&(o.img.destLeft=(o.lowerCanvas.clientWidth-o.img.destWidth)/2,o.img.destTop=(o.lowerCanvas.clientHeight-o.img.destHeight+1)/2)},t.prototype.redrawImgWithObj=function(){var e,t=this.parent,o={canvasFilter:t.canvasFilter};this.lowerContext.filter=o.canvasFilter,0!==t.rotateFlipColl.length?(o=T.extend({},t.panPoint.totalPannedInternalPoint,{},!0),e={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight},this.callUpdateCurrTransState(),t.panPoint.totalPannedInternalPoint=o,t.img.destLeft=e.startX,t.img.destTop=e.startY,t.img.destWidth=e.width,t.img.destHeight=e.height):this.callUpdateCurrTransState(),t.isCircleCrop&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})},t.prototype.setCurrentObj=function(e,t,o){var i,r,n=this.parent,a=!!e,s=(a||(n.cropObj.aspectWidth=n.aspectWidth,n.cropObj.aspectHeight=n.aspectHeight,n.cropObj.frame=n.frameObj.type),e=e||n.cropObj,n.transform.cropZoomFactor=e.cropZoom,n.transform.defaultZoomFactor=e.defaultZoom,this.straightenInitZoom=e.straightenZoom,!a||e.activeObj.shape&&"crop"===e.activeObj.shape.split("-")[0]?n.transform.zoomFactor=e.cropZoom:n.transform.zoomFactor=e.defaultZoom,n.setProperties({zoomSettings:{zoomFactor:e.zoomFactor}},!0),n.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:e.previousZoomValue}}),n.panPoint.totalPannedPoint=T.extend({},e.totalPannedPoint,{},!0),n.panPoint.totalPannedClientPoint=T.extend({},e.totalPannedClientPoint,{},!0),n.panPoint.totalPannedInternalPoint=T.extend({},e.totalPannedInternalPoint,{},!0),T.extend({},e.tempFlipPanPoint,{},!0)),s=(n.notify("crop",{prop:"setTempFlipPanPoint",onPropertyChange:!1,value:{point:s}}),n.rotateFlipColl=T.extend([],e.rotateFlipColl,[],!0),n.transform.degree=e.degree,n.frameObj.type=e.frame,n.transform.currFlipState=e.currFlipState,n.notify("filter",{prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:e.adjustmentLevel}}),n.notify("filter",{prop:"setTempAdjVal"}),n.currentFilter=e.currentFilter,n.notify("filter",{prop:"setTempFilVal"}),n.transform.straighten===e.straighten&&!t||(n.transform.straighten=e.straighten,n.straightenBaseImageCanvas()),n.img={destLeft:e.destPoints.startX,destTop:e.destPoints.startY,destWidth:e.destPoints.width,destHeight:e.destPoints.height,srcLeft:e.srcPoints.startX,srcTop:e.srcPoints.startY,srcWidth:e.srcPoints.width,srcHeight:e.srcPoints.height},n.aspectWidth=e.aspectWidth,n.aspectHeight=e.aspectHeight,e.afterCropActions&&(n.afterCropActions=e.afterCropActions),this.lowerContext.filter=e.filter,n.notify("filter",{prop:"setBrightnessAdjusted",onPropertyChange:!1,value:{isBrightnessAdjusted:e.isBrightAdjust}}),n.notify("draw",{prop:"imageBackgroundColor",onPropertyChange:!1,value:{color:e.bgColor}}),n.isCircleCrop),t=(T.isNullOrUndefined(n.currSelectionPoint)?i=null:(i=T.extend({},n.currSelectionPoint,{},!0),n.currSelectionPoint=null),n.isCircleCrop=!1,o&&(n.frameObj.type="none"),this.drawCropSelectionImage(e,!1),0!==n.transform.degree&&(""===n.transform.currFlipState?n.notify("transform",{prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}):n.notify("transform",{prop:"drawPannedImage",value:{xDiff:0,yDiff:0}}),n.img.destLeft=e.destPoints.startX,n.img.destTop=e.destPoints.startY,n.panPoint.totalPannedClientPoint=T.extend({},e.totalPannedClientPoint,{},!0),n.panPoint.totalPannedInternalPoint=T.extend({},e.totalPannedInternalPoint,{},!0)),n.activeObj=T.extend({},e.activeObj,{},!0),this.upperContext.clearRect(0,0,n.upperCanvas.width,n.upperCanvas.height),0!==n.activeObj.activePoint.width&&0!==n.activeObj.activePoint.height&&this.drawObject("duplicate",null,null,null,!0),T.extend({},e.activeObj,{},!0)),o=!1,l=(0<n.afterCropActions.length&&(r={collection:n.afterCropActions},n.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:n.afterCropActions,isRotateFlipCollection:null,obj:r}}),n.afterCropActions=r.collection),T.extend([],n.afterCropActions,[],!0));if(!a&&0<l.length){for(var o=!0,p=0,h=l.length;p<h;p++)"horizontalflip"!==l[p]&&"verticalflip"!==l[p]||(n.activeObj=T.extend({},i,{},!0),this.rotatedFlipCropSel=!0),n.notify("transform",{prop:"updateTransform",onPropertyChange:!1,value:{text:l[p]}});t=T.extend({},n.activeObj,{},!0),this.resetPanPoints(),n.activeObj=t,this.upperContext.clearRect(0,0,n.upperCanvas.width,n.upperCanvas.height),0!==n.activeObj.activePoint.width&&0!==n.activeObj.activePoint.height&&this.drawObject("duplicate",null,null,null,!0),e.degree!==n.transform.degree&&(n.transform.cropZoomFactor=null,n.transform.zoomFactor=0),n.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),this.rotatedFlipCropSel&&(this.rotatedFlipCropSel=!1)}n.afterCropActions=l,this.isCancelAction||o||(n.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),n.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),n.img.destLeft=e.destPoints.startX,n.img.destTop=e.destPoints.startY),n.activeObj=t,n.isCircleCrop=s,(T.isNullOrUndefined(i)||(n.currSelectionPoint=T.extend({},i,{},!0),n.currSelectionPoint&&T.isNullOrUndefined(n.currSelectionPoint.shape)))&&(n.currSelectionPoint=null)},t.prototype.drawCropSelectionImage=function(e,t){var o,i=this.parent,r=this.lowerContext.filter,t=(i.clearContext(this.lowerContext),i.clearContext(this.upperContext),this.lowerContext.setTransform(1,0,0,1,0,0),t?this.updateCurrTransState("initial"):this.setTransformColl(this.lowerContext,"initial"),i.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),this.drawImage(),t?this.updateCurrTransState("reverse"):this.setTransformColl(this.lowerContext,"reverse"),i.img.destLeft=i.cropObj.destPoints.startX,i.img.destTop=i.cropObj.destPoints.startY,T.extend({},e.activeObj,{},!0));this.lowerContext.filter="none",i.img={destLeft:e.destPoints.startX,destTop:e.destPoints.startY,destWidth:e.destPoints.width,destHeight:e.destPoints.height,srcLeft:e.srcPoints.startX,srcTop:e.srcPoints.startY,srcWidth:e.srcPoints.width,srcHeight:e.srcPoints.height},0!==e.activeObj.activePoint.width&&0!==e.activeObj.activePoint.height&&(o={startX:i.img.destLeft,startY:i.img.destTop,width:i.img.destWidth,height:i.img.destHeight},i.img.destLeft=e.activeObj.activePoint.startX,i.img.destTop=e.activeObj.activePoint.startY,i.img.destWidth=e.activeObj.activePoint.width,i.img.destHeight=e.activeObj.activePoint.height,i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),i.img.destLeft=o.startX,i.img.destTop=o.startY,i.img.destWidth=o.width,i.img.destHeight=o.height),i.activeObj=t,this.lowerContext.filter=r},t.prototype.performPointZoom=function(e,t,o,i,r){var n=this.parent,a=n.img,s=a.destLeft,l=a.destTop,p=a.destWidth,a=a.destHeight,h=!1,h=(n.activeObj.shape&&-1<n.activeObj.shape.indexOf("crop-")&&(h=!0),!n.element.querySelector(".e-contextual-toolbar-wrapper")||h||n.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")||(n.okBtn(),n.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide")),(e-s)/p),s=(t-l)/a,p=n.isUndoRedo,l=(n.isUndoRedo=!0,n.setProperties({zoomSettings:{zoomPoint:{x:e,y:t}}},!0),r||("zoomIn"===o?.1:-.1));n.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:l,zoomPoint:null,isResize:i}}),n.isUndoRedo=p,this.panToPoint(e,t,h,s)},t.prototype.panToPoint=function(e,t,o,i){var r=this.parent;if(0<r.transform.zoomFactor){for(var n,a,s,l,p,h=r.img.destLeft,d=r.img.destTop,c=T.extend({},r.activeObj,{},!0),u=(0===r.transform.degree?(r.img.destLeft=e-o*r.img.destWidth,r.img.destTop=t-i*r.img.destHeight,this.drawZoomPanImage(r.img.destLeft-h,r.img.destTop-d)):(n=r.isCropTab,r.isCropTab=!0,a=T.extend([],r.objColl,[],!0),s=T.extend([],r.pointColl,[],!0),r.notify("freehand-draw",{prop:"getStraightenPoint",onPropertyChange:!(l={straightenPoint:null}),value:{obj:l}}),r.objColl=[],r.pointColl=[],r.freehandCounter=0,r.notify("freehand-draw",{prop:"setStraightenPoint",onPropertyChange:!1,value:{x:null,y:null,ratioX:null,ratioY:null}}),r.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(p={selPointColl:null}),value:{obj:p}}),p=p.selPointColl,r.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),r.panPoint.currentPannedPoint={x:e-o*r.img.destWidth-h,y:t-i*r.img.destHeight-d},r.notify("transform",{prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}),r.isCropTab=n,r.objColl=a,r.pointColl=s,r.freehandCounter=r.pointColl.length,l.straightenPoint.x&&l.straightenPoint.y&&r.notify("freehand-draw",{prop:"setStraightenPoint",onPropertyChange:!1,value:{x:l.straightenPoint.x,y:l.straightenPoint.y,ratioX:l.straightenPoint.ratioX,ratioY:l.straightenPoint.ratioY}}),r.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:p}}}),r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:r.panPoint.currentPannedPoint.x,y:r.panPoint.currentPannedPoint.y,panRegion:""}})),this.adjustPanning(c),!1),g=0;g<r.objColl.length;g++)if(JSON.stringify(c.activePoint)===JSON.stringify(r.objColl[g].activePoint)){u=!0;break}u||(r.activeObj=c),0!==r.activeObj.activePoint.width&&0!==r.activeObj.activePoint.height&&this.drawObject("duplicate",null,null,null,!0)}},t.prototype.adjustPanning=function(e){var t,o,i,r,n,a=this.parent,e=e.activePoint,s=e.startX,l=e.startY,p=e.width,e=e.height;0!==p&&0!==e&&(t=(n=a.img).destLeft,o=n.destTop,r=n.destWidth,n=n.destHeight,i={x:0,y:0},s<t?i.x=t-s:t+r<s+p&&(i.x=t+r-(s+p)),l<o?i.y=o-l:o+n<l+e&&(i.y=o+n-(l+e)),0===a.transform.degree?(a.img.destLeft-=i.x,a.img.destTop-=i.y,this.drawZoomPanImage(a.img.destLeft-t,a.img.destTop-o)):(r=a.isCropTab,a.isCropTab=!0,s=T.extend([],a.objColl,[],!0),p=T.extend([],a.pointColl,[],!0),a.objColl=[],a.pointColl=[],a.freehandCounter=0,a.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(n={selPointColl:null}),value:{obj:n}}),l=n.selPointColl,a.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),a.img.destLeft-=i.x,a.img.destTop-=i.y,a.panPoint.currentPannedPoint={x:a.img.destLeft-t,y:a.img.destTop-o},a.notify("transform",{prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}),a.isCropTab=r,a.objColl=s,a.pointColl=p,a.freehandCounter=a.pointColl.length,a.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:l}}}),a.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:a.panPoint.currentPannedPoint.x,y:a.panPoint.currentPannedPoint.y,panRegion:""}})))},t.prototype.panToSel=function(){var e=this.parent,t=T.extend({},e.activeObj,{},!0),o=t.activePoint,i=o.startX,r=o.startY,n=o.width,o=o.height,a=(this.allowRedactStraighten=!0,{straightenPoint:null});if(e.notify("freehand-draw",{prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:a}}),a.straightenPoint.x&&a.straightenPoint.y){var i=i+n/2-a.straightenPoint.x,n=r+o/2-a.straightenPoint.y,r=(0===e.transform.degree?(e.img.destLeft+=i,e.img.destTop+=n,e.notify("transform",{prop:"drawPannImage",value:{point:{x:i,y:n}}})):(e.panPoint.currentPannedPoint={x:i,y:n},e.notify("transform",{prop:"drawPannedImage",value:{xDiff:i,yDiff:n}}),e.panPoint.currentPannedPoint={x:0,y:0},e.notify("transform",{prop:"setTempPanMove",value:{point:null}})),e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t}}),e.img),s=r.destLeft,l=r.destTop,p=r.destWidth,h=r.destHeight,o=this.imgCanvasPoints,d=(o.forEach(function(e){e.x=e.ratioX*p+s,e.y=e.ratioY*h+l}),this.imgCanvasPoints=o,0);for(3!==e.transform.straighten||this.preventStraightening||(this.preventStraightening=!0,a=e.prevStraightenedDegree,e.prevStraightenedDegree=e.transform.straighten,e.setStraighten(0),e.setStraighten(3),e.prevStraightenedDegree=a,this.preventStraightening=!1);this.isLinesIntersect()&&0!==e.transform.straighten&&360!==e.transform.straighten&&d<100;)d++,this.performPointZoom(e.activeObj.activePoint.startX+e.activeObj.activePoint.width/2,e.activeObj.activePoint.startY+e.activeObj.activePoint.height/2,"zoomIn",!1,.025),this.updateImgCanvasPoints()}},t.prototype.drawZoomPanImage=function(e,t){var o=this.parent,i=(o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:e,y:t,panRegion:""}}),this.renderImage(!0),{width:0,height:0});o.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:o.img.srcWidth,height:o.img.srcHeight,obj:i,isImgShape:null}});i.width+=i.width*o.transform.zoomFactor,i.height+=i.height*o.transform.zoomFactor,o.panPoint.totalPannedPoint.x+=e,o.panPoint.totalPannedPoint.y+=t,o.notify("crop",{prop:"setTempFlipPanPoint",onPropertyChange:!1,value:{point:{x:0,y:0}}})},t.prototype.openNewImage=function(){var t=this,e=this.parent,o=e.element.id,i=e.inMemoryCanvas.getContext("2d"),r=(f.showSpinner(e.element),e.element.style.opacity="0.5",document.querySelector("#"+o+"_currPos")),r=(r&&(r.style.display="none"),{defToolbarItems:null});e.notify("toolbar",{prop:"getDefToolbarItems",value:{obj:r}}),r.defToolbarItems&&0===r.defToolbarItems.length&&T.isNullOrUndefined(document.getElementById(o+"_toolbar"))&&e.element.querySelector("#"+o+"_toolbarArea")&&(r=e.element.querySelector("#"+o+"_toolbarArea").clientHeight,e.notify("toolbar",{prop:"setToolbarHeight",value:{height:r}})),e.reset(),e.update(),e.transform.degree=0,e.transform.zoomFactor=0,e.isImageLoaded=!1,e.currSelectionPoint=null,"string"==typeof this.openURL?(1<(r=this.openURL.split(".")).length?(r=r[r.length-2].split("/"),this.fileName=r[r.length-1]):this.fileName="ImageEditor",this.fileType=this.getFileExtensionFromURL(this.openURL),this.fileType&&(this.fileType=e.toPascalCase(this.fileType),"jpg"!==(r=this.fileType.toLowerCase())&&"jpeg"!==r||(this.fileType="Jpeg",r="jpeg"),"jpeg"!==r)&&"png"!==r&&"svg"!==r&&"webp"!==r&&(this.fileType=null),this.imageOnLoad(this.openURL),"string"==typeof this.openURL&&-1!==this.openURL.indexOf("localhost")||this.getImageSizeFromURL(this.openURL.toString(),function(e){null!==e&&t.parent.notify("toolbar",{prop:"setInitialSize",value:{value:+e}})})):(this.fileName="ImageEditor",this.fileType=null,e.lowerCanvas=document.querySelector("#"+o+"_lowerCanvas"),e.upperCanvas=document.querySelector("#"+o+"_upperCanvas"),this.lowerContext=e.lowerCanvas.getContext("2d"),this.upperContext=e.upperCanvas.getContext("2d"),e.clearContext(this.lowerContext),e.clearContext(this.upperContext),e.clearContext(i),e.inMemoryCanvas.width=this.openURL.width,e.inMemoryCanvas.height=this.openURL.height,i.putImageData(this.openURL,0,0),e.baseImg.src=e.inMemoryCanvas.toDataURL())},t.prototype.getImageSizeFromURL=function(o,i){return Y(this,void 0,void 0,function(){var t;return E(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,fetch(o,{method:"HEAD"})];case 1:return t=e.sent(),t=parseInt(t.headers.get("content-length")||"0",10),i(t),[3,3];case 2:return t=e.sent(),console.log(t.message),[3,3];case 3:return[2]}})})},t.prototype.dlgBtnClick=function(){this.parent.export(),this.applyDialogOption()},t.prototype.dlgCloseBtnClick=function(){this.applyDialogOption()},t.prototype.applyDialogOption=function(){var e=this.parent;this.isFileChanged?(e.isImageLoaded=this.isFileChanged=!1,e.reset(),this.checkToolbarTemplate(this.inputElem,this.openURL)):(this.reset(),this.openNewImage()),T.getComponent(document.getElementById(e.element.id+"_dialog"),"dialog").destroy(),this.isImageEdited=!1},t.prototype.showDialogPopup=function(){var e=this.parent,t={key:"ConfirmDialogHeader"},o=(e.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:t}}),{key:"ConfirmDialogContent"}),i=(e.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:o}}),{key:"Yes"}),r=(e.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:i}}),{key:"No"});e.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:r}}),e.element.querySelector("#"+e.element.id+"_dialog").style.display="block",new f.Dialog({header:t.value,closeOnEscape:!0,content:"<span>"+o.value+"</span>",target:document.getElementById("target"),width:"285px",isModal:!0,animationSettings:{effect:"Zoom"},close:this.dlgCloseBtnClick.bind(this),buttons:[{click:this.dlgCloseBtnClick.bind(this),buttonModel:{content:r.value,iconCss:"e-icons e-close"}},{click:this.dlgBtnClick.bind(this),buttonModel:{content:i.value,isPrimary:!0,iconCss:"e-icons e-check"}}]}).appendTo("#"+e.element.id+"_dialog")},t.prototype.restoreOldImage=function(){var e,t,o=this,i=this.parent,r=document.getElementById(this.parent.element.id+"_dropArea"),n=i.getExtensionArray();"string"!=typeof this.openURL?this.openImageData(r):(e=this.getFileExtensionFromURL(this.openURL),t=!!(e=e&&("jpg"===(e=e.toLowerCase())||"jpeg"===e?"jpeg":e))&&(-1<n.indexOf(e)||"jpeg"===e&&(-1<i.uploadSettings.allowedExtensions.indexOf("jpg")||-1<i.uploadSettings.allowedExtensions.indexOf("jpeg")))||this.isNullExtension,-1<this.openURL.indexOf("data:image/")&&-1<this.openURL.indexOf("base64")||-1<this.openURL.indexOf("blob")?this.openImageData(r,!0):i.uploadSettings.minFileSize||i.uploadSettings.maxFileSize?this.getImageSizeFromURL(this.openURL.toString(),function(e){e=i.uploadSettings.minFileSize&&e<i.uploadSettings.minFileSize||i.uploadSettings.maxFileSize&&e>i.uploadSettings.maxFileSize;o.handleFileSize(!t||e,r,!t)}):this.handleFileSize(!t,r,!t))},t.prototype.handleFileSize=function(e,t,o){var i=this.parent;e?(this.errorLoading(),i.showDialogPopup("unsupported",o),t&&!i.isImageLoaded&&(t.style.display="block")):(t&&(t.style.display="none"),this.parent.isImageLoaded&&this.reset(),this.openNewImage())},t.prototype.openImageData=function(e,t){var o,i=this.parent,r=this,n=i.createElement("canvas"),a=n.getContext("2d");i.uploadSettings.minFileSize||i.uploadSettings.maxFileSize?t?((o=new Image).src=this.openURL,o.onload=function(){a.canvas.width=o.width,a.canvas.height=o.height,a.drawImage(o,0,0),r.getImageSize(n,e)}):(n.width=this.openURL.width,n.height=this.openURL.height,a.putImageData(this.openURL,0,0),this.getImageSize(n,e)):this.handleFileSize(!1,e,!1)},t.prototype.getImageSize=function(e,t){var o=this.parent;e.toBlob(function(e){o.uploadSettings.minFileSize&&e.size<o.uploadSettings.minFileSize||o.uploadSettings.maxFileSize&&e.size>o.uploadSettings.maxFileSize?this.handleFileSize(!0,t,!1):this.handleFileSize(!1,t,!1)}.bind(this),"image/jpeg",1)},t.prototype.open=function(e){this.parent.disabled||(this.openURL=e,this.restoreOldImage())},t.prototype.getInitialLoaded=function(e){e.isInitialLoaded=this.isInitialLoading},t.prototype.getFileExtensionFromURL=function(e){var t=e.lastIndexOf(".");return-1!==t?e.slice(t+1).toLowerCase():-1!==e.indexOf("base64")?e.slice(e.indexOf("/")+1,e.indexOf(";")).toLowerCase():null},t.prototype.fileSelect=function(e,t){var o,i,r,n=this.parent,a=document.getElementById(n.element.id+"_dropArea");a&&(a.style.display="none"),n.disabled||(o=a=void 0,t=void(t.target?o=a=t.target.files[0]:a=o=t.filesData[0].rawFile),o.name&&(t=(i=o.name.split("."))[i.length-1].toLowerCase()),i=n.getExtensionArray(),r=("jpg"===t||"jpeg"===t)&&(-1<n.uploadSettings.allowedExtensions.indexOf("jpg")||-1<n.uploadSettings.allowedExtensions.indexOf("jpeg")),t&&-1===i.indexOf(t)&&!r||n.uploadSettings.minFileSize&&o.size<n.uploadSettings.minFileSize||n.uploadSettings.maxFileSize&&o.size>n.uploadSettings.maxFileSize?this.errorLoading():(f.showSpinner(n.element),n.element.style.opacity="0.5",this.inputElem=e,(t=o.name&&o.name.split(".")[1])?(i=n.toPascalCase(t),this.fileType="JPG"===i||"Jpg"===i?"Jpeg":i):this.fileType=null,r=window.URL.createObjectURL(a),this.openURL=r,n.isImageLoaded&&!n.isChangesSaved&&(this.isImageEdited||0<n.pointColl.length||0<n.objColl.length)?(this.isFileChanged=!0,this.showDialogPopup()):this.checkToolbarTemplate(e,r)))},t.prototype.checkToolbarTemplate=function(e,t){var o=this.parent;T.isNullOrUndefined(o.toolbarTemplate)&&(o.reset(),o.update()),this.fileName=e.value.split("\\")[e.value.split("\\").length-1],this.fileName=this.fileName.split(".")[0],this.imageOnLoad(t.toString()),e.value=""},t.prototype.moveToSelectionRange=function(e,t){var o=this.parent;if(o.activeObj.shape){for(var i=!1,r=0,n=o.rotateFlipColl.length;r<n;r++){var a=o.rotateFlipColl[r];if(90===a||-90===a){i=!0;break}}if(i&&0!==o.transform.degree){var s=o.transform.zoomFactor,l=(o.objColl.push(o.activeObj),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),o.objColl[o.objColl.length-1]);if("rotateleft"===e||"rotateright"===e)if(o.transform.degree%90==0&&o.transform.degree%180!=0)if(l.activePoint.width<t.activePoint.height)for(r=2;r<o.zoomSettings.maxZoomFactor;r++){if(l.activePoint.width>=t.activePoint.height||this.isSelectionBiggerThanCanvas(l)||this.isSelectionOutsideCanvas(l)){T.isNullOrUndefined(s)||o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null},isResize:null});break}s+=.1,o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:s,zoomPoint:null},isResize:null})}else for(r=2;r<o.zoomSettings.maxZoomFactor;r++){if(l.activePoint.width>=t.activePoint.height||this.isSelectionBiggerThanCanvas(l)||this.isSelectionOutsideCanvas(l)){T.isNullOrUndefined(s)||o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null,isResize:null}});break}s-=.1,o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:s,zoomPoint:null},isResize:null})}else if(l.activePoint.height<t.activePoint.width)for(r=2;r<o.zoomSettings.maxZoomFactor;r++){if(l.activePoint.height>=t.activePoint.width||this.isSelectionBiggerThanCanvas(l)||this.isSelectionOutsideCanvas(l)){T.isNullOrUndefined(s)||o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null},isResize:null});break}s+=.1,o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:s,zoomPoint:null},isResize:null})}else for(r=2;r<o.zoomSettings.maxZoomFactor;r++){if(l.activePoint.height>=t.activePoint.width||this.isSelectionBiggerThanCanvas(l)||this.isSelectionOutsideCanvas(l)){T.isNullOrUndefined(s)||o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null},isResize:null});break}s-=.1,o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:s,zoomPoint:null},isResize:null})}var e=o.lowerCanvas.clientWidth/2-(l.activePoint.startX+l.activePoint.width/2),p=(o.lowerCanvas.clientHeight+1)/2-(l.activePoint.startY+l.activePoint.height/2);T.isNullOrUndefined(o.activeObj.shape)&&(o.activeObj=T.extend({},t,{},!0)),0===o.transform.degree?(o.img.destLeft+=e,o.img.destTop+=p,o.notify("transform",{prop:"drawPannImage",value:{point:{x:e,y:p}}})):(o.panPoint.currentPannedPoint={x:e,y:p},o.notify("transform",{prop:"drawPannedImage",value:{xDiff:e,yDiff:p}}),o.panPoint.currentPannedPoint={x:0,y:0}),o.notify("transform",{prop:"setTempPanMove",onPropertyChange:!1,value:{point:null}}),o.activeObj=T.extend({},o.objColl[o.objColl.length-1]),o.objColl.pop(),o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj}})}}},t.prototype.isSelectionBiggerThanCanvas=function(e){var t=!1,o=this.parent,e=e.activePoint,i=e.startX,r=e.startY,n=e.endX,e=e.endY,o=o.img,a=o.destLeft,s=o.destTop,l=o.destWidth,o=o.destHeight;return t=i<=a||r<=s||a+l<=n||s+o<=e?!0:t},t.prototype.isSelectionOutsideCanvas=function(e){var t=!1,o=this.parent;return t=e.activePoint.height<o.lowerCanvas.height-o.toolbarHeight||e.activePoint.width<o.lowerCanvas.width?!0:t},t.prototype.downScaleImgCanvas=function(e,t,o,i){var r=this.parent,n=t?r.activeObj.imageCanvas:r.baseImgCanvas,a=t?r.activeObj.imageElement:r.baseImg,s=t?r.activeObj.activePoint.width:r.img.destWidth,l=t?r.activeObj.activePoint.height:r.img.destHeight,p={width:0,height:0};r.transform.degree%90==0&&r.transform.degree%180!=0?r.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:a.height,height:a.width,obj:p,isImgShape:t}}):r.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:a.width,height:a.height,obj:p,isImgShape:t}}),t||r.allowDownScale&&!r.isCropTab&&!r.isCropToolbar&&0!==a.width&&0!==a.height&&s<.75*p.width&&l<.75*p.height?((p=r.createElement("canvas",{id:r.element.id+"_downScaleCanvas",attrs:{name:"canvasImage"}})).width=t?a.width:r.img.srcWidth,p.height=t?a.height:r.img.srcHeight,t?p.getContext("2d").drawImage(a,0,0,p.width,p.height):(""!==this.imageBackgroundColor&&(e.fillStyle=this.imageBackgroundColor,e.fillRect(r.img.destLeft,r.img.destTop,r.img.destWidth,r.img.destHeight)),p.getContext("2d").drawImage(n,r.img.srcLeft,r.img.srcTop,r.img.srcWidth,r.img.srcHeight,0,0,p.width,p.height)),(t||this.isDownScale)&&this.downScale(p,s,l,t),t?(e.canvas.width=p.width,e.canvas.height=p.height,o&&i?(e.translate(r.activeObj.imageCanvas.width,0),e.scale(-1,1),e.translate(0,r.activeObj.imageCanvas.height),e.scale(1,-1)):o?(T.isNullOrUndefined(r.activeObj.isHorImageFlip)||!r.activeObj.isHorImageFlip?(r.activeObj.isHorImageFlip=!0,e.translate(r.activeObj.imageCanvas.width,0),e.scale(-1,1)):r.activeObj.isHorImageFlip&&(r.activeObj.isHorImageFlip=!1),r.activeObj.isVerImageFlip&&(e.translate(0,r.activeObj.imageCanvas.height),e.scale(1,-1))):i&&(T.isNullOrUndefined(r.activeObj.isVerImageFlip)||!r.activeObj.isVerImageFlip?(r.activeObj.isVerImageFlip=!0,e.translate(0,r.activeObj.imageCanvas.height),e.scale(1,-1)):r.activeObj.isVerImageFlip&&(r.activeObj.isVerImageFlip=!1),r.activeObj.isHorImageFlip)&&(e.translate(r.activeObj.imageCanvas.width,0),e.scale(-1,1)),e.drawImage(p,0,0),e.setTransform(1,0,0,1,0,0)):r.isFinetuning?(e.save(),e.setTransform(1,0,0,1,0,0),e.drawImage(r.inMemoryCanvas,0,0),e.restore()):e.drawImage(p,0,0,p.width,p.height,r.img.destLeft,r.img.destTop,p.width,p.height)):!T.isNullOrUndefined(t)&&t||0===r.baseImgCanvas.width||0===r.baseImgCanvas.height||(""!==this.imageBackgroundColor&&(e.fillStyle=this.imageBackgroundColor,e.fillRect(r.img.destLeft,r.img.destTop,r.img.destWidth,r.img.destHeight)),e.drawImage(r.baseImgCanvas,r.img.srcLeft,r.img.srcTop,r.img.srcWidth,r.img.srcHeight,r.img.destLeft,r.img.destTop,r.img.destWidth,r.img.destHeight)),r.isSafari&&r.notify("filter",{prop:"apply-filter",onPropertyChange:!1,value:{context:e}})},t.prototype.downScale=function(e,t,o,i){var r=this.parent;if(!i||!r.isStraightening){for(var n=e.width,a=e.height,s=n/(t=Math.round(t)),l=a/(o=Math.round(o)),p=Math.ceil(s/2),h=Math.ceil(l/2),d=e.getContext("2d"),a=d.getImageData(0,0,n,a),c=d.createImageData(t,o),u=a.data,g=c.data,v=0;v<o;v++)for(var f=0;f<t;f++){for(var C=4*(f+v*t),b=0,m=0,y=0,P=0,j=0,x=0,w=(v+.5)*l,O=Math.floor(v*l),S=Math.ceil((v+1)*l),T=O;T<S;T++)for(var k=Math.abs(w-(T+.5))/h,F=(f+.5)*s,I=k*k,k=Math.floor(f*s),A=Math.ceil((f+1)*s),z=k;z<A;z++){var R,D=Math.abs(F-(z+.5))/p,D=Math.sqrt(I+D*D);1<=D||(x+=(D=2*D*D*D-3*D*D+1)*u[3+(R=4*(z+T*n))],m+=D,y+=(D=D*u[3+R]/250)*u[R],P+=D*u[1+R],j+=D*u[2+R],b+=D)}g[C]=y/b,g[1+C]=P/b,g[2+C]=j/b,g[3+C]=x/m}e.width=(i?r.activeObj.activePoint:r.lowerCanvas).width,e.height=(i?r.activeObj.activePoint:r.lowerCanvas).height,d.putImageData(c,0,0)}},t.prototype.drawImgToCtx=function(e,t){var o=this.parent;e.canvas.id!==o.element.id+"_tempCanvas"&&e!==this.upperContext&&T.isNullOrUndefined(t)&&this.downScaleImgCanvas(e,null,null,null)},t.prototype.getFrameColor=function(e,t,o){this.parent.frameObj.color;return e.gradientColor?((t=t.createLinearGradient(o.startX,o.startY,o.startX+o.width,o.startY+o.height)).addColorStop(0,e.color),t.addColorStop(1,e.gradientColor),t):e.color},t.prototype.applyFrame=function(e,t,o){var i,r,n,a,s=this.parent,l=(s.frameObj.type=t,{width:1,height:1}),p={startX:s.img.destLeft-e.lineWidth,startY:s.img.destTop-e.lineWidth,width:s.img.destWidth+2*e.lineWidth,height:s.img.destHeight+2*e.lineWidth},h={type:s.frameObj.type,color:s.frameObj.color,size:s.frameObj.size,inset:s.frameObj.inset,offset:s.frameObj.offset/2,radius:s.frameObj.radius,amount:s.frameObj.amount,border:s.frameObj.border,gradientColor:s.frameObj.gradientColor},d=s.transform.zoomFactor,c=(e.canvas.id===s.element.id+"_tempCanvas"?(r=e.canvas.width,n=e.canvas.height,s.notify("crop",{prop:"calcRatio",onPropertyChange:!(a={width:0,height:0}),value:{obj:a,dimension:{width:r,height:n}}}),h.size*=((l=a).width+l.height)/2,h.inset*=(l.width+l.height)/2,h.offset*=(l.width+l.height)/2,h.radius*=(l.width+l.height)/2,p={startX:0,startY:0,width:e.canvas.width,height:e.canvas.height},s.notify("export",{prop:"updateSaveContext",onPropertyChange:!1,value:{context:e}})):e===this.upperContext&&s.activeObj.shape?p={startX:s.activeObj.activePoint.startX-e.lineWidth,startY:s.activeObj.activePoint.startY-e.lineWidth,width:s.activeObj.activePoint.width+2*e.lineWidth,height:s.activeObj.activePoint.height+2*e.lineWidth}:T.isNullOrUndefined(o)&&e.clearRect(0,0,e.canvas.width,e.canvas.height),(l.width+l.height)/2*40),u=(l.width+l.height)/2*50;if(e!==this.upperContext&&(h.size+=h.size*d,h.inset+=h.inset*d,h.offset+=h.offset*d,h.radius+=h.radius*d,c+=c*d,u+=u*d),e!==this.upperContext||!s.activeObj.shape||!("mat"===t&&(p.width-2*h.size<0||p.height-2*h.size<0)||"bevel"===t&&(p.width-2*h.size<40||p.height-2*h.size<40)||"inset"===t&&(p.startX+p.width-h.offset-(p.startX+h.offset)<0||p.startY+p.height-h.offset-(p.startY+h.offset)<0)||"hook"===t&&(p.width-2*h.size<50||p.height-2*h.size<50))){var g={bevelFilter:e.filter},v=e.filter;if(s.currSelectionPoint&&"crop-circle"===s.currSelectionPoint.shape||s.isCircleCrop||e===this.lowerContext&&s.isCropTab)this.drawImgToCtx(e,o);else{switch(t){case"none":this.drawImgToCtx(e,o);break;case"mat":for(this.drawImgToCtx(e,o);(p.width-2*h.size<0||p.height-2*h.size<0)&&0<h.size;)h.size-=20;e.filter="none",e.fillStyle=this.getFrameColor(h,e,p),e.beginPath(),e.rect(p.startX,p.startY,p.width,p.height),e.rect(p.startX+h.size,p.startY+h.size,p.width-2*h.size,p.height-2*h.size),e.fill("evenodd"),e.closePath();break;case"bevel":for(e.filter="none",e.fillStyle=this.getFrameColor(h,e,p),e.beginPath(),e.fillRect(p.startX,p.startY,p.width,p.height),e.closePath(),p.startX+=h.size,p.startY+=h.size,p.width-=2*h.size,p.height-=2*h.size;(p.width-2*h.size<40||p.height-2*h.size<40)&&0<h.size;)p.startX-=h.size,p.startY-=h.size,p.width+=2*h.size,p.height+=2*h.size,h.size-=20,p.startX+=h.size,p.startY+=h.size,p.width-=2*h.size,p.height-=2*h.size;e.fillStyle=this.getFrameColor(h,e,p),e.save(),e.beginPath(),e.moveTo(p.startX+c,p.startY),e.lineTo(p.startX+p.width-c,p.startY),e.quadraticCurveTo(p.startX+p.width,p.startY,p.startX+p.width,p.startY+c),e.lineTo(p.startX+p.width,p.startY+p.height-c),e.quadraticCurveTo(p.startX+p.width,p.startY+p.height,p.startX+p.width-c,p.startY+p.height),e.lineTo(p.startX+c,p.startY+p.height),e.quadraticCurveTo(p.startX,p.startY+p.height,p.startX,p.startY+p.height-c),e.lineTo(p.startX,p.startY+c),e.quadraticCurveTo(p.startX,p.startY,p.startX+c,p.startY),e.closePath(),e.clip(),e.filter="none"===v?s.canvasFilter:v,e.canvas.id===s.element.id+"_tempCanvas"?(o=null,e.filter="none",e.drawImage(s.inMemoryCanvas,0,0),e.filter="none"===v?s.canvasFilter:v):(e.clearRect(0,0,e.canvas.width,e.canvas.height),o?(o=null,0!==s.transform.zoomFactor&&(this.isRotateZoom=!0),s.notify("filter",{prop:"getBevelFilter",onPropertyChange:!1,value:{obj:g}}),e.filter=g.bevelFilter,this.updateCurrTransState("initial"),this.drawImgToCtx(e,o),this.updateCurrTransState("reverse"),this.isRotateZoom=!1,s.frameObj.type="none",e.filter="none",s.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:e,shape:"iterate",pen:"iterate",isPreventApply:null}}),s.frameObj.type="bevel",e.filter="none"===v?s.canvasFilter:v):(s.notify("filter",{prop:"getBevelFilter",onPropertyChange:!1,value:{obj:g}}),e.filter=g.bevelFilter,this.drawImgToCtx(e,o))),e.restore();break;case"line":this.drawImgToCtx(e,o),i=e.lineWidth,e.lineWidth=h.size/10;for(var f=0;f<s.frameObj.amount;f++){0<f&&(p.startX+=h.offset,p.startY+=h.offset,p.width-=2*h.offset,p.height-=2*h.offset);var C=p.startY+p.height-h.inset-h.radius,b=p.startY+h.inset+h.radius,m=p.startX+p.width-h.inset-h.radius,y=p.startX+h.inset+h.radius,P=p.startX+h.inset+h.radius,j=p.startX+p.width-h.inset-h.radius,x=p.startY+h.inset+h.radius,w=p.startY+p.height-h.inset-h.radius;b<=C&&y<=m&&P<=j&&x<=w&&(e.filter="none",e.strokeStyle=this.getFrameColor(h,e,p),"dashed"===h.border?e.setLineDash([2.5*e.lineWidth,1.5*e.lineWidth]):"dotted"===h.border&&e.setLineDash([e.lineWidth,e.lineWidth]),e.beginPath(),e.moveTo(p.startX+h.inset+h.radius,p.startY+h.inset),e.lineTo(p.startX+p.width-h.inset-h.radius,p.startY+h.inset),e.arcTo(p.startX+p.width-h.inset,p.startY+h.inset,p.startX+p.width-h.inset,p.startY+h.inset+h.radius,h.radius),e.lineTo(p.startX+p.width-h.inset,p.startY+p.height-h.inset-h.radius),e.arcTo(p.startX+p.width-h.inset,p.startY+p.height-h.inset,p.startX+p.width-h.inset-h.radius,p.startY+p.height-h.inset,h.radius),e.lineTo(p.startX+h.inset+h.radius,p.startY+p.height-h.inset),e.arcTo(p.startX+h.inset,p.startY+p.height-h.inset,p.startX+h.inset,p.startY+p.height-h.inset-h.radius,h.radius),e.lineTo(p.startX+h.inset,p.startY+h.inset+h.radius),e.arcTo(p.startX+h.inset,p.startY+h.inset,p.startX+h.inset+h.radius,p.startY+h.inset,h.radius),e.closePath(),e.stroke(),e.setLineDash([]))}e.lineWidth=i;break;case"inset":this.drawImgToCtx(e,o),e.filter="none",e.strokeStyle=this.getFrameColor(h,e,p),i=e.lineWidth,e.lineWidth=h.size/10,e.beginPath(),e.moveTo(p.startX+h.offset,p.startY+h.inset),e.lineTo(p.startX+p.width-h.offset,p.startY+h.inset),e.moveTo(p.startX+p.width-h.inset,p.startY+h.offset),e.lineTo(p.startX+p.width-h.inset,p.startY+p.height-h.offset),e.moveTo(p.startX+p.width-h.offset,p.startY+p.height-h.inset),e.lineTo(p.startX+h.offset,p.startY+p.height-h.inset),e.moveTo(p.startX+h.inset,p.startY+p.height-h.offset),e.lineTo(p.startX+h.inset,p.startY+h.offset),e.stroke(),e.closePath(),e.lineWidth=i;break;case"hook":this.drawImgToCtx(e,o),e.filter="none",e.strokeStyle=this.getFrameColor(h,e,p),i=e.lineWidth,e.lineWidth=h.size/10,e.beginPath(),e.moveTo(p.startX+h.inset+u,p.startY+h.inset),e.lineTo(p.startX+h.inset,p.startY+h.inset),e.lineTo(p.startX+h.inset,p.startY+h.inset+u),e.moveTo(p.startX+p.width-h.inset-u,p.startY+h.inset),e.lineTo(p.startX+p.width-h.inset,p.startY+h.inset),e.lineTo(p.startX+p.width-h.inset,p.startY+h.inset+u),e.moveTo(p.startX+p.width-h.inset-u,p.startY+p.height-h.inset),e.lineTo(p.startX+p.width-h.inset,p.startY+p.height-h.inset),e.lineTo(p.startX+p.width-h.inset,p.startY+p.height-h.inset-u),e.moveTo(p.startX+h.inset+u,p.startY+p.height-h.inset),e.lineTo(p.startX+h.inset,p.startY+p.height-h.inset),e.lineTo(p.startX+h.inset,p.startY+p.height-h.inset-u),e.stroke(),e.lineWidth=i}(s.isCircleCrop||s.currSelectionPoint&&"crop-circle"===s.currSelectionPoint.shape)&&s.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:e,isSave:e.canvas.id===s.element.id+"_tempCanvas"||null,isFlip:null}}),e.filter=v}}},t.prototype.triggerFrameChange=function(e){var t=this.parent,e={cancel:!1,previousFrameSetting:e,currentFrameSetting:{type:t.toPascalCase(t.frameObj.type),color:t.frameObj.color,gradientColor:t.frameObj.gradientColor,size:t.frameObj.size,inset:t.frameObj.inset,offset:t.frameObj.offset,borderRadius:t.frameObj.radius,frameLineStyle:t.toPascalCase(t.frameObj.border),lineCount:t.frameObj.amount}};return t.trigger("frameChange",e),(t.editCompleteArgs=e).cancel||this.setFrameObj(e.currentFrameSetting),e},t.prototype.setFrameObj=function(e){var t=this.parent;t.frameObj.type=e.type.toLowerCase(),t.frameObj.color=e.color,t.frameObj.gradientColor=e.gradientColor,t.frameObj.size=e.size,t.frameObj.inset=e.inset,t.frameObj.offset=e.offset,t.frameObj.radius=e.borderRadius,t.frameObj.border=e.frameLineStyle.toLowerCase(),t.frameObj.amount=e.lineCount},t.prototype.zoomToSel=function(e,t){var o=this.parent;if(this.straightenActObj&&JSON.stringify(this.straightenActObj.activePoint)===JSON.stringify(e.activePoint))if(o.activeObj=T.extend({},this.straightenActObj,null,!0),this.allowRedactStraighten=!1,0===o.transform.straighten){var i=o.img.destWidth,r=o.img.destHeight;for(o.transform.straighten=360;;){if(T.isNullOrUndefined(this.straightenInitZoom)||!(Math.round(o.transform.zoomFactor*Math.pow(10,3))/Math.pow(10,3)>Math.round(this.straightenInitZoom*Math.pow(10,3))/Math.pow(10,3))){this.performDummyZoom();break}if(this.setZoomPan("out"),i===o.img.destWidth&&r===o.img.destHeight){this.performDummyZoom();break}0===o.transform.degree&&(o.transform.zoomFactor-=.025,o.transform.cropZoomFactor-=.025)}o.transform.straighten=0,o.img={destLeft:o.img.destLeft,destTop:o.img.destTop,destWidth:o.img.destWidth,destHeight:o.img.destHeight,srcLeft:o.img.srcLeft,srcTop:o.img.srcTop,srcWidth:o.img.srcWidth,srcHeight:o.img.srcHeight}}else T.isNullOrUndefined(this.straightenInitZoom)&&(this.straightenInitZoom=o.transform.zoomFactor),0<this.straightenInitZoom-o.transform.zoomFactor?o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-(this.straightenInitZoom-o.transform.zoomFactor),zoomPoint:null,isResize:!0}}):this.straightenInitZoom-o.transform.zoomFactor<0&&o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:this.straightenInitZoom-o.transform.zoomFactor,zoomPoint:null,isResize:!0}}),o.activeObj=T.extend({},e,null,!0),o.transform.zoomFactor+=.001,this.calcStraightenedPoints(t);else this.straightenActObj=T.extend({},e,null,!0),o.activeObj=T.extend({},this.straightenActObj,null,!0),this.straightenInitZoom=o.transform.zoomFactor,this.calcStraightenedPoints(t)},t.prototype.isDestPointSmall=function(){var e=this.parent,t=e.img,o={startX:t.destLeft,startY:t.destTop,width:t.destWidth,height:t.destHeight},i=(e.notify("shape",{prop:"straightenShapes",onPropertyChange:!1}),!1);return this.straightenDestPoints.destWidth&&this.straightenDestPoints.destHeight&&(t.destWidth<this.straightenDestPoints.destWidth||t.destHeight<this.straightenDestPoints.destHeight)&&(i=!0),t.destLeft=o.startX,t.destTop=o.startY,t.destWidth=o.width,t.destHeight=o.height,e.img=t,i},t.prototype.calcStraightenedPoints=function(n){for(var a=this.parent,s=a.img.destWidth,l=a.img.destHeight,p=(T.isNullOrUndefined(a.transform.zoomFactor)&&(a.transform.zoomFactor+=.025),this.updateImgCanvasPoints(),this);"break"!==function(){if(!(p.isLinesIntersect()||p.isSelOutsideImg()||n&&p.isDestPointSmall()))return p.performDummyZoom(),"break";if(a.activeObj=T.extend({},p.straightenActObj,null,!0),p.setZoomPan("in"),s===a.img.destWidth&&l===a.img.destHeight)return p.performDummyZoom(),"break";0===a.transform.degree&&(a.transform.zoomFactor+=.025,a.transform.cropZoomFactor+=.025);var e=p.imgCanvasPoints,t=a.img.destLeft,o=a.img.destTop,i=a.img.destWidth,r=a.img.destHeight;e.forEach(function(e){e.x=e.ratioX*i+t,e.y=e.ratioY*r+o}),p.imgCanvasPoints=e}(););},t.prototype.performDummyZoom=function(){var e=this.parent,t=(e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.025,zoomPoint:null,isResize:!0}}),e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.025,zoomPoint:null,isResize:!0}}),10*e.transform.zoomFactor);e.setProperties({zoomSettings:{zoomFactor:t=t<1?1+t/10:t}},!0),e.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:t}}),this.panToSel()},t.prototype.setZoomPan=function(e){var t=this.parent,o={maxDimension:null};0===t.transform.degree?(t.notify("transform",{prop:"cropZoom",onPropertyChange:!1,value:{value:"in"===e?.025:-.025,selectionObj:t.activeObj,obj:o}}),t.img.destWidth=o.maxDimension.width,t.img.destHeight=o.maxDimension.height):(t.transform.zoomFactor+="in"===e?.025:-.025,t.transform.cropZoomFactor+="in"===e?.025:-.025,this.updateCurrTransState("initial"),this.isRotateZoom=!0,this.setDestPoints(),this.isRotateZoom=!1,this.updateCurrTransState("reverse"))},t.prototype.updateImgCanvasPoints=function(){var e,t,o,i,r=this.parent,n=this.getImagePoints(),a={width:0,height:0},s=r.baseImgCanvas.width,l=r.baseImgCanvas.height,s=(r.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:a,dimension:{width:s,height:l}}}),r.transform.degree%90==0&&r.transform.degree%180!=0?a.height:a.width),l=r.transform.degree%90==0&&r.transform.degree%180!=0?a.width:a.height,a=r.img,p=a.destLeft,h=a.destTop,d=a.destWidth,a=a.destHeight;0<r.transform.straighten?(e={x:p+n[0].x/s,y:h},t={x:p+d,y:h+n[1].y/l},o={x:p+d-n[0].x/s,y:h+a},i={x:p,y:h+a-n[1].y/l}):r.transform.straighten<0?(e={x:p,y:h+n[0].y/l},t={x:p+n[1].x/s,y:h},o={x:p+d,y:h+a-n[0].y/l},i={x:p+d-n[1].x/s,y:h+a}):0===r.transform.straighten&&(e={x:p,y:h},t={x:p+d,y:h},o={x:p+d,y:h+a},i={x:p,y:h+a}),e.ratioX=(e.x-p)/d,e.ratioY=(e.y-h)/a,t.ratioX=(t.x-p)/d,t.ratioY=(t.y-h)/a,o.ratioX=(o.x-p)/d,o.ratioY=(o.y-h)/a,i.ratioX=(i.x-p)/d,i.ratioY=(i.y-h)/a,this.imgCanvasPoints=[e,t,o,i]},t.prototype.isLinesIntersect=function(e){var t,o,i,r,n,a,s,l,p,h=this.parent,d=h.activeObj.activePoint;return 0!==h.activeObj.rotatedAngle?(r=(o=h.activeObj.activePoint).startX,t=o.startY,s=o.endX,i=o.endY,l=r+o.width/2,o=t+o.height/2,n={x:(p=Math.cos(h.activeObj.rotatedAngle))*(r-l)-(h=Math.sin(h.activeObj.rotatedAngle))*(i-o)+l,y:h*(r-l)+p*(i-o)+o},i={x:p*(s-l)-h*(i-o)+l,y:h*(s-l)+p*(i-o)+o},a=this.imgCanvasPoints,s=this.doIntersect(r={x:p*(r-l)-h*(t-o)+l,y:h*(r-l)+p*(t-o)+o},h={x:p*(s-l)-h*(t-o)+l,y:h*(s-l)+p*(t-o)+o},a[0],a[1]),l=this.doIntersect(h,i,a[1],a[2]),p=this.doIntersect(n,i,a[2],a[3]),t=this.doIntersect(r,n,a[3],a[0]),e&&(e.arr=[s,l,p,t]),s||l||p||t):(o=this.imgCanvasPoints,h=this.doIntersect({x:d.startX,y:d.startY},{x:d.endX,y:d.startY},o[0],o[1]),i=this.doIntersect({x:d.endX,y:d.startY},{x:d.endX,y:d.endY},o[1],o[2]),r=this.doIntersect({x:d.startX,y:d.endY},{x:d.endX,y:d.endY},o[2],o[3]),n=this.doIntersect({x:d.startX,y:d.startY},{x:d.startX,y:d.endY},o[3],o[0]),a=this.isInsideRect(o[0]),s=this.isInsideRect(o[1]),l=this.isInsideRect(o[2]),p=this.isInsideRect(o[3]),e&&(e.arr=[h,i,r,n]),h||i||r||n||a||s||l||p||o[0].x>d.startX&&o[1].x<d.endX&&o[2].x<d.endX&&o[3].x>d.startX&&o[0].y<d.startY&&o[1].y<d.startY&&o[2].y>d.endY&&o[3].y>d.endY||o[0].x<d.startX&&o[1].x>d.endX&&o[2].x>d.endX&&o[3].x<d.startX&&o[0].y>d.startY&&o[1].y>d.startY&&o[2].y<d.endY&&o[3].y<d.endY)},t.prototype.isSelOutsideImg=function(){var e=this.parent,t=this.imgCanvasPoints,e=e.activeObj.activePoint;return"inside"!==this.checkPointPosition(e.startX,e.startY,t[0].x,t[0].y,t[1].x,t[1].y,t[2].x,t[2].y,t[3].x,t[3].y)||"inside"!==this.checkPointPosition(e.endX,e.startY,t[0].x,t[0].y,t[1].x,t[1].y,t[2].x,t[2].y,t[3].x,t[3].y)||"inside"!==this.checkPointPosition(e.startX,e.endY,t[0].x,t[0].y,t[1].x,t[1].y,t[2].x,t[2].y,t[3].x,t[3].y)||"inside"!==this.checkPointPosition(e.endX,e.endY,t[0].x,t[0].y,t[1].x,t[1].y,t[2].x,t[2].y,t[3].x,t[3].y)},t.prototype.calcTriangleArea=function(e,t,o,i,r,n){return Math.abs((e*(i-n)+o*(n-t)+r*(t-i))/2)},t.prototype.checkPointPosition=function(e,t,o,i,r,n,a,s,l,p){var h=this.calcTriangleArea(e,t,o,i,l,p),d=this.calcTriangleArea(e,t,l,p,a,s),c=this.calcTriangleArea(e,t,a,s,r,n),e=this.calcTriangleArea(e,t,r,n,o,i),t=this.calcTriangleArea(o,i,r,n,a,s)+this.calcTriangleArea(a,s,l,p,o,i);return t<h+d+c+e?"outside":h+d+c+e!==t||0!==h&&0!==d&&0!==c&&0!==e?"inside":"on"},t.prototype.getImagePoints=function(){var e=[],t=this.parent,o=t.transform.degree,i=t.baseImg.width,r=t.baseImg.height,n={dim:null,width:r,height:i,angle:t.transform.straighten};n.dim=t.getRotatedCanvasDim(n.width,n.height,n.angle);var a=o%90==0&&o%180!=0?r:i,i=o%90==0&&o%180!=0?i:r,r=(o%90==0&&o%180!=0?n.dim:t.baseImgCanvas).width/2,o=(o%90==0&&o%180!=0?n.dim:t.baseImgCanvas).height/2,n=r-a/2,s=o-i/2,a=r+a/2,i=o+i/2,t=t.transform.straighten*(Math.PI/180),l={x:Math.cos(t)*(n-r)-Math.sin(t)*(s-o)+r,y:Math.sin(t)*(n-r)+Math.cos(t)*(s-o)+o},s={x:Math.cos(t)*(a-r)-Math.sin(t)*(s-o)+r,y:Math.sin(t)*(a-r)+Math.cos(t)*(s-o)+o},a={x:Math.cos(t)*(a-r)-Math.sin(t)*(i-o)+r,y:Math.sin(t)*(a-r)+Math.cos(t)*(i-o)+o},n={x:Math.cos(t)*(n-r)-Math.sin(t)*(i-o)+r,y:Math.sin(t)*(n-r)+Math.cos(t)*(i-o)+o};return e.push(l),e.push(s),e.push(a),e.push(n),e},t.prototype.doIntersect=function(e,t,o,i){var r=this.initiation(e,t,o),n=this.initiation(e,t,i),a=this.initiation(o,i,e),s=this.initiation(o,i,t);return r!==n&&a!==s||!!(0===r&&this.onSegment(e,o,t)||0===n&&this.onSegment(e,i,t)||0===a&&this.onSegment(o,e,i)||0===s&&this.onSegment(o,t,i))},t.prototype.initiation=function(e,t,o){e=(t.y-e.y)*(o.x-t.x)-(t.x-e.x)*(o.y-t.y);return 0==e?0:0<e?1:2},t.prototype.onSegment=function(e,t,o){return t.x<=Math.max(e.x,o.x)&&t.x>=Math.min(e.x,o.x)&&t.y<=Math.max(e.y,o.y)&&t.y>=Math.min(e.y,o.y)},t.prototype.isInsideRect=function(e){var t=this.parent.activeObj.activePoint,o=!1;return o=e.x>=t.startX&&e.x<=t.endX&&e.y>=t.startY&&e.y<=t.endY?!0:o},t.prototype.setDestForStraighten=function(){var e,t,o,i,r=this.parent;T.isNullOrUndefined(this.straightenDestPoints)&&(e=(i=r.img).destLeft,t=i.destTop,o=i.destWidth,i=i.destHeight,r.notify("shape",{prop:"straightenShapes",onPropertyChange:!1}),this.straightenDestPoints=T.extend({},r.img,{},!0),r.img.destLeft=e,r.img.destTop=t,r.img.destWidth=o,r.img.destHeight=i)},t.prototype.drawRedact=function(e,t){var o,i,r,n,a,s,l,p,h,d,c,u,g,v,f,C,b,m,y,P=t.activePoint,j=P.startX,x=P.startY,w=P.endX,P=P.endY,O=t.activePoint,S=O.width,O=O.height,T=!1,k=e.canvas,F=(-1!==k.id.indexOf("_tempCanvas")&&(T=!0),this.parent.img);S<=0||O<=0||(this.parent.isCropTab?e.drawImage(t.redactImage,0,0,t.redactImage.width,t.redactImage.height,j,x,S,O):(i=(o=document.createElement("canvas")).getContext("2d"),r=k.width,n=k.height,r=Math.min(r,n)/1e3,n=(0!==this.parent.transform.straighten?this.parent.transform:this.parent.cropObj).straighten,this.allowRedactStraighten&&0!==n&&(s=(a=document.createElement("canvas")).getContext("2d"),T?(a.width=k.width,a.height=k.height,s.drawImage(k,0,0)):(a.width=F.destWidth,a.height=F.destHeight,s.drawImage(this.lowerContext.canvas,F.destLeft,F.destTop,F.destWidth,F.destHeight,0,0,F.destWidth,F.destHeight)),s=-n*Math.PI/180,p=(l=document.createElement("canvas")).getContext("2d"),l.width=a.width,l.height=a.height,F.destWidth>k.width&&!T&&(l.width=k.width),F.destHeight>k.height&&!T&&(l.height=k.height),p.save(),p.translate(a.width/2,a.height/2),p.rotate(s),p.drawImage(a,-a.width/2,-a.height/2),p.restore(),0<F.destLeft&&!T&&(j-=F.destLeft,w-=F.destLeft),0<F.destTop&&!T&&(x-=F.destTop,P-=F.destTop),m={x:j+S/2,y:x+O/2},C=Math.cos(n*Math.PI/180),v=Math.sin(n*Math.PI/180),d=C*(j-m.x)-v*(x-m.y)+m.x,c=v*(j-m.x)+C*(x-m.y)+m.y,u=C*(w-m.x)-v*(x-m.y)+m.x,g=v*(w-m.x)+C*(x-m.y)+m.y,f=C*(j-m.x)-v*(P-m.y)+m.x,b=v*(j-m.x)+C*(P-m.y)+m.y,T?m={x:k.width/2,y:k.height/2}:(m={x:F.destWidth/2,y:F.destHeight/2},F.destWidth>k.width&&(m.x=k.width/2),F.destHeight>k.height&&(m.y=k.height/2)),C=Math.cos(s),v=Math.sin(s),h=C*(d-m.x)-v*(c-m.y)+m.x,d=v*(d-m.x)+C*(c-m.y)+m.y,c=C*(u-m.x)-v*(g-m.y)+m.x,u=v*(u-m.x)+C*(g-m.y)+m.y,m.x,m.y,m.x,g=v*(f-m.x)+C*(b-m.y)+m.y,v=T?e.canvas.width:F.destWidth,f=T?e.canvas.height:F.destHeight,C=Math.abs(v*Math.cos(s))+Math.abs(f*Math.sin(s)),b=Math.abs(v*Math.sin(s))+Math.abs(f*Math.cos(s)),l.width=C,l.height=b,p.save(),p.translate(C/2,b/2),p.rotate(s),p.drawImage(a,-a.width/2,-a.height/2),p.restore(),"blur"===this.parent.activeObj.redactType?(o.width=S,o.height=O,i.drawImage(l,h+(C-a.width)/2,d+(b-a.height)/2,c-h,g-u,0,0,S,O)):(y=t.redactPixelate/100*20,T&&(y=r*(t.redactPixelate/100)*35),o.width=Math.ceil(S/y),o.height=Math.ceil(O/y),i.drawImage(l,h+(C-a.width)/2,d+(b-a.height)/2,c-h,g-u,0,0,o.width,o.height))),"blur"===this.parent.activeObj.redactType?(0===n&&(o.width=S,o.height=O,i.drawImage(T?k:this.lowerContext.canvas,j,x,S,O,0,0,S,O)),T?(m=r*(t.redactBlur/100*34),i.filter="blur("+m+"px)"):i.filter="blur("+t.redactBlur/100*17+"px)",i.drawImage(o,0,0),0===n?i.drawImage(T?k:this.lowerContext.canvas,j,x,S,O,0,0,S,O):(0<F.destLeft&&!T&&(j+=F.destLeft,w+=F.destLeft),0<F.destTop&&!T&&(x+=F.destTop,P+=F.destTop)),this.parent.isSafari&&this.parent.notify("filter",{prop:"apply-filter",onPropertyChange:!1,value:{context:i}}),e.drawImage(o,0,0,S,O,j,x,S,O)):(y=t.redactPixelate/100*20,T&&(y=r*(t.redactPixelate/100)*35),0===n?(o.width=Math.ceil(S/y),o.height=Math.ceil(O/y),i.drawImage(T?k:this.lowerContext.canvas,j,x,S,O,0,0,o.width,o.height)):(0<F.destLeft&&!T&&(j+=F.destLeft,w+=F.destLeft),0<F.destTop&&!T&&(x+=F.destTop,P+=F.destTop)),e.imageSmoothingEnabled=!1,e.drawImage(o,0,0,o.width,o.height,j,x,S,O)),t.redactImage=this.parent.createElement("canvas"),t.redactImage.width=o.width,t.redactImage.height=o.height,t.redactImage.getContext("2d").drawImage(o,0,0),e.beginPath(),e.rect(j,x,S,O),e.rect(j,x,S,O),e.fill("evenodd"),e.closePath()))},t);function t(e){this.isInitialLoading=!1,this.fileName="",this.isErrorImage=!1,this.isShapeTextInserted=!1,this.isRotateZoom=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,outlineColor:"",radius:null,outlineWidth:null},this.tempTextSettings={text:"Enter Text",fontFamily:"",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.tempAdjValue="",this.tempFilter="",this.tempUndoRedoStep=0,this.tempFreehandCounter=0,this.tempCurrFhdIndex=0,this.tempZoomFactor=null,this.isCancelAction=!1,this.rotatedFlipCropSel=!1,this.zoomCrop={width:0,height:0},this.isImageEdited=!1,this.isFileChanged=!1,this.isNewPath=!1,this.isResizeSelect=!1,this.arrowDimension={bar:{width:10,height:32,ratioX:null,ratioY:null},arrow:{width:24,height:24,ratioX:null,ratioY:null},arrowSolid:{width:32,height:32,ratioX:null,ratioY:null},circle:{width:10,height:10,ratioX:null,ratioY:null},square:{width:20,height:20,ratioX:null,ratioY:null}},this.origDim={width:0,height:0},this.isImageApply=!1,this.imgCanvasPoints=[],this.isCropSelect=!1,this.isDownScale=!1,this.preventStraightening=!1,this.tempObjColl=[],this.tempPointColl={},this.imageBackgroundColor="",this.allowRedactStraighten=!0,this.isNullExtension=!0,this.parent=e,this.addEventListener()}n.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},n.prototype.addEventListener=function(){this.parent.on("export",this.export,this),this.parent.on("destroyed",this.destroy,this)},n.prototype.removeEventListener=function(){this.parent.off("export",this.export),this.parent.off("destroyed",this.destroy)},n.prototype.export=function(e){switch(this.parent.notify("toolbar",{prop:"refreshShapeDrawing",onPropertyChange:!1}),this.updatePvtVar(),e.prop){case"export":this.exportImg(e.value.type,e.value.fileName,e.value.imgQuality);break;case"exportToCanvas":this.exportToCanvas(e.value.object);break;case"updateSaveContext":this.updateSaveContext(e.value.context);break;case"setImageQuality":this.imageQuality=e.value.value;break;case"drawAnnotation":this.drawAnnotation(e.value.context,e.value.ratio)}},n.prototype.getModuleName=function(){return"export"},n.prototype.updatePvtVar=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d"))},n.prototype.exportImg=function(e,t,o){var i,r=this.parent,n={fileName:""},n=(r.notify("draw",{prop:"getFileName",onPropertyChange:!1,value:{obj:n}}),n.fileName);!r.disabled&&r.isImageLoaded&&(r.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),i={canvasFilter:this.parent.canvasFilter},this.lowerContext.filter=i.canvasFilter,e=e||"Png",r.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),r.trigger("beforeSave",i={cancel:!1,fileName:t||n,fileType:e,imageQuality:o}),this.beforeSaveEvent(i,e,t,n,o))},n.prototype.beforeSaveEvent=function(e,t,o,i,r){var n=this.parent;e.cancel||(n.currObjType.isSave=!0,o=(o=e.fileName||o)||i,"svg"===(e=t.toLowerCase())?this.toSVGImg(o):this.toBlobFn(o,e,r),n.trigger("saved",e={fileName:o||i,fileType:t}),n.triggerEditCompleteEvent({action:"save",actionEventArgs:e}),n.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),n.lowerCanvas.style.left=n.upperCanvas.style.left="",n.lowerCanvas.style.top=n.upperCanvas.style.top="",n.lowerCanvas.style.maxWidth=n.upperCanvas.style.maxWidth="",n.lowerCanvas.style.maxHeight=n.upperCanvas.style.maxHeight="")},n.prototype.toSVGImg=function(e){var t=this.parent,o=(f.showSpinner(t.element),t.element.style.opacity="0.5",this.exportToCanvas()),i=o.toDataURL(),t=(f.hideSpinner(t.element),t.element.style.opacity="1",document.createElementNS("http://www.w3.org/2000/svg","svg")),r=(t.setAttribute("width",o.style.maxWidth),t.setAttribute("height",o.style.maxHeight),document.createElementNS("http://www.w3.org/2000/svg","image")),i=(r.setAttributeNS(null,"height",o.height.toString()),r.setAttributeNS(null,"width",o.width.toString()),r.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",i),t.appendChild(r),'<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="'+o.width+'" height="'+o.height+'">'),r=t.innerHTML,o="data:image/svg+xml;base64,"+btoa(i+r+"</svg>");return null===e?o:(this.downloadImg(o,e+".svg"),null)},n.prototype.toBlobFn=function(t,o,e){var i=this,r=this.parent;f.showSpinner(r.element),r.element.style.opacity="0.5",T.isNullOrUndefined(e)||(this.imageQuality=(e=1<e?1:e<=0?.01:e)||null),this.exportToCanvas().toBlob(function(e){e=URL.createObjectURL(e);i.downloadImg(e,t+"."+o),f.hideSpinner(r.element),r.element.style.opacity="1"},"jpeg"===o?"image/jpeg":"webp"===o?"image/webp":"image/png",this.imageQuality||null)},n.prototype.exportToCanvas=function(e){var t,o,i=this.parent,r=T.extend({},i.cropObj,{},!0),n={currObj:{}},n=(i.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}}),n.currObj),a=(n.objColl=T.extend([],i.objColl,[],!0),n.pointColl=T.extend([],i.pointColl,[],!0),n.afterCropActions=T.extend([],i.afterCropActions,[],!0),{selPointColl:null}),s=(i.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),this.parent.aspectWidth?(i.notify("undo-redo",{prop:"setPreventUR",value:{bool:!0}}),i.notify("toolbar",{prop:"resizeClick",value:{bool:!1}}),i.okBtn(),o=i.transform.degree%90==0&&i.transform.degree%180!=0?(t=this.parent.aspectHeight,this.parent.aspectWidth):(t=this.parent.aspectWidth,this.parent.aspectHeight),i.notify("undo-redo",{prop:"setPreventUR",value:{bool:!1}})):o=i.currSelectionPoint?(t=i.img.srcWidth,i.img.srcHeight):(t=i.baseImgCanvas.width,i.baseImgCanvas.height),{width:0,height:0}),l=(i.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:s,dimension:{width:t,height:o}}}),this.lowerContext.filter),p=("none"!==this.lowerContext.filter&&(h=this.lowerContext.filter.split(" "),p=parseFloat(h[5].split("(")[1]),h[5]="blur("+(p*=(s.width+s.height)/2)+"px)",this.lowerContext.filter=h.join(" ")),i.createElement("canvas",{id:i.element.id+"_tempCanvas",attrs:{name:"canvasImage"}})),h=p.getContext("2d"),d=(p.width=t,p.height=o,{width:0,height:0}),d=(i.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t,height:o,obj:d}}),p.style.maxWidth=d.width+"px",p.style.maxHeight=d.height+"px",this.lowerContext.filter);return h.filter=this.lowerContext.filter,this.downScaleImgCanvas(h,t,o),this.lowerContext.filter=d,0===i.transform.degree&&""===i.transform.currFlipState&&0===i.transform.straighten||(this.updateSaveContext(h),this.exportTransformedImage(h)),i.isSafari&&i.notify("filter",{prop:"apply-filter",onPropertyChange:!1,value:{context:h}}),this.drawAnnotation(h,s),i.isCircleCrop&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:h,isSave:!0,isFlip:null}}),this.updateFrame(h,!0),this.lowerContext.filter=l,i.canvasFilter=l,e&&(e.canvas=p),i.aspectWidth&&(i.objColl=[],i.pointColl=[],i.freehandCounter=0,i.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),i.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:n}}),n.selPointColl=T.extend([],a.selPointColl,[],!0),i.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:n.selPointColl}}}),i.cropObj=r,i.objColl=T.extend([],n.objColl,[],!0),i.pointColl=T.extend([],n.pointColl,[],!0),i.freehandCounter=i.pointColl.length,i.transform.straighten=0,this.lowerContext.filter="none",i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=n.filter,i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),i.isCircleCrop||i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape)&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),p},n.prototype.drawAnnotation=function(e,t){var o=this.parent,i=T.extend([],o.objColl,[],!0),r=T.extend([],o.pointColl,[],!0),n=o.shapeColl.filter(function(e){return"redact"!==e.shape}),a=o.shapeColl.filter(function(e){return"redact"===e.shape});o.shapeColl=a.concat(n);for(var s=0;s<o.shapeColl.length;s++)o.shapeColl[s].order&&(o.shapeColl[s].currIndex&&-1<o.shapeColl[s].currIndex.indexOf("shape")?(o.objColl=[],o.objColl.push(T.extend({},o.shapeColl[s],{},!0)),this.drawShape(e,t)):o.shapeColl[s].id&&-1<o.shapeColl[s].id.indexOf("pen")&&(o.pointColl=[],o.freehandCounter=0,o.pointColl.push(T.extend({},o.shapeColl[s],{},!0)),o.freehandCounter=o.pointColl.length,this.drawPen(e,t)));o.objColl=i,o.pointColl=r,o.freehandCounter=o.pointColl.length},n.prototype.drawShape=function(e,t){var o=this.parent;if(0<o.objColl.length){for(var i=e.filter,r=(e.filter="none",{index:null}),n=(o.notify("shape",{prop:"getSmallestIndex",onPropertyChange:!1,value:{obj:r}}),r.index),a=T.extend([],o.objColl,[],!0),r=T.extend([],o.objColl,[],!0);0<a.length;){for(var s=!1,l=0;l<a.length;l++){var p=a[l];if(T.isNullOrUndefined(p.order))a.splice(l,1),l--;else if(p.order===n){var p=e.filter,h=(e.filter="none",a[l]),d=h.activePoint;if(d.startX-=o.img.destLeft,d.startY-=o.img.destTop,d.endX-=o.img.destLeft,d.endY-=o.img.destTop,d.width=d.endX-d.startX,d.height=d.endY-d.startY,d.startX*=t.width,d.startY*=t.height,d.endX*=t.width,d.endY*=t.height,d.width=d.endX-d.startX,d.height=d.endY-d.startY,h.strokeSettings.strokeWidth*=(t.width+t.height)/2,"text"===h.shape)h.textSettings.fontSize*=(t.width+t.height)/2;else if("path"===h.shape)for(var c=0;c<h.pointColl.length;c++)h.pointColl[c].x=(h.pointColl[c].x-o.img.destLeft)*t.width,h.pointColl[c].y=(h.pointColl[c].y-o.img.destTop)*t.height;else"image"===h.shape&&(o.activeObj=T.extend({},a[l],{},!0),o.notify("selection",{prop:"upgradeImageQuality",onPropertyChange:!1}),a[l]=T.extend({},o.activeObj,{},!0));o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"saveContext",obj:a[l],isCropRatio:null,points:null,isPreventDrag:!0,saveContext:e,isPreventSelection:null}}),e.filter=p,o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),n++;d={bool:!1};o.notify("shape",{prop:"isIndexInObjColl",onPropertyChange:!1,value:{obj:d,index:n}}),d.bool||n++,a.splice(l,1),s=!0;break}}if(!s)break}e.filter=i,o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),o.objColl=r}},n.prototype.drawPen=function(e,t){var o=this.parent;if(0<o.freehandCounter){for(var i={penStrokeWidth:null},r=(o.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:i}}),T.extend({},o.pointColl,{},!0)),n=0;n<o.freehandCounter;n++){o.points=T.extend([],o.pointColl[n].points,[]),o.notify("freehand-draw",{prop:"setPointCounter",onPropertyChange:!1,value:{value:0}});var a=o.points.length;o.pointColl[n].strokeWidth*=(t.width+t.height)/2;for(var s=0;s<a;s++)o.points[s].x=(o.points[s].x-o.img.destLeft)*t.width,o.points[s].y=(o.points[s].y-o.img.destTop)*t.height}o.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:e,points:null}}),o.pointColl=r,o.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:i.penStrokeWidth}})}},n.prototype.downScaleImgCanvas=function(e,t,o){var i=this.parent,r=i.baseImgCanvas,n=i.baseImg,a={width:0,height:0},n=(i.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:n.width,height:n.height,obj:a,isImgShape:null}}),{color:null});i.notify("draw",{prop:"getImageBackgroundColor",value:{obj:n}}),""!==n.color&&(e.fillStyle=n.color,e.fillRect(0,0,e.canvas.width,e.canvas.height)),t<a.width&&o<a.height?((n=i.createElement("canvas",{id:i.element.id+"_downScaleCanvas",attrs:{name:"canvasImage"}})).width=this.parent.img.srcWidth,n.height=this.parent.img.srcHeight,n.getContext("2d").drawImage(r,i.img.srcLeft,i.img.srcTop,i.img.srcWidth,i.img.srcHeight,0,0,n.width,n.height),i.notify("draw",{prop:"downScale",value:{canvas:n,width:t,height:o}}),e.drawImage(n,0,0)):e.drawImage(i.baseImgCanvas,i.img.srcLeft,i.img.srcTop,i.img.srcWidth,i.img.srcHeight,0,0,t,o)},n.prototype.updateFrame=function(e,t){var o;"none"!==this.parent.frameObj.type&&(o=e.filter,e.filter="none",this.parent.notify("draw",{prop:"applyFrame",value:{ctx:e,frame:this.parent.frameObj.type,preventImg:t}}),e.filter=o)},n.prototype.downloadImg=function(e,t){var o=document.createElement("a");o.href=e,o.target="_parent",o.download=t,(document.body||document.documentElement).appendChild(o),o.click(),o.parentNode.removeChild(o)},n.prototype.exportTransformedImage=function(e){var t=this.parent,o=t.transform.degree;if(0<t.rotateFlipColl.length)for(var i=0,r=t.rotateFlipColl.length;i<r;i++){var n=t.rotateFlipColl[i];"number"==typeof n?this.exportRotate(e,n):"horizontal"===n?this.exportFlip(e,!0,!1):"vertical"===n&&this.exportFlip(e,!1,!0)}t.transform.degree=o},n.prototype.exportRotate=function(e,t){var o=this.parent;e.clearRect(0,0,e.canvas.width,e.canvas.height),this.setMaxDim(o.transform.degree,e.canvas),e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*t),e.drawImage(o.inMemoryCanvas,-e.canvas.height/2,-e.canvas.width/2,e.canvas.height,e.canvas.width),this.updateSaveContext(e)},n.prototype.exportFlip=function(e,t,o){e.clearRect(0,0,e.canvas.width,e.canvas.height),t&&(e.translate(e.canvas.width,0),e.scale(-1,1)),o&&(e.translate(0,e.canvas.height),e.scale(1,-1)),e.drawImage(this.parent.inMemoryCanvas,0,0),this.updateSaveContext(e)},n.prototype.updateSaveContext=function(e){var t=this.parent.inMemoryCanvas.getContext("2d"),e=(e.setTransform(1,0,0,1,0,0),e.getImageData(0,0,e.canvas.width,e.canvas.height));this.parent.inMemoryCanvas.width=e.width,this.parent.inMemoryCanvas.height=e.height,t.putImageData(e,0,0)},n.prototype.setMaxDim=function(e,t){e%90==0&&e%180!=0?o=T.isNullOrUndefined(this.parent.currSelectionPoint)?(i=this.parent.baseImgCanvas.height,this.parent.baseImgCanvas.width):(i=this.parent.img.srcHeight,this.parent.img.srcWidth):e%180!=0&&0!==e||(o=T.isNullOrUndefined(this.parent.currSelectionPoint)?(i=this.parent.baseImgCanvas.width,this.parent.baseImgCanvas.height):(i=this.parent.img.srcWidth,this.parent.img.srcHeight)),T.isNullOrUndefined(this.parent.aspectWidth)||(i=this.parent.aspectWidth,o=this.parent.aspectHeight),t.width=i,t.height=o;var o,e={width:0,height:0},i=(this.parent.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:i,height:o,obj:e,isImgShape:null}}),e);t.style.maxWidth=i.width+"px",t.style.maxHeight=i.height+"px"};var r=n;function n(e){this.parent=e,this.addEventListener()}s.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},s.prototype.addEventListener=function(){this.parent.on("filter",this.filter,this),this.parent.on("destroyed",this.destroy,this)},s.prototype.removeEventListener=function(){this.parent.off("filter",this.filter),this.parent.off("destroyed",this.destroy)},s.prototype.filter=function(e){switch(this.updatePrivateVariables(),e.prop){case"finetuneImage":this.finetuneImage(e.value.option,e.value.value);break;case"applyImageFilter":this.setFilter(e.value.option);break;case"update-finetunes":this.updateFinetunes();break;case"set-adjustment":this.setAdjustment(e.value.operation);break;case"initFilter":this.initFilter();break;case"setCurrAdjValue":this.setCurrAdjValue(e.value.type,e.value.value);break;case"updateAdj":this.updateAdj(e.value.type,e.value.value,e.value.isPreview,e.value.ctx);break;case"getCurrentObj":this.getCurrentObj(e.value.object);break;case"getAdjustmentLevel":T.isNullOrUndefined(this.parent.activeObj.opacity)?this.adjustmentLevel.transparency=100:this.adjustmentLevel.transparency=100*this.parent.activeObj.opacity,e.value.obj.adjustmentLevel=this.adjustmentLevel;break;case"setAdjustmentLevel":this.adjustmentLevel=e.value.adjustmentLevel;break;case"getTempAdjustmentLevel":e.value.obj.tempAdjustmentLevel=this.tempAdjustmentLevel;break;case"setTempAdjustmentLevel":this.tempAdjustmentLevel=e.value.tempAdjustmentLevel;break;case"setAdjustmentValue":this.adjustmentValue=e.value.adjustmentValue;break;case"setBrightnessAdjusted":this.isBrightnessAdjusted=e.value.isBrightnessAdjusted,this.parent.currentFilter.split("_")&&"cold"===this.parent.currentFilter.split("_")[1]&&(this.isBrightnessAdjusted=!1);break;case"getBevelFilter":e.value.obj.bevelFilter=this.bevelFilter;break;case"setBevelFilter":this.bevelFilter=e.value.bevelFilter;break;case"setTempAdjVal":this.tempAdjVal=T.extend({},this.adjustmentLevel,{},!0);break;case"setTempFilVal":this.tempFilVal=this.parent.currentFilter;break;case"reset":this.reset();break;case"apply-filter":this.applyFilter(e.value.context)}},s.prototype.updatePrivateVariables=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d"))},s.prototype.getModuleName=function(){return"filter"},s.prototype.reset=function(){this.adjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.tempAdjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.adjustmentValue=this.parent.getDefaultFilter(),this.isBrightnessAdjusted=!1,this.bevelFilter="none",this.tempFilVal="",this.tempAdjVal={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1}},s.prototype.updateFinetunes=function(){var t=this,e=this.parent,o=e.finetuneSettings;o&&(["brightness","contrast","hue","saturation","exposure","opacity","blur"].forEach(function(e){o[e]&&(t.adjustmentLevel[e]=o[e].defaultValue,t.tempAdjustmentLevel[e]=o[e].defaultValue)}),e.notify("draw",{prop:"isInitialLoading",onPropertyChange:!1,value:{isInitialLoading:!0}}))},s.prototype.initFilter=function(){this.setFilterAdj("brightness",this.adjustmentLevel.brightness),this.setFilterAdj("contrast",this.adjustmentLevel.contrast),this.setFilterAdj("hue",this.adjustmentLevel.hue),this.setFilterAdj("saturation",this.adjustmentLevel.saturation),this.setFilterAdj("exposure",this.adjustmentLevel.exposure),this.setFilterAdj("opacity",this.adjustmentLevel.opacity),this.setFilterAdj("blur",this.adjustmentLevel.blur)},s.prototype.updateAdj=function(e,t,o,i){var r,n,a=this.parent,s=(this.lowerContext.clearRect(0,0,a.lowerCanvas.width,a.lowerCanvas.height),this.lowerContext.filter.split(" ")),l=[],p=this.getFilterValue(this.adjustmentLevel.brightness);switch(e){case"brightness":t=this.getFilterValue(this.adjustmentLevel.exposure)+.005*t,s[0]="brightness("+t+")",t=0!==this.adjustmentLevel.brightness?this.adjustmentLevel.opacity/100-.3*this.adjustmentLevel.opacity/100:this.adjustmentLevel.opacity/100,s[4]="opacity("+t+")",this.adjustmentValue=s.join(" ");break;case"contrast":s[1]="contrast("+t+"%)",this.adjustmentValue=s.join(" ");break;case"hue":s[2]="hue-rotate("+t+"deg)",this.adjustmentValue=s.join(" ");break;case"saturation":s[3]="saturate("+t+"%)",this.adjustmentValue=s.join(" ");break;case"opacity":1!==parseFloat(s[0].split("(")[1])&&(t-=.2),s[4]="opacity("+(t=t<0?0:t)+")",this.adjustmentValue=s.join(" ");break;case"blur":s[5]="blur("+t+"px)",this.adjustmentValue=s.join(" ");break;case"exposure":1<t?(--t,t+=p):t<1&&(t=p-(t=1-t)),s[0]="brightness("+t+")",this.adjustmentValue=s.join(" ");break;case"chrome":r=this.getSaturationFilterValue(this.adjustmentLevel.saturation),s[3]="saturate("+(t=(r*=100)+.4*r)+"%)",l=this.adjustmentValue.split(" "),s[0]=l[0],s[1]=l[1],s[2]=l[2],s[4]=l[4],s[5]=l[5],s[6]="sepia(0%)",s[7]="grayscale(0%)",s[8]="invert(0%)";break;case"cold":r=this.getFilterValue(this.adjustmentLevel.brightness),t=.9*(r*=100),s[0]="brightness("+(t*=.01)+")",r=this.getFilterValue(this.adjustmentLevel.contrast),s[1]="contrast("+(t=(r*=100)+.5*r)+"%)",r=this.getSaturationFilterValue(this.adjustmentLevel.saturation),s[3]="saturate("+(t=r*=100)+"%)",l=this.adjustmentValue.split(" "),s[2]=l[2],s[4]=l[4],s[5]=l[5],s[6]="sepia(0%)",s[7]="grayscale(0%)",s[8]="invert(0%)";break;case"warm":r=this.getSaturationFilterValue(this.adjustmentLevel.saturation),s[3]="saturate("+(t=(r*=100)+.4*r)+"%)",s[6]="sepia(25%)",l=this.adjustmentValue.split(" "),s[0]=l[0],s[1]=l[1],s[2]=l[2],s[4]=l[4],s[5]=l[5],s[7]="grayscale(0%)",s[8]="invert(0%)";break;case"grayscale":s[7]="grayscale(100%)",l=this.adjustmentValue.split(" "),s[0]=l[0],s[1]=l[1],s[2]=l[2],s[3]=l[3],s[4]=l[4],s[5]=l[5],s[6]="sepia(0%)",s[8]="invert(0%)";break;case"sepia":s[6]="sepia(100%)",l=this.adjustmentValue.split(" "),s[0]=l[0],s[1]=l[1],s[2]=l[2],s[3]=l[3],s[4]=l[4],s[5]=l[5],s[7]="grayscale(0%)",s[8]="invert(0%)";break;case"invert":s[8]="invert(100%)",l=this.adjustmentValue.split(" "),s[0]=l[0],s[1]=l[1],s[2]=l[2],s[3]=l[3],s[4]=l[4],s[5]=l[5],s[6]="sepia(0%)",s[7]="grayscale(0%)"}"sharpen"!==e&&"blackandwhite"!==e&&(T.isNullOrUndefined(o)&&("default"===e&&(s=this.getDefaultCurrentFilter(s)),this.lowerContext.filter=s.join(" ")),s=this.setTempFilterValue(p,o,s,e),a.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!0}}),a.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),n=void 0,"bevel"===a.frameObj.type&&(n=this.lowerContext.filter,this.bevelFilter=n),0===a.transform.degree&&0<a.rotateFlipColl.length&&(a.img.destLeft+=a.panPoint.totalPannedPoint.x,a.img.destTop+=a.panPoint.totalPannedPoint.y),a.img.destLeft+=a.panPoint.totalPannedInternalPoint.x,a.img.destTop+=a.panPoint.totalPannedInternalPoint.y,0===a.transform.degree&&a.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),a.notify("draw",{prop:"drawImage",onPropertyChange:!1}),a.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),a.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),0===a.transform.degree&&0<a.rotateFlipColl.length&&(a.img.destLeft+=a.panPoint.totalPannedPoint.x,a.img.destTop+=a.panPoint.totalPannedPoint.y),s=this.setTempFilterValue(p,o,s,e),T.isNullOrUndefined(o)&&(this.lowerContext.filter=s.join(" ")),a.initialAdjustmentValue=s.join(" "),n=this.lowerContext.filter,this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",this.bevelFilter=n,a.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.lowerContext.filter=n,a.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),(a.currSelectionPoint&&"crop-circle"===a.currSelectionPoint.shape||a.isCircleCrop)&&a.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),this.isBrightnessAdjusted=1!==p);e=s.join(" ");i&&(i.filter=e)},s.prototype.setTempFilterValue=function(e,t,o,i){return t&&("default"===i?o=this.getDefaultCurrentFilter(o):1!==e&&((t=this.lowerContext.filter.split(" "))[4]=o[4],this.lowerContext.filter=t.join(" "))),o},s.prototype.getDefaultCurrentFilter=function(e){var t=this.adjustmentValue.split(" ");return[t[0],t[1],t[2],t[3],t[4],t[5],"sepia(0%)","grayscale(0%)","invert(0%)"]},s.prototype.getFilterValue=function(e){return 0===e?1:1+.5*e/100},s.prototype.getSaturationFilterValue=function(e){return 0===e?1:1+e/100},s.prototype.setFilterAdj=function(e,t){var o=this.parent;switch(o.notify("freehand-draw",{prop:"apply-pen-draw",onPropertyChange:!1}),this.adjustmentLevel[""+e]=t,e){case"contrast":case"exposure":t=this.getFilterValue(t),"contrast"===e&&(t*=100);break;case"hue":t*=3;break;case"saturation":t=100*this.getSaturationFilterValue(t);break;case"opacity":t<10&&(t+=1),t/=100;break;case"blur":0!==t&&(t=t/20+.5)}var i=T.extend({},o.cropObj,{},!0),r=this.getCurrentObj(),n=(r.objColl=T.extend([],o.objColl,[],!0),r.pointColl=T.extend([],o.pointColl,[],!0),r.afterCropActions=T.extend([],o.afterCropActions,[],!0),{selPointColl:null});o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),r.selPointColl=T.extend([],n.selPointColl,[],!0),this.updateAdj(e,t),o.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:e,previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})},s.prototype.setFilter=function(e){var t=this.parent;e=e.toLowerCase(),t.notify("freehand-draw",{prop:"apply-pen-draw",onPropertyChange:!1});var o={currentFilter:this.parent.currentFilter}.currentFilter,i=T.extend({},t.cropObj,{},!0),r=this.getCurrentObj(),n=(r.objColl=T.extend([],t.objColl,[],!0),r.pointColl=T.extend([],t.pointColl,[],!0),r.afterCropActions=T.extend([],t.afterCropActions,[],!0),{selPointColl:null});t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),r.selPointColl=T.extend([],n.selPointColl,[],!0),this.updateAdj(e,null),t.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:e,previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:o,isCircleCrop:null}})},s.prototype.setAdjustment=function(e){var t,o,i=this.lowerContext.filter.split(" ");switch(e){case"brightness":o=i[0].split("("),t=parseFloat(o[1].split(")")[0]),this.adjustmentLevel.brightness=this.setFilterValue(t);break;case"contrast":o=i[1].split("("),t=parseFloat(o[1].split(")")[0]),this.adjustmentLevel.contrast=this.setFilterValue(t/=100);break;case"hue":o=i[2].split("("),t=parseFloat(o[1].split(")")[0]),this.adjustmentLevel.hue=t/=3;break;case"saturation":o=i[3].split("("),t=parseFloat(o[1].split(")")[0]),this.adjustmentLevel.saturation=this.setSaturationFilterValue(t/=100);break;case"opacity":o=i[4].split("("),.45===(t=parseFloat(o[1].split(")")[0]))?t=40:.4===t?t=30:.35===t?t=20:.3===t?t=10:.25===t?t=0:t*=100,this.adjustmentLevel.opacity=t;break;case"blur":o=i[5].split("("),t=parseFloat(o[1].split(")")[0]),this.adjustmentLevel.blur=t*=20;break;case"exposure":o=i[0].split("("),t=parseFloat(o[1].split(")")[0]),this.adjustmentLevel.exposure=this.setFilterValue(t)}},s.prototype.setFilterValue=function(e){return Math.round(1===e?0:100*(e-1)/.5)},s.prototype.setSaturationFilterValue=function(e){return Math.round(1===e?0:100*(e-1))},s.prototype.finetuneImage=function(e,t){var o=this.parent;if(!o.disabled&&o.isImageLoaded){switch(e.toLowerCase()){case"brightness":this.setFilterAdj("brightness",t);break;case"contrast":this.setFilterAdj("contrast",t);break;case"hue":this.setFilterAdj("hue",t);break;case"saturation":this.setFilterAdj("saturation",t);break;case"opacity":this.setFilterAdj("opacity",t);break;case"blur":this.setFilterAdj("blur",t);break;case"exposure":this.setFilterAdj("exposure",t)}this.parent.canvasFilter=this.lowerContext.filter,o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})}},s.prototype.setCurrAdjValue=function(e,t){var o=this.parent;switch(this.parent.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),e){case"brightness":this.setFilterAdj("brightness",t);break;case"contrast":this.setFilterAdj("contrast",t);break;case"hue":this.setFilterAdj("hue",t);break;case"saturation":this.setFilterAdj("saturation",t);break;case"opacity":this.setFilterAdj("opacity",t);break;case"blur":this.setFilterAdj("blur",t);break;case"exposure":this.setFilterAdj("exposure",t)}o.isFinetuneBtnClick=!0,o.curFinetuneObjEvent={finetune:o.toPascalCase(e),value:t}},s.prototype.getCurrentObj=function(e){var t=this.parent,o={point:null},i=(t.notify("crop",{prop:"getTempFlipPanPoint",value:{obj:o}}),{previousZoomValue:null}),r=(t.notify("transform",{prop:"getPreviousZoomValue",value:{obj:i}}),{zoomFactor:null}),n=(t.notify("draw",{prop:"getStraightenInitZoom",value:{obj:r}}),{color:null}),a=(t.notify("draw",{prop:"getImageBackgroundColor",value:{obj:n}}),{cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",zoomFactor:0,previousZoomValue:0,straighten:0,destPoints:{startX:0,startY:0,width:0,height:0},frame:"none",srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:this.isBrightnessAdjusted,aspectWidth:null,aspectHeight:null,straightenZoom:0,adjustmentLevel:T.extend({},this.tempAdjVal,{},!0),currentFilter:this.tempFilVal,imageSource:"",bgColor:""});return a.cropZoom=t.transform.cropZoomFactor,a.defaultZoom=t.transform.defaultZoomFactor,a.zoomFactor=t.zoomSettings.zoomFactor,a.previousZoomValue=i.previousZoomValue,a.straightenZoom=r.zoomFactor,a.totalPannedPoint=T.extend({},t.panPoint.totalPannedPoint,{},!0),a.totalPannedClientPoint=T.extend({},t.panPoint.totalPannedClientPoint,{},!0),a.totalPannedInternalPoint=T.extend({},t.panPoint.totalPannedInternalPoint,{},!0),a.tempFlipPanPoint=T.extend({},o.point,{},!0),a.activeObj=T.extend({},t.activeObj,{},!0),a.rotateFlipColl=T.extend([],t.rotateFlipColl,[],!0),a.degree=t.transform.degree,a.straighten=t.cropObj.straighten,a.currFlipState=t.transform.currFlipState,a.destPoints={startX:t.img.destLeft,startY:t.img.destTop,endX:0,endY:0,width:t.img.destWidth,height:t.img.destHeight},a.srcPoints={startX:t.img.srcLeft,startY:t.img.srcTop,endX:0,endY:0,width:t.img.srcWidth,height:t.img.srcHeight},a.filter=this.lowerContext.filter,a.aspectWidth=t.aspectWidth,a.aspectHeight=t.aspectHeight,a.frame=t.frameObj.type,a.frameObj=T.extend({},t.frameObj),a.imageSource=t.baseImg.src,a.bgColor=n.color,e&&(e.currObj=a),a},s.prototype.getValFromPercentage=function(e){var t=parseFloat(e);return/%\s*?$/i.test(e)&&(t/=100),t},s.prototype.getValFromLength=function(e){return parseFloat(e)},s.prototype.parseFilterString=function(e){var t=[];return t=e&&"none"!==e?e.split(" ").map(function(e){e=e.match(/([a-z-]+)\(([^)]+)\)/).slice(1,3);return{filter:e[0],value:e[1]}}):t},s.prototype.applyFilter=function(e){for(var t=e.canvas,o=t.height,t=t.width,i=e.getImageData(0,0,t,o),r=this.parseFilterString(e.filter),n=0,a=r.length;n<a;n++)switch(r[n].filter){case"blur":i=this.blur(e,i,r[n].value);break;case"brightness":i=this.brightness(i,r[n].value);break;case"contrast":i=this.contrast(i,r[n].value);break;case"grayscale":i=this.grayscale(i,r[n].value);break;case"hue-rotate":i=this.hueRotate(i,r[n].value);break;case"invert":i=this.invert(i,r[n].value);break;case"opacity":i=this.opacity(i,r[n].value);break;case"saturate":i=this.saturate(e,i,r[n].value);break;case"sepia":i=this.sepia(i,r[n].value)}e.putImageData(i,0,0)},s.prototype.blur=function(e,t,o){var i=this.getValFromLength(o=void 0===o?"0":o),i=Math.floor(i);if(!(i<=0)){for(var o=e.canvas,r=o.height,n=o.width,a=t.data,s=new Uint8ClampedArray(a.length),l=0;l<r;l++)for(var p=0;p<n;p++){for(var h=0,d=0,c=0,u=0,g=0,v=-i;v<=i;v++)for(var f=-i;f<=i;f++){var C=p+f,b=l+v;0<=C&&C<n&&0<=b&&b<r&&(h+=a[b=4*(b*n+C)],d+=a[1+b],c+=a[2+b],u+=a[3+b],g++)}s[m=4*(l*n+p)]=h/g,s[m+1]=d/g,s[m+2]=c/g,s[m+3]=u/g}for(var m=0;m<a.length;m++)a[m]=s[m]}return t},s.prototype.brightness=function(e,t){var o=this.getValFromPercentage(t=void 0===t?"1":t);if(1!==o)for(var i=e.data,r=i.length,n=0;n<r;n+=4)i[n+0]*=o,i[n+1]*=o,i[n+2]*=o;return e},s.prototype.contrast=function(e,t){var o=this.getValFromPercentage(t=void 0===t?"1":t);if(1!==o)for(var i=e.data,r=i.length,n=0;n<r;n+=4)i[n+0]=255*((i[n+0]/255-.5)*o+.5),i[n+1]=255*((i[n+1]/255-.5)*o+.5),i[n+2]=255*((i[n+2]/255-.5)*o+.5);return e},s.prototype.grayscale=function(e,t){var o=this.getValFromPercentage(t=void 0===t?"0":t);if(0<o)for(var i=e.data,r=i.length,n=0;n<r;n+=4){var a=i[n],s=i[n+1],l=i[n+2],p=.299*a+.587*s+.114*l;i[n]=a*(1-o)+p*o,i[n+1]=s*(1-o)+p*o,i[n+2]=l*(1-o)+p*o}return e},s.prototype.hueRotate=function(e,t){void 0===t&&(t="0deg");var o=e.data,t=parseFloat(t)*(Math.PI/180);if(0<t)for(var i=Math.cos(t),t=Math.sin(t),r=[.213+.787*i-.213*t,.715-.715*i-.715*t,.072-.072*i+.928*t,.213-.213*i+.143*t,.715+.285*i+.14*t,.072-.072*i-.283*t,.213-.213*i-.787*t,.715-.715*i+.715*t,.072+.928*i+.072*t],n=0;n<o.length;n+=4){var a=o[n],s=o[n+1],l=o[n+2];o[n]=r[0]*a+r[1]*s+r[2]*l,o[n+1]=r[3]*a+r[4]*s+r[5]*l,o[n+2]=r[6]*a+r[7]*s+r[8]*l}return e},s.prototype.invert=function(e,t){var o=this.getValFromPercentage(t=void 0===t?"0":t);if(0<o)for(var i=e.data,r=i.length,n=0;n<r;n+=4)i[n+0]=Math.abs(i[n+0]-255*o),i[n+1]=Math.abs(i[n+1]-255*o),i[n+2]=Math.abs(i[n+2]-255*o);return e},s.prototype.opacity=function(e,t){var o=this.getValFromPercentage(t=void 0===t?"0":t);if(0<=o)for(var i=e.data,r=i.length,n=3;n<r;n+=4)i[n]*=o;return e},s.prototype.saturate=function(e,t,o){var i=this.getValFromPercentage(o=void 0===o?"0":o);if(1!==i)for(var o=e.canvas,r=o.width,n=o.height,a=t.data,s=.3086*(1-i),l=.6094*(1-i),p=.082*(1-i),h=r<<2,d=0;d<n;d++)for(var c=d*h,u=0;u<r;u++){var g=c+(u<<2),v=a[g],f=a[1+g],C=a[2+g];a[g]=(s+i)*v+l*f+p*C,a[1+g]=s*v+(l+i)*f+p*C,a[2+g]=s*v+l*f+(p+i)*C}return t},s.prototype.sepia=function(e,t){var o=this.getValFromPercentage(t=void 0===t?"0":t);if(0<(o=1<o?1:o))for(var i=e.data,r=i.length,n=0;n<r;n+=4){var a=i[n+0],s=i[n+1],l=i[n+2];i[n+0]=(.393*a+.769*s+.189*l)*o+a*(1-o),i[n+1]=(.349*a+.686*s+.168*l)*o+s*(1-o),i[n+2]=(.272*a+.534*s+.131*l)*o+l*(1-o)}return e};var a=s;function s(e){this.adjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.tempAdjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.adjustmentValue="",this.isBrightnessAdjusted=!1,this.bevelFilter="none",this.tempAdjVal={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.tempFilVal="",this.parent=e,this.addEventListener()}l.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},l.prototype.addEventListener=function(){this.parent.on("freehand-draw",this.draw,this),this.parent.on("destroyed",this.destroy,this)},l.prototype.removeEventListener=function(){this.parent.off("freehand-draw",this.draw),this.parent.off("destroyed",this.destroy)},l.prototype.draw=function(e){switch(this.updateFhdPvtVar(),e.prop){case"hoverFhd":this.hoverFhd(e.value.strokeColor,e.value.strokeWidth);break;case"freehandDownHandler":this.freehandDownHandler(e.value.e,e.value.canvas);break;case"freehandUpHandler":this.freehandUpHandler(e.value.e,e.value.canvas,e.value.context);break;case"handle-freehand-draw":var t=parseInt(e.value.id.split("_")[1],10)-1;this.isFHDIdx(t)&&this.deleteFhd(t,!0);break;case"freehandRedraw":this.freehandRedraw(e.value.context,e.value.points);break;case"deleteFhd":t=parseInt(e.value.id.split("_")[1],10)-1;this.deleteFhd(t,!0);break;case"selectFhd":t=null;e.value.id&&(t=parseInt(e.value.id.split("_")[1],10)-1),this.selectFhd(t);break;case"applyFhd":this.applyFhd();break;case"cancelFhd":this.cancelFhd();break;case"updateFHDCurPts":this.updateFHDCurPts();break;case"rotateFhdColl":this.rotateFhdColl();break;case"flipFHDColl":this.flipFHDColl(e.value.value);break;case"panFHDColl":this.panFHDColl(e.value.xDiff,e.value.yDiff,e.value.panRegion);break;case"updateFHDColl":e.value&&e.value.isPreventApply?this.updateFHDColl(e.value.isPreventApply):this.updateFHDColl();break;case"zoomFHDColl":this.zoomFHDColl(e.value.isPreventApply);break;case"apply-pen-draw":this.applyPenDraw();break;case"freeHandDraw":this.freeHandDraw(e.value.value);break;case"isFHDIdx":this.isFHDIdx(e.value.index,e.value.obj);break;case"getSqPtFD":this.getSqPtFD(e.value.idx,e.value.obj);break;case"getSelPointColl":e.value.obj.selPointColl=T.extend([],this.selPointColl);break;case"setSelPointColl":this.selPointColl=T.extend([],e.value.obj.selPointColl);break;case"pushSelPointColl":this.selPointColl.push(T.extend([],e.value.obj.selPointColl));break;case"setFreehandDrawHoveredIndex":this.fhdHovIdx=e.value.index;break;case"getFreehandDrawHoveredIndex":e.value.obj.index=this.fhdHovIdx;break;case"setPointCounter":this.pointCounter=e.value.value;break;case"getPenStrokeWidth":e.value.obj.penStrokeWidth=this.penStrokeWidth;break;case"setPenStrokeWidth":this.penStrokeWidth=e.value.value;break;case"getCurrentFreehandDrawIndex":e.value.obj.currentFreehandDrawIndex=this.currFHDIdx;break;case"setCurrentFreehandDrawIndex":this.currFHDIdx=e.value.value;break;case"updateCropPtsForSel":this.updateCropPtsForSel();break;case"getFreehandDrawSelectedId":e.value.obj.freehandDrawSelectedId=this.fhdSelID;break;case"resetFreehandDrawSelectedId":this.fhdSelID=null;break;case"getTempFreeHandDrawEditingStyles":e.value.obj.tempFreeHandDrawEditingStyles=this.tempFHDStyles;break;case"setFreehandSelectedIndex":this.fhdSelIdx=e.value.index;break;case"getFreehandSelectedIndex":e.value.obj.freehandSelectedIndex=this.fhdSelIdx;break;case"setCenterSelPoints":this.setCenterSelPoints();break;case"getStraightenPoint":e.value.obj.straightenPoint=T.extend({},this.straightenPoint,{},!0);break;case"setStraightenPoint":this.straightenPoint.x=e.value.x,this.straightenPoint.y=e.value.y,e.value.ratioX&&e.value.ratioY&&(this.straightenPoint.ratioX=e.value.ratioX,this.straightenPoint.ratioY=e.value.ratioY);break;case"resetStraightenPoint":this.straightenPoint={x:null,y:null,ratioX:null,ratioY:null},this.prevStraightenObj=null,this.straightenPointAngle=0;break;case"getStraightenPointAngle":e.value.obj.angle=this.straightenPointAngle;break;case"reset":this.reset();break;case"triggerShapeChanging":this.triggerShapeChanging(e.value.shapeChangingArgs);break;case"setMasking":this.isMasking=e.value.value;break;case"resetSelPoints":this.selPoints=[]}},l.prototype.updateFhdPvtVar=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d"))},l.prototype.reset=function(){this.fhdObj={lastWidth:0,lastVelocity:0,time:0,pointX:0,pointY:0},this.isFreehandDrawing=this.isFreehandPointMoved=!1,this.selPoints=[],this.dummyPoints=[],this.freehandDownPoint={x:0,y:0},this.selPointColl={},this.straightenPointAngle=0,this.fhdHovIdx=null,this.pointCounter=0,this.fhdSelID=null,this.isMasking=!1,this.penStrokeWidth=void 0,this.currFHDIdx=0,this.fhdSelIdx=null,this.tempFHDStyles={strokeColor:null,fillColor:null,strokeWidth:null},this.straightenPoint={x:null,y:null,ratioX:null,ratioY:null},this.prevStraightenObj=null},l.prototype.getModuleName=function(){return"freehand-draw"},l.prototype.hoverFhd=function(e,t){var o,i,r,n,a,s,l=this.parent,p=this.upperContext,h=-1,h=-1<this.fhdHovIdx?this.fhdHovIdx:this.fhdSelIdx,d=(l.points=T.extend([],l.pointColl[h].points),this.pointCounter=0,l.points.length);p.fillStyle=e||l.pointColl[h].strokeColor,p.strokeStyle=p.fillStyle,a=s=this.penStrokeWidth=t||l.pointColl[h].strokeWidth,1===d&&(o=i=r=n=l.points[0],this.startDraw(p,o,i,r,n,a,s));for(var c=0;c<d-3;c++)l.points[c+1]&&l.points[c+2]&&l.points[c+2]&&(o=this.calcCurveCP(l.points[c+0],l.points[c+1],l.points[c+2]).controlPoint2,i=this.calcCurveCP(l.points[c+1],l.points[c+2],l.points[c+3]).controlPoint1,r=0===c?l.points[c]:l.points[c+1],n=l.points[c+2],this.startDraw(p,o,i,r,n,a,s));p.closePath();e=this.getSqPtFD(h),t=p.lineWidth;p.lineWidth=2,p.strokeStyle=l.themeColl[l.theme].primaryColor,p.beginPath(),p.rect(e.startX,e.startY,e.width,e.height),p.stroke(),p.closePath(),p.lineWidth=t},l.prototype.freehandDownHandler=function(e,t){var o=this.parent,e=(o.lowerCanvas=document.querySelector("#"+o.element.id+"_lowerCanvas"),this.lowerContext=o.lowerCanvas.getContext("2d"),o.upperCanvas=document.querySelector("#"+o.element.id+"_upperCanvas"),this.upperContext=o.upperCanvas.getContext("2d"),this.fhdObj.time=(new Date).getTime(),this.isFreehandDrawing=!0,"mousedown"===e.type?this.freehandDownPoint={x:e.clientX,y:e.clientY}:this.freehandDownPoint={x:e.touches[0].clientX,y:e.touches[0].clientY},this.isFreehandPointMoved=!1,T.EventHandler.add(t,"mousemove touchmove",this.freehandMoveHandler,this),{id:"pen_"+(this.currFHDIdx+1),type:m.ShapeType.FreehandDraw,startX:this.freehandDownPoint.x,startY:this.freehandDownPoint.y,strokeColor:o.activeObj.strokeSettings.strokeColor,strokeWidth:this.penStrokeWidth,points:null,index:o.objColl.length+o.freehandCounter+1});this.triggerShapeChanging({cancel:!1,action:"draw-start",previousShapeSettings:e,currentShapeSettings:e})},l.prototype.freehandUpHandler=function(e,t,o){var i=t.getBoundingClientRect(),r=this.parent,t=(T.EventHandler.remove(t,"mousemove touchmove",this.freehandMoveHandler),0===r.points.length&&("mouseup"===e.type?this.processPoint(e.clientX-i.left,e.clientY-i.top,!0,o):"touchend"===e.type&&e.changedTouches?this.processPoint(e.changedTouches[0].clientX-i.left,e.changedTouches[0].clientY-i.top,!0,o):this.isFreehandPointMoved||this.processPoint(this.freehandDownPoint.x-i.left,this.freehandDownPoint.y-i.top,!0,o)),o.closePath(),T.extend({},r.cropObj,{},!0)),e={currObj:{}},i=(r.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:e}}),e.currObj),o=(i.objColl=T.extend([],r.objColl,[],!0),i.pointColl=T.extend([],r.pointColl,[],!0),i.afterCropActions=T.extend([],r.afterCropActions,[],!0),{selPointColl:null}),e=(r.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:o}}),i.selPointColl=T.extend([],o.selPointColl,[],!0),r.freehandCounter),o=r.objColl.length+r.freehandCounter+1,e=(r.pointColl[e]={points:T.extend([],r.points),strokeColor:r.activeObj.strokeSettings.strokeColor,strokeWidth:this.penStrokeWidth,flipState:r.transform.currFlipState,id:"pen_"+(this.currFHDIdx+1),order:o},r.points=[],this.dummyPoints=[],this.selPointColl[e]={points:T.extend([],this.selPoints)},this.selPoints=[],this.pointCounter=0,r.freehandCounter++,this.isFreehandDrawing=!1,r.isMaskImage||r.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"freehand-draw",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),{id:"pen_"+(this.currFHDIdx+1),type:m.ShapeType.FreehandDraw,startX:this.freehandDownPoint.x,startY:this.freehandDownPoint.y,strokeColor:r.activeObj.strokeSettings.strokeColor,strokeWidth:this.penStrokeWidth,points:r.pointColl[this.currFHDIdx].points,index:o});this.triggerShapeChanging({cancel:!1,action:"draw-end",previousShapeSettings:e,currentShapeSettings:e}),this.currFHDIdx++},l.prototype.freehandMoveHandler=function(e){this.isFreehandPointMoved=!0;var t,o=this.parent.upperCanvas.getBoundingClientRect(),e="mousemove"===e.type?(t=e.clientX-o.left,e.clientY-o.top):(t=e.touches[0].clientX-o.left,e.touches[0].clientY-o.top);this.isFreehandDrawing&&(this.upperContext.fillStyle=this.parent.activeObj.strokeSettings.strokeColor,this.parent.isMaskImage&&(this.upperContext.globalCompositeOperation="xor"),this.processPoint(t,e,!1,this.upperContext))},l.prototype.processPoint=function(e,t,o,i){var r,n,a,s,l,p,h,d=this.parent,c=(this.point(e,t,(new Date).getTime()),!!(r=0<d.points.length&&d.points[d.points.length-1])&&this.distanceTo(r)<=5);this.selPoints.push({x:e,y:t,ratioX:(e-d.img.destLeft)/d.img.destWidth,ratioY:(t-d.img.destTop)/d.img.destHeight,time:this.fhdObj.time}),r&&c&&!o||(this.fhdObj.time=(new Date).getTime(),d.points.push({x:e,y:t,ratioX:(e-d.img.destLeft)/d.img.destWidth,ratioY:(t-d.img.destTop)/d.img.destHeight,time:this.fhdObj.time}),this.dummyPoints.push({x:e,y:t,ratioX:(e-d.img.destLeft)/d.img.destWidth,ratioY:(t-d.img.destTop)/d.img.destHeight,time:this.fhdObj.time}),2<this.dummyPoints.length&&(3===this.dummyPoints.length&&this.dummyPoints.unshift(this.dummyPoints[0]),r=this.dummyPoints[0],c=this.dummyPoints[1],d=this.dummyPoints[2],a=this.dummyPoints[3],n=this.calcCurveCP(r,c,d).controlPoint2,a=this.calcCurveCP(c,d,a).controlPoint1,s=this.dummyPoints[1],l=this.dummyPoints[2],p=.5,h=5,T.isNullOrUndefined(this.penStrokeWidth)||(p=h=this.penStrokeWidth),this.startDraw(i,n,a,s,l,p,h),this.pointCounter++,this.dummyPoints.shift()),o&&(n=a=s=l={x:e,y:t,time:(new Date).getTime()},p=.5,h=5,T.isNullOrUndefined(this.penStrokeWidth)||(p=h=this.penStrokeWidth),this.startDraw(i,n,a,s,l,p,h)))},l.prototype.calcCurveCP=function(e,t,o){var i=e.x-(t=t||e).x,r=e.y-t.y,n=t.x-(o=o||t).x,a=t.y-o.y,s=(e.x+t.x)/2,e=(e.y+t.y)/2,l=(t.x+o.x)/2,o=(t.y+o.y)/2,i=Math.sqrt(i*i+r*r),r=Math.sqrt(n*n+a*a),n=r/(i+r),a=l+(s-l)*n,i=o+(e-o)*n,r=t.x-a,n=t.y-i;return{controlPoint1:this.point(s+r,e+n,0),controlPoint2:this.point(l+r,o+n,0)}},l.prototype.point=function(e,t,o){return this.fhdObj.pointX=e,this.fhdObj.pointY=t,{x:this.fhdObj.pointX,y:this.fhdObj.pointY,time:o}},l.prototype.startDraw=function(e,t,o,i,r,n,a){var s=this.pointVelocity(i),n=(s=.7*s+(1-.7)*this.fhdObj.lastVelocity,Math.max(a/1.7,n));this.drawCurve(this.fhdObj.time,n,e,t,o,i,r,a),this.fhdObj.lastVelocity=s,this.fhdObj.time=n},l.prototype.pointVelocity=function(e){return this.fhdObj.time!==e.time?this.distanceTo(e)/(this.fhdObj.time-e.time):0},l.prototype.distanceTo=function(e){return Math.sqrt(Math.pow(this.fhdObj.pointX-e.x,2)+Math.pow(this.fhdObj.pointY-e.y,2))},l.prototype.drawCurve=function(e,t,o,i,r,n,a,s){var l,p,h,d,c,u,g,v,f=t-e,t=this.bezierLength(i,r,n,a),C=2*Math.ceil(t);for(o.beginPath(),l=0;l<C;l++)g=(v=(u=(c=1-(p=l/C))*c)*c)*n.x,g=(g=(g+=3*u*p*i.x)+3*c*(h=p*p)*r.x)+(d=h*p)*a.x,v=v*n.y,v=(v=(v+=3*u*p*i.y)+3*c*h*r.y)+d*a.y,u=Math.min(e+d*f,s),this.drawArc(g,v,u,o);o.closePath(),o.fill()},l.prototype.bezierLength=function(e,t,o,i){for(var r,n,a,s,l,p,h=0,d=0;d<=10;d++)r=this.bezierPoint(n=d/10,o.x,e.x,t.x,i.x),n=this.bezierPoint(n,o.y,e.y,t.y,i.y),0<d&&(l=r-a,p=n-s,h+=Math.sqrt(l*l+p*p)),a=r,s=n;return h},l.prototype.bezierPoint=function(e,t,o,i,r){return t*(1-e)*(1-e)*(1-e)+3*o*(1-e)*(1-e)*e+3*i*(1-e)*e*e+r*e*e*e},l.prototype.drawArc=function(e,t,o,i){var r=this.parent.img;(e>r.destLeft&&t>r.destTop&&e<r.destLeft+r.destWidth&&t<r.destTop+r.destHeight||i!==this.lowerContext&&i!==this.upperContext)&&(i.moveTo(e,t),i.arc(e,t,o,0,2*Math.PI,!1))},l.prototype.freehandRedraw=function(e,t){var o=this.parent,i=e.filter;if(e.filter="none",t&&(o.pointColl[o.freehandCounter]={points:t,strokeColor:o.activeObj.strokeSettings.strokeColor,strokeWidth:this.penStrokeWidth,flipState:o.transform.currFlipState,id:"pen_"+(o.freehandCounter+1),order:o.objColl.length+o.freehandCounter+1},this.selPointColl[o.freehandCounter]=T.extend({},o.pointColl[o.freehandCounter],{},!0),o.freehandCounter++),0<o.freehandCounter){for(var r=0;r<o.freehandCounter;r++){o.points=T.extend([],o.pointColl[r].points),this.pointCounter=0;var n=o.points.length,a=void 0,s=void 0,l=void 0,p=void 0,h=void 0,d=void 0;0<n&&(e.fillStyle=o.pointColl[r].strokeColor,h=d=this.penStrokeWidth=o.pointColl[r].strokeWidth),1===n&&(a=s=l=p=o.points[0],this.startDraw(e,a,s,l,p,h,d));for(var c=0;c<n-3;c++)o.points[c+1]&&o.points[c+2]&&o.points[c+2]&&(a=this.calcCurveCP(o.points[c+0],o.points[c+1],o.points[c+2]).controlPoint2,s=this.calcCurveCP(o.points[c+1],o.points[c+2],o.points[c+3]).controlPoint1,l=0===c?o.points[c]:o.points[c+1],p=o.points[c+2],this.startDraw(e,a,s,l,p,h,d));e.closePath()}e===this.lowerContext&&(o.notify("draw",{prop:"applyFrame",value:{ctx:this.lowerContext,frame:o.frameObj.type,preventImg:!0}}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height))}e.filter=i},l.prototype.getSqPtFD=function(e,t){for(var o={startX:0,startY:0,endX:0,endY:0,width:0,height:0},i=T.extend([],this.selPointColl[e].points,[]),r=(this.parent.points=T.extend([],this.parent.pointColl[e].points),this.pointCounter=0,i.length),n=0;n<r;n++)0===o.startX&&0===o.startY&&0===o.endX&&0===o.endY?(o.startX=i[n].x,o.startY=i[n].y,o.endX=i[n].x,o.endY=i[n].y):(o.startX=Math.min(o.startX,i[n].x),o.startY=Math.min(o.startY,i[n].y),o.endX=Math.max(o.endX,i[n].x),o.endY=Math.max(o.endY,i[n].y));return o.startX-=this.penStrokeWidth,o.startY-=this.penStrokeWidth,o.endX+=this.penStrokeWidth,o.endY+=this.penStrokeWidth,o.width=o.endX-o.startX,o.height=o.endY-o.startY,t&&(t.activePoint=o),o},l.prototype.applyPenDraw=function(){var e=this.parent;"freehanddraw"===e.currObjType.shape&&(e.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}}),e.upperCanvas.style.cursor=e.cursor="default",e.currObjType.shape=""),e.notify("shape",{prop:"clearActObj"})},l.prototype.applyFhd=function(){var e=this.parent,t=e.pointColl[this.fhdSelIdx];"#42a5f5"===t.strokeColor&&(t.strokeColor=this.tempFHDStyles.strokeColor),e.notify("toolbar",{prop:"setSelectedFreehandColor",value:{color:"#42a5f5"}}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),t&&(t.isSelected=!1),e.notify("selection",{prop:"resetFreehandDrawVariables"}),this.fhdHovIdx=this.fhdSelIdx=null},l.prototype.cancelFhd=function(){var e=this.parent,t=e.pointColl[this.fhdSelIdx];e.notify("toolbar",{prop:"setSelectedFreehandColor",value:{color:"#42a5f5"}}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.lowerContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.pointCounter=0,t&&(t.strokeColor=this.tempFHDStyles.strokeColor,t.strokeWidth=this.tempFHDStyles.strokeWidth,t.isSelected=!1),this.fhdHovIdx=this.fhdSelIdx=this.fhdSelID=null,e.notify("selection",{prop:"resetFreehandDrawVariables"}),e.activeObj.strokeSettings.strokeColor=this.tempFHDStyles.strokeColor,e.activeObj.strokeSettings.strokeWidth=this.penStrokeWidth=this.tempFHDStyles.strokeWidth,this.tempFHDStyles={strokeColor:null,strokeWidth:null,fillColor:null},e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})},l.prototype.selectFhd=function(e){var t=this.parent,o=T.extend({},this.tempFHDStyles,{},!0);if(t.notify("selection",{prop:"setFreehandDrawEditing",onPropertyChange:!1,value:{bool:!0}}),e||0===e){if(!this.isFHDIdx(e))return;this.fhdSelIdx=this.fhdHovIdx=e,this.hoverFhd(),t.upperCanvas.style.cursor=t.cursor="pointer"}this.fhdSelIdx=this.fhdHovIdx;var e=t.pointColl[this.fhdSelIdx],i=(e.isSelected=!0,this.fhdSelID=e.id,"#42a5f5"!==e.strokeColor&&(t.activeObj.strokeSettings.strokeColor=this.tempFHDStyles.strokeColor=e.strokeColor),t.activeObj.strokeSettings.strokeWidth=this.tempFHDStyles.strokeWidth=t.pointColl[this.fhdHovIdx].strokeWidth,{bool:!1});t.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:i}}),i.bool?(i={id:"pen_"+(this.fhdSelIdx+1),type:m.ShapeType.FreehandDraw,startX:e.points[0].x,startY:e.points[0].y,strokeColor:e.strokeColor,strokeWidth:e.strokeWidth,points:e.points,opacity:e.opacity,index:e.order},this.triggerShapeChanging({cancel:!1,action:"select",previousShapeSettings:i,currentShapeSettings:i})):t.okBtn(null,!0),t.isUndoRedoStack&&(this.tempFHDStyles=o)},l.prototype.deleteFhd=function(e,t){var o=this.parent;if(this.isFHDIdx(e)){this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height);for(var i=T.extend({},o.pointColl,{},!0),r=T.extend({},this.selPointColl,{},!0),n=(o.pointColl={},this.selPointColl={},0),a=0;a<o.freehandCounter;a++)parseInt(i[a].id.split("_")[1],10)-1!==e&&(o.pointColl[n]=i[a],this.selPointColl[n]=r[a],n++);--o.freehandCounter,this.fhdHovIdx=this.fhdSelIdx=null,o.notify("selection",{prop:"resetFreehandDrawVariables"}),o.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),o.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})}},l.prototype.zoomX=function(e){return e*this.parent.img.destWidth+this.parent.img.destLeft},l.prototype.zoomY=function(e){return e*this.parent.img.destHeight+this.parent.img.destTop},l.prototype.zoomFHDColl=function(e){var t=this.parent,o={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};t.notify("shape",{prop:"straightenShapes",onPropertyChange:!1});for(var i=0;i<t.freehandCounter;i++){t.points=T.extend([],t.pointColl[i].points,[]),this.pointCounter=0;for(var r=t.points.length,n=0;n<r;n++){var a=t.points[n];a.x=this.zoomX(a.ratioX),a.y=this.zoomY(a.ratioY)}}this.updateFHDCurPts(),this.straightenPoint.x&&this.straightenPoint.y&&(this.straightenPoint.x=this.zoomX(this.straightenPoint.ratioX),this.straightenPoint.y=this.zoomY(this.straightenPoint.ratioY)),0!==t.transform.straighten&&t.notify("shape",{prop:"straightenFHD",onPropertyChange:!1}),t.img.destLeft=o.startX,t.img.destTop=o.startY,t.img.destWidth=o.width,t.img.destHeight=o.height,T.isNullOrUndefined(e)&&this.freehandRedraw(this.lowerContext,null)},l.prototype.updateFHDCurPts=function(){for(var e=this.parent,t=0;t<e.freehandCounter;t++)if(this.selPointColl[t]){this.selPoints=T.extend([],this.selPointColl[t].points,[]),this.pointCounter=0;for(var o=this.selPoints.length,i=0;i<o;i++){var r=this.selPoints[i];r.x=this.zoomX(r.ratioX),r.y=this.zoomY(r.ratioY)}}},l.prototype.rotateFhdColl=function(){for(var e=this.parent,t=e.img,o=t.destLeft,i=t.destTop,r=t.destWidth,n=t.destHeight,a=0;a<e.freehandCounter;a++){e.points=T.extend([],e.pointColl[a].points,[]),this.pointCounter=0;for(var s=e.points.length,l=0;l<s;l++)(p=e.points[l]).y=i+n*p.ratioX,p.x=o+r-r*p.ratioY,p.ratioX=(p.x-o)/r,p.ratioY=(p.y-i)/n}for(a=0;a<e.freehandCounter;a++)if(this.selPointColl[a]){this.selPoints=T.extend([],this.selPointColl[a].points,[]),this.pointCounter=0;for(var p,s=this.selPoints.length,l=0;l<s;l++)(p=this.selPoints[l]).y=i+n*p.ratioX,p.x=o+r-r*p.ratioY,p.ratioX=(p.x-o)/r,p.ratioY=(p.y-i)/n}this.updateFHDCurPts()},l.prototype.flipFHDColl=function(e){e=e.toLowerCase();if("horizontal"===e)this.pointsHorizontalFlip();else{if("vertical"!==e){this.pointsHorizontalFlip();for(var t=0;t<this.parent.freehandCounter;t++)this.parent.pointColl[t].shapeFlip=""}this.pointsVerticalFlip()}},l.prototype.pointsHorizontalFlip=function(){for(var e=this.parent,t=e.img,o=t.destLeft,i=t.destTop,r=t.destWidth,n=t.destHeight,a=0;a<e.freehandCounter;a++)if(e.pointColl[a].shapeFlip!==e.transform.currFlipState){e.points=T.extend([],e.pointColl[a].points,[]),this.pointCounter=0;for(var s=e.points.length,l=0;l<s;l++)(p=e.points[l]).x<=o+r/2?p.x=o+r-(p.x-o):p.x>=o+r/2&&(p.x=o+(o+r-p.x)),p.ratioX=(p.x-o)/r,p.ratioY=(p.y-i)/n;e.pointColl[a].shapeFlip=e.transform.currFlipState}for(a=0;a<e.freehandCounter;a++)if(this.selPointColl[a]&&this.selPointColl[a].shapeFlip!==e.transform.currFlipState){this.selPoints=T.extend([],this.selPointColl[a].points,[]),this.pointCounter=0;for(var p,s=this.selPoints.length,l=0;l<s;l++)(p=this.selPoints[l]).x<=o+r/2?p.x=o+r-(p.x-o):p.x>=o+r/2&&(p.x=o+(o+r-p.x)),p.ratioX=(p.x-o)/r,p.ratioY=(p.y-i)/n}this.updateFHDCurPts()},l.prototype.pointsVerticalFlip=function(){for(var e=this.parent,t=e.img,o=t.destLeft,i=t.destTop,r=t.destWidth,n=t.destHeight,a=0;a<e.freehandCounter;a++)if(e.pointColl[a].shapeFlip!==e.transform.currFlipState){e.points=T.extend([],e.pointColl[a].points,[]),this.pointCounter=0;for(var s=e.points.length,l=0;l<s;l++)(p=e.points[l]).y<=i+n/2?p.y=i+n-(p.y-i):p.y>=i+n/2&&(p.y=i+(i+n-p.y)),p.ratioX=(p.x-o)/r,p.ratioY=(p.y-i)/n;e.pointColl[a].shapeFlip=e.transform.currFlipState}for(a=0;a<e.freehandCounter;a++)if(this.selPointColl[a]&&this.selPointColl[a].shapeFlip!==e.transform.currFlipState){this.selPoints=T.extend([],this.selPointColl[a].points,[]),this.pointCounter=0;for(var p,s=this.selPoints.length,l=0;l<s;l++)(p=this.selPoints[l]).y<=i+n/2?p.y=i+n-(p.y-i):p.y>=i+n/2&&(p.y=i+(i+n-p.y)),p.ratioX=(p.x-o)/r,p.ratioY=(p.y-i)/n}this.updateFHDCurPts()},l.prototype.updateFHDColl=function(e){for(var t=this.parent,o={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight},i=(t.notify("shape",{prop:"straightenShapes",onPropertyChange:!1}),t.img),r=i.destLeft,n=i.destTop,a=i.destWidth,s=i.destHeight,l=0,p=t.objColl.length;l<p;l++){var h,d=t.objColl[l];if("line"===d.shape||"arrow"===d.shape?t.notify("shape",{prop:"straightenShapePoints",value:{obj:d,isReverse:!0}}):"path"===d.shape&&(h=t.transform.straighten,t.transform.straighten=-t.transform.straighten,t.notify("shape",{prop:"straightenPath",onPropertyChange:!1,value:{obj:d}}),t.transform.straighten=h),d.imageRatio={startX:(d.activePoint.startX-r)/a,startY:(d.activePoint.startY-n)/s,endX:(d.activePoint.endX-r)/a,endY:(d.activePoint.endY-n)/s,width:a/d.activePoint.width,height:s/d.activePoint.height},"path"===d.shape)for(var c=0,u=d.pointColl.length;c<u;c++)d.pointColl[c].ratioX=(d.pointColl[c].x-r)/a,d.pointColl[c].ratioY=(d.pointColl[c].y-n)/s;t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1})}0<t.freehandCounter&&0!==t.transform.straighten&&(h=t.transform.straighten,t.transform.straighten=-t.transform.straighten,t.notify("shape",{prop:"straightenFHD",onPropertyChange:!1}),t.transform.straighten=h);for(var g=0;g<t.freehandCounter;g++){t.points=T.extend([],t.pointColl[g].points,[]),this.pointCounter=0;for(var v=t.points.length,f=0;f<v;f++)(C=t.points[f]).ratioX=(C.x-r)/a,C.ratioY=(C.y-n)/s}for(g=0;g<t.freehandCounter;g++)if(this.selPointColl[g]){this.selPoints=T.extend([],this.selPointColl[g].points,[]),this.pointCounter=0;for(var C,v=this.selPoints.length,f=0;f<v;f++)(C=this.selPoints[f]).ratioX=(C.x-r)/a,C.ratioY=(C.y-n)/s}this.straightenPoint.x&&this.straightenPoint.y&&(this.straightenPoint.ratioX=(this.straightenPoint.x-r)/a,this.straightenPoint.ratioY=(this.straightenPoint.y-n)/s),t.img.destLeft=o.startX,t.img.destTop=o.startY,t.img.destWidth=o.width,t.img.destHeight=o.height,t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:e}})},l.prototype.panFHDColl=function(e,t,o){for(var i=this.parent,r=0;r<i.freehandCounter;r++){i.points=T.extend([],i.pointColl[r].points,[]),this.pointCounter=0;for(var n=i.points.length,a=0;a<n;a++){var s=i.points[a];""===o||"vertical"===o?s.x+=e:s.x-=e,""===o||"horizontal"===o?s.y+=t:s.y-=t}}for(r=0;r<i.freehandCounter;r++)if(this.selPointColl[r]){this.selPoints=T.extend([],this.selPointColl[r].points,[]),this.pointCounter=0;for(n=this.selPoints.length,a=0;a<n;a++){s=this.selPoints[a];""===o||"vertical"===o?s.x+=e:s.x-=e,""===o||"horizontal"===o?s.y+=t:s.y-=t}}this.straightenPoint.x&&this.straightenPoint.y&&(""===o||"vertical"===o?this.straightenPoint.x+=e:this.straightenPoint.x-=e,""===o||"horizontal"===o?this.straightenPoint.y+=t:this.straightenPoint.y-=t),this.freehandRedraw(this.lowerContext,null)},l.prototype.freeHandDraw=function(e){var t=this.parent;e?(t.points=[],this.dummyPoints=[],t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.togglePen=!0,t.upperCanvas.style.cursor=t.cursor="crosshair",t.upperCanvas.style.display="block",T.isNullOrUndefined(t.activeObj.strokeSettings)&&(t.notify("shape",{prop:"getStrokeSettings",onPropertyChange:!(e={strokeSettings:{}}),value:{obj:e}}),t.activeObj.strokeSettings=e.strokeSettings),T.isNullOrUndefined(t.activeObj.strokeSettings.strokeWidth)&&(t.activeObj.strokeSettings.strokeWidth=2),t.isMaskImage?t.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}):t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"pen",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})):(t.upperCanvas.style.cursor=t.cursor="default",e=this.penStrokeWidth,t.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}}),t.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),t.notify("toolbar",{prop:"setCurrentToolbar",value:{type:"main"}}),t.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!1}}),this.penStrokeWidth=e)},l.prototype.isFHDIdx=function(e,t){for(var o=!1,i=0;i<this.parent.freehandCounter;i++)if(this.parent.pointColl[i].id&&parseInt(this.parent.pointColl[i].id.split("_")[1],10)-1===e){o=!0;break}return t&&(t.isIndex=o),o},l.prototype.updateCropPtsForSel=function(){for(var e=this.parent,t=e.activeObj.activePoint,o=0;o<e.freehandCounter;o++){var i={selPointColl:T.extend([],this.selPointColl)};if(i.selPointColl[o]){this.selPoints=T.extend([],i.selPointColl[o].points,[]),this.pointCounter=0;for(var r=this.selPoints.length,n=0;n<r;n++){var a=this.selPoints[n];a.ratioX=(a.x-t.startX)/t.width,a.ratioY=(a.y-t.startY)/t.height}}}},l.prototype.triggerShapeChanging=function(e){var t,o=this.parent,i=o.pointColl[this.fhdSelIdx];o.trigger("shapeChanging",e),"mask-drawing"!==o.element.getAttribute("data-value")||this.isMasking?(-1!==(o.editCompleteArgs=e).currentShapeSettings.id.indexOf("pen_")||"draw-end"!==e.action&&"select"!==e.action||(t="pen_"+e.currentShapeSettings.id,this.fhdSelIdx?o.pointColl[this.fhdSelIdx].id=t:o.pointColl[o.freehandCounter-1].id=t),this.penStrokeWidth=e.currentShapeSettings.strokeWidth,o.activeObj.strokeSettings.strokeColor!==e.currentShapeSettings.strokeColor&&(o.activeObj.strokeSettings.strokeColor=e.currentShapeSettings.strokeColor,o.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1})),this.fhdSelID&&i&&e.currentShapeSettings&&(i.strokeColor=e.currentShapeSettings.strokeColor,i.strokeWidth=e.currentShapeSettings.strokeWidth,i.points=e.currentShapeSettings.points,i.opacity=e.currentShapeSettings.opacity),"select"===e.action&&(this.freehandRedraw(this.upperContext),o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"pen",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}))):(this.isMasking=!0,o.upperCanvas.style.cursor="crosshair",o.notify("draw",{prop:"updateTempObjColl"}),o.notify("draw",{prop:"updateTempPointColl"}),o.discard(),o.selectMaskImage())},l.prototype.setCenterSelPoints=function(){var e=this.parent,t={startX:e.img.destLeft,startY:e.img.destTop,width:e.img.destWidth,height:e.img.destHeight},o=(e.notify("shape",{prop:"straightenShapes",onPropertyChange:!1}),e.img),i=o.destLeft,r=o.destTop,n=o.destWidth,o=o.destHeight,a=e.activeObj.activePoint;!T.isNullOrUndefined(this.prevStraightenObj)&&JSON.stringify(this.prevStraightenObj.activePoint)===JSON.stringify(a)||(this.straightenPoint={x:a.startX+a.width/2,y:a.startY+a.height/2,ratioX:(a.startX+a.width/2-i)/n,ratioY:(a.startY+a.height/2-r)/o},this.prevStraightenObj=T.extend({},e.activeObj,{},!0),this.straightenPointAngle=e.transform.straighten),e.img.destLeft=t.startX,e.img.destTop=t.startY,e.img.destWidth=t.width,e.img.destHeight=t.height};var B=l;function l(e){this.fhdObj={lastWidth:0,lastVelocity:0,time:0,pointX:0,pointY:0},this.isFreehandDrawing=!1,this.freehandDownPoint={x:0,y:0},this.isFreehandPointMoved=!1,this.pointCounter=0,this.selPointColl={},this.currFHDIdx=0,this.selPoints=[],this.dummyPoints=[],this.tempFHDStyles={strokeColor:null,fillColor:null,strokeWidth:null},this.straightenPoint={x:null,y:null,ratioX:null,ratioY:null},this.straightenPointAngle=0,this.isMasking=!1,this.parent=e,this.addEventListener()}p.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},p.prototype.addEventListener=function(){this.parent.on("selection",this.selection,this),this.parent.on("destroyed",this.destroy,this)},p.prototype.removeEventListener=function(){this.parent.off("selection",this.selection),this.parent.off("destroyed",this.destroy)},p.prototype.selection=function(e){var t=this.parent;switch(this.updatePrivateVariables(),e.prop){case"setCursor":this.setCursor(e.value.x,e.value.y);break;case"updateActivePoint":this.updateActivePoint(e.value.x,e.value.y,e.value.isCropSelection);break;case"updateCursorStyles":this.updateCursorStyles(e.value.x,e.value.y,e.value.type);break;case"setTextSelection":this.setTextSelection(e.value.width,e.value.height);break;case"setActivePoint":this.setActivePoint(e.value.startX,e.value.startY);break;case"clearSelection":this.clearSelection(e.value.resetCrop);break;case"calcShapeRatio":this.calcShapeRatio(e.value.x,e.value.y,e.value.imgWidth,e.value.imgHeight);break;case"tab":this.performTabAction();break;case"setDragDirection":this.setDragDirection(e.value.width,e.value.height);break;case"clearUpperCanvas":this.isTouch&&setTimeout(function(){t.upperCanvas.getContext("2d").clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height)},550);break;case"resetFreehandDrawVariables":this.isFhdEditing=this.isFhdPoint=!1;break;case"isShapeInserted":this.isShapeInserted=e.value.bool;break;case"redrawShape":this.redrawShape(e.value.obj);break;case"setTextBoxStylesToActObj":this.setTextBoxStylesToActObj();break;case"mouseDownEventHandler":this.mouseDownEventHandler(e.value.e);break;case"mouseMoveEventHandler":this.mouseMoveEventHandler(e.value.e);break;case"mouseUpEventHandler":this.mouseUpEventHandler(e.value.e);break;case"canvasMouseDownHandler":this.canvasMouseDownHandler(e.value.e);break;case"canvasMouseMoveHandler":this.canvasMouseMoveHandler(e.value.e);break;case"canvasMouseUpHandler":this.canvasMouseUpHandler(e.value.e);break;case"touchStartHandler":this.touchStartHandler(e.value.e);break;case"keyDownEventHandler":this.keyDownEventHandler(e.value.e);break;case"handleScroll":this.handleScroll(e.value.e);break;case"textKeyDown":setTimeout(this.textKeyDown.bind(this),1,e.value.e);break;case"deleteItem":this.deleteItem();break;case"updatePrevShapeSettings":this.updatePrevShapeSettings(e.value.obj);break;case"getZoomType":e.value.obj.zoomType=this.zoomType;break;case"setZoomType":this.zoomType=e.value.zoomType;break;case"setInitialTextEdit":this.isInitialTextEdited=e.value.bool;break;case"setDragCanvas":this.dragCanvas=e.value.bool;break;case"setFreehandDrawCustomized":this.isFhdCustomized=e.value.isFreehandDrawCustomized;break;case"setTouchEndPoint":this.touchEndPoint.x=e.value.x,this.touchEndPoint.y=e.value.y;break;case"getPanDown":e.value.obj.panDown=this.panDown;break;case"setPanDown":this.panDown=e.value.panDown;break;case"getFreehandDrawEditing":e.value.obj.bool=this.isFhdEditing;break;case"setFreehandDrawEditing":this.isFhdEditing=e.value.bool;break;case"getTempActObj":e.value.obj.tempObj=this.tempActiveObj;break;case"setTempActObj":this.tempActiveObj=e.value.obj;break;case"isInside":this.isInside(e.value.x,e.value.y,e.value.z1,e.value.z2,e.value.z3,e.value.z4);break;case"setDragElement":this.dragElement=e.value.value;break;case"setObjSelected":this.isObjSelected=e.value.bool;break;case"adjustActObjForLineArrow":this.adjustActObjForLineArrow(e.value.obj);break;case"findTarget":this.findTarget(e.value.x,e.value.y,e.value.type);break;case"getCurrentFlipState":this.getCurrentFlipState();break;case"setDragWidth":this.setDragWidth(e.value.width);break;case"setDragHeight":this.setDragHeight(e.value.setDragHeight);break;case"annotate":this.currentDrawingShape=e.value.shape,"text"===e.value.shape?(t.activeObj.textSettings.fontSize=11,t.activeObj.keyHistory="Enter Text",t.notify("shape",{prop:"initializeTextShape",onPropertyChange:!1,value:{text:null,fontFamily:null,fontSize:null,bold:null,italic:null,strokeColor:null}})):"path"===e.value.shape&&(t.activeObj.pointColl=[]);break;case"getCurrentDrawingShape":e.value.obj.shape=this.currentDrawingShape;break;case"setCurrentDrawingShape":this.currentDrawingShape=e.value.value;break;case"getTransRotationPoint":this.getTransRotationPoint(e.value.obj,e.value.object);break;case"adjustNEPoints":this.adjustNEPoints(e.value.rectangle,e.value.x,e.value.y,e.value.angle);break;case"adjustRotationPoints":this.adjustRotationPoints(e.value.rectangle,e.value.x,e.value.y,e.value.angle,e.value.type,e.value.elem);break;case"getResizeDirection":this.getResizeDirection(e.value.rectangle,e.value.x,e.value.y,e.value.angle);break;case"setResizedElement":this.resizedElement=e.value.value;break;case"reset":this.reset();break;case"unWireEvent":this.unwireEvent();break;case"updPtCollForShpRot":this.updPtCollForShpRot(e.value.obj);break;case"findImageRatio":this.findImageRatio(e.value.width,e.value.height,e.value.obj);break;case"getNumTextValue":this.getNumTextValue(e.value.obj);break;case"setImageClarity":this.isImageClarity=e.value.bool;break;case"upgradeImageQuality":this.upgradeImageQuality();break;case"triggerShapeChange":this.triggerShapeChange(e.value.shapeResizingArgs,e.value.shapeMovingArgs,e.value.type);break;case"applyTransformToImg":this.applyTransformToImg(e.value.ctx);break;case"findTargetObj":e.value.obj.bool=this.findTargetObj(e.value.x,e.value.y,e.value.isCrop);break;case"setSliding":this.isSliding=e.value.bool;break;case"setSliderActive":this.isSliderActive=e.value.bool;break;case"getArrowType":e.value.obj.type=this.getArrowType(e.value.type);break;case"setArrowShape":"initial"===e.value.type?this.arrowShape[0]=e.value.shape:this.arrowShape[1]=e.value.shape;break;case"updateNWPoints":this.updateNWPoints(e.value.x,e.value.y);break;case"updateNPoints":this.updateNPoints(e.value.x,e.value.y);break;case"updateNEPoints":this.updateNEPoints(e.value.x,e.value.y);break;case"updateWPoints":this.updateWPoints(e.value.x,e.value.y);break;case"updateEPoints":this.updateEPoints(e.value.x,e.value.y);break;case"updateSWPoints":this.updateSWPoints(e.value.x,e.value.y);break;case"updateSPoints":this.updateSPoints(e.value.x,e.value.y);break;case"updateSEPoints":this.updateSEPoints(e.value.x,e.value.y);break;case"drawMaskCircle":this.drawMaskCircle(e.value.x,e.value.y);break;case"isValueUpdated":this.isValueUpdated();break;case"getDistance":this.getDistance(e.value.x,e.value.y);break;case"redact":this.currentDrawingShape=e.value.shape;break;case"updateTransColl":e.value.obj.coll=this.updateTransColl(e.value.object);break;case"getTransformedShape":e.value.obj.bool=this.isTransformedShape;break;case"setTransformedShape":this.isTransformedShape=e.value.bool;break;case"rgbToHex":this.rgbToHex(e.value.r,e.value.g,e.value.b,e.value.a);break;case"padLeft":this.padLeft(e.value.value,e.value.length,e.value.padChar);break;case"setTimer":this.setTimer(e.value.e);break;case"targetTouches":e.value.output=this.targetTouches(e.value.touches);break;case"calculateScale":e.value.output=this.calculateScale(e.value.startTouches,e.value.endTouches);break;case"beforeSaveEvent":this.beforeSaveEvent(e.value.args,e.value.e);break;case"isKeyBoardCrop":e.value.output=this.isKeyBoardCrop(e.value.e);break;case"focusRatioBtn":this.focusRatioBtn();break;case"performEnterAction":this.performEnterAction(e.value.e);break;case"getImagePoints":e.value.output=this.getImagePoints(e.value.x,e.value.y);break;case"revertPoints":this.revertPoints(e.value.actPoint,e.value.tempActiveObj);break;case"performNWResize":this.performNWResize(e.value.x,e.value.y,e.value.tempActiveObj,e.value.actPoint);break;case"performSEResize":this.performSEResize(e.value.x,e.value.y,e.value.tempActiveObj,e.value.actPoint);break;case"isMouseOutsideImg":e.value.output=this.isMouseOutsideImg(e.value.x,e.value.y)}},p.prototype.getModuleName=function(){return"selection"},p.prototype.updatePrivateVariables=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d"))},p.prototype.reset=function(){this.diffPoint={x:0,y:0},this.oldPoint={},this.isTouch=this.isObjSelected=this.isFhdPoint=this.isShapeInserted=!1,this.dragPoint={startX:0,startY:0,endX:0,endY:0},this.tempActiveObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],order:null},this.isFirstMove=!1,this.cursorTargetId=this.dragElement="",this.isTouchDblClick=!1,this.startTouches=[],this.tempTouches=[],this.currMousePoint={x:0,y:0},this.isPreventDragging=!1,this.timer=void 0,this.tempObjColl=void 0,this.mouseWheel=0,this.textRow=1,this.mouseDownPoint={x:0,y:0},this.previousPoint={x:0,y:0},this.zoomType="Toolbar",this.isInitialTextEdited=!1,this.dragCanvas=this.isPinching=!1,this.isFhdCustomized=!1,this.touchEndPoint={},this.panDown=null,this.isSliding=!1,this.isFhdEditing=!1,this.pathAdjustedIndex=null,this.touchTime=0,this.isImageClarity=!0,this.currentDrawingShape="",this.initialPrevObj={},this.resizedElement="",this.mouseDown="",this.isSliderActive=!1,this.arrowShape=[m.ArrowheadType.None,m.ArrowheadType.SolidArrow],this.isMouseDown=this.isMouseUp=this.isTransformedShape=!1},p.prototype.performTabAction=function(){var e,t=this.parent;"block"!==t.textArea.style.display&&"inline-block"!==t.textArea.style.display||(e=this.applyCurrShape(!1),t.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),e&&t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})),t.isKBDNavigation=!0},p.prototype.selMouseUpEvent=function(){this.oldPoint.x=void 0,this.oldPoint.y=void 0},p.prototype.getMouseCursor=function(e,t,o,i,r){var n=this.getTransRotationPoint(e),a=e.bottomCenterCircle.radius,s=r?0:2*e.topLeftCircle.radius;return t>=e.topLeftCircle.startX-s&&t<=e.topLeftCircle.startX+s&&o>=e.topLeftCircle.startY-s&&o<=e.topLeftCircle.startY+s?"nw-resize":t>=e.topLeftCircle.startX-s&&t<=e.topRightCircle.startX-s&&o>=e.topCenterCircle.startY-s&&o<=e.topCenterCircle.startY+s?"n-resize":t>=e.topRightCircle.startX-s&&t<=e.topRightCircle.startX+s&&o>=e.topRightCircle.startY-s&&o<=e.topRightCircle.startY+s?"ne-resize":t>=e.centerLeftCircle.startX-s&&t<=e.centerLeftCircle.startX+s&&o>=e.topLeftCircle.startY-s&&o<=e.bottomLeftCircle.startY-s?"w-resize":t>=e.centerRightCircle.startX-s&&t<=e.centerRightCircle.startX+s&&o>=e.topRightCircle.startY-s&&o<=e.bottomRightCircle.startY-s?"e-resize":t>=e.bottomLeftCircle.startX-s&&t<=e.bottomLeftCircle.startX+s&&o>=e.bottomLeftCircle.startY-s&&o<=e.bottomLeftCircle.startY+s?"sw-resize":t>=e.bottomLeftCircle.startX-s&&t<=e.bottomRightCircle.startX-s&&o>=e.bottomCenterCircle.startY-s&&o<=e.bottomCenterCircle.startY+s?"s-resize":t>=e.bottomRightCircle.startX-s&&t<=e.bottomRightCircle.startX+s&&o>=e.bottomRightCircle.startY-s&&o<=e.bottomRightCircle.startY+s?"se-resize":t>=e.activePoint.startX&&t<=e.activePoint.endX&&o>=e.activePoint.startY&&o<=e.activePoint.endY?i?"grab":"move":n&&!r&&t>=n.x-(a+2)&&t<=n.x+(a+2)&&o>=n.y-(a+2)&&o<=n.y+(a+2)?"grabbing":"default"},p.prototype.setCursor=function(e,t){var o=this.parent,i=(o.upperCanvas.style.cursor=o.cursor="default",{bool:null});if(o.notify("toolbar",{prop:"getFrameToolbar",onPropertyChange:!1,value:{obj:i}}),o.isResize||this.isSliding||i.bool)o.upperCanvas.style.cursor="default";else{var r,n=!1;if((!(r=o.activeObj.shape?o.activeObj.shape.split("-"):r)&&o.currObjType.isCustomCrop||r&&"crop"===r[0])&&(n=!0),o.currObjType.isDragging)""===this.dragElement?o.upperCanvas.style.cursor=o.cursor="move":o.upperCanvas.style.cursor=o.cursor=this.dragElement;else if(o.togglePen)o.upperCanvas.style.cursor=o.cursor="crosshair",o.isMaskImage&&(this.drawMaskCircle(e,t),o.upperCanvas.style.cursor="none");else{if(o.activeObj.shape&&this.setCursorForActObj(r,n,e,t),"default"===o.cursor||"grab"===o.cursor){for(var a=this.getHighestOrder(),s=T.extend([],o.shapeColl,[],!0),i=T.extend([],o.objColl,[],!0),l=!1;0<a;){l=!1;for(var p,h=s.length-1;0<=h;h--)s[h].order===a?(l=!0,s[h].id&&-1<s[h].id.indexOf("pen")?!o.pointColl[0]||"grab"===o.cursor&&n||o.currObjType.isDragging||o.currObjType.isResize||(p=T.extend([],o.points,[],!0),n||this.setCursorForFreehandDrawing(e,t,o.upperCanvas,s[h].id),o.points=p):(o.objColl=[],o.objColl.push(T.extend({},s[h],null,!0)),p=o.upperCanvas.style.cursor,0<o.objColl.length&&("grab"!==o.cursor||!n)&&this.setCursorFromObj(e,t,o.objColl,o.upperCanvas,n),"grab"===p&&"default"===o.cursor&&(o.upperCanvas.style.cursor=o.cursor="grab"))):T.isNullOrUndefined(s[h].order)&&(l=!0);if("default"!==o.cursor&&"grab"!==o.cursor)break;if(l)for(var d=!1;!d&&0<a;){for(var c=0;c<s.length;c++)if(s[c].order===a-1){d=!0;break}a--,d||a--}}o.objColl=i,"default"!==o.cursor&&"grab"!==o.cursor||o.togglePan&&(o.lowerCanvas.style.cursor=o.upperCanvas.style.cursor=o.cursor="grab")}""===this.currentDrawingShape||"default"!==o.cursor&&"grab"!==o.cursor||(o.upperCanvas.style.cursor=o.cursor="crosshair")}}},p.prototype.getHighestOrder=function(){for(var e=0,t=0;t<this.parent.shapeColl.length;t++)this.parent.shapeColl[t].order>e&&(e=this.parent.shapeColl[t].order);return e},p.prototype.drawMaskCircle=function(e,t){var o,i,r=this.parent;r.isMaskImage&&(o=2*r.activeObj.strokeSettings.strokeWidth,(i=r.maskCanvas.getContext("2d")).clearRect(0,0,r.maskCanvas.width,r.maskCanvas.height),i.fillStyle=r.activeObj.strokeSettings.strokeColor,i.strokeStyle="#fff",i.beginPath(),i.ellipse(e,t,o/2,o/2,0,0,2*Math.PI,!1),i.fill(),i.stroke(),i.closePath(),r.maskCanvas.style.cursor="none")},p.prototype.setCursorForActObj=function(e,t,o,i){var r,n=this.parent;void 0!==n.activeObj.horTopLine?(!(t=void 0===(e=void 0!==n.activeObj.shape?n.activeObj.shape.split("-"):e)&&n.currObjType.isCustomCrop||void 0!==e&&"crop"===e[0]?!0:t)&&n.togglePan&&(n.lowerCanvas.style.cursor=n.upperCanvas.style.cursor=n.cursor="grab"),e=n.upperCanvas.style.cursor,r=T.extend({},n.activeObj,{},!0),this.cursorTargetId=r.currIndex,0===r.shapeDegree?n.transform.degree:(n.transform.degree,r.shapeDegree),"line"===r.shape||"arrow"===r.shape?this.setCursorForLineArrow(r,o,i,n.upperCanvas):"path"===r.shape?this.setCursorForPath(r,o,i,n.upperCanvas):T.isNullOrUndefined(r.rotatedAngle)||0===r.rotatedAngle?(n.upperCanvas.style.cursor=n.cursor=this.getMouseCursor(r,o,i,t,!1),"text"===r.shape&&-1<["n-resize","s-resize","e-resize","w-resize"].indexOf(n.cursor)&&(n.upperCanvas.style.cursor=n.cursor="move")):this.setCursorForRotatedObject(r,o,i,n.upperCanvas),"default"===e&&"default"===n.cursor&&t&&(n.upperCanvas.style.cursor=n.cursor="grab"),"grab"===e&&"default"===n.cursor&&(n.upperCanvas.style.cursor=n.cursor="grab")):n.togglePan&&!n.togglePen?n.lowerCanvas.style.cursor=n.upperCanvas.style.cursor=n.cursor="grab":n.currObjType.isCustomCrop||n.togglePen?n.upperCanvas.style.cursor=n.cursor="crosshair":n.upperCanvas.style.cursor=n.cursor="default"},p.prototype.setCursorForPath=function(e,t,o,i){this.setCursorForLineArrow(e,t,o,i);var r=this.parent;if("default"===r.cursor)for(var n=T.extend({},e,null,!0),a=!1,s=1,l=e.pointColl.length;s<l&&!a;s++){n.activePoint.startX=e.pointColl[s-1].x,n.activePoint.startY=e.pointColl[s-1].y,n.activePoint.endX=e.pointColl[s].x,n.activePoint.endY=e.pointColl[s].y,r.notify("shape",{prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:n}});for(var p=e.topLeftCircle.radius,h=0,d=n.pointColl.length;h<d;h++){var c=n.pointColl[h];if(!T.isNullOrUndefined(c.x-2*p)&&!T.isNullOrUndefined(c.x+2*p)&&!T.isNullOrUndefined(c.y-2*p)&&!T.isNullOrUndefined(c.y+2*p)&&t>=c.x-2*p&&t<=c.x+2*p&&o>=c.y-2*p&&o<=c.y+2*p){i.style.cursor=r.cursor="move",a=!0;break}i.style.cursor=r.cursor="default"}}return r.cursor},p.prototype.setCursorForLineArrow=function(e,t,o,i){var r,n=e.topLeftCircle.radius;if(!T.isNullOrUndefined(e.pointColl))for(var a=0,s=e.pointColl.length;a<s;a++){var l=e.pointColl[a];if(t>=l.x-2*n&&t<=l.x+2*n&&o>=l.y-2*n&&o<=l.y+2*n){i.style.cursor=this.parent.cursor="move",r=a;break}i.style.cursor=this.parent.cursor="default"}return r},p.prototype.setCursorForRotatedObject=function(e,t,o,i){this.resizedElement="";var r=this.parent,n=e.bottomCenterCircle.radius,a=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length/2)],s=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length-1)],l=e.verLeftLinePointColl[Math.round(e.verLeftLinePointColl.length/2)],p=e.verRightLinePointColl[Math.round(e.verRightLinePointColl.length/2)],h=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length/2)],d=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length-1)],c=e.rotationCirclePointColl,u=e.horTopLinePointColl[0],g=e.horBottomLinePointColl[0];if(t>=u.x-(n+2)&&t<=u.x+(n+2)&&o>=u.y-(n+2)&&o<=u.y+(n+2)?i.style.cursor=r.cursor="nw-resize":t>=a.x-5&&t<=a.x+5&&o>=a.y-5&&o<=a.y+5?i.style.cursor=r.cursor=this.resizedElement="n-resize":t>=s.x-(n+2)&&t<=s.x+(n+2)&&o>=s.y-(n+2)&&o<=s.y+(n+2)?i.style.cursor=r.cursor="ne-resize":t>=l.x-5&&t<=l.x+5&&o>=l.y-5&&o<=l.y+5?i.style.cursor=r.cursor=this.resizedElement="w-resize":t>=p.x-5&&t<=p.x+5&&o>=p.y-5&&o<=p.y+5?i.style.cursor=r.cursor=this.resizedElement="e-resize":t>=g.x-(n+2)&&t<=g.x+(n+2)&&o>=g.y-(n+2)&&o<=g.y+(n+2)?i.style.cursor=r.cursor="sw-resize":t>=h.x-5&&t<=h.x+5&&o>=h.y-5&&o<=h.y+5?i.style.cursor=r.cursor=this.resizedElement="s-resize":t>=d.x-(n+2)&&t<=d.x+(n+2)&&o>=d.y-(n+2)&&o<=d.y+(n+2)?i.style.cursor=r.cursor="se-resize":c&&t>=c.x-(n+2)&&t<=c.x+(n+2)&&o>=c.y-(n+2)&&o<=c.y+(n+2)?i.style.cursor=r.cursor="grabbing":(i.style.cursor=r.cursor="default",this.getRectanglePoints(e.activePoint.startX,e.activePoint.startY,e.activePoint.width,e.activePoint.height,e.rotatedAngle*(180/Math.PI),t,o)&&(i.style.cursor=r.cursor="move")),"default"===r.cursor)for(var v=0,f=e.horTopLinePointColl.length;v<f;v++){var C=e.horTopLinePointColl[v];if(t>=C.x-5&&t<=C.x+5&&o>=C.y-5&&o<=C.y+5){i.style.cursor=r.cursor=this.resizedElement="n-resize";break}}if("default"===r.cursor)for(v=0,f=e.horBottomLinePointColl.length;v<f;v++){var b=e.horBottomLinePointColl[v];if(t>=b.x-5&&t<=b.x+5&&o>=b.y-5&&o<=b.y+5){i.style.cursor=r.cursor=this.resizedElement="s-resize";break}}if("default"===r.cursor)for(v=0,f=e.verLeftLinePointColl.length;v<f;v++){var m=e.verLeftLinePointColl[v];if(t>=m.x-5&&t<=m.x+5&&o>=m.y-5&&o<=m.y+5){i.style.cursor=r.cursor=this.resizedElement="w-resize";break}}if("default"===r.cursor)for(v=0,f=e.verRightLinePointColl.length;v<f;v++){var y=e.verRightLinePointColl[v];if(t>=y.x-5&&t<=y.x+5&&o>=y.y-5&&o<=y.y+5){i.style.cursor=r.cursor=this.resizedElement="e-resize";break}}return this.adjustCursorStylesForRotatedState(e),r.cursor},p.prototype.adjustCursorStylesForRotatedState=function(e){var t=this.parent,o=e.rotatedAngle*(180/Math.PI);return(92<=(o=0<o?Math.floor(o):Math.ceil(o))&&o<=182||-178<=o&&o<=-88)&&t.cursor in(o={"nw-resize":"ne-resize","n-resize":"s-resize","ne-resize":"nw-resize","w-resize":"e-resize","e-resize":"w-resize","sw-resize":"se-resize","s-resize":"n-resize","se-resize":"sw-resize"})&&(t.cursor=o[t.cursor]),t.upperCanvas.style.cursor=this.getResizeElement(e.rotatedAngle*(180/Math.PI),t.cursor),t.cursor},p.prototype.getResizeElement=function(e,t){var o=[];switch(t){case"nw-resize":o=[[337.5,22.5,"nw-resize"],[22.5,67.5,"n-resize"],[67.5,112.5,"ne-resize"],[112.5,157.5,"e-resize"],[157.5,202.5,"se-resize"],[202.5,247.5,"s-resize"],[247.5,292.5,"sw-resize"],[292.5,337.5,"w-resize"]];break;case"n-resize":o=[[337.5,22.5,"n-resize"],[22.5,67.5,"ne-resize"],[67.5,112.5,"e-resize"],[112.5,157.5,"se-resize"],[157.5,202.5,"s-resize"],[202.5,247.5,"sw-resize"],[247.5,292.5,"w-resize"],[292.5,337.5,"nw-resize"]];break;case"ne-resize":o=[[337.5,22.5,"ne-resize"],[22.5,67.5,"e-resize"],[67.5,112.5,"se-resize"],[112.5,157.5,"s-resize"],[157.5,202.5,"sw-resize"],[202.5,247.5,"w-resize"],[247.5,292.5,"nw-resize"],[292.5,337.5,"n-resize"]];break;case"e-resize":o=[[337.5,22.5,"e-resize"],[22.5,67.5,"se-resize"],[67.5,112.5,"s-resize"],[112.5,157.5,"sw-resize"],[157.5,202.5,"w-resize"],[202.5,247.5,"nw-resize"],[247.5,292.5,"n-resize"],[292.5,337.5,"ne-resize"]];break;case"se-resize":o=[[337.5,22.5,"se-resize"],[22.5,67.5,"s-resize"],[67.5,112.5,"sw-resize"],[112.5,157.5,"w-resize"],[157.5,202.5,"nw-resize"],[202.5,247.5,"n-resize"],[247.5,292.5,"ne-resize"],[292.5,337.5,"e-resize"]];break;case"s-resize":o=[[337.5,22.5,"s-resize"],[22.5,67.5,"sw-resize"],[67.5,112.5,"w-resize"],[112.5,157.5,"nw-resize"],[157.5,202.5,"n-resize"],[202.5,247.5,"ne-resize"],[247.5,292.5,"e-resize"],[292.5,337.5,"se-resize"]];break;case"sw-resize":o=[[337.5,22.5,"sw-resize"],[22.5,67.5,"w-resize"],[67.5,112.5,"nw-resize"],[112.5,157.5,"n-resize"],[157.5,202.5,"ne-resize"],[202.5,247.5,"e-resize"],[247.5,292.5,"se-resize"],[292.5,337.5,"s-resize"]];break;case"w-resize":o=[[337.5,22.5,"w-resize"],[22.5,67.5,"nw-resize"],[67.5,112.5,"n-resize"],[112.5,157.5,"ne-resize"],[157.5,202.5,"e-resize"],[202.5,247.5,"se-resize"],[247.5,292.5,"s-resize"],[292.5,337.5,"sw-resize"]]}for(var i=e<0?360-Math.abs(e):e,r=0,n=o;r<n.length;r++){var a=n[r],s=a[0],l=a[1],a=a[2];if(s<i&&i<=l||s<i+360&&i+360<=l)return a}return t},p.prototype.setCursorForFreehandDrawing=function(e,t,o,i){var r,n=o.getContext("2d"),a=this.parent,s=document.querySelector("#"+a.element.id+"_textArea"),l=!1;a.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:-1}});for(var p=0;p<a.freehandCounter;p++)if(!i||i===a.pointColl[p].id){for(var h={selPointColl:{}},d=(a.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:h}}),r=T.extend([],h.selPointColl[p].points,[]),a.points=T.extend([],a.pointColl[p].points,[]),a.pointColl[p]),c=(a.notify("freehand-draw",{prop:"setPointCounter",onPropertyChange:!1,value:{value:0}}),r.length),u=0;u<c;u++)if(0!==u){var g=!1;if(g=r[u-1]&&r[u]?this.isInside(e,t,r[u-1].x,r[u-1].y,r[u].x,r[u].y):g){this.isFhdPoint=!0,a.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:p}}),a.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}),o.style.cursor=a.cursor="pointer",l=!0;break}this.isFhdEditing&&!d.isSelected||((this.isFhdPoint||this.isFhdEditing)&&(n.clearRect(0,0,o.width,o.height),a.activeObj.shape)&&"none"===s.style.display&&a.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:a.activeObj}}),this.isFhdEditing?(a.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!(v={freehandSelectedIndex:-1}),value:{obj:v}}),f=a.pointColl[v.freehandSelectedIndex].strokeColor,C=a.pointColl[v.freehandSelectedIndex].strokeWidth,a.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:f,strokeWidth:C}})):a.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:null}}),this.isFhdPoint=!1)}else{var v,f,C,g=a.points[u];if(e>g.x-d.strokeWidth&&e<g.x+d.strokeWidth&&t>g.y-d.strokeWidth&&t<g.y+d.strokeWidth){this.isFhdPoint=!0,a.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:p}}),a.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}),o.style.cursor=a.cursor="pointer",l=!0;break}this.isFhdEditing&&!d.isSelected||((this.isFhdPoint||this.isFhdEditing)&&(n.clearRect(0,0,o.width,o.height),a.activeObj.shape)&&"none"===s.style.display&&a.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:a.activeObj}}),this.isFhdEditing&&(a.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!(v={freehandSelectedIndex:-1}),value:{obj:v}}),f=a.pointColl[v.freehandSelectedIndex].strokeColor,C=a.pointColl[v.freehandSelectedIndex].strokeWidth,a.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:f,strokeWidth:C}})),this.isFhdPoint=!1)}if(l)break}},p.prototype.setCursorFromObj=function(e,t,o,i,r){for(var n=this.parent,a=0,s=o.length;a<s;a++){if("move"===n.cursor)return;var l=T.extend({},o[a],{},!0);if(0===l.activePoint.width&&0===l.activePoint.height)return void o.splice(a,1);this.cursorTargetId=l.currIndex,"line"===l.shape||"arrow"===l.shape?this.setCursorForLineArrow(l,e,t,i):"path"===l.shape?this.setCursorForPath(l,e,t,i):T.isNullOrUndefined(l.rotatedAngle)||0===l.rotatedAngle?i.style.cursor=n.cursor=this.getMouseCursor(l,e,t,r,!0):this.setCursorForRotatedObject(l,e,t,i)}},p.prototype.isInside=function(e,t,o,i,r,n){var a=Math.min(o,r),o=Math.max(o,r),r=Math.min(i,n),i=Math.max(i,n);return a<=e&&e<=o&&r<=t&&t<=i},p.prototype.preventResizing=function(e){var t,o=this.parent;o.activeObj.preventShapeDragOut&&this.isShapeDragOut()&&((t=o.activeObj.activePoint).startX=e.activePoint.startX,t.startY=e.activePoint.startY,t.endX=e.activePoint.endX,t.endY=e.activePoint.endY,t.width=e.activePoint.width,t.height=e.activePoint.height,o.activeObj.rotatedAngle=e.rotatedAngle,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:t,obj:o.activeObj,isMouseMove:null,x:null,y:null}}))},p.prototype.updateActivePoint=function(e,t,o){var i=this.parent,r=i.activeObj.activePoint,n=r.startX,a=r.startY,r=i.activeObj.activePoint,s=r.width,l=r.height,r=(i.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:s,height:l,obj:{width:0,height:0},isImgShape:null}}),this.updatePrevShapeSettings()),p={cancel:!1,action:"resize",previousShapeSettings:r,allowShapeOverflow:this.allowOutofBound()},h={cancel:!1,action:"move",previousShapeSettings:r,allowShapeOverflow:this.allowOutofBound()},d=(this.shapeResizingArgs=p,this.shapeMovingArgs=h,"text"===i.activeObj.shape&&""!==this.dragElement&&i.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:i.activeObj,isTextArea:null}}),""===this.currentDrawingShape||""!==this.dragElement&&"move"!==this.dragElement||!i.isShapeDrawing||(-1<["line","arrow","path"].indexOf(i.activeObj.shape)?this.dragElement="e-resize":n<e&&a<t?this.dragElement="se-resize":e<n&&a<t?this.dragElement="sw-resize":n<e&&t<a?this.dragElement="ne-resize":e<n&&t<a&&(this.dragElement="nw-resize")),"arrow"===i.activeObj.shape&&(0<Math.atan2(e-i.lowerCanvas.width/2,t-i.lowerCanvas.height/2)?i.activeObj.rotatedAngle=-Math.atan2(e-i.lowerCanvas.width/2,t-i.lowerCanvas.height/2):i.activeObj.rotatedAngle=Math.abs(Math.atan2(e-i.lowerCanvas.width/2,t-i.lowerCanvas.height/2))),!1),c=!1;if(!o||0===i.transform.straighten||!this.isMouseOutsideImg(e,t)){var u,g,v=T.extend({},i.activeObj,{},!0);switch(void 0!==(u=void 0!==i.activeObj.shape?i.activeObj.shape.split("-"):u)&&"crop"===u[0]&&(g=!0),this.dragElement.toLowerCase()){case"nw-resize":this.updateNWPoints(e,t),this.preventResizing(v),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(p,h,"resize");break;case"n-resize":this.updateNPoints(e,t),this.preventResizing(v),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(p,h,"resize");break;case"ne-resize":this.updateNEPoints(e,t),this.preventResizing(v),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(p,h,"resize");break;case"w-resize":this.updateWPoints(e,t),this.preventResizing(v),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(p,h,"resize");break;case"e-resize":this.updateEPoints(e,t),this.preventResizing(v),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(p,h,"resize");break;case"sw-resize":this.updateSWPoints(e,t),this.preventResizing(v),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(p,h,"resize");break;case"s-resize":this.updateSPoints(e,t),this.preventResizing(v),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(p,h,"resize");break;case"se-resize":this.updateSEPoints(e,t),this.preventResizing(v),i.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:i.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(p,h,"resize");break;case"grabbing":0<Math.atan2(e-(n+s/2),t-(a+l/2))?i.activeObj.rotatedAngle=-Math.atan2(e-(n+s/2),t-(a+l/2)):i.activeObj.rotatedAngle=Math.abs(Math.atan2(e-(n+s/2),t-(a+l/2))),(b=0===i.activeObj.shapeDegree?i.transform.degree:i.transform.degree-i.activeObj.shapeDegree)<0&&(b=360+b);for(var f=0,C=i.activeObj.flipObjColl.length;f<C;f++)"horizontal"===i.activeObj.flipObjColl[f].toLowerCase()?d=!0:"vertical"===i.activeObj.flipObjColl[f].toLowerCase()&&(c=!0);i.activeObj.rotatedAngle-=b*(Math.PI/180),0===b||360===b?c&&(i.activeObj.rotatedAngle-=Math.PI/180*180):90===b||-270===b?d&&(i.activeObj.rotatedAngle-=Math.PI/180*180):180===b||-180===b?c&&(i.activeObj.rotatedAngle-=Math.PI/180*180):270!==b&&-90!==b||d&&(i.activeObj.rotatedAngle-=Math.PI/180*180),this.preventResizing(v);break;case"pathdrag":T.isNullOrUndefined(this.pathAdjustedIndex)||(i.activeObj.pointColl[this.pathAdjustedIndex].x=e,i.activeObj.pointColl[this.pathAdjustedIndex].y=t);break;default:if(!o&&!i.currObjType.isCustomCrop){var b=i.activeObj.activePoint;if(this.dragPoint.startX){var m=this.dragPoint.endX-this.previousPoint.x,y=this.dragPoint.endY-this.previousPoint.y;if(b.startX+=m,b.endX+=m,b.startY+=y,b.endY+=y,b.startX,b.startY,"line"!==i.activeObj.shape&&"arrow"!==i.activeObj.shape&&i.activeObj.rotationCirclePointColl&&(i.activeObj.rotationCirclePointColl.x+=m,i.activeObj.rotationCirclePointColl.y+=y,i.activeObj.rotationCirclePoint.x+=m,i.activeObj.rotationCirclePoint.y+=y),"path"===i.activeObj.shape)for(f=0,C=i.activeObj.pointColl.length;f<C;f++)i.activeObj.pointColl[f].x+=m,i.activeObj.pointColl[f].y+=y;if(!this.isPreventDragging&&this.isShapeDragOut()&&(i.activeObj.preventShapeDragOut||"redact"===i.activeObj.shape||g)){if(b.startX-=m,b.endX-=m,b.startY-=y,b.endY-=y,"line"!==i.activeObj.shape&&"arrow"!==i.activeObj.shape&&i.activeObj.rotationCirclePointColl)i.activeObj.rotationCirclePointColl.x-=m,i.activeObj.rotationCirclePointColl.y-=y,i.activeObj.rotationCirclePoint.x-=m,i.activeObj.rotationCirclePoint.y-=y;else if("path"===i.activeObj.shape)for(var P=0,C=i.activeObj.pointColl.length;P<C;P++)i.activeObj.pointColl[P].x-=m,i.activeObj.pointColl[P].y-=y;if(0===i.activeObj.rotatedAngle){var j=i.activeObj.activePoint.endX,x=i.activeObj.activePoint.endY,w=("path"===i.activeObj.shape&&(i.activeObj.activePoint=i.getSquarePointForPath(i.activeObj)),this.setDragWidth(m),this.setDragHeight(y),i.activeObj),O=w.activePoint.endX-j,S=w.activePoint.endY-x;if("path"===w.shape)for(P=0,C=w.pointColl.length;P<C;P++)w.pointColl[P].x+=O,w.pointColl[P].y+=S}else i.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:i.activeObj}})}}else b.startX=e<this.mouseDownPoint.x?e:this.mouseDownPoint.x,b.startY=t<this.mouseDownPoint.y?t:this.mouseDownPoint.y,e=e<this.mouseDownPoint.x?this.mouseDownPoint.x:e,t=t<this.mouseDownPoint.y?this.mouseDownPoint.y:t,b.endX=e,b.endY=t;this.triggerShapeChange(p,h,"move")}}}},p.prototype.isShapeDragOut=function(){var e,t,o,i,r=this.parent,n=!1,a=!1,s=r.activeObj.shape;return(a=r.activeObj.preventShapeDragOut||0===r.activeObj.rotatedAngle&&"line"!==s&&"arrow"!==s&&"path"!==s?!0:a)&&(e=(a=r.activeObj.activePoint).startX,t=a.startY,o=a.endX,a=a.endY,"path"===s&&(e=(i=r.getSquarePointForPath(r.activeObj)).startX,t=i.startY,o=i.endX,a=i.endY),n=0!==r.activeObj.rotatedAngle&&"arrow"!==s&&(r.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!(i={isIntersect:null,arr:null})}),r.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:i}}),!!(i.arr[0]||i.arr[1]||i.arr[2]||i.arr[3]))||this.isObjOutsideImg(e,t,o,a,s)),n},p.prototype.isObjOutsideImg=function(e,t,o,i,r){var n=this.parent.img,a=n.destLeft,s=n.destTop,l=n.destWidth,n=n.destHeight;return e<a||t<s||a+l<o||s+n<i||("line"===r||"arrow"===r)&&(a+l<e||s+n<t||o<a||i<s)},p.prototype.triggerShapeChange=function(e,t,o){var i=this.parent,r=i.activeObj.activePoint,r=(r.width=r.endX-r.startX,r.height=r.endY-r.startY,this.updatePrevShapeSettings());T.isNullOrUndefined(this.shapeResizingArgs)||T.isNullOrUndefined(this.shapeMovingArgs)?(e.currentShapeSettings=r,t.currentShapeSettings=r):(e.currentShapeSettings=this.shapeResizingArgs.currentShapeSettings=r,t.currentShapeSettings=this.shapeMovingArgs.currentShapeSettings=r),"resize"===o?(this.isCropSelection=!1,(r=void 0)!==(r=void 0!==i.activeObj.shape?i.activeObj.shape.split("-"):r)&&"crop"===r[0]&&(this.isCropSelection=!0),this.isCropSelection?(this.isMouseDown?e.action="resize-start":this.isMouseUp&&(e.action="resize-end"),r={action:e.action,previousSelectionSettings:{type:i.getSelectionType(i.activeObj.shape),startX:e.previousShapeSettings.startX,startY:e.previousShapeSettings.startY,width:e.previousShapeSettings.width,height:e.previousShapeSettings.height},currentSelectionSettings:{type:i.getSelectionType(i.activeObj.shape),startX:e.currentShapeSettings.startX,startY:e.currentShapeSettings.startY,width:e.currentShapeSettings.width,height:e.currentShapeSettings.height}},this.selectionResizingArgs=r,i.trigger("selectionChanging",r),i.editCompleteArgs=r,i.notify("shape",{prop:"updSelChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:r.currentSelectionSettings}})):(""!==this.currentDrawingShape&&"crosshair"===i.upperCanvas.style.cursor&&(e.action="drawing"),i.currObjType.isRedact&&"redact"===i.activeObj.shape||i.trigger("shapeChanging",e),i.editCompleteArgs=e,this.isPreventShaping=e.cancel,i.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings,allowShapeOverflow:e.allowShapeOverflow}}))):"mouse-down"===o||"mouse-up"===o?("redact"!==i.activeObj.shape&&i.trigger("shapeChanging",e),i.editCompleteArgs=e,this.isPreventShaping=e.cancel,i.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings,allowShapeOverflow:e.allowShapeOverflow}})):("redact"!==i.activeObj.shape&&i.trigger("shapeChanging",t),i.editCompleteArgs=t,this.isPreventShaping=t.cancel,i.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:t.currentShapeSettings,allowShapeOverflow:t.allowShapeOverflow}})),i.eventType=o},p.prototype.setDragWidth=function(e){var t=this.parent,o=t.activeObj.activePoint,i=t.img,r=i.destLeft,n=i.destWidth,a=e,i=t.activeObj.shape,s=!1;if(!t.activeObj.preventShapeDragOut||"line"!==i&&"arrow"!==i||(s=!0),0<=a)for(var l=0;l<a&&(o.startX+=e=a-l,o.endX+=e,!(o.startX>=r&&o.endX<=r+n&&!s||o.startX>=r&&o.endX<=r+n&&o.endX>=r&&o.startX<=r+n&&s));l++)o.startX-=e,o.endX-=e;else for(l=1;l<Math.abs(a)&&(o.startX+=e=a+l,o.endX+=e,!(o.startX>=r&&o.endX<=r+n&&!s||o.startX>=r&&o.endX<=r+n&&o.endX>=r&&o.startX<=r+n&&s));l++)o.startX-=e,o.endX-=e},p.prototype.setDragHeight=function(e){var t=this.parent,o=t.activeObj.activePoint,i=t.img,r=i.destTop,n=i.destHeight,a=e,i=t.activeObj.shape,s=!1;if(!t.activeObj.preventShapeDragOut||"line"!==i&&"arrow"!==i||(s=!0),0<=a)for(var l=1;l<a&&(o.startY+=e=a-l,o.endY+=e,!(o.startY>=r&&o.endY<=r+n&&!s||o.startY>=r&&o.endY<=r+n&&o.endY>=r&&o.startY<=r+n&&s));l++)o.startY-=e,o.endY-=e;else for(l=0;l<Math.abs(a)&&(o.startY+=e=a+l,o.endY+=e,!(o.startY>=r&&o.endY<=r+n&&!s||o.startY>=r&&o.endY<=r+n&&o.endY>=r&&o.startY<=r+n&&s));l++)o.startY-=e,o.endY-=e},p.prototype.limitDrag=function(e){var t=!1,o=this.parent,i=o.img,r=i.destLeft,n=i.destTop,a=i.destWidth,i=i.destHeight,s=o.activeObj.activePoint,l=e?s.startX:s.endX,p=e?s.startY:s.endY,h=e?s.endX:s.startX,d=e?s.endY:s.startY,c=o.upperCanvas.width,u=o.upperCanvas.height;return T.Browser.isDevice?(l<0&&r<0&&(l=0),p<0&&n<0&&(p=0),c<h&&c<r+a&&(h=c),u<d&&u<n+i&&(d=u)):(l<r&&(l=r),p<n&&(p=n),r+a<h&&(h=r+a),n+i<d&&(d=n+i)),0!==o.transform.straighten&&(o.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!(c={isIntersect:null,arr:null})}),o.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:c}}),c.arr[0]||c.arr[1]||c.arr[2]||c.arr[3])&&(t=!0),e?(s.startX=l,s.startY=p,s.endX=h,s.endY=d):(s.startX=h,s.startY=d,s.endX=l,s.endY=p),t},p.prototype.isMouseOutsideImg=function(e,t){var o={bool:!1};return this.parent.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),this.parent.notify("draw",{prop:"isPointsInsideImg",value:{obj:o,x:e,y:t}}),o.bool},p.prototype.preventDraggingInvertly=function(){var e,t,o=!1,i=this.parent;return"image"===i.activeObj.shape||(void 0!==(e=void 0!==i.activeObj.shape?i.activeObj.shape.split("-"):e)&&"crop"===e[0]&&(t=!0),this.isPreventDragging)||0!==i.activeObj.rotatedAngle||!i.activeObj.preventShapeDragOut&&"redact"!==i.activeObj.shape&&!t||(o=this.limitDrag(!0),-1<["line","arrow","path"].indexOf(i.activeObj.shape)&&(o=this.limitDrag(!1))),o},p.prototype.preventTextDraggingInvertly=function(){var e=this.parent,t=!1,o=e.activeObj.activePoint,e=e.img,i=e.destLeft,r=e.destTop,n=e.destWidth,e=e.destHeight;return this.isPreventDragging||(o.startX<i||o.startY<r||o.endX>i+n||o.endY>r+e)&&(t=!0),t},p.prototype.preventInverseResize=function(e){var t=this.parent.activeObj.activePoint;t.width<0&&(t.width=0,t.startX=e.activePoint.startX,t.endX=e.activePoint.endX),t.height<0&&(t.height=0,t.startY=e.activePoint.startY,t.endY=e.activePoint.endY)},p.prototype.getScaleRatio=function(e){var t,o=this.parent,i={x:e,y:e};return o.activeObj.shape&&"crop-custom"!==o.activeObj.shape&&"crop-circle"!==o.activeObj.shape&&"crop-square"!==o.activeObj.shape&&(1<(t=("image"===o.activeObj.shape||"text"===o.activeObj.shape?this.findImageRatio(o.activeObj.activePoint.width,o.activeObj.activePoint.height):o.activeObj.shape).split("-")).length||"image"===o.activeObj.shape||"text"===o.activeObj.shape)&&(t=("image"===o.activeObj.shape||"text"===o.activeObj.shape?t[0]:t[1]).split(":"),o=e/parseInt(t[1],10),i.x=o*parseInt(t[0],10),i.y=o*parseInt(t[1],10)),i},p.prototype.findImageRatio=function(e,t,o){function i(e,t){return 0===t?e:i(t,e%t)}var r=i(e,t),e=e/r+":"+t/r;return o&&(o.ratio=e),e},p.prototype.revertResizing=function(e){var t=this.parent.activeObj.activePoint;this.preventDraggingInvertly()&&(t.startX=e.activePoint.startX,t.startY=e.activePoint.startY,t.endX=e.activePoint.endX,t.endY=e.activePoint.endY)},p.prototype.performSEResize=function(e,t,o,i){var r,n=this.parent;this.resizeImg(e,t,"se-resize",o),i.endX<i.startX&&(r=i.endX,i.endX=i.startX,i.startX=r,this.dragElement=n.upperCanvas.style.cursor=n.cursor="sw-resize"),i.endY<i.startY&&(r=i.endY,i.endY=i.startY,i.startY=r,this.dragElement=n.upperCanvas.style.cursor=n.cursor="ne-resize"),this.revertCustomSelection(i,o,"se-resize"),this.revertResizing(o)},p.prototype.performNWResize=function(e,t,o,i){var r,n=this.parent;this.resizeImg(e,t,"nw-resize",o),i.startX>i.endX&&(r=i.startX,i.startX=i.endX,i.endX=r,this.dragElement=n.upperCanvas.style.cursor=n.cursor="ne-resize"),i.startY>i.endY&&(r=i.startY,i.startY=i.endY,i.endY=r,this.dragElement=n.upperCanvas.style.cursor=n.cursor="sw-resize"),this.revertCustomSelection(i,o,"nw-resize"),this.revertResizing(o)},p.prototype.isCustomSelection=function(){return!!this.parent.activeObj.shape&&-1<this.parent.activeObj.shape.indexOf("crop-")&&-1===["custom","circle","square","2:3","3:2","3:4","4:3","4:5","5:4","5:7","7:5","9:16","16:9"].indexOf(this.parent.activeObj.shape.split("-")[1])},p.prototype.revertCustomSelection=function(e,t,o){var i,r,n,a,s=this.parent;this.isCustomSelection()&&(i=(a=s.img).destLeft,r=a.destTop,n=a.destWidth,a=a.destHeight,n=i+n<s.lowerCanvas.width?i+n:s.lowerCanvas.width,a=r+a<s.lowerCanvas.height?r+a:s.lowerCanvas.height,"se-resize"===o&&(e.endX>n||e.endY>a)||"nw-resize"===o&&(e.startX<(0<i?i:0)||e.startY<(0<r?r:0))||"ne-resize"===o&&(e.endX>n||e.startY<(0<r?r:0))||"sw-resize"===o&&(e.startX<(0<i?i:0)||e.endY>a))&&this.revertPoints(e,t)},p.prototype.revertPoints=function(e,t){e.startX=t.activePoint.startX,e.startY=t.activePoint.startY,e.endX=t.activePoint.endX,e.endY=t.activePoint.endY,e.width=t.activePoint.width,e.height=t.activePoint.height},p.prototype.updateNWPoints=function(e,t){var o,i,r,n,a,s,l=this.parent,p=l.activeObj.activePoint,h=T.extend({},l.activeObj,null,!0);"text"===l.activeObj.shape?(this.resizeImg(e,t,"nw-resize",h),l.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:l.activeObj}})):((o=void 0)!==l.activeObj.shape&&(o=l.activeObj.shape.split("-")),"crop-custom"===l.activeObj.shape||void 0!==l.activeObj.shape&&"crop"!==o[0]||this.isCustomSelection()?("image"===l.activeObj.shape||this.isCustomSelection()?this.resizeImg(e,t,"nw-resize",h):this.adjustNWPoints(p,e,t,l.activeObj.rotatedAngle),p.startX>p.endX&&(i=p.startX,p.startX=p.endX,p.endX=i,this.dragElement=l.upperCanvas.style.cursor=l.cursor="ne-resize"),p.startY>p.endY&&(i=p.startY,p.startY=p.endY,p.endY=i,this.dragElement=l.upperCanvas.style.cursor=l.cursor="sw-resize"),this.revertCustomSelection(p,h,"nw-resize")):(i=(o=l.img).destLeft,l=o.destTop,p.startX<e&&p.startY<t?(r=e-p.startX,n=t-p.startY,a=Math.min(r,n),s=this.getScaleRatio(a),p.startX+=s.x,p.startY+=s.y,(p.startX<(0<i?i:0)||p.startY<(0<l?l:0))&&(p.startX-=s.x,p.startY-=s.y)):(r=p.startX-e,n=t-p.endY,a=Math.max(r,n),s=this.getScaleRatio(a),p.startX-=s.x,p.startY-=s.y,(p.startX<(0<i?i:0)||p.startY<(0<l?l:0))&&(p.startX+=s.x,p.startY+=s.y)),p.width=p.endX-p.startX,p.height=p.endY-p.startY),this.revertResizing(h),p.width=p.endX-p.startX,p.height=p.endY-p.startY,this.preventInverseResize(h))},p.prototype.updateNPoints=function(e,t){var o,i,r,n,a,s,l=this.parent,p=l.activeObj.activePoint,h=T.extend({},l.activeObj,null,!0);"text"!==l.activeObj.shape&&(i=void 0,l.activeObj.shape&&(i=l.activeObj.shape.split("-")),"crop-custom"===l.activeObj.shape||l.activeObj.shape&&"crop"!==i[0]?("line"!==l.activeObj.shape&&"arrow"!==l.activeObj.shape&&"path"!==l.activeObj.shape&&0!==l.activeObj.rotatedAngle&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t),r=this.dragPoint.endX-this.previousPoint.x,n=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(p,r,n,l.activeObj.rotatedAngle)):(p.startY=t,p.height=p.endY-p.startY),p.startY>p.endY&&(i=p.startY,p.startY=p.endY,p.endY=i,this.dragElement=this.resizedElement="s-resize")):(l=(i=l.img).destLeft,o=i.destTop,i=i.destWidth,this.isCustomSelection()?this.performNWResize(e,t,h,p):p.endX>e&&p.startY<t?(r=p.endX-e,n=t-p.startY,a=Math.min(r,n),s=this.getScaleRatio(a),p.endX-=s.x,p.startY+=s.y,(p.endX>l+i||p.startY<o)&&(p.endX+=s.x,p.startY-=s.y)):(r=e-p.endX,n=p.startY-t,a=Math.max(r,n),s=this.getScaleRatio(a),p.endX+=s.x,p.startY-=s.y,(p.endX>l+i||p.startY<o)&&(p.endX-=s.x,p.startY+=s.y)),p.width=p.endX-p.startX,p.height=p.endY-p.startY),this.revertResizing(h))},p.prototype.updateNEPoints=function(e,t){var o,i,r,n,a,s,l,p,h,d=this.parent,c=d.activeObj.activePoint,u=T.extend({},d.activeObj,null,!0);"text"===d.activeObj.shape?(this.resizeImg(e,t,"ne-resize",u),d.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:d.activeObj}})):(r=void 0,d.activeObj.shape&&(r=d.activeObj.shape.split("-")),"crop-custom"===d.activeObj.shape||void 0!==d.activeObj.shape&&"crop"!==r[0]||this.isCustomSelection()?("image"===d.activeObj.shape||this.isCustomSelection()?this.resizeImg(e,t,"ne-resize",u):this.adjustNEPoints(c,e,t,d.activeObj.rotatedAngle),c.endX<c.startX&&(o=c.endX,c.endX=c.startX,c.startX=o,this.dragElement=d.upperCanvas.style.cursor=d.cursor="nw-resize"),c.startY>c.endY&&(o=c.startY,c.startY=c.endY,c.endY=o,this.dragElement=d.upperCanvas.style.cursor=d.cursor="se-resize"),this.revertCustomSelection(c,u,"ne-resize")):(o=(r=d.img).destLeft,i=r.destTop,r=r.destWidth,c.endX>e&&c.startY<t?(n=c.endX-e,a=t-c.startY,s=Math.min(n,a),l=this.getScaleRatio(s),c.endX-=l.x,c.startY+=l.y,p=o+r<d.lowerCanvas.width?o+r:d.lowerCanvas.width,h=0<i?i:0,(c.endX>p||c.startY<h)&&(c.endX+=l.x,c.startY-=l.y)):(n=e-c.endX,a=c.startY-t,s=Math.max(n,a),l=this.getScaleRatio(s),c.endX+=l.x,c.startY-=l.y,p=o+r<d.lowerCanvas.width?o+r:d.lowerCanvas.width,h=0<i?i:0,(c.endX>p||c.startY<h)&&(c.endX-=l.x,c.startY+=l.y)),c.width=c.endX-c.startX,c.height=c.endY-c.startY),this.revertResizing(u),c.width=c.endX-c.startX,c.height=c.endY-c.startY,this.preventInverseResize(u))},p.prototype.updateWPoints=function(e,t){var o,i,r,n,a,s,l=this.parent,p=l.activeObj.activePoint,h=T.extend({},l.activeObj,null,!0);"text"!==l.activeObj.shape&&(i=void 0,l.activeObj.shape&&(i=l.activeObj.shape.split("-")),"crop-custom"===l.activeObj.shape||l.activeObj.shape&&"crop"!==i[0]?("line"!==l.activeObj.shape&&"arrow"!==l.activeObj.shape&&"path"!==l.activeObj.shape&&0!==l.activeObj.rotatedAngle&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t),r=this.dragPoint.endX-this.previousPoint.x,n=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(p,r,n,l.activeObj.rotatedAngle)):(p.startX=e,p.width=p.endX-p.startX),"line"===l.activeObj.shape||"arrow"===l.activeObj.shape||"path"===l.activeObj.shape?(p.startY=t,p.height=p.endY-p.startY,this.adjustActObjForLineArrow()&&(this.dragElement="e-resize","right"===l.activeObj.triangleDirection?l.activeObj.triangleDirection="left":"left"===l.activeObj.triangleDirection&&(l.activeObj.triangleDirection="right"))):p.startX>p.endX&&(i=p.startX,p.startX=p.endX,p.endX=i,this.dragElement=this.resizedElement="e-resize")):(l=(i=l.img).destLeft,o=i.destTop,i=i.destHeight,this.isCustomSelection()?this.performNWResize(e,t,h,p):p.startX<e&&p.endY>t?(r=e-p.startX,n=p.endY-t,a=Math.min(r,n),s=this.getScaleRatio(a),p.startX+=s.x,p.endY-=s.y,(p.startX<l||p.endY>o+i)&&(p.startX-=s.x,p.endY+=s.y)):(r=p.startX-e,n=t-p.endY,a=Math.max(r,n),s=this.getScaleRatio(a),p.startX-=s.x,p.endY+=s.y,(p.startX<l||p.endY>o+i)&&(p.startX+=s.x,p.endY-=s.y)),p.width=p.endX-p.startX,p.height=p.endY-p.startY),this.revertResizing(h))},p.prototype.updateEPoints=function(e,t){var o,i,r,n,a,s,l,p=this.parent,h=p.activeObj.activePoint,d=T.extend({},p.activeObj,null,!0);"text"!==p.activeObj.shape&&(r=void 0,p.activeObj.shape&&(r=p.activeObj.shape.split("-")),"crop-custom"===p.activeObj.shape||p.activeObj.shape&&"crop"!==r[0]?("line"!==p.activeObj.shape&&"arrow"!==p.activeObj.shape&&"path"!==p.activeObj.shape&&0!==p.activeObj.rotatedAngle&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t),n=this.dragPoint.endX-this.previousPoint.x,a=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(h,n,a,p.activeObj.rotatedAngle)):(h.endX=e,h.width=h.endX-h.startX),"line"===p.activeObj.shape||"arrow"===p.activeObj.shape||"path"===p.activeObj.shape?(h.endY=t,h.height=h.endY-h.startY,this.adjustActObjForLineArrow()&&(this.dragElement="w-resize","right"===p.activeObj.triangleDirection?p.activeObj.triangleDirection="left":"left"===p.activeObj.triangleDirection&&(p.activeObj.triangleDirection="right"))):h.endX<h.startX&&(r=h.endX,h.endX=h.startX,h.startX=r,this.dragElement=this.resizedElement="w-resize")):(p=(r=p.img).destLeft,o=r.destTop,i=r.destWidth,r=r.destHeight,this.isCustomSelection()?this.performSEResize(e,t,d,h):h.endX>e&&h.endY>t?(n=h.endX-e,a=h.endY-t,s=Math.min(n,a),l=this.getScaleRatio(s),h.endX-=l.x,h.endY-=l.y,(h.endX>p+i||h.endY>o+r)&&(h.endX+=l.x,h.endY+=l.y)):(n=e-h.endX,a=t-h.endY,s=Math.max(n,a),l=this.getScaleRatio(s),h.endX+=l.x,h.endY+=l.y,(h.endX>p+i||h.endY>o+r)&&(h.endX-=l.x,h.endY-=l.y)),h.width=h.endX-h.startX,h.height=h.endY-h.startY),this.revertResizing(d))},p.prototype.updateSWPoints=function(e,t){var o,i,r,n,a,s,l,p,h=this.parent,d=h.activeObj.activePoint,c=T.extend({},h.activeObj,null,!0);"text"===h.activeObj.shape?(this.resizeImg(e,t,"sw-resize",c),h.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:h.activeObj}})):((r=void 0)!==h.activeObj.shape&&(r=h.activeObj.shape.split("-")),"crop-custom"===h.activeObj.shape||void 0!==h.activeObj.shape&&"crop"!==r[0]||this.isCustomSelection()?("image"===h.activeObj.shape||this.isCustomSelection()?this.resizeImg(e,t,"sw-resize",c):this.adjustSWPoints(d,e,t,h.activeObj.rotatedAngle),d.startX>d.endX&&(o=d.startX,d.startX=d.endX,d.endX=o,this.dragElement=h.upperCanvas.style.cursor=h.cursor="se-resize"),d.endY<d.startY&&(o=d.endY,d.endY=d.startY,d.startY=o,this.dragElement=h.upperCanvas.style.cursor=h.cursor="nw-resize"),this.revertCustomSelection(d,c,"sw-resize")):(o=(r=h.img).destLeft,i=r.destTop,r=r.destHeight,d.startX<e&&d.endY>t?(n=e-d.startX,a=d.endY-t,s=Math.min(n,a),l=this.getScaleRatio(s),d.startX+=l.x,d.endY-=l.y,p=i+r<h.lowerCanvas.height?i+r:h.lowerCanvas.height,(d.startX<(0<o?o:0)||d.endY>p)&&(d.startX-=l.x,d.endY+=l.y)):(n=d.startX-e,a=t-d.endY,s=Math.max(n,a),l=this.getScaleRatio(s),d.startX-=l.x,d.endY+=l.y,p=i+r<h.lowerCanvas.height?i+r:h.lowerCanvas.height,(d.startX<(0<o?o:0)||d.endY>p)&&(d.startX+=l.x,d.endY-=l.y)),d.width=d.endX-d.startX,d.height=d.endY-d.startY),this.revertResizing(c),d.width=d.endX-d.startX,d.height=d.endY-d.startY,this.preventInverseResize(c))},p.prototype.updateSPoints=function(e,t){var o,i,r,n,a,s,l,p=this.parent,h=p.activeObj.activePoint,d=T.extend({},p.activeObj,null,!0);"text"!==p.activeObj.shape&&(r=void 0,p.activeObj.shape&&(r=p.activeObj.shape.split("-")),"crop-custom"===p.activeObj.shape||p.activeObj.shape&&"crop"!==r[0]?("line"!==p.activeObj.shape&&"arrow"!==p.activeObj.shape&&"path"!==p.activeObj.shape&&0!==p.activeObj.rotatedAngle&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t),n=this.dragPoint.endX-this.previousPoint.x,a=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(h,n,a,p.activeObj.rotatedAngle)):(h.endY=t,h.height=h.endY-h.startY),h.endY<h.startY&&(r=h.endY,h.endY=h.startY,h.startY=r,this.dragElement=this.resizedElement="n-resize")):(p=(r=p.img).destLeft,o=r.destTop,i=r.destWidth,r=r.destHeight,this.isCustomSelection()?this.performSEResize(e,t,d,h):h.endX>e&&h.endY>t?(n=h.endX-e,a=h.endY-t,s=Math.min(n,a),l=this.getScaleRatio(s),h.endX-=l.x,h.endY-=l.y,(h.endX>p+i||h.endY>o+r)&&(h.endX+=l.x,h.endY+=l.y)):(n=e-h.endX,a=t-h.endY,s=Math.max(n,a),l=this.getScaleRatio(s),h.endX+=l.x,h.endY+=l.x,(h.endX>p+i||h.endY>o+r)&&(h.endX-=l.x,h.endY-=l.y)),h.width=h.endX-h.startX,h.height=h.endY-h.startY),this.revertResizing(d))},p.prototype.updateSEPoints=function(e,t){var o,i,r,n,a,s,l,p,h,d,c=this.parent,u=c.activeObj.activePoint,g=T.extend({},c.activeObj,null,!0);"text"===c.activeObj.shape?(this.resizeImg(e,t,"se-resize",g),c.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:c.activeObj}})):((n=p=void 0)!==c.activeObj.shape&&(p=c.activeObj.shape.split("-")),"crop-custom"===c.activeObj.shape||void 0!==c.activeObj.shape&&"crop"!==p[0]||this.isCustomSelection()?("image"===c.activeObj.shape||this.isCustomSelection()?this.resizeImg(e,t,"se-resize",g):this.adjustSEPoints(u,e,t,c.activeObj.rotatedAngle),u.endX<u.startX&&(a=u.endX,u.endX=u.startX,u.startX=a,this.dragElement=c.upperCanvas.style.cursor=c.cursor="sw-resize"),u.endY<u.startY&&(a=u.endY,u.endY=u.startY,u.startY=a,this.dragElement=c.upperCanvas.style.cursor=c.cursor="ne-resize"),this.revertCustomSelection(u,g,"se-resize")):(a=(p=c.img).destLeft,s=p.destTop,l=p.destWidth,p=p.destHeight,u.endX>e&&u.endY>t?(o=u.endX-e,i=u.endY-t,r=Math.min(o,i),n=this.getScaleRatio(r),u.endX-=n.x,u.endY-=n.y,h=a+l<c.lowerCanvas.width?a+l:c.lowerCanvas.width,d=s+p<c.lowerCanvas.height?s+p:c.lowerCanvas.height,(u.endX>h||u.endY>d)&&(u.endX+=n.x,u.endY+=n.y)):(o=e-u.endX,i=t-u.endY,r=Math.max(o,i),n=this.getScaleRatio(r),u.endX+=n.x,u.endY+=n.y,h=a+l<c.lowerCanvas.width?a+l:c.lowerCanvas.width,d=s+p<c.lowerCanvas.height?s+p:c.lowerCanvas.height,(u.endX>h||u.endY>d)&&(u.endX-=n.x,u.endY-=n.y)),u.width=u.endX-u.startX,u.height=u.endY-u.startY),this.revertResizing(g),this.preventInverseResize(g))},p.prototype.resizeImg=function(e,t,o,i){var r,n,a,s,l=this.parent,p=l.activeObj.activePoint;if(0!==this.previousPoint.x&&0!==this.previousPoint.y){switch("text"===this.currentDrawingShape&&(this.setCursor(e,t),0===l.activeObj.textSettings.fontSize)&&(l.activeObj.textSettings.fontSize=11,l.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:l.activeObj,isTextArea:null}}),l.activeObj.textSettings.text=l.activeObj.keyHistory="Enter Text",l.notify("shape",{prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}}),s=this.upperContext.measureText(l.activeObj.textSettings.text).width+.5*l.activeObj.textSettings.fontSize,p.endX=p.startX+s,p.endY=p.startY+l.activeObj.textSettings.fontSize,p.width=p.endX-p.startX,p.height=p.endY-p.startY,i=T.extend({},l.activeObj,null,!0),l.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:l.activeObj.activePoint,obj:l.activeObj,isMouseMove:null,x:null,y:null}})),l.upperCanvas.style.cursor){case"se-resize":case"s-resize":this.previousPoint.x>e||this.previousPoint.y>t?(r=this.previousPoint.x-e,n=this.previousPoint.y-t,a=this.getScaleRatio((r+n)/2),this.adjustRotationPoints(p,-Math.abs(a.x),-Math.abs(a.y),l.activeObj.rotatedAngle,"img-resize",o)):0!==this.previousPoint.x&&0!==this.previousPoint.y&&(r=e-this.previousPoint.x,n=t-this.previousPoint.y,a=this.getScaleRatio((r+n)/2),this.adjustRotationPoints(p,Math.abs(a.x),Math.abs(a.y),l.activeObj.rotatedAngle,"img-resize",o));break;case"sw-resize":this.previousPoint.x<e||this.previousPoint.y>t?(r=e-this.previousPoint.x,n=this.previousPoint.y-t,a=this.getScaleRatio((r+n)/2),this.adjustRotationPoints(p,-Math.abs(a.x),-Math.abs(a.y),l.activeObj.rotatedAngle,"img-resize",o)):0!==this.previousPoint.x&&0!==this.previousPoint.y&&(r=this.previousPoint.x-e,n=t-this.previousPoint.y,a=this.getScaleRatio((r+n)/2),this.adjustRotationPoints(p,Math.abs(a.x),Math.abs(a.y),l.activeObj.rotatedAngle,"img-resize",o));break;case"w-resize":case"nw-resize":this.previousPoint.x<e||this.previousPoint.y<t?(r=e-this.previousPoint.x,n=t-this.previousPoint.y,a=this.getScaleRatio((r+n)/2),this.adjustRotationPoints(p,-Math.abs(a.x),-Math.abs(a.y),l.activeObj.rotatedAngle,"img-resize",o)):0!==this.previousPoint.x&&0!==this.previousPoint.y&&(r=this.previousPoint.x-e,n=this.previousPoint.y-t,a=this.getScaleRatio((r+n)/2),this.adjustRotationPoints(p,Math.abs(a.x),Math.abs(a.y),l.activeObj.rotatedAngle,"img-resize",o));break;case"n-resize":case"ne-resize":this.previousPoint.x>e||this.previousPoint.y<t?(r=this.previousPoint.x-e,n=t-this.previousPoint.y,a=this.getScaleRatio((r+n)/2),this.adjustRotationPoints(p,-Math.abs(a.x),-Math.abs(a.y),l.activeObj.rotatedAngle,"img-resize",o)):0!==this.previousPoint.x&&0!==this.previousPoint.y&&(r=e-this.previousPoint.x,n=this.previousPoint.y-t,a=this.getScaleRatio((r+n)/2),this.adjustRotationPoints(p,Math.abs(a.x),Math.abs(a.y),l.activeObj.rotatedAngle,"img-resize",o));break;case"e-resize":this.previousPoint.x>e||this.previousPoint.y>t?(r=this.previousPoint.x-e,n=this.previousPoint.y-t,a=this.getScaleRatio((r+n)/2),this.adjustRotationPoints(p,-Math.abs(a.x),-Math.abs(a.y),l.activeObj.rotatedAngle,"img-resize",o)):0!==this.previousPoint.x&&0!==this.previousPoint.y&&(r=e-this.previousPoint.x,n=t-this.previousPoint.y,a=this.getScaleRatio((r+n)/2),this.adjustRotationPoints(p,Math.abs(a.x),Math.abs(a.y),l.activeObj.rotatedAngle,"img-resize",o))}p.width=p.endX-p.startX,p.height=p.endY-p.startY,(p.width<10||p.height<10||"text"===l.activeObj.shape&&0===l.activeObj.rotatedAngle&&this.preventTextDraggingInvertly())&&(l.activeObj=T.extend({},i,null,!0))}this.previousPoint={x:e,y:t}},p.prototype.adjustNWPoints=function(e,t,o,i){var r=e.startX+e.width/2,n=e.startY+e.height/2,r=this.rotatePoints(e.endX,e.endY,r,n,i),n=[(r[0]+t)/2,(r[1]+o)/2],r=this.rotatePoints(r[0],r[1],n[0],n[1],-i),t=this.rotatePoints(t,o,n[0],n[1],-i);return e.endX=r[0],e.endY=r[1],e.startY=t[1],e.startX=t[0],e.width=e.endX-e.startX,e.height=e.endY-e.startY,e},p.prototype.adjustNEPoints=function(e,t,o,i){var r=e.startX+e.width/2,n=e.startY+e.height/2,r=this.rotatePoints(e.startX,e.endY,r,n,i),n=[(r[0]+t)/2,(r[1]+o)/2],r=this.rotatePoints(r[0],r[1],n[0],n[1],-i),t=this.rotatePoints(t,o,n[0],n[1],-i);return e.startX=r[0],e.endY=r[1],e.width=t[0]-r[0],e.height=r[1]-t[1],e.endX=e.startX+e.width,e.startY=e.endY-e.height,e},p.prototype.adjustSWPoints=function(e,t,o,i){var r=e.startX+e.width/2,n=e.startY+e.height/2,r=this.rotatePoints(e.endX,e.startY,r,n,i),n=[(r[0]+t)/2,(r[1]+o)/2],r=this.rotatePoints(r[0],r[1],n[0],n[1],-i),t=this.rotatePoints(t,o,n[0],n[1],-i);return e.endX=r[0],e.startY=r[1],e.startX=t[0],e.endY=t[1],e.width=e.endX-e.startX,e.height=e.endY-e.startY,e},p.prototype.adjustSEPoints=function(e,t,o,i){var r=e.startX+e.width/2,n=e.startY+e.height/2,r=this.rotatePoints(e.startX,e.startY,r,n,i),n=[(r[0]+t)/2,(r[1]+o)/2],r=this.rotatePoints(r[0],r[1],n[0],n[1],-i),t=this.rotatePoints(t,o,n[0],n[1],-i);return e.startX=r[0],e.startY=r[1],e.width=t[0]-r[0],e.height=t[1]-r[1],e.endX=e.startX+e.width,e.endY=e.startY+e.height,e},p.prototype.adjustRotationPoints=function(e,t,o,i,r,n){var a=e.startX+e.width/2,s=e.startY+e.height/2,t=(this.getResizeDirection(e,t,o,i,r,n),this.rotatePoints(e.startX,e.startY,a,s,i)),o=this.rotatePoints(e.endX,e.startY,a,s,i),r=this.rotatePoints(e.endX,e.endY,a,s,i),n=this.rotatePoints(e.startX,e.endY,a,s,i),a=[(t[0]+r[0])/2,(t[1]+r[1])/2],s=this.rotatePoints(t[0],t[1],a[0],a[1],-i),r=this.rotatePoints(n[0],n[1],a[0],a[1],-i),t=this.rotatePoints(o[0],o[1],a[0],a[1],-i);return e.startX=s[0],e.startY=s[1],e.endX=t[0],e.endY=r[1],e.width=e.endX-e.startX,e.height=e.endY-e.startY,e},p.prototype.rotatePoints=function(e,t,o,i,r){return[(e-o)*Math.cos(r)-(t-i)*Math.sin(r)+o,(e-o)*Math.sin(r)+(t-i)*Math.cos(r)+i]},p.prototype.setResizedValue=function(e,t,o,i){switch(e){case"x":t+=o;break;case"y":t+=i;break;case"abs-x":t+=0<o?-o:Math.abs(o);break;case"abs-y":t+=0<i?-i:Math.abs(i);break;case"y-abs-x":t+=i+(0<o?-o:Math.abs(o))/2;break;case"abs-x-abs-y":t+=(0<o?-o:Math.abs(o))+(0<i?-i:Math.abs(i))/2;break;case"abs-y-x":t+=(0<i?-i:Math.abs(i))+o/2;break;case"x-y":t+=o+i/2;break;case"y-x":t+=i+o/2;break;case"img-resize-x":t+=o;break;case"img-resize-y":t+=i}return t},p.prototype.getResizeDirection=function(e,t,o,i,r,n){i*=180/Math.PI,i=this.getResizedElement(i,this.resizedElement);"e-resize"===this.resizedElement?(e.width=this.setResizedValue(i,e.width,t,o),e.endX=e.width+e.startX):"n-resize"===this.resizedElement?(e.startY=this.setResizedValue(i,e.startY,t,o),e.height=e.endY-e.startY):"w-resize"===this.resizedElement?(e.startX=this.setResizedValue(i,e.startX,t,o),e.width=e.startX+e.endX):"s-resize"===this.resizedElement?(e.height=this.setResizedValue(i,e.height,t,o),e.endY=e.height+e.startY):r&&"img-resize"===r?(e.width=this.setResizedValue("img-resize-x",e.width,t,o),e.height=this.setResizedValue("img-resize-y",e.height,t,o),"se-resize"===n?(e.endX=e.width+e.startX,e.endY=e.height+e.startY):"sw-resize"===n?(e.startX=e.endX-e.width,e.endY=e.height+e.startY):"ne-resize"===n?(e.endX=e.width+e.startX,e.startY=e.endY-e.height):"nw-resize"===n&&(e.startX=e.endX-e.width,e.startY=e.endY-e.height)):r&&"text"===r&&("widthHeight"===n?(e.width=this.setResizedValue("x-y",e.width,t,o),e.endX=e.width+e.startX,e.height=this.setResizedValue("y-x",e.height,t,o),e.endY=e.height+e.startY):"width"===n?(e.width=this.setResizedValue("x-y",e.width,t,o),e.endX=e.width+e.startX):"height"===n&&(e.height=this.setResizedValue("y-abs-x",e.height,t,o),e.endY=e.height+e.startY))},p.prototype.getResizedElement=function(e,t){for(var o=[],i=("n-resize"===t?o=[[337.5,360,"y"],[0,22.5,"y"],[22.5,67.5,"y-abs-x"],[67.5,112.5,"abs-x"],[112.5,157.5,"abs-x-abs-y"],[157.5,202.5,"abs-y"],[202.5,247.5,"abs-y-x"],[247.5,292.5,"x"],[292.5,337.5,"x-y"]]:"e-resize"===t?o=[[337.5,360,"x"],[0,22.5,"x"],[22.5,67.5,"x-y"],[67.5,112.5,"y"],[112.5,157.5,"y-abs-x"],[157.5,202.5,"abs-x"],[202.5,247.5,"abs-x-abs-y"],[247.5,292.5,"abs-y"],[292.5,337.5,"abs-y-x"]]:"s-resize"===t?o=[[337.5,360,"y"],[0,22.5,"y"],[22.5,67.5,"y-abs-x"],[67.5,112.5,"abs-x"],[112.5,157.5,"abs-x-abs-y"],[157.5,202.5,"abs-y"],[202.5,247.5,"abs-y-x"],[247.5,292.5,"x"],[292.5,337.5,"x-y"]]:"w-resize"===t&&(o=[[337.5,360,"x"],[0,22.5,"x"],[22.5,67.5,"x-y"],[67.5,112.5,"y"],[112.5,157.5,"y-abs-x"],[157.5,202.5,"abs-x"],[202.5,247.5,"abs-x-abs-y"],[247.5,292.5,"abs-y"],[292.5,337.5,"abs-y-x"]]),e<0?360-Math.abs(e):e),r=0,n=o;r<n.length;r++){var a=n[r],s=a[0],l=a[1],a=a[2];if(s<i&&i<=l||s<i+360&&i+360<=l)return a}return t},p.prototype.updateCursorStyles=function(e,t,o){var i,r,n=this.parent,a=!1,s=(""===n.activeObj.keyHistory||void 0!==n.activeObj.shape||n.currObjType.isCustomCrop||n.currObjType.isLine||!n.currObjType.isText||(n.activeObj.shape="text"),T.extend({},n.activeObj,{},!0));T.isNullOrUndefined(s.topLeftCircle)||((0===s.shapeDegree?n.transform.degree:n.transform.degree-s.shapeDegree)<0&&0,this.isObjSelected?"line"===s.shape||"arrow"===s.shape?a=this.updateCursorStylesForLineArrow(e,t,s):"path"===s.shape?a=this.updateCursorStylesForPath(e,t,s):s.rotatedAngle?(this.setCursorForRotatedObject(s,e,t,n.upperCanvas),"grabbing"===n.cursor?(n.upperCanvas.style.cursor=n.cursor="grabbing",this.dragElement=n.cursor):"move"===n.cursor?(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t):"default"!==n.cursor&&(a=!0,this.dragElement=n.cursor,n.currObjType.isResize=!0)):(i=this.getTransRotationPoint(s),r=s.topLeftCircle.radius,i&&e>=i.x-2*r&&e<=i.x+2*r&&t>=i.y-2*r&&t<=i.y+2*r&&"grabbing"!==this.dragElement?(n.upperCanvas.style.cursor=n.cursor="grabbing",this.dragElement=n.upperCanvas.style.cursor):e>=s.topLeftCircle.startX-2*r&&e<=s.topLeftCircle.startX+2*r&&t>=s.topLeftCircle.startY-2*r&&t<=s.topLeftCircle.startY+2*r&&"nw-resize"!==this.dragElement?(s.topLeftCircle.startX=s.topLeftCircle.startY=0,n.upperCanvas.style.cursor=n.cursor="nw-resize",a=!0,this.dragElement=n.upperCanvas.style.cursor):e>=s.topLeftCircle.startX-2*r&&e<=s.topRightCircle.startX-2*r&&t>=s.topCenterCircle.startY-2*r&&t<=s.topCenterCircle.startY+2*r&&"n-resize"!==this.dragElement?(s.topCenterCircle.startX=s.topCenterCircle.startY=0,n.upperCanvas.style.cursor=n.cursor="n-resize",a=!0,this.dragElement=n.upperCanvas.style.cursor):e>=s.topRightCircle.startX-2*r&&e<=s.topRightCircle.startX+2*r&&t>=s.topRightCircle.startY-2*r&&t<=s.topRightCircle.startY+2*r&&"ne-resize"!==this.dragElement?(s.topRightCircle.startX=s.topRightCircle.startY=0,n.upperCanvas.style.cursor=n.cursor="ne-resize",a=!0,this.dragElement=n.upperCanvas.style.cursor):e>=s.centerLeftCircle.startX-2*r&&e<=s.centerLeftCircle.startX+2*r&&t>=s.topLeftCircle.startY-2*r&&t<=s.bottomLeftCircle.startY-2*r&&"w-resize"!==this.dragElement?(s.centerLeftCircle.startX=s.centerLeftCircle.startY=0,n.upperCanvas.style.cursor=n.cursor="w-resize",a=!0,this.dragElement=n.upperCanvas.style.cursor):e>=s.centerRightCircle.startX-2*r&&e<=s.centerRightCircle.startX+2*r&&t>=s.topRightCircle.startY-2*r&&t<=s.bottomRightCircle.startY-2*r&&"e-resize"!==this.dragElement?(s.centerRightCircle.startX=s.centerRightCircle.startY=0,n.upperCanvas.style.cursor=n.cursor="e-resize",a=!0,this.dragElement=n.upperCanvas.style.cursor):e>=s.bottomLeftCircle.startX-2*r&&e<=s.bottomLeftCircle.startX+2*r&&t>=s.bottomLeftCircle.startY-2*r&&t<=s.bottomLeftCircle.startY+2*r&&"sw-resize"!==this.dragElement?(s.bottomLeftCircle.startX=s.bottomLeftCircle.startY=0,n.upperCanvas.style.cursor=n.cursor="sw-resize",a=!0,this.dragElement=n.upperCanvas.style.cursor):e>=s.bottomLeftCircle.startX-2*r&&e<=s.bottomRightCircle.startX-2*r&&t>=s.bottomCenterCircle.startY-2*r&&t<=s.bottomCenterCircle.startY+2*r&&"s-resize"!==this.dragElement?(s.bottomCenterCircle.startX=s.bottomCenterCircle.startY=0,n.upperCanvas.style.cursor=n.cursor="s-resize",a=!0,this.dragElement=n.upperCanvas.style.cursor):e>=s.bottomRightCircle.startX-2*r&&e<=s.bottomRightCircle.startX+2*r&&t>=s.bottomRightCircle.startY-2*r&&t<=s.bottomRightCircle.startY+2*r&&"se-resize"!==this.dragElement?(s.bottomRightCircle.startX=s.bottomRightCircle.startY=0,n.upperCanvas.style.cursor=n.cursor="se-resize",a=!0,this.dragElement=n.upperCanvas.style.cursor):(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t),"text"!==s.shape||"n-resize"!==n.cursor&&"s-resize"!==n.cursor&&"e-resize"!==n.cursor&&"w-resize"!==n.cursor||(n.upperCanvas.style.cursor=n.cursor="move",this.dragElement="",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t)):(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t),this.previousPoint.x=this.previousPoint.y=this.diffPoint.x=this.diffPoint.y=0,"touchstart"!==o||a||e>=s.activePoint.startX&&e<=s.activePoint.endX&&t>=s.activePoint.startY&&t<=s.activePoint.endY||"grabbing"===this.dragElement?n.currObjType.isDragging=!0:"line"===s.shape||"arrow"===s.shape?(this.setCursorForLineArrow(s,e,t,n.upperCanvas),"move"===n.cursor&&(n.currObjType.isDragging=!0)):"path"===s.shape&&(this.setCursorForPath(s,e,t,n.upperCanvas),"move"===n.cursor)&&(n.currObjType.isDragging=!0),0===s.rotatedAngle)||"e-resize"!==this.dragElement&&"w-resize"!==this.dragElement&&"n-resize"!==this.dragElement&&"s-resize"!==this.dragElement||(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t)},p.prototype.updateCursorStylesForLineArrow=function(e,t,o){for(var i,r=!1,n=this.parent,a=o.topLeftCircle.radius,s=0;s<5;s++)if(e>=(i=o.pointColl[s]).x-2*a&&e<=i.x+2*a&&t>=i.y-2*a&&t<=i.y+2*a){o.centerLeftCircle.startX=o.centerLeftCircle.startY=0,this.dragElement="w-resize",r=!0;break}if(!r)for(s=1;s<6;s++)if(e>=(i=o.pointColl[o.pointColl.length-s]).x-2*a&&e<=i.x+2*a&&t>=i.y-2*a&&t<=i.y+2*a){o.centerRightCircle.startX=o.centerRightCircle.startY=0,this.dragElement="e-resize",r=!0;break}if(!r)for(s=0;s<o.pointColl.length;s++){if(e>=(i=o.pointColl[s]).x-2*a&&e<=i.x+2*a&&t>=i.y-2*a&&t<=i.y+2*a){n.upperCanvas.style.cursor=n.cursor="move",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t;break}n.upperCanvas.style.cursor=n.cursor="default"}return r},p.prototype.updateCursorStylesForPath=function(e,t,o){var i=!1,r=this.parent;return this.pathAdjustedIndex=this.setCursorForLineArrow(o,e,t,r.upperCanvas),"move"===r.cursor&&(i=!0,this.dragElement="pathDrag"),i||(r.upperCanvas.style.cursor=r.cursor="move",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=t),i},p.prototype.setTextSelection=function(e,t){var o=this.parent,i=o.activeObj.activePoint,r=o.transform.degree,n=(r=0===o.activeObj.shapeDegree?o.transform.degree:o.transform.degree-o.activeObj.shapeDegree,o.activeObj.rotateFlipColl);if(this.isTransformedShape&&n)for(var r=0,a=0;a<n.length;a++)"number"==typeof n[a]&&(r+=n[a]);r<0&&(r=360+r);for(var a=0,s=o.activeObj.flipObjColl.length;a<s;a++){var l=o.activeObj.flipObjColl[a].toLowerCase();switch(r){case 0:switch(l){case"horizontal":i={startX:i.endX-e,startY:i.startY,endX:i.endX,endY:i.startY+(t||0)};break;case"vertical":i.startY=i.endY-t,i={startX:i.startX,startY:i.startY,endX:i.startX+(e||0),endY:i.endY};break;default:i={startX:i.startX,startY:i.startY,endX:i.startX+(e||0),endY:i.startY+(t||0)}}break;case 90:switch(l){case"horizontal":i.endX=i.startX+t,i={startX:i.startX,startY:i.startY,endX:i.endX,endY:i.startY+(e||0)};break;case"vertical":i.startX=i.endX-t,i={startX:i.startX,startY:i.endY-e,endX:i.endX,endY:i.endY};break;default:i.startX=i.endX-t,i={startX:i.startX,startY:i.startY,endX:i.endX,endY:i.startY+(e||0)}}break;case 180:switch(l){case"horizontal":i.startY=i.endY-t,i={startX:i.startX,startY:i.startY,endX:i.startX+e,endY:i.endY};break;case"vertical":i.endY=i.startY+t,i={endX:i.endX,endY:i.endY,startX:i.endX-(e||0),startY:i.startY};break;default:i={endX:i.endX,endY:i.endY,startX:i.endX-(e||0),startY:i.endY-(t||0)}}break;case 270:switch(l){case"horizontal":i.startX=i.endX-t,i={startX:i.startX,startY:i.endY-(e||0),endX:i.endX,endY:i.endY};break;case"vertical":i={startX:i.startX,startY:i.startY,endX:i.startX+t,endY:i.startY+(e||0)};break;default:i.endX=i.startX+t,i={startX:i.startX,startY:i.endY-(e||0),endX:i.endX,endY:i.endY}}}}if(0===o.activeObj.flipObjColl.length)switch(r){case 0:i={startX:i.startX,startY:i.startY,endX:i.startX+(e||0),endY:i.startY+(t||0)};break;case 90:i.startX=i.endX-t,i={startX:i.startX,startY:i.startY,endX:i.endX,endY:i.startY+(e||0)};break;case 180:i={endX:i.endX,endY:i.endY,startX:i.endX-(e||0),startY:i.endY-(t||0)};break;case 270:i.endX=i.startX+t,i={startX:i.startX,startY:i.endY-(e||0),endX:i.endX,endY:i.endY}}i.width=i.endX-i.startX,i.height=i.endY-i.startY,o.activeObj.activePoint=i,360!==o.transform.degree&&-360!==o.transform.degree||(o.transform.degree=0)},p.prototype.setActivePoint=function(e,t){var o,i,r=this.parent,n=r.activeObj.activePoint;T.isNullOrUndefined(n)||(r.currObjType.isText?(i=e||0,o=t||r.activeObj.textSettings.fontSize,void 0===r.activeObj.textSettings.fontSize&&(r.activeObj.textSettings.fontSize=.1*Math.abs(r.baseImgCanvas.width-r.baseImgCanvas.height)),this.setTextSelection(i,o),this.mouseDownPoint.x=n.endX,this.mouseDownPoint.y=n.endY,void 0!==r.activeObj.horTopLine&&(r.activeObj.activePoint=T.extend({},n,{},!0)),r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}})):e&&t?(n.startX=this.mouseDownPoint.x=e,n.startY=this.mouseDownPoint.y=t,r.currObjType.isDragging=!0):((n={startX:(i=r.activeObj).horTopLine.startX,startY:i.horTopLine.startY,endX:i.horTopLine.endX,endY:i.horTopLine.endY}).width=n.endX-n.startX,n.height=n.endY-n.startY))},p.prototype.mouseDownEventHandler=function(e){var t,o,i=this.parent;i.isKBDNavigation=!1,this.mouseDown=e.currentTarget===i.lowerCanvas||e.currentTarget===i.upperCanvas?"canvas":"","touchstart"===e.type?this.isTouch=!0:this.isTouch=!1,"touchstart"===e.type&&e.currentTarget===i.lowerCanvas&&!i.isImageLoaded||(this.isCropSelection=!1,this.isPan=!0,void 0!==(t=void 0!==i.activeObj.shape?i.activeObj.shape.split("-"):t)&&"crop"===t[0]&&(this.isCropSelection=!0),this.isCropSelection&&(this.dragCanvas=i.togglePan=!0),"grabbing"===i.cursor&&(t={shapeSettingsObj:{}},this.isGrabbing=!0,i.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:t}}),t={cancel:!(o={cancel:!1,action:"rotate-start",previousShapeSettings:t=t.shapeSettingsObj,allowShapeOverflow:this.allowOutofBound()}),action:"rotate-start",previousShapeSettings:t,allowShapeOverflow:this.allowOutofBound()},this.triggerShapeChange(o,t,"mouse-down")),o={point:this.setXYPoints(e)},i.trigger("click",o),this.isMouseDown=!0,this.isMouseUp=!1,this.clickEvent(o,e))},p.prototype.getImagePoints=function(e,t){var o=this.parent.img,i=o.destLeft,r=o.destTop,n=o.destWidth,o=o.destHeight;return e<i?e=i:i+n<e&&(e=i+n),t<r?t=r:r+o<t&&(t=r+o),{x:e,y:t}},p.prototype.clickEvent=function(e,t){var o=this.parent,i=o.activeObj.activePoint,r=e.point.x,e=e.point.y,n=o.activeObj.shape&&"text"===o.activeObj.shape?o.cursor:"default",a=o.upperCanvas.style.cursor;if(o.isResize)this.performEnterAction(t),o.upperCanvas.style.cursor="default";else{if(JSON.stringify(o.frameObj)!==JSON.stringify(o.tempFrameObj))o.okBtn();else if(""!==this.currentDrawingShape&&!this.isShapeTouch(t,this.isCropSelection)&&(this.isTouch||"crosshair"===a||o.isShapeDrawing))return o.drawingShape&&!o.isShapeDrawing&&(o.okBtn(),o.enableShapeDrawing(o.toPascalCase(o.drawingShape),!0)),i=o.activeObj.activePoint,o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(c={currObj:{}}),value:{object:c}}),this.initialPrevObj=c.currObj,this.initialPrevObj.objColl=T.extend([],o.objColl,[],!0),this.initialPrevObj.pointColl=T.extend([],o.pointColl,[],!0),this.initialPrevObj.afterCropActions=T.extend([],o.afterCropActions,[],!0),o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(c={selPointColl:null}),value:{obj:c}}),this.initialPrevObj.selPointColl=T.extend([],c.selPointColl,[],!0),this.setActivePoint(r,e),i=o.activeObj.activePoint,"path"===this.currentDrawingShape&&(l=this.getImagePoints(r,e),o.activeObj.pointColl.push({x:l.x,y:l.y}),0!==i.width)&&0!==i.height&&(i.width=0,i.height=0,i.startX=o.activeObj.pointColl[o.activeObj.pointColl.length-1].x,i.startY=o.activeObj.pointColl[o.activeObj.pointColl.length-1].y),i.endX=i.startX,i.endY=i.startY,"text"===this.currentDrawingShape?(o.activeObj.textSettings.fontSize=11,this.previousPoint.x=i.startX,this.previousPoint.y=i.startY,o.notify("shape",{prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}}),c=this.upperContext.measureText(o.activeObj.textSettings.text).width+.5*o.activeObj.textSettings.fontSize,i.endX=i.startX+c,i.endY=i.startY+o.activeObj.textSettings.fontSize,i.width=i.endX-i.startX,i.height=i.endY-i.startY):"arrow"===this.currentDrawingShape&&(o.activeObj.start=this.arrowShape[0],o.activeObj.end=this.arrowShape[1]),c={cancel:!(d={cancel:!(o.currObjType.isDragging=!0),action:"draw-start",previousShapeSettings:c=this.updatePrevShapeSettings(),allowShapeOverflow:this.allowOutofBound()}),action:"move",previousShapeSettings:c,allowShapeOverflow:this.allowOutofBound()},this.shapeResizingArgs=d,this.shapeMovingArgs=c,this.triggerShapeChange(d,c,"mouse-down"),o.activeObj.activePoint=i,o.isShapeDrawing=!0,void(this.tempActiveObj=T.extend({},o.activeObj,{},!0));o.notify("draw",{prop:"resetFrameZoom",onPropertyChange:!1,value:{isOk:!0}}),this.isCropSelection&&this.dragCanvas&&(this.setCursor(r,e),"move"!==o.cursor)&&"crosshair"!==o.cursor&&"default"!==o.cursor&&"grab"!==o.cursor&&(this.isPan=!1),o.activeObj.shape?this.isObjSelected=!0:this.isObjSelected=!1;var s,l,p,h,d={currObj:{}},c=(o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:d}}),d.currObj),i=T.extend({},o.activeObj,null,!0),d=this.isShapeTouch(t,this.isCropSelection),u=this.isFreehandDrawTouch(t,this.isCropSelection),g=d||this.isShapeClick(t,this.isCropSelection),g=this.applyCurrShape(g),v="none"!==o.textArea.style.display;this.isTouch&&!d&&i.shape&&!this.isCropSelection&&(this.applyObj(r,e)&&(o.okBtn(!0),o.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}})),i=T.extend({},o.cropObj,{},!0),o.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:c,previousObjColl:c.objColl,previousPointColl:c.pointColl,previousSelPointColl:c.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:o.isCircleCrop}}),g)&&o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),d||o.togglePen||this.isCropSelection||"blur"===o.activeObj.redactType||"pixelate"===o.activeObj.redactType||(o.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),o.notify("toolbar",{prop:"close-contextual-toolbar",onPropertyChange:!1})),!this.dragCanvas||!this.isPan||"grab"!==o.cursor&&!this.isTouch||d||u||o.togglePen?(c=!1,!o.activeObj.shape||"line"!==o.activeObj.shape&&"arrow"!==o.activeObj.shape||(c=!0),d=(i=this.setXYPoints(t)).x,u=i.y,this.applyObj(d,u)&&(o.okBtn(!0),g&&(i=o.cursor,o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),o.cursor=i),o.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}})),o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:d,y:u,isMouseDown:!0}}),o.notify("freehand-draw",{prop:"getFreehandDrawHoveredIndex",onPropertyChange:!(i={index:null}),value:{obj:i}}),o.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!(s={freehandSelectedIndex:null}),value:{obj:s}}),this.isFhdPoint||this.isFhdCustomized&&!o.togglePen?(T.isNullOrUndefined(s.freehandSelectedIndex)||s.freehandSelectedIndex===i.index||(h=i.index,o.okBtn(),this.isFhdCustomized=!1,o.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:h}}),-1<i.index&&(p=o.pointColl[i.index].strokeColor,o.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:p,strokeWidth:o.pointColl[i.index].strokeWidth}}))),s.freehandSelectedIndex=null,o.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:s}}),h=T.extend([],o.objColl,[],!0),!T.isNullOrUndefined(i.index)&&-1<i.index?(o.notify("freehand-draw",{prop:"selectFhd",value:{type:"ok"}}),o.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}),o.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:!0}})):s.freehandSelectedIndex?(o.okBtn(),p=o.pointColl[s.freehandSelectedIndex].strokeColor,o.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:p,strokeWidth:o.pointColl[s.freehandSelectedIndex].strokeWidth}})):this.findTargetObj(d,u,!1)&&(o.objColl=h,this.findTarget(d,u,t.type),o.notify("draw",{prop:"redrawDownScale"}))):(this.isFhdEditing&&(o.apply(),(i=document.getElementById(o.element.id+"_quickAccessToolbarArea"))&&(i.style.display="none"),l=o.pointColl[s.freehandSelectedIndex],p={id:"pen_"+(s.freehandSelectedIndex+1),type:m.ShapeType.FreehandDraw,startX:l.points[0].x,startY:l.points[0].y,strokeColor:l.strokeColor,strokeWidth:l.strokeWidth,points:l.points,opacity:l.opacity,index:l.order},h={action:"apply",currentShapeSettings:T.extend({},p,{},!0)},o.trigger("shapeChange",h),o.editCompleteArgs=h),i=o.togglePen,o.notify("toolbar",{prop:"close-contextual-toolbar",onPropertyChange:!1}),i&&o.freeHandDraw(!0),this.isFhdEditing=!1,c?this.setCursor(d,u):"default"!==n&&(o.upperCanvas.style.cursor=o.cursor=n),("crosshair"===o.cursor||T.Browser.isDevice&&o.togglePen)&&(o.togglePen?(T.isNullOrUndefined(o.activeObj.strokeSettings)&&(o.notify("shape",{prop:"getStrokeSettings",onPropertyChange:!(s={strokeSettings:{}}),value:{obj:s}}),o.activeObj.strokeSettings=s.strokeSettings),o.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!(l={penStrokeWidth:null}),value:{obj:l}}),T.isNullOrUndefined(l.penStrokeWidth)&&o.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:2}}),this.upperContext.strokeStyle=o.activeObj.strokeSettings.strokeColor,this.upperContext.fillStyle=o.activeObj.strokeSettings.strokeColor,o.notify("freehand-draw",{prop:"resetSelPoints",onPropertyChange:!1}),o.notify("freehand-draw",{prop:"freehandDownHandler",onPropertyChange:!1,value:{e:t,canvas:o.upperCanvas}})):(o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height)),o.currObjType.isActiveObj=!1,this.dragElement="",this.dragPoint.startX=this.dragPoint.startY=this.dragPoint.endX=this.dragPoint.endY=0),(this.isTouch&&"crosshair"!==a||"crosshair"!==o.cursor)&&"touchstart"===t.type.toLowerCase()||o.currObjType.isActiveObj&&"default"!==o.cursor&&!o.togglePen?(o.notify("draw",{prop:"updateTempObjColl"}),o.notify("draw",{prop:"updateTempPointColl"}),this.findTarget(d,u,t.type),o.notify("draw",{prop:"redrawDownScale"})):""!==o.currObjType.shape&&!o.currObjType.isCustomCrop||o.togglePen||"default"===o.cursor||this.setActivePoint(d,u),v&&o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}))):(this.applyObj(r,e)&&(o.okBtn(!0),g&&(p=o.cursor,o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),o.cursor=p),o.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}})),this.isFhdEditing&&(o.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.isFhdCustomized=!1,o.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1})),(h=o.activeObj.shape)&&-1<["rectangle","ellipse","line","arrow","path","text","image","redact"].indexOf(h)&&(o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),o.notify("toolbar",{prop:"setCurrentToolbar",value:{type:"main"}}),o.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})),i=!1,o.activeObj.shape&&-1<o.activeObj.shape.indexOf("crop-")&&(i=!0),!o.element.querySelector(".e-contextual-toolbar-wrapper")||i||o.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")||(o.okBtn(),o.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide")),this.canvasMouseDownHandler(t)),this.isShapeInserted=!1,this.tempActiveObj=T.extend({},o.activeObj,{},!0)}},p.prototype.mouseMoveEventHandler=function(e){var t=this.parent,o=t.cursor,i=t.upperCanvas.style.cursor;if(e.preventDefault(),!(this.isPreventShaping||t.isShapeDrawing&&t.currObjType.isDragging&&this.isTouch&&t.activeObj.shape&&"path"===t.activeObj.shape)){"grabbing"===t.cursor&&this.isGrabbing&&(t.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!(h={shapeSettingsObj:{}}),value:{obj:h}}),h={cancel:!(r={cancel:!1,action:"rotating",previousShapeSettings:h=h.shapeSettingsObj,allowShapeOverflow:this.allowOutofBound()}),action:"rotating",previousShapeSettings:h,allowShapeOverflow:this.allowOutofBound()},this.triggerShapeChange(r,h,"mouse-down")),this.timer&&0<this.timer&&this.dragPoint.startX&&this.dragPoint.startY&&(r=Math.abs(this.dragPoint.startX-e.touches[0].clientX),h=Math.abs(this.dragPoint.startY-e.touches[0].clientY),10<r||10<h)&&(this.timer=0);var r=t.lowerCanvas.getBoundingClientRect();if("touchmove"===e.type&&2===e.touches.length)this.isFirstMove?(this.startTouches=this.targetTouches(e.touches),this.tempTouches=[],this.tempTouches.push({x:e.touches[0].clientX||e.touches[0].pageX-t.lowerCanvas.offsetLeft-r.left,y:(e.touches[0].clientY||e.touches[0].pageY-t.lowerCanvas.offsetTop)-r.top}),this.tempTouches.push({x:(e.touches[1].clientX||e.touches[1].pageX-t.lowerCanvas.offsetLeft)-r.left,y:(e.touches[1].clientY||e.touches[1].pageY-t.lowerCanvas.offsetTop)-r.top})):(h=(e.touches[0].clientX||e.touches[0].pageX-t.lowerCanvas.offsetLeft)-r.left,l=(e.touches[0].clientY||e.touches[0].pageY-t.lowerCanvas.offsetTop)-r.top,p=(e.touches[1].clientX||e.touches[1].pageX-t.lowerCanvas.offsetLeft)-r.left,s=(e.touches[1].clientY||e.touches[1].pageY-t.lowerCanvas.offsetTop)-r.top,this.currMousePoint.x!==(h={x:h<p?p-(p-h)/2:h-(h-p)/2,y:l<s?s-(s-l)/2:l-(l-s)/2}).x&&this.currMousePoint.y!==h.y&&(p="","touchmove"===e.type&&(t.zoomSettings.zoomTrigger&m.ZoomTrigger.Pinch)===m.ZoomTrigger.Pinch&&(this.zoomType="Pinch",l=this.calculateScale(this.startTouches,this.targetTouches(e.touches)),this.startTouches=this.targetTouches(e.touches),1<l?p="zoomIn":l<1&&(p="zoomOut")),""!==p&&(t.isZoomBtnClick=!0,t.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:h.x,y:h.y,type:p,isResize:null}})),this.tempTouches=[],this.tempTouches.push({x:e.touches[0].clientX||e.touches[0].pageX-t.lowerCanvas.offsetLeft,y:e.touches[0].clientY||e.touches[0].pageY-t.lowerCanvas.offsetTop}),this.tempTouches.push({x:e.touches[1].clientX||e.touches[1].pageX-t.lowerCanvas.offsetLeft,y:e.touches[1].clientY||e.touches[1].pageY-t.lowerCanvas.offsetTop}),this.currMousePoint.x=h.x,this.currMousePoint.y=h.y,this.isPinching=!0)),this.isFirstMove=!1;else{"mousemove"===e.type?(n=e.clientX,a=e.clientY):(this.touchEndPoint.x=n=e.touches[0].clientX,this.touchEndPoint.y=a=e.touches[0].clientY),n-=r.left,a-=r.top,this.canvasMouseMoveHandler(e);var n,a,s=!1,l=((s=void 0!==(d=void 0!==t.activeObj.shape?t.activeObj.shape.split("-"):d)&&"crop"===d[0]?!0:s)&&t.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),t.upperCanvas.style.cursor=i,t.cursor=o,(t.currObjType.isActiveObj&&(void 0!==t.activeObj.activePoint||0<t.objColl.length)&&!this.dragCanvas||void 0!==t.activeObj.activePoint)&&""===this.dragElement&&(this.setCursor(n,a),t.activeObj.activePoint&&(0===t.activeObj.activePoint.width||!T.isNullOrUndefined(t.activeObj.currIndex)&&this.cursorTargetId!==t.activeObj.currIndex)&&"default"!==t.cursor&&"move"!==t.cursor&&"crosshair"!==t.cursor&&"grab"!==t.cursor&&"pointer"!==t.cursor&&(t.upperCanvas.style.cursor=t.cursor="move"),this.findTarget(n,a,e.type)),t.img),p=l.destLeft,h=l.destTop,r=l.destWidth,d=l.destHeight;if(t.currObjType.isDragging){if(t.activeObj.shape&&t.activeObj.preventShapeDragOut&&(n<p||p+r<n||a<h||h+d<a))return;this.upperContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.updateActivePoint(n,a,s),t.notify("shape",{prop:"updateTrianglePoints",onPropertyChange:!1,value:{obj:t.activeObj}}),this.isPreventDragging?(this.isShapeDragOut()||(this.isPreventDragging=!1),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}})):t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:null,saveContext:null,isPreventSelection:null}}),s&&(this.dragCanvas=t.togglePan=!0)}this.isMouseDown=!1,this.isMouseUp=!1}}},p.prototype.mouseUpEventHandler=function(e){var t=this.parent,o=t.element.id;if(t.isKBDNavigation=this.isMouseDown=!1,this.isMouseUp=!0,T.Browser.isDevice||!(t.element.querySelector("#"+o+"_contextualToolbar")&&!t.element.querySelector("#"+o+"_contextualToolbar").parentElement.classList.contains("e-hide")||t.element.querySelector("#"+o+"_headWrapper")&&!t.element.querySelector("#"+o+"_headWrapper").parentElement.classList.contains("e-hide"))||t.activeObj.shape&&"redact"===t.activeObj.shape&&t.isShapeDrawing){if("grabbing"===t.cursor&&this.isGrabbing&&(t.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!(C={shapeSettingsObj:{}}),value:{obj:C}}),h={cancel:!(u={cancel:!1,action:"rotate-end",previousShapeSettings:o=C.shapeSettingsObj,allowShapeOverflow:this.allowOutofBound()}),action:"rotate-end",previousShapeSettings:o,allowShapeOverflow:this.allowOutofBound()},this.triggerShapeChange(u,h,"mouse-up")),this.isGrabbing=!1,this.isPreventShaping&&(this.isPreventShaping=!1),"canvas"===this.mouseDown||this.isSliderActive||e.target.closest(".e-image-editor")||e.target.closest(".e-ie-ddb-popup")){"touchstart"===e.type?this.isTouch=!1:"touchend"===e.type&&e.stopImmediatePropagation(),e.preventDefault(),t.togglePan&&this.canvasMouseUpHandler(e);var o=void 0,i=void 0,r=("mouseup"===e.type?(o=e.clientX,i=e.clientY):this.isTouchDblClick||(o=this.touchEndPoint.x,i=this.touchEndPoint.y),t.lowerCanvas.getBoundingClientRect()),r=(o-=r.left,i-=r.top,void 0),n=this.currentDrawingShape,a=!1;if("touchend"===e.type&&(this.startTouches=this.tempTouches=[],this.isFirstMove=!1,"none"===t.textArea.style.display&&(this.timer=0),this.isPinching))return this.isPinching=!1,t.notify("draw",{prop:"redrawDownScale"}),(t.isCropTab||t.activeObj.shape)&&(t.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),t.notify("freehand-draw",{prop:"resetStraightenPoint"})),void(t.isStraightening&&(t.notify("draw",{prop:"resetStraightenDestPoints"}),t.notify("draw",{prop:"setDestForStraighten"})));var s,l,p,h,d,c,u,g,v=!1,f=void 0;if(void 0!==(f=void 0!==t.activeObj.shape?t.activeObj.shape.split("-"):f)&&"crop"===f[0]&&(v=!0),"path"===this.currentDrawingShape&&t.isShapeDrawing)return s=(l=e.srcElement).parentElement.id,p=t.element.id,e.currentTarget!==t.upperCanvas&&e.currentTarget!==t.lowerCanvas&&0<t.activeObj.pointColl.length&&(l.classList.contains("e-upload-icon")||s===p+"_zoomIn"||s===p+"_zoomOut"||s===p+"_annotationBtn"||s===p+"_borderColorBtn"||s===p+"_borderWidthBtn")&&(t.notify("shape",{prop:"stopPathDrawing",onPropertyChange:!1,value:{e:e,isApply:!0}}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:!0}})),void(t.currObjType.isDragging&&this.isTouch&&t.activeObj.shape&&"path"===t.activeObj.shape&&(this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:!0}})));e.currentTarget!==t.upperCanvas||t.isResize||(this.pathAdjustedIndex=null,""!==this.currentDrawingShape&&("text"===this.currentDrawingShape?(l=T.extend({},t.cropObj,{},!0),t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeInsert",previousObj:this.initialPrevObj,previousObjColl:this.initialPrevObj.objColl,previousPointColl:this.initialPrevObj.pointColl,previousSelPointColl:this.initialPrevObj.selPointColl,previousCropObj:l,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})):t.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:this.initialPrevObj.objColl,operation:"shapeInsert"}}),this.isShapeInserted=!0,this.currentDrawingShape="",(t.activeObj.shape&&"path"===t.activeObj.shape&&0===t.activeObj.pointColl.length||(!t.activeObj.shape||"path"!==t.activeObj.shape)&&0===t.activeObj.activePoint.width&&0===t.activeObj.activePoint.height)&&(t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!(a=!0)}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height)),h={cancel:!(u={cancel:!1,action:"draw-end",previousShapeSettings:c=this.updatePrevShapeSettings()}),action:"move",previousShapeSettings:c},this.shapeResizingArgs=u,this.shapeMovingArgs=h,this.triggerShapeChange(u,h,"mouse-up")),t.activeObj.shape&&"path"===t.activeObj.shape&&0<t.activeObj.pointColl.length&&(t.activeObj.activePoint=t.getSquarePointForPath(t.activeObj)),this.adjustActObjForLineArrow(),this.updPtCollForShpRot(),t.currObjType.shape=t.currObjType.shape.toLowerCase(),s=T.extend({},t.cropObj,{},!0),t.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(p={currObj:{}}),value:{object:p}}),(l=p.currObj).objColl=T.extend([],t.objColl,[],!0),l.pointColl=T.extend([],t.pointColl,[],!0),l.afterCropActions=T.extend([],t.afterCropActions,[],!0),t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(h={selPointColl:null}),value:{obj:h}}),l.selPointColl=T.extend([],h.selPointColl,[],!0),t.togglePen||v?v&&this.isMouseUp&&-1<t.cursor.indexOf("resize")&&(u={cancel:!1,action:"resize-end",previousShapeSettings:c=this.updatePrevShapeSettings()},this.triggerShapeChange(u,u,"resize")):(this.tempObjColl&&0!==t.activeObj.activePoint.width&&(t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl.push(t.activeObj),JSON.stringify(t.activeObj.activePoint)!==JSON.stringify(this.tempActiveObj.activePoint)&&t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:l,previousObjColl:this.tempObjColl,previousPointColl:l.pointColl,previousSelPointColl:l.selPointColl,previousCropObj:s,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),p=T.extend({},t.objColl[t.objColl.length-1],{},!0),t.objColl.pop(),this.redrawShape(p),this.tempObjColl=void 0),this.isFhdEditing||(this.applyCurrActObj(o,i),t.currObjType.isResize=!1,t.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}))),t.activeObj&&(h=!1,(void 0===(d=void 0!==t.activeObj.shape?t.activeObj.shape.split("-"):d)&&(t.currObjType.isCustomCrop||t.togglePen)||void 0!==d&&"crop"===d[0])&&(h=!0),c=t.activeObj.shape,-1<["rectangle","ellipse","line","arrow","path"].indexOf(r=c)?t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):"text"===c?"none"===t.textArea.style.display&&t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):"redact"===c?t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"redact",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):this.isFhdEditing?t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"pen",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):h||t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:!1,isZooming:null}}),t.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),this.isFhdEditing||(u=Math.floor(t.activeObj.activePoint.width),t.activeObj.shape&&"text"===t.activeObj.shape&&11===t.activeObj.textSettings.fontSize&&11===Math.floor(t.activeObj.activePoint.height)&&(55===u||t.activeObj.textSettings.bold&&58===u)&&(t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),"text"!==t.drawingShape||t.activeObj.keyHistory||(t.activeObj.keyHistory="Enter Text")),h)||(this.adjustActObjForLineArrow(),t.isShapeDrawing?(g=this.currentDrawingShape,t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1}),this.currentDrawingShape=g):t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})))),void 0!==(f=void 0!==t.activeObj.shape?t.activeObj.shape.split("-"):f)&&"crop"===f[0]&&(v=!0),t.activeObj.shape&&!v&&e.currentTarget===t.upperCanvas&&"none"===t.textArea.style.display&&("text"===t.activeObj.shape?t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):"redact"===t.activeObj.shape?t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"redact",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):(g=this.currentDrawingShape,this.currentDrawingShape="",t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),this.currentDrawingShape=g),t.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),t.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}));var C={freehandDrawSelectedId:null};t.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:C}}),t.togglePen&&e.currentTarget===t.upperCanvas&&!C.freehandDrawSelectedId?(t.notify("freehand-draw",{prop:"freehandUpHandler",onPropertyChange:!1,value:{e:e,canvas:t.upperCanvas,context:this.upperContext}}),t.togglePen&&!t.isMaskImage&&(T.isNullOrUndefined(t.toolbar)||t.toolbar&&0<t.toolbar.length||!T.isNullOrUndefined(t.toolbarTemplate))&&(t.okBtn(),t.freeHandDraw(!0))):t.currObjType.shape="",this.dragElement="",this.mouseDown="",this.isSliderActive=!1,t.currObjType.isInitialLine=t.currObjType.isDragging=!1,this.selMouseUpEvent(),T.isNullOrUndefined(t.drawingShape)&&r&&""!==n&&(t.drawingShape=r),t.drawingShape&&(this.currentDrawingShape=t.drawingShape.toLowerCase(),a)&&(t.enableShapeDrawing(t.toPascalCase(t.drawingShape),!0),t.upperCanvas.style.cursor="crosshair"),t.isShapeDrawing=!1,t.notify("freehand-draw",{prop:"resetSelPoints",onPropertyChange:!1})}this.isMouseUp=!1}},p.prototype.adjustActObjForLineArrow=function(e){var t=!1,o=this.parent;if((e=e||o.activeObj).shape&&("line"===e.shape||"arrow"===o.activeObj.shape)){var i;if(("e-resize"===this.dragElement&&e.activePoint.endX<e.activePoint.startX||"w-resize"===this.dragElement&&e.activePoint.startX>e.activePoint.endX)&&(t=!0,i=e.activePoint.startX,e.activePoint.startX=e.activePoint.endX,e.activePoint.endX=i,i=e.activePoint.startY,e.activePoint.startY=e.activePoint.endY,e.activePoint.endY=i),e.activePoint.width=Math.abs(e.activePoint.endX-e.activePoint.startX),e.activePoint.height=Math.abs(e.activePoint.endY-e.activePoint.startY),"path"!==o.activeObj.shape){o.notify("shape",{prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:e}});for(var r=0;r<e.pointColl.length;r++)e.pointColl[r].ratioX=(e.pointColl[r].x-o.img.destLeft)/o.img.destWidth,e.pointColl[r].ratioY=(e.pointColl[r].y-o.img.destTop)/o.img.destHeight}}return t},p.prototype.updPtCollForShpRot=function(e){var t,o,i,r,n,a,s=this.parent;(e=e||s.activeObj).shape&&0!==e.rotatedAngle&&(s.notify("shape",{prop:"setPointCollForShapeRotation",onPropertyChange:!1,value:{obj:e}}),s=s.img,t=s.destLeft,o=s.destTop,i=s.destWidth,r=s.destHeight,s=e.horTopLinePointColl,n=e.horBottomLinePointColl,a=e.verLeftLinePointColl,e=e.verRightLinePointColl,s.forEach(s=function(e){e.ratioX=(e.x-t)/i,e.ratioY=(e.y-o)/r}),n.forEach(s),a.forEach(s),e.forEach(s))},p.prototype.setXYPoints=function(e){e.preventDefault(),"mousedown"===e.type?(t=e.clientX,o=e.clientY):(this.touchEndPoint.x=t=e.touches[0].clientX,this.touchEndPoint.y=o=e.touches[0].clientY);var t,o,e=this.parent.lowerCanvas.getBoundingClientRect();return{x:t-=e.left,y:o-=e.top}},p.prototype.getCurrentIndex=function(){for(var e,t=this.parent,o=0,i=t.objColl.length;o<i;o++)if(t.activeObj.currIndex===t.objColl[o].currIndex){e=o;break}return e},p.prototype.isShapeClick=function(e,t){var o,i,r,n,a=this.parent,s=!1;return a.togglePen||a.activeObj.shape&&"text"===a.activeObj.shape&&this.isShapeInserted&&(o="block"===a.textArea.style.display||"inline-block"===a.textArea.style.display,i=T.extend({},a.activeObj,null,!0),a.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),r=(e=this.setXYPoints(e)).x,e=e.y,s=this.findTargetObj(r,e,t),t||(this.upperContext.clearRect(0,0,a.upperCanvas.width,a.upperCanvas.height),s&&a.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}})),o?(a.textArea.value=a.objColl[a.objColl.length-1].keyHistory,a.textArea.style.display="block",a.activeObj=i,n=this.getCurrentIndex(),T.isNullOrUndefined(n)?a.objColl.pop():a.objColl.splice(n,1)):!s&&i.shape&&(a.activeObj=i,n=this.getCurrentIndex(),T.isNullOrUndefined(n)||JSON.stringify(a.activeObj.activePoint)!==JSON.stringify(a.objColl[n].activePoint)?T.isNullOrUndefined(a.activeObj.currIndex)&&a.objColl.pop():a.objColl.splice(n,1))),s},p.prototype.isShapeTouch=function(e,t){var o,i,r,n,a=this.parent,s=!1;return"touchstart"!==e.type||a.togglePen||(a.activeObj&&"text"===a.activeObj.shape&&(this.timer=setTimeout(this.setTimer.bind(this),1e3,e)),o="block"===a.textArea.style.display||"inline-block"===a.textArea.style.display,i=T.extend({},a.activeObj,null,!0),a.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),r=(e=this.setXYPoints(e)).x,e=e.y,s=this.findTargetObj(r,e,t),t||this.upperContext.clearRect(0,0,a.upperCanvas.width,a.upperCanvas.height),o?(a.textArea.value=a.objColl[a.objColl.length-1].keyHistory,a.textArea.style.display="block",a.activeObj=i,n=this.getCurrentIndex(),T.isNullOrUndefined(n)?a.objColl.pop():a.objColl.splice(n,1)):!s&&i.shape&&(0!==i.activePoint.width||0!==i.activePoint.height||"path"===i.shape&&0<i.pointColl.length)&&(a.activeObj=i,n=this.getCurrentIndex(),t||(T.isNullOrUndefined(n)||JSON.stringify(a.activeObj.activePoint)!==JSON.stringify(a.objColl[n].activePoint)?T.isNullOrUndefined(a.activeObj.currIndex)&&a.objColl.pop():a.objColl.splice(n,1)))),s},p.prototype.isFreehandDrawTouch=function(e,t){var o,i,r,n,a=this.parent,s=!1;return"touchstart"!==e.type||t||a.togglePen||(o="block"===a.textArea.style.display||"inline-block"===a.textArea.style.display,i=T.extend({},a.activeObj,null,!0),a.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),r=(e=this.setXYPoints(e)).x,e=e.y,this.setCursor(r,e),this.isFhdPoint&&(s=!0),o?(a.textArea.value=a.objColl[a.objColl.length-1].keyHistory,a.textArea.style.display="block",a.activeObj=i,n=this.getCurrentIndex(),T.isNullOrUndefined(n)?a.objColl.pop():a.objColl.splice(n,1)):i.shape&&(a.activeObj=i,n=this.getCurrentIndex(),t||(T.isNullOrUndefined(n)||JSON.stringify(a.activeObj.activePoint)!==JSON.stringify(a.objColl[n].activePoint)?T.isNullOrUndefined(a.activeObj.currIndex)&&a.objColl.pop():a.objColl.splice(n,1)))),s},p.prototype.applyObj=function(e,t){var o,i,r,n,a=this.parent,s=!1;return(0!==a.activeObj.activePoint.width||0!==a.activeObj.activePoint.height)&&(n=(r=a.activeObj.activePoint).startX,o=r.startY,i=r.endX,r=r.endY,a.activeObj.shape&&-1<["rectangle","ellipse","line","arrow","path","image","text"].indexOf(a.activeObj.shape)?!(n-2*(n=a.activeObj.topLeftCircle.radius)<=e&&e<=i+2*n&&o-2*n<=t&&t<=r+2*n||"default"!==a.upperCanvas.style.cursor&&"grab"!==a.upperCanvas.style.cursor&&"crosshair"!==a.upperCanvas.style.cursor&&"pointer"!==a.upperCanvas.style.cursor&&"move"!==a.upperCanvas.style.cursor):s)},p.prototype.applyCurrShape=function(e){var t,o=this.parent,i=!1;return o.togglePen||(t=T.extend({},o.activeObj,null,!0),this.isShapeInserted&&"text"===o.activeObj.shape&&e&&(this.isInitialTextEdited=!0,o.notify("draw",{prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!0}})),"block"===o.textArea.style.display||"inline-block"===o.textArea.style.display?(e=T.extend({},o.activeObj,null,!0),o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),t=T.extend({},o.objColl[o.objColl.length-1],null,!0),o.objColl.pop(),o.activeObj=T.extend({},e,null,!0),o.textArea.value=t.keyHistory,o.textArea.style.display="block",(e=t.strokeSettings&&t.strokeSettings.strokeColor?"rgb"===t.strokeSettings.strokeColor.split("(")[0]?this.rgbToHex(parseFloat(t.strokeSettings.strokeColor.split("(")[1].split(",")[0]),parseFloat(t.strokeSettings.strokeColor.split("(")[1].split(",")[1]),parseFloat(t.strokeSettings.strokeColor.split("(")[1].split(",")[2]),parseFloat(t.strokeSettings.strokeColor.split("(")[1].split(",")[3])):t.strokeSettings.strokeColor:null)&&"#ffffff"===e&&(e="#fff"),this.tempActiveObj.strokeSettings&&this.tempActiveObj.strokeSettings.strokeColor&&"#ffffff"===this.tempActiveObj.strokeSettings.strokeColor&&(this.tempActiveObj.strokeSettings.strokeColor="#fff"),(t.keyHistory!==this.tempActiveObj.keyHistory||e&&e!==this.tempActiveObj.strokeSettings.strokeColor||t.textSettings&&t.textSettings.fontFamily!==this.tempActiveObj.textSettings.fontFamily||t.textSettings&&Math.round(t.textSettings.fontSize)!==Math.round(this.tempActiveObj.textSettings.fontSize)||t.textSettings&&Math.round(t.textSettings.fontRatio)!==Math.round(this.tempActiveObj.textSettings.fontRatio)||t.textSettings&&t.textSettings.bold!==this.tempActiveObj.textSettings.bold||t.textSettings&&t.textSettings.italic!==this.tempActiveObj.textSettings.italic||t.textSettings&&t.textSettings.underline!==this.tempActiveObj.textSettings.underline)&&(i=!0),this.isInitialTextEdited&&!i&&(this.isInitialTextEdited=!(i=!0))):(this.tempActiveObj.activePoint.height=Math.abs(this.tempActiveObj.activePoint.height),i=JSON.stringify(t)!==JSON.stringify(this.tempActiveObj))),i},p.prototype.canvasMouseDownHandler=function(e){var t,o=this.parent,i=(e.preventDefault(),e="mousedown"===e.type?(t=e.offsetX||e.pageX-o.lowerCanvas.offsetLeft,e.offsetY||e.pageY-o.lowerCanvas.offsetTop):(t=e.touches[0].clientX||e.touches[0].pageX-o.lowerCanvas.offsetLeft,e.touches[0].clientY||e.touches[0].pageY-o.lowerCanvas.offsetTop),o.lowerCanvas.getBoundingClientRect()),i=(t-=i.left,e-=i.top,this.panDown={x:t,y:e},{tempPanMove:null});o.notify("transform",{prop:"getTempPanMove",onPropertyChange:!1,value:{obj:i}}),T.isNullOrUndefined(i.tempPanMove)&&o.notify("transform",{prop:"setTempPanMove",onPropertyChange:!1,value:{point:{x:t,y:e}}})},p.prototype.canvasMouseMoveHandler=function(e){var t,o=this.parent,i={bool:null};o.notify("toolbar",{prop:"getFrameToolbar",onPropertyChange:!1,value:{obj:i}}),o.isResize||i.bool?o.upperCanvas.style.cursor="default":(this.dragCanvas?o.lowerCanvas.style.cursor="grab":(this.dragCanvas=o.togglePan=!1,o.lowerCanvas.style.cursor=o.upperCanvas.style.cursor=o.cursor="default"),i="mousemove"===e.type?(t=e.offsetX,e.offsetY):(t=e.touches[0].clientX||e.touches[0].pageX-o.lowerCanvas.offsetLeft,e.touches[0].clientY||e.touches[0].pageY-o.lowerCanvas.offsetTop),e=o.lowerCanvas.getBoundingClientRect(),t-=e.left,i-=e.top,o.notify("transform",{prop:"setPanMove",onPropertyChange:!1,value:{point:{x:t,y:i}}}),this.panDown&&o.togglePan&&this.dragCanvas&&((o.isCropTab||o.activeObj.shape)&&(o.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),o.notify("freehand-draw",{prop:"resetStraightenPoint"})),o.notify("transform",{prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:null,yDiff:null}})))},p.prototype.canvasMouseUpHandler=function(e){var t=this.parent,e=(e.preventDefault(),{panMove:null});t.notify("transform",{prop:"getPanMove",onPropertyChange:!1,value:{obj:e}}),t.togglePan&&this.panDown&&e.panMove&&t.togglePan&&this.dragCanvas&&(this.panDown=null,t.notify("transform",{prop:"setPanMove",onPropertyChange:!1,value:{point:null}})),t.notify("transform",{prop:"setTempPanMove",onPropertyChange:!1,value:{point:null}}),"path"!==this.currentDrawingShape&&(t.currObjType.isDragging=!1)},p.prototype.touchStartHandler=function(e){e.preventDefault();var t=this.parent;if(0===this.touchTime)this.touchTime=(new Date).getTime();else if((new Date).getTime()-this.touchTime<400){this.isTouchDblClick=!0;var o=t.isShapeDrawing;if(t.notify("shape",{prop:"stopPathDrawing",onPropertyChange:!1,value:{e:e,isApply:null}}),this.isTouchDblClick=!1,this.touchTime=0,o!==t.isShapeDrawing&&t.activeObj.shape&&"path"===t.activeObj.shape)return}else this.touchTime=(new Date).getTime();2===e.touches.length?this.isFirstMove=!0:this.mouseDownEventHandler(e),T.EventHandler.add(t.lowerCanvas,"touchend",this.mouseUpEventHandler,this),T.EventHandler.add(t.lowerCanvas,"touchmove",this.mouseMoveEventHandler,this),T.EventHandler.add(t.upperCanvas,"touchend",this.mouseUpEventHandler,this),T.EventHandler.add(t.upperCanvas,"touchmove",this.mouseMoveEventHandler,this)},p.prototype.unwireEvent=function(){var e=this.parent;T.EventHandler.remove(e.lowerCanvas,"touchend",this.mouseUpEventHandler),T.EventHandler.remove(e.lowerCanvas,"touchmove",this.mouseMoveEventHandler),T.EventHandler.remove(e.upperCanvas,"touchend",this.mouseUpEventHandler),T.EventHandler.remove(e.upperCanvas,"touchmove",this.mouseMoveEventHandler)},p.prototype.keyDownEventHandler=function(e){var t=this.parent,o=(!e.ctrlKey||"+"!==e.key&&"-"!==e.key||e.preventDefault(),{fileName:"",fileType:null}),i=(t.notify("draw",{prop:"getFileName",onPropertyChange:!1,value:{obj:o}}),{fileName:o.fileName,fileType:o.fileType,cancel:!1});switch(e.key){case e.ctrlKey&&"s":t.trigger("beforeSave",i),this.beforeSaveEvent(i,e);break;case e.ctrlKey&&"z":t.allowUndoRedo&&(t.noPushUndo=!1,(t.togglePen||t.drawingShape)&&(t.okBtn(),t.drawingShape=null),t.notify("undo-redo",{prop:"call-undo"}));break;case e.ctrlKey&&"y":t.allowUndoRedo&&(t.noPushUndo=!1,(t.togglePen||t.drawingShape)&&(t.okBtn(),t.drawingShape=null),t.notify("undo-redo",{prop:"call-redo"}));break;case e.ctrlKey&&"+":(t.zoomSettings.zoomTrigger&m.ZoomTrigger.Commands)===m.ZoomTrigger.Commands&&(this.zoomType="Commands",t.isZoomBtnClick=!0,t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null},isResize:null}),t.notify("draw",{prop:"redrawDownScale"}),(t.isCropTab||t.activeObj.shape)&&(t.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),t.notify("freehand-draw",{prop:"resetStraightenPoint"})),t.isStraightening)&&(t.notify("draw",{prop:"resetStraightenDestPoints"}),t.notify("draw",{prop:"setDestForStraighten"}));break;case e.ctrlKey&&"-":(t.zoomSettings.zoomTrigger&m.ZoomTrigger.Commands)===m.ZoomTrigger.Commands&&(this.zoomType="Commands",t.isZoomBtnClick=!0,t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null},isResize:null}),t.notify("draw",{prop:"redrawDownScale"}),(t.isCropTab||t.activeObj.shape)&&(t.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),t.notify("freehand-draw",{prop:"resetStraightenPoint"})),t.isStraightening)&&(t.notify("draw",{prop:"resetStraightenDestPoints"}),t.notify("draw",{prop:"setDestForStraighten"}));break;case"Delete":this.deleteItem();break;case"Escape":t.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null,isFinalCancel:!0}});break;case"Enter":this.performEnterAction(e);break;case"Tab":this.performTabAction();break;default:!T.Browser.isDevice||"block"!==t.textArea.style.display&&"inline-block"!==t.textArea.style.display||setTimeout(this.textKeyDown.bind(this),1,e)}},p.prototype.performEnterAction=function(e){var t,o,i,r,n,a=this.parent;a.isResize?(t=!!((t=e.target).id.indexOf("aspectratio")||-1<t.id.indexOf("non-aspectratio")),this.isValueUpdated()&&(o=this.getNumTextValue(),r=a.element.querySelector("#"+a.element.id+"_aspectratio"),n=a.element.querySelector(".e-ie-toolbar-aspect-ratio-btn"),o&&o.x&&o.y&&(r||n&&!n.classList.contains("e-hidden")?a.notify("transform",{prop:"resize",value:{width:o.x,height:null,isAspectRatio:!0}}):a.notify("transform",{prop:"resize",value:{width:o.x,height:o.y,isAspectRatio:!1}})),n=a.element.querySelector("#"+a.element.id+"_resizeHeight"),o=a.element.querySelector("#"+a.element.id+"_resizeWidth"),T.isNullOrUndefined(r)&&(n&&(i=T.getComponent(n,"numerictextbox"),n)&&""===n.value&&(i.value=parseFloat(i.placeholder),n.value=i.placeholder+"px"),o)&&(i=T.getComponent(o,"numerictextbox"),o)&&""===o.value&&(i.value=parseFloat(i.placeholder),o.value=i.placeholder+"px"),a.notify("draw",{prop:"redrawDownScale"})),t&&this.focusRatioBtn()):e.target.classList.contains("e-upload")?(r=a.element.querySelector(".e-image-upload"))&&r.querySelector(".e-tbar-btn")&&r.querySelector(".e-tbar-btn").click():e.target.classList.contains("filter-wrapper")?e.target.parentElement.click():(n=void 0,a.activeObj.shape&&(n=a.activeObj.shape.split("-")),e&&this.isKeyBoardCrop(e)&&a.activeObj.horTopLine&&a.activeObj.shape&&"crop"===n[0]&&a.crop())},p.prototype.focusRatioBtn=function(){var e=this.parent.element.id;this.parent.isKBDNavigation&&setTimeout(function(){document.getElementById(e+"_aspectratio")?document.getElementById(e+"_aspectratio").focus():document.getElementById(e+"_nonaspectratio")&&document.getElementById(e+"_nonaspectratio").focus()},50)},p.prototype.isKeyBoardCrop=function(e){var t=!1,e=e.target;return t=e.id!==this.parent.element.id+"_ok"&&""!==e.id?t:!0},p.prototype.beforeSaveEvent=function(e,t){var o=this.parent;e.cancel||o.notify("export",{prop:"export",onPropertyChange:!1,value:{type:e.fileType,fileName:e.fileName}}),t.preventDefault(),t.stopImmediatePropagation()},p.prototype.handleScroll=function(e){this.mouseWheel++;var t,o,i=this.parent,r=!1,n=("mousewheel"===e.type&&(t=e.clientX,o=e.clientY),i.lowerCanvas.getBoundingClientRect());t-=n.left,o-=n.top,t>i.img.destLeft&&t<i.img.destLeft+i.img.destWidth&&o>i.img.destTop&&o<i.img.destTop+i.img.destHeight&&(r=!0),2===this.mouseWheel?!(this.mouseWheel=0)===e.ctrlKey&&r&&e.preventDefault():(e.stopPropagation(),!0===e.ctrlKey&&r&&(e.preventDefault(),!i.isCropTab&&i.activeObj.shape&&"crop"!==i.activeObj.shape.split("-")[0]&&(i.okBtn(null,!0),i.notify("toolbar",{prop:"close-contextual-toolbar",onPropertyChange:!1})),n="","mousewheel"===e.type&&(i.zoomSettings.zoomTrigger&m.ZoomTrigger.MouseWheel)===m.ZoomTrigger.MouseWheel&&(this.zoomType="MouseWheel",n=0<e.wheelDelta?"zoomIn":"zoomOut"),""!==n)&&(i.isZoomBtnClick=!0,i.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:t,y:o,type:n,isResize:null}}),i.notify("draw",{prop:"redrawDownScale"}),(i.isCropTab||i.activeObj.shape)&&(i.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),i.notify("freehand-draw",{prop:"resetStraightenPoint"})),i.isStraightening)&&(i.notify("draw",{prop:"resetStraightenDestPoints"}),i.notify("draw",{prop:"setDestForStraighten"})))},p.prototype.textKeyDown=function(e){var t=this.parent;0===t.activeObj.rotatedAngle&&("\r"===String.fromCharCode(e.which)&&(this.textRow+=1),t.textArea.setAttribute("rows",this.textRow.toString()),t.textArea.style.height="auto",t.textArea.style.height=t.textArea.scrollHeight+"px",t.notify("shape",{prop:"setTextBoxWidth",onPropertyChange:!1,value:{e:e}}),T.Browser.isDevice&&(t.textArea.style.width=parseFloat(t.textArea.style.width)+t.textArea.style.fontSize+"px"),e=t.textArea.value.split("\n"),this.textRow=e.length,t.textArea.setAttribute("rows",this.textRow.toString()),this.isInitialTextEdited=!1)},p.prototype.clearSelection=function(e){var t=this.parent;!t.disabled&&t.isImageLoaded&&(e?t.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}):(t.togglePen=!1,t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.dragElement="",this.dragPoint.startX=this.dragPoint.startY=this.dragPoint.endX=this.dragPoint.endY=0,t.currObjType.shape="",this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.currObjType.isActiveObj=!0,t.currObjType.isCustomCrop=!1,t.upperCanvas.style.cursor=t.cursor="default"))},p.prototype.setDragDirection=function(e,t){var o=7.5,i=this.parent,r=i.activeObj.activePoint;i.img.destWidth>i.img.destHeight?(r.startX=this.dragPoint.startX=e/2-t/2+o,r.startY=this.dragPoint.startY=t/2-t/2+o,r.endX=e/2+t/2-o,r.endY=t/2+t/2-o):(r.startY=this.dragPoint.startX=t/2-e/2+o,r.endY=t/2+e/2-o,r.startX=this.dragPoint.startX=o,r.endX=e-o)},p.prototype.calcShapeRatio=function(e,t,o,i){for(var r=this.parent,n=r.activeObj.activePoint,a=i<=o?o:i,s=a*(e/t),l=a,p=this.getScale(s,o),h=[],e=r.img,t=e.destLeft,a=e.destTop,d=e.destWidth,e=e.destHeight,c=0;c<2;c++)h.push(0===c?s*p:l*p);for(var s=h[0],l=h[1],u=this.getScale(l,i),g=[],c=0;c<2;c++)g.push(0===c?s*u:l*u);l=g[1],n.width=s=g[0],n.height=l,n.startX=7.5+(this.dragPoint.startX=(o-s)/2),n.startY=7.5+(this.dragPoint.startY=(i-l)/2),n.endX=n.startX+n.width,n.endY=n.startY+n.height,n.startX<t&&t+d>r.lowerCanvas.clientWidth&&(n.startX=t,n.endX=n.startX+s-7.5),n.startY<a&&a+e>r.lowerCanvas.clientHeight&&(n.startY=a,n.endY=n.startY+l-7.5),n.width=n.endX-n.startX,n.height=n.endY-n.startY},p.prototype.getScale=function(e,t){return t<e?t/e:1},p.prototype.findTarget=function(e,t,o){var i=this.parent;if("mousedown"===o.toLowerCase()||"touchstart"===o.toLowerCase()){var r=!1;i.activeObj.shape&&"crop"===i.activeObj.shape.split("-")[0]&&(r=!0),this.findTargetObj(e,t,r),this.updateCursorStyles(e,t,o)}else{var r=i.activeObj,n=r.topLeftCircle,a=r.topCenterCircle,s=r.topRightCircle,l=r.centerLeftCircle,p=r.centerRightCircle,h=r.bottomLeftCircle,d=r.bottomCenterCircle,c=r.bottomRightCircle;switch(this.dragElement.toLowerCase()){case"nw-resize":n.startX=e,n.startY=t;break;case"n-resize":a.startX=e,a.startY=t;break;case"ne-resize":s.startX=e,s.startY=t;break;case"w-resize":l.startX=e,l.startY=t;break;case"e-resize":p.startX=e,p.startY=t;break;case"sw-resize":h.startX=e,h.startY=t;break;case"s-resize":d.startX=e,d.startY=t;break;case"se-resize":c.startX=e,c.startY=t;break;default:this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=t)}}},p.prototype.findTargetObj=function(e,t,o){var i=this.parent,r=!1;if(0!==i.objColl.length&&!i.currObjType.isCustomCrop&&!o){for(var n,a,s=0,l=void 0,p=0;p<i.objColl.length;p++){var h=i.upperCanvas.style.cursor,d=(this.setCursor(e,t),T.extend({},i.objColl[p],{},!0)),c=d.topLeftCircle.radius;if("line"===d.shape||"arrow"===d.shape){for(var u=0;u<d.pointColl.length;u++)if(e>=d.pointColl[u].x-2*c&&e<=d.pointColl[u].x+2*c&&t>=d.pointColl[u].y-2*c&&t<=d.pointColl[u].y+2*c){if(this.tempActiveObj&&this.tempActiveObj.activePoint&&JSON.stringify(this.tempActiveObj.activePoint)===JSON.stringify(d.activePoint)){l=p;break}this.isTouch||"move"===i.cursor||"grab"===i.cursor||this.isShapeInserted?(0===s||s<d.order)&&(s=d.order,l=p):i.objColl[p].currIndex===this.tempActiveObj.currIndex&&(l=p);break}}else if("path"===d.shape){var g=this.setCursorForPath(d,e,t,i.upperCanvas);if("default"!==g&&"grab"!==g){if(this.tempActiveObj&&this.tempActiveObj.activePoint&&JSON.stringify(this.tempActiveObj.activePoint)===JSON.stringify(d.activePoint)){l=p;break}this.isTouch||"move"===i.cursor||"grab"===i.cursor||this.isShapeInserted?(0===s||s<d.order)&&(s=d.order,l=p):i.objColl[p].currIndex===this.tempActiveObj.currIndex&&(l=p)}}else if(0!==d.rotatedAngle){g=this.setCursorForRotatedObject(d,e,t,i.upperCanvas);if("default"!==g&&"grab"!==g){if(this.tempActiveObj&&this.tempActiveObj.activePoint&&JSON.stringify(this.tempActiveObj.activePoint)===JSON.stringify(d.activePoint)){l=p;break}this.isTouch||"move"===i.cursor||"grab"===i.cursor||this.isShapeInserted?(0===s||s<d.order&&("redact"!==d.shape||"redact"===i.drawingShape))&&(s=d.order,l=p):i.objColl[p].currIndex===this.tempActiveObj.currIndex&&(l=p)}}else{var v=this.getTransRotationPoint(d);if(e>=d.activePoint.startX-2*c&&e<=d.activePoint.endX+2*c&&t>=d.activePoint.startY-2*c&&t<=d.activePoint.endY+2*c||v&&e>=v.x-2*c&&e<=v.x+2*c&&t>=v.y-2*c&&t<=v.y+2*c){if(this.tempActiveObj&&this.tempActiveObj.activePoint&&JSON.stringify(this.tempActiveObj.activePoint)===JSON.stringify(d.activePoint)){l=p;break}this.isTouch||"move"===h||"grabbing"===h||this.isShapeInserted||"move"===i.cursor||"grabbing"===i.cursor?(0===s||s<d.order&&("redact"!==d.shape||"redact"===i.drawingShape))&&(s=d.order,l=p):i.objColl[p].currIndex===this.tempActiveObj.currIndex&&(l=p)}}}r=T.isNullOrUndefined(l)?(i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),!1):(this.tempObjColl=T.extend([],i.objColl,[],!0),i.currObjType.isCustomCrop=!1,i.activeObj=T.extend({},i.objColl[l],{},!0),o=T.extend({},i.objColl[l],{},!0),i.objColl.splice(l,1),0===i.transform.degree?(n=this.lowerContext.filter,this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),i.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter="none",i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),i.activeObj=T.extend({},n,{},!0),this.lowerContext.filter=n,this.getCurrentFlipState()):(n=T.extend({},i.panPoint.totalPannedInternalPoint,{},!0),a={startX:i.img.destLeft,startY:i.img.destTop,width:i.img.destWidth,height:i.img.destHeight},i.notify("draw",{prop:"callUpdateCurrTransState",onPropertyChange:!1}),i.panPoint.totalPannedInternalPoint=n,i.img.destLeft=a.startX,i.img.destTop=a.startY,i.img.destWidth=a.width,i.img.destHeight=a.height,i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}})),i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),(i.currSelectionPoint&&"crop-circle"===i.currSelectionPoint.shape||i.isCircleCrop)&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),i.activeObj=T.extend({},o,{},!0),this.setActivePoint(),i.activeObj=T.extend({},o,{},!0),n=T.extend({},i.activeObj.strokeSettings,{},!0),i.notify("draw",{prop:"setTempStrokeSettings",onPropertyChange:!1,value:{tempStrokeSettings:n}}),a=T.extend({},i.activeObj.textSettings,{},!0),i.notify("draw",{prop:"setTempTextSettings",onPropertyChange:!1,value:{tempTextSettings:a}}),n={cancel:!1,action:"select",previousShapeSettings:o=this.updatePrevShapeSettings(),currentShapeSettings:o,allowShapeOverflow:this.allowOutofBound()},"line"!==i.activeObj.shape&&"arrow"!==i.activeObj.shape||(n.currentShapeSettings.width=i.activeObj.activePoint.endX-i.activeObj.activePoint.startX,n.currentShapeSettings.height=i.activeObj.activePoint.endY-i.activeObj.activePoint.startY),a=void(this.isCropSelection=!1),void 0!==(a=void 0!==i.activeObj.shape?i.activeObj.shape.split("-"):a)&&"crop"===a[0]&&(this.isCropSelection=!0),this.isCropSelection||"redact"===i.activeObj.shape?(this.isMouseDown?n.action="resize-start":this.isMouseUp&&(n.action="resize-end"),o={action:n.action,previousSelectionSettings:{type:i.getSelectionType(i.activeObj.shape),startX:n.previousShapeSettings.startX,startY:n.previousShapeSettings.startY,width:n.previousShapeSettings.width,height:n.previousShapeSettings.height},currentSelectionSettings:{type:i.getSelectionType(i.activeObj.shape),startX:n.currentShapeSettings.startX,startY:n.currentShapeSettings.startY,width:n.currentShapeSettings.width,height:n.currentShapeSettings.height}},i.trigger("selectionChanging",o),i.editCompleteArgs=o,n.currentShapeSettings.startX=o.currentSelectionSettings.startX,n.currentShapeSettings.startY=o.currentSelectionSettings.startY,n.currentShapeSettings.width=o.currentSelectionSettings.width,n.currentShapeSettings.height=o.currentSelectionSettings.height,this.shapeEvent(n)):(i.trigger("shapeChanging",n),this.shapeEvent(n),i.editCompleteArgs=n),!0)}return r},p.prototype.shapeEvent=function(e){var t=this.parent;t.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings,allowShapeOverflow:e.allowShapeOverflow}}),t.activeObj.activePoint&&(t.notify("draw",{prop:"getPrevActObj",onPropertyChange:!(e={prevActObj:null}),value:{obj:e}}),T.isNullOrUndefined(e.prevActObj)&&t.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:T.extend({},t.activeObj,{},!0)}}),"image"!==t.activeObj.shape||this.isImageClarity||(this.upgradeImageQuality(),this.isImageClarity=!0),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:!0}}),this.isShapeInserted||(this.isPreventDragging=this.isShapeDragOut()))},p.prototype.upgradeImageQuality=function(){var e,t,o,i=this.parent;i.activeObj.imageCanvas&&(e=T.extend({},i.activeObj,null,!0),t=i.activeObj.imageCanvas.getContext("2d"),i.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!(o={width:0,height:0}),value:{width:i.activeObj.imageElement.width,height:i.activeObj.imageElement.height,obj:o,isImgShape:null}}),i.notify("shape",{prop:"updateObj",onPropertyChange:!1,value:{dimObj:o,x:null,y:null}}),t.clearRect(0,0,i.activeObj.imageCanvas.width,i.activeObj.imageCanvas.height),this.applyTransformToImg(t),i.activeObj=e)},p.prototype.applyTransformToImg=function(e){var t=this.parent;t.activeObj.isHorImageFlip&&t.activeObj.isVerImageFlip?(t.activeObj.isHorImageFlip=t.activeObj.isVerImageFlip=!1,t.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:e,isImgAnnotation:!0,isHFlip:!0,isVFlip:!0}})):t.activeObj.isHorImageFlip?(t.activeObj.isHorImageFlip=!1,t.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:e,isImgAnnotation:!0,isHFlip:!0,isVFlip:!1}})):t.activeObj.isVerImageFlip?(t.activeObj.isVerImageFlip=!1,t.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:e,isImgAnnotation:!0,isHFlip:!1,isVFlip:!0}})):t.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:e,isImgAnnotation:!0,isHFlip:!1,isVFlip:!1}})},p.prototype.targetTouches=function(e){var t=this.parent.lowerCanvas.getBoundingClientRect();return[{x:e[0].pageX-t.left,y:e[0].pageY-t.top},{x:e[1].pageX-t.left,y:e[1].pageY-t.top}]},p.prototype.calculateScale=function(e,t){e=this.getDistance(e[0],e[1]);return this.getDistance(t[0],t[1])/e},p.prototype.getDistance=function(e,t){var o=0,i=0;return e&&t&&(o=e.x-t.x,i=e.y-t.y),Math.sqrt(o*o+i*i)},p.prototype.redrawShape=function(e,t){for(var o,i=this.parent,r=0,n=i.objColl.length;r<n;r++)if(JSON.stringify(e)===JSON.stringify(i.objColl[r])){i.objColl.splice(r,1),e.shape&&"none"===i.textArea.style.display&&(o=T.extend({},e,{},!0),i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),i.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),0<i.rotateFlipColl.length&&(0!==i.panPoint.totalPannedClientPoint.x||0!==i.panPoint.totalPannedClientPoint.y)&&i.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),e=i.activeObj=o);break}"path"===e.shape&&0===e.pointColl.length||"path"!==e.shape&&0===e.activePoint.width&&0===e.activePoint.height||(this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),this.isPreventDragging?(i.activeObj.activePoint.startX>i.img.destLeft&&(this.isPreventDragging=!1),t&&i.activeObj.rotatedAngle):t&&0!==i.activeObj.rotatedAngle||"redact"===i.activeObj.shape&&(this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),i.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}})),i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}))},p.prototype.setTimer=function(e){var t=this.parent;10<this.timer&&(clearTimeout(this.timer),this.timer=0,t.notify("shape",{prop:"findTextTarget",onPropertyChange:!1,value:{e:e}}),T.Browser.isDevice)&&this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height)},p.prototype.applyCurrActObj=function(e,t){var o,i,r,n,a,s,l=this.parent,p=!1,h=T.extend({},l.activeObj,{},!0);T.isNullOrUndefined(h.activePoint)||(r=(o=h.activePoint).startX,s=o.startY,a=o.endX,o=o.endY,i=h.topLeftCircle?h.topLeftCircle.radius:0,e>=Math.floor(r)&&e<=Math.ceil(a)&&t>=Math.floor(s)&&t<=Math.ceil(o)?p=!0:0!==i&&e>=Math.floor(r)-i&&e<=Math.ceil(a)+i&&t>=Math.floor(s)-i&&t<=Math.ceil(o)+i?(p=!0,this.tempActiveObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[]}):"text"!==h.shape&&"image"!==h.shape||""===this.dragElement?"line"===h.shape||"arrow"===h.shape?(i={x:r<a?r:a,y:s<o?s:o},r={x:a<r?r:a,y:o<s?s:o},(e>=Math.floor(i.x)-5&&e<=Math.ceil(r.x)+5&&t>=Math.floor(i.y)-5&&t<=Math.ceil(r.y)+5||l.activeObj.preventShapeDragOut)&&(p=!0)):"path"===h.shape?"move"===(n=this.setCursorForPath(h,e,t,l.upperCanvas))&&(p=!0):"grabbing"===this.dragElement?p=!0:0!==h.rotatedAngle?("default"!==(n=this.setCursorForRotatedObject(h,e,t,l.upperCanvas))&&"grab"!==n||"n-resize"===this.dragElement||"e-resize"===this.dragElement||"s-resize"===this.dragElement||"w-resize"===this.dragElement)&&(p=!0):"block"!==l.textArea.style.display&&"inline-block"!==l.textArea.style.display||(p=!0):p=!0,p)||(T.isNullOrUndefined(l.activeObj.currIndex)&&(a={id:"shape_"+(l.objColl.length+1)},l.notify("shape",{prop:"getNewShapeId",onPropertyChange:!1,value:{obj:a}}),l.activeObj.currIndex=a.id),l.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),void 0===l.activeObj.horTopLine||0===l.activeObj.horTopLine.startX||0===l.activeObj.horTopLine.endX||l.currObjType.isCustomCrop||""===l.currObjType.shape||0<l.objColl.length&&JSON.stringify(l.objColl[l.objColl.length-1].activePoint)!==JSON.stringify(l.activeObj.activePoint)&&l.objColl.push(T.extend({},l.activeObj,{},!0)),-1<["rectangle","ellipse","line","arrow","path","text","image"].indexOf(l.activeObj.shape)&&(s=this.lowerContext.filter,this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",l.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=s,l.activeObj.shape&&l.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}}),l.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),l.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),l.isCircleCrop)&&l.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),l.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}))},p.prototype.getCurrentFlipState=function(){var e,t=this.parent;0!==t.rotateFlipColl.length?(e=T.extend({},t.panPoint.totalPannedInternalPoint,{},!0),t.notify("draw",{prop:"callUpdateCurrTransState",onPropertyChange:!1}),t.panPoint.totalPannedInternalPoint=e):t.notify("draw",{prop:"callUpdateCurrTransState",onPropertyChange:!1})},p.prototype.setTextBoxStylesToActObj=function(){var e=this.parent;e.activeObj.textSettings.fontFamily=e.textArea.style.fontFamily,e.activeObj.strokeSettings.strokeColor=""!==e.textArea.style.color&&e.textArea.style.color.split("(")[1]&&e.textArea.style.color.split("(")[1].split(",")[0]&&e.textArea.style.color.split("(")[1].split(",")[1]&&e.textArea.style.color.split("(")[1].split(",")[2]&&e.textArea.style.color.split("(")[1].split(",")[3]?this.rgbToHex(parseFloat(e.textArea.style.color.split("(")[1].split(",")[0]),parseFloat(e.textArea.style.color.split("(")[1].split(",")[1]),parseFloat(e.textArea.style.color.split("(")[1].split(",")[2]),parseFloat(e.textArea.style.color.split("(")[1].split(",")[3])):e.textArea.style.color,e.activeObj.strokeSettings.fillColor=""!==e.textArea.style.backgroundColor&&e.textArea.style.backgroundColor.split("(")[1]&&e.textArea.style.backgroundColor.split("(")[1].split(",")[0]&&e.textArea.style.backgroundColor.split("(")[1].split(",")[1]&&e.textArea.style.backgroundColor.split("(")[1].split(",")[2]&&e.textArea.style.backgroundColor.split("(")[1].split(",")[3]?this.rgbToHex(parseFloat(e.textArea.style.backgroundColor.split("(")[1].split(",")[0]),parseFloat(e.textArea.style.backgroundColor.split("(")[1].split(",")[1]),parseFloat(e.textArea.style.backgroundColor.split("(")[1].split(",")[2]),parseFloat(e.textArea.style.backgroundColor.split("(")[1].split(",")[3])):e.textArea.style.backgroundColor,e.activeObj.strokeSettings.outlineColor=""!==e.textArea.style.textShadow&&e.textArea.style.textShadow.split("(")[1]&&e.textArea.style.textShadow.split("(")[1].split(",")[0]&&e.textArea.style.textShadow.split("(")[1].split(",")[1]&&e.textArea.style.textShadow.split("(")[1].split(",")[2]&&e.textArea.style.textShadow.split("(")[1].split(",")[3]?this.rgbToHex(parseFloat(e.textArea.style.textShadow.split("(")[1].split(",")[0]),parseFloat(e.textArea.style.textShadow.split("(")[1].split(",")[1]),parseFloat(e.textArea.style.textShadow.split("(")[1].split(",")[2]),parseFloat(e.textArea.style.textShadow.split("(")[1].split(",")[3])):e.textArea.style.textShadow.match(/^(\s*[\w#]+)\s/)?e.textArea.style.textShadow.match(/^(\s*[\w#]+)\s/)[1].trim():e.textArea.style.textShadow,"bold"===e.textArea.style.fontWeight?e.activeObj.textSettings.bold=!0:e.activeObj.textSettings.bold=!1,"italic"===e.textArea.style.fontStyle?e.activeObj.textSettings.italic=!0:e.activeObj.textSettings.italic=!1,e.activeObj.textSettings.fontSize=parseFloat(e.textArea.style.fontSize)},p.prototype.rgbToHex=function(e,t,o,i){e=Math.max(0,Math.min(255,Math.round(e))),t=Math.max(0,Math.min(255,Math.round(t))),o=Math.max(0,Math.min(255,Math.round(o))),i=Math.max(0,Math.min(1,i));e=this.padLeft(e.toString(16),2,"0"),t=this.padLeft(t.toString(16),2,"0"),o=this.padLeft(o.toString(16),2,"0"),i=this.padLeft(Math.round(255*i).toString(16),2,"0"),e=isNaN(Number(i))?"#"+e+t+o:"#"+e+t+o+i;return e},p.prototype.padLeft=function(e,t,o){for(;e.length<t;)e=o+e;return e},p.prototype.deleteItem=function(){var e=this.parent;if(this.isFhdEditing){this.updateFreehandDrawColorChange();var t=T.extend({},e.cropObj,{},!0),o={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}});(l=o.currObj).objColl=T.extend([],e.objColl,[],!0),l.pointColl=T.extend([],e.pointColl,[],!0),l.afterCropActions=T.extend([],e.afterCropActions,[],!0);var i={selPointColl:null},r=(e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:i}}),l.selPointColl=T.extend([],i.selPointColl,[],!0),{freehandDrawSelectedId:null});e.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:r}}),e.notify("freehand-draw",{prop:"deleteFhd",value:{id:r.freehandDrawSelectedId}}),e.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"deleteFreehandDrawing",previousObj:l,previousObjColl:this.tempObjColl,previousPointColl:l.pointColl,previousSelPointColl:l.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),e.notify("freehand-draw",{prop:"resetFreehandDrawSelectedId"})}else if("none"===e.textArea.style.display){r={prevActObj:null};if(e.notify("draw",{prop:"getPrevActObj",onPropertyChange:!1,value:{obj:r}}),r.prevActObj&&(r.prevActObj.activePoint.width=Math.abs(r.prevActObj.activePoint.width),r.prevActObj.activePoint.height=Math.abs(r.prevActObj.activePoint.height)),r.prevActObj&&JSON.stringify(r.prevActObj)!==JSON.stringify(e.activeObj)){var n=e.activeObj.currIndex;e.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null,isFinalCancel:!0}});for(var a=0,s=e.objColl.length;a<s;a++)if(e.objColl[a].currIndex===n){e.objColl.splice(a,1),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}});break}}var l,o={isNewPath:null};e.notify("draw",{prop:"getNewPath",value:{obj:o}}),o.isNewPath?(e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})):e.activeObj.shape&&(e.objColl.push(e.activeObj),t=T.extend({},e.cropObj,{},!0),e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(r={currObj:{}}),value:{object:r}}),(l=r.currObj).objColl=T.extend([],e.objColl,[],!0),l.pointColl=T.extend([],e.pointColl,[],!0),l.afterCropActions=T.extend([],e.afterCropActions,[],!0),e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(i={selPointColl:null}),value:{obj:i}}),l.selPointColl=T.extend([],i.selPointColl,[],!0),e.objColl.pop(),o=this.updatePrevShapeSettings(),e.notify("shape",{prop:"setKeyHistory",onPropertyChange:!(r={cancel:!1,action:"delete",previousShapeSettings:o,currentShapeSettings:null}),value:{keyHistory:""}}),e.clearSelection(),e.trigger("shapeChanging",r),e.editCompleteArgs=r,e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),T.isNullOrUndefined(l.objColl[l.objColl.length-1].currIndex)||(e.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"deleteObj",previousObj:l,previousObjColl:this.tempObjColl,previousPointColl:l.pointColl,previousSelPointColl:l.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}))),e.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}}),e.drawingShape&&(this.currentDrawingShape=e.drawingShape.toLowerCase(),e.enableShapeDrawing(e.toPascalCase(e.drawingShape),!0),e.upperCanvas.style.cursor="crosshair")}document.getElementById(e.element.id+"_quickAccessToolbarArea")&&(document.getElementById(e.element.id+"_quickAccessToolbarArea").style.display="none")},p.prototype.updateFreehandDrawColorChange=function(){var e,t=this.parent,o={freehandSelectedIndex:null};t.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:o}}),T.isNullOrUndefined(o.freehandSelectedIndex)||T.isNullOrUndefined(t.pointColl[o.freehandSelectedIndex])||"#42a5f5"!==t.pointColl[o.freehandSelectedIndex].strokeColor||(t.notify("freehand-draw",{prop:"getTempFreeHandDrawEditingStyles",value:{obj:e={tempFreeHandDrawEditingStyles:null}}}),t.pointColl[o.freehandSelectedIndex].strokeColor=e.tempFreeHandDrawEditingStyles.strokeColor)},p.prototype.updatePrevShapeSettings=function(e){var t=this.parent,o=[],i=(T.isNullOrUndefined(t.activeObj.currIndex)&&(i={id:"shape_"+(t.objColl.length+1)},t.notify("shape",{prop:"getNewShapeId",onPropertyChange:!1,value:{obj:i}}),t.activeObj.currIndex=i.id),"text"===t.activeObj.shape&&t.activeObj.textSettings&&(t.activeObj.textSettings.bold&&o.push("bold"),t.activeObj.textSettings.italic&&o.push("italic"),t.activeObj.textSettings.underline)&&o.push("underline"),t.activeObj.activePoint),r=i.startX,n=i.startY,a=i.endX,s=i.endY,l=i.width,i=i.height,p=t.activeObj,h=p.keyHistory,d=p.currIndex,c=p.shape,u=p.textSettings,g=p.strokeSettings,v=p.rotatedAngle,f=p.imageElement,p=p.opacity,d={id:T.isNullOrUndefined(d)?null:d,type:t.toPascalCase(c),startX:r,startY:n,width:l,height:i,strokeColor:g?"text"===c?g.outlineColor:g.strokeColor:null,strokeWidth:g?"text"===c?g.outlineWidth:g.strokeWidth:null,fillColor:g?g.fillColor:null,radius:"ellipse"===c?l/2:null,length:"line"===c||"arrow"===c?l:null,text:"text"===c&&(h||u.text)||null,fontSize:"text"===c&&u?u.fontSize:null,fontFamily:"text"===c&&u?u.fontFamily:null,fontStyle:"text"===c?o:null,color:"text"===c&&g?g.strokeColor:null,degree:"ellipse"===c||"rectangle"===c||"image"===c||"text"===c?v*(180/Math.PI):null,imageData:"image"===c?f.src:null,opacity:"image"===c?p:null,radiusX:"ellipse"===c?l/2:null,radiusY:"ellipse"===c?i/2:null,endX:"line"===c||"arrow"===c?a:null,endY:"line"===c||"arrow"===c?s:null,arrowHead:"arrow"===c?this.getArrowType(t.activeObj.start):null,arrowTail:"arrow"===c?this.getArrowType(t.activeObj.end):null,points:"path"===c?t.activeObj.pointColl:null,index:t.activeObj.order,transformCollection:"text"===c?this.updateTransColl(t.activeObj):null};return e&&(e.shapeSettingsObj=d),d},p.prototype.updateTransColl=function(e){var t=this.parent,o=e.rotateFlipColl;if(o&&0<o.length)for(var i,r=[],n=0;n<o.length;n++)"number"==typeof(i=o[n])?r.push({degree:i}):r.push({flip:t.toPascalCase(i)});return r},p.prototype.getArrowType=function(e){return{none:"None",arrow:"Arrow",arrowSolid:"SolidArrow",circle:"Circle",circleSolid:"SolidCircle",square:"Square",squareSolid:"SolidSquare",bar:"Bar"}[""+e]},p.prototype.getRectanglePoints=function(e,t,o,i,r,n,a){var e=e+o/2,t=t+i/2,r=r*(Math.PI/180),s=Math.cos(r),r=Math.sin(r),n=n-e,e=a-t,a=n*s+e*r,t=-n*r+e*s,n=o/2,r=i/2;return-n<=a&&a<=n&&-r<=t&&t<=r},p.prototype.getTransRotationPoint=function(e,t){var o,i=!1,r=!1,n=0===e.shapeDegree?this.parent.transform.degree:this.parent.transform.degree-e.shapeDegree;if(n<0&&(n=360+n),e.flipObjColl)for(var a=0,s=e.flipObjColl.length;a<s;a++)"horizontal"===e.flipObjColl[a].toLowerCase()?i=!0:"vertical"===e.flipObjColl[a].toLowerCase()&&(r=!0);return 0===n||360===n?o=r?{x:e.topCenterCircle.startX,y:e.topCenterCircle.startY-e.rotationCircleLine}:{x:e.bottomCenterCircle.startX,y:e.bottomCenterCircle.startY+e.rotationCircleLine}:90===n||-270===n?o=i?{x:e.centerRightCircle.startX+e.rotationCircleLine,y:e.centerLeftCircle.startY}:{x:e.centerLeftCircle.startX-e.rotationCircleLine,y:e.centerLeftCircle.startY}:180===n||-180===n?o=r?{x:e.bottomCenterCircle.startX,y:e.bottomCenterCircle.startY+e.rotationCircleLine}:{x:e.topCenterCircle.startX,y:e.topCenterCircle.startY-e.rotationCircleLine}:270!==n&&-90!==n||(o=i?{x:e.centerLeftCircle.startX-e.rotationCircleLine,y:e.centerLeftCircle.startY}:{x:e.centerRightCircle.startX+e.rotationCircleLine,y:e.centerLeftCircle.startY}),t&&(t.rotationCirclePoint=o),o},p.prototype.getNumTextValue=function(e){var t,o,i=this.parent.element,r=i.querySelector("#"+i.id+"_resizeWidth"),i=i.querySelector("#"+i.id+"_resizeHeight");return r&&i&&(t=i.value.replace(/,/g,""),o=r.value.replace(/,/g,""),""===t&&(t=i.placeholder.replace(/,/g,"")),""===o&&(o=r.placeholder.replace(/,/g,"")),t=parseFloat(t),o=parseFloat(o)),e&&(e.width=o,e.height=t),{x:o,y:t}},p.prototype.isValueUpdated=function(){var e=!0,t=this.parent.element.querySelector("#"+this.parent.element.id+"_resizeWidth"),o=this.parent.element.querySelector("#"+this.parent.element.id+"_resizeHeight");return e=t&&o&&""===o.value.replace(/,/g,"")&&""===t.value.replace(/,/g,"")?!1:e},p.prototype.allowOutofBound=function(){return-1===["ellipse","rectangle","text","image","redact"].indexOf(this.parent.activeObj.shape)||0!==this.parent.activeObj.rotatedAngle};var H=p;function p(e){this.diffPoint={x:0,y:0},this.oldPoint={},this.isTouch=!1,this.isObjSelected=!1,this.isFhdPoint=!1,this.dragPoint={startX:0,startY:0,endX:0,endY:0},this.isShapeInserted=!1,this.tempActiveObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],order:null},this.isFirstMove=!1,this.startTouches=[],this.tempTouches=[],this.currMousePoint={x:0,y:0},this.cursorTargetId="",this.isPreventDragging=!1,this.dragElement="",this.textRow=1,this.mouseDownPoint={x:0,y:0},this.previousPoint={x:0,y:0},this.zoomType="Toolbar",this.isInitialTextEdited=!1,this.dragCanvas=!1,this.isFhdCustomized=!1,this.touchEndPoint={},this.isFhdEditing=!1,this.currentDrawingShape="",this.initialPrevObj={},this.touchTime=0,this.resizedElement="",this.isImageClarity=!0,this.isPinching=!1,this.isSliding=!1,this.mouseDown="",this.isSliderActive=!1,this.arrowShape=[m.ArrowheadType.None,m.ArrowheadType.SolidArrow],this.isTouchDblClick=!1,this.isMouseDown=!1,this.isMouseUp=!1,this.mouseWheel=0,this.isTransformedShape=!1,this.parent=e,this.addEventListener()}h.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},h.prototype.addEventListener=function(){this.parent.on("shape",this.shape,this),this.parent.on("destroyed",this.destroy,this)},h.prototype.removeEventListener=function(){this.parent.off("shape",this.shape),this.parent.off("destroyed",this.destroy)},h.prototype.shape=function(e){var t,o=this.parent;switch(this.initShapePvtProps(),e.prop){case"drawEllipse":this.drawEllipse(e.value.x,e.value.y,e.value.radiusX,e.value.radiusY,e.value.strokeWidth,e.value.strokeColor,e.value.fillColor,e.value.degree,e.value.isSelected);break;case"drawLine":this.drawLine(e.value.startX,e.value.startY,e.value.endX,e.value.endY,e.value.strokeWidth,e.value.strokeColor,e.value.isSelected);break;case"drawArrow":this.drawArrow(e.value.startX,e.value.startY,e.value.endX,e.value.endY,e.value.strokeWidth,e.value.strokeColor,e.value.arrowStart,e.value.arrowEnd,e.value.isSelected);break;case"drawPath":this.drawPath(e.value.pointColl,e.value.strokeWidth,e.value.strokeColor,e.value.isSelected);break;case"drawRectangle":this.drawRectangle(e.value.x,e.value.y,e.value.width,e.value.height,e.value.strokeWidth,e.value.strokeColor,e.value.fillColor,e.value.degree,e.value.isSelected,e.value.radius);break;case"drawText":this.drawText(e.value.x,e.value.y,e.value.text,e.value.fontFamily,e.value.fontSize,e.value.bold,e.value.italic,e.value.color,e.value.isSelected,e.value.degree,e.value.fillColor,e.value.outlineColor,e.value.outlineWidth,e.value.transformCollection);break;case"redrawActObj":this.redrawActObj(e.value.x,e.value.y,e.value.isMouseDown);break;case"apply":this.apply(e.value.shape,e.value.obj,e.value.canvas);break;case"updateShapeChangeEventArgs":this.updateShapeChangeEventArgs(e.value.shapeSettings,e.value.allowShapeOverflow);break;case"updSelChangeEventArgs":this.updSelChangeEventArgs(e.value.selectionSettings);break;case"iterateObjColl":this.iterateObjColl();break;case"updImgRatioForActObj":this.updImgRatioForActObj();break;case"redrawObj":this.redrawObj(e.value.degree);break;case"redraw-text":this.redrawText();break;case"draw-shape":this.drawShape(e.value.obj,e.value.strokeWidth,e.value.strokeColor,e.value.fillColor,e.value.start,e.value.width,e.value.height);break;case"renderTextArea":this.renderTextArea(e.value.x,e.value.y,e.value.actObj);break;case"setTextBoxWidth":this.setTextBoxWidth(e.value.e);break;case"findTextTarget":this.findTextTarget(e.value.e);break;case"updateFontStyles":this.updateFontStyles(e.value.isTextBox);break;case"applyFontStyle":this.applyFontStyle(e.value.item);break;case"updateFontRatio":this.updateFontRatio(e.value.obj,e.value.isTextArea);break;case"updateFontSize":this.updateFontSize(e.value.obj);break;case"pushActItemIntoObj":this.pushActItemIntoObj();break;case"clearActObj":this.clearActObj();break;case"refreshActiveObj":this.refreshActiveObj();break;case"applyActObj":this.applyActObj(e.value.isMouseDown);break;case"wireEvent":T.EventHandler.add(o.upperCanvas,"dblclick",this.findTextTarget,this),T.EventHandler.add(o.textArea,"mousedown",this.findTextTarget,this),(t=document.getElementById(o.element.id+"_fileUpload"))&&T.EventHandler.add(t,"change",this.fileChanged,this);break;case"unWireEvent":T.EventHandler.remove(o.upperCanvas,"dblclick",this.findTextTarget),T.EventHandler.remove(o.textArea,"mousedown",this.findTextTarget),(t=document.getElementById(o.element.id+"_fileUpload"))&&T.EventHandler.remove(t,"change",this.fileChanged);break;case"getShapeSetting":this.getShapeSetting(e.value.id,e.value.obj);break;case"getShapeSettings":this.getShapeSettings(e.value.obj);break;case"getRedactSettings":this.getRedactSettings(e.value.obj);break;case"isPointsInRange":this.isPointsInRange(e.value.x,e.value.y,e.value.obj);break;case"alignRotateFlipColl":this.alignRotateFlipColl(e.value.collection,e.value.isRotateFlipCollection,e.value.obj);break;case"selectShape":this.selectShape(e.value.id,e.value.obj);break;case"deleteShape":this.deleteShape(e.value.id);break;case"getMaxText":this.getMaxText(e.value.isTextBox,e.value.text,e.value.obj);break;case"setPointCollForLineArrow":e.value.obj.pointColl=this.getLinePoints(e.value.obj.activePoint.startX,e.value.obj.activePoint.startY,e.value.obj.activePoint.endX,e.value.obj.activePoint.endY);break;case"setPointCollForShapeRotation":this.setPointCollForShapeRotation(e.value.obj);break;case"setTextSettings":e.value.textSettings?this.textSettings=e.value.textSettings:e.value.fontFamily?this.textSettings.fontFamily=e.value.fontFamily:e.value.fontSize?this.textSettings.fontSize=e.value.fontSize:e.value.radius&&(this.strokeSettings.radius=e.value.radius);break;case"setStrokeSettings":e.value.strokeSettings?this.strokeSettings=e.value.strokeSettings:e.value.strokeColor?this.strokeSettings.strokeColor=e.value.strokeColor:e.value.fillColor?this.strokeSettings.fillColor=e.value.fillColor:e.value.strokeWidth?this.strokeSettings.strokeWidth=e.value.strokeWidth:e.value.outlineColor?this.strokeSettings.outlineColor=e.value.outlineColor:e.value.radius?this.strokeSettings.radius=e.value.radius:e.value.outlineWidth&&(this.strokeSettings.outlineWidth=e.value.outlineWidth);break;case"getStrokeSettings":e.value.obj.strokeSettings=this.strokeSettings;break;case"setKeyHistory":this.keyHistory=e.value.keyHistory;break;case"getKeyHistory":e.value.obj.keyHistory=this.keyHistory;break;case"setTextBoxPos":this.setTextBoxPos(e.value.actObj,e.value.degree,e.value.flip,e.value.x,e.value.y);break;case"setTextBoxPoints":this.setTextBoxPoints(e.value.actObj,e.value.degree,e.value.flip,e.value.x,e.value.y);break;case"alignTextAreaIntoCanvas":this.alignTextAreaIntoCanvas();break;case"initializeTextShape":this.initializeTextShape(e.value.text,e.value.fontFamily,e.value.fontSize,e.value.bold,e.value.italic,e.value.strokeColor,e.value.fillColor,e.value.outlineColor,e.value.outlineWidth);break;case"stopPathDrawing":this.stopPathDrawing(e.value.e,e.value.isApply);break;case"updateArrowRatio":this.updateArrowRatio(e.value.obj);break;case"getSquarePointForRotatedShape":this.getSquarePointForRotatedShape(e.value.obj,e.value.object);break;case"drawImage":this.drawImage(e.value.x,e.value.y,e.value.width,e.value.height,e.value.src,e.value.degree,e.value.isAspectRatio,e.value.opacity,e.value.isSelected);break;case"reset":this.reset();break;case"updateObj":this.updateObj(e.value.dimObj,e.value.x,e.value.y);break;case"straightenShapes":this.straightenShapes();break;case"straightenShapePoints":this.straightenShapePoints(e.value.obj,e.value.isReverse);break;case"straightenPath":this.straightenPath(e.value.obj);break;case"straightenFHD":this.straightenFHD();break;case"getTextBoxPosition":this.getTextBoxPosition(e.value.obj,e.value.object);break;case"setFlipState":this.setFlipState(e.value.x,e.value.y,e.value.obj,e.value.object);break;case"getNewShapeId":e.value.obj.id=this.getNewShapeId();break;case"z-order":this.updateZOrder(e.value.obj,e.value.value);break;case"getSmallestIndex":e.value.obj.index=this.getSmallestIndex();break;case"isIndexInObjColl":e.value.obj.bool=this.isIndexInObjColl(e.value.index);break;case"drawAnnotations":this.drawAnnotations(e.value.ctx,e.value.shape,e.value.pen,e.value.isPreventApply,e.value.x,e.value.y,e.value.panRegion);break;case"updateShapeColl":this.updateShapeColl();break;case"getNewOrder":e.value.obj.order=this.getNewOrder();break;case"getHighestOrder":e.value.obj.order=this.getHighestOrder();break;case"getLowestOrder":e.value.obj.order=this.getLowestOrder();break;case"drawRedact":this.drawRedact(e.value.x,e.value.y,e.value.width,e.value.height,e.value.type,e.value.value);break;case"setRedactType":this.redactType=e.value.redactType}},h.prototype.getModuleName=function(){return"shape"},h.prototype.initShapePvtProps=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d")),T.isNullOrUndefined(this.shapeImg)&&(this.shapeImg=e.createElement("img",{id:e.element.id+"_shapeImg",attrs:{name:"Image",crossorigin:"anonymous"}})),""===this.textSettings.fontFamily&&(this.textSettings.fontFamily=e.fontFamily.default)},h.prototype.reset=function(){this.textSettings={text:"Enter Text",fontFamily:this.parent.fontFamily.default,fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.strokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,radius:null,outlineColor:"",outlineWidth:null},this.preventFrameAnnotation=!1},h.prototype.drawEllipse=function(e,t,o,i,r,n,a,s,l){this.initializeShape("ellipse"),this.drawShape("ellipse",r,n,a,e&&t?{x:e,y:t}:null,o,i,null,null,null,s,null,l)},h.prototype.drawLine=function(e,t,o,i,r,n,a){this.initializeShape("line"),this.drawShape("line",r,n,null,e&&t?{x:e,y:t}:null,o-e,i-t,null,null,null,null,null,a)},h.prototype.drawPath=function(e,t,o,i){this.initializeShape("path"),e&&this.drawShape("path",t,o,null,null,null,null,e,null,null,null,null,i)},h.prototype.drawArrow=function(e,t,o,i,r,n,a,s,l){this.initializeShape("arrow"),this.drawShape("arrow",r,n,null,e&&t?{x:e,y:t}:null,o-e,i-t,null,a,s,null,null,l)},h.prototype.drawRectangle=function(e,t,o,i,r,n,a,s,l,p){this.initializeShape("rectangle"),this.drawShape("rectangle",r,n,a,e&&t?{x:e,y:t}:null,o,i,null,null,null,s,null,l,p)},h.prototype.drawRedact=function(e,t,o,i,r,n){this.initializeShape("redact"),this.drawShape("redact",null,null,null,e&&t?{x:e,y:t}:null,o,i,null,null,null,null,null,null,null,r,n)},h.prototype.drawText=function(e,t,o,i,r,n,a,s,l,p,h,d,c,u){this.drawShapeText(o,i,r,n,a,s,e,t,l,p,h,d,c,u)},h.prototype.initializeShape=function(e){var t=this.parent;this.redrawActObj(),t.activeObj.shape=e,t.currObjType.isCustomCrop=!1},h.prototype.updateWidthHeight=function(e){return e.activePoint.width=e.activePoint.endX-e.activePoint.startX,e.activePoint.height=e.activePoint.endY-e.activePoint.startY,e},h.prototype.setDimension=function(e,t){var o=this.parent,i=o.activeObj.shape;(e&&t||("line"===i||"arrow"===i)&&(e||t))&&(o.activeObj.activePoint.width=e,o.activeObj.activePoint.height=t,"ellipse"===o.currObjType.shape.toLowerCase())&&(o.activeObj.activePoint.width=2*e,o.activeObj.activePoint.height=2*t)},h.prototype.getArrowType=function(e){var t=e;return e&&(t={None:"none",Arrow:"arrow",SolidArrow:"arrowSolid",Circle:"circle",SolidCircle:"circleSolid",Square:"square",SolidSquare:"squareSolid",Bar:"bar"}[""+e]),t},h.prototype.drawShape=function(e,t,o,i,r,n,a,s,l,p,h,d,c,u,g,v){var f,C,b=this.parent;!b.disabled&&b.isImageLoaded&&(b.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),this.redrawActObj(),f=T.extend([],b.objColl,[],!0),b.togglePen=!1,this.keyHistory="",b.upperCanvas.style.display="block",this.refreshActiveObj(),b.currObjType.shape=e=e.toLowerCase(),"freehanddraw"!==e)&&""!==e&&(b.activeObj.shape=e,C=b.activeObj.strokeSettings,this.upperContext.clearRect(0,0,b.upperCanvas.width,b.upperCanvas.height),T.isNullOrUndefined(C)&&(C=this.strokeSettings),"path"===e&&s&&(b.activeObj.pointColl=s),null!=d&&(b.activeObj.opacity=d),C.strokeWidth=t||C.strokeWidth,"rectangle"!==(s=b.activeObj.shape)&&"ellipse"!==s||0!==t||(C.strokeWidth=0),C.strokeColor=o||C.strokeColor,C.fillColor=i||""===i?i:C.fillColor,C.radius=u||C.radius,d=100<b.img.destWidth?100:b.img.destWidth/2,s=100<b.img.destHeight?100:b.img.destHeight/2,b.activeObj.activePoint.width=d,b.activeObj.activePoint.height=s,"line"===e||"arrow"===e?(b.activeObj.lineDraw="horizontal",b.activeObj.activePoint.height=0,"arrow"===e&&(b.activeObj.activePoint.width+=50,b.activeObj.start=this.getArrowType(l),b.activeObj.end=this.getArrowType(p))):"rectangle"===e?b.activeObj.activePoint.width+=b.activeObj.activePoint.width/2:"redact"===e&&g&&(b.activeObj.redactType=g.toLowerCase(),g===m.RedactType.Blur?v&&(b.activeObj.redactBlur=v):v&&(b.activeObj.redactPixelate=v),b.activeObj.redactImage=b.createElement("canvas")),this.setDimension(n,a),r?(b.activeObj.activePoint.startX=r.x,b.activeObj.activePoint.startY=r.y,b.activeObj.activePoint.endX=b.activeObj.activePoint.startX+b.activeObj.activePoint.width,b.activeObj.activePoint.endY=b.activeObj.activePoint.startY+b.activeObj.activePoint.height):this.setCenterPoints(),this.setPointCollForLineAndArrow(),"arrow"===e&&(b.activeObj.triangleDirection="right"),b.currObjType.isDragging=b.currObjType.isCustomCrop=!1,this.initShapeProps(),b.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!(t={shapeSettingsObj:{}}),value:{obj:t}}),b.trigger("shapeChanging",i={cancel:!1,action:"insert",previousShapeSettings:o=t.shapeSettingsObj,currentShapeSettings:o}),b.editCompleteArgs=i,this.updateShapeChangeEventArgs(i.currentShapeSettings,i.allowShapeOverflow),this.setDimension(n,a),b.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),h&&(b.activeObj.rotatedAngle=h*(Math.PI/180),b.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:b.activeObj}})),b.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}),b.notify("selection",{prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}}),b.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:f}}),"redact"===e?b.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"redact",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):b.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),b.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),b.isPublicMethod&&!c&&b.notify("undo-redo",{prop:"updateUndoRedo",value:{operation:"shapeInsert"},onPropertyChange:!1}),b.isPublicMethod=!1)},h.prototype.initShapeProps=function(){var e=this.parent;e.activeObj.shapeDegree=e.transform.degree,e.activeObj.shapeFlip=e.transform.currFlipState,e.activeObj.textFlip=e.transform.currFlipState,e.activeObj.flipObjColl=[],e.activeObj.order=this.getNewOrder()},h.prototype.setPointCollForLineAndArrow=function(){var e=this.parent,t=e.activeObj.shape,o=e.activeObj.activePoint,i=o.startX,r=o.startY,n=o.endX,o=o.endY;if(("line"===t||"arrow"===t)&&(e.activeObj.pointColl=this.getLinePoints(i,r,n,o),e.activeObj.pointColl))for(var a=0,s=e.activeObj.pointColl.length;a<s;a++)e.activeObj.pointColl[a].ratioX=(e.activeObj.pointColl[a].x-e.img.destLeft)/e.img.destWidth,e.activeObj.pointColl[a].ratioY=(e.activeObj.pointColl[a].y-e.img.destTop)/e.img.destHeight},h.prototype.prevObjColl=function(){var e=this.parent,t={currObj:{}},t=(e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:t}}),this.prevObj=t.currObj,this.prevObj.objColl=T.extend([],e.objColl,[],!0),this.prevObj.pointColl=T.extend([],e.pointColl,[],!0),this.prevObj.afterCropActions=T.extend([],e.afterCropActions,[],!0),{selPointColl:null});e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:t}}),this.prevObj.selPointColl=T.extend([],t.selPointColl,[],!0)},h.prototype.drawShapeText=function(e,t,o,i,r,n,a,s,l,p,h,d,c,u){var g=this.parent;if(!g.disabled&&g.isImageLoaded){"freehanddraw"===g.currObjType.shape&&(this.apply(),g.upperCanvas.style.cursor=g.cursor="default",g.currObjType.shape=""),g.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),g.togglePen=!1,this.redrawActObj(),this.prevObjColl(),this.refreshActiveObj(),g.activeObj.shape=g.currObjType.shape="text",g.currObjType.isCustomCrop=!1,this.initializeTextShape(e,t,o,i,r,n,h,d,c),g.currObjType.isText=g.currObjType.isInitialText=!0,T.isNullOrUndefined(g.activeObj.textSettings.fontSize)&&(g.getFontSizes(),g.activeObj.textSettings.fontSize=parseInt(g.fontSizeColl[parseInt("3",10)-1].text,10)),g.img.destWidth<100?g.activeObj.textSettings.fontSize=Math.floor(g.img.destWidth/20):g.img.destHeight<100&&(g.activeObj.textSettings.fontSize=Math.floor(g.img.destHeight/20)),g.activeObj.shapeDegree=g.transform.degree,g.activeObj.shapeFlip=g.transform.currFlipState,g.activeObj.flipObjColl=[],this.updateFontStyles(),g.activeObj.order=this.getNewOrder();t=this.upperContext.measureText(g.activeObj.textSettings.text).width+.5*g.activeObj.textSettings.fontSize,i=g.activeObj.textSettings.fontSize;if(e&&(g.activeObj.keyHistory=e,r=(r=this.getMaxText())||g.activeObj.textSettings.text,t=this.upperContext.measureText(r).width+.5*g.activeObj.textSettings.fontSize,1<(n=e.split("\n")).length)&&(i=n.length*g.activeObj.textSettings.fontSize,i+=.25*o),T.isNullOrUndefined(a)||T.isNullOrUndefined(s)?this.setCenterPoints(!0,t,i):(g.activeObj.activePoint.startX=a,g.activeObj.activePoint.startY=s,g.activeObj.activePoint.endX=g.activeObj.activePoint.startX+t,g.activeObj.activePoint.endY=g.activeObj.activePoint.startY+i),u){g.notify("selection",{prop:"setTransformedShape",onPropertyChange:!1,value:{bool:!0}}),this.setTransformColl(u);for(var h=g.activeObj,v=(h.shapeDegree=0,h.shapeFlip="",0),f=h.rotateFlipColl,C=0;C<f.length;C++)"number"==typeof f[C]&&(v+=f[C]);v%90==0&&Math.abs(v)%180==90&&(h.activePoint.endX=h.activePoint.startX+i,h.activePoint.endY=h.activePoint.startY+t,h.activePoint.width=h.activePoint.endX-h.activePoint.startX,h.activePoint.height=h.activePoint.endY-h.activePoint.startY)}d={shapeSettingsObj:{}},c=(g.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:d}}),d.shapeSettingsObj),r={cancel:!1,action:"insert",previousShapeSettings:c,currentShapeSettings:c};g.trigger("shapeChanging",r),g.editCompleteArgs=r,this.drawShapeTextEvent(r),p&&(g.activeObj.rotatedAngle=p*(Math.PI/180),g.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:g.activeObj}}),this.upperContext.clearRect(0,0,g.upperCanvas.width,g.upperCanvas.height),g.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:g.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}),g.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),g.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})),e&&-1<e.indexOf("\n")&&g.isPublicMethod&&(n=String(g.fontSizeColl.findIndex(function(e){return e.text===String(g.activeObj.textSettings.fontSize)})+1),g.noPushUndo=!0,g.updateFontSize("5"),0<parseInt(n,10)&&g.updateFontSize(n),g.noPushUndo=!1),g.isPublicMethod&&!l&&g.notify("undo-redo",{prop:"updateUndoRedo",value:{operation:"shapeInsert"},onPropertyChange:!1}),g.isPublicMethod=!1}},h.prototype.drawShapeImageEvent=function(e,t){var o=this.parent,e=(this.updateShapeChangeEventArgs(e.currentShapeSettings,e.allowShapeOverflow),o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),o.objColl.push(o.activeObj),T.extend({},o.cropObj,{},!0));o.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeInsert",previousObj:this.prevObj,previousObjColl:this.prevObj.objColl,previousPointColl:this.prevObj.pointColl,previousSelPointColl:this.prevObj.selPointColl,previousCropObj:e,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),o.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:o.objColl[o.objColl.length-1]}}),t?(o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),o.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),o.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})):o.okBtn(null,!0),o.notify("selection",{prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}})},h.prototype.setTransformColl=function(e){var t=this.parent;if(t.activeObj.rotateFlipColl=[],e)for(var o=0;o<e.length;o++)e[o].degree?t.activeObj.rotateFlipColl.push(e[o].degree):t.activeObj.rotateFlipColl.push(e[o].flip.toLowerCase())},h.prototype.drawShapeTextEvent=function(e){var t=this.parent,e=(this.updateShapeChangeEventArgs(e.currentShapeSettings,e.allowShapeOverflow),this.addLetter(t.activeObj.textSettings.text),t.activeObj.textFlip=t.transform.currFlipState,this.updateFontRatio(t.activeObj),t.objColl.push(t.activeObj),T.extend({},t.cropObj,{},!0));t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeInsert",previousObj:this.prevObj,previousObjColl:this.prevObj.objColl,previousPointColl:this.prevObj.pointColl,previousSelPointColl:this.prevObj.selPointColl,previousCropObj:e,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),t.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:t.objColl[t.objColl.length-1]}}),t.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}),t.notify("selection",{prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}}),t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),t.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1})},h.prototype.initializeTextShape=function(e,t,o,i,r,n,a,s,l){var p=this.parent;this.keyHistory="",p.upperCanvas.style.display="block",p.activeObj.strokeSettings.strokeColor=n||p.activeObj.strokeSettings.strokeColor,p.activeObj.strokeSettings.fillColor=a||p.activeObj.strokeSettings.fillColor,p.activeObj.textSettings.text=e||p.activeObj.textSettings.text,p.activeObj.textSettings.fontFamily=t||p.activeObj.textSettings.fontFamily,p.activeObj.textSettings.fontSize=o||p.activeObj.textSettings.fontSize,p.activeObj.textSettings.bold=i||p.activeObj.textSettings.bold,p.activeObj.textSettings.italic=r||p.activeObj.textSettings.italic,p.activeObj.strokeSettings.outlineColor=s||p.activeObj.strokeSettings.outlineColor,p.activeObj.strokeSettings.outlineWidth=l||p.activeObj.strokeSettings.outlineWidth},h.prototype.drawImage=function(e,t,o,i,r,n,a,s,l){this.initializeShape("image"),this.onLoadImgShape(e,t,o,i,r,null,n,a,s,l)},h.prototype.redrawActObj=function(e,t,o){var i,r=this.parent;r.activeObj.shape&&(i=r.activeObj.shape.split("-")),r.activeObj.horTopLine&&r.activeObj.shape&&"crop"!==i[0]&&("block"===r.textArea.style.display||"inline-block"===r.textArea.style.display?(r.notify("selection",{prop:"setTextBoxStylesToActObj",onPropertyChange:!1}),this.updateFontRatio(r.activeObj,!0),e&&t?e!==r.activeObj.activePoint.startX&&t!==r.activeObj.activePoint.startY&&this.updateTextFromTextArea():(this.updateTextFromTextArea(),r.textArea.style.transform="",r.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})),this.refreshActiveObj()):this.applyActObj(o))},h.prototype.apply=function(e,t,o){var i,r,n,a,s,l=this.parent;l.disabled||(l.togglePen&&!l.currObjType.isCustomCrop?(i=l.img.destLeft,r=l.img.destTop,n=l.img.destWidth,a=l.img.destHeight,l.notify("draw",{prop:"callUpdateCurrTransState",onPropertyChange:!1}),s=this.lowerContext.filter,this.lowerContext.filter="none",l.togglePen=!1,(l.isCircleCrop||l.currSelectionPoint&&"crop-circle"===l.currSelectionPoint.shape)&&l.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),l.img.destLeft=i,l.img.destTop=r,l.img.destWidth=n,l.img.destHeight=a,this.lowerContext.filter=s):(o=o||"original",T.isNullOrUndefined(l.activeObj.shape)&&T.isNullOrUndefined(e)?l.currObjType.shape="":l.currObjType.shape=e||l.currObjType.shape,""!==l.currObjType.shape&&(this.upperContext.clearRect(0,0,l.upperCanvas.width,l.upperCanvas.height),"text"===l.activeObj.shape?l.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:o,obj:t,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}):l.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:o,obj:t}}),l.activeObj.shape=l.currObjType.shape.toLowerCase(),e||""===l.currObjType.shape||l.currObjType.isCustomCrop||l.objColl.push(T.extend({},l.activeObj,{},!0)),this.keyHistory="")))},h.prototype.setCenterPoints=function(e,t,o){var i,r=this.parent,e=e&&t&&o?(i=t,o):(i=r.activeObj.activePoint.width,r.activeObj.activePoint.height);r.activeObj.activePoint.startX=r.lowerCanvas.width/2-i/2,r.activeObj.activePoint.startY=r.lowerCanvas.height/2-e/2,r.activeObj.activePoint.endX=r.lowerCanvas.width/2+i/2,r.activeObj.activePoint.endY=r.lowerCanvas.height/2+e/2},h.prototype.updSelChangeEventArgs=function(e){var t=this.parent;t.activeObj.activePoint={startX:e.startX,startY:e.startY,endX:t.activeObj.activePoint.startX+t.activeObj.activePoint.width,endY:t.activeObj.activePoint.startY+t.activeObj.activePoint.height,width:e.width,height:e.height},t.activeObj.activePoint.endX=t.activeObj.activePoint.startX+t.activeObj.activePoint.width,t.activeObj.activePoint.endY=t.activeObj.activePoint.startY+t.activeObj.activePoint.height},h.prototype.updateShapeChangeEventArgs=function(e,t){var o,i=this.parent;if(e.id&&-1===e.id.indexOf("shape_")&&-1===e.id.indexOf("pen_")&&(i.activeObj.currIndex?i.activeObj.currIndex="shape_"+e.id:i.pointColl[o].id="pen_"+e.id),e.id&&e.id.split("_")[0]&&"pen"===e.id.split("_")[0])o=parseInt(e.id.split("_")[1],10)-1,i.pointColl[o].points=e.points,i.pointColl[o].strokeColor=e.strokeColor,i.pointColl[o].strokeWidth=e.strokeWidth,i.pointColl[o].opacity=e.opacity,i.pointColl[o].order=e.index;else{switch(i.activeObj.activePoint.startX=e.startX,i.activeObj.activePoint.startY=e.startY,e.width&&e.height&&(i.activeObj.activePoint.width=e.width,i.activeObj.activePoint.height=e.height,i.activeObj.activePoint.endX=i.activeObj.activePoint.startX+i.activeObj.activePoint.width,i.activeObj.activePoint.endY=i.activeObj.activePoint.startY+i.activeObj.activePoint.height),"text"!==i.activeObj.shape&&(i.activeObj.strokeSettings.strokeColor=e.strokeColor,i.activeObj.strokeSettings.strokeWidth=e.strokeWidth),i.activeObj.strokeSettings.fillColor=e.fillColor,i.activeObj.opacity=e.opacity,i.activeObj.order=e.index,i.activeObj.preventShapeDragOut=!t,T.isNullOrUndefined(e.degree)&&(e.degree=0),i.activeObj.shape){case"ellipse":i.activeObj.activePoint.width=2*e.radiusX,i.activeObj.activePoint.height=2*e.radiusY,i.activeObj.activePoint.endX=i.activeObj.activePoint.startX+i.activeObj.activePoint.width,i.activeObj.activePoint.endY=i.activeObj.activePoint.startY+i.activeObj.activePoint.height,e.degree&&(i.activeObj.rotatedAngle=e.degree*(Math.PI/180));break;case"line":case"arrow":i.activeObj.activePoint.width=e.length,i.activeObj.activePoint.endX=e.endX,i.activeObj.activePoint.endY=e.endY,i.activeObj.activePoint.width=i.activeObj.activePoint.startX+i.activeObj.activePoint.width,i.activeObj.activePoint.height=i.activeObj.activePoint.startY+i.activeObj.activePoint.height,"arrow"===i.activeObj.shape&&(i.activeObj.start=this.getArrowType(e.arrowHead),i.activeObj.end=this.getArrowType(e.arrowTail));break;case"text":i.activeObj.keyHistory=i.activeObj.textSettings.text=e.text,i.activeObj.textSettings.fontSize=e.fontSize,i.activeObj.strokeSettings.strokeColor=e.color,i.activeObj.strokeSettings.outlineColor=e.strokeColor,i.activeObj.strokeSettings.outlineWidth=e.strokeWidth,i.activeObj.strokeSettings.fillColor=e.fillColor,i.activeObj.textSettings.fontFamily=e.fontFamily,this.setTransformColl(e.transformCollection),e.degree&&(i.activeObj.rotatedAngle=e.degree*(Math.PI/180)),this.updateFontRatio(i.activeObj);break;case"rectangle":case"image":e.degree&&(i.activeObj.rotatedAngle=e.degree*(Math.PI/180));break;case"path":i.activeObj.pointColl=e.points}if("text"===i.activeObj.shape&&i.activeObj.textSettings){i.activeObj.textSettings.bold=!1,i.activeObj.textSettings.italic=!1,i.activeObj.textSettings.underline=!1;for(var r=0;r<e.fontStyle.length;r++)switch(e.fontStyle[r]){case"bold":i.activeObj.textSettings.bold=!0;break;case"italic":i.activeObj.textSettings.italic=!0}}}},h.prototype.addLetter=function(e){var t,o=this.parent;"none"!==o.textArea.style.display||!o.currObjType.isText&&"text"!==o.activeObj.shape||(t=o.activeObj.textSettings.fontSize,"Backspace"===e?this.keyHistory=this.keyHistory.slice(0,-1):this.keyHistory+=e,this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),this.updateFontStyles(),e=this.upperContext.measureText(this.keyHistory).width+.5*t,this.upperContext.fillText(this.keyHistory,o.activeObj.activePoint.startX,o.activeObj.activePoint.startY+(t=t)),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.currObjType.isText=!0,o.notify("selection",{prop:"setActivePoint",onPropertyChange:!1,value:{startX:e,startY:t}}))},h.prototype.redrawText=function(){var e=this.parent,t=e.activeObj.textSettings,o=t.fontSize,i=t.fontFamily,r="",t=(t.bold&&(r+="bold "),t.italic&&(r+="italic "),this.upperContext.font=r+o+"px "+i,e.activeObj.keyHistory.split("\n")),r="block"===e.textArea.style.display||"inline-block"===e.textArea.style.display?this.getMaxText(!0):this.getMaxText(),i=this.upperContext.measureText(r).width+.5*o,r=t.length*o;1<t.length&&(r+=.5*o),e.notify("selection",{prop:"setTextSelection",onPropertyChange:!1,value:{width:i,height:r}}),e.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:e.activeObj.activePoint,obj:e.activeObj,isMouseMove:null,x:null,y:null}}),e.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:e.activeObj}})},h.prototype.updateTextFromTextArea=function(){var e,t=this.parent,o=!1,i=t.activeObj.textSettings.fontSize,r=T.extend({},t.activeObj,{},!0),n=T.extend({},t.cropObj,{},!0),a={currObj:{}},a=(t.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}}),a.currObj),s=(a.objColl=T.extend([],t.objColl,[],!0),a.pointColl=T.extend([],t.pointColl,[],!0),a.afterCropActions=T.extend([],t.afterCropActions,[],!0),{selPointColl:null}),s=(t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}}),a.selPointColl=T.extend([],s.selPointColl,[],!0),t.activeObj.keyHistory!==t.textArea.value&&(o=!0),t.activeObj.keyHistory=t.textArea.value,t.textArea.style.display="none",t.textArea.value="",this.updateFontStyles(),this.upperContext.measureText(t.activeObj.keyHistory).width+.5*i),l=i,p=t.activeObj.keyHistory.split("\n");if(1<p.length){for(var l=(l*=p.length)+.1*i*p.length,h=[],d=0,c=p.length;d<c;d++)h.push(this.upperContext.measureText(p[d]).width+.5*i);s=Math.max.apply(Math,h)}t.notify("selection",{prop:"setTextSelection",onPropertyChange:!1,value:{width:s,height:l}}),0!==t.activeObj.rotatedAngle&&(s=t.activeObj.activePoint.width-r.activePoint.width,l=t.activeObj.activePoint.height-r.activePoint.height,e="",0<s&&0<l?e="widthHeight":0!=s?e="width":0!=l&&(e="height"),t.activeObj.activePoint=T.extend({},r.activePoint,{},!0),t.notify("selection",{prop:"adjustRotationPoints",onPropertyChange:!1,value:{rectangle:t.activeObj.activePoint,x:s,y:l,angle:t.activeObj.rotatedAngle,type:"text",elem:e}}),t.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:t.activeObj}})),t.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:t.activeObj.activePoint,obj:t.activeObj,isMouseMove:null,x:null,y:null}}),this.updImgRatioForActObj(),0!==t.activeObj.rotatedAngle&&t.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:t.activeObj}}),o?(this.apply(t.activeObj.shape,t.activeObj),t.objColl.push(T.extend({},t.activeObj,{},!0)),t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"text",previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:n,previousText:t.activeObj.keyHistory,currentText:t.textArea.value,previousFilter:null,isCircleCrop:null}})):(this.apply(t.activeObj.shape,t.activeObj),t.objColl.push(T.extend({},t.activeObj,{},!0)))},h.prototype.iterateObjColl=function(){var e=this.parent;if(0<e.objColl.length)for(var t=this.getSmallestIndex(),o=T.extend([],e.objColl,[],!0);0<o.length;){for(var i=!1,r=0;r<o.length;r++){var n=o[r];if(T.isNullOrUndefined(n.order))o.splice(r,1),r--;else if(n.order===t){this.apply(n.shape,n),"redact"===n.shape&&JSON.stringify(n.activePoint)===JSON.stringify(e.activeObj.activePoint)&&n.redactImage!==e.activeObj.redactImage&&(n.redactImage=e.activeObj.redactImage,e.objColl[r])&&JSON.stringify(e.objColl[r].activePoint)===JSON.stringify(n.activePoint)&&(e.objColl[r].redactImage=e.activeObj.redactImage),this.refreshActiveObj(),t++,this.isIndexInObjColl(t)||t++,o.splice(r,1),i=!0;break}}if(!i)break}},h.prototype.getSmallestIndex=function(){for(var e,t=this.parent,o=0,i=t.objColl.length;o<i;o++){var r=t.objColl[o];T.isNullOrUndefined(r.order)||(T.isNullOrUndefined(e)||r.order<e)&&(e=r.order)}return e},h.prototype.isIndexInObjColl=function(e){for(var t=this.parent,o=0,i=t.objColl.length;o<i;o++){var r=t.objColl[o];if(!T.isNullOrUndefined(r.order)&&r.order===e)return!0}return!1},h.prototype.updImgRatioForActObj=function(){var e=this.parent,t={startX:e.img.destLeft,startY:e.img.destTop,width:e.img.destWidth,height:e.img.destHeight},o=(this.straightenShapes(),e.img),i=o.destLeft,r=o.destTop,n=o.destWidth,o=o.destHeight,a=e.activeObj.activePoint;e.activeObj.imageRatio={startX:(a.startX-i)/n,startY:(a.startY-r)/o,endX:(a.endX-i)/n,endY:(a.endY-r)/o,width:n/a.width,height:o/a.height},e.activeObj.rotationCirclePointColl&&(e.activeObj.rotationCirclePointColl.ratioX=(e.activeObj.rotationCirclePointColl.x-i)/n,e.activeObj.rotationCirclePointColl.ratioY=(e.activeObj.rotationCirclePointColl.y-r)/o),"path"===e.activeObj.shape?this.updatePathRatio(e.activeObj):"arrow"===e.activeObj.shape&&this.updateArrowRatio(e.activeObj),e.img.destLeft=t.startX,e.img.destTop=t.startY,e.img.destWidth=t.width,e.img.destHeight=t.height},h.prototype.zoomObjColl=function(e){var t=this.parent,o={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};if(this.straightenShapes(),0<t.objColl.length){for(var i=0,r=t.objColl.length;i<r;i++){var n=t.objColl[i];if(n.imageRatio&&(n.activePoint.startX=n.imageRatio.startX*t.img.destWidth+t.img.destLeft,n.activePoint.startY=n.imageRatio.startY*t.img.destHeight+t.img.destTop,n.activePoint.endX=n.imageRatio.endX*t.img.destWidth+t.img.destLeft,n.activePoint.endY=n.imageRatio.endY*t.img.destHeight+t.img.destTop),"text"===(n=this.updateWidthHeight(n)).shape)this.updateFontSize(n);else if("line"===n.shape||"arrow"===n.shape){n.pointColl=this.getLinePoints(n.activePoint.startX,n.activePoint.startY,n.activePoint.endX,n.activePoint.endY);for(var a=0,s=n.pointColl.length;a<s;a++)n.pointColl[a].ratioX=(n.pointColl[a].x-t.img.destLeft)/t.img.destWidth,n.pointColl[a].ratioY=(n.pointColl[a].y-t.img.destTop)/t.img.destHeight;"arrow"===n.shape&&this.updateArrowSize(n),0===t.transform.straighten||"line"!==n.shape&&"arrow"!==n.shape||this.straightenShapePoints(n)}else if("path"===n.shape){for(var l=0,p=n.pointColl.length;l<p;l++)n.pointColl[l].x=n.pointColl[l].ratioX*t.img.destWidth+t.img.destLeft,n.pointColl[l].y=n.pointColl[l].ratioY*t.img.destHeight+t.img.destTop;this.updatePathRatio(n),0!==t.transform.straighten&&this.straightenPath(n)}t.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:n.activePoint,obj:n}}),"line"!==n.shape&&"arrow"!==n.shape&&"path"!==n.shape&&0!==n.rotatedAngle&&(this.setPointCollForShapeRotation(n),n.rotationCirclePoint.x=n.rotationCirclePoint.ratioX*t.img.destWidth+t.img.destLeft,n.rotationCirclePoint.y=n.rotationCirclePoint.ratioY*t.img.destHeight+t.img.destTop,n.rotationCirclePointColl)&&(n.rotationCirclePointColl.x=n.rotationCirclePointColl.ratioX*t.img.destWidth+t.img.destLeft,n.rotationCirclePointColl.y=n.rotationCirclePointColl.ratioY*t.img.destHeight+t.img.destTop)}T.isNullOrUndefined(e)&&(e=this.lowerContext.filter,this.lowerContext.filter="none",this.iterateObjColl(),this.lowerContext.filter=e)}t.img.destLeft=o.startX,t.img.destTop=o.startY,t.img.destWidth=o.width,t.img.destHeight=o.height},h.prototype.straightenPath=function(e){for(var t,o=0,i=e.pointColl.length;o<i;o++)t=this.straightenPoints(e.pointColl[o].x,e.pointColl[o].y),e.pointColl[o].x=t.x,e.pointColl[o].y=t.y},h.prototype.straightenFHD=function(){for(var e=this.parent,t=0,o=e.freehandCounter;t<o;t++){e.points=T.extend([],e.pointColl[t].points,[]);for(var i=e.points.length,r=void 0,n=0;n<i;n++)r=this.straightenPoints(e.points[n].x,e.points[n].y),e.points[n].x=r.x,e.points[n].y=r.y}var a={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}});for(t=0,o=e.freehandCounter;t<o;t++)if(a.selPointColl[t]&&a.selPointColl[t].points)for(i=a.selPointColl[t].points.length,r=void 0,n=0;n<i;n++)r=this.straightenPoints(a.selPointColl[t].points[n].x,a.selPointColl[t].points[n].y),a.selPointColl[t].points[n].x=r.x,a.selPointColl[t].points[n].y=r.y;var s,l={straightenPoint:null};e.notify("freehand-draw",{prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:l}}),l.straightenPoint.x&&l.straightenPoint.y&&(e.notify("freehand-draw",{prop:"getStraightenPointAngle",onPropertyChange:!(s={angle:0}),value:{obj:s}}),s=((360===e.transform.straighten?0:e.transform.straighten)-s.angle)*(Math.PI/180),r=this.straightenPoints(l.straightenPoint.x,l.straightenPoint.y,s),0==s&&(r.x=l.straightenPoint.x,r.y=l.straightenPoint.y),e.notify("freehand-draw",{prop:"setStraightenPoint",onPropertyChange:!1,value:{x:r.x,y:r.y}}))},h.prototype.straightenPoints=function(e,t,o){var i=this.parent,r=i.img.destLeft+i.img.destWidth/2,n=i.img.destTop+i.img.destHeight/2;return o=o||i.transform.straighten*(Math.PI/180),{x:Math.cos(o)*(e-r)-Math.sin(o)*(t-n)+r,y:Math.sin(o)*(e-r)+Math.cos(o)*(t-n)+n}},h.prototype.straightenShapes=function(){var e,t,o,i=this.parent,r=i.img,n=r.destLeft,a=r.destTop,s=r.destWidth,r=r.destHeight;i.isStraightening&&0!==i.transform.straighten&&(i.notify("draw",{prop:"updateImgCanvasPoints"}),i.notify("draw",{prop:"getImageCanvasPoints",value:{obj:e={points:null}}}),n=n+s/2,s=a+r/2,a=-(i.transform.straighten*(Math.PI/180)),r={x:Math.cos(a)*(e.points[0].x-n)-Math.sin(a)*(e.points[0].y-s)+n,y:Math.sin(a)*(e.points[0].x-n)+Math.cos(a)*(e.points[0].y-s)+s},t=Math.cos(a)*(e.points[1].x-n)-Math.sin(a)*(e.points[1].y-s)+n,o=Math.sin(a)*(e.points[1].x-n)+Math.cos(a)*(e.points[1].y-s)+s,Math.cos(a),e.points[2].x,Math.sin(a),e.points[2].y,n=Math.sin(a)*(e.points[2].x-n)+Math.cos(a)*(e.points[2].y-s)+s,i.img.destWidth=t-r.x,i.img.destHeight=n-o,i.img.destLeft=r.x,i.img.destTop=r.y)},h.prototype.straightenShapePoints=function(e,t){var o=this.parent,i=o.img,r=i.destLeft,n=i.destTop,a=i.destWidth,i=i.destHeight;!o.isStraightening||"line"!==e.shape&&"arrow"!==e.shape||(e.activePoint.width=e.activePoint.endX>e.activePoint.startX?e.activePoint.endX-e.activePoint.startX:e.activePoint.startX-e.activePoint.endX,e.activePoint.height=e.activePoint.endY>e.activePoint.startY?e.activePoint.endY-e.activePoint.startY:e.activePoint.startY-e.activePoint.endY,r=r+a/2,a=n+i/2,n=(t?-o.transform.straighten:o.transform.straighten)*(Math.PI/180),i={x:Math.cos(n)*(e.activePoint.startX-r)-Math.sin(n)*(e.activePoint.startY-a)+r,y:Math.sin(n)*(e.activePoint.startX-r)+Math.cos(n)*(e.activePoint.startY-a)+a},t={x:Math.cos(n)*(e.activePoint.endX-r)-Math.sin(n)*(e.activePoint.endY-a)+r,y:Math.sin(n)*(e.activePoint.endX-r)+Math.cos(n)*(e.activePoint.endY-a)+a},e.activePoint.startX=i.x,e.activePoint.startY=i.y,e.activePoint.endX=t.x,e.activePoint.endY=t.y,e.activePoint.width=e.activePoint.endX>e.activePoint.startX?e.activePoint.endX-e.activePoint.startX:e.activePoint.startX-e.activePoint.endX,e.activePoint.height=e.activePoint.endY>e.activePoint.startY?e.activePoint.endY-e.activePoint.startY:e.activePoint.startY-e.activePoint.endY,o.notify("selection",{prop:"adjustActObjForLineArrow",onPropertyChange:!1,value:{obj:e}}))},h.prototype.redrawObj=function(e){var t=this.parent,o=!1;if(0<t.objColl.length)if("horizontal"===e||"vertical"===e||"Horizontal"===e||"Vertical"===e||"horizontalVertical"===e||"verticalHorizontal"===e)this.updateCurrentActiveObjPoint(e.toLowerCase());else if("number"==typeof e){this.updateCurrentActiveObjPoint(e);e=this.lowerContext.filter;this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)";for(var i=0,r=t.objColl.length;i<r;i++)"crop"!==t.objColl[i].shape.split("-")[0]&&(this.apply(t.objColl[i].shape,t.objColl[i]),o=!0);o&&t.notify("draw",{prop:"applyFrame",value:{ctx:this.lowerContext,frame:t.frameObj.type,preventImg:!0}}),this.lowerContext.filter=e}},h.prototype.updateCurrentActiveObjPoint=function(e){for(var t,o=this.parent,i=o.img,r=i.destLeft,n=i.destTop,a=i.destWidth,s=i.destHeight,l=0,p=o.objColl.length;l<p;l++){var h=o.objColl[l];if(o.activeObj.shape===h.shape&&o.activeObj.activePoint.startX===h.activePoint.startX&&o.activeObj.activePoint.startY===h.activePoint.startY&&o.activeObj.activePoint.endX===h.activePoint.endX&&o.activeObj.activePoint.endY===h.activePoint.endY&&o.activeObj.currIndex===h.currIndex){t=l;break}}if("horizontal"===e||"vertical"===e||"Horizontal"===e||"Vertical"===e||"horizontalvertical"===e||"verticalhorizontal"===e){if("horizontal"===e||"Horizontal"===e)for(var d=0,p=o.objColl.length;d<p;d++)(h=o.objColl[d]).shapeFlip!==o.transform.currFlipState&&(h.activePoint.startX<=r+a/2?(h.activePoint.endX=r+a-(h.activePoint.startX-r),h.activePoint.startX=h.activePoint.endX-h.activePoint.width,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})):h.activePoint.startX>=r+a/2&&(h.activePoint.startX=r+(r+a-h.activePoint.endX),h.activePoint.endX=h.activePoint.startX+h.activePoint.width,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})),"line"===h.shape||"arrow"===h.shape||"path"===h.shape?this.flipLineArrowObj(h,"horizontal"):0!==h.rotatedAngle&&(h.rotatedAngle=h.rotatedAngle+2*(Math.PI-h.rotatedAngle),h.rotationCirclePointColl.x<=r+a/2?h.rotationCirclePointColl.x=r+a-(h.rotationCirclePointColl.x-r):h.rotationCirclePointColl.x>=r+a/2&&(h.rotationCirclePointColl.x=r+(r+a-h.rotationCirclePointColl.x)),h.rotationCirclePointColl.ratioX=(h.rotationCirclePointColl.x-r)/a),h.shapeFlip=o.transform.currFlipState,h.imageRatio={startX:(h.activePoint.startX-r)/a,startY:(h.activePoint.startY-n)/s,endX:(h.activePoint.endX-r)/a,endY:(h.activePoint.endY-n)/s,width:a/h.activePoint.width,height:s/h.activePoint.height});else if("vertical"===e||"Vertical"===e)for(d=0;d<o.objColl.length;d++)(h=o.objColl[d]).shapeFlip!==o.transform.currFlipState&&(h.activePoint.startY<=n+s/2?(h.activePoint.endY=n+s-(h.activePoint.startY-n),h.activePoint.startY=h.activePoint.endY-h.activePoint.height,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})):h.activePoint.startY>=o.lowerCanvas.height/2&&(h.activePoint.startY=n+(n+s-h.activePoint.endY),h.activePoint.endY=h.activePoint.startY+h.activePoint.height,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})),"line"===h.shape||"arrow"===h.shape||"path"===h.shape?this.flipLineArrowObj(h,"vertical"):0!==h.rotatedAngle&&(h.rotatedAngle=-h.rotatedAngle,h.rotationCirclePointColl.y<=n+s/2?h.rotationCirclePointColl.y=n+s-(h.rotationCirclePointColl.y-n):h.rotationCirclePointColl.y>=n+s/2&&(h.rotationCirclePointColl.y=n+(n+s-h.rotationCirclePointColl.y)),h.rotationCirclePointColl.ratioY=(h.rotationCirclePointColl.y-n)/s),h.shapeFlip=o.transform.currFlipState,h.imageRatio={startX:(h.activePoint.startX-r)/a,startY:(h.activePoint.startY-n)/s,endX:(h.activePoint.endX-r)/a,endY:(h.activePoint.endY-n)/s,width:a/h.activePoint.width,height:s/h.activePoint.height});else if("verticalhorizontal"===e||"horizontalvertical"===e)for(d=0,p=o.objColl.length;d<p;d++)(h=o.objColl[d]).shapeFlip!==o.transform.currFlipState&&(h.activePoint.startX<=r+a/2?(h.activePoint.endX=r+a-(h.activePoint.startX-r),h.activePoint.startX=h.activePoint.endX-h.activePoint.width,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})):h.activePoint.startX>=r+a/2&&(h.activePoint.startX=r+(r+a-h.activePoint.endX),h.activePoint.endX=h.activePoint.startX+h.activePoint.width,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})),h.activePoint.startY<=n+s/2?(h.activePoint.endY=n+s-(h.activePoint.startY-n),h.activePoint.startY=h.activePoint.endY-h.activePoint.height,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})):h.activePoint.startY>=o.lowerCanvas.height/2&&(h.activePoint.startY=n+(n+s-h.activePoint.endY),h.activePoint.endY=h.activePoint.startY+h.activePoint.height,o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})),"line"!==h.shape&&"arrow"!==h.shape&&"path"!==h.shape||this.flipLineArrowObj(h,e),h.shapeFlip=o.transform.currFlipState,h.imageRatio={startX:(h.activePoint.startX-r)/a,startY:(h.activePoint.startY-n)/s,endX:(h.activePoint.endX-r)/a,endY:(h.activePoint.endY-n)/s,width:a/h.activePoint.width,height:s/h.activePoint.height});void 0!==t&&(o.activeObj=T.extend({},o.objColl[t],{},!0))}else if(90===e)this.rotateObjColl();else if(-90===e)for(d=0;d<3;d++)this.rotateObjColl();else if("number"==typeof e)if(0<e)this.rotateObjColl();else for(d=0;d<3;d++)this.rotateObjColl()},h.prototype.rotateObjColl=function(){for(var e=this.parent,t=e.img,o=t.destWidth,i=t.destHeight,r=t.destLeft,n=t.destTop,a=0,s=e.objColl.length;a<s;a++){var l=(p=e.objColl[a]).shape;p.activePoint.startY=n+i*p.imageRatio.startX,p.activePoint.endY=n+i*p.imageRatio.endX,p.activePoint.startX=r+o-o*p.imageRatio.endY,p.activePoint.endX=r+o-o*p.imageRatio.startY,p=this.updateWidthHeight(e.objColl[a]),this.updateFontSize(p),"line"===l||"arrow"===l||"path"===l?(this.rotateLineArrowObj(p),"arrow"===l&&this.updateArrowSize(p)):0!==p.rotatedAngle&&(p.rotationCirclePointColl.y=n+i*p.rotationCirclePointColl.ratioX,p.rotationCirclePointColl.x=r+o-o*p.rotationCirclePointColl.ratioY,p.rotationCirclePointColl.ratioX=(p.rotationCirclePointColl.x-r)/o,p.rotationCirclePointColl.ratioY=(p.rotationCirclePointColl.y-n)/i)}for(a=0,s=e.objColl.length;a<s;a++)e.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:e.objColl[a].activePoint,obj:e.objColl[a]}});for(var p,a=0,s=e.objColl.length;a<s;a++)(p=e.objColl[a]).imageRatio={startX:(p.activePoint.startX-r)/o,startY:(p.activePoint.startY-n)/i,endX:(p.activePoint.endX-r)/o,endY:(p.activePoint.endY-n)/i,width:o/p.activePoint.width,height:i/p.activePoint.height}},h.prototype.rotateLineArrowObj=function(e){if(!T.isNullOrUndefined(e.pointColl)){var t=this.parent.img,o=t.destWidth,i=t.destHeight,r=t.destLeft,n=t.destTop;if(0<e.pointColl.length){for(var a=0;a<e.pointColl.length;a++)e.pointColl[a].y=n+i*e.pointColl[a].ratioX,e.pointColl[a].x=r+o-o*e.pointColl[a].ratioY;for(a=0;a<e.pointColl.length;a++)e.pointColl[a].ratioX=(e.pointColl[a].x-r)/o,e.pointColl[a].ratioY=(e.pointColl[a].y-n)/i;var t=void 0,t=T.isNullOrUndefined(e.pointColl[e.pointColl.length-2])?{x:0,y:0}:{x:e.pointColl[e.pointColl.length-2].x,y:e.pointColl[e.pointColl.length-2].y},s=e.pointColl[e.pointColl.length-1].x-t.x,t=e.pointColl[e.pointColl.length-1].y-t.y;e.activePoint.startX=e.pointColl[0].x,e.activePoint.startY=e.pointColl[0].y,e.activePoint.endX=e.pointColl[e.pointColl.length-1].x+s/2,e.activePoint.endY=e.pointColl[e.pointColl.length-1].y+t/2,this.updateWidthHeight(e)}}},h.prototype.flipLineArrowObj=function(e,t){t=t.toLowerCase(),T.isNullOrUndefined(e.pointColl)||("horizontal"===t?this.lineArrowHorizontalFlip(e):("vertical"!==t&&(this.lineArrowHorizontalFlip(e),e.shapeFlip=""),this.lineArrowVerticalFlip(e)),e.activePoint.startX=e.pointColl[0].x,e.activePoint.startY=e.pointColl[0].y,e.activePoint.endX=e.pointColl[e.pointColl.length-1].x,e.activePoint.endY=e.pointColl[e.pointColl.length-1].y,e.activePoint.startX>e.activePoint.endX&&(t=e.activePoint.startX,e.activePoint.startX=e.activePoint.endX,e.activePoint.endX=t,t=e.activePoint.startY,e.activePoint.startY=e.activePoint.endY,e.activePoint.endY=t))},h.prototype.lineArrowHorizontalFlip=function(e){var t=this.parent,o=t.img,i=o.destWidth,r=o.destHeight,n=o.destLeft,a=o.destTop;if(e.shapeFlip!==t.transform.currFlipState){for(var s=0,l=e.pointColl.length;s<l;s++){var p=e.pointColl[s];p.x<=n+i/2?p.x=n+i-(p.x-n):p.x>=n+i/2&&(p.x=n+(n+i-p.x)),p.ratioX=(p.x-n)/i,p.ratioY=(p.y-a)/r}"arrow"===e.shape&&(o=e.start,e.start=e.end,e.end=o),e.shapeFlip=t.transform.currFlipState}},h.prototype.lineArrowVerticalFlip=function(e){var t=this.parent,o=t.img,i=o.destWidth,r=o.destHeight,n=o.destLeft,a=o.destTop;if(e.shapeFlip!==t.transform.currFlipState){for(var s=0,l=e.pointColl.length;s<l;s++){var p=e.pointColl[s];p.y<=a+r/2?p.y=a+r-(p.y-a):p.y>=a+r/2&&(p.y=a+(a+r-p.y)),p.ratioX=(p.x-n)/i,p.ratioY=(p.y-a)/r}e.shapeFlip=t.transform.currFlipState}},h.prototype.getRotDegOfShape=function(e,t){var o=this.parent,e=((i=0===e.shapeDegree?this.parent.transform.degree:this.parent.transform.degree-e.shapeDegree)<0&&(i=360+i),{bool:!1});if(o.notify("selection",{prop:"getTransformedShape",onPropertyChange:!1,value:{obj:e}}),e.bool&&!t&&o.activeObj.rotateFlipColl)for(var i=0,r=0;r<o.activeObj.rotateFlipColl.length;r++)"number"==typeof o.activeObj.rotateFlipColl[r]&&(i+=o.activeObj.rotateFlipColl[r]);return i},h.prototype.renderTextArea=function(e,t,o){var i=this.parent,r={shapeSettingsObj:{}},r=(i.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:r}}),r.shapeSettingsObj),r={cancel:!1,action:"text-edit",previousShapeSettings:r,currentShapeSettings:r},r=(i.trigger("shapeChanging",r),this.updateShapeChangeEventArgs(r.currentShapeSettings,r.allowShapeOverflow),this.getRotDegOfShape(i.activeObj)),n=(this.transformTextArea(),i.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),i.element.querySelector("#"+i.element.id+"_zOrderBtn")),a=i.element.querySelector("#"+i.element.id+"_duplicate"),s=i.element.querySelector("#"+i.element.id+"_remove"),l=i.element.querySelector("#"+i.element.id+"_editText"),p=o.strokeSettings.outlineColor,h=o.strokeSettings.outlineWidth,d=[],n=(n&&n.classList.add("e-overlay"),a&&a.classList.add("e-overlay"),s&&s.classList.add("e-overlay"),l&&l.classList.add("e-overlay"),""!==o.strokeSettings.fillColor?i.textArea.style.backgroundColor=o.strokeSettings.fillColor:i.textArea.style.backgroundColor="transparent",i.textArea.style.display="block",i.textArea.style.left=e+"px",i.textArea.style.top=t+"px",i.textArea.style.fontFamily=o.textSettings.fontFamily,i.textArea.style.fontSize=o.textSettings.fontSize+"px",i.textArea.style.color=o.strokeSettings.strokeColor,o.textSettings.fontSize),c=Math.max(1,h/2)*(.5*Math.floor((n-1)/16)+.5);if(/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$|^[a-zA-Z]+$/.test(o.strokeSettings.outlineColor)){for(var u=-c;u<=c;u++)for(var g=-c;g<=c;g++)0===u&&0===g||d.push(u/2+"px "+g/2+"px 0 "+p);i.textArea.style.textShadow=d.join(", ")}else i.textArea.style.textShadow=null;i.textArea.style.fontWeight=o.textSettings.bold?"bold":"normal",i.textArea.style.fontStyle=o.textSettings.italic?"italic":"normal",i.textArea.style.border="2px solid "+i.themeColl[i.theme].primaryColor,i.textArea.value=o.keyHistory,i.textArea.style.overflow="hidden",i.textArea.style.width="auto",i.textArea.style.height="auto",i.textArea.focus();a=o.activePoint,s=a.width,l=a.height,r%90==0&&r%180!=0&&0!==r?(i.textArea.style.width=l+.25*l+"px",i.textArea.style.height=s+.25*s+"px"):(i.textArea.style.width=s+.25*s+"px",i.textArea.style.height=l+.25*l+"px"),this.setTextBoxWidth(),e={flipColl:null};if(i.notify("transform",{prop:"getFlipColl",onPropertyChange:!1,value:{obj:e}}),e.flipColl.length<=1&&this.setTextBoxHeight(),parseFloat(i.textArea.style.maxHeight)<i.activeObj.textSettings.fontSize&&(i.textArea.style.maxHeight=i.activeObj.textSettings.fontSize+"px"),r%90==0&&r%180!=0?parseFloat(i.textArea.style.left)+parseFloat(i.textArea.style.width)>i.img.destTop+i.img.destHeight&&this.alignTextAreaIntoCanvas():parseFloat(i.textArea.style.left)+parseFloat(i.textArea.style.width)>i.img.destLeft+i.img.destWidth&&this.alignTextAreaIntoCanvas(),0!==o.rotatedAngle){var v=parseFloat(i.textArea.style.left),t=parseFloat(i.textArea.style.top),f=(0<o.flipObjColl.length&&(n=(h=i.lowerCanvas).clientWidth,a=h.clientHeight,i.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!(s={x:0,y:0}),value:{panObj:l={panRegion:""}}}),""!==l.panRegion)&&("horizontal"===l.panRegion?(s.x=n-n/2,v=s.x-v+s.x):t=("vertical"===l.panRegion?s.y=a-a/2:v=(s={x:n-n/2,y:a-a/2}).x-v+s.x,s.y-t+s.y)),v+parseFloat(i.textArea.style.width)),C=t+parseFloat(i.textArea.style.height),b=parseFloat(i.textArea.style.width),m=parseFloat(i.textArea.style.height),y={x:f-b/2,y:C-m/2},P=Math.cos(o.rotatedAngle),j=Math.sin(o.rotatedAngle),x={x:P*(f-y.x)-j*(C-y.y)+y.x,y:j*(f-y.x)+P*(C-y.y)+y.y};if(x.x>i.img.destLeft&&x.x<i.img.destLeft+i.img.destWidth&&x.y>i.img.destTop&&x.y+parseFloat(i.textArea.style.fontSize)<i.img.destTop+i.img.destHeight)i.textArea.style.width=i.textArea.style.width;else for(var w=0,O=parseFloat(i.textArea.style.width);;)if(w++,(x={x:P*((f=v+--b)-(y={x:f-b/2,y:C-m/2}).x)-j*(C-y.y)+y.x,y:j*(f-y.x)+P*(C-y.y)+y.y}).x>i.img.destLeft&&x.x<i.img.destLeft+i.img.destWidth&&x.y>i.img.destTop&&x.y+parseFloat(i.textArea.style.fontSize)<i.img.destTop+i.img.destHeight||w===O){i.textArea.style.width=b+"px";break}}i.notify("selection",{prop:"clearUpperCanvas",onPropertyChange:!1})},h.prototype.setTextBoxWidth=function(e){var t,o,i,r,n,a=this.parent;0!==a.activeObj.rotatedAngle?(a.textArea.style.whiteSpace="nowrap",a.textArea.style.textOverflow="ellipsis",a.textArea.style.display="inline-block"):(a.textArea.style.whiteSpace="",a.textArea.style.textOverflow="","inline-block"===a.textArea.style.display&&(a.textArea.style.display="block"),t=this.getMaxText(!0),"block"===a.textArea.style.display||"inline-block"===a.textArea.style.display?this.updateFontStyles(!0):this.updateFontStyles(),t=this.upperContext.measureText(t).width+parseFloat(a.textArea.style.fontSize)/2,o=e?this.upperContext.measureText(String.fromCharCode(e.which)).width:0,r=T.extend({},a.activeObj,{},!0),n="",i=this.getRotDegOfShape(r),n=r.shapeFlip!==a.transform.currFlipState?"":a.transform.currFlipState,(e&&parseFloat(a.textArea.style.width)<t+o||T.isNullOrUndefined(e))&&(0===i?"horizontal"===n.toLowerCase()?0<parseFloat(a.textArea.style.left)-a.img.destLeft-t-o&&(a.textArea.style.width=t+o+"px"):a.img.destWidth-(parseFloat(a.textArea.style.left)-a.img.destLeft)>t+o&&(a.textArea.style.width=t+o+"px"):90===i?"vertical"===n.toLowerCase()?0<parseFloat(a.textArea.style.top)-a.img.destTop-t-o&&(a.textArea.style.width=t+o+"px"):a.img.destHeight-(parseFloat(a.textArea.style.top)-a.img.destTop)>t+o&&(a.textArea.style.width=t+o+"px"):180===i?(r=parseFloat(a.textArea.style.left),e=a.img.destLeft,"horizontal"===n.toLowerCase()?t+o<a.img.destWidth-(r-e)&&(a.textArea.style.width=t+o+"px"):0<r-e-t-o&&(a.textArea.style.width=t+o+"px")):270===i&&(r=parseFloat(a.textArea.style.top),e=a.img.destTop,"vertical"===n.toLowerCase()?t+o<a.img.destHeight-(r-e)&&(a.textArea.style.width=t+o+"px"):0<r-e-t-o&&(a.textArea.style.width=t+o+"px"))))},h.prototype.setTextBoxHeight=function(){var e,t=this.parent,o=T.extend({},t.activeObj,{},!0),i="",r=this.getRotDegOfShape(o),i=o.textFlip===t.transform.currFlipState?"":""===o.textFlip?t.transform.currFlipState:o.textFlip;switch(r){case 0:"vertical"===i.toLowerCase()?t.textArea.style.maxHeight=t.img.destHeight-(t.img.destHeight-parseFloat(t.textArea.style.top))+"px":(e=parseFloat(t.textArea.style.top)-t.img.destTop,t.textArea.style.maxHeight=t.img.destHeight-e+"px");break;case 90:"horizontal"===i.toLowerCase()?t.textArea.style.maxHeight=t.img.destWidth-(parseFloat(t.textArea.style.left)-t.img.destLeft)+"px":t.textArea.style.maxHeight=parseFloat(t.textArea.style.left)-t.img.destLeft+"px";break;case 180:"vertical"===i.toLowerCase()?(e=parseFloat(t.textArea.style.top)-t.img.destTop,t.textArea.style.maxHeight=t.img.destHeight-e+"px"):t.textArea.style.maxHeight=parseFloat(t.textArea.style.top)-t.img.destTop+"px";break;case 270:"horizontal"===i.toLowerCase()?t.textArea.style.maxHeight=parseFloat(t.textArea.style.left)-t.img.destLeft+"px":t.textArea.style.maxHeight=t.img.destWidth-(parseFloat(t.textArea.style.left)-t.img.destLeft)+"px"}},h.prototype.updatePathRatio=function(e){for(var t=this.parent,o=0,i=e.pointColl.length;o<i;o++){var r=e.pointColl[o];r.ratioX=(r.x-t.img.destLeft)/t.img.destWidth,r.ratioY=(r.y-t.img.destTop)/t.img.destHeight}},h.prototype.stopPathDrawing=function(e,t){var o,i,r,n=this.parent;"path"===n.activeObj.shape&&(n.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:r={shape:null}}}),"path"===r.shape)&&(r=T.extend({},n.cropObj,{},!0),n.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(i={currObj:{}}),value:{object:i}}),(i=i.currObj).objColl=T.extend([],n.objColl,[],!0),i.pointColl=T.extend([],n.pointColl,[],!0),i.afterCropActions=T.extend([],n.afterCropActions,[],!0),n.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(o={selPointColl:null}),value:{obj:o}}),i.selPointColl=T.extend([],o.selPointColl,[],!0),n.notify("selection",{prop:"setCurrentDrawingShape",value:{value:""}}),n.currObjType.isDragging=!1,e&&"touchstart"!==e.type&&T.isNullOrUndefined(t)&&n.activeObj.pointColl.pop(),this.updatePathRatio(n.activeObj),T.isNullOrUndefined(n.activeObj.imageRatio)&&n.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),n.objColl.push(n.activeObj),n.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),n.objColl.pop(),e&&(n.notify("selection",{prop:"mouseUpEventHandler",value:{e:e}}),this.lowerContext.clearRect(0,0,n.lowerCanvas.width,n.lowerCanvas.height),n.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),0<n.objColl.length)&&(o=n.activeObj.activePoint,t=n.objColl[n.objColl.length-1].activePoint,Math.floor(o.startX)===Math.floor(t.startX))&&Math.floor(o.startY)===Math.floor(t.startY)&&Math.floor(o.endX)===Math.floor(t.endX)&&Math.floor(o.endY)===Math.floor(t.endY)&&this.refreshActiveObj(),n.notify("draw",{prop:"setNewPath",value:{bool:!0}}),n.objColl[n.objColl.length-1]&&(i=n.drawingShape,n.notify("selection",{prop:"setCurrentDrawingShape",value:{value:""}}),n.noRedact=!0,n.selectShape(n.objColl[n.objColl.length-1].currIndex),n.notify("selection",{prop:"setCurrentDrawingShape",value:{value:"path"}}),n.drawingShape=i),n.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}),n.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!(r={shapeSettingsObj:{}}),value:{obj:r}}),n.notify("selection",{prop:"triggerShapeChange",onPropertyChange:!1,value:{shapeResizingArgs:{cancel:!1,action:"draw-end",previousShapeSettings:e=r.shapeSettingsObj},shapeMovingArgs:{cancel:!1,action:"move",previousShapeSettings:e},type:"mouse-up"}}),n.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1}))},h.prototype.findTextTarget=function(e){var t=this.parent;if(e){if("text"!==t.activeObj.shape){if("path"===t.activeObj.shape)return void this.stopPathDrawing(e,null);if("dblclick"!==e.type)return;t.notify("selection",{prop:"setPanDown",onPropertyChange:!1,value:{panDown:null}});var o=T.extend({},t.activeObj,{},!0),i=T.extend([],t.objColl,[],!0),r={bool:null};if(t.notify("selection",{prop:"findTargetObj",onPropertyChange:!1,value:{x:e.clientX,y:e.clientY,isCrop:!1,obj:r}}),t.objColl=i,!r.bool||"text"!==t.activeObj.shape)return void(t.activeObj=T.extend({},o,{},!0))}if("dblclick"===e.type?(s=e.clientX,l=e.clientY):"touchstart"===e.type&&(s=e.touches[0].clientX,l=e.touches[0].clientY,t.notify("selection",{prop:"setTouchEndPoint",onPropertyChange:!1,value:{x:e.touches[0].clientX,y:e.touches[0].clientY}})),t.notify("toolbar",{prop:"setPreventZoomBtn",onPropertyChange:!1,value:{isPrevent:!0}}),t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),t.notify("toolbar",{prop:"setPreventZoomBtn",onPropertyChange:!1,value:{isPrevent:!1}}),t.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),T.isNullOrUndefined(s)||T.isNullOrUndefined(l))"block"!==t.textArea.style.display&&"inline-block"!==t.textArea.style.display||""===this.selectedText()||"mousedown"!==e.type?"none"===t.textArea.style.display&&(t.textArea.style.display="block"):(n=t.textArea.value,t.textArea.value+="a",t.textArea.value=n);else{var i=t.lowerCanvas.getBoundingClientRect(),o=(s-=i.left,l-=i.top,""),e=this.getRotDegOfShape(t.activeObj),o=""===t.activeObj.textFlip?t.activeObj.textFlip===t.transform.currFlipState?"":t.transform.currFlipState:t.activeObj.textFlip===t.transform.currFlipState?"":""===t.transform.currFlipState?t.activeObj.textFlip:t.transform.currFlipState,n=void 0;if("none"===t.textArea.style.display){n=T.extend({},t.activeObj,{},!0);for(var a=0;a<t.objColl.length;a++)JSON.stringify(t.activeObj)===JSON.stringify(t.objColl[a])&&t.objColl.splice(a,1);this.refreshActiveObj(),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),this.lowerContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),t.notify("draw",{prop:"redrawDownScale"}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),(t.currSelectionPoint&&"crop-circle"===t.currSelectionPoint.shape||t.isCircleCrop)&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),t.activeObj=n,this.updateFontStyles();var s,l,i=T.extend({},t.activeObj,{},!0),n=i.topLeftCircle.radius,p=i.activePoint,h=p.startX,d=p.startY,c=p.endX,u=p.endY,g=h+p.width/2,p=d+p.height/2,v=Math.cos(i.rotatedAngle),f=Math.sin(i.rotatedAngle),C={x:v*(h-g)-f*(d-p)+g,y:f*(h-g)+v*(d-p)+p},d={x:v*(c-g)-f*(d-p)+g,y:f*(c-g)+v*(d-p)+p},h={x:v*(h-g)-f*(u-p)+g,y:f*(h-g)+v*(u-p)+p},f={x:v*(c-g)-f*(u-p)+g,y:f*(c-g)+v*(u-p)+p},r={position:null,x:s,y:l,x1:C.x,y1:C.y,x2:d.x,y2:d.y,x3:h.x,y3:h.y,x4:f.x,y4:f.y};t.notify("draw",{prop:"checkPointPosition",onPropertyChange:!1,value:{obj:r}}),0!==i.rotatedAngle&&("inside"===r.position||"on"===r.position)||0===i.rotatedAngle&&s>=i.activePoint.startX-2*n&&s<=i.activePoint.endX+2*n&&l>=i.activePoint.startY-2*n&&l<=i.activePoint.endY+2*n?(this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),4===i.flipObjColl.length&&(i.flipObjColl=[],i.shapeFlip=o=""),""===o&&1<i.flipObjColl.length&&(o=i.flipObjColl[i.flipObjColl.length-1]),l=(s=(c=i.flipObjColl.length<=1?this.setTextBoxPos(i,e,o,s,l):this.setTextBoxPoints(i,e,o,s,l)).x,c.y),0!==t.activeObj.rotatedAngle&&(s=(g=this.getTextBoxPosition(t.activeObj)).x,l=g.y,s=(g=this.setFlipState(s,l,t.activeObj)).x,l=g.y),this.renderTextArea(s,l,i)):this.applyActObj()}}}},h.prototype.getTextBoxPosition=function(e,t){var o={x:0,y:0},i=e.activePoint,r=i.startX,n=i.startY,a=i.endX,s=i.endY,l=r+i.width/2,i=n+i.height/2,p=Math.cos(e.rotatedAngle),h=Math.sin(e.rotatedAngle),d={x:p*(r-l)-h*(n-i)+l,y:h*(r-l)+p*(n-i)+i},n={x:p*(a-l)-h*(n-i)+l,y:h*(a-l)+p*(n-i)+i},r={x:p*(r-l)-h*(s-i)+l,y:h*(r-l)+p*(s-i)+i},h={x:p*(a-l)-h*(s-i)+l,y:h*(a-l)+p*(s-i)+i},a=this.getRotDegOfShape(e);return 0===a||360===a?o={x:d.x,y:d.y}:90===a||-270===a?o={x:n.x,y:n.y}:180===a||-180===a?o={x:h.x,y:h.y}:270!==a&&-90!==a||(o={x:r.x,y:r.y}),t&&(t.x=o.x,t.y=o.y),o},h.prototype.setFlipState=function(e,t,o,i){var r=this.parent,n={panRegion:""},a=r.lowerCanvas,s=a.clientWidth,a=a.clientHeight,l={x:0,y:0};return r.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:n}}),""!==n.panRegion&&("horizontal"===n.panRegion?(l.x=s-s/2,e=l.x-e+l.x):t=("vertical"===n.panRegion?l.y=a-a/2:e=(l={x:s-s/2,y:a-a/2}).x-e+l.x,l.y-t+l.y)),i&&(i.x=e,i.y=t),{x:e,y:t}},h.prototype.fileChanged=function(e){var t=e.target.files[0],t=t.name&&t.name.split(".").pop().toLowerCase();t&&-1===["jpg","jpeg","png","svg","webp"].indexOf(t)?this.refreshActiveObj():(t=window.URL.createObjectURL(e.target.files[0]),this.onLoadImgShape(null,null,null,null,t.toString(),!0),document.getElementById(this.parent.element.id+"_fileUpload").value="")},h.prototype.onLoadImgShape=function(e,t,o,i,r,n,a,s,l,p){var h=this,d=this.parent;"string"==typeof r?this.shapeImg.src=r:(d.inMemoryCanvas.width=r.width,d.inMemoryCanvas.height=r.height,d.inMemoryCanvas.getContext("2d").putImageData(r,0,0),this.shapeImg.src=d.inMemoryCanvas.toDataURL()),this.prevObjColl(),d.activeObj.shape="image",this.initShapeProps(),this.shapeImg.onload=function(){h.upperContext.drawImage(h.shapeImg,0,0,h.shapeImg.width,h.shapeImg.height),h.updateImgCanvas(n,e,t,o,i,a,s,l,p)}},h.prototype.updateImgCanvas=function(e,t,o,i,r,n,a,s,l){var p=this.parent,h=(p.activeObj.imageElement=this.shapeImg,p.activeObj.imageCanvas=p.createElement("canvas"),{width:0,height:0}),a=(p.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:this.shapeImg.width,height:this.shapeImg.height,obj:h,isImgShape:null}}),i&&r&&(h=a?(p.notify("selection",{prop:"findImageRatio",onPropertyChange:!(d={ratio:null}),value:{width:this.shapeImg.width,height:this.shapeImg.height,obj:d}}),this.resizeImage(i,d.ratio)):{width:i,height:r}),this.updateObj(h,t,o),p.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:p.activeObj.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:null,isVFlip:null}}),p.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:this.shapeImg.width,height:this.shapeImg.height,obj:h,isImgShape:!0}}),i&&r&&(h=a?(p.notify("selection",{prop:"findImageRatio",onPropertyChange:!(d={ratio:null}),value:{width:this.shapeImg.width,height:this.shapeImg.height,obj:d}}),this.resizeImage(i,d.ratio)):{width:i,height:r}),null!=s&&(p.activeObj.opacity=s),this.updateObj(h,t,o),p.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.shapeImg=null,n&&(p.activeObj.rotatedAngle=n*(Math.PI/180),p.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:p.activeObj}})),{shapeSettingsObj:{}}),d=(p.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:a}}),a.shapeSettingsObj),i={cancel:!1,action:"insert",previousShapeSettings:d,currentShapeSettings:d};p.trigger("shapeChanging",i),p.editCompleteArgs=i,this.drawShapeImageEvent(i,e=e||l),p.isPublicMethod&&!l?p.notify("undo-redo",{prop:"updateUndoRedo",onPropertyChange:!1}):p.isPublicMethod||p.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1}),p.isPublicMethod=!1},h.prototype.updateObj=function(e,t,o){var i=this.parent;i.activeObj.activePoint.width=e.width,i.activeObj.activePoint.height=e.height,i.activeObj.activePoint.startX=t||i.lowerCanvas.width/2-e.width/2,i.activeObj.activePoint.startY=o||i.lowerCanvas.height/2-e.height/2,i.activeObj.activePoint.endX=i.activeObj.activePoint.startX+e.width,i.activeObj.activePoint.endY=i.activeObj.activePoint.startY+e.height},h.prototype.resizeImage=function(e,t){var t=t.split(":"),o=parseInt(t[0],10),t=parseInt(t[1],10);return{width:e,height:Math.round(e*t/o)}},h.prototype.setTextBoxPos=function(e,t,o,i,r){var n={x:i,y:r},i=e.activePoint,a=i.startX,s=i.startY,l=i.endX,p=i.endY;switch(o=o.toLowerCase(),t){case 0:"horizontal"===o?(n.x=l,n.y=s):"vertical"===o?(n.x=a,n.y=p):(n.x=a,n.y=s);break;case 90:"horizontal"===o?(n.x=a,n.y=s):"vertical"===o?(n.x=l,n.y=p):(n.x=l,n.y=s);break;case 180:"horizontal"===o?(n.x=a,n.y=p):"vertical"===o?(n.x=l,n.y=s):(n.x=l,n.y=p);break;case 270:"horizontal"===o?(n.x=l,n.y=p):"vertical"===o?(n.x=a,n.y=s):(n.x=a,n.y=p)}return n},h.prototype.setTextBoxPoints=function(e,t,o,i,r){var n={x:i,y:r},i=e.activePoint,a=i.startX,s=i.startY,l=i.endX,p=i.endY;switch(o=o.toLowerCase(),t){case 0:e.flipObjColl[0]&&"horizontal"===e.flipObjColl[0].toLowerCase()?"horizontal"===o?(n.x=a,n.y=s):"vertical"===o&&(n.x=l,n.y=p):"horizontal"===o?(n.x=l,n.y=p):"vertical"===o&&(n.x=l,n.y=s);break;case 90:e.flipObjColl[0]&&"horizontal"===e.flipObjColl[0].toLowerCase()?"horizontal"===o?(n.x=l,n.y=p):"vertical"===o&&(n.x=a,n.y=p):"horizontal"===o?(n.x=a,n.y=p):"vertical"===o&&(n.x=a,n.y=s);break;case 180:e.flipObjColl[0]&&"horizontal"===e.flipObjColl[0].toLowerCase()?"horizontal"!==o&&"vertical"!==o||(n.x=a,n.y=s):"horizontal"===o?(n.x=a,n.y=s):"vertical"===o&&(n.x=a,n.y=p);break;case 270:e.flipObjColl[0]&&"horizontal"===e.flipObjColl[0].toLowerCase()?"horizontal"===o?(n.x=a,n.y=s):"vertical"===o&&(n.x=l,n.y=s):"horizontal"===o?(n.x=l,n.y=s):"vertical"===o&&(n.x=l,n.y=p)}return n},h.prototype.selectedText=function(){var e=this.parent,t=e.textArea.selectionStart,o=e.textArea.selectionEnd;return e.textArea.value.substring(t,o)},h.prototype.panObjColl=function(e,t,o){var i=this.parent;if(0<i.objColl.length){for(var r=0,n=i.objColl.length;r<n;r++){var a=i.objColl[r];if(""===o){if(a.activePoint.startX+=e,a.activePoint.endX+=e,a.rotationCirclePointColl&&(a.rotationCirclePointColl.x+=e),"path"===a.shape)for(var s=0,l=a.pointColl.length;s<l;s++)a.pointColl[s].x+=e;if(a.activePoint.startY+=t,a.activePoint.endY+=t,a.rotationCirclePointColl&&(a.rotationCirclePointColl.y+=t),"path"===a.shape)for(s=0;s<a.pointColl.length;s++)a.pointColl[s].y+=t}if(a=this.updateWidthHeight(a),i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:a.activePoint,obj:a}}),"line"===a.shape||"arrow"===a.shape){a.pointColl=this.getLinePoints(a.activePoint.startX,a.activePoint.startY,a.activePoint.endX,a.activePoint.endY);for(var p=0,h=a.pointColl.length;p<h;p++)a.pointColl[p].ratioX=(a.pointColl[p].x-i.img.destLeft)/i.img.destWidth,a.pointColl[p].ratioY=(a.pointColl[p].y-i.img.destTop)/i.img.destHeight}this.refreshActiveObj()}var d=this.lowerContext.filter;this.lowerContext.filter="none",this.iterateObjColl(),this.lowerContext.filter=d,this.refreshActiveObj(),i.notify("draw",{prop:"applyFrame",value:{ctx:this.lowerContext,frame:i.frameObj.type,preventImg:!0}})}},h.prototype.updateFontStyles=function(e){var t=this.parent,o=(this.upperContext.strokeStyle=t.activeObj.strokeSettings.strokeColor,this.upperContext.fillStyle=t.activeObj.strokeSettings.strokeColor,""),e=(t.activeObj.textSettings.bold&&(o="bold "),t.activeObj.textSettings.italic&&(o="italic "),t.activeObj.textSettings.bold&&t.activeObj.textSettings.italic&&(o="italic bold "),e?parseFloat(t.textArea.style.fontSize):t.activeObj.textSettings.fontSize),t=("block"===t.textArea.style.display||"inline-block"===t.textArea.style.display?t.textArea.style:t.activeObj.textSettings).fontFamily;this.upperContext.font=o+e+"px "+t},h.prototype.applyFontStyle=function(e){var t=this.parent,o={shapeSettingsObj:{}},o=(t.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:o}}),o.shapeSettingsObj),i=(this.pushActItemIntoObj(),T.extend([],t.objColl,[],!0));switch(t.objColl.pop(),"none"===t.textArea.style.display?this.updateFontRatio(t.activeObj):this.updateFontRatio(t.activeObj,!0),e){case"default":this.updateFontStyle(e,i,"normal","normal");break;case"bold":this.updateFontStyle(e,i,"bold","normal");break;case"italic":this.updateFontStyle(e,i,"normal","italic");break;case"bolditalic":this.updateFontStyle(e,i,"bold","italic")}o={action:"font-style",currentShapeSettings:T.extend({},o,{},!0)};o.currentShapeSettings.fontStyle=[e],t.trigger("shapeChange",o),t.editCompleteArgs=o},h.prototype.updateFontStyle=function(e,t,o,i){var r,n=this.parent,a=n.textArea.style;"block"===a.display||"inline-block"===a.display?("normal"===a.fontWeight&&"bold"===o?a.fontWeight="bold":"bold"===a.fontWeight&&"bold"===o&&(a.fontWeight="normal"),"normal"===a.fontStyle&&"italic"===i?a.fontStyle="italic":"italic"===a.fontStyle&&"italic"===i&&(a.fontStyle="normal"),r="normal"===a.fontWeight&&"normal"===a.fontStyle?"default":"bold"===a.fontWeight&&"normal"===a.fontStyle?"bold":"normal"===a.fontWeight&&"italic"===a.fontStyle?"italic":"bolditalic",r=this.getTextAreaWidth(r),a.width=r+"px",this.updateObjColl(e,t)):(this.textSettings.bold=n.activeObj.textSettings.bold="normal"!==o,this.textSettings.italic=n.activeObj.textSettings.italic="normal"!==i,0===n.activeObj.activePoint.width&&0===n.activeObj.activePoint.height||this.redrawText(),n.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:t}}))},h.prototype.updateArrowRatio=function(e){for(var t,o={arrowDimension:null},i=(this.parent.notify("draw",{prop:"getArrowDimension",onPropertyChange:!1,value:{obj:o}}),t=Math.abs(e.activePoint.width)>Math.abs(e.activePoint.height)?Math.abs(e.activePoint.width):Math.abs(e.activePoint.height),0),r=["bar","arrow","arrowSolid","circle","square"];i<r.length;i++){var n,a=t/o.arrowDimension[n=r[i]].width,s=t/o.arrowDimension[n].height;o.arrowDimension[n].ratioX=a,o.arrowDimension[n].ratioY=s}},h.prototype.updateArrowSize=function(e){for(var t,o={arrowDimension:null},i=(this.parent.notify("draw",{prop:"getArrowDimension",onPropertyChange:!1,value:{obj:o}}),t=Math.abs(e.activePoint.width)>Math.abs(e.activePoint.height)?Math.abs(e.activePoint.width):Math.abs(e.activePoint.height),0),r=["bar","arrow","arrowSolid","circle","square"];i<r.length;i++){var n,a=o.arrowDimension[n=r[i]].ratioX,s=o.arrowDimension[n].ratioY;o.arrowDimension[n].width=t/a,o.arrowDimension[n].height=t/s}},h.prototype.updateFontRatio=function(e,t){var o=this.parent,i=this.getMaxText(t),i=this.upperContext.measureText(i).width+.5*o.activeObj.textSettings.fontSize,r=o.activeObj.textSettings.fontSize,n=this.getRotDegOfShape(e);T.isNullOrUndefined(t)?0===n||180===Math.abs(n)?e.textSettings.fontRatio=i/e.textSettings.fontSize:e.textSettings.fontRatio=r/e.textSettings.fontSize:t&&(o.notify("selection",{prop:"getTransformedShape",onPropertyChange:!(t={bool:!1}),value:{obj:t}}),t.bool&&0!==n&&180!==Math.abs(n)?e.textSettings.fontRatio=r/parseFloat(o.textArea.style.fontSize):e.textSettings.fontRatio=i/parseFloat(o.textArea.style.fontSize))},h.prototype.updateFontSize=function(e){var t=this.getRotDegOfShape(e,!0);0===t||180===Math.abs(t)?e.textSettings.fontSize=e.activePoint.width/e.textSettings.fontRatio:e.textSettings.fontSize=e.activePoint.height/e.textSettings.fontRatio},h.prototype.updateObjColl=function(e,t){var o=this.parent,i=T.extend({},o.cropObj,{},!0),r={currObj:{}},r=(o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}}),r.currObj),t=(r.objColl=t,r.pointColl=T.extend([],o.pointColl,[],!0),r.afterCropActions=T.extend([],o.afterCropActions,[],!0),{selPointColl:null}),t=(o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:t}}),r.selPointColl=T.extend([],t.selPointColl,[],!0),o.activeObj.textSettings.bold),n=o.activeObj.textSettings.italic;switch(e){case"default":o.activeObj.textSettings.bold=!1,o.activeObj.textSettings.italic=!1;break;case"bold":o.activeObj.textSettings.bold=!0,o.activeObj.textSettings.italic=!1;break;case"italic":o.activeObj.textSettings.bold=!1,o.activeObj.textSettings.italic=!0;break;case"bolditalic":o.activeObj.textSettings.bold=!0,o.activeObj.textSettings.italic=!0}o.objColl.push(o.activeObj),o.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),o.objColl.pop(),o.activeObj.textSettings.bold=t,o.activeObj.textSettings.italic=n},h.prototype.pushActItemIntoObj=function(){var e,t=this.parent;"none"===t.textArea.style.display?0===t.activeObj.activePoint.width&&0===t.activeObj.activePoint.height||t.objColl.push(t.activeObj):(e=T.extend({},t.activeObj,{},!0),t.notify("selection",{prop:"setTextBoxStylesToActObj",onPropertyChange:!1}),t.objColl.push(t.activeObj),t.activeObj=e)},h.prototype.clearActObj=function(){var e=this.parent;"none"===e.textArea.style.display&&(this.refreshActiveObj(),this.applyActObj(),this.refreshActiveObj(),e.currObjType.isCustomCrop=!1)},h.prototype.refreshActiveObj=function(){var e=this.parent;e.activeObj={},e.activeObj.activePoint={startX:0,startY:0,endX:0,endY:0,width:0,height:0},e.activeObj.triangle=[],e.activeObj.triangleRatio=[],e.activeObj.order=null,e.activeObj.flipObjColl=[],e.activeObj.strokeSettings=this.strokeSettings,e.activeObj.textSettings=this.textSettings,e.activeObj.rotatedAngle=0,e.activeObj.opacity=1,e.activeObj.redactType=this.redactType,e.activeObj.redactBlur=e.tempRedactBlur,e.activeObj.redactPixelate=e.tempRedactPixel},h.prototype.applyActObj=function(e){var t=this.parent,o=!1;if(void 0!==t.activeObj.shape&&"text"===t.activeObj.shape&&""===t.activeObj.keyHistory)this.refreshActiveObj(),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height);else{var i=void 0,r=!1;if((void 0===(i=void 0!==t.activeObj.shape?t.activeObj.shape.split("-"):i)&&t.currObjType.isCustomCrop||void 0!==i&&"crop"===i[0])&&(r=!0),t.activeObj.shape&&!r&&"shape"!==t.activeObj.shape){for(var n=0;n<t.objColl.length;n++)if(JSON.stringify(t.activeObj)===JSON.stringify(t.objColl[n])){o=!0;break}if(!o){T.isNullOrUndefined(t.activeObj.currIndex)&&(t.activeObj.currIndex=this.getNewShapeId()),T.isNullOrUndefined(t.activeObj.order)&&(t.activeObj.order=this.getNewOrder()),this.updImgRatioForActObj();var i=t.activeObj.currIndex.split("_"),a=t.objColl.splice(0,parseInt(i[1],10)-1);a.push(T.extend({},t.activeObj,{},!0));for(n=0;n<t.objColl.length;n++)a.push(t.objColl[n]);t.objColl=a,a=[],this.refreshActiveObj(),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),t.currObjType.shape="",this.refreshActiveObj(),t.isCircleCrop&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),t.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),T.isNullOrUndefined(e)&&(t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),t.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}}))}}}},h.prototype.getNewShapeId=function(){for(var e=this.parent,t=e.objColl.length+1,o=0;o<e.objColl.length;o++)e.objColl[o].currIndex==="shape_"+t&&(t++,o=-1);return"shape_"+t},h.prototype.getNewOrder=function(){for(var e=this.parent,t=(this.updateShapeColl(),e.shapeColl.length+1),o=0;o<e.shapeColl.length;o++)e.shapeColl[o].order===t&&(t++,o=-1);return t},h.prototype.getHighestOrder=function(){for(var e=this.parent,t=(this.updateShapeColl(),0),o=0;o<e.shapeColl.length;o++)e.shapeColl[o].order>t&&(t=e.shapeColl[o].order);return t},h.prototype.getLowestOrder=function(){for(var e=this.parent,t=(this.updateShapeColl(),1),o=0;o<e.shapeColl.length;o++)e.shapeColl[o].order<t&&(t=e.shapeColl[o].order);return t},h.prototype.alignTextAreaIntoCanvas=function(){var e=this.parent,t=e.textArea.value;e.textArea.value="";for(var o=0,i=t.length;o<i;o++)e.textArea.value+=t[o],e.textArea.style.height="auto",e.textArea.style.height=e.textArea.scrollHeight+"px",this.setTextBoxWidth()},h.prototype.transformTextArea=function(){var e=this.parent;if("text"===e.activeObj.shape){e.textArea.style.transformOrigin="0 0";var t=e.activeObj.rotatedAngle*(180/Math.PI),o="",i=this.getRotDegOfShape(e.activeObj);if(0<e.activeObj.flipObjColl.length)for(var r=0;r<e.activeObj.flipObjColl.length;r++)o+=0!==i&&i%90==0&&180!==i?"horizontal"===e.activeObj.flipObjColl[r].toLowerCase()?"scale(1, -1)":"scale(-1, 1)":"horizontal"===e.activeObj.flipObjColl[r].toLowerCase()?"scale(-1, 1)":"scale(1, -1)",i+=t,("horizontal"===e.activeObj.flipObjColl[r].toLowerCase()||"vertical"===e.activeObj.flipObjColl[r].toLowerCase())&&(e.textArea.style.transform="rotate("+i+"deg)"+o);else e.textArea.style.transform="rotate("+(i+=t)+"deg)"}},h.prototype.getTextAreaWidth=function(e){var t=this.parent,o=t.activeObj.textSettings.bold,i=t.activeObj.textSettings.italic;switch(e){case"default":t.activeObj.textSettings.bold=!1,t.activeObj.textSettings.italic=!1;break;case"bold":t.activeObj.textSettings.bold=!0,t.activeObj.textSettings.italic=!1;break;case"italic":t.activeObj.textSettings.bold=!1,t.activeObj.textSettings.italic=!0;break;case"bolditalic":t.activeObj.textSettings.bold=!0,t.activeObj.textSettings.italic=!0}var e="none"!==t.textArea.style.display;return this.updateFontStyles(e),e=e?this.upperContext.measureText(t.textArea.value).width+.5*t.activeObj.textSettings.fontSize:this.upperContext.measureText(t.activeObj.keyHistory).width+.5*t.activeObj.textSettings.fontSize,t.activeObj.textSettings.bold=o,t.activeObj.textSettings.italic=i,e},h.prototype.getRedactObjDetails=function(e){var t=this.parent,o={};switch(o.id=e.currIndex,o.type=t.toPascalCase(e.redactType),o.startX=e.activePoint.startX,o.startY=e.activePoint.startY,o.width=e.activePoint.width,o.height=e.activePoint.height,e.redactType){case"blur":o.blurIntensity=e.redactBlur;break;case"pixelate":o.pixelSize=e.redactPixelate}return o},h.prototype.getObjDetails=function(e){var t,o=this.parent,i={},r=(i.id=e.currIndex,i.type=o.toPascalCase(e.shape),i.startX=e.activePoint.startX,i.startY=e.activePoint.startY,i.index=e.order,{coll:null});switch(e.shape){case"rectangle":i.width=e.activePoint.width,i.height=e.activePoint.height,i.strokeColor=e.strokeSettings.strokeColor,i.fillColor=e.strokeSettings.fillColor,i.strokeWidth=e.strokeSettings.strokeWidth,i.degree=e.rotatedAngle*(180/Math.PI);break;case"ellipse":i.radius=e.activePoint.width/2,i.strokeColor=e.strokeSettings.strokeColor,i.fillColor=e.strokeSettings.fillColor,i.strokeWidth=e.strokeSettings.strokeWidth,i.radiusX=e.activePoint.width/2,i.radiusY=e.activePoint.height/2,i.degree=e.rotatedAngle*(180/Math.PI);break;case"line":case"arrow":i.length=e.activePoint.width,i.strokeColor=e.strokeSettings.strokeColor,i.strokeWidth=e.strokeSettings.strokeWidth,i.endX=e.activePoint.endX,i.endY=e.activePoint.endY,"arrow"===e.shape&&(o.notify("selection",{prop:"getArrowType",onPropertyChange:!(t={type:null}),value:{type:e.start,obj:t}}),i.arrowHead=t.type,o.notify("selection",{prop:"getArrowType",onPropertyChange:!1,value:{type:e.end,obj:t}}),i.arrowTail=t.type);break;case"text":i.text=e.keyHistory,i.fontSize=e.textSettings.fontSize,i.fontFamily=e.textSettings.fontFamily,i.color=e.strokeSettings.strokeColor,i.strokeColor=e.strokeSettings.outlineColor,i.fillColor=e.strokeSettings.fillColor,i.strokeWidth=e.strokeSettings.outlineWidth,i.fontStyle=[],e.textSettings.bold&&i.fontStyle.push("bold"),e.textSettings.italic&&i.fontStyle.push("italic"),i.degree=e.rotatedAngle*(180/Math.PI),o.notify("selection",{prop:"updateTransColl",onPropertyChange:!1,value:{obj:r,object:e}}),i.transformCollection=r.coll;break;case"path":i.strokeColor=e.strokeSettings.strokeColor,i.strokeWidth=e.strokeSettings.strokeWidth,i.points=e.pointColl;break;case"image":i.imageData=e.imageCanvas.toDataURL(),i.degree=e.rotatedAngle*(180/Math.PI),i.width=e.activePoint.width,i.height=e.activePoint.height,i.opacity=e.opacity}return i},h.prototype.getFreehandDrawDetails=function(e){var t=this.parent,o={};return o.id=t.pointColl[e].id,o.type=m.ShapeType.FreehandDraw,o.points=T.extend([],t.pointColl[e].points),o.strokeColor=t.pointColl[e].strokeColor,o.strokeWidth=t.pointColl[e].strokeWidth,o.index=t.pointColl[e].order,o},h.prototype.getShapeSetting=function(e,t){var o,i=this.parent;if(!i.disabled&&i.isImageLoaded)if("none"!==i.textArea.style.display?i.okBtn(null,!0):this.applyActObj(!0),"shape"===e.split("_")[0]){for(var r,n=0,a=i.objColl.length;n<a;n++)if(i.objColl[n].currIndex===e){r=T.extend({},i.objColl[n],{},!0);break}o=this.getObjDetails(r)}else"pen"===e.split("_")[0]&&(o=this.getFreehandDrawDetails(parseInt(e.split("_")[1],10)-1));t.shapeDetails=o},h.prototype.getShapeSettings=function(e){var t=this.parent,o=[];if(!t.disabled&&t.isImageLoaded){"none"!==t.textArea.style.display?t.okBtn(null,!0):this.applyActObj(!0);for(var i=0,r=t.objColl.length;i<r;i++){var n=this.getObjDetails(t.objColl[i]);o.push(n)}for(i=0;i<t.freehandCounter;i++){n=this.getFreehandDrawDetails(i);o.push(n)}}e.shapeDetailsColl=o},h.prototype.getRedactSettings=function(e){var t=this.parent,o=[];if(!t.disabled&&t.isImageLoaded){"none"!==t.textArea.style.display?t.okBtn(null,!0):this.applyActObj(!0);for(var i=0,r=t.objColl.length;i<r;i++){var n=this.getRedactObjDetails(t.objColl[i]);o.push(n)}}e.shapeDetailsColl=o},h.prototype.isPointsInRange=function(e,t,o){var i=!1,r=this.parent;!T.isNullOrUndefined(e)&&!T.isNullOrUndefined(t)&&e>=r.img.destLeft&&t>=r.img.destTop&&e<=r.img.destLeft+r.img.destWidth&&t<=r.img.destTop+r.img.destHeight&&(i=!0),o.inRange=i},h.prototype.alignRotateFlipColl=function(e,t,o){return e=this.popForDefaultTransformedState(e),e=this.popForDefaultFlipState(e),0===(e=this.popForDefaultRotateState(e)).length&&t&&(this.parent.transform.degree=0,this.parent.transform.currFlipState=""),o.collection=e},h.prototype.popForDefaultTransformedState=function(e){for(var t=0,o=0,i=0,r=0,n=0;n<e.length;n++)90===e[n]||"rotateRight"===e[n]?(r=i=o=0,4===++t&&(e.pop(),e.pop(),e.pop(),e.pop())):-90===e[n]||"rotateLeft"===e[n]?(r=i=t=0,4===++o&&(e.pop(),e.pop(),e.pop(),e.pop())):"horizontal"===e[n]||"Horizontal"===e[n]||"horizontalflip"===e[n]?(r=t=o=0,2===++i&&(e.pop(),e.pop())):"vertical"!==e[n]&&"Vertical"!==e[n]&&"verticalflip"!==e[n]||(t=o=i=0,2===++r&&(e.pop(),e.pop()));return e},h.prototype.popForDefaultFlipState=function(e){for(var t=0,o=e.length-3;t<o;t++){var i="horizontal"===e[t]||"Horizontal"===e[t]||"horizontalFlip"===e[t],r="vertical"===e[t]||"Vertical"===e[t]||"verticalFlip"===e[t],n="horizontal"===e[t+1]||"Horizontal"===e[t+1]||"horizontalFlip"===e[t+1],a="vertical"===e[t+1]||"Vertical"===e[t+1]||"verticalFlip"===e[t+1],s="horizontal"===e[t+2]||"Horizontal"===e[t+2]||"horizontalFlip"===e[t+2],l="vertical"===e[t+2]||"Vertical"===e[t+2]||"verticalFlip"===e[t+2],p="horizontal"===e[t+3]||"Horizontal"===e[t+3]||"horizontalFlip"===e[t+3];(i&&a&&s&&l||r&&n&&l&&p)&&(e.splice(t,4),t-=4)}return e},h.prototype.popForDefaultRotateState=function(e){for(var t=0;t<e.length-1;t++){var o=e[t],i=e[t+1];(90!==o&&"rotateRight"!==o||-90!==i&&"rotateLeft"!==i)&&(-90!==o&&"rotateLeft"!==o||90!==i&&"rotateRight"!==i)||(e.splice(t,2),t-=2)}return e},h.prototype.selectShape=function(e,t){var o=this.parent,i=!1;if(!o.disabled&&o.isImageLoaded)if(this.applyActObj(),"shape"===e.split("_")[0]){for(var r,n,a=0,s=o.objColl.length;a<s;a++)if(o.objColl[a].currIndex===e){r=T.extend({},o.objColl[a],{},!0);break}T.isNullOrUndefined(r)?i=!1:(i=!0,o.activeObj=r,o.notify("toolbar",{prop:"getCanvasFilter",onPropertyChange:!(n={canvasFilter:null}),value:{obj:n}}),this.lowerContext.filter=n.canvasFilter,o.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:o.activeObj}}),"text"===o.activeObj.shape?o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):"pen"===o.activeObj.shape?o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"pen",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):"redact"===o.activeObj.shape?o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"redact",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),o.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),o.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}))}else"pen"===e.split("_")[0]&&(o.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!(n={bool:!1}),value:{obj:n}}),n.bool&&o.okBtn(null,!0),n={isIndex:!1},o.notify("freehand-draw",{prop:"isFHDIdx",value:{index:parseInt(e.split("_")[1],10)-1,obj:n}}),n.isIndex?(i=!0,o.notify("freehand-draw",{prop:"selectFhd",value:{id:e}}),o.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:!0}}),o.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1})):i=!1);t.isSelected=i},h.prototype.deleteShape=function(e){var t=this.parent;if(!t.disabled&&t.isImageLoaded){if(t.activeObj.currIndex&&t.activeObj.currIndex===e)t.notify("selection",{prop:"deleteItem",onPropertyChange:!1});else if(this.applyActObj(),"shape"===e.split("_")[0]){for(var o=0,i=t.objColl.length;o<i;o++)if(t.objColl[o].currIndex===e){t.objColl.splice(o,1);break}}else"pen"===e.split("_")[0]&&t.notify("freehand-draw",{prop:"handle-freehand-draw",value:{id:e}});var r={canvasFilter:null};t.notify("toolbar",{prop:"getCanvasFilter",onPropertyChange:!1,value:{obj:r}}),this.lowerContext.filter=r.canvasFilter,this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),t.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})}},h.prototype.getMaxText=function(e,t,o){if(T.isNullOrUndefined(t)&&!(t=e?this.parent.textArea.value:this.parent.activeObj.keyHistory))return t;for(var i,r=t.split("\n"),n=r[0].length,a=r[0],s=1;s<r.length;s++)n<(i=r[s].length)&&(a=r[s],n=i);return o&&(o.maxText=a),a},h.prototype.getLinePoints=function(e,t,o,i){var r,n,a=[];if(e===o){t<i?(r=[e,t],n=[o,i]):(n=[e,t],r=[o,i]);for(var s=this.getSlope(r,n,!0),l=this.getIntercept(r,s),p=r[1];p<=n[1];p++){var h=s*p+l;a.push({x:h,y:p})}}else{e<o?(r=[e,t],n=[o,i]):(n=[e,t],r=[o,i]);for(s=this.getSlope(r,n,!1),l=this.getIntercept(r,s),h=r[0];h<=n[0];h++){p=s*h+l;a.push({x:h,y:p})}}if(Math.floor(e)===Math.floor(o)||a.length<10&&(10<i-t||10<t-i)){for(var a=[],d=Math.min(t,i),c=0;c<Math.abs(Math.floor(i)-Math.floor(t));c++)a.push({x:e,y:d+c});1<a.length&&(u=void 0,u=T.isNullOrUndefined(a[a.length-2])?{x:0,y:0}:a[a.length-2],g=a[a.length-1].x-u.x,v=a[a.length-1].y-u.y,a.push({x:a[a.length-1].x+g/2,y:a[a.length-1].y+v/2}))}else if(Math.floor(t)===Math.floor(i)||a.length<10&&(10<o-e||10<e-o)){a=[];for(var u,g,v,f=Math.min(e,o),C=0;C<Math.abs(Math.floor(o)-Math.floor(e));C++)a.push({x:f+C,y:t});1<a.length&&(u=void 0,u=T.isNullOrUndefined(a[a.length-2])?{x:0,y:0}:a[a.length-2],g=a[a.length-1].x-u.x,v=a[a.length-1].y-u.y,a.push({x:a[a.length-1].x+g/2,y:a[a.length-1].y+v/2}))}return a},h.prototype.getSlope=function(e,t,o){var i;if(o){if(e[1]===t[1])return null;i=(t[0]-e[0])/(t[1]-e[1])}else{if(e[0]===t[0])return null;i=(t[1]-e[1])/(t[0]-e[0])}return i},h.prototype.getIntercept=function(e,t){return null===t?e[0]:e[1]-t*e[0]},h.prototype.setPointCollForShapeRotation=function(e){var t=this.parent,o=e.activePoint,i=o.startX,r=o.startY,n=o.endX,a=o.endY,s=i+o.width/2,o=r+o.height/2,l=Math.cos(e.rotatedAngle),p=Math.sin(e.rotatedAngle),h={x:l*(i-s)-p*(r-o)+s,y:p*(i-s)+l*(r-o)+o},r={x:l*(n-s)-p*(r-o)+s,y:p*(n-s)+l*(r-o)+o},i={x:l*(i-s)-p*(a-o)+s,y:p*(i-s)+l*(a-o)+o},n={x:l*(n-s)-p*(a-o)+s,y:p*(n-s)+l*(a-o)+o};e.horTopLinePointColl=this.getLinePoints(h.x,h.y,r.x,r.y),e.horTopLinePointColl=this.getLinePoints(h.x,h.y,r.x,r.y),e.horBottomLinePointColl=this.getLinePoints(i.x,i.y,n.x,n.y),e.verLeftLinePointColl=this.getLinePoints(h.x,h.y,i.x,i.y),e.verRightLinePointColl=this.getLinePoints(r.x,r.y,n.x,n.y),e.verLeftLinePointColl.reverse(),e.verRightLinePointColl.reverse();for(var d=0;d<e.horTopLinePointColl.length;d++)e.horTopLinePointColl[d].ratioX=(e.horTopLinePointColl[d].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.horTopLinePointColl[d].ratioY=(e.horTopLinePointColl[d].y-this.parent.img.destTop)/this.parent.img.destHeight;for(d=0;d<e.horBottomLinePointColl.length;d++)e.horBottomLinePointColl[d].ratioX=(e.horBottomLinePointColl[d].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.horBottomLinePointColl[d].ratioY=(e.horBottomLinePointColl[d].y-this.parent.img.destTop)/this.parent.img.destHeight;for(d=0;d<e.verLeftLinePointColl.length;d++)e.verLeftLinePointColl[d].ratioX=(e.verLeftLinePointColl[d].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.verLeftLinePointColl[d].ratioY=(e.verLeftLinePointColl[d].y-this.parent.img.destTop)/this.parent.img.destHeight;for(d=0;d<e.verRightLinePointColl.length;d++)e.verRightLinePointColl[d].ratioX=(e.verRightLinePointColl[d].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.verRightLinePointColl[d].ratioY=(e.verRightLinePointColl[d].y-this.parent.img.destTop)/this.parent.img.destHeight;"move"!==t.upperCanvas.style.cursor&&(t.notify("selection",{prop:"getTransRotationPoint",value:{obj:e,object:a={rotationCirclePoint:null}}}),h=a.rotationCirclePoint)&&(e.rotationCirclePointColl={x:l*(h.x-s)-p*(h.y-o)+s,y:p*(h.x-s)+l*(h.y-o)+o},e.rotationCirclePointColl.ratioX=(e.rotationCirclePointColl.x-t.img.destLeft)/t.img.destWidth,e.rotationCirclePointColl.ratioY=(e.rotationCirclePointColl.y-t.img.destTop)/t.img.destHeight)},h.prototype.getSquarePointForRotatedShape=function(e,t){var o={startX:0,startY:0,endX:0,endY:0,width:0,height:0},i=e.activePoint,r=i.startX,n=i.startY,a=i.endX,s=i.endY,l=r+i.width/2,i=n+i.height/2,p=Math.cos(e.rotatedAngle),e=Math.sin(e.rotatedAngle),h={x:p*(r-l)-e*(n-i)+l,y:e*(r-l)+p*(n-i)+i},n={x:p*(a-l)-e*(n-i)+l,y:e*(a-l)+p*(n-i)+i},r={x:p*(r-l)-e*(s-i)+l,y:e*(r-l)+p*(s-i)+i},e={x:p*(a-l)-e*(s-i)+l,y:e*(a-l)+p*(s-i)+i};return o.startX=h.x,o.startY=h.y,o.endX=h.x,o.endY=h.y,n.x<o.startX&&(o.startX=n.x),r.x<o.startX&&(o.startX=r.x),e.x<o.startX&&(o.startX=e.x),n.y<o.startY&&(o.startY=n.y),r.y<o.startY&&(o.startY=r.y),e.y<o.startY&&(o.startY=e.y),o.endX<n.x&&(o.endX=n.x),o.endX<r.x&&(o.endX=r.x),o.endX<e.x&&(o.endX=e.x),o.endY<n.y&&(o.endY=n.y),o.endY<r.y&&(o.endY=r.y),o.endY<e.y&&(o.endY=e.y),o.width=o.endX-o.startX,o.height=o.endY-o.startY,t&&(t.activePoint=o),o},h.prototype.updateZOrder=function(e,t){var o=this.parent,i=(t=t.toLowerCase(),e);if(!T.isNullOrUndefined(i.order)){var r,n,a=this.getHighestOrder();if(this.updateShapeColl(),0!==o.shapeColl.length){for(var s,l=0;l<o.shapeColl.length;l++)s=o.shapeColl[l],i.id&&-1<i.id.indexOf("pen")?s.id&&s.id===i.id&&o.shapeColl.splice(l,1):s.shape&&-1<s.shape.indexOf("crop-")&&o.shapeColl.splice(l,1);switch(t){case"sendtoback":n=i.order,r=i.order,i.order=1;break;case"sendbackward":--i.order,r=i.order;break;case"bringtofront":n=i.order,i.order=r=a;break;case"bringforward":i.order+=1,r=i.order}this.reArrangeObjColl(r,t,n),i.id&&-1<i.id.indexOf("pen")&&this.reUpdateShapeColl(i)}}},h.prototype.reArrangeObjColl=function(e,t,o){var i,r=this.parent;switch(t){case"sendtoback":for(var n=0,a=r.shapeColl.length;n<a;n++)(i=r.shapeColl[n]).order<o&&i.order<=e&&(i.order+=1,this.reUpdateShapeColl(i));break;case"sendbackward":for(n=0,a=r.shapeColl.length;n<a;n++)if((i=r.shapeColl[n]).order===e){i.order+=1,this.reUpdateShapeColl(i);break}break;case"bringtofront":for(n=0,a=r.shapeColl.length;n<a;n++)(i=r.shapeColl[n]).order>o&&i.order<=e&&(--i.order,this.reUpdateShapeColl(i));break;case"bringforward":for(n=0,a=r.shapeColl.length;n<a;n++)if((i=r.shapeColl[n]).order===e){--i.order,this.reUpdateShapeColl(i);break}}},h.prototype.reorderRedact=function(e){var t=e.filter(function(e){return"redact"!==e.shape});return e.filter(function(e){return"redact"===e.shape}).concat(t)},h.prototype.updateShapeColl=function(){var e=this.parent,t=!1,o=1,i=T.extend([],e.objColl,[],!0),i=this.reorderRedact(i),r=T.extend([],e.pointColl,[],!0);if(0<e.shapeColl.length&&e.shapeColl.length===e.objColl.length+e.pointColl.length){for(var n=0;n<e.shapeColl.length;n++){if(e.shapeColl[n].order!==o){t=!1;break}t=!0,o++}if(t){for(n=0;n<e.shapeColl.length;n++)if(e.shapeColl[n].currIndex&&-1<e.shapeColl[n].currIndex.indexOf("shape")){for(var a=0;a<i.length;a++)if(e.shapeColl[n].currIndex===i[a].currIndex){e.shapeColl[n]=T.extend({},i[a],{},!0),i.splice(a,1);break}}else if(e.shapeColl[n].id&&-1<e.shapeColl[n].id.indexOf("pen"))for(a=0;a<r.length;a++)if(e.shapeColl[n].id===r[a].id){e.shapeColl[n]=T.extend([],r[a],[],!0),r.splice(a,1);break}return}}i=T.extend([],e.objColl,[],!0);for(var r=T.extend([],e.pointColl,[],!0),s=1,l=!(e.shapeColl=[]);0!==i.length||0!==r.length;){for(var p=l=!1,n=0;n<i.length;n++)if(i[n].order===s||!i[n].order&&i[n].shape&&-1<i[n].shape.indexOf("crop-")){e.shapeColl.push(T.extend({},i[n],{},!0)),i[n].shape&&-1<i[n].shape.indexOf("crop-")&&(l=!0),i.splice(n,1),p=!0;break}if(!p)for(n=0;n<r.length;n++)if(r[n].order===s){e.shapeColl.push(T.extend([],r[n],[],!0)),r.splice(n,1),p=!0;break}l||s++}},h.prototype.reUpdateShapeColl=function(e){var t=this.parent;if(e.id&&-1<e.id.indexOf("pen")){if(0<t.freehandCounter)for(var o=0;o<t.freehandCounter;o++)t.pointColl[o].id===e.id&&(t.pointColl[o].order=e.order)}else if(e.currIndex&&-1<e.currIndex.indexOf("shape"))for(o=0;o<t.objColl.length;o++)t.objColl[o].currIndex===e.currIndex&&(t.objColl[o].order=e.order)},h.prototype.drawAnnotations=function(e,t,o,i,r,n,a){var s=this.parent,l=T.extend({},s.activeObj,{},!0),p=T.extend([],s.objColl,[],!0),h=T.extend([],s.pointColl,[],!0),d={selPointColl:null},c=(s.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:d}}),{selPointColl:null}),u=(s.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:c}}),this.updateShapeColl(),T.extend([],s.shapeColl,[],!0)),u=this.reorderRedact(u),g=!1;this.preventFrameAnnotation||(this.preventFrameAnnotation=g=!0);for(var v=0;v<u.length;v++){var f=u[v].id;if(u[v].order||!u[v].order&&u[v].shape&&-1<u[v].shape.indexOf("crop-")||!u[v].order&&"path"===u[v].shape&&"path"===s.drawingShape){if(u[v].currIndex&&-1<u[v].currIndex.indexOf("shape")){if(s.objColl=[],s.objColl.push(T.extend({},u[v],{},!0)),"iterate"===t){var C=this.lowerContext.filter;this.lowerContext.filter="none",this.iterateObjColl(),this.lowerContext.filter=C}else if("zoom"===t||"pan"===t){for(var b=-1,m=0;m<p.length;m++)if(JSON.stringify(p[m])===JSON.stringify(s.objColl[0])){b=m;break}"zoom"===t?this.zoomObjColl(i):this.panObjColl(r,n,a),-1<b&&(p[b]=T.extend({},s.objColl[0],{},!0))}}else if(u[v].id&&-1<u[v].id.indexOf("pen"))if(s.pointColl=[],s.freehandCounter=0,s.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),s.pointColl.push(T.extend({},u[v],{},!0)),s.notify("freehand-draw",{prop:"pushSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:c.selPointColl[v]}}}),s.freehandCounter=s.pointColl.length,"iterate"===o)s.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:e,points:null}});else if("zoom"===o||"pan"===o){"zoom"===o?s.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:i}}):s.notify("freehand-draw",{prop:"panFHDColl",onPropertyChange:!1,value:{xDiff:r,yDiff:n,panRegion:a}});for(var y=0;y<h.length;y++)if(h[y].id===s.pointColl[0].id){h[y]=T.extend({},s.pointColl[0],{},!0);break}for(var P=0,j=d.selPointColl.length;P<j;P++)if(d.selPointColl[P].id===c.selPointColl[P].id){d.selPointColl[P]=T.extend({},c.selPointColl[P],{},!0);break}}}else(u[v].shape||f)&&(u[v].currIndex||f)||u.splice(v,1)}o&&"zoom"===o&&(s.pointColl=[],s.freehandCounter=0,s.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:i}})),s.objColl=p,s.pointColl=h,s.freehandCounter=s.pointColl.length,s.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:d.selPointColl}}}),g&&this.preventFrameAnnotation&&(s.notify("draw",{prop:"applyFrame",value:{ctx:this.lowerContext,frame:s.frameObj.type,preventImg:!0}}),this.preventFrameAnnotation=!1),s.activeObj=l};var M=h;function h(e){this.textSettings={text:"Enter Text",fontFamily:"",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.strokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,radius:null,outlineColor:"",outlineWidth:null},this.keyHistory="",this.preventFrameAnnotation=!1,this.redactType="blur",this.parent=e,this.addEventListener()}d.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},d.prototype.addEventListener=function(){this.parent.on("transform",this.transform,this),this.parent.on("destroyed",this.destroy,this)},d.prototype.removeEventListener=function(){this.parent.off("transform",this.transform),this.parent.off("destroyed",this.destroy)},d.prototype.transform=function(e){switch(this.initTransformPvtVar(),e.prop){case"flipImage":this.flipImage(e.value.direction);break;case"setDestPointsForFlipState":this.setDestPointsForFlipState();break;case"zoomAction":this.zoomAction(e.value.zoomFactor,e.value.zoomPoint,e.value.isResize);break;case"disableZoomOutBtn":this.disableZoomOutBtn(e.value.isZoomOut);break;case"rotatedFlip":this.rotatedFlip();break;case"drawPannedImage":this.drawPannedImage(e.value.xDiff,e.value.yDiff);break;case"drawPannImage":this.drawPannImage(e.value.point);break;case"performTransformation":this.performTransformation(e.value.text);break;case"updateTransform":this.updateTransform(e.value.text);break;case"rotatePan":this.rotatePan(e.value.isCropSelection,e.value.isDefaultZoom);break;case"resetZoom":this.resetZoom();break;case"pan":this.pan(e.value.value,e.value.x,e.value.y);break;case"zoom":this.zoom(e.value.zoomFactor,e.value.zoomPoint);break;case"setCurrPanRegion":this.setCurrPanRegion(e.value.region,e.value.type,e.value.obj);break;case"rotate":this.rotate(e.value.degree,e.value.obj);break;case"flip":this.flip(e.value.direction);break;case"update":this.update();break;case"calcMaxDimension":this.calcMaxDimension(e.value.width,e.value.height,e.value.obj,e.value.isImgShape);break;case"getPanMove":e.value.obj.panMove=this.panMove;break;case"setPanMove":this.panMove=e.value.point;break;case"getTempPanMove":e.value.obj.tempPanMove=this.tempPanMove;break;case"setTempPanMove":this.tempPanMove=e.value.point;break;case"setReverseFlip":this.isReverseFlip=e.value.isReverseFlip;break;case"setDisablePan":this.disablePan=e.value.bool;break;case"setCurrDestinationPoint":this.currDestPoint=e.value.point,this.currDestPoint.startX-=this.parent.cropObj.totalPannedPoint.x,this.currDestPoint.startY-=this.parent.cropObj.totalPannedPoint.y;break;case"setReverseRotate":this.isReverseRotate=e.value.bool;break;case"getFlipColl":e.value.obj.flipColl=this.flipColl;break;case"setFlipColl":this.flipColl=e.value.flipColl;break;case"getPreviousZoomValue":e.value.obj.previousZoomValue=this.prevZoomValue;break;case"setPreviousZoomValue":this.prevZoomValue=e.value.previousZoomValue;break;case"getCropDimension":e.value.obj.cropDimension=this.cropDimension;break;case"setCropDimension":this.cropDimension.width=e.value.width,this.cropDimension.height=e.value.height;break;case"getPreventSelect":e.value.obj.bool=this.isPreventSelect;break;case"setPreventSelect":this.isPreventSelect=e.value.bool;break;case"resizeImage":this.resizeImage(e.value.width,e.value.height);break;case"resizeCrop":this.resizeCrop(e.value.width,e.value.height);break;case"updateResize":this.updateResize();break;case"resize":this.resize(e.value.width,e.value.height,e.value.isAspectRatio);break;case"straightenImage":this.straightenImage(e.value.degree);break;case"reset":this.reset();break;case"cropZoom":e.value.obj.maxDimension=this.cropZoom(e.value.value,e.value.selectionObj);break;case"setResizedImgAngle":this.resizedImgAngle=e.value.angle}},d.prototype.getModuleName=function(){return"transform"},d.prototype.initTransformPvtVar=function(){this.parent.lowerCanvas&&(this.lowerContext=this.parent.lowerCanvas.getContext("2d")),this.parent.upperCanvas&&(this.upperContext=this.parent.upperCanvas.getContext("2d"))},d.prototype.reset=function(){this.zoomBtnHold=null,this.tempPanMove=null,this.panMove=null,this.disablePan=!1,this.currDestPoint=null,this.isReverseRotate=!1,this.flipColl=[],this.resizedImgAngle=null,this.transCurrObj=null,this.prevZoomValue=1,this.isPreventSelect=this.preventDownScale=!1},d.prototype.rotateImage=function(e){var t=this.parent,o={cancel:!1,previousDegree:t.transform.degree,currentDegree:360===Math.abs(t.transform.degree+e)?0:t.transform.degree+e};this.isPreventSelect||(t.trigger("rotating",o),t.editCompleteArgs=o),this.rotateEvent(o,e)},d.prototype.rotateEvent=function(e,t){var o,i=this.parent;e.cancel?(i.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:i.prevEventObjPoint}}),i.activeObj=i.prevEventSelectionPoint,i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:i.activeObj}})):(e=void 0,T.isNullOrUndefined(this.transCurrObj)&&(i.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(o={currObj:{}}),value:{object:o}}),(e=o.currObj).objColl=T.extend([],i.objColl,null,!0),e.pointColl=T.extend({},i.pointColl,null,!0),e.afterCropActions=T.extend([],i.afterCropActions,[],!0),i.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(o={selPointColl:null}),value:{obj:o}}),e.selPointColl=T.extend([],o.selPointColl,[],!0)),i.afterCropActions.push(90===t?"rotateRight":"rotateLeft"),e=[],o=void 0,i.activeObj.activePoint&&i.activeObj.shape&&(void 0!==i.activeObj.shape&&(e=i.activeObj.shape.split("-")),!i.currObjType.isCustomCrop&&"crop"!==e[0]||(o=i.currObjType.isCustomCrop?"custom":e[1],i.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),i.objColl.push(i.activeObj),i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}))),i.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),this.drawRotatedImage(t),i.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),i.isCircleCrop&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),o&&(this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.activeObj=T.extend({},i.objColl[i.objColl.length-1],{},!0),i.objColl.pop(),i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:i.activeObj}})),i.isUndoRedo=!1,e={collection:i.rotateFlipColl},i.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:i.rotateFlipColl,isRotateFlipCollection:!0,obj:e}}),i.rotateFlipColl=e.collection,i.cropObj.activeObj.shape&&!this.isPreventSelect&&(i.notify("draw",{prop:"setIsCropSelect",value:{bool:!0}}),this.isPreventSelect=!0,i.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),this.isPreventSelect=!1,i.setProperties({zoomSettings:{zoomFactor:1}},!0),this.prevZoomValue=i.zoomSettings.zoomFactor))},d.prototype.drawRotatedImage=function(e){var t=this.parent,o=(0===e?t.transform.degree=0:t.transform.degree+=e,360===Math.abs(t.transform.degree)&&(t.transform.degree=0),t.notify("draw",{prop:"setDestPoints",onPropertyChange:!1}),T.extend([],t.objColl,[],!0)),i=T.extend({},t.activeObj,{},!0);if(t.objColl=[],t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.isReverseRotate||t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),this.rotateDegree(e),this.isReverseRotate||(t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),t.rotateFlipColl.push(e)),t.objColl=T.extend([],o,[],!0),t.activeObj=T.extend({},i,{},!0),t.isCircleCrop&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),t.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:e}}),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),0<e)t.notify("freehand-draw",{prop:"rotateFhdColl",onPropertyChange:!1});else for(var r=0;r<3;r++)t.notify("freehand-draw",{prop:"rotateFhdColl",onPropertyChange:!1});t.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.updateCurrSelectionPoint(e)},d.prototype.rotateDegree=function(e){var t=this.parent,o=(this.lowerContext.save(),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.lowerContext.translate(t.lowerCanvas.width/2,t.lowerCanvas.height/2),this.lowerContext.rotate(Math.PI/180*e),this.lowerContext.translate(-t.lowerCanvas.width/2,-t.lowerCanvas.height/2),this.lowerContext.filter);t.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=o,this.lowerContext.translate(t.lowerCanvas.width/2,t.lowerCanvas.height/2),this.lowerContext.rotate(Math.PI/180*-e),this.lowerContext.translate(-t.lowerCanvas.width/2,-t.lowerCanvas.height/2),this.lowerContext.restore()},d.prototype.updateCurrSelectionPoint=function(e){var t,o,i,r,n=this.parent;n.currSelectionPoint&&this.currDestPoint&&(t=T.extend({},n.activeObj,{},!0),o=T.extend([],n.objColl,[],!0),i={startX:n.img.srcLeft,startY:n.img.srcTop,width:n.img.srcWidth,height:n.img.srcHeight},r={startX:n.img.destLeft,startY:n.img.destTop,width:n.img.destWidth,height:n.img.destHeight},n.objColl=[],n.objColl.push(T.extend({},n.currSelectionPoint,{},!0)),n.img={srcLeft:0,srcTop:0,srcWidth:n.baseImgCanvas.width,srcHeight:n.baseImgCanvas.height,destLeft:this.currDestPoint.startX,destTop:this.currDestPoint.startY,destWidth:this.currDestPoint.width,destHeight:this.currDestPoint.height},"number"==typeof e&&(n.notify("draw",{prop:"setDestPoints",onPropertyChange:!1}),n.notify("draw",{prop:"setClientTransDim",onPropertyChange:!1,value:{isPreventDimension:null}})),n.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:e}}),n.currSelectionPoint=T.extend({},n.objColl[0],{},!0),this.currDestPoint={startX:n.img.destLeft,startY:n.img.destTop,width:n.img.destWidth,height:n.img.destHeight},n.objColl=o,n.activeObj=t,n.img={srcLeft:i.startX,srcTop:i.startY,srcWidth:i.width,srcHeight:i.height,destLeft:r.startX,destTop:r.startY,destWidth:r.width,destHeight:r.height})},d.prototype.flipImage=function(e){var t=this.parent,o={direction:e,cancel:!1,previousDirection:t.toPascalCase(t.transform.currFlipState||e)};this.isPreventSelect||(t.trigger("flipping",o),t.editCompleteArgs=o),this.flipEvent(o,e)},d.prototype.flipEvent=function(e,t){var o=this.parent;if(e.cancel)o.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:o.prevEventObjPoint}}),o.activeObj=o.prevEventSelectionPoint,o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj}});else{T.isNullOrUndefined(this.transCurrObj)&&(o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(e={currObj:{}}),value:{object:e}}),(e=e.currObj).objColl=T.extend([],o.objColl,null,!0),e.pointColl=T.extend({},o.pointColl,null,!0),e.afterCropActions=T.extend([],o.afterCropActions,[],!0),o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(r={selPointColl:null}),value:{obj:r}}),e.selPointColl=T.extend([],r.selPointColl,[],!0)),o.afterCropActions.push("horizontal"===t.toLowerCase()?"horizontalflip":"verticalflip");var i,e=[],r=(o.activeObj.activePoint&&(void 0!==o.activeObj.shape&&(e=o.activeObj.shape.split("-")),!o.currObjType.isCustomCrop&&"crop"!==e[0]||(i=o.currObjType.isCustomCrop?"custom":e[1],o.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),o.objColl.push(o.activeObj),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}))),o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),o.clearContext(this.lowerContext),o.clearContext(this.upperContext),T.extend([],o.objColl,[],!0)),e=T.extend({},o.activeObj,{},!0),n=(o.objColl=[],o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.isReverseFlip||o.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),t.toLowerCase()),a=(this.updateFlipState(n),o.transform.currFlipState.toLowerCase()),a=(o.transform.currFlipState="horizontal"===n&&"horizontal"===a||"vertical"===n&&"vertical"===a?"":n,{isSelected:null}),n=(o.notify("draw",{prop:"getRotatedFlipCropSelection",onPropertyChange:!1,value:{bool:a}}),a.isSelected&&(o.img.destLeft+=o.panPoint.totalPannedInternalPoint.x,o.img.destTop+=o.panPoint.totalPannedInternalPoint.y),this.lowerContext.filter);o.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=n,o.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),this.updateFlipState(t.toLowerCase()),this.isReverseFlip||(o.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),this.updateFlipColl(t.toLocaleLowerCase()),o.rotateFlipColl.push(t.toLowerCase())),1===o.rotateFlipColl.length&&(o.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!(a={panRegion:""}),value:{panObj:a}}),""===a.panRegion?o.notify("draw",{prop:"setClientTransDim",onPropertyChange:!1,value:{isPreventDimension:null}}):this.setDestPointsForFlipState()),o.isCircleCrop&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),o.objColl=T.extend([],r,[],!0),o.activeObj=T.extend({},e,{},!0);for(var s=0,l=o.objColl.length;s<l;s++){var p=o.objColl[s].flipObjColl;0!==p.length&&p[p.length-1]===t?p.pop():p.push(t)}o.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:t.toLowerCase()}});n=this.lowerContext.filter,a=(this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",o.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),t.toLowerCase()),r=(("horizontal"===a||"vertical"===a)&&o.notify("freehand-draw",{prop:"flipFHDColl",onPropertyChange:!1,value:{value:a}}),o.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=n,o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.updateCurrSelectionPoint(a),o.isUndoRedo=!1,o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),o.isCircleCrop&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),i&&(this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.activeObj=T.extend({},o.objColl[o.objColl.length-1],{},!0),o.objColl.pop(),o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o.activeObj}})),{collection:o.rotateFlipColl});o.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:o.rotateFlipColl,isRotateFlipCollection:!0,obj:r}}),o.rotateFlipColl=r.collection,o.cropObj.activeObj.shape&&!this.isPreventSelect&&(o.notify("draw",{prop:"setIsCropSelect",value:{bool:!0}}),this.isPreventSelect=!0,o.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),this.isPreventSelect=!1,o.setProperties({zoomSettings:{zoomFactor:1}},!0),this.prevZoomValue=o.zoomSettings.zoomFactor)}},d.prototype.updateFlipState=function(e){var t=this.parent.transform.degree;"horizontal"===e?t%90==0&&t%180!=0?this.verticalFlip():this.horizontalFlip():"vertical"===e&&(t%90==0&&t%180!=0?this.horizontalFlip():this.verticalFlip())},d.prototype.horizontalFlip=function(){this.lowerContext.translate(this.lowerContext.canvas.width,0),this.lowerContext.scale(-1,1),this.upperContext.translate(this.upperContext.canvas.width,0),this.upperContext.scale(-1,1)},d.prototype.verticalFlip=function(){this.lowerContext.translate(0,this.lowerContext.canvas.height),this.lowerContext.scale(1,-1),this.upperContext.translate(0,this.upperContext.canvas.height),this.upperContext.scale(1,-1)},d.prototype.updateFlipColl=function(e){this.isPreventSelect||(0===this.flipColl.length||this.flipColl[this.flipColl.length-1]!==e?this.flipColl.push(e):this.flipColl.pop(),4<=this.flipColl.length&&("horizontal"===(e=this.flipColl.slice(-4))[0]&&"vertical"===e[1]&&"horizontal"===e[2]&&"vertical"===e[3]||"vertical"===e[0]&&"horizontal"===e[1]&&"vertical"===e[2]&&"horizontal"===e[3])&&this.flipColl.splice(-4))},d.prototype.setDestPointsForFlipState=function(){var e=this.parent,t={panRegion:""},o=e.img,i=o.destLeft,r=o.destTop,n=o.destWidth,o=o.destHeight,a=e.lowerCanvas,s=a.clientWidth,a=a.clientHeight;e.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:t}}),""!==t.panRegion&&("horizontal"===t.panRegion?e.img.destLeft=s-(n+i):("vertical"!==t.panRegion&&(e.img.destLeft=s-(n+i)),e.img.destTop=a-(o+r)))},d.prototype.zoomAction=function(e,t,o,i){var r=this.parent;if(!r.disabled&&r.isImageLoaded)if(T.isNullOrUndefined(o)&&(r.zoomSettings.zoomFactor>=r.zoomSettings.maxZoomFactor&&0<e||r.zoomSettings.zoomFactor>r.zoomSettings.minZoomFactor&&e<0&&this.disableZoomOutBtn(!0)||r.zoomSettings.zoomFactor<=r.zoomSettings.minZoomFactor&&e<0))r.notify("toolbar",{prop:"zoom-up-handler",onPropertyChange:!1});else{r.notify("draw",{prop:"setImageEdited",onPropertyChange:!1});var n=e;e=0<n?.1:-.1;for(var a,s=0;s<Math.round(Math.abs(n/.1));s++)1===this.prevZoomValue?this.prevZoomValue+=0<e?10*e:10*e/10:1<this.prevZoomValue?this.prevZoomValue+=10*e:this.prevZoomValue<1&&(this.prevZoomValue+=10*e/10,a=Math.pow(10,1),this.prevZoomValue=Math.round(this.prevZoomValue*a)/a);e=n,r.setProperties({zoomSettings:{zoomFactor:this.prevZoomValue}},!0);var o=void 0,o=(this.tempActiveObj=null,this.isShape=!1,void 0!==r.activeObj.shape&&("shape"===r.activeObj.shape?r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}):o=r.activeObj.shape.split("-")),void 0!==o&&"crop"===o[0]?(this.tempActiveObj=T.extend({},r.activeObj,{},!0),r.isCropTab=!0):(r.activeObj.shape&&"crop"!==o[0]&&(0!==r.activeObj.activePoint.width||0!==r.activeObj.activePoint.height)||"path"===r.activeObj.shape&&0<r.activeObj.pointColl.length)&&(this.isShape=!0),{zoomType:null}),l=(r.notify("selection",{prop:"getZoomType",onPropertyChange:!1,value:{obj:o}}),T.isNullOrUndefined(t)&&(t=r.isCropTab&&this.tempActiveObj?{x:r.activeObj.activePoint.startX+r.activeObj.activePoint.width/2,y:r.activeObj.activePoint.startY+r.activeObj.activePoint.height/2}:{x:r.lowerCanvas.clientWidth/2,y:r.lowerCanvas.clientHeight/2},"MouseWheel"!==o.zoomType&&"Pinch"!==o.zoomType||(t={x:r.zoomSettings.zoomPoint.x,y:r.zoomSettings.zoomPoint.y})),r.zoomSettings.zoomFactor-10*e),t={zoomPoint:t,cancel:!1,previousZoomFactor:l,currentZoomFactor:r.zoomSettings.zoomFactor,zoomTrigger:o.zoomType};!r.isCropToolbar&&r.isZoomBtnClick&&(r.trigger("zooming",t),r.editCompleteArgs=t),this.zoomEvent(t,e,i)}},d.prototype.zoomEvent=function(e,t,o){var i,r=this.parent,n=r.zoomSettings,a=n.zoomFactor,n=n.minZoomFactor;if(e.cancel)r.isZoomBtnClick=!1;else{"blur"!==this.parent.activeObj.redactType&&"pixelate"!==this.parent.activeObj.redactType&&r.notify("toolbar",{prop:"close-contextual-toolbar",onPropertyChange:!1}),!r.isCropTab&&r.activeObj.shape&&(i=r.activeObj.currIndex),r.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height);var s,l={canvasFilter:r.canvasFilter},p=(this.lowerContext.filter=l.canvasFilter,r.upperCanvas.style.cursor=r.cursor="default",T.extend([],r.objColl,[],!0),r.isCropTab||(0!==r.transform.degree?(r.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),r.panPoint.currentPannedPoint={x:0,y:0},s=r.allowDownScale,r.allowDownScale=!1,this.rotatePan(!0,!0),r.allowDownScale=s):""!==r.transform.currFlipState&&(r.panPoint.totalPannedPoint={x:0,y:0}),0!==r.transform.straighten)||this.isPreventSelect||r.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:o}}),0===r.transform.degree?(this.drawZoomImgToCanvas(t,this.tempActiveObj),r.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!(l={panRegion:""}),value:{panObj:l}}),""!==l.panRegion&&(r.notify("crop",{prop:"setTempFlipPanPoint",onPropertyChange:!1,value:{point:r.panPoint.totalPannedPoint,isAdd:!0}}),l=T.extend([],r.objColl,[],!0),r.objColl=[],h=r.img.destLeft,p=r.img.destTop,this.setDestPointsForFlipState(),this.rotatedFlip(),r.img.destLeft=h,r.img.destTop=p,r.objColl=l,r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:o}}),0!==r.transform.straighten||this.isPreventSelect||r.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:o}})),a<=n&&!r.isCropTab&&(r.panPoint.totalPannedPoint={x:0,y:0})):(0!==r.transform.straighten||this.isPreventSelect||r.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:o}}),r.panPoint.totalPannedClientPoint={x:0,y:0},r.panPoint.totalPannedInternalPoint={x:0,y:0},this.rotateZoom(t),r.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!(h={panRegion:""}),value:{panObj:h}}),""!==h.panRegion&&(s=this.lowerContext.filter,this.lowerContext.filter="none",r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:o}}),this.lowerContext.filter=s)),Math.pow(10,1)),l=((a<=n||Math.round(r.transform.zoomFactor*p)/p==2)&&(clearInterval(this.zoomBtnHold),this.zoomBtnHold=0),{panRegion:""}),h=(r.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:l}}),""===l.panRegion&&(s=this.lowerContext.filter,this.lowerContext.filter="none",r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:o}}),this.lowerContext.filter=s),(r.currSelectionPoint&&"crop-circle"===r.currSelectionPoint.shape||r.isCircleCrop)&&r.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),r.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.tempActiveObj&&(r.activeObj=T.extend({},this.tempActiveObj,{},!0),r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj}}),a<=n)&&(r.currSelectionPoint=null),r.isUndoRedo=!1,(t=document.querySelector("#"+r.element.id+"_zoomOut"))&&a<=n?(t.classList.add("e-disabled"),t.parentElement.classList.add("e-overlay")):t&&(t.classList.remove("e-disabled"),t.parentElement.classList.remove("e-overlay")),r.drawingShape);if(this.autoEnablePan(),r.drawingShape=h,this.tempActiveObj&&(r.activeObj=T.extend({},this.tempActiveObj,{},!0)),"crop-custom"===r.activeObj.shape&&(r.currObjType.isCustomCrop=!0),this.isShape){if(i){for(var d=0,c=r.objColl.length;d<c;d++)if(r.objColl[d].currIndex===i){r.activeObj=T.extend({},r.objColl[d],{},!0),r.objColl.splice(d,1);break}}else r.activeObj=T.extend({},r.objColl[r.objColl.length-1],{},!0),r.objColl.pop();r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}),r.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),r.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})}r.notify("toolbar",{prop:"enable-disable-btns",onPropertyChange:!1}),r.notify("selection",{prop:"setZoomType",onPropertyChange:!1,value:{zoomType:"Toolbar"}}),e={zoomPoint:e.zoomPoint,previousZoomFactor:e.previousZoomFactor,currentZoomFactor:e.currentZoomFactor,zoomTrigger:e.zoomTrigger},!r.isCropToolbar&&r.isZoomBtnClick&&(r.isZoomBtnClick=!1),r.drawingShape?(p=T.extend({},r.activeObj,{},!0),r.enableShapeDrawing(r.toPascalCase(r.drawingShape),!0),(0<(r.activeObj=p).activePoint.width||0<p.activePoint.height||p.pointColl&&0<p.pointColl.length)&&("redact"===p.shape&&r.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}),l=r.element.querySelector("#"+r.element.id+"_zOrderBtn"),o=r.element.querySelector("#"+r.element.id+"_duplicate"),s=r.element.querySelector("#"+r.element.id+"_remove"),a=r.element.querySelector("#"+r.element.id+"_editText"),l&&l.classList.remove("e-overlay"),o&&o.classList.remove("e-overlay"),s&&s.classList.remove("e-overlay"),a)&&a.classList.remove("e-overlay")):r.activeObj.shape&&"redact"===r.activeObj.shape&&(r.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"redact",isApplyBtn:!1,isCropping:!1}}),r.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}))}},d.prototype.disableZoomOutBtn=function(e){var t,o,i,r=this.parent,n=r.zoomSettings,a=n.zoomFactor,n=n.minZoomFactor,s=!1,l=(T.isNullOrUndefined(e)||(r.transform.zoomFactor-=.1),t=r.element.querySelector("#"+r.element.id+"_zoomOut"),{destLeft:r.img.destLeft,destTop:r.img.destTop,destWidth:r.img.destWidth,destHeight:r.img.destHeight});return r.activeObj.shape?(o=this.setZoomDimension(-.1,r.activeObj),T.isNullOrUndefined(t)||(i=r.activeObj.activePoint,s=0===r.transform.straighten?r.img.destLeft>i.startX||r.img.destTop>i.startY||r.img.destLeft+r.img.destWidth<i.endX||r.img.destTop+r.img.destHeight<i.endY||a===n?(t.classList.add("e-disabled"),t.parentElement.classList.add("e-overlay"),!0):(t.classList.remove("e-disabled"),t.parentElement.classList.remove("e-overlay"),!1):(r.img.destWidth=o.width,r.img.destHeight=o.height,r.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!(i={isIntersect:null})}),r.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:i}}),i.isIntersect||a===n?(t.classList.add("e-disabled"),t.parentElement.classList.add("e-overlay"),!0):(t.classList.remove("e-disabled"),t.parentElement.classList.remove("e-overlay"),!1)))):this.setZoomDimension(-.1,null),T.isNullOrUndefined(e)||(r.transform.zoomFactor+=.1),r.img.destLeft=l.destLeft,r.img.destTop=l.destTop,r.img.destWidth=l.destWidth,r.img.destHeight=l.destHeight,s},d.prototype.drawZoomImgToCanvas=function(e,t){var o=this.parent,i=Math.pow(10,1),i=Math.round(o.transform.zoomFactor*i)/i,i=(.1==i&&-.1===e||0==i&&-.025===e?o.transform.zoomFactor=0:o.transform.zoomFactor+=e,o.transform[o.isCropTab?"cropZoomFactor":"defaultZoomFactor"]=o.transform.zoomFactor,{width:0,height:0});o.isCropTab?i=this.cropZoom(e,t):((i=this.calcMaxDimension(o.img.srcWidth,o.img.srcHeight)).width+=i.width*o.transform.zoomFactor,i.height+=i.height*o.transform.zoomFactor,o.img.destLeft=(o.lowerCanvas.clientWidth-i.width)/2,o.img.destTop=(o.lowerCanvas.clientHeight-i.height+1)/2),o.notify("draw",{prop:"draw-image-to-canvas",value:{dimension:i}}),i.width=this.cropDimension.width,i.height=this.cropDimension.height,i.width+=i.width*o.transform.zoomFactor,i.height+=i.height*o.transform.zoomFactor,o.notify("draw",{prop:"setZoomCropWidth",value:{width:i.width,height:i.height}})},d.prototype.rotatedFlip=function(){var e=this.parent,t=(this.isReverseFlip=!0,e.transform.currFlipState),o=this.flipColl,i=T.extend([],e.objColl,[],!0),r=T.extend({},e.activeObj,{},!0),n=(this.flipColl=[],e.objColl=[],e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),e.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),this.lowerContext.filter);e.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=n,e.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:!0,context:null,isPreventCircleCrop:null}}),""===t&&""!==e.transform.currFlipState&&(t=e.transform.currFlipState),e.transform.currFlipState=t,this.flipColl=o,e.objColl=T.extend([],i,[],!0),this.lowerContext.filter="none",e.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),this.lowerContext.filter=n,0!==r.activePoint.width&&(e.activeObj=T.extend({},r,{},!0)),this.isReverseFlip=!1},d.prototype.rotateZoom=function(e){var t=this.parent,o=Math.pow(10,1),o=Math.round(t.transform.zoomFactor*o)/o,o=(.1==o&&-.1===e||0==o&&-.025===e?t.transform.zoomFactor=0:t.transform.zoomFactor+=e,t.isCropTab?t.transform.cropZoomFactor=t.transform.zoomFactor:t.transform.defaultZoomFactor=t.transform.zoomFactor,T.extend([],t.objColl,[],!0)),e=T.extend({},t.activeObj,{},!0),i=(t.objColl=[],t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),t.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!0}}),t.notify("draw",{prop:"setDestPoints",onPropertyChange:!1}),this.lowerContext.filter),i=(t.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=i,t.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),t.objColl=o,t.activeObj=e,{width:this.cropDimension.width,height:this.cropDimension.height});i.width+=i.width*t.transform.zoomFactor,i.height+=i.height*t.transform.zoomFactor,t.notify("draw",{prop:"setZoomCropWidth",value:{width:i.width,height:i.height}})},d.prototype.autoEnablePan=function(){var e=this.parent;e.transform.zoomFactor<=0?(e.togglePan=!1,e.notify("selection",{prop:"setDragCanvas",value:{bool:!1}}),e.pan(!1),this.disablePan=!1):e.pan(!this.disablePan)},d.prototype.cropZoom=function(e,t){var o=this.parent,i=o.img.destLeft,r=o.img.destTop,n={width:0,height:0};return(n=o.transform.degree%90==0&&o.transform.degree%180!=0?this.calcMaxDimension(o.img.srcHeight,o.img.srcWidth):this.calcMaxDimension(o.img.srcWidth,o.img.srcHeight)).width+=n.width*o.transform.zoomFactor,n.height+=n.height*o.transform.zoomFactor,o.img.destLeft=i-(n.width-o.img.destWidth)/2,o.img.destTop=r-(n.height-o.img.destHeight)/2,i=o.img.destLeft,r=o.img.destTop,t&&0===o.transform.straighten&&(o.img.destLeft>t.activePoint.startX&&(o.img.destLeft=t.activePoint.startX,0===o.transform.degree)&&(o.panPoint.totalPannedPoint.x-=i-o.img.destLeft),o.img.destTop>t.activePoint.startY&&(o.img.destTop=t.activePoint.startY,0===o.transform.degree)&&(o.panPoint.totalPannedPoint.y-=r-o.img.destTop),o.img.destLeft+n.width<t.activePoint.endX&&(o.img.destLeft=t.activePoint.endX-n.width,0===o.transform.degree)&&(o.panPoint.totalPannedPoint.x-=i-o.img.destLeft),o.img.destTop+n.height<t.activePoint.endY)&&(o.img.destTop=t.activePoint.endY-n.height,0===o.transform.degree)&&(o.panPoint.totalPannedPoint.y-=r-o.img.destTop),n},d.prototype.setZoomDimension=function(e,t){var o,i,r,n,a,s=this.parent,l=s.transform.degree,p={width:0,height:0};return(p=l%90==0&&l%180!=0?this.calcMaxDimension(s.img.srcHeight,s.img.srcWidth):this.calcMaxDimension(s.img.srcWidth,s.img.srcHeight)).width+=p.width*s.transform.zoomFactor,p.height+=p.height*s.transform.zoomFactor,s.img.destLeft+=(s.img.destWidth-p.width)/2,s.img.destTop+=(s.img.destHeight-p.height)/2,e<0&&t?(l=t.activePoint.startX,o=t.activePoint.startY,i=t.activePoint.width,r=t.activePoint.height,n=s.img.destLeft+p.width,a=s.img.destTop+p.height,s.img.destLeft>l&&(s.img.destLeft=l),s.img.destTop>o&&(s.img.destTop=o),n<l+i&&(s.img.destLeft=l+i-p.width),a<o+r&&(s.img.destTop=o+r-p.height)):e<0&&T.isNullOrUndefined(t)&&(0<s.img.destLeft&&(s.img.destLeft=0),0<s.img.destTop&&(s.img.destTop=0),s.img.destLeft+p.width<s.lowerCanvas.clientWidth&&(s.img.destLeft=s.lowerCanvas.clientWidth-s.img.destWidth),s.img.destTop+p.height<s.lowerCanvas.clientHeight)&&(s.img.destTop=s.lowerCanvas.clientHeight-s.img.destHeight),p},d.prototype.drawPannedImage=function(e,t){var o=this.parent,i={panDown:null},i=(o.notify("selection",{prop:"getPanDown",onPropertyChange:!1,value:{obj:i}}),{startPoint:i.panDown,endPoint:this.panMove,cancel:!1});o.trigger("panning",i),i.cancel||this.panEvent(e,t)},d.prototype.panEvent=function(e,t,o){var i,r,n,a,s,l=this.parent,p=!1;l.activeObj.shape&&"shape"===l.activeObj.shape&&l.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),T.isNullOrUndefined(l.activeObj.shape)&&(p=!0,s=(i=l.activeObj.activePoint={startX:l.img.destLeft,startY:l.img.destTop,endX:l.img.destLeft+l.img.destWidth,endY:l.img.destTop+l.img.destHeight}).startX,r=i.startY,n=i.endX,a=i.endY,s<0&&(i.startX=0),r<0&&(i.startY=0),n>l.lowerCanvas.width&&(i.endX=l.lowerCanvas.width),a>l.lowerCanvas.height&&(i.endY=l.lowerCanvas.height),i.width=i.endX-i.startX,i.height=i.endY-i.startY,l.activeObj.shape="crop-custom",l.notify("shape",{prop:"getStrokeSettings",onPropertyChange:!(s={strokeSettings:{}}),value:{obj:s}}),l.activeObj.strokeSettings=s.strokeSettings,l.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:i,obj:l.activeObj,isMouseMove:null,x:null,y:null}}),l.isCropTab=!0),0===l.transform.degree?(r=void 0,r=T.isNullOrUndefined(e)&&T.isNullOrUndefined(t)||o?o?this.updatePanPoints(e,t):this.updatePanPoints():{x:e,y:t},l.panPoint.totalPannedPoint.x+=r.x,l.panPoint.totalPannedPoint.y+=r.y,n=T.extend({},l.activeObj,{},!0),a=this.lowerContext.filter,this.drawPannImage(r,p),this.lowerContext.filter=a,this.tempPanMove=T.extend({},this.panMove,{},!0),l.activeObj=T.extend({},n,{},!0),this.upperContext.clearRect(0,0,l.upperCanvas.width,l.upperCanvas.height),l.activeObj.shape&&l.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:l.activeObj}})):(s=l.transform.currFlipState,l.isCropTab=!0,T.isNullOrUndefined(e)&&T.isNullOrUndefined(t)||o?l.panPoint.currentPannedPoint=o?this.updatePanPoints(e,t):this.updatePanPoints():l.panPoint.currentPannedPoint={x:e,y:t},l.transform.currFlipState=s,this.rotatePan(null,null,p),l.isCropTab=!1,this.tempPanMove=T.extend({},this.panMove,{},!0)),p&&(l.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),l.isCropTab=!1,this.upperContext.clearRect(0,0,l.upperCanvas.width,l.upperCanvas.height))},d.prototype.drawPannImage=function(e,t){var o=this.parent,i=this.lowerContext.filter,r={startX:o.img.destLeft,startY:o.img.destTop,width:o.img.destWidth,height:o.img.destHeight},i=(this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),o.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),o.img.destLeft=r.startX,o.img.destTop=r.startY,o.img.destWidth=r.width,o.img.destHeight=r.height,this.setDestPointsForFlipState(),t&&(o.isCropTab=!1),o.notify("draw",{prop:"drawImage",onPropertyChange:!1}),t&&(o.isCropTab=!0),(o.currSelectionPoint&&"crop-circle"===o.currSelectionPoint.shape||o.isCircleCrop)&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:!0}}),this.lowerContext.filter=i,o.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),o.img.destLeft=r.startX,o.img.destTop=r.startY,o.img.destWidth=r.width,o.img.destHeight=r.height,this.lowerContext.filter);this.lowerContext.filter="none",t&&(o.isCropTab=!1),o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:e.x,y:e.y,panRegion:""}}),t&&(o.isCropTab=!0),this.lowerContext.filter=i,o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.isCircleCrop&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:!0}})},d.prototype.resetZoom=function(){var e,t,o=this.parent;0!==o.transform.defaultZoomFactor&&(e=o.isUndoRedo,o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(t={currObj:{}}),value:{object:t}}),this.transCurrObj=t.currObj,this.transCurrObj.objColl=T.extend([],o.objColl,null,!0),this.transCurrObj.pointColl=T.extend({},o.pointColl,null,!0),this.transCurrObj.afterCropActions=T.extend([],o.afterCropActions,[],!0),o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(t={selPointColl:null}),value:{obj:t}}),this.transCurrObj.selPointColl=T.extend([],t.selPointColl,[],!0),o.isUndoRedo=o.isCropToolbar=!0,0<(t=o.transform.defaultZoomFactor)?this.zoomAction(-t):this.zoomAction(Math.abs(t)),o.isCropToolbar=!1,o.isUndoRedo=e)},d.prototype.performTransformation=function(e){var t=this.parent;this.resetZoom(),this.updateTransform(e);for(var o,i=0,r=t.objColl.length;i<r;i++)0<t.objColl[i].flipObjColl.length&&(o={collection:t.objColl[i].flipObjColl},t.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:o.collection,isRotateFlipCollection:null,obj:o}}),t.objColl[i].flipObjColl=o.collection,0===t.objColl[i].flipObjColl.length)&&(t.objColl[i].shapeFlip="")},d.prototype.updateTransform=function(e){switch(e.toLowerCase()){case"rotateleft":this.rotateImage(-90);break;case"rotateright":this.rotateImage(90);break;case"horizontalflip":this.flipImage(m.Direction.Horizontal);break;case"verticalflip":this.flipImage(m.Direction.Vertical)}},d.prototype.rotatePan=function(e,t,o){var i,r=this.parent,n=(this.isReverseRotate=!0,r.transform.degree),a={selPointColl:null},s=(r.activeObj.activePoint&&r.activeObj.shape&&(i=T.extend({},r.activeObj,{},!0)),T.extend([],r.objColl,[],!0)),l=T.extend([],r.pointColl,[],!0),a=(r.objColl=[],r.pointColl=[],r.freehandCounter=0,r.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),a.selPointColl),p=(r.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),r.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!0}}),r.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),r.img.destLeft),h=r.img.destTop,d=r.panPoint.totalPannedInternalPoint,d=(r.isCropTab&&(r.img.destLeft+=d.x,r.img.destTop+=d.y),r.notify("crop",{prop:"updateRotatePan",onPropertyChange:!1}),r.isCropTab&&(r.panPoint.totalPannedInternalPoint.x=r.img.destLeft-p,r.panPoint.totalPannedInternalPoint.y=r.img.destTop-h),this.lowerContext.filter),p=(o&&(r.isCropTab=!1),r.notify("draw",{prop:"drawImage",onPropertyChange:!1}),o&&(r.isCropTab=!0),r.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),r.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:!0,isRotatePan:!0}}),r.img.destLeft),h=r.img.destTop;r.img.destLeft+=r.panPoint.totalPannedClientPoint.x,r.img.destTop+=r.panPoint.totalPannedClientPoint.y,r.img.destLeft+=r.panPoint.currentPannedPoint.x,r.img.destTop+=r.panPoint.currentPannedPoint.y,r.panPoint.totalPannedClientPoint.x=r.img.destLeft-p,r.panPoint.totalPannedClientPoint.y=r.img.destTop-h,r.objColl=s,r.pointColl=l,r.freehandCounter=r.pointColl.length,r.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:a}}}),r.transform.degree=n,this.lowerContext.filter="none",e&&(t?(r.panPoint.totalPannedClientPoint.x=-r.panPoint.totalPannedClientPoint.x,r.panPoint.totalPannedClientPoint.y=-r.panPoint.totalPannedClientPoint.y,r.panPoint.currentPannedPoint=T.extend({},r.panPoint.totalPannedClientPoint,{},!0),r.panPoint.totalPannedClientPoint={x:0,y:0},r.img.destLeft+=r.panPoint.currentPannedPoint.x,r.img.destTop+=r.panPoint.currentPannedPoint.y):r.panPoint.currentPannedPoint=T.extend({},r.panPoint.totalPannedClientPoint,{},!0)),o&&(r.isCropTab=!1),r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:r.panPoint.currentPannedPoint.x,y:r.panPoint.currentPannedPoint.y,panRegion:""}}),o&&(r.isCropTab=!0),this.lowerContext.filter=d,r.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.activeObj=T.extend({},i,{},!0),r.activeObj.activePoint&&r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}),this.isReverseRotate=!1},d.prototype.limitPan=function(){var e=this.parent,t=e.activeObj.activePoint,o=t.startX,i=t.startY,r=t.endX,t=t.endY,n=e.img;e.activeObj.activePoint&&(n.destLeft>o&&(e.img.destLeft=o),n.destTop>i&&(e.img.destTop=i),n.destLeft+n.destWidth<r&&(e.img.destLeft=r-n.destWidth),n.destTop+n.destHeight<t)&&(e.img.destTop=t-n.destHeight)},d.prototype.pan=function(e,t,o){var i=this.parent;!i.disabled&&i.isImageLoaded&&(e?(i.togglePan=!0,i.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),i.notify("selection",{prop:"setDragCanvas",value:{bool:!0}}),i.lowerCanvas.style.cursor=i.upperCanvas.style.cursor=i.cursor="grab",i.notify("selection",{prop:"setPanDown",onPropertyChange:!1,value:{panDown:null}}),(t||o)&&(t=t||0,o=o||0,T.isNullOrUndefined(this.panMove)&&(this.panMove={x:t,y:o}),T.isNullOrUndefined(this.tempPanMove)&&(this.tempPanMove={x:this.panMove.x,y:this.panMove.y}),this.panEvent(t,o,!0),this.tempPanMove=null)):(i.togglePan=i.currObjType.isCustomCrop=!1,i.notify("selection",{prop:"setDragCanvas",value:{bool:!1}}),i.lowerCanvas.style.cursor=i.upperCanvas.style.cursor=i.cursor="default"))},d.prototype.zoom=function(e,t){var o=this.parent;if(!o.disabled&&o.isImageLoaded){e=this.getCurrentZoomFactor(e);if(T.isNullOrUndefined(t))this.zoomAction(e,t);else for(var i=0<e?"zoomIn":"zoomOut",r=10*Math.abs(e),n=0;n<r;n++)o.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:t.x,y:t.y,type:i,isResize:null}});e={action:0<e?"zoom-in":"zoom-out",actionEventArgs:o.editCompleteArgs};o.triggerEditCompleteEvent(e)}},d.prototype.getCurrentZoomFactor=function(e){return!(1<=e)||this.prevZoomValue<1?e-this.prevZoomValue:.1*(e-this.prevZoomValue)},d.prototype.setCurrPanRegion=function(e,t,o){var i=e,i=""===e?"horizontal"===t?"horizontal":"vertical"===t?"vertical":e:"horizontal"===e?"horizontal"===t?"horizontalVertical":"vertical"===t?"verticalHorizontal":90===t?"vertical":-90===t?"horizontal":e:"vertical"===e?"horizontal"===t?"horizontalVertical":"vertical"===t?"verticalHorizontal":90===t?"horizontal":-90===t?"vertical":e:"horizontal"===t?"vertical":"vertical"===t?"horizontal":e;o.panRegion=i},d.prototype.rotate=function(e,t){var o=this.parent;!o.disabled&&o.isImageLoaded&&e%90==0&&this.rotateImage(e),t.isRotate=!1},d.prototype.flip=function(e){var t=this.parent;!t.disabled&&t.isImageLoaded&&this.flipImage(e)},d.prototype.update=function(){var e,t,o=this.parent,i=0,r=!1,n={bool:!1},a=o.isStraightening,s=0,l=o.element.querySelector("#"+o.element.id+"_contextualToolbar"),p=o.element.querySelector(".e-contextual-toolbar-wrapper"),h=o.element.querySelector("#"+o.element.id+"_headWrapper"),l=(o.isImageLoaded&&(d=!1,e=void 0,T.Browser.isDevice&&(o.activeObj.shape&&(e=o.activeObj.shape.split("-")),o.currObjType.isCustomCrop||e&&"crop"===e[0])&&(d=!0),o.notify("toolbar",{prop:"getFrameToolbar",onPropertyChange:!1,value:{obj:{bool:null}}}),!a&&(l&&!l.parentElement.classList.contains("e-hide")||h&&!h.parentElement.classList.contains("e-hide"))&&(p.classList.add("e-hide"),d||o.okBtn(null,!0),o.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),o.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1})),o.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:n}}),n.bool&&o.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),e=T.extend({},o.activeObj.activePoint,{},!0),!o.activeObj.shape||0===e.width&&0===e.height||(r=!0,"block"===o.textArea.style.display||"inline-block"===o.textArea.style.display?(o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),o.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1})):(o.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),o.objColl.push(o.activeObj)),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}))),o.updateDropInfoContent(o.element.querySelector(".e-ie-drop-info")),this.lowerContext.filter),h=o.element.querySelector("#"+o.element.id+"_canvasWrapper"),d=(h&&(h.style.width=o.element.offsetWidth-2+"px"),o.lowerCanvas.width=o.upperCanvas.width=o.maskCanvas.width=o.element.offsetWidth-2,o.toolbarTemplate?i=o.element.querySelector("#"+o.element.id+"_toolbarArea").clientHeight:o.element.querySelector("#"+o.element.id+"_toolbar")&&0===(i=o.element.querySelector("#"+o.element.id+"_toolbar").clientHeight)&&o.toolbar&&0<o.toolbar.length&&-1===o.toolbar.indexOf("Open")&&(o.notify("toolbar",{prop:"getToolbarHeight",value:{obj:t={toolbarHeight:0}}}),i=t.toolbarHeight),o.element.querySelector("#"+o.element.id+"_contextualToolbarArea"));T.Browser.isDevice&&a&&d&&(s=d.clientHeight),o.notify("toolbar",{prop:"setToolbarHeight",value:{height:i}}),T.Browser.isDevice?h&&(h.style.height=o.element.offsetHeight-(2*i+s)-4+"px"):h&&(h.style.height=o.element.offsetHeight-i-2+"px"),o.lowerCanvas.height=o.upperCanvas.height=parseFloat(h.style.height),this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",o.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),o.canvasFilter=this.lowerContext.filter,o.initialAdjustmentValue=this.lowerContext.filter,o.clearContext(this.lowerContext),o.clearContext(this.upperContext),o.isImageLoaded&&(o.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.lowerContext.filter=l,o.initialAdjustmentValue=l,o.canvasFilter=this.lowerContext.filter,o.isImageLoaded&&(f.showSpinner(o.element),o.element.style.opacity="0.5"),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),h&&(h.style.width=o.element.offsetWidth-2+"px",h.style.height=o.element.offsetHeight+"px",o.notify("toolbar",{prop:"getToolbarHeight",value:{obj:e={toolbarHeight:0}}}),T.Browser.isDevice?h.style.height=parseFloat(h.style.height)-2*e.toolbarHeight-s-4+"px":h.style.height=parseFloat(h.style.height)-e.toolbarHeight-2+"px"),o.lowerCanvas.width=o.upperCanvas.width=o.maskCanvas.width=parseFloat(h.style.width),o.lowerCanvas.height=o.upperCanvas.height=o.maskCanvas.height=parseFloat(h.style.height),this.lowerContext.filter=l,this.calcMaxDimension(o.img.srcWidth,o.img.srcHeight,t={width:0,height:0}),d=t,a&&0!==o.transform.cropZoomFactor?(d.width+=d.width*o.transform.cropZoomFactor,d.height+=d.height*o.transform.cropZoomFactor):0<o.transform.defaultZoomFactor&&(d.width+=d.width*o.transform.defaultZoomFactor,d.height+=d.height*o.transform.defaultZoomFactor),o.img.destLeft=(o.lowerCanvas.clientWidth-d.width)/2,o.img.destTop=(o.lowerCanvas.clientHeight-d.height+1)/2,0===o.transform.degree&&""===o.transform.currFlipState?(0<o.transform.defaultZoomFactor&&(o.img.destLeft+=o.panPoint.totalPannedPoint.x,o.img.destTop+=o.panPoint.totalPannedPoint.y),o.notify("draw",{prop:"draw-image-to-canvas",value:{dimension:d}})):(o.notify("draw",{prop:"draw-image-to-canvas",value:{dimension:d}}),o.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),i=this.lowerContext.filter,o.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=i,o.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}})),o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),o.isCircleCrop&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),f.hideSpinner(o.element),o.element.style.opacity="1",o.notify("toolbar",{prop:"getDefToolbarItems",value:{obj:s={defToolbarItems:null}}}),s.defToolbarItems&&0<s.defToolbarItems.length&&document.getElementById(o.element.id+"_toolbar")&&((e=T.getComponent(o.element.id+"_toolbar","toolbar"))&&e.refreshOverflow(),p)&&!a&&p.classList.add("e-hide"),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),r&&(h=T.extend({},o.objColl[o.objColl.length-1],null,!0),o.objColl.pop(),0!==h.activePoint.width)&&0!==h.activePoint.height&&(this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),o.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),o.objColl.push(h),o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),h=T.extend({},o.objColl[o.objColl.length-1],null,!0),o.objColl.pop(),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),o.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:h}}),a&&o.notify("draw",{prop:"setStraightenActObj",value:{activeObj:h}}),"rectangle"!==o.activeObj.shape&&"ellipse"!==o.activeObj.shape&&"text"!==o.activeObj.shape&&"line"!==o.activeObj.shape&&"arrow"!==o.activeObj.shape&&"path"!==o.activeObj.shape&&"image"!==o.activeObj.shape||o.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})),n.bool&&o.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:!0}}),o.isResize&&(o.aspectWidth=Math.ceil(o.img.destWidth),o.aspectHeight=Math.ceil(o.img.destHeight),o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:!1,isCropping:!1}}),o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:!1,isCropping:!1}})),(0!==o.transform.degree||""!==o.transform.currFlipState)&&0<o.transform.defaultZoomFactor?(l=T.extend({},o.panPoint.totalPannedPoint,null,!0),t=T.extend({},o.panPoint.totalPannedInternalPoint,null,!0),d=T.extend({},o.panPoint.totalPannedClientPoint,null,!0),this.zoomAction(.1),this.zoomAction(-.1),0===o.transform.degree?(o.img.destLeft+=l.x,o.img.destTop+=l.y,o.panPoint.totalPannedPoint=l,o.notify("draw",{prop:"updateFlipPan",value:{tempSelectionObj:null}})):(o.panPoint.totalPannedInternalPoint=t,o.panPoint.totalPannedClientPoint=d,o.panPoint.currentPannedPoint={x:0,y:0},o.isCropTab=!0,this.rotatePan(),o.isCropTab=!1)):0!==o.transform.degree&&0<o.transform.cropZoomFactor&&(o.transform.zoomFactor=0,o.transform.cropZoomFactor=null,o.notify("toolbar",{prop:"enable-disable-btns",onPropertyChange:!1})))},d.prototype.calcMaxDimension=function(e,t,o,i){var r={toolbarHeight:0},n=this.parent,a=(n.notify("toolbar",{prop:"getToolbarHeight",value:{obj:r}}),i?n.element.clientWidth/3:n.element.clientWidth),s=i?(n.element.clientHeight-r.toolbarHeight)/3:n.element.clientHeight-r.toolbarHeight,s=T.Browser.isDevice?s-r.toolbarHeight:s,r=(T.Browser.isDevice&&n.isStraightening&&(s-=(r=n.element.querySelector("#"+n.element.id+"_contextualToolbarArea"))?r.clientHeight:0),i||0!==n.element.clientHeight||(s=0),T.isNullOrUndefined(i)&&(30<a&&(a-=30),30<s)&&(s-=30),a/e),l=s/t,a=Math.min(e,a),s=Math.min(t,s);return r<1&&r<l?(a=e*r,s=t*r):l<1&&l<r&&(a=e*l,s=t*l),T.isNullOrUndefined(i)&&(n.notify("crop",{prop:"getPreventScaling",onPropertyChange:!(r={bool:null}),value:{obj:r}}),r.bool)&&n.cropObj.activeObj.activePoint&&0!==n.cropObj.activeObj.activePoint.width&&0!==n.cropObj.activeObj.activePoint.height&&(a=n.cropObj.activeObj.activePoint.width,s=n.cropObj.activeObj.activePoint.height),o&&(o.width=a,o.height=s),{width:a,height:s}},d.prototype.updatePanPoints=function(e,t){for(var o=this.parent,i=T.extend({},o.activeObj,{},!0),r=o.img.destLeft,n=o.img.destTop,a=(T.isNullOrUndefined(this.tempPanMove)&&(this.tempPanMove={x:this.panMove.x,y:this.panMove.y}),this.panMove.x-this.tempPanMove.x),s=this.panMove.y-this.tempPanMove.y,l=((e||t)&&(a=e,s=t),o.img.destLeft+=a,o.img.destTop+=s,this.limitPan(),{bool:null}),p={isIntersect:null},h=(o.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),o.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}}),o.notify("draw",{prop:"isSelOutsideImg",onPropertyChange:!1,value:{obj:l}}),0);0!==o.transform.straighten&&(p.isIntersect||l.bool)&&(h++,o.img.destLeft=r,o.img.destTop=n,0!==a&&0<a?--a:0!==a&&a<0&&(a+=1),0!==s&&0<s?--s:0!==s&&s<0&&(s+=1),0!==a||0!==s)&&200!==h;)o.img.destLeft+=a,o.img.destTop+=s,this.limitPan(),o.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),o.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}}),o.notify("draw",{prop:"isSelOutsideImg",onPropertyChange:!1,value:{obj:l}});return o.activeObj=i,{x:o.img.destLeft-r,y:o.img.destTop-n}},d.prototype.resizeImage=function(e,t){var o=this.parent,i=!0,r=!0,n=(o.allowDownScale=!1,o.img.srcLeft=0,o.img.srcTop=0,o.isAspectRatio=!0,[]);for(o.img.srcWidth=o.baseImgCanvas.width,o.img.srcHeight=o.baseImgCanvas.height,o.resizeSrc&&0!==o.resizeSrc.width&&0!==o.resizeSrc.height&&(o.img.srcLeft=o.resizeSrc.startX,o.img.srcTop=o.resizeSrc.startY,o.img.srcWidth=o.resizeSrc.width,o.img.srcHeight=o.resizeSrc.height);(e<o.img.destWidth||t<o.img.destHeight)&&r;)if(this.zoomAction(-.1,null,!0,!0),e>o.img.destWidth||t>o.img.destHeight)for(;e>o.img.destWidth||t>o.img.destHeight;)this.zoomAction(.0125,null,!0,!0),r=!1,n.push(o.img.destWidth);for(;(e>o.img.destWidth||t>o.img.destHeight)&&r&&i;)if(this.zoomAction(.1,null,!0,!0),e<o.img.destWidth||t<o.img.destHeight)for(;e<o.img.destWidth;)this.zoomAction(-.0125,null,!0,!0),i=!1,n.push(o.img.destWidth);for(var a=n[0],s=Math.abs(o.img.destWidth-a),l=0,p=n;l<p.length;l++){var h=p[l],d=Math.abs(e-h);d<s&&(a=h,s=d)}a<e&&i&&(this.zoomAction(-.0125,null,!0,!0),i=!1),e<a&&!i&&(this.zoomAction(.0125,null,!0,!0),i=!1),this.zoomAction(.0125,null,!0),o.allowDownScale=!0,this.zoomAction(-.0125,null,!0);var c=T.extend({},o.cropObj,{},!0),u=T.extend({},this.prevResizeCurrObj,{},!0);o.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"resize",previousObj:u,previousObjColl:u.objColl,previousPointColl:u.pointColl,previousSelPointColl:u.selPointColl,previousCropObj:c,previousText:null,currentText:null,previousFilter:null,isCircleCrop:o.isCircleCrop}}),o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})},d.prototype.resizeCrop=function(e,t){var o=this.parent,i=!0,r={prevObj:o.prevObj},n=(o.cropObj=T.extend({},o.prevCropObj,{},!0),o.allowDownScale=!1,o.notify("toolbar",{prop:"getPrevObj",onPropertyChange:!1,value:{obj:r}}),T.extend({},r.prevObj.activeObj,{},!0)),a=(r.prevObj.activeObj=T.extend({},o.activeObj,{},!0),o.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:r.prevObj}}),o.objColl=T.extend([],r.prevObj.objColl,[],!0),o.pointColl=T.extend([],r.prevObj.pointColl,[],!0),o.transform.straighten=0,o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),0!==o.transform.straighten||this.isPreventSelect||o.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),e),s=t,l=!1;if(e<=t&&t<=Math.ceil(o.img.destHeight)){for(;t<=Math.ceil(o.img.destHeight)&&i;)if(this.zoomAction(-.1,null,!0,!0),e>o.img.destWidth||t>o.img.destHeight)for(;e>o.img.destWidth||t>o.img.destHeight;)this.zoomAction(.0125,null,!0,!0),i=!1}else if(t<=e&&e<o.img.destWidth){for(;e<o.img.destWidth&&i;)if(this.zoomAction(-.1,null,!0,!0),e>o.img.destWidth||t>o.img.destHeight)for(;e>o.img.destWidth||t>o.img.destHeight;)this.zoomAction(.0125,null,!0,!0),i=!1}else if(e<=t&&t>=o.img.destHeight)for(;t>=o.img.destHeight&&i;)this.zoomAction(.1,null,!0,!0);else if(t<=e&&e>=o.img.destWidth){for(;e>=o.img.destWidth&&i;)this.zoomAction(.1,null,!0,!0);if(e<o.img.destWidth&&t<o.img.destHeight){for(;e<o.img.destWidth&&t<o.img.destHeight;)this.zoomAction(-.0125,null,!0,!0),i=!1;this.zoomAction(.0125,null,!0,!0)}}else if(t>o.img.destHeight&&e>o.img.destWidth){for(;t>o.img.destHeight&&e>o.img.destWidth&&i;)this.zoomAction(.1,null,!0,!0);if(e<o.img.destWidth&&t<o.img.destHeight){for(;e<o.img.destWidth&&t<o.img.destHeight;)this.zoomAction(-.0125,null,!0,!0),i=!1;this.zoomAction(.0125,null,!0,!0)}}if(this.resizeImg(n,e,t),e=a,(t=s)!==o.img.destHeight||e!==o.img.destWidth){for(;t>o.img.destHeight||e>o.img.destWidth;)this.zoomAction(.0125,null,!0,!0),l=!0;l&&(this.zoomAction(-.0125,null,!0,!0),l=!1)}if(t!==o.img.destHeight||e!==o.img.destWidth){for(;t<o.img.destHeight||e<o.img.destWidth;)this.zoomAction(-.0125,null,!0,!0),l=!0;l&&(this.zoomAction(-.0125,null,!0,!0),l=!1)}r.prevObj.activeObj=T.extend({},n,{},!0),this.zoomAction(.0125,null,!0),o.allowDownScale=!this.preventDownScale,o.isCropTab=!1,this.zoomAction(-.0125,null,!0),o.aspectWidth=e,o.aspectHeight=t},d.prototype.resizeImg=function(e,t,o){for(var i=this.parent,r=t/i.img.destWidth,n=o/i.img.destHeight,a=(e.shape?(i.currSelectionPoint=e,i.notify("crop",{prop:"setInitCrop",onPropertyChange:!1,value:{bool:!0}})):i.img.srcWidth===i.baseImgCanvas.width&&i.img.srcHeight===i.baseImgCanvas.height&&(i.currSelectionPoint=null,i.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}})),T.isNullOrUndefined(i.currSelectionPoint)?i.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:i.img.destLeft,startY:i.img.destTop,width:i.img.destWidth,height:i.img.destHeight}}):i.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),t=i.activeObj.activePoint.width*r,o=i.activeObj.activePoint.height*n,i.activeObj.activePoint.startX+i.activeObj.activePoint.width/2-t/2),s=i.activeObj.activePoint.startY+i.activeObj.activePoint.height/2-o/2,l=0;T.Browser.isDevice&&l<500&&(a<0||s<0||a+t>i.img.destWidth||s+o>i.img.destHeight);)l++,a=i.activeObj.activePoint.startX+i.activeObj.activePoint.width/2- --t/2,s=i.activeObj.activePoint.startY+i.activeObj.activePoint.height/2- --o/2;if(i.transform.defaultZoomFactor=0,i.notify("draw",{prop:"setResizeSelect",value:{bool:!0}}),i.notify("draw",{prop:"setIsCropSelect",value:{bool:!0}}),i.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:a,startY:s,width:t,height:o}}),i.notify("draw",{prop:"setResizeSelect",value:{bool:!1}}),0!==i.transform.straighten){var p={isIntersect:null,arr:null};for(i.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),i.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}});p.arr[0]||p.arr[1]||p.arr[2]||p.arr[3];)this.zoomAction(.0125,null,!0),i.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),i.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}})}i.isCropToolbar=!0,i.crop(),i.isCropToolbar=!1},d.prototype.updateResize=function(){var e=this.parent,t=(e.prevCropObj=T.extend({},e.cropObj,{},!0),{currObj:{}}),t=(e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:t}}),e.prevObj=t.currObj,e.currSelectionPoint&&e.prevCropObj.activeObj.shape&&(e.prevObj.activeObj=T.extend({},e.prevCropObj.activeObj,{},!0)),e.prevObj.objColl=T.extend([],e.objColl,[],!0),e.prevObj.pointColl=T.extend([],e.pointColl,[],!0),e.prevObj.afterCropActions=T.extend([],e.afterCropActions,[],!0),{selPointColl:null});e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:t}}),e.prevObj.selPointColl=T.extend([],t.selPointColl,[],!0),e.resizeSrc={startX:e.img.srcLeft,startY:e.img.srcTop,width:e.img.srcWidth,height:e.img.srcHeight}},d.prototype.resize=function(e,t,o){var i=this.parent,r=(i.isResize=!0,T.isNullOrUndefined(i.prevCropObj)&&T.isNullOrUndefined(i.prevObj)&&i.notify("transform",{prop:"updateResize",value:{bool:!1}}),i.element.querySelector("#"+i.element.id+"_aspectratio")),n=i.element.querySelector("#"+i.element.id+"_nonaspectratio"),r=(r&&n&&(i.notify("toolbar",{prop:"initResizeToolbar"}),T.Browser.isDevice)&&i.notify("toolbar",{prop:"init-main-toolbar",value:{isApplyBtn:!1,isDevice:!0,isOkBtn:!0,isResize:!0}}),i.element.querySelector("#"+i.element.id+"_resizeHeight")),n=r?""===r.value?r.placeholder:r.value:t+"px",r={cancel:!1,previousWidth:Math.ceil(i.img.destWidth),previousHeight:Math.ceil(i.img.destHeight),width:Math.ceil(e),height:t&&0!==t?Math.ceil(t):o?Math.ceil(parseFloat(n)):Math.ceil(i.img.destHeight),isAspectRatio:o||!1};i.trigger("resizing",r),(i.editCompleteArgs=r).cancel?i.aspectHeight&&i.aspectWidth&&(i.aspectHeight=r.previousHeight,i.aspectWidth=r.previousWidth):this.resizeEventHandler(r)},d.prototype.resizeEventHandler=function(e){var t,o,i,r,n,a=this.parent,s=a.element.querySelector("#"+a.element.id+"_resizeWidth"),l=a.element.querySelector("#"+a.element.id+"_resizeHeight");e.isAspectRatio?(null!=this.resizedImgAngle&&this.resizedImgAngle===a.transform.degree||(this.resizedImgAngle=a.transform.degree,t=!0),t?(a.notify("transform",{prop:"resizeImage",value:{width:e.width,height:0}}),o=a.img.destWidth,i=a.img.destHeight,l&&(n=.5<=(r=parseFloat(""===s.value?s.placeholder:s.value)/(o/i))%1||r%1<=-.5?Math.round(r):r<0?Math.ceil(r):Math.floor(r),T.getComponent(l,"numerictextbox").value=n,l.value=n.toString()+" px",a.aspectHeight=n,s)&&""===s.value&&(n=.5<=(r=parseFloat(""===l.value?l.placeholder:l.value)/(i/o))%1||r%1<=-.5?Math.round(r):r<0?Math.ceil(r):Math.floor(r),T.getComponent(s,"numerictextbox").value=n,s.value=n.toString()+" px",a.aspectWidth=n)):a.notify("transform",{prop:"resizeImage",value:{width:e.width,height:null}})):(null!==this.resizedImgAngle&&this.resizedImgAngle!==a.transform.degree&&(this.resizedImgAngle=a.transform.degree,t=!0),t?(a.notify("transform",{prop:"setPreventDownScale",value:{bool:!0}}),a.notify("transform",{prop:"resizeCrop",value:{width:e.width,height:e.height}}),a.notify("undo-redo",{prop:"setPreventUR",value:{bool:!0}}),a.okBtn(null,!0),a.notify("undo-redo",{prop:"setPreventUR",value:{bool:!1}}),a.resizeSrc={startX:a.img.srcLeft,startY:a.img.srcTop,width:a.img.srcWidth,height:a.img.srcHeight},a.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),a.notify("transform",{prop:"setPreventDownScale",value:{bool:!1}}),a.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})):a.notify("transform",{prop:"resizeCrop",value:{width:e.width,height:e.height}})),this.resizedImgAngle=a.transform.degree},d.prototype.straightenImage=function(e){var t=this.parent,o=t.activeObj.shape&&-1<t.activeObj.shape.indexOf("crop-");t.toolbar&&0===t.toolbar.length&&t.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),t.notify("toolbar",{prop:"performCropTransformClick",value:{shape:null}}),t.setStraighten(e),o||t.okBtn()};var W=d;function d(e){this.isReverseFlip=!1,this.disablePan=!1,this.isReverseRotate=!1,this.flipColl=[],this.prevZoomValue=1,this.cropDimension={width:0,height:0},this.isPreventSelect=!1,this.preventDownScale=!1,this.resizedImgAngle=null,this.parent=e,this.addEventListener()}u.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},u.prototype.addEventListener=function(){this.parent.on("undo-redo",this.undoRedo,this),this.parent.on("destroyed",this.destroy,this)},u.prototype.removeEventListener=function(){this.parent.off("undo-redo",this.undoRedo),this.parent.off("destroyed",this.destroy)},u.prototype.initializeUrPvtProp=function(){this.parent.lowerCanvas&&(this.lowerContext=this.parent.lowerCanvas.getContext("2d")),this.parent.upperCanvas&&(this.upperContext=this.parent.upperCanvas.getContext("2d"))},u.prototype.undoRedo=function(e){switch(this.initializeUrPvtProp(),e.prop){case"updateUndoRedoColl":this.updateUrc(e.value.operation,e.value.previousObj,e.value.previousObjColl,e.value.previousPointColl,e.value.previousSelPointColl,e.value.previousCropObj,e.value.previousText,e.value.currentText,e.value.previousFilter,e.value.isCircleCrop);break;case"refreshUrc":this.refreshUrc(e.value.bool);break;case"updateCurrUrc":this.updateCurrUrc(e.value.type,e.value.isCancel);break;case"call-undo":this.callUndo();break;case"call-redo":this.callRedo();break;case"undo":this.undo();break;case"redo":this.redo();break;case"updateUrObj":this.updateUrObj(e.value.objColl,e.value.operation);break;case"updateUndoRedo":this.updateUndoRedo(e.value?e.value.operation:null);break;case"getAppliedUndoRedoColl":e.value.obj.appliedUndoRedoColl=this.appliedUndoRedoColl;break;case"getUndoRedoStep":e.value.obj.undoRedoStep=this.undoRedoStep;break;case"setUndoRedoStep":this.undoRedoStep=e.value.step;break;case"undoDefault":this.undoDefault(e.value.obj);break;case"setPreventUR":this.isPreventing=e.value.bool;break;case"updateUndoRedoStack":e.value&&e.value.isPenDraw?this.updateUndoRedoStack(e.value.isPenDraw):this.updateUndoRedoStack();break;case"reset":this.reset()}},u.prototype.getModuleName=function(){return"undo-redo"},u.prototype.reset=function(){this.tempCurrSelPoint=null,this.undoRedoStep=0,this.undoRedoColl=[],this.appliedUndoRedoColl=[],this.tempActObj=null,this.tempUndoRedoColl=[],this.tempUndoRedoStep=0,this.isPreventing=!1},u.prototype.refreshUrc=function(e){var t=this.parent;t.isImageUpdated||((e=e||!1)&&(t.notify("toolbar",{prop:"setEnableDisableUndoRedo",value:{isPrevent:!0}}),this.tempUndoRedoColl=T.extend([],this.appliedUndoRedoColl,[],!0),this.tempUndoRedoStep=this.undoRedoStep),t.notify("toolbar",{prop:"setEnableDisableUndoRedo",value:{isPrevent:!1}}),this.undoRedoColl=this.undoRedoColl.slice(0,this.undoRedoStep),this.appliedUndoRedoColl=this.appliedUndoRedoColl.slice(0,this.undoRedoStep),t.isUndoRedo=t.currObjType.isUndoAction=!1,t.notify("toolbar",{prop:"enable-disable-btns"}))},u.prototype.updateCurrUrc=function(e,t){var o=this.parent;if(!(o.isResize||this.isPreventing||o.noPushUndo)){o.notify("toolbar",{prop:"setEnableDisableUndoRedo",value:{isPrevent:!1}}),"ok"===e?(o.notify("draw",{prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!1}}),a=0<this.tempUndoRedoColl.length?T.extend([],this.tempUndoRedoColl,[],!0):T.extend([],this.undoRedoColl,[],!0),i=this.undoRedoColl[this.undoRedoColl.length-1],r=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1],n=i?T.extend({},i.previousObj,{},!0):null,T.isNullOrUndefined(r)?this.undoRedoColl[0]&&(i.previousCropObj=a[0].previousCropObj,i.previousObj=a[0].previousObj,i.previousObjColl=a[0].previousObjColl,i.previousPointColl=a[0].previousPointColl,i.previousText=a[0].previousText):"imageHFlip"!==i.operation&&"imageVFlip"!==i.operation&&(i.previousCropObj=r.currentCropObj,i.previousObj=r.currentObj,i.previousObjColl=r.currentObjColl,i.previousPointColl=r.currentPointColl,i.previousText=r.currentText,"frame"===i.operation)&&i.previousObj&&n&&(i.previousObj.defaultZoom=n.defaultZoom,i.previousObj.zoomFactor=n.zoomFactor,i.previousObj.cropZoom=n.cropZoom),i&&("imageHFlip"!==i.operation&&"imageVFlip"!==i.operation&&(a=this.getZeroZoomObjPointValue(i.currentObjColl,i.currentPointColl),i.currentObjColl=a.obj,i.currentPointColl=a.point,o.notify("filter",{prop:"getAdjustmentLevel",onPropertyChange:!(r={adjustmentLevel:null}),value:{obj:r}}),i.currentObj.adjustmentLevel=T.extend({},r.adjustmentLevel,{},!0),o.notify("filter",{prop:"setTempAdjVal"}),i.currentObj.currentFilter=o.currentFilter),this.appliedUndoRedoColl.push(i),t||this.triggerActionCompletedEvent(i.operation)),this.tempUndoRedoColl=[],this.tempUndoRedoStep=0):0<this.tempUndoRedoColl.length&&(this.appliedUndoRedoColl=T.extend([],this.tempUndoRedoColl,[],!0),this.undoRedoStep=this.tempUndoRedoStep,this.tempUndoRedoColl=[],this.tempUndoRedoStep=0);var i,r,n=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1],a=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-2];if(16<this.appliedUndoRedoColl.length)this.appliedUndoRedoColl.splice(0,1);else if(!t&&n&&a)if(("shapeTransform"===n.operation&&"shapeTransform"===a.operation||"shapeInsert"===n.operation&&"shapeInsert"===a.operation)&&JSON.stringify(n.currentObjColl)===JSON.stringify(a.currentObjColl)||"freehand-draw"===n.operation&&"freehand-draw"===a.operation&&JSON.stringify(n.currentPointColl)===JSON.stringify(a.currentPointColl)||"freehanddrawCustomized"===n.operation&&"freehanddrawCustomized"===a.operation&&JSON.stringify(n.currentPointColl)===JSON.stringify(a.currentPointColl))this.appliedUndoRedoColl.splice(this.appliedUndoRedoColl.length-1,1);else if(this.undoRedoStep!==this.appliedUndoRedoColl.length-1&&(n=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1],a=this.appliedUndoRedoColl[this.undoRedoStep],n)&&a&&"shapeTransform"===n.operation&&"shapeTransform"===a.operation&&JSON.stringify(n.currentObjColl)===JSON.stringify(a.previousObjColl))return this.appliedUndoRedoColl.splice(this.appliedUndoRedoColl.length-1,1),this.undoRedoColl=[],void(this.undoRedoColl=T.extend([],this.appliedUndoRedoColl,[],!0));this.undoRedoColl=[],this.undoRedoColl=T.extend([],this.appliedUndoRedoColl,[],!0),"ok"===e&&(this.undoRedoStep=this.undoRedoColl.length,o.notify("toolbar",{prop:"enable-disable-btns"})),0<o.transform.zoomFactor&&(o.togglePan=!0,o.notify("selection",{prop:"setDragCanvas",value:{bool:!0}}))}},u.prototype.triggerActionCompletedEvent=function(e){var t=this.parent,e={action:{brightness:"fine-tune",contrast:"fine-tune",hue:"fine-tune",saturation:"fine-tune",opacity:"fine-tune",blur:"fine-tune",exposure:"fine-tune",default:"filter",chrome:"filter",cold:"filter",warm:"filter",grayscale:"filter",sepia:"filter",invert:"filter",deleteObj:"shape-delete",deleteFreehandDrawing:"freehand-draw-delete",shapeInsert:"shape-insert",shapeTransform:"shape-customize",freehanddrawCustomized:"freehand-draw-customize"}[e]||e,actionEventArgs:t.editCompleteArgs};t.triggerEditCompleteEvent(e)},u.prototype.getUndoRedoAction=function(e){return{brightness:"fine-tune",contrast:"fine-tune",hue:"fine-tune",saturation:"fine-tune",opacity:"fine-tune",blur:"fine-tune",exposure:"fine-tune",default:"filter",chrome:"filter",cold:"filter",warm:"filter",grayscale:"filter",sepia:"filter",invert:"filter",deleteObj:"shape-delete",deleteFreehandDrawing:"freehand-drawing-delete",shapeInsert:"shape-insert",shapeTransform:"shape-customize",imageRotate:"shape-customize",freehanddraw:"freehand-draw",freehanddrawCustomized:"freehand-draw-customize",textAreaCustomization:"text-area-customization",imageHFlip:"shape-customize",imageVFlip:"shape-customize",bgColor:"background-color",updateImage:"image-update"}[e]||e},u.prototype.cancelCropSelection=function(){var e,t=this.parent,o=!1;t.activeObj.shape&&(e=t.activeObj.shape.split("-")),(o=t.currObjType.isCustomCrop||e&&"crop"===e[0]?!0:o)&&t.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}),0===this.tempUndoRedoColl.length&&0===this.tempUndoRedoStep||(this.appliedUndoRedoColl=T.extend([],this.tempUndoRedoColl,[],!0),this.undoRedoColl=T.extend([],this.tempUndoRedoColl,[],!0),this.undoRedoStep=this.tempUndoRedoStep,this.tempUndoRedoColl=[],this.tempUndoRedoStep=0,t.notify("toolbar",{prop:"setEnableDisableUndoRedo",value:{isPrevent:!1}}))},u.prototype.refreshToolbarActions=function(){var e=this.parent;e.activeObj.shape?(e.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),e.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1})):e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})},u.prototype.applyCurrentChanges=function(){var e=this.parent;e.currObjType.isFiltered=!1,0===e.transform.zoomFactor&&(e.togglePan=!1,e.notify("selection",{prop:"setDragCanvas",value:{bool:!1}})),e.element.querySelector(".e-contextual-toolbar-wrapper")&&e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),e.togglePen&&(e.togglePen=!1,e.upperCanvas.style.cursor=e.cursor="default",this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height)),0<this.appliedUndoRedoColl.length&&(this.undoRedoColl=T.extend([],this.appliedUndoRedoColl,[],!0))},u.prototype.callUndo=function(){this.applyCurrentChanges(),this.undo()},u.prototype.callRedo=function(){this.applyCurrentChanges(),this.redo()},u.prototype.undo=function(){var e=this.parent;if(this.cancelCropSelection(),e.notify("draw",{prop:"resetFrameZoom",onPropertyChange:!1,value:{isOk:!1}}),!e.disabled&&e.isImageLoaded&&0<this.undoRedoStep){this.refreshToolbarActions(),e.activeObj.activePoint&&0!==e.activeObj.activePoint.width&&(this.tempActObj=e.activeObj),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.undoRedoStep--,e.notify("toolbar",{prop:"enable-disable-btns"}),e.element.querySelector(".e-contextual-toolbar-wrapper")&&e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),e.isUndoRedo=!0;var t,o=this.undoRedoColl[this.undoRedoStep],i=(this.undoRedoColl.length===this.undoRedoStep?e.currObjType.isUndoAction=!1:e.currObjType.isUndoAction=!0,"textAreaCustomization"===o.operation||"block"!==e.textArea.style.display&&"inline-block"!==e.textArea.style.display||(e.textArea.style.display="none"),e.notify("draw",{prop:"setCancelAction",onPropertyChange:!1,value:{bool:!0}}),e.cropObj=T.extend({},o.previousCropObj,{},!0),e.afterCropActions=o.previousObj.afterCropActions,this.lowerContext.filter=o.previousObj.filter,e.notify("filter",{prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:o.previousObj.adjustmentLevel}}),e.notify("filter",{prop:"setTempAdjVal"}),e.currentFilter=o.previousObj.currentFilter,e.notify("filter",{prop:"setTempFilVal"}),e.canvasFilter=this.lowerContext.filter,e.initialAdjustmentValue=this.lowerContext.filter,e.notify("filter",{prop:"setBevelFilter",onPropertyChange:!1,value:{bevelFilter:this.lowerContext.filter}}),{action:this.getUndoRedoAction(o.operation)});switch(o.operation){case"shapeTransform":case"brightness":case"contrast":case"hue":case"saturation":case"opacity":case"blur":case"exposure":case"default":case"chrome":case"cold":case"warm":case"grayscale":case"blackandwhite":case"sepia":case"invert":case"sharpen":case"imageRotate":case"shapeInsert":this.shapeTransform(o.previousObjColl,o.previousPointColl);break;case"freehanddraw":case"freehand-draw":this.updateFreehandDraw(o.previousPointColl,o.previousSelPointColl),e.notify("freehand-draw",{prop:"setCurrentFreehandDrawIndex",value:{value:e.pointColl.length}});break;case"freehanddrawCustomized":this.updateFreehandDrawCustomized(o.previousObjColl,o.previousPointColl);break;case"deleteFreehandDrawing":case"deleteObj":this.updateDelete(o.operation,o.previousObjColl,o.previousPointColl,o.previousSelPointColl);break;case"textAreaCustomization":this.shapeTransform(o.previousObjColl,o.previousPointColl),this.updateTextAreaCustomization(void 0,o.previousObjColl);break;case"text":this.updateText(o.previousObjColl,!0);break;case"frame":e.transform.zoomFactor=e.transform.defaultZoomFactor=o.previousObj.defaultZoom,e.setProperties({zoomSettings:{zoomFactor:o.previousObj.zoomFactor}},!0),e.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:e.zoomSettings.zoomFactor}}),T.extend(e.frameObj,o.previousObj.frameObj),e.notify("draw",{prop:"render-image",value:{isMouseWheel:!0,isPreventClearRect:null,isFrame:!0}});break;case"imageHFlip":this.imageFlip("horizontal",o.previousObjColl);break;case"imageVFlip":this.imageFlip("vertical",o.previousObjColl);break;case"bgColor":e.notify("draw",{prop:"imageBackgroundColor",onPropertyChange:!1,value:{color:o.previousObj.bgColor}}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}});break;case"updateImage":e.isImageUpdated=!0,e.baseImg.src=o.previousObj.imageSource,setTimeout(function(){0!==e.cropObj.straighten?(e.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-custom"}}),e.noPushUndo=!0,e.crop(),e.noPushUndo=!1):e.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),e.isImageUpdated=!1});break;default:this.undoDefault(o,!0),e.notify("filter",{prop:"set-adjustment",value:{operation:o.operation}}),e.notify("filter",{prop:"update-filter",value:{operation:o.operation,filter:o.filter}})}"crop"===o.operation?(o.previousObj.currSelectionPoint&&(e.currSelectionPoint=T.extend({},o.previousObj.currSelectionPoint,{},!0),e.currSelectionPoint)&&T.isNullOrUndefined(e.currSelectionPoint.shape)&&(e.currSelectionPoint=null),e.updateCropTransformItems(),e.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),e.isCircleCrop&&(e.isCircleCrop=!1,this.tempCurrSelPoint=T.extend({},e.currSelectionPoint,{},!0),e.currSelectionPoint=null),t=e.cancelCropSelection.isCircleCrop,e.cancelCropSelection.isCircleCrop=!1,e.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null,isUndoRedo:!0}}),e.cancelCropSelection.isCircleCrop=t,e.currObjType.isActiveObj=!1,0!==e.transform.straighten&&e.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}})):"resize"===o.operation&&e.cropObj&&e.cropObj.activeObj&&(e.currSelectionPoint=T.extend({},e.cropObj.activeObj,{},!0)),this.undoRedoColl[this.undoRedoStep-1]&&this.undoRedoColl[this.undoRedoStep-1].isCircleCrop&&(e.isCircleCrop=!0,e.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})),this.endUndoRedo(o.operation,!0),e.triggerEditCompleteEvent({action:"undo",actionEventArgs:i})}},u.prototype.redo=function(){var e=this.parent;if(this.cancelCropSelection(),e.notify("draw",{prop:"resetFrameZoom",onPropertyChange:!1,value:{isOk:!1}}),!e.disabled&&e.isImageLoaded&&this.undoRedoStep<this.appliedUndoRedoColl.length){this.refreshToolbarActions(),this.undoRedoStep++,e.notify("toolbar",{prop:"enable-disable-btns"}),e.isUndoRedo=!0;var t,o=this.undoRedoColl[this.undoRedoStep-1],i=(this.undoRedoColl.length===this.undoRedoStep?e.currObjType.isUndoAction=!1:e.currObjType.isUndoAction=!0,"textAreaCustomization"===o.operation||"block"!==e.textArea.style.display&&"inline-block"!==e.textArea.style.display||(e.textArea.style.display="none"),e.notify("draw",{prop:"setCancelAction",onPropertyChange:!1,value:{bool:!0}}),e.cropObj=T.extend({},o.currentCropObj,{},!0),e.afterCropActions=o.currentObj.afterCropActions,this.lowerContext.filter=o.currentObj.filter,e.element.querySelector(".e-contextual-toolbar-wrapper")&&e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),e.notify("filter",{prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:o.currentObj.adjustmentLevel}}),e.notify("filter",{prop:"setTempAdjVal"}),e.currentFilter=o.currentObj.currentFilter,e.notify("filter",{prop:"setTempFilVal"}),e.canvasFilter=this.lowerContext.filter,e.initialAdjustmentValue=this.lowerContext.filter,e.notify("filter",{prop:"setBevelFilter",onPropertyChange:!1,value:{bevelFilter:this.lowerContext.filter}}),{action:this.getUndoRedoAction(o.operation)});switch(o.operation){case"shapeTransform":case"brightness":case"contrast":case"hue":case"saturation":case"opacity":case"blur":case"exposure":case"default":case"chrome":case"cold":case"warm":case"grayscale":case"blackandwhite":case"sepia":case"invert":case"sharpen":case"imageRotate":case"shapeInsert":this.shapeTransform(o.currentObjColl,o.currentPointColl);break;case"freehanddraw":case"freehand-draw":this.updateFreehandDraw(o.currentPointColl,o.currentSelPointColl),e.notify("freehand-draw",{prop:"setCurrentFreehandDrawIndex",value:{value:e.pointColl.length}});break;case"freehanddrawCustomized":this.updateFreehandDrawCustomized(o.currentObjColl,o.currentPointColl);break;case"deleteFreehandDrawing":case"deleteObj":this.updateDelete(o.operation,o.currentObjColl,o.currentPointColl,o.currentSelPointColl);break;case"textAreaCustomization":this.shapeTransform(o.currentObjColl,o.currentPointColl),this.updateTextAreaCustomization(void 0,o.currentObjColl);break;case"text":this.updateText(o.currentObjColl,!1);break;case"frame":T.extend(e.frameObj,o.currentObj.frameObj),e.notify("draw",{prop:"render-image",value:{isMouseWheel:!0,isPreventClearRect:null,isFrame:!0}});break;case"imageHFlip":this.imageFlip("horizontal",o.currentObjColl);break;case"imageVFlip":this.imageFlip("vertical",o.currentObjColl);break;case"bgColor":e.notify("draw",{prop:"imageBackgroundColor",onPropertyChange:!1,value:{color:o.currentObj.bgColor}}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}});break;case"updateImage":e.isImageUpdated=!0,e.baseImg.src=o.currentObj.imageSource,setTimeout(function(){0!==e.cropObj.straighten?(e.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-custom"}}),e.noPushUndo=!0,e.crop(),e.noPushUndo=!1):e.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),e.isImageUpdated=!1});break;default:e.objColl=[],e.pointColl=[],e.freehandCounter=0,e.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),e.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:o.currentObj,isUndoRedo:!0}}),e.img.destLeft=o.currentObj.destPoints.startX,e.img.destTop=o.currentObj.destPoints.startY,t=T.extend({},e.activeObj,{},!0),e.objColl=T.extend([],o.currentObjColl,[],!0),e.pointColl=T.extend([],o.currentPointColl,[],!0),e.freehandCounter=e.pointColl.length,e.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:T.extend([],o.currentSelPointColl,[],!0)}}}),e.transform.straighten=0,this.lowerContext.filter="none",e.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=o.currentObj.filter,e.prevStraightenedDegree=e.transform.straighten,e.activeObj=t,this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),0!==e.activeObj.activePoint.width&&0!==e.activeObj.activePoint.height&&e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),e.notify("filter",{prop:"set-adjustment",value:{operation:o.operation}}),e.notify("filter",{prop:"update-filter",value:{operation:o.operation}})}"crop"===o.operation&&o.isCircleCrop&&(e.isCircleCrop=!0,e.currSelectionPoint=T.extend({},this.tempCurrSelPoint,{},!0),this.tempCurrSelPoint=null),"crop"!==o.operation||o.isCircleCrop||(e.isCircleCrop=!1),"crop"===o.operation&&o.currentObj.currSelectionPoint&&(e.currSelectionPoint=T.extend({},o.currentObj.currSelectionPoint,{},!0),e.notify("draw",{prop:"setStraightenActObj",value:{activeObj:e.currSelectionPoint}})),e.currSelectionPoint&&T.isNullOrUndefined(e.currSelectionPoint.shape)&&(e.currSelectionPoint=null),"resize"===o.operation&&e.cropObj&&e.cropObj.activeObj&&(e.currSelectionPoint=T.extend({},e.cropObj.activeObj,{},!0)),this.endUndoRedo(o.operation,!1),e.triggerEditCompleteEvent({action:"redo",actionEventArgs:i})}},u.prototype.imageFlip=function(e,t){var o=this.parent,t=(this.shapeTransform(t,null),o.activeObj=T.extend({},o.objColl[o.objColl.length-1],{},!0),o.activeObj),i=t.shape,r=t.isHorImageFlip,t=t.isVerImageFlip;o.objColl.pop(),i&&"image"===i?("horizontal"===e?(T.isNullOrUndefined(r)&&t?(o.activeObj.isHorImageFlip=!0,o.activeObj.isVerImageFlip=null):T.isNullOrUndefined(r)||!r?o.activeObj.isHorImageFlip=!0:o.activeObj.isHorImageFlip=null,o.horizontalFlip(this.upperContext,!0)):"vertical"===e&&(T.isNullOrUndefined(t)&&r?(o.activeObj.isVerImageFlip=!0,o.activeObj.isHorImageFlip=null):T.isNullOrUndefined(t)||!t?o.activeObj.isVerImageFlip=!0:o.activeObj.isVerImageFlip=null,o.verticalFlip(this.upperContext,!0)),o.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}})):o.notify("draw",{prop:"render-image",value:{isMouseWheel:!0}})},u.prototype.shapeTransform=function(e,t){var o=this.parent;o.objColl=T.extend([],e,[],!0),t&&(o.pointColl=T.extend([],t,[],!0),o.freehandCounter=o.pointColl.length),o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.isUndoRedo=!0,o.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1})},u.prototype.updateFreehandDraw=function(e,t){var o=this.parent;o.pointColl=e,o.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:t}}}),o.freehandCounter=o.pointColl.length,o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.isUndoRedo=!0,o.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1})},u.prototype.updateFreehandDrawCustomized=function(e,t){var o=this.parent;o.objColl=T.extend([],e,[],!0),o.pointColl=t,o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.isUndoRedo=!0,o.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1})},u.prototype.updateDelete=function(e,t,o,i){var r=this.parent;"deleteFreehandDrawing"===e?(r.pointColl=o,r.freehandCounter=r.pointColl.length,r.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:i}}}),r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}})):"deleteObj"===e&&(r.objColl=t,r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}})),this.lowerContext.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height),this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.isUndoRedo=!0,r.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1})},u.prototype.updateTextAreaCustomization=function(e,t){var o=this.parent;o.objColl=T.extend([],t,[],!0),o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),o.isUndoRedo=!0,o.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1});for(var i=0,r=t.length;i<r;i++){if(!this.tempActObj){e=T.extend({},t[t.length-1],{},!0),o.objColl.splice(i,1);break}if(this.tempActObj.currIndex===t[i].currIndex){e=T.extend({},t[i],{},!0),o.objColl.splice(i,1);break}}e&&this.updateTextBox(e),"block"!==o.textArea.style.display&&"inline-block"!==o.textArea.style.display||o.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}})},u.prototype.updateText=function(e,t){var o=this.parent;if(this.tempActObj&&(o.activeObj=T.extend({},this.tempActObj,{},!0)),0===e.length&&1===o.objColl.length)this.tempActObj=T.extend({},o.objColl[0],{},!0);else for(var i=0,r=o.objColl.length;i<r;i++){if(o.objColl[i]&&T.isNullOrUndefined(e[i])){this.tempActObj=T.extend({},o.objColl[i],{},!0);break}if(e[i].currIndex!==o.objColl[i].currIndex){this.tempActObj=T.extend({},o.objColl[i],{},!0);break}}t&&(o.activeObj=T.extend({},this.tempActObj,{},!0)),o.objColl=T.extend([],e,[],!0),o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:!0}}),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),o.isUndoRedo=!0,o.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1})},u.prototype.updateTextBox=function(e){var t=this.parent,o=(this.upperContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),t.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),t.textArea);o.style.display="block",o.style.fontFamily=e.textSettings.fontFamily,o.style.fontSize=e.textSettings.fontSize+"px",o.style.color=e.strokeSettings.strokeColor,o.style.fontWeight=e.textSettings.bold?"bold":"normal",o.style.fontStyle=e.textSettings.italic?"italic":"normal",o.style.border="2px solid "+t.themeColl[t.theme].primaryColor,o.value=e.keyHistory,t.activeObj=T.extend({},e,{},!0),t.notify("shape",{prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}}),t.textArea.style.width=t.activeObj.activePoint.width+"px"},u.prototype.undoDefault=function(e,t){this.lowerContext.filter=e.previousObj.filter;var o=this.parent,i=(o.objColl=[],o.pointColl=[],o.freehandCounter=0,o.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),!t&&e.isCircleCrop),t=(o.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:e.previousObj,isUndoRedo:t,isCircleCrop:i}}),o.prevStraightenedDegree=o.transform.straighten,this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),o.img.destLeft=e.previousObj.destPoints.startX,o.img.destTop=e.previousObj.destPoints.startY,T.extend({},o.activeObj,{},!0));o.objColl=T.extend([],e.previousObjColl,[],!0),o.pointColl=T.extend([],e.previousPointColl,[],!0),o.freehandCounter=o.pointColl.length,o.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:T.extend([],e.previousSelPointColl,[],!0)}}}),o.transform.straighten=0,this.lowerContext.filter="none",o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=e.previousObj.filter,o.activeObj=t,this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),0!==o.activeObj.activePoint.width&&0!==o.activeObj.activePoint.height&&o.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}})},u.prototype.endUndoRedo=function(e,t){var o=this.parent;(o.currSelectionPoint&&"crop-circle"===o.currSelectionPoint.shape||o.isCircleCrop)&&JSON.stringify(o.frameObj)!==JSON.stringify({type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""})&&o.notify("draw",{prop:"render-image",value:{isMouseWheel:!0}}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.isCircleCrop&&(t&&"crop"!==e||!t)&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),0<o.transform.zoomFactor&&o.notify("selection",{prop:"setDragCanvas",value:{bool:!0}}),o.notify("draw",{prop:"setCancelAction",onPropertyChange:!1,value:{bool:!1}}),o.activeObj.shape&&"crop"===o.activeObj.shape.split("-")[0]?o.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!0,isCropping:!0,isZooming:null,cType:null}}):o.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),o.notify("toolbar",{prop:"enable-disable-btns"}),document.getElementById(o.element.id+"_quickAccessToolbarArea")&&(document.getElementById(o.element.id+"_quickAccessToolbarArea").style.display="none"),o.notify("toolbar",{prop:"enable-disable-btns"}),0!==o.transform.degree&&o.notify("transform",{prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:0,yDiff:0}}),o.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),o.currObjType.isCustomCrop=!1},u.prototype.updateUrc=function(e,t,o,i,r,n,a,s,l,p){var h=this.parent;if(!h.isResize&&!this.isPreventing){var d={isInitialLoaded:!1};if(h.currObjType.isUndoAction&&this.refreshUrc(!0),h.notify("draw",{prop:"isInitialLoaded",onPropertyChange:!1,value:{object:d}}),!d.isInitialLoaded&&h.allowUndoRedo){var d={currObj:{}},d=(h.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:d}}),d.currObj),c=(d.objColl=T.extend([],h.objColl,[],!0),d.pointColl=T.extend([],h.pointColl,[],!0),d.afterCropActions=T.extend([],h.afterCropActions,[],!0),{selPointColl:null});if(h.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:c}}),d.selPointColl=T.extend([],c.selPointColl,[],!0),"crop"===e)d.currSelectionPoint=T.extend({},h.currSelectionPoint,{},!0);else if("frame"===e)t.destPoints={startX:h.frameDestPoints.destLeft,startY:h.frameDestPoints.destTop,width:h.frameDestPoints.destWidth,height:h.frameDestPoints.destHeight},d.destPoints={startX:h.frameDestPoints.destLeft,startY:h.frameDestPoints.destTop,width:h.frameDestPoints.destWidth,height:h.frameDestPoints.destHeight},T.isNullOrUndefined(h.tempFrameZoomLevel)||(t.defaultZoom=d.defaultZoom=h.tempFrameZoomLevel);else if(("imageHFlip"===e||"imageVFlip"===e)&&0<this.appliedUndoRedoColl.length){var u=o[o.length-1].currIndex;if(o=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1].currentObjColl,u)for(var g=0,v=o.length;g<v;g++)if(o[g].currIndex===u){var f=T.extend({},o[g],{},!0);o.splice(g,1),o.push(f);break}}this.undoRedoColl.push({operation:e,previousObj:t,currentObj:d,previousObjColl:o,currentObjColl:d.objColl,previousPointColl:i,currentPointColl:d.pointColl,previousSelPointColl:r,currentSelPointColl:d.selPointColl,previousCropObj:n,currentCropObj:T.extend({},h.cropObj,{},!0),previousText:a,currentText:s,filter:l,isCircleCrop:p}),h.notify("toolbar",{prop:"enable-disable-btns",onPropertyChange:!1})}}},u.prototype.updateUrObj=function(e,t){var o,i,r,n=this.parent;n.allowUndoRedo&&(n.currObjType.isUndoAction&&!n.isShapeDrawing&&this.refreshUrc(!0),T.isNullOrUndefined(n.activeObj.imageRatio)&&n.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),n.objColl.push(n.activeObj),o=T.extend({},n.cropObj,{},!0),n.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(i={currObj:{}}),value:{object:i}}),(i=i.currObj).objColl=T.extend([],n.objColl,[],!0),i.pointColl=T.extend([],n.pointColl,[],!0),i.afterCropActions=T.extend([],n.afterCropActions,[],!0),n.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(r={selPointColl:null}),value:{obj:r}}),i.selPointColl=T.extend([],r.selPointColl,[],!0),this.undoRedoColl.push({operation:t||"shapeTransform",previousObj:i,currentObj:i,previousObjColl:e,currentObjColl:i.objColl,previousPointColl:i.pointColl,currentPointColl:i.pointColl,previousSelPointColl:i.selPointColl,currentSelPointColl:i.selPointColl,previousCropObj:o,currentCropObj:o}),n.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:n.objColl[n.objColl.length-1]}}))},u.prototype.updateUndoRedo=function(e){var t=this.parent,o=T.extend({},t.cropObj,{},!0),i={currObj:{}},i=(t.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}}),i.currObj),r=(i.objColl=T.extend([],t.objColl,[],!0),i.pointColl=T.extend([],t.pointColl,[],!0),i.afterCropActions=T.extend([],t.afterCropActions,[],!0),{selPointColl:null});t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),i.selPointColl=T.extend([],r.selPointColl,[],!0),T.isNullOrUndefined(t.activeObj.imageRatio)&&t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl.push(t.activeObj),this.updateUrc(e||"shapeTransform",i,i.objColl,i.pointColl,i.selPointColl,o),t.objColl.pop(),t.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})},u.prototype.getZeroZoomObjPointValue=function(e,t){var o=this.parent,i=(this.updateObjColl(),{currObj:{}}),i=(o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}}),i.currObj),r=(i.objColl=T.extend([],o.objColl,[],!0),i.pointColl=T.extend([],o.pointColl,[],!0),i.afterCropActions=T.extend([],o.afterCropActions,[],!0),{selPointColl:null}),r=(o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),i.selPointColl=T.extend([],r.selPointColl,[],!0),{cropDimension:null}),n=(o.notify("transform",{prop:"getCropDimension",onPropertyChange:!1,value:{obj:r}}),T.extend([],o.objColl,[],!0)),a=T.extend([],o.pointColl,[],!0),s={arrowDimension:null},s=(this.parent.notify("draw",{prop:"getArrowDimension",onPropertyChange:!1,value:{obj:s}}),T.extend({},s.arrowDimension,{},!0));if(0<o.transform.zoomFactor&&(0<e.length||0<t.length)){if(0<e.length)for(var l=0;l<e.length;l++)e[l].currIndex||(e[l].currIndex="shape_"+(l+1));o.objColl=e,o.pointColl=t;var p,t=o.isUndoRedo,h=o.isCropTab;0!==o.transform.zoomFactor&&(o.isUndoRedo=!0,o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:!0}}),o.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),o.isCropTab=!0,p=T.extend({},o.zoomSettings,null,!0),0<o.transform.zoomFactor?o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-o.transform.zoomFactor,zoomPoint:null,isResize:null}}):o.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:Math.abs(o.transform.zoomFactor),zoomPoint:null,isResize:null}}),o.zoomSettings=p,o.isCropTab=h,o.isUndoRedo=t,n=T.extend([],o.objColl,[],!0),a=T.extend([],o.pointColl,[],!0),o.objColl=[],o.pointColl=[],o.freehandCounter=0,o.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),o.notify("transform",{prop:"setCropDimension",onPropertyChange:!1,value:{width:r.cropDimension.width,height:r.cropDimension.height}}),(p={width:r.cropDimension.width,height:r.cropDimension.height}).width+=p.width*i.defaultZoom,p.height+=p.height*i.defaultZoom,o.notify("draw",{prop:"setZoomCropWidth",value:{width:p.width,height:p.height}}),o.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:i}}),o.img.destLeft=i.destPoints.startX,o.img.destTop=i.destPoints.startY,o.panPoint.totalPannedPoint=i.totalPannedPoint,o.panPoint.totalPannedClientPoint=i.totalPannedClientPoint,o.panPoint.totalPannedInternalPoint=i.totalPannedInternalPoint,o.objColl=T.extend([],i.objColl,[],!0),o.pointColl=T.extend([],i.pointColl,[],!0),o.freehandCounter=o.pointColl.length,o.notify("draw",{prop:"setArrowDimension",onPropertyChange:!1,value:{arrowDimension:s}}),o.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:T.extend([],i.selPointColl,[],!0)}}}),this.lowerContext.filter="none",o.transform.straighten=0,this.applyImgTranform(),o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),o.notify("freehand-draw",{prop:"updateFHDCurPts",onPropertyChange:!1}),this.lowerContext.filter=i.filter,0!==o.transform.degree&&o.notify("transform",{prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:0,yDiff:0}}),o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),o.isCircleCrop||o.currSelectionPoint&&"crop-circle"===o.currSelectionPoint.shape)&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})}return{obj:n,point:a}},u.prototype.updateObjColl=function(){for(var e=this.parent,t=0;t<e.objColl.length;t++){var o=e.objColl[t],i=!1;"line"!==o.shape&&"arrow"!==o.shape||(o.activePoint.width<0&&(o.activePoint.width=Math.abs(o.activePoint.width),i=!0),o.activePoint.height<0&&(o.activePoint.height=Math.abs(o.activePoint.height),i=!0),i&&(i=T.extend({},e.activeObj,{},!0),e.activeObj=o,e.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),o=e.activeObj,e.activeObj=i))}},u.prototype.applyImgTranform=function(){for(var e,t=this.parent,o=T.extend({},t.activeObj,{},!0),i=0,r=t.objColl.length;i<r;i++)"image"===t.objColl[i].shape&&(t.activeObj=T.extend({},t.objColl[i],{},!0),e=t.objColl[i].imageCanvas.getContext("2d"),t.notify("selection",{prop:"applyTransformToImg",onPropertyChange:!1,value:{ctx:e}}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("selection",{prop:"setImageClarity",onPropertyChange:!1,value:{bool:!0}}));t.activeObj=o},u.prototype.updateUndoRedoStack=function(e){var t,o,i,r=this.parent;(r.activeObj.currIndex&&0!==r.activeObj.activePoint.width||0!==r.activeObj.activePoint.height||r.activeObj.pointColl&&0<r.activeObj.pointColl.length||e)&&(t="none"!==r.textArea.style.display,o=r.noPushUndo,r.noPushUndo=!1,r.isUndoRedoStack=!0,e?(e=r.togglePen,r.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!(i={freehandDrawSelectedId:null}),value:{obj:i}}),r.okBtn(),r.noPushUndo=o,i.freehandDrawSelectedId?(r.noRedact=!0,r.selectShape(i.freehandDrawSelectedId)):r.freeHandDraw(!0),r.togglePen=e):r.activeObj.currIndex&&(i=r.activeObj.currIndex,r.okBtn(),r.noPushUndo=o,r.noRedact=!0,r.selectShape(i),r.drawingShape&&r.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:r.drawingShape.toLowerCase()}}),t)&&r.enableTextEditing(),r.isUndoRedoStack=!1)};var U=u;function u(e){this.undoRedoStep=0,this.undoRedoColl=[],this.appliedUndoRedoColl=[],this.tempUndoRedoColl=[],this.tempUndoRedoStep=0,this.isPreventing=!1,this.parent=e,this.addEventListener()}C=function(e,t){return(C=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])}))(e,t)};var C,b,y=function(e,t){function o(){this.constructor=e}C(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)},P=function(e,t,o,i){var r,n=arguments.length,a=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,i);else for(var s=e.length-1;0<=s;s--)(r=e[s])&&(a=(n<3?r(a):3<n?r(t,o,a):r(t,o))||a);return 3<n&&a&&Object.defineProperty(t,o,a),a},_=(b=T.ChildProperty,y(j,b),P([T.Property(null)],j.prototype,"allowedExtensions",void 0),P([T.Property(null)],j.prototype,"minFileSize",void 0),P([T.Property(null)],j.prototype,"maxFileSize",void 0),j);function j(){return null!==b&&b.apply(this,arguments)||this}x=T.ChildProperty,y(w,x),P([T.Property(null)],w.prototype,"brightness",void 0),P([T.Property(null)],w.prototype,"contrast",void 0),P([T.Property(null)],w.prototype,"hue",void 0),P([T.Property(null)],w.prototype,"saturation",void 0),P([T.Property(null)],w.prototype,"exposure",void 0),P([T.Property(null)],w.prototype,"opacity",void 0),P([T.Property(null)],w.prototype,"blur",void 0);var x,N=w;function w(){return null!==x&&x.apply(this,arguments)||this}O=T.ChildProperty,y(S,O),P([T.Property(null)],S.prototype,"zoomTrigger",void 0),P([T.Property(1)],S.prototype,"minZoomFactor",void 0),P([T.Property(10)],S.prototype,"maxZoomFactor",void 0),P([T.Property(1)],S.prototype,"zoomFactor",void 0),P([T.Property(null)],S.prototype,"zoomPoint",void 0);var O,q=S;function S(){return null!==O&&O.apply(this,arguments)||this}k=T.ChildProperty,y(F,k),P([T.Property(!0)],F.prototype,"showCircle",void 0),P([T.Property(null)],F.prototype,"strokeColor",void 0),P([T.Property(null)],F.prototype,"fillColor",void 0);var k,Z=F;function F(){return null!==k&&k.apply(this,arguments)||this}I=T.ChildProperty,y(A,I),P([T.Property("Arial")],A.prototype,"default",void 0),P([T.Property(null)],A.prototype,"items",void 0);var I,V=A;function A(){return null!==I&&I.apply(this,arguments)||this}z=T.Component,y(D,z),(R=D).prototype.requiredModules=function(){var e=[];return e.push({member:"crop",args:[this]}),e.push({member:"draw",args:[this]}),e.push({member:"selection",args:[this]}),e.push({member:"transform",args:[this]}),e.push({member:"export",args:[this]}),e.push({member:"toolbar-module",args:[this]}),e.push({member:"undo-redo",args:[this]}),e.push({member:"filter",args:[this]}),e.push({member:"shape",args:[this]}),e.push({member:"freehand-draw",args:[this]}),e},D.prototype.preRender=function(){this.element.id=this.element.id||T.getUniqueID("ej2-image-editor"),this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),T.Browser.isDevice&&this.element.classList.add("e-device"),this.initializeThemeColl()},D.prototype.render=function(){var e,t;this.isAngular&&(t=(e=this.element).cloneNode(!0),e.parentNode.replaceChild(t,e),this.element=t,T.setValue("ej2_instances",[this],this.element)),this.initialize()},D.prototype.getModuleName=function(){return"image-editor"},D.prototype.getPersistData=function(){return this.addOnPersist([])},D.prototype.onPropertyChanged=function(e,t){for(var o,i=0,r=Object.keys(e);i<r.length;i++)switch(r[i]){case"cssClass":t.cssClass&&T.removeClass([this.element],t.cssClass.replace(/\s+/g," ").trim().split(" ")),e.cssClass&&T.addClass([this.element],e.cssClass.replace(/\s+/g," ").trim().split(" "));break;case"disabled":e.disabled?(this.element.classList.add("e-disabled"),this.unwireEvent()):(this.element.classList.remove("e-disabled"),this.wireEvent());break;case"height":this.element.style.height=e.height,this.update();break;case"width":this.element.style.width=e.width,this.update();break;case"theme":e.theme&&(this.theme&&""!==this.theme?this.theme=this.toPascalCase(this.theme):this.theme="Bootstrap5",this.upperContext.strokeStyle=this.themeColl[this.theme].primaryColor,this.upperContext.fillStyle=this.themeColl[this.theme].secondaryColor,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}));break;case"finetuneSettings":e.finetuneSettings&&(this.finetuneSettings=e.finetuneSettings,this.notify("filter",{prop:"update-finetunes"}));break;case"locale":e.locale&&(this.notify("toolbar",{prop:"setLocale",onPropertyChange:!1,value:{locale:e.locale}}),this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}));break;case"allowUndoRedo":e.allowUndoRedo?this.allowUndoRedo=!0:this.allowUndoRedo=!1,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});break;case"showQuickAccessToolbar":e.showQuickAccessToolbar?(this.showQuickAccessToolbar=!0,this.notify("toolbar",{prop:"create-qa-toolbar",onPropertyChange:!1}),this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!(o={freehandSelectedIndex:null}),value:{obj:o}}),this.activeObj.shape?this.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}):o.freehandSelectedIndex&&this.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:!0}})):(this.showQuickAccessToolbar=!1,this.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}));break;case"zoomSettings":e.zoomSettings&&(this.zoomSettings.zoomTrigger=e.zoomSettings.zoomTrigger),T.isNullOrUndefined(this.zoomSettings.zoomTrigger)?(this.zoomSettings.zoomTrigger=m.ZoomTrigger.MouseWheel|m.ZoomTrigger.Pinch|m.ZoomTrigger.Toolbar|m.ZoomTrigger.Commands,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})):(e.zoomSettings.zoomTrigger&m.ZoomTrigger.Toolbar)===m.ZoomTrigger.Toolbar&&this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});break;case"selectionSettings":e.selectionSettings&&(this.selectionSettings=e.selectionSettings,this.activeObj.shape)&&(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:this.activeObj}}));break;case"toolbar":e.toolbar&&(this.toolbar=e.toolbar,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}));break;case"toolbarTemplate":e.toolbarTemplate&&(this.notify("toolbar",{prop:"destroy-bottom-toolbar",onPropertyChange:!1}),this.notify("toolbar",{prop:"destroy-top-toolbar",onPropertyChange:!1}),this.element.appendChild(this.createElement("div",{id:this.element.id+"_toolbarArea",className:"e-toolbar-area"})),this.toolbarTemplateFn());break;case"quickAccessToolbarTemplate":e.quickAccessToolbarTemplate&&(this.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),this.quickAccessToolbarTemplateFn());break;case"uploadSettings":e.uploadSettings?(this.uploadSettings=e.uploadSettings,this.uploadSettings.allowedExtensions?this.notify("draw",{prop:"setNullExtension",value:{extension:!1}}):(this.uploadSettings.allowedExtensions=".jpg, .jpeg, .png, .svg, .webp",this.notify("draw",{prop:"setNullExtension",value:{extension:!0}})),this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})):this.notify("draw",{prop:"setNullExtension",value:{extension:!0}}),this.updateDropInfoContent(this.element.querySelector(".e-ie-drop-info"))}},D.prototype.destroy=function(){var e=[],t=(this.element.removeAttribute("tabindex"),this.element.querySelector("#"+this.element.id+"_saveDialog"));t&&"block"===t.style.display&&T.getComponent(document.getElementById(this.element.id+"_saveDialog"),"dialog").destroy(),this.cssClass&&(e=e.concat(this.cssClass.replace(/\s+/g," ").trim().split(" "))),T.removeClass([this.element],e),this.element.getAttribute("class")||this.element.removeAttribute("class"),this.unwireEvent(),this.notify("toolbar",{prop:"destroySubComponents",onPropertyChange:!1}),this.notify("destroyed",null),z.prototype.destroy.call(this),this.element.innerHTML=""},D.prototype.initialize=function(){var e;this.toolbarTemplate?(this.element.appendChild(this.createElement("div",{id:this.element.id+"_toolbarArea",className:"e-toolbar-area"})),this.toolbarTemplateFn()):(this.notify("toolbar",{prop:"create-toolbar",onPropertyChange:!1}),this.notify("toolbar",{prop:"create-contextual-toolbar",onPropertyChange:!1})),this.uploadSettings.allowedExtensions?this.notify("draw",{prop:"setNullExtension",value:{extension:!1}}):this.setProperties({uploadSettings:{allowedExtensions:".jpg, .jpeg, .png, .svg, .webp"}},!0),this.createCanvas(),359<this.element.offsetWidth&&this.element.querySelector(".e-ie-min-drop-content")&&this.element.querySelector(".e-ie-drop-content")&&(this.element.querySelector(".e-ie-min-drop-content").style.display="none",this.element.querySelector(".e-ie-drop-content").style.display="block"),this.createDropUploader(),this.showQuickAccessToolbar&&(document.querySelector("#"+this.element.id+"_canvasWrapper").appendChild(this.createElement("div",{id:this.element.id+"_quickAccessToolbarArea",className:"e-quick-access-toolbar-area"})),(e=document.getElementById(this.element.id+"_quickAccessToolbarArea")).style.position="absolute",e.style.display="none",this.activeObj&&(e.style.left=this.activeObj.activePoint.startX+"px",e.style.top=this.activeObj.activePoint.startY+"px"),e.style.width="100%"),this.quickAccessToolbarTemplate?this.quickAccessToolbarTemplateFn():this.notify("toolbar",{prop:"create-qa-toolbar",onPropertyChange:!1}),this.wireEvent(),this.lowerContext=this.lowerCanvas.getContext("2d"),this.upperContext=this.upperCanvas.getContext("2d"),this.inMemoryContext=this.inMemoryCanvas.getContext("2d"),this.lowerContext.filter=this.getDefaultFilter(),this.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),this.canvasFilter=this.lowerContext.filter,this.notify("toolbar",{prop:"setInitialAdjustmentValue",onPropertyChange:!1,value:{value:this.lowerContext.filter}}),this.cssClass&&T.addClass([this.element],this.cssClass.replace(/\s+/g," ").trim().split(" ")),this.element&&f.createSpinner({target:this.element}),this.initializeZoomSettings(),this.imgSrc&&this.open(this.imgSrc)},D.prototype.createDropUploader=function(){var r=this,n=this;new g.Uploader({dropArea:this.element.getElementsByClassName("e-canvas-wrapper")[0],allowedExtensions:this.uploadSettings.allowedExtensions,multiple:!1,selected:function(e){var t,o,i;"change"!==e.event.type&&"drop"!==e.event.type||(o=e.filesData[0].type,t="unsupported",o=-1<r.getExtensionArray().indexOf(o)||"jpeg"===o&&(-1<n.uploadSettings.allowedExtensions.indexOf("jpg")||-1<n.uploadSettings.allowedExtensions.indexOf("jpeg")),i=e.filesData[0].size,i=n.uploadSettings.minFileSize&&i<n.uploadSettings.minFileSize||n.uploadSettings.maxFileSize&&i>n.uploadSettings.maxFileSize,("change"===e.event.type||"drop"===e.event.type&&1===e.event.dataTransfer.files.length)&&o&&!i?r.notify("draw",{prop:"fileSelect",value:{inputElement:r.element.querySelector("#"+r.element.id+"_dropfileUpload"),args:e}}):("drop"===e.event.type&&1<e.event.dataTransfer.files.length&&(t="multi-select-image"),r.showDialogPopup(t,!o)))}}).appendTo("#"+this.element.id+"_dropfileUpload")},D.prototype.dlgCloseBtnClick=function(){T.getComponent(document.getElementById(this.element.id+"_dialog"),"dialog").destroy()},D.prototype.showDialogPopup=function(e,t){var o,i,r,n,a,s,l="",p=(this.element.querySelector("#"+this.element.id+"_dialog").style.display="block",{key:"DlgOK"});this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:p}}),"multi-select-image"===e?(this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!(o={key:"ImageErrorDialogHeader"}),value:{obj:o}}),this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!(i={key:"ImageErrorDialogContent"}),value:{obj:i}}),l="<span>"+i.value+"</span>"):(this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!(o={key:"AlertDialogHeader"}),value:{obj:o}}),this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!(i={key:"AlertDialogContent"}),value:{obj:i}}),this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!(e={key:"SupportText"}),value:{obj:e}}),r=this.getExtensionString(),this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!(n={key:"MinMaxSizeAlert"}),value:{obj:n}}),s=void this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!(a={key:"And"}),value:{obj:a}}),this.uploadSettings.minFileSize&&this.uploadSettings.maxFileSize?s=" "+n.value+" <b> "+this.formatSizeUnits(this.uploadSettings.minFileSize)+" </b> "+a.value+" <b> "+this.formatSizeUnits(this.uploadSettings.maxFileSize)+" </b> ":this.uploadSettings.minFileSize?(n.key="MinSizeAlert",this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:n}}),s=" "+n.value+" <b> "+this.formatSizeUnits(this.uploadSettings.minFileSize)+" </b> "):this.uploadSettings.maxFileSize&&(n.key="MaxSizeAlert",this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:n}}),s=" "+n.value+" <b> "+this.formatSizeUnits(this.uploadSettings.maxFileSize)+" </b> "),t?l="<span>"+i.value+" "+e.value+"<b>"+r+"</b></span>":s&&(l="<span>"+i.value+" "+e.value+s+"</span>")),new f.Dialog({header:o.value,closeOnEscape:!0,content:l,target:document.getElementById("target"),width:T.Browser.isDevice?"285px":"400px",isModal:!0,animationSettings:{effect:"Zoom"},close:this.dlgCloseBtnClick.bind(this),buttons:[{click:this.dlgCloseBtnClick.bind(this),buttonModel:{content:p.value}}]}).appendTo("#"+this.element.id+"_dialog")},D.prototype.formatSizeUnits=function(e){return 1073741824<=e?(e/1073741824).toFixed(2)+" GB":1048576<=e?(e/1048576).toFixed(2)+" MB":1024<=e?(e/1024).toFixed(2)+" KB":1<e?e+" bytes":1===e?e+" byte":"0 bytes"},D.prototype.getExtensionArray=function(){for(var e=["jpeg","jpg","png","svg","webp"],t=[],o=0,i=this.uploadSettings.allowedExtensions.split(",");o<i.length;o++)for(var r=i[o].trim(),n=0,a=e;n<a.length;n++){var s=a[n];if(-1!==r.indexOf(s)){t.push(s);break}}return t},D.prototype.getExtensionString=function(){for(var e={key:"And"},t=(this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:e}}),this.getExtensionArray()),o="",i=0;i<t.length;i++){switch(i===t.length-1&&1<t.length&&("jpeg"!==t[i]&&"jpg"!==t[i]||!(-1<o.indexOf("JPG")))&&((2===t.length||3===t.length&&-1!==t.indexOf("jpeg")&&-1!==t.indexOf("jpg"))&&(o=o.replace(/,\s*$/,"")),o+=" "+e.value),t[i]){case"jpeg":case"jpg":-1===o.indexOf("JPG")&&(o+=" JPG,");break;case"png":o+=" PNG,";break;case"svg":o+=" SVG,";break;case"webp":o+=" WebP,"}i===t.length-1&&(o=o.slice(0,-1))}return o},D.prototype.wireEvent=function(){T.EventHandler.add(document,"keydown",this.keyDownEventHandler,this),T.EventHandler.add(document,"keypress",this.keyUpEventHandler,this),T.EventHandler.add(this.upperCanvas,"mousedown",this.mouseDownEventHandler,this),T.EventHandler.add(this.upperCanvas,"mousemove",this.mouseMoveEventHandler,this),T.EventHandler.add(this.upperCanvas,"mouseup",this.mouseUpEventHandler,this),T.EventHandler.add(document,"mouseup",this.mouseUpEventHandler,this),T.EventHandler.add(this.lowerCanvas,"mousedown",this.canvasMouseDownHandler,this),T.EventHandler.add(this.lowerCanvas,"mousemove",this.canvasMouseMoveHandler,this),T.EventHandler.add(this.lowerCanvas,"mouseup",this.canvasMouseUpHandler,this),T.EventHandler.add(this.upperCanvas,"touchstart",this.touchStartHandler,this),T.EventHandler.add(this.lowerCanvas,"touchstart",this.touchStartHandler,this),T.EventHandler.add(this.lowerCanvas,"mousewheel DOMMouseScroll",this.handleScroll,this),T.EventHandler.add(this.upperCanvas,"mousewheel DOMMouseScroll",this.handleScroll,this),window.addEventListener("resize",this.windowResizeHandler.bind(this)),T.Browser.isIos||"safari"===T.Browser.info.name||screen.orientation.addEventListener("change",this.screenOrientation.bind(this)),this.notify("shape",{prop:"wireEvent",onPropertyChange:!1})},D.prototype.unwireEvent=function(){T.EventHandler.remove(document,"keydown",this.keyDownEventHandler),T.EventHandler.remove(document,"keypress",this.keyUpEventHandler),T.EventHandler.remove(this.upperCanvas,"mousedown",this.mouseDownEventHandler),T.EventHandler.remove(this.upperCanvas,"mousemove",this.mouseMoveEventHandler),T.EventHandler.remove(this.upperCanvas,"mouseup",this.mouseUpEventHandler),T.EventHandler.remove(document,"mouseup",this.mouseUpEventHandler),T.EventHandler.remove(this.lowerCanvas,"mousedown",this.canvasMouseDownHandler),T.EventHandler.remove(this.lowerCanvas,"mousemove",this.canvasMouseMoveHandler),T.EventHandler.remove(this.lowerCanvas,"mouseup",this.canvasMouseUpHandler),T.EventHandler.remove(this.upperCanvas,"touchstart",this.touchStartHandler),T.EventHandler.remove(this.lowerCanvas,"touchstart",this.touchStartHandler),T.EventHandler.remove(this.lowerCanvas,"mousewheel DOMMouseScroll",this.handleScroll),T.EventHandler.remove(this.upperCanvas,"mousewheel DOMMouseScroll",this.handleScroll),window.removeEventListener("resize",this.windowResizeHandler.bind(this)),T.Browser.isIos||"safari"===T.Browser.info.name||screen.orientation.removeEventListener("change",this.screenOrientation.bind(this)),this.notify("shape",{prop:"unWireEvent",onPropertyChange:!1}),this.notify("selection",{prop:"unWireEvent",onPropertyChange:!1})},D.prototype.createCanvas=function(){this.element.style.boxSizing="border-box";var e={toolbarHeight:0},e=(this.notify("toolbar",{prop:"getToolbarHeight",value:{obj:e}}),e.toolbarHeight),t=(this.toolbar&&0<this.toolbar.length&&-1===this.toolbar.indexOf("Open")&&(e=0),this.element.style.width=this.width,this.element.style.height=this.height,this.createElement("div",{id:this.element.id+"_canvasWrapper",className:"e-canvas-wrapper"})),e=(t.style.cssText="height: "+(this.element.offsetHeight-e-2)+"px; width: "+(this.element.offsetWidth-2)+"px; position: relative; overflow: hidden; margin: 0 auto;",this.element.appendChild(t)),t={key:"DragText"},o=(this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:t}}),{key:"DropText"}),i=(this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:o}}),{key:"BrowseText"}),r=(this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:i}}),this.createElement("div",{id:this.element.id+"_dropArea",className:"e-ie-drop-area"})),n=(r.style.position="relative",this.createElement("span",{className:"e-ie-drop-icon e-icons e-image"})),a=(n.style.position="absolute",this.createElement("span",{className:"e-ie-drop-content"})),t=(a.style.cssText="position: absolute; display: none;",a.textContent=t.value+" ",this.createElement("span",{className:"e-ie-min-drop-content"})),o=(t.style.position="absolute",t.textContent=o.value+" ",this.createElement("a",{id:this.element.id+"_dropBrowse",className:"e-ie-drop-browse"})),s=(o.textContent=i.value,this.createElement("a",{id:this.element.id+"_dropBrowse",className:"e-ie-drop-browse"})),i=(s.textContent=i.value,a.appendChild(o),t.appendChild(s),o.href="",s.href="",this.createElement("span",{className:"e-ie-drop-info",attrs:{position:"absolute"}})),l=(this.updateDropInfoContent(i),r.appendChild(this.createElement("input",{id:this.element.id+"_dropfileUpload",className:"e-fileUpload e-image-upload"})));l.setAttribute("type","file"),l.setAttribute("accept","image/*"),r.appendChild(n),r.appendChild(a),r.appendChild(t),r.appendChild(i),e.appendChild(r),this.lowerCanvas=e.appendChild(this.createElement("canvas",{id:this.element.id+"_lowerCanvas",attrs:{name:"canvasImage"}})),this.maskCanvas=e.appendChild(this.createElement("canvas",{id:this.element.id+"_maskCanvas",attrs:{name:"canvasImage"}})),this.upperCanvas=e.appendChild(this.createElement("canvas",{id:this.element.id+"_upperCanvas",attrs:{name:"canvasImage"}})),this.inMemoryCanvas=this.createElement("canvas",{id:this.element.id+"_inMemoryCanvas",attrs:{name:"canvasImage"}}),this.baseImgCanvas=this.createElement("canvas",{id:this.element.id+"_baseImgCanvas",attrs:{name:"canvasImage"}}),this.textArea=e.appendChild(this.createElement("textarea",{id:this.element.id+"_textArea",className:"e-textarea",attrs:{name:"textArea"}}));this.element.appendChild(this.createElement("div",{id:this.element.id+"_dialog",className:"e-dialog"})).style.display="none";n=this.element.appendChild(this.createElement("input",{id:this.element.id+"_fileUpload",className:"e-fileUpload"}));n.setAttribute("type","file"),n.setAttribute("accept","image/*"),n.style.display="none",this.textArea.setAttribute("spellcheck","false"),this.textArea.style.lineHeight="normal",this.lowerCanvas.style.width=this.upperCanvas.style.width=this.maskCanvas.style.width=this.inMemoryCanvas.style.width="100%",this.lowerCanvas.style.height=this.upperCanvas.style.height=this.maskCanvas.style.height=this.inMemoryCanvas.style.height="100%",this.upperCanvas.style.position=this.lowerCanvas.style.position=this.maskCanvas.style.position=this.textArea.style.position="absolute",this.textArea.style.backgroundColor="transparent",this.textArea.style.display="none",this.maskCanvas.style.display=this.textArea.style.resize="none",this.lowerContext=this.lowerCanvas.getContext("2d"),this.baseImg=this.createElement("img",{id:this.element.id+"_orgImg",attrs:{name:"Image",crossorigin:"anonymous"}}),this.upperCanvas.style.cursor=this.cursor="default",this.upperCanvas.style.display="block",this.upperContext=this.upperCanvas.getContext("2d"),o.addEventListener("click",function(e){return e.preventDefault(),l.click(),!1}),s.addEventListener("click",function(e){return e.preventDefault(),l.click(),!1})},D.prototype.touchStartHandler=function(e){this.notify("selection",{prop:"touchStartHandler",onPropertyChange:!1,value:{e:e}})},D.prototype.mouseDownEventHandler=function(e){"e-ie-drop-browse"!==e.target.className&&this.notify("selection",{prop:"mouseDownEventHandler",onPropertyChange:!1,value:{e:e}})},D.prototype.mouseMoveEventHandler=function(e){this.notify("selection",{prop:"mouseMoveEventHandler",onPropertyChange:!1,value:{e:e}})},D.prototype.mouseUpEventHandler=function(e){"e-ie-drop-browse"!==e.target.className&&this.notify("selection",{prop:"mouseUpEventHandler",onPropertyChange:!1,value:{e:e}})},D.prototype.keyDownEventHandler=function(e){this.notify("selection",{prop:"keyDownEventHandler",onPropertyChange:!1,value:{e:e}})},D.prototype.keyUpEventHandler=function(e){"block"!==this.textArea.style.display&&"inline-block"!==this.textArea.style.display||e.target.id!==this.element.id+"_textArea"||this.notify("selection",{prop:"textKeyDown",value:{e:e}})},D.prototype.canvasMouseDownHandler=function(e){"e-ie-drop-browse"!==e.target.className&&this.notify("selection",{prop:"canvasMouseDownHandler",onPropertyChange:!1,value:{e:e}})},D.prototype.canvasMouseMoveHandler=function(e){this.notify("selection",{prop:"canvasMouseMoveHandler",onPropertyChange:!1,value:{e:e}})},D.prototype.canvasMouseUpHandler=function(e){"e-ie-drop-browse"!==e.target.className&&this.notify("selection",{prop:"canvasMouseUpHandler",onPropertyChange:!1,value:{e:e}})},D.prototype.handleScroll=function(e){this.notify("selection",{prop:"handleScroll",onPropertyChange:!1,value:{e:e}})},D.prototype.adjustToScreen=function(){this.update()},D.prototype.screenOrientation=function(){T.Browser.isDevice&&setTimeout(this.adjustToScreen.bind(this),100)},D.prototype.windowResizeHandler=function(){!T.Browser.isDevice&&this.element.classList.contains("e-image-editor")&&this.adjustToScreen()},D.prototype.notifyResetForAllModules=function(){for(var e=this.requiredModules(),t=0;t<e.length;t++){var o=e[t].member;this.notify("toolbar-module"===o?"toolbar":o,{prop:"reset",onPropertyChange:!1})}},D.prototype.allowShape=function(e,t){this.isPublicMethod=!0,this.applyShapes();var o={inRange:!1};return this.notify("shape",{prop:"isPointsInRange",onPropertyChange:!1,value:{x:e,y:t,obj:o}}),o.inRange},D.prototype.manageActiveAction=function(){this.applyShapes(),this.activeObj.shape&&-1<this.activeObj.shape.indexOf("crop")&&this.discard()},D.prototype.clearSelection=function(e){this.notify("selection",{prop:"clearSelection",onPropertyChange:!1,value:{resetCrop:e}})},D.prototype.crop=function(){var e={isCrop:!1};return this.notify("crop",{prop:"crop",onPropertyChange:!1,value:{obj:e}}),e.isCrop},D.prototype.flip=function(e){this.applyShapes(),this.updateImageTransformColl(e.toLowerCase()+"flip"),this.notify("transform",{prop:"flip",value:{direction:e}}),this.notify("draw",{prop:"redrawDownScale"}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}});e={action:"flip",actionEventArgs:this.editCompleteArgs};this.triggerEditCompleteEvent(e)},D.prototype.getImageData=function(e){var t;return(e=!!T.isNullOrUndefined(e)||e)?(e={canvas:null},this.applyShapes(),this.notify("export",{prop:"exportToCanvas",value:{object:e}}),t=e.canvas.getContext("2d").getImageData(0,0,e.canvas.width,e.canvas.height)):this.isMaskImage&&"mask-drawing"===this.element.getAttribute("data-value")?(t=this.getData(!0),this.updateColl("reset")):(t=this.getData(),this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}})),t},D.prototype.open=function(e,t,o){(t=!!T.isNullOrUndefined(t)||t)?T.isNullOrUndefined(e)||((t=document.getElementById(this.element.id+"_dropArea"))&&(t.style.display="none"),this.notify("draw",{prop:"open",value:{data:e}})):this.updateImage(e,o?o.backgroundColor:null)},D.prototype.reset=function(){this.updateColl("reset");var e,t={isErrorImage:!1};this.notify("draw",{prop:"getErrorImage",value:{obj:t}}),this.disabled||t.isErrorImage||(this.clearContext(this.inMemoryContext),this.clearContext(this.lowerContext),this.clearContext(this.upperContext),this.notify("shape",{prop:"setRedactType",onPropertyChange:!1,value:{redactType:"blur"}}),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:!1,isZooming:null,cType:null}}),T.Browser.isDevice&&document.getElementById(this.element.id+"_bottomToolbar")&&(T.getComponent(document.getElementById(this.element.id+"_bottomToolbar"),"toolbar").destroy(),this.notify("toolbar",{prop:"create-bottom-toolbar",onPropertyChange:!1})),t=this.isImageLoaded,this.currObjType.isUndoAction=this.isUndoRedo=this.togglePan=this.togglePen=this.isImageLoaded=this.isFinetuning=!1,this.isCircleCrop=this.isCropTab=!1,this.objColl=[],this.transform.degree=0,this.upperCanvas.style.display="block",this.transform.currFlipState="",this.allowDownScale=!0,this.upperCanvas.style.cursor=this.cursor=this.lowerCanvas.style.cursor="default",this.lowerContext.lineWidth=this.upperContext.lineWidth=void 0,this.frameDestPoints=null,this.textArea.value=this.textArea.textContent="",this.textArea.style.display="none",this.lowerContext.filter=this.canvasFilter=this.getDefaultFilter(),this.img.destLeft=this.img.destTop=this.img.srcLeft=this.img.srcTop=0,this.img.destWidth=this.img.destHeight=this.img.srcWidth=this.img.srcHeight=null,this.currSelectionPoint=null,this.panPoint.currentPannedPoint={x:0,y:0},this.rotateFlipColl=[],this.points=[],this.pointColl={},this.freehandCounter=0,this.notify("draw",{prop:"resetPanPoints"}),this.lowerCanvas.style.left=this.upperCanvas.style.left="",this.fontSizeColl=[],this.lowerCanvas.style.top=this.upperCanvas.style.top="",this.lowerCanvas.style.maxWidth=this.upperCanvas.style.maxWidth="",this.lowerCanvas.style.maxHeight=this.upperCanvas.style.maxHeight="",this.transform.defaultZoomFactor=this.transform.zoomFactor=0,this.transform.cropZoomFactor=null,this.frameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},this.tempFrameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},this.currObjType={shape:"",isDragging:!1,isActiveObj:!1,isText:!1,isInitialText:!1,isLine:!1,isInitialLine:!1,isCustomCrop:!1,isZoomed:!1,isUndoZoom:!1,isUndoAction:!1,isFiltered:!1,isSave:!1,isResize:!1,isRedact:!1},this.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",straighten:0,zoomFactor:0,previousZoomValue:0,destPoints:{startX:0,startY:0,width:0,height:0},frame:"none",srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:!1,aspectWidth:null,aspectHeight:null,straightenZoom:0,adjustmentLevel:{brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},currentFilter:""},this.afterCropActions=[],this.currentFilter="",this.tempFrameZoomLevel=null,this.cxtTbarHeight=null,this.straightenPoint=null,this.transform.straighten=0,this.cancelCropSelection=null,this.aspectWidth=this.aspectHeight=null,this.isResize=this.isMaskImage=!1,this.drawingShape=null,this.isShapeDrawing=this.noPushUndo=this.isUndoRedoStack=this.isKBDNavigation=!1,this.shapeColl=[],this.tempObjColl=[],this.tempPointColl=[],this.tempShapeColl=[],this.isImageUpdated=!1,this.tempToolbarHeight=0,this.tempToolbar=[],this.tempRedactBlur=50,e={initialZoomValue:!(this.tempRedactPixel=40)},this.editCompleteArgs=null,this.isFinetuneBtnClick=!1,this.notify("draw",{prop:"getInitialZoomValue",onPropertyChange:!1,value:{obj:e}}),e.initialZoomValue&&this.setProperties({zoomSettings:{zoomFactor:e.initialZoomValue}},!0),(e=document.getElementById(this.element.id+"_quickAccessToolbarArea"))&&(e.style.display="none"),this.notifyResetForAllModules(),this.notify("filter",{prop:"update-finetunes"}),this.toolbarTemplate?this.toolbarHeight=this.element.querySelector("#"+this.element.id+"_toolbarArea").clientHeight:this.element.querySelector("#"+this.element.id+"_toolbar")&&(this.toolbarHeight=this.element.querySelector("#"+this.element.id+"_toolbar").clientHeight),this.notify("toolbar",{prop:"setToolbarHeight",value:{height:this.toolbarHeight}}),this.isImageLoaded=t,this.straightenBaseImageCanvas(),this.isImageLoaded=!1,this.notify("draw",{prop:"update-canvas",onPropertyChange:!1}),this.isImageLoaded=t,this.prevStraightenedDegree=0,(e=this.element.querySelector(".e-contextual-toolbar-wrapper"))&&e.classList.add("e-hide"),this.notify("toolbar",{prop:"refresh-dropdown-btn",value:{isDisabled:!1}}),this.notify("toolbar",{prop:"enable-disable-btns"}),t=this.isStraightening,T.Browser.isDevice&&t&&this.notify("crop",{prop:"resizeWrapper"}),(e=this.element.querySelector("#"+this.element.id+"_saveDialog"))&&T.getComponent(e,"dialog").close(),this.triggerEditCompleteEvent({action:"reset",actionEventArgs:null}))},D.prototype.rotate=function(e){var t={isRotate:!1},e=(this.applyShapes(),90!==e&&-90!==e||this.updateImageTransformColl(90===e?"rotateright":"rotateleft"),this.notify("transform",{prop:"rotate",value:{degree:e,obj:t}}),this.notify("draw",{prop:"redrawDownScale"}),{action:"rotate",actionEventArgs:this.editCompleteArgs});return this.triggerEditCompleteEvent(e),t.isRotate},D.prototype.export=function(e,t,o){this.applyShapes(),this.notify("export",{prop:"export",onPropertyChange:!1,value:{type:e,fileName:t,imgQuality:o}})},D.prototype.select=function(e,t,o,i,r){this.applyShapes(),this.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-"+e}}),this.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:e,startX:t,startY:o,width:i,height:r}}),t&&o||i&&r?this.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:e,startX:t,startY:o,width:i,height:r}}):this.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",straighten:0,zoomFactor:0,previousZoomValue:0,destPoints:{startX:0,startY:0,width:0,height:0},frame:"none",srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:!1,aspectWidth:null,aspectHeight:null,straightenZoom:0,adjustmentLevel:{brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},currentFilter:""}},D.prototype.freeHandDraw=function(e){this.notify("freehand-draw",{prop:"freeHandDraw",onPropertyChange:!1,value:{value:e}})},D.prototype.freehandDraw=function(e){!this.disabled&&this.isImageLoaded&&(!e&&this.isMaskImage?this.discard():(this.manageActiveAction(),this.freeHandDraw(e),this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!(e={shapeSettingsObj:{}}),value:{obj:e}}),(e=e.shapeSettingsObj).type=m.ShapeType.FreehandDraw,this.notify("freehand-draw",{prop:"triggerShapeChanging",value:{shapeChangingArgs:{cancel:!1,action:"insert",previousShapeSettings:e,currentShapeSettings:e}}})))},D.prototype.pan=function(e,t,o){this.applyShapes(),this.notify("transform",{prop:"pan",onPropertyChange:!1,value:{value:e,x:t,y:o}})},D.prototype.zoom=function(e,t){this.isZoomBtnClick=!0,this.notify("transform",{prop:"zoom",onPropertyChange:!1,value:{zoomFactor:e,zoomPoint:t}}),this.notify("draw",{prop:"redrawDownScale"})},D.prototype.drawEllipse=function(e,t,o,i,r,n,a,s,l){var p=!1,h=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&(h||T.isNullOrUndefined(e)&&T.isNullOrUndefined(t))&&(p=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawEllipse",onPropertyChange:!1,value:{x:e,y:t,radiusX:o,radiusY:i,strokeWidth:r,strokeColor:n,fillColor:a,degree:s,isSelected:l}}),this.editCompleted()),p},D.prototype.drawLine=function(e,t,o,i,r,n,a){var s=!1,l=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&(l||T.isNullOrUndefined(e)&&T.isNullOrUndefined(t))&&(s=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawLine",onPropertyChange:!1,value:{startX:e,startY:t,endX:o,endY:i,strokeWidth:r,strokeColor:n,isSelected:a}}),this.editCompleted()),s},D.prototype.drawArrow=function(e,t,o,i,r,n,a,s,l){var p=!1,h=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&(h||T.isNullOrUndefined(e)&&T.isNullOrUndefined(t))&&(p=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawArrow",onPropertyChange:!1,value:{startX:e,startY:t,endX:o,endY:i,strokeWidth:r,strokeColor:n,arrowStart:a,arrowEnd:s,isSelected:l}}),this.editCompleted()),p},D.prototype.drawPath=function(e,t,o,i){var r={inRange:!(this.isPublicMethod=!0)},n=!1;if(e&&0<e.length)for(var a=0;a<e.length&&!r.inRange;a++)this.notify("shape",{prop:"isPointsInRange",onPropertyChange:!1,value:{x:e[a].x,y:e[a].y,obj:r}});return!this.disabled&&this.isImageLoaded&&(r.inRange||T.isNullOrUndefined(e))&&(n=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawPath",onPropertyChange:!1,value:{pointColl:e,strokeWidth:t,strokeColor:o,isSelected:i}}),this.editCompleted()),n},D.prototype.drawRectangle=function(e,t,o,i,r,n,a,s,l,p){var h=!1,d=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&(d||T.isNullOrUndefined(e)&&T.isNullOrUndefined(t))&&(h=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawRectangle",onPropertyChange:!1,value:{x:e,y:t,width:o,height:i,strokeWidth:r,strokeColor:n,fillColor:a,degree:s,isSelected:l,radius:p}}),this.editCompleted()),h},D.prototype.drawText=function(e,t,o,i,r,n,a,s,l,p,h,d,c,u){var g=!1,v=this.allowShape(e,t);return!this.disabled&&this.isImageLoaded&&(v||T.isNullOrUndefined(e)&&T.isNullOrUndefined(t))&&(g=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawText",onPropertyChange:!1,value:{x:e,y:t,text:o,fontFamily:i,fontSize:r,bold:n,italic:a,color:s,isSelected:l,degree:p,fillColor:h,outlineColor:d,outlineWidth:c,transformCollection:u}}),this.editCompleted()),g},D.prototype.drawImage=function(e,t,o,i,r,n,a,s,l){var p=!1,h=this.allowShape(t,o);return p=!this.disabled&&this.isImageLoaded&&(h||T.isNullOrUndefined(t)&&T.isNullOrUndefined(o))&&(this.manageActiveAction(),h=this.objColl.length,this.notify("shape",{prop:"drawImage",onPropertyChange:!1,value:{x:t,y:o,width:i,height:r,src:e,degree:a,isAspectRatio:n,opacity:s,isSelected:l}}),this.editCompleted(),this.objColl.length>h)?!0:p},D.prototype.updateShape=function(e,t){var o,i={isSelected:!1},r=!1,n={bool:!1};return T.isNullOrUndefined(e.id)?(e.strokeColor&&(this.activeObj.strokeSettings.strokeColor=e.strokeColor),e.fillColor&&(this.activeObj.strokeSettings.fillColor=e.fillColor),e.strokeWidth&&(this.activeObj.strokeSettings.strokeWidth=e.strokeWidth),e.index&&(this.activeObj.order=e.index),"FreehandDraw"===e.type&&e.strokeWidth&&this.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:e.strokeWidth}})):("text"!==e.type.toLowerCase()||"block"!==this.textArea.style.display&&"inline-block"!==this.textArea.style.display||(this.okBtn(null,!0),r=!0),this.notify("shape",{prop:"selectShape",onPropertyChange:!1,value:{id:e.id,obj:i,isShape:!0}}),this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:n}}),i.isSelected&&(o=this.activeObj.textSettings.fontSize,this.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e}}),"text"===this.activeObj.shape&&o&&0!=(o=this.activeObj.textSettings.fontSize-o)&&(this.activeObj.activePoint.height+=o,this.activeObj.activePoint.startY-=o/2,this.activeObj.activePoint.endY+=o/2,this.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:this.activeObj.activePoint,obj:this.activeObj,isMouseMove:null,x:null,y:null}})),o=T.extend({},this.activeObj,{},!0),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:null}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),o.shape&&this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o}}),"text"===this.activeObj.shape&&this.notify("toolbar",{prop:"editText",onPropertyChange:!1}),n.bool&&this.notify("undo-redo",{prop:"setPreventUR",value:{bool:!0}}),this.okBtn(t,!0),n.bool&&this.notify("undo-redo",{prop:"setPreventUR",value:{bool:!1}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.editCompleteArgs={action:"shape-update",currentShapeSettings:e},this.editCompleted("shape-customize"),r&&this.enableTextEditing(),t)&&(this.noRedact=!0,this.selectShape(e.id))),i.isSelected},D.prototype.selectShape=function(e){this.applyShapes();var t={isSelected:!1};return this.notify("shape",{prop:"selectShape",onPropertyChange:!1,value:{id:e,obj:t,isShape:!0}}),this.editCompleted("shape-select"),this.noRedact=!1,t.isSelected},D.prototype.deleteShape=function(e){"Redact"!==this.getShapeSetting(e).type&&(this.applyShapes(),this.notify("shape",{prop:"deleteShape",onPropertyChange:!1,value:{id:e,isShape:!0}}),this.editCompleted("shape-delete"))},D.prototype.getShapeSetting=function(e){this.applyShapes();var t={shapeDetails:null};return this.notify("shape",{prop:"getShapeSetting",onPropertyChange:!1,value:{id:e,obj:t}}),this.notify("draw",{prop:"redrawDownScale"}),t.shapeDetails||{}},D.prototype.getShapeSettings=function(){this.applyShapes();var e={shapeDetailsColl:[]};return this.notify("shape",{prop:"getShapeSettings",onPropertyChange:!1,value:{obj:e}}),this.notify("draw",{prop:"redrawDownScale"}),e.shapeDetailsColl.filter(function(e){return"redact"!==e.type})},D.prototype.getRedacts=function(){this.applyShapes();var e={shapeDetailsColl:[]};return this.notify("shape",{prop:"getRedactSettings",onPropertyChange:!1,value:{obj:e}}),this.notify("draw",{prop:"redrawDownScale"}),e.shapeDetailsColl.filter(function(e){return"redact"!==e.type})},D.prototype.selectRedact=function(e){this.applyShapes();var t={isSelected:!1};return this.notify("shape",{prop:"selectShape",onPropertyChange:!1,value:{id:e,obj:t,isRedact:!0}}),this.editCompleted("redact-select"),this.noRedact=!1,t.isSelected},D.prototype.deleteRedact=function(e){this.applyShapes(),this.notify("shape",{prop:"deleteShape",onPropertyChange:!1,value:{id:e,isRedact:!0}}),this.editCompleted("redact-delete")},D.prototype.updateRedact=function(e,t){this.applyShapes();var o,i={isSelected:!1};return this.notify("shape",{prop:"selectShape",onPropertyChange:!1,value:{id:e.id,obj:i,isRedact:!0}}),i.isSelected&&(this.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e}}),e.blurIntensity&&(this.activeObj.redactBlur=e.blurIntensity),e.pixelSize&&(this.activeObj.redactPixelate=e.pixelSize),this.activeObj.redactType="blur"===e.type.toLowerCase()?"blur":"pixelate",o=T.extend({},this.activeObj,{},!0),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:null}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),o.shape&&this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o}}),this.okBtn(t,!0),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.editCompleteArgs={action:"redact-update",currentShapeSettings:e},this.editCompleted("redact-customize"),t)&&this.selectRedact(e.id),i.isSelected},D.prototype.update=function(){this.notify("transform",{prop:"update"})},D.prototype.finetuneImage=function(e,t){!this.disabled&&this.isImageLoaded&&(this.manageActiveAction(),this.notify("filter",{prop:"finetuneImage",value:{value:t,option:e}}),this.editCompleteArgs={finetune:e,value:t},this.editCompleted("fine-tune"))},D.prototype.applyImageFilter=function(e){!this.disabled&&this.isImageLoaded&&(this.manageActiveAction(),this.notify("filter",{prop:"applyImageFilter",value:{option:e.toString()}}),this.editCompleteArgs={filter:e},this.editCompleted("filter"),this.canvasFilter=this.lowerContext.filter,this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}))},D.prototype.undo=function(){this.manageActiveAction(),this.notify("undo-redo",{prop:"undo",onPropertyChange:!1}),this.notify("draw",{prop:"redrawDownScale"})},D.prototype.redo=function(){this.manageActiveAction(),this.notify("undo-redo",{prop:"redo",onPropertyChange:!1}),this.notify("draw",{prop:"redrawDownScale"})},D.prototype.getImageDimension=function(){return{x:this.img.destLeft,y:this.img.destTop,width:this.img.destWidth,height:this.img.destHeight}},D.prototype.resize=function(e,t,o){var i,r,n,a,s,l,p=!1;return e.toString().length<=4&&t.toString().length<=4&&(!this.isCircleCrop||o)&&(this.manageActiveAction(),this.notify("toolbar",{prop:"resizeClick",value:{bool:!1}}),i=this.img.destLeft,r=this.img.destTop,n=this.img.destWidth,a=this.img.destHeight,o&&this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:!1,isCropping:!1}}),this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:!1,isCropping:!1}}),s=this.element.querySelector("#"+this.element.id+"_resizeWidth"),l=this.element.querySelector("#"+this.element.id+"_resizeHeight"),s&&l&&(T.getComponent(s,"numerictextbox").value=Math.floor(e),s.value=Math.floor(e).toString()+" px",T.getComponent(l,"numerictextbox").value=Math.floor(t),l.value=Math.floor(t).toString()+" px"),this.notify("transform",{prop:"resize",value:{width:e,height:t,isAspectRatio:o}}),i!==this.img.destLeft||r!==this.img.destTop||n!==this.img.destWidth||a!==this.img.destHeight?(p=!0,this.aspectWidth=e,this.aspectHeight=t,o&&(this.aspectHeight=null),this.okBtn(!1,!1,!0)):this.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}),this.notify("draw",{prop:"redrawDownScale"})),p},D.prototype.drawFrame=function(e,t,o,i,r,n,a,s,l){this.manageActiveAction();var p=!1,h={frameChangeEventArgs:null},d=(t=t||"#fff",o=o||"",i=i||20,r=r||0,n=n||0,a=a||0,s=s||m.FrameLineStyle.Solid,l=l||0,{type:this.toPascalCase(this.frameObj.type),color:this.frameObj.color,gradientColor:this.frameObj.gradientColor,size:this.frameObj.size,inset:this.frameObj.inset,offset:this.frameObj.offset,borderRadius:this.frameObj.radius,frameLineStyle:this.toPascalCase(this.frameObj.border),lineCount:this.frameObj.amount}),e=(T.extend(this.tempFrameObj,this.frameObj),this.tempFrameZoomLevel=this.transform.zoomFactor,this.frameDestPoints=T.extend({},this.img,{},!0),this.notify("toolbar",{prop:"frameToolbarClick"}),this.frameObj.type=e.toLowerCase(),this.frameObj.color=t,this.frameObj.gradientColor=o,this.frameObj.size=i,this.frameObj.inset=r,this.frameObj.offset=n,this.frameObj.radius=a,this.frameObj.border=s.toLowerCase(),this.frameObj.amount=l,this.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:d,obj:h}}),h.frameChangeEventArgs&&!h.frameChangeEventArgs.cancel?(this.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),JSON.stringify(this.frameObj)!==JSON.stringify(this.tempFrameObj)?(p=!0,this.okBtn()):this.tempFrameZoomLevel=null):(this.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}),T.extend(this.frameObj,this.tempFrameObj),this.tempFrameZoomLevel=null),this.notify("draw",{prop:"redrawDownScale"}),this.element.querySelector(".e-contextual-toolbar-wrapper"));return e&&e.classList.add("e-hide"),p},D.prototype.straightenImage=function(e){var t=!1;return-45<=e&&e<=45&&(this.applyShapes(),t=!0,this.notify("transform",{prop:"straightenImage",value:{degree:e}}),this.notify("draw",{prop:"redrawDownScale"})),t},D.prototype.cloneShape=function(e){var t={isSelected:!1};return"shape"===e.split("_")[0]&&(this.notify("shape",{prop:"selectShape",onPropertyChange:!1,value:{id:e,obj:t}}),t.isSelected)&&(this.notify("toolbar",{prop:"duplicateShape",onPropertyChange:!1,value:{isPreventUndoRedo:!1}}),this.okBtn(null,!0),this.notify("draw",{prop:"redrawDownScale"})),t.isSelected},D.prototype.getImageFilter=function(e){var t=this.createElement("canvas").getContext("2d");return this.notify("filter",{prop:"updateAdj",value:{type:e.toLowerCase(),value:null,isPreview:!0,ctx:t}}),t.filter},D.prototype.enableTextEditing=function(){var e=T.extend({},this.activeObj,{},!0);e.order||(this.noPushUndo=!0,this.okBtn(),this.noPushUndo=!1,this.noRedact=!0,this.selectShape(e.currIndex),e.order=this.activeObj.order),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!1}}),this.activeObj=e,this.notify("toolbar",{prop:"editText",onPropertyChange:!1})},D.prototype.canUndo=function(){var e=!1;return e=0<this.getUndoRedoColl().index?!0:e},D.prototype.canRedo=function(){var e=!1,t=this.getUndoRedoColl(),o=t.undoRedoColl,t=t.index;return o&&0<o.length&&t<o.length-1&&(e=!0),t===o.length?e=!1:(0===t&&0<o.length||0<t)&&(e=!0),e},D.prototype.apply=function(){this.isMaskImage?this.discard():(this.updateColl("reset"),this.closeOverlayTbar(),this.okBtn(null,!0))},D.prototype.discard=function(){this.updateColl("reset"),this.notify("draw",{prop:"performCancel",value:{isContextualToolbar:this.closeOverlayTbar(),isFinalCancel:!0}})},D.prototype.enableShapeDrawing=function(e,t){this.manageActiveAction(),t&&(this.drawingShape=e.toLowerCase(),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1})),e&&t?(this.currObjType.shape=e.toLowerCase(),this.activeObj.shape=this.currObjType.shape,this.currObjType.isDragging=this.currObjType.isCustomCrop=!1,this.activeObj.shapeDegree=this.transform.degree,this.activeObj.shapeFlip=this.transform.currFlipState,this.activeObj.textFlip=this.transform.currFlipState,this.activeObj.flipObjColl=[],this.notify("shape",{prop:"getNewOrder",onPropertyChange:!(e={order:null}),value:{obj:e}}),this.activeObj.order=e.order,this.notify("selection",{prop:"annotate",value:{shape:this.currObjType.shape}}),"text"===this.currObjType.shape?this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):"redact"===this.currObjType.shape?this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"redact",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),this.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1})):t||this.okBtn(null,!0)},D.prototype.bringToFront=function(e){this.noRedact=!0,this.selectShape(e)&&(this.updateShapeOrder(e,"bringToFront"),this.apply())},D.prototype.bringForward=function(e){this.noRedact=!0,this.selectShape(e)&&(this.updateShapeOrder(e,"bringForward"),this.apply())},D.prototype.sendToBack=function(e){this.noRedact=!0,this.selectShape(e)&&(this.updateShapeOrder(e,"sendToBack"),this.apply())},D.prototype.sendBackward=function(e){this.noRedact=!0,this.selectShape(e)&&(this.updateShapeOrder(e,"sendBackward"),this.apply())},D.prototype.clearImage=function(){this.reset(),this.isImageLoaded=!1,this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height);var e=document.getElementById(this.element.id+"_bottomToolbar"),e=(T.Browser.isDevice&&e&&(document.getElementById(this.element.id+"_bottomToolbar").style.display="none"),this.notify("toolbar",{prop:"destroy-top-toolbar",onPropertyChange:!1}),this.notify("toolbar",{prop:"create-toolbar",onPropertyChange:!1}),this.notify("toolbar",{prop:"create-contextual-toolbar",onPropertyChange:!1}),document.getElementById(this.element.id+"_dropArea"));e&&(e.style.display="block")},D.prototype.selectMaskImage=function(e,t){e=e||10,t=t||"#512da880",this.applyShapes(),this.isMaskImage=!0,this.updateColl("empty"),this.enableDisableToolbar(!0),this.update(),this.activeObj.strokeSettings.strokeWidth=e,this.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:e}}),this.activeObj.strokeSettings.strokeColor=t,this.notify("freehand-draw",{prop:"freeHandDraw",onPropertyChange:!1,value:{value:!0}}),this.maskCanvas.style.display="block"},D.prototype.enableDisableToolbar=function(e){var t,o=document.getElementById(this.element.id+"_toolbar");o&&(t=T.getComponent(o,"toolbar"))&&t.disable(e),(o=document.getElementById(this.element.id+"_bottomToolbar"))&&(t=T.getComponent(o,"toolbar"))&&t.disable(e)},D.prototype.updateImage=function(e,t){var o,i,r,n=this;(e||t||""===t)&&(o=T.extend({},this.cropObj,{},!0),this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(r={currObj:{}}),value:{object:r}}),(i=r.currObj).objColl=T.extend([],this.objColl,[],!0),i.pointColl=T.extend([],this.pointColl,[],!0),i.afterCropActions=T.extend([],this.afterCropActions,[],!0),this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(r={selPointColl:null}),value:{obj:r}}),i.selPointColl=T.extend([],r.selPointColl,[],!0),e&&(this.isImageUpdated=!0,"string"!=typeof e&&((r=this.createElement("canvas")).width=e.width,r.height=e.height,r.getContext("2d").putImageData(e,0,0),e=r.toDataURL()),this.baseImg.src=e,setTimeout(function(){0!==n.cropObj.straighten?(n.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-custom"}}),n.noPushUndo=!0,n.crop(),n.noPushUndo=!1):n.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),n.isImageUpdated=!1,t||(n.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"updateImage",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),n.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}))},100)),!t&&""!==t||(this.notify("draw",{prop:"imageBackgroundColor",onPropertyChange:!1,value:{color:t}}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),e)||(this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"bgColor",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})),e)&&t&&(this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"updateImage",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}))},D.prototype.editCompleted=function(e){this.notify("draw",{prop:"redrawDownScale"});e={action:e||"shape-insert",actionEventArgs:this.editCompleteArgs};this.triggerEditCompleteEvent(e)},D.prototype.updateColl=function(e){this.isMaskImage&&("empty"===e?(this.tempToolbarHeight=this.toolbarHeight,this.tempToolbar=this.toolbar?T.extend([],this.toolbar,[],!0):null,this.tempObjColl=T.extend([],this.objColl,[],!0),this.tempPointColl=T.extend([],this.pointColl,[],!0),this.tempShapeColl=T.extend([],this.shapeColl,[],!0),this.objColl=[],this.pointColl=[],this.shapeColl=[],this.freehandCounter=0,this.notify("freehand-draw",{prop:"setCurrentFreehandDrawIndex",value:{value:0}}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}})):"reset"===e&&(this.objColl=this.tempObjColl,this.pointColl=this.tempPointColl,this.shapeColl=this.tempShapeColl,this.freehandCounter=this.pointColl.length,this.notify("freehand-draw",{prop:"setCurrentFreehandDrawIndex",value:{value:this.freehandCounter}}),this.enableDisableToolbar(!1),0!==this.cropObj.straighten&&(this.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-custom"}}),this.noPushUndo=!0,this.crop(),this.noPushUndo=!1),this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),this.isMaskImage=!1,this.upperContext.globalCompositeOperation="source-over",this.maskCanvas.style.display="none",this.activeObj.strokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,radius:null,outlineColor:"",outlineWidth:null},this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:this.activeObj.strokeSettings,strokeColor:"#fff",fillColor:"",strokeWidth:null,outlineWidth:null}}),this.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:2}}),this.notify("freehand-draw",{prop:"setMasking",onPropertyChange:!1,value:{value:!1}})))},D.prototype.resetToolbar=function(){this.toolbarHeight!==this.tempToolbarHeight&&!(T.isNullOrUndefined(this.toolbar)||this.toolbar&&0<this.toolbar.length)&&T.isNullOrUndefined(this.toolbarTemplate)&&(this.toolbarHeight=this.tempToolbarHeight,this.notify("toolbar",{prop:"setToolbarHeight",value:{height:this.toolbarHeight}}),this.toolbar=this.tempToolbar,this.toolbarTemplate||(this.notify("toolbar",{prop:"create-toolbar",onPropertyChange:!1}),this.notify("toolbar",{prop:"create-contextual-toolbar",onPropertyChange:!1})),this.update())},D.prototype.getData=function(e){e&&this.resetToolbar();var t=T.extend([],this.objColl,null,!0),o=T.extend([],this.pointColl,null,!0),i=T.extend([],this.shapeColl,null,!0);if(e){this.notify("shape",{prop:"updateShapeColl",onPropertyChange:!1});for(var r=0;r<this.freehandCounter;r++)this.pointColl[r].strokeColor="#fff"}else this.objColl=[],this.pointColl=[],this.shapeColl=[],this.freehandCounter=0;var n,a,s,l=this.frameObj.type,p=(this.frameObj.type="none",this.aspectWidth),h=this.aspectHeight,d=(this.aspectWidth=this.aspectHeight=null,this.cropObj.straighten),c=(this.togglePen=!1,this.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-custom"}}),T.extend({},this.img,{},!0)),u=T.extend({},this.cropObj,{},!0),g=T.extend({},this.activeObj,{},!0),v=T.extend({},this.transform,{},!0),f=T.extend({},this.panPoint,{},!0),C=(0!==d&&this.setStraighten(0),this.activeObj.activePoint),C=(C.startX=this.img.destLeft,C.startY=this.img.destTop,C.width=this.img.destWidth,C.height=this.img.destHeight,C.endX=C.startX+C.width,C.endY=C.startY+C.height,this.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:C,obj:this.activeObj,isMouseMove:null,x:null,y:null}}),this.noPushUndo=!0,this.crop(),this.noPushUndo=!1,this.isCropTab=!1,this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.notify("crop",{prop:"resetZoom",onPropertyChange:!1}),this.isCropTab=!0,T.extend([],this.afterCropActions,[],!0)),b=T.extend([],this.rotateFlipColl,[],!0),m=(this.notify("crop",{prop:"revertTransform",value:{type:"initial",coll:b}}),this.getImageData());return e&&(a=(n=this.createElement("canvas")).getContext("2d"),n.width=m.width,n.height=m.height,a.fillRect(0,0,n.width,n.height),0<this.pointColl.length&&(this.notify("crop",{prop:"calcRatio",onPropertyChange:!(s={width:0,height:0}),value:{obj:s,dimension:{width:n.width,height:n.height}}}),this.notify("export",{prop:"drawAnnotation",value:{context:a,ratio:s}})),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),m=a.getImageData(0,0,n.width,n.height)),this.notify("crop",{prop:"revertTransform",value:{type:"reverse",coll:b}}),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.afterCropActions=C,e||(this.objColl=t,this.pointColl=o,this.shapeColl=i,this.freehandCounter=this.pointColl.length),this.frameObj.type=l,this.aspectWidth=p,this.aspectHeight=h,this.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-custom"}}),0!==d&&this.setStraighten(d),this.img=c,this.cropObj=u,this.activeObj=g,this.transform=v,this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null,isResize:null}}),this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null,isResize:null}}),0!==this.transform.degree&&(this.panPoint.currentPannedPoint={x:f.totalPannedClientPoint.x,y:f.totalPannedClientPoint.y},this.notify("transform",{prop:"drawPannedImage",value:{xDiff:f.totalPannedClientPoint.x,yDiff:f.totalPannedClientPoint.y}}),this.panPoint.currentPannedPoint={x:0,y:0},this.notify("transform",{prop:"setTempPanMove",value:{point:null}})),this.noPushUndo=!0,this.crop(),this.noPushUndo=!1,this.transform.straighten=0,this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),m},D.prototype.applyShapes=function(){var e;!this.isUndoRedoStack&&(this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!(e={bool:!1}),value:{obj:e}}),e.bool||this.togglePen||this.activeObj.shape&&-1!==["rectangle","ellipse","line","arrow","path","text","image"].indexOf(this.activeObj.shape)||this.drawingShape)&&this.okBtn(null,!0)},D.prototype.closeOverlayTbar=function(){var e=!1,t={bool:null};return this.notify("toolbar",{prop:"getFrameToolbar",onPropertyChange:!1,value:{obj:t}}),!t.bool&&this.element.querySelector(".e-contextual-toolbar-wrapper")&&(this.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")||(e=!0),t=this.isStraightening,T.Browser.isDevice&&(!T.Browser.isDevice||t)||this.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide")),e},D.prototype.toolbarTemplateFn=function(){var e,t=this.element.id+"_toolbar",o=this.element.querySelector("#"+this.element.id+"_toolbarArea");this.toolbarTemplate&&(this.toolbarFn=this.templateParser(this.toolbarTemplate),e=!this.isReact&&this.isAngular?3===(e=this.toolbarFn({type:"toolbar"},this,"Template",t))[0].nodeType?e[1]:e[0]:this.toolbarFn({type:"toolbar"},this,"Template",t)[0],o.appendChild(e),this.toolbarHeight=o.clientHeight,this.notify("toolbar",{prop:"setToolbarHeight",value:{height:this.toolbarHeight}}),this.renderReactTemplates())},D.prototype.quickAccessToolbarTemplateFn=function(){var e,t=this.element.id+"_quickAccessToolbar",o=this.element.querySelector("#"+this.element.id+"_quickAccessToolbarArea");this.quickAccessToolbarTemplate&&(this.qatFn=this.templateParser(this.quickAccessToolbarTemplate),e=!this.isReact&&this.isAngular?3===(e=this.qatFn({type:"toolbar"},this,"Template",t))[0].nodeType?e[1]:e[0]:this.qatFn({type:"toolbar"},this,"Template",t)[0],o.appendChild(e),this.renderReactTemplates())},D.prototype.templateParser=function(t){if(t)try{return"function"!=typeof t&&document.querySelectorAll(t).length?T.compile(document.querySelector(t).innerHTML.trim()):T.compile(t)}catch(e){return T.compile(t)}},D.prototype.getTextFromId=function(e){return{1:"none",2:"bar",3:"arrow",4:"arrowSolid",5:"circle",6:"circleSolid",7:"square",8:"squareSolid"}[""+e]},D.prototype.getFinetuneOption=function(e){return{brightness:m.ImageFinetuneOption.Brightness,contrast:m.ImageFinetuneOption.Contrast,hue:m.ImageFinetuneOption.Hue,saturation:m.ImageFinetuneOption.Saturation,opacity:m.ImageFinetuneOption.Opacity,blur:m.ImageFinetuneOption.Blur,exposure:m.ImageFinetuneOption.Exposure}[""+e]},D.prototype.setPenStroke=function(e){this.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:parseInt(e,10)}})},D.prototype.updateFreehandDrawColorChange=function(){var e={tempFreeHandDrawEditingStyles:null};this.notify("freehand-draw",{prop:"getTempFreeHandDrawEditingStyles",value:{obj:e}}),this.notify("freehand-draw",{prop:"color-change",value:{color:e.tempFreeHandDrawEditingStyles.strokeColor}})},D.prototype.getUndoRedoColl=function(){var e={undoRedoColl:null,index:null},t={undoRedoStep:null},o={appliedUndoRedoColl:[]};return this.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:o}}),this.notify("undo-redo",{prop:"getUndoRedoStep",value:{obj:t}}),e.undoRedoColl=o.appliedUndoRedoColl,e.index=t.undoRedoStep,e},D.prototype.updateImageTransformColl=function(e){var t;"rotateleft"===e?t=-90:"rotateright"===e?t=90:"horizontalflip"===e?t="horizontal":"verticalflip"===e&&(t="vertical");for(var o=0;o<this.objColl.length;o++){var i=this.objColl[o].shape;"image"!==i&&"text"!==i||(T.isNullOrUndefined(this.objColl[o].rotateFlipColl)&&(this.objColl[o].rotateFlipColl=[]),this.objColl[o].rotateFlipColl.push(t),i={collection:this.objColl[o].rotateFlipColl},this.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:this.objColl[o].rotateFlipColl,isRotateFlipCollection:!1,obj:i}}),this.objColl[o].rotateFlipColl=i.collection)}},D.prototype.setInitialZoomState=function(){this.objColl.push(this.activeObj),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1});var e=this.isUndoRedo;this.isCropTab=!1,this.isUndoRedo=!0,this.transform.cropZoomFactor&&0<this.transform.cropZoomFactor?this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-this.transform.cropZoomFactor,zoomPoint:null,isResize:!0}}):this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:Math.abs(this.transform.cropZoomFactor),zoomPoint:null,isResize:!0}}),this.isUndoRedo=e,this.panPoint.totalPannedPoint={x:0,y:0},this.transform.cropZoomFactor=0,this.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),this.activeObj=T.extend({},this.objColl[this.objColl.length-1],{},!0),this.objColl.pop(),this.isCropTab=!0,this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:this.activeObj}})},D.prototype.updateCropTransformItems=function(){this.prevCurrSelectionPoint=T.extend({},this.currSelectionPoint,{},!0),this.notify("draw",{prop:"updateCropSelection",onPropertyChange:!1})},D.prototype.toPascalCase=function(e,t){var o=[];T.isNullOrUndefined(e)||(o=e.toLowerCase().split("-"));for(var i=0;i<o.length;i++)o[i]=o[i].charAt(0).toUpperCase()+o[i].slice(1);return t&&(t.maxText=o.join("")),o.join("")},D.prototype.getFontSizes=function(){var e=[];this.fontSizeColl=[];for(var t=0===this.transform.degree||this.transform.degree%180==0?this.img.destWidth/25:this.img.destHeight/25,o=1;o<=10;o++)this.fontSizeColl.push({text:(o*Math.round(t/2)).toString()}),e.push({text:o.toString()});return e},D.prototype.updateDropInfoContent=function(e){var t,o,i,r,n;e&&(this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!(t={key:"SupportText"}),value:{obj:t}}),o=this.getExtensionString(),this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!(i={key:"MinMaxSize"}),value:{obj:i}}),this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!(r={key:"And"}),value:{obj:r}}),this.uploadSettings.minFileSize&&this.uploadSettings.maxFileSize?n=" "+i.value+" "+this.formatSizeUnits(this.uploadSettings.minFileSize)+" "+r.value+" "+this.formatSizeUnits(this.uploadSettings.maxFileSize):this.uploadSettings.minFileSize?(i.key="MinSize",this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:i}}),n=" "+i.value+" "+this.formatSizeUnits(this.uploadSettings.minFileSize)):this.uploadSettings.maxFileSize&&(i.key="MaxSize",this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:i}}),n=" "+i.value+" "+this.formatSizeUnits(this.uploadSettings.maxFileSize)),e.textContent=n?t.value+o+n:t.value+o)},D.prototype.okBtn=function(e,t,o){t&&(this.noPushUndo=!1,this.notify("selection",{prop:"setTempActObj",onPropertyChange:!1,value:{obj:{activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],order:null}}}));var i,r=this.element.querySelector(".e-contextual-toolbar-wrapper"),r=(r&&r.classList.remove("e-frame-wrapper"),!1),n=(this.isResizeOkBtn=!0,this.element.querySelector("#"+this.element.id+"_aspectratio")),a=this.element.querySelector("#"+this.element.id+"_nonaspectratio"),s=this.element.querySelector(".e-ie-toolbar-aspect-ratio-btn"),l=this.element.querySelector(".e-ie-toolbar-nonaspect-ratio-btn"),p=((void 0===(i=void 0!==this.activeObj.shape?this.activeObj.shape.split("-"):i)&&this.currObjType.isCustomCrop||void 0!==i&&"crop"===i[0])&&(r=!0),this.allowDownScale=!0,(this.activeObj.shape&&"image"!==this.activeObj.shape||this.togglePen)&&!r&&(this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!(i={shapeSettingsObj:{}}),value:{obj:i}}),i=i.shapeSettingsObj,this.togglePen&&(i.type=m.ShapeType.FreehandDraw),i={action:"apply",currentShapeSettings:T.extend({},i,{},!0)},this.currObjType.isRedact||!t&&!this.isShapeDrawing||(this.isShapeDrawing&&(i.action="draw-end"),this.trigger("shapeChange",i)),this.editCompleteArgs=i,this.currObjType.isRedact)&&(this.currObjType.isRedact=!1),n||a?(this.notify("selection",{prop:"getNumTextValue",onPropertyChange:!(i={width:null,height:null}),value:{obj:i}}),h={prevCropObj:this.prevCropObj},p={prevObj:this.prevObj},(i={x:i.width,y:i.height}).x&&i.y&&h.prevCropObj&&p.prevObj?(a||l&&!l.classList.contains("e-hidden")?this.notify("transform",{prop:"resize",value:{width:i.x,height:i.y,isAspectRatio:!1}}):(n||s&&!s.classList.contains("e-hidden"))&&this.notify("transform",{prop:"resize",value:{width:i.x,height:null,isAspectRatio:!0}}),this.isResize=!1,this.aspectWidth=i.x,this.aspectHeight=i.y,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:!1,isZooming:null,cType:null}}),this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-this.transform.zoomFactor,zoomPoint:null,isResize:!0}}),this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:p.prevObj.defaultZoom,zoomPoint:null,isResize:!0}}),p.prevObj.zoomFactor&&this.setProperties({zoomSettings:{zoomFactor:p.prevObj.zoomFactor}},!0),this.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:this.zoomSettings.zoomFactor}}),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"resize",previousObj:p.prevObj,previousObjColl:p.prevObj.objColl,previousPointColl:p.prevObj.pointColl,previousSelPointColl:p.prevObj.selPointColl,previousCropObj:h.prevCropObj,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),!(l=this.cancelCropSelection)||!T.isNullOrUndefined(a)&&a||(l.previousObj.aspectWidth=l.currentObj.aspectWidth=this.aspectWidth,l.previousObj.aspectHeight=l.currentObj.aspectHeight=this.aspectHeight,l.previousCropObj=T.extend({},this.cropObj,{},!0),l.currentCropObj=T.extend({},this.cropObj,{},!0),this.notify("draw",{prop:"updateCropSelObj"})),this.cancelCropSelection=null):0===i.x||0===i.y?this.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}):this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:!1,isZooming:null,cType:null}}),this.isAspectRatio=!1):o&&(n=!1,this.aspectWidth&&this.aspectHeight?this.notify("transform",{prop:"resize",value:{width:this.aspectWidth,height:this.aspectHeight,isAspectRatio:!1}}):this.aspectWidth&&(this.notify("transform",{prop:"resize",value:{width:this.aspectWidth,height:null,isAspectRatio:!0}}),this.aspectHeight=this.aspectWidth/(this.img.destWidth/this.img.destHeight),n=!0),this.isResize=!1,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:!1,isZooming:null,cType:null}}),this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-this.transform.zoomFactor,zoomPoint:null,isResize:!0}}),this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:this.prevObj.defaultZoom,zoomPoint:null,isResize:!0}}),this.prevObj.zoomFactor&&this.setProperties({zoomSettings:{zoomFactor:this.prevObj.zoomFactor}},!0),this.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:this.zoomSettings.zoomFactor}}),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"resize",previousObj:this.prevObj,previousObjColl:this.prevObj.objColl,previousPointColl:this.prevObj.pointColl,previousSelPointColl:this.prevObj.selPointColl,previousCropObj:this.prevCropObj,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),(s=this.cancelCropSelection)&&n&&(s.previousObj.aspectWidth=s.currentObj.aspectWidth=this.aspectWidth,s.previousObj.aspectHeight=s.currentObj.aspectHeight=this.aspectHeight,s.previousCropObj=T.extend({},this.cropObj,{},!0),s.currentCropObj=T.extend({},this.cropObj,{},!0),this.notify("draw",{prop:"updateCropSelObj"})),this.cancelCropSelection=null,this.isAspectRatio=!1),this.element.querySelector(".e-contextual-toolbar-wrapper .e-toolbar-item.e-selected")),h={bool:!1},a=(this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:h}}),this.notify("toolbar",{prop:"getFrameToolbar",onPropertyChange:!1,value:{obj:{bool:null}}}),document.querySelector("#"+this.element.id+"_sliderWrapper"));p&&(this.currentFilter=p.children[0].children[0].id.replace("Canvas","")),r?(0===this.transform.straighten||0===this.panPoint.totalPannedPoint.x&&0===this.panPoint.totalPannedPoint.y&&0===this.panPoint.totalPannedClientPoint.x&&0===this.panPoint.totalPannedClientPoint.y||(l=this.prevStraightenedDegree,this.prevStraightenedDegree=this.transform.straighten,this.setStraighten(this.transform.straighten-3),this.setStraighten(this.transform.straighten+3),this.prevStraightenedDegree=l),this.isCroppedEvent=this.crop()):this.togglePen?(this.freeHandDraw(!1),this.isMaskImage||(this.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!(i={penStrokeWidth:null}),value:{obj:i}}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),this.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:i.penStrokeWidth}})),this.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),this.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}})):"block"===this.textArea.style.display||"inline-block"===this.textArea.style.display?(this.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),T.isNullOrUndefined(e)&&this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),this.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),this.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}})):!a&&!this.currObjType.isFiltered||this.drawingShape||"redact"===this.activeObj.shape?h.bool?(this.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!1}}),this.notify("toolbar",{prop:"destroy-qa-toolbar"}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),this.notify("freehand-draw",{prop:"resetFreehandDrawSelectedId",onPropertyChange:!1})):0!==this.activeObj.activePoint.width||0!==this.activeObj.activePoint.height||"path"===this.activeObj.shape&&0<this.activeObj.pointColl.length?("image"===this.activeObj.shape&&this.notify("draw",{prop:"setImageApply",onPropertyChange:!1,value:{bool:!0}}),this.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}})):(JSON.stringify(this.frameObj)!==JSON.stringify(this.tempFrameObj)&&(this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(o={currObj:{}}),value:{object:o}}),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:o.currObj,previousObjColl:o.currObj.objColl,previousPointColl:o.currObj.pointColl,previousSelPointColl:o.currObj.selPointColl,previousCropObj:T.extend({},this.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),n={type:this.toPascalCase(this.frameObj.type),color:this.frameObj.color,gradientColor:this.frameObj.gradientColor,size:this.frameObj.size,inset:this.frameObj.inset,offset:this.frameObj.offset,borderRadius:this.frameObj.radius,frameLineStyle:this.toPascalCase(this.frameObj.border),lineCount:this.frameObj.amount},s={type:this.toPascalCase(this.tempFrameObj.type),color:this.tempFrameObj.color,gradientColor:this.tempFrameObj.gradientColor,size:this.tempFrameObj.size,inset:this.tempFrameObj.inset,offset:this.tempFrameObj.offset,borderRadius:this.tempFrameObj.radius,frameLineStyle:this.toPascalCase(this.tempFrameObj.border),lineCount:this.tempFrameObj.amount},this.editCompleteArgs={cancel:!1,previousFrameSetting:s,currentFrameSetting:n},this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),this.tempFrameObj=T.extend({},this.frameObj,{},!0)),this.notify("draw",{prop:"resetFrameZoom",onPropertyChange:!1,value:{isOk:!0}})):(this.initialAdjustmentValue=this.canvasFilter=this.lowerContext.filter,this.currObjType.isFiltered=!1,this.notify("draw",{prop:"getTempAdjustmentValue",value:{obj:{value:null}}}),a&&"Opacity"===a.parentElement.previousElementSibling.textContent||this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),(0!==this.activeObj.activePoint.width&&0!==this.activeObj.activePoint.height||"path"===this.activeObj.shape&&0<this.activeObj.pointColl.length)&&this.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}})),h.isCropToolbar||(this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:null,isZooming:null,cType:null}}),this.currObjType.isRedact=!1),this.notify("draw",{prop:"setNewPath",value:{bool:!1}}),this.transform.zoomFactor=this.transform.defaultZoomFactor,this.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),this.isResizeOkBtn=!1,this.notify("draw",{prop:"redrawDownScale"}),this.isChangesSaved=this.isFinetuneBtnClick=!1,t&&(this.drawingShape=null,this.notify("draw",{prop:"resetTempObjColl"}),this.notify("draw",{prop:"resetTempPointColl"}))},D.prototype.triggerEditCompleteEvent=function(e){"shape-insert"===e.action&&e.actionEventArgs&&e.actionEventArgs.currentShapeSettings&&"Redact"===e.actionEventArgs.currentShapeSettings.type.toString()&&(e.action="redact"),this.trigger("editComplete",e),this.editCompleteArgs=null},D.prototype.getObjFromId=function(e){var t;if(this.activeObj.currIndex&&this.activeObj.currIndex===e)t=T.extend({},this.activeObj,{},!0);else for(var o=0;o<this.shapeColl.length;o++)if((this.shapeColl[o].id||this.shapeColl[o].currIndex)===e){t=T.extend({},this.shapeColl[o],{},!0);break}return t},D.prototype.setTempFilterProperties=function(){this.upperCanvas.style.display="block",this.cropSelectedState();var e={adjustmentLevel:null},e=(this.notify("filter",{prop:"getAdjustmentLevel",onPropertyChange:!1,value:{obj:e}}),this.lowerContext.filter=this.initialAdjustmentValue,this.notify("draw",{prop:"setTempAdjustmentValue",value:{tempAdjustmentValue:this.lowerContext.filter}}),this.notify("filter",{prop:"setTempAdjustmentLevel",onPropertyChange:!1,value:{tempAdjustmentLevel:T.extend({},e.adjustmentLevel,{},!0)}}),this.notify("draw",{prop:"setTempFilter",value:{tempFilter:this.currentFilter}}),{undoRedoStep:null});this.notify("undo-redo",{prop:"getUndoRedoStep",value:{obj:e}}),this.notify("draw",{prop:"setTempUndoRedoStep",value:{tempUndoRedoStep:e.undoRedoStep}})},D.prototype.cropSelectedState=function(){this.activeObj.shape&&"crop"===this.activeObj.shape.split("-")[0]&&this.okBtn()},D.prototype.getCurrentCanvasData=function(){var e=T.extend({},this.frameObj,{},!0),t=(this.frameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},this.lowerContext.filter),o=(this.lowerContext.filter=this.canvasFilter="none",T.extend([],this.objColl,null,!0)),i=T.extend([],this.pointColl,null,!0),r=(this.objColl=[],this.pointColl=[],this.freehandCounter=0,this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),this.element.querySelector(".e-contextual-toolbar-wrapper")),n=(r&&r.classList.add("e-hide"),this.getImageData());return r&&r.classList.remove("e-hide"),T.Browser.isDevice||this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!0,isCropping:!1}}),this.element.querySelector("#"+this.element.id+"_contextualToolbarArea").classList.remove("e-hide"),this.objColl=o,this.pointColl=i,this.freehandCounter=i.length,this.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.lowerContext.filter=this.canvasFilter=t,this.frameObj=e,n},D.prototype.setCurrAdjustmentValue=function(e,t){var o={finetune:this.getFinetuneOption(e),value:t,cancel:!1};this.trigger("finetuneValueChanging",o),(this.editCompleteArgs=o).cancel||this.notify("filter",{prop:"setCurrAdjValue",value:{type:e.toLowerCase(),value:t}})},D.prototype.getSquarePointForPath=function(e){var t={startX:0,startY:0,endX:0,endY:0,width:0,height:0};if(0<e.pointColl.length){for(var t={startX:e.pointColl[0].x,startY:e.pointColl[0].y,endX:e.pointColl[0].x,endY:e.pointColl[0].y},o=1;o<e.pointColl.length;o++)e.pointColl[o].x<t.startX&&(t.startX=e.pointColl[o].x),e.pointColl[o].y<t.startY&&(t.startY=e.pointColl[o].y),e.pointColl[o].x>t.endX&&(t.endX=e.pointColl[o].x),e.pointColl[o].y>t.endY&&(t.endY=e.pointColl[o].y);t.width=t.endX-t.startX,t.height=t.endY-t.startY}return t},D.prototype.getSelectionType=function(e){var t={CropCustom:"Custom",CropSquare:"Square",CropCircle:"Circle","Crop3:2":"3:2","Crop4:3":"4:3","Crop5:4":"5:4","Crop7:5":"7:5","Crop16:9":"16:9","Crop2:3":"2:3","Crop3:4":"3:4","Crop4:5":"4:5","Crop5:7":"5:7","Crop9:16":"9:16"};return t[""+(e="crop-custom"===e?"CropCustom":e)]||e.split("Crop")[1]},D.prototype.clearContext=function(e){e.clearRect(0,0,e.canvas.width,e.canvas.height),e.clearRect(0,0,e.canvas.height,e.canvas.width)},D.prototype.updateArrow=function(e,t){var o=!1,i=this.objColl.length,i=(this.notify("shape",{prop:"pushActItemIntoObj"}),i!==this.objColl.length&&(o=!0),T.extend({},this.cropObj,{},!0)),r={currObj:{}},n={shapeSettingsObj:{}},n=(this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:n}}),n.shapeSettingsObj),r=(this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}}),r.currObj),o=(r.objColl=T.extend([],this.objColl,[],!0),r.pointColl=T.extend([],this.pointColl,[],!0),r.afterCropActions=T.extend([],this.afterCropActions,[],!0),o&&this.objColl.pop(),"startArrow"===e?this.activeObj.start=this.getTextFromId(t):"endArrow"===e&&(this.activeObj.end=this.getTextFromId(t)),this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth}}),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}),T.Browser.isDevice?document.getElementById(this.element.id+"_bottomToolbar")&&T.getComponent(this.element.id+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(this.element.id+"_toolbar")&&T.getComponent(this.element.id+"_toolbar","toolbar").refreshOverflow(),{action:e,currentShapeSettings:T.extend({},n,{},!0)});this.trigger("shapeChange",o),this.editCompleteArgs=o},D.prototype.updateFontFamily=function(e){this.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}});var t=!1,o=this.objColl.length,o=(this.notify("shape",{prop:"pushActItemIntoObj"}),o!==this.objColl.length&&(t=!0),T.extend([],this.objColl,[],!0)),i=T.extend({},this.cropObj,{},!0),r={shapeSettingsObj:{}},r=(this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:r}}),r.shapeSettingsObj),n={currObj:{}},n=(this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}}),n.currObj),a=(n.objColl=T.extend([],this.objColl,[],!0),n.pointColl=T.extend([],this.pointColl,[],!0),n.afterCropActions=T.extend([],this.afterCropActions,[],!0),{selPointColl:null}),a=(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),n.selPointColl=T.extend([],a.selPointColl,[],!0),t&&this.objColl.pop(),"block"===this.textArea.style.display||"inline-block"===this.textArea.style.display?(this.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:!0}}),a=this.activeObj.textSettings.fontFamily,this.activeObj.textSettings.fontFamily=this.toPascalCase(e),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.notify("shape",{prop:"redraw-text"}),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),t=this.activeObj.activePoint.width+.25*this.activeObj.textSettings.fontSize,this.textArea.style.width=t+"px",this.textArea.style.fontFamily=this.toPascalCase(e),this.activeObj.textSettings.fontFamily=a,this.notify("shape",{prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}})):(this.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:null}}),t=this.activeObj.textSettings.fontFamily=this.toPascalCase(e),this.notify("shape",{prop:"setTextSettings",onPropertyChange:!1,value:{textSettings:null,fontFamily:t,fontSize:null}}),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.notify("shape",{prop:"redraw-text"}),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:n,previousObjColl:o,previousPointColl:T.extend([],this.pointColl,[],!0),previousSelPointColl:n.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})),{action:"font-family",currentShapeSettings:T.extend({},r,{},!0)});a.currentShapeSettings.fontFamily=this.textArea.style.fontFamily,this.trigger("shapeChange",a),this.editCompleteArgs=a},D.prototype.updateFontSize=function(e){this.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}});var t,o,i,r=!1,n=this.objColl.length,n=(this.notify("shape",{prop:"pushActItemIntoObj"}),n!==this.objColl.length&&(r=!0),T.extend({},this.cropObj,{},!0)),a={shapeSettingsObj:{}},a=(this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:a}}),a.shapeSettingsObj),s={currObj:{}},s=(this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:s}}),s.currObj),l=(s.objColl=T.extend([],this.objColl,[],!0),s.pointColl=T.extend([],this.pointColl,[],!0),s.afterCropActions=T.extend([],this.afterCropActions,[],!0),{selPointColl:null}),r=(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),s.selPointColl=T.extend([],l.selPointColl,[],!0),r&&this.objColl.pop(),"block"===this.textArea.style.display||"inline-block"===this.textArea.style.display?(this.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:!0}}),l=this.activeObj.textSettings.fontSize,this.activeObj.textSettings.fontSize=parseInt(this.fontSizeColl[parseInt(e,10)-1].text,10),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:s,previousObjColl:s.objColl,previousPointColl:s.pointColl,previousSelPointColl:s.selPointColl,previousCropObj:n,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop(),r="","bold"===this.textArea.style.fontWeight&&(r="bold "),"italic"===this.textArea.style.fontStyle&&(r="italic "),"bold"===this.textArea.style.fontWeight&&"italic"===this.textArea.style.fontStyle&&(r="italic bold "),this.upperContext.font=r+this.activeObj.textSettings.fontSize+"px "+this.textArea.style.fontFamily,t=this.textArea.value.split("\n"),this.notify("shape",{prop:"getMaxText",onPropertyChange:!(o={maxText:""}),value:{isTextBox:!0,text:null,obj:o}}),r=o.maxText,i=this.upperContext.measureText(r).width+.5*this.activeObj.textSettings.fontSize,this.textArea.style.width=i+"px",this.textArea.style.height=t.length*(this.activeObj.textSettings.fontSize+.25*this.activeObj.textSettings.fontSize)+"px",this.activeObj.textSettings.fontSize=l,this.upperContext.font=this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily,this.textArea.style.fontSize=parseInt(this.fontSizeColl[parseInt(e,10)-1].text,10)+"px","georgia"===this.textArea.style.fontFamily&&(this.textArea.style.width=parseFloat(this.textArea.style.width)+parseFloat(this.textArea.style.fontSize)+"px")):(this.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:null}}),r=this.activeObj.textSettings.fontSize=parseInt(this.fontSizeColl[parseInt(e,10)-1].text,10),this.notify("shape",{prop:"setTextSettings",onPropertyChange:!1,value:{textSettings:null,fontFamily:null,fontSize:r}}),this.upperContext.font=this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily,t=this.activeObj.keyHistory.split("\n"),this.notify("shape",{prop:"getMaxText",onPropertyChange:!(o={maxText:""}),value:{isTextBox:null,text:null,obj:o}}),l=o.maxText,i=this.upperContext.measureText(l).width+.5*this.activeObj.textSettings.fontSize,e=t.length*(this.activeObj.textSettings.fontSize+.25*this.activeObj.textSettings.fontSize),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||(this.notify("selection",{prop:"setTextSelection",onPropertyChange:!1,value:{width:i,height:e}}),this.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:this.activeObj.activePoint,obj:this.activeObj,isMouseMove:null,x:null,y:null}}),this.notify("shape",{prop:"redraw-text"})),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:s,previousObjColl:s.objColl,previousPointColl:s.pointColl,previousSelPointColl:s.selPointColl,previousCropObj:n,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})),{action:"font-size",currentShapeSettings:T.extend({},a,{},!0)});r.currentShapeSettings.fontSize=this.activeObj.textSettings.fontSize,this.trigger("shapeChange",r),this.editCompleteArgs=r},D.prototype.updateFontColor=function(e,t){this.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}});var o=!1,i=this.objColl.length,i=(this.notify("shape",{prop:"pushActItemIntoObj"}),i!==this.objColl.length&&(o=!0),T.extend({},this.cropObj,{},!0)),r={shapeSettingsObj:{}},r=(this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:r}}),r.shapeSettingsObj),n={currObj:{}},n=(this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}}),n.currObj),a=(n.objColl=T.extend([],this.objColl,[],!0),n.pointColl=T.extend([],this.pointColl,[],!0),n.afterCropActions=T.extend([],this.afterCropActions,[],!0),{selPointColl:null}),o=(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),n.selPointColl=T.extend([],a.selPointColl,[],!0),o&&this.objColl.pop(),"none"===this.textArea.style.display?("Text"===t?(this.activeObj.strokeSettings.strokeColor=e,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:this.activeObj.strokeSettings.strokeColor,fillColor:null,strokeWidth:null}})):(this.activeObj.strokeSettings.fillColor=e,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:this.activeObj.strokeSettings.fillColor,strokeWidth:null}})),this.togglePen||0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}))):"block"===this.textArea.style.display||"inline-block"===this.textArea.style.display?(this.textArea.style["Text"===t?"color":"backgroundColor"]=e,a="Text"===t?this.activeObj.strokeSettings.strokeColor:this.activeObj.strokeSettings.fillColor,this.activeObj.strokeSettings["Text"===t?"strokeColor":"fillColor"]=e,0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop()),this.activeObj.strokeSettings["Text"===t?"strokeColor":"fillColor"]=a):this.togglePen||0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})),{action:"font-color",currentShapeSettings:T.extend({},r,{},!0)});o.currentShapeSettings.fillColor=e,this.trigger("shapeChange",o),this.editCompleteArgs=o},D.prototype.updateStrokeTextColor=function(e){this.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}});var t=!1,o=this.objColl.length,o=(this.notify("shape",{prop:"pushActItemIntoObj"}),o!==this.objColl.length&&(t=!0),T.extend({},this.cropObj,{},!0)),i={shapeSettingsObj:{}},i=(this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:i}}),i.shapeSettingsObj),r={currObj:{}},r=(this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}}),r.currObj),n=(r.objColl=T.extend([],this.objColl,[],!0),r.pointColl=T.extend([],this.pointColl,[],!0),r.afterCropActions=T.extend([],this.afterCropActions,[],!0),{selPointColl:null}),t=(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),r.selPointColl=T.extend([],n.selPointColl,[],!0),t&&this.objColl.pop(),"none"===this.textArea.style.display?(this.activeObj.strokeSettings.outlineColor=e,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:null,outlineColor:this.activeObj.strokeSettings.outlineColor}}),this.togglePen||0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}))):"block"===this.textArea.style.display||"inline-block"===this.textArea.style.display?(this.textArea.style.textShadow="-1px -1px 0 "+e+", 1px -1px 0 "+e+", -1px 1px 0 "+e+", 1px 1px 0 "+e,n=this.activeObj.strokeSettings.outlineColor,this.activeObj.strokeSettings.outlineColor=e,0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop()),this.activeObj.strokeSettings.outlineColor=n):this.togglePen||0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})),{action:"font-color",currentShapeSettings:T.extend({},i,{},!0)});t.currentShapeSettings.fillColor=e,this.trigger("shapeChange",t),this.editCompleteArgs=t},D.prototype.updatePenStrokeWidth=function(e){var t=T.extend([],this.pointColl,[],!0),o=(this.updateFreehandDrawColorChange(),T.extend({},this.cropObj,{},!0)),i={shapeSettingsObj:{}},i=(this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:i}}),i.shapeSettingsObj),r={currObj:{}},r=(this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}}),r.currObj),n=(r.objColl=T.extend([],this.objColl,[],!0),r.pointColl=T.extend([],this.pointColl,[],!0),r.afterCropActions=T.extend([],this.afterCropActions,[],!0),{selPointColl:null}),n=(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),r.selPointColl=T.extend([],n.selPointColl,[],!0),this.pointColl=t,this.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!0}}),this.setPenStroke(e),{bool:!1}),n=(this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:n}}),n.bool&&(this.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!(t={penStrokeWidth:null}),value:{obj:t}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:t.penStrokeWidth}}),this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!(e={freehandSelectedIndex:null}),value:{obj:e}}),this.pointColl[e.freehandSelectedIndex].strokeWidth=t.penStrokeWidth,this.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),this.notify("draw",{prop:"redrawDownScale"}),this.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:t.penStrokeWidth}}),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"freehanddrawCustomized",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})),i.type=m.ShapeType.FreehandDraw,{action:"stroke-width",currentShapeSettings:T.extend({},i,{},!0)});n.currentShapeSettings.strokeWidth=this.activeObj.strokeSettings.strokeWidth,this.trigger("shapeChange",n),this.editCompleteArgs=n},D.prototype.updatePenStrokeColor=function(e){var t=T.extend([],this.pointColl,[],!0),o=(this.updateFreehandDrawColorChange(),T.extend({},this.cropObj,{},!0)),i={shapeSettingsObj:{}},i=(this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:i}}),i.shapeSettingsObj),r={currObj:{}},r=(this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}}),r.currObj),n=(r.objColl=T.extend([],this.objColl,[],!0),r.pointColl=T.extend([],this.pointColl,[],!0),r.afterCropActions=T.extend([],this.afterCropActions,[],!0),{selPointColl:null}),n=(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),r.selPointColl=T.extend([],n.selPointColl,[],!0),this.pointColl=t,this.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!0}}),this.activeObj.strokeSettings.strokeColor=e,{freehandSelectedIndex:null}),t=(this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:n}}),null!=n.freehandSelectedIndex&&(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),this.notify("draw",{prop:"redrawDownScale"}),this.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}})),{bool:!1}),t=(this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:t}}),t.bool?(this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!(n={freehandSelectedIndex:null}),value:{obj:n}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.pointColl[n.freehandSelectedIndex].strokeColor=e,this.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:e}}),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"freehanddrawCustomized",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})):this.togglePen||this.notify("selection",{prop:"redrawShape",value:{obj:this.activeObj}}),i.type=m.ShapeType.FreehandDraw,{action:"stroke-color",currentShapeSettings:T.extend({},i,{},!0)});t.currentShapeSettings.strokeColor=e,this.trigger("shapeChange",t),this.editCompleteArgs=t},D.prototype.updateStrokeWidth=function(e,t,o){var i,r,n,a,s;this.activeObj.shape&&("path"!==this.activeObj.shape||"path"===this.activeObj.shape&&0<this.activeObj.pointColl.length)?(this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!(i={shapeSettingsObj:{}}),value:{obj:i}}),i=i.shapeSettingsObj,r=!1,n=this.objColl.length,this.notify("shape",{prop:"pushActItemIntoObj"}),n!==this.objColl.length&&(r=!0),n=T.extend({},this.cropObj,{},!0),this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(a={currObj:{}}),value:{object:a}}),(a=a.currObj).objColl=T.extend([],this.objColl,[],!0),a.pointColl=T.extend([],this.pointColl,[],!0),a.afterCropActions=T.extend([],this.afterCropActions,[],!0),this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(s={selPointColl:null}),value:{obj:s}}),a.selPointColl=T.extend([],s.selPointColl,[],!0),r&&this.objColl.pop(),this.activeObj.strokeSettings["width"===t?"text"===o?"outlineWidth":"strokeWidth":"radius"]=parseInt(e,10),"rectangle"!==this.activeObj.shape&&"ellipse"!==this.activeObj.shape||(this.activeObj.strokeSettings["width"===t?"text"===o?"outlineWidth":"strokeWidth":"radius"]=parseInt(e,10)-1),this.activeObj.strokeSettings["width"===t?"text"===o?"outlineWidth":"strokeWidth":"radius"]*=2,"width"===t?"text"===o?this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:null,radius:null,outlineWidth:this.activeObj.strokeSettings.outlineWidth}}):this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth,radius:null,outlineWidth:null}}):this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:null,radius:this.activeObj.strokeSettings.radius}}),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:n,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}),(s={action:"stroke-width",currentShapeSettings:T.extend({},i,{},!0)}).currentShapeSettings["width"===t?"text"===o?"outlineWidth":"strokeWidth":"radius"]=this.activeObj.strokeSettings["width"===t?"text"===o?"outlineWidth":"strokeWidth":"radius"],this.trigger("shapeChange",s),this.editCompleteArgs=s):this.activeObj.shape&&"path"===this.activeObj.shape&&0===this.activeObj.pointColl.length&&(this.activeObj.strokeSettings.strokeWidth=parseInt(e,10),this.activeObj.strokeSettings.strokeWidth*=2,"width"===t?"text"===o?this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:null,radius:null,outlineWidth:this.activeObj.strokeSettings.outlineWidth}}):this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth,radius:null,outlineWidth:null}}):this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:null,radius:this.activeObj.strokeSettings.radius}}))},D.prototype.updateStrokeColor=function(e){var t,o,i,r={shapeSettingsObj:{}},r=(this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:r}}),r.shapeSettingsObj),n=(this.activeObj.shape&&("path"!==this.activeObj.shape||"path"===this.activeObj.shape&&0<this.activeObj.pointColl.length)?(t=!1,o=this.objColl.length,this.notify("shape",{prop:"pushActItemIntoObj"}),o!==this.objColl.length&&(t=!0),o=T.extend({},this.cropObj,{},!0),this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(i={currObj:{}}),value:{object:i}}),(i=i.currObj).objColl=T.extend([],this.objColl,[],!0),i.pointColl=T.extend([],this.pointColl,[],!0),i.afterCropActions=T.extend([],this.afterCropActions,[],!0),this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(n={selPointColl:null}),value:{obj:n}}),i.selPointColl=T.extend([],n.selPointColl,[],!0),t&&this.objColl.pop(),this.activeObj.strokeSettings.strokeColor=e,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:this.activeObj.strokeSettings.strokeColor,fillColor:null,strokeWidth:null}}),this.togglePen||(this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}))):this.activeObj.shape&&"path"===this.activeObj.shape&&0===this.activeObj.pointColl.length&&(this.activeObj.strokeSettings.strokeColor=e,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:this.activeObj.strokeSettings.strokeColor,fillColor:null,strokeWidth:null}})),{action:"stroke-color",currentShapeSettings:T.extend({},r,{},!0)});n.currentShapeSettings.strokeColor=e,this.trigger("shapeChange",n),this.editCompleteArgs=n},D.prototype.updateFillColor=function(e){var t={shapeSettingsObj:{}},t=(this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:t}}),t.shapeSettingsObj),o=!1,i=this.objColl.length,i=(this.notify("shape",{prop:"pushActItemIntoObj"}),i!==this.objColl.length&&(o=!0),T.extend({},this.cropObj,{},!0)),r={currObj:{}},r=(this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}}),r.currObj),n=(r.objColl=T.extend([],this.objColl,[],!0),r.pointColl=T.extend([],this.pointColl,[],!0),r.afterCropActions=T.extend([],this.afterCropActions,[],!0),{selPointColl:null}),n=(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),r.selPointColl=T.extend([],n.selPointColl,[],!0),o&&this.objColl.pop(),this.activeObj.strokeSettings.fillColor=e,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:this.activeObj.strokeSettings.fillColor,strokeWidth:null}}),this.objColl.push(this.activeObj),0===this.activeObj.activePoint.width&&0===this.activeObj.activePoint.height||this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}),{action:"fill-color",currentShapeSettings:T.extend({},t,{},!0)});this.trigger("shapeChange",n),this.editCompleteArgs=n},D.prototype.horizontalFlip=function(e,t){T.isNullOrUndefined(t)&&(T.isNullOrUndefined(this.activeObj.imageRatio)&&this.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),this.notify("shape",{prop:"pushActItemIntoObj"}),o=T.extend({},this.cropObj,{},!0),this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(i={currObj:{}}),value:{object:i}}),(i=i.currObj).objColl=T.extend([],this.objColl,[],!0),i.pointColl=T.extend([],this.pointColl,[],!0),i.afterCropActions=T.extend([],this.afterCropActions,[],!0),this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(r={selPointColl:null}),value:{obj:r}}),i.selPointColl=T.extend([],r.selPointColl,[],!0),this.objColl.pop()),this.notify("toolbar",{prop:"refreshSlider"}),e.clearRect(0,0,this.activeObj.imageCanvas.width,this.activeObj.imageCanvas.height);var o,i,r=this.duplicateImage();this.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:this.activeObj.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:!0,isVFlip:null}}),this.activeObj.activePoint=r,this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),T.isNullOrUndefined(t)&&(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"imageHFlip",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}))},D.prototype.verticalFlip=function(e,t){T.isNullOrUndefined(t)&&(T.isNullOrUndefined(this.activeObj.imageRatio)&&this.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),this.notify("shape",{prop:"pushActItemIntoObj"}),o=T.extend({},this.cropObj,{},!0),this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(i={currObj:{}}),value:{object:i}}),(i=i.currObj).objColl=T.extend([],this.objColl,[],!0),i.pointColl=T.extend([],this.pointColl,[],!0),i.afterCropActions=T.extend([],this.afterCropActions,[],!0),this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(r={selPointColl:null}),value:{obj:r}}),i.selPointColl=T.extend([],r.selPointColl,[],!0),this.objColl.pop()),this.notify("toolbar",{prop:"refreshSlider"}),e.clearRect(0,0,this.activeObj.imageCanvas.width,this.activeObj.imageCanvas.height);var o,i,r=this.duplicateImage();this.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:this.activeObj.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:null,isVFlip:!0}}),this.activeObj.activePoint=r,this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),T.isNullOrUndefined(t)&&(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"imageVFlip",previousObj:i,previousObjColl:i.objColl,previousPointColl:i.pointColl,previousSelPointColl:i.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}))},D.prototype.rotateImage=function(e){T.isNullOrUndefined(this.activeObj.imageRatio)&&this.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),this.notify("shape",{prop:"pushActItemIntoObj"}),t=T.extend({},this.cropObj,{},!0);var t,o={currObj:{}},i=(this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),(o=o.currObj).objColl=T.extend([],this.objColl,[],!0),o.pointColl=T.extend([],this.pointColl,[],!0),o.afterCropActions=T.extend([],this.afterCropActions,[],!0),{selPointColl:null});this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:i}}),o.selPointColl=T.extend([],i.selPointColl,[],!0),this.objColl.pop(),this.notify("toolbar",{prop:"refreshSlider"}),"rotleft"===e?this.activeObj.rotatedAngle-=Math.PI/180*90:this.activeObj.rotatedAngle+=Math.PI/180*90,this.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:this.activeObj}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"imageRotate",previousObj:o,previousObjColl:o.objColl,previousPointColl:o.pointColl,previousSelPointColl:o.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}),this.notify("toolbar",{prop:"destroy-qa-toolbar"}),this.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})},D.prototype.pascalToSplitWords=function(e){var t=(e=e.charAt(0).toUpperCase()+e.slice(1)).match(/[A-Z][a-z]+/g);return T.isNullOrUndefined(t)?e:t.map(function(e){return e.charAt(0).toUpperCase()+e.slice(1)}).join(" ")},D.prototype.getCurrAdjustmentValue=function(e){var t,o={freehandSelectedIndex:null};return this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:o}}),"transparency"===e&&this.togglePen?(this.notify("freehand-draw",{prop:"getPenOpacity",onPropertyChange:!(t={penOpacity:1}),value:{obj:t}}),100*t.penOpacity):"transparency"===e&&null!=o.freehandSelectedIndex?100*this.pointColl[o.freehandSelectedIndex].opacity:(this.notify("filter",{prop:"getAdjustmentLevel",onPropertyChange:!(t={adjustmentLevel:null}),value:{obj:t}}),{brightness:t.adjustmentLevel.brightness,contrast:t.adjustmentLevel.contrast,hue:t.adjustmentLevel.hue,saturation:t.adjustmentLevel.saturation,opacity:t.adjustmentLevel.opacity,blur:t.adjustmentLevel.blur,exposure:t.adjustmentLevel.exposure,transparency:t.adjustmentLevel.transparency,straighten:this.transform.straighten}[""+e])},D.prototype.transformSelect=function(e){0!==this.transform.straighten||"rotateleft"!==e&&"rotateright"!==e||!this.activeObj.shape||-1===["crop-2:3","crop-3:2","crop-3:4","crop-4:3","crop-4:5","crop-5:4","crop-5:7","crop-7:5","crop-9:16","crop-16:9"].indexOf(this.activeObj.shape)&&(-1===this.activeObj.shape.indexOf("crop-")||"crop-custom"===this.activeObj.shape||"crop-square"===this.activeObj.shape||"crop-circle"===this.activeObj.shape)||(this.activeObj.shape="crop-"+this.activeObj.shape.split("-")[1].split(":")[1]+":"+this.activeObj.shape.split("-")[1].split(":")[0],this.notify("toolbar",{prop:"performCropTransformClick",value:{shape:this.activeObj.shape,isTransform:!0}})),this.isCropToolbar=!0,this.allowDownScale=!1;var t=this.transform.straighten,o=T.extend({},this.activeObj,{},!0),i=this.transform.zoomFactor,r=(this.prevEventSelectionPoint=T.extend({},this.activeObj,{},!0),{currObj:{}}),r=(this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}}),this.prevEventObjPoint=r.currObj,this.prevEventObjPoint.objColl=T.extend([],this.objColl,[],!0),this.prevEventObjPoint.pointColl=T.extend([],this.pointColl,[],!0),this.prevEventObjPoint.afterCropActions=T.extend([],this.afterCropActions,[],!0),{selPointColl:null});if(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),this.prevEventObjPoint.selPointColl=T.extend([],r.selPointColl,[],!0),0!==this.transform.straighten){this.transform.straighten=0,this.straightenBaseImageCanvas();for(var n=0,a=this.objColl.length;n<a;n++)"line"!==(s=this.objColl[n].shape)&&"arrow"!==s&&"path"!==s&&(this.objColl[n].rotatedAngle-=t*(Math.PI/180),this.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:this.objColl[n]}}));this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),this.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}})}this.setInitialZoomState();r=T.extend({},this.activeObj,{},!0);if(this.notify("crop",{prop:"setTransformCrop",onPropertyChange:!1,value:{bool:!0}}),this.cropSelectedState(),this.notify("crop",{prop:"setTransformCrop",onPropertyChange:!1,value:{bool:!1}}),this.notify("draw",{prop:"resetCurrentSelectionPoint"}),this.updateImageTransformColl(e),this.notify("transform",{prop:"performTransformation",value:{text:e}}),this.isCropTab=!0,this.notify("draw",{prop:"moveToSelectionRange",value:{type:e,activeObj:r}}),!this.isStraightening||"horizontalflip"!==e&&"verticalflip"!==e||(this.notify("draw",{prop:"resetStraightenDestPoints"}),this.notify("draw",{prop:"setDestForStraighten"})),0!==t){this.transform.straighten=t,this.straightenBaseImageCanvas();for(var s,n=0,a=this.objColl.length;n<a;n++)"line"!==(s=this.objColl[n].shape)&&"arrow"!==s&&"path"!==s&&(this.objColl[n].rotatedAngle+=t*(Math.PI/180),this.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:this.objColl[n]}}));this.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o}}),this.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),this.notify("draw",{prop:"setStraightenInitZoom",value:{zoomFactor:i}}),(this.isStraightening&&("horizontalflip"===e||"verticalflip"===e)&&T.isNullOrUndefined(this.transform.zoomFactor)||0===this.transform.zoomFactor)&&(0===this.transform.degree?this.transform.zoomFactor+=.025:0===this.transform.zoomFactor&&(this.transform.zoomFactor=null)),this.notify("draw",{prop:"zoomToSel",value:{activeObj:o,isToolbar:!1}})}this.isCropToolbar=!1;r=this.element.querySelector(".e-ie-straighten-value-span");r&&(r.innerHTML=this.transform.straighten.toString()+"&#176")},D.prototype.getDefaultFilter=function(){return"brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)"},D.prototype.setStraighten=function(e){var e={cancel:!1,previousDegree:this.transform.straighten,currentDegree:e};this.trigger("rotating",e),(this.editCompleteArgs=e).cancel||(this.performStraighten(e),e={action:"straighten",actionEventArgs:this.editCompleteArgs},this.triggerEditCompleteEvent(e))},D.prototype.duplicateImage=function(){var e=T.extend({},this.activeObj.activePoint,{},!0),t={width:0,height:0};return this.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:this.activeObj.imageElement.width,height:this.activeObj.imageElement.height,obj:t,isImgShape:null}}),this.activeObj.activePoint.width=t.width,this.activeObj.activePoint.height=t.height,e},D.prototype.performStraighten=function(e){var e=e.currentDegree,t=this.element.querySelector(".e-ie-straighten-value-span"),t=(t&&(t.innerHTML=e.toString()+"&#176"),T.extend({},this.activeObj,null,!0));this.notify("freehand-draw",{prop:"setCenterSelPoints"}),this.transform.straighten=e,this.straightenPoint={x:this.activeObj.activePoint.startX+this.activeObj.activePoint.width/2,y:this.activeObj.activePoint.startY+this.activeObj.activePoint.height/2},this.straightenBaseImageCanvas();for(var o=0,i=this.objColl.length;o<i;o++){var r=this.objColl[o].shape;"line"!==r&&"arrow"!==r&&"path"!==r&&(this.objColl[o].rotatedAngle+=(this.transform.straighten-this.prevStraightenedDegree)*(Math.PI/180),this.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:this.objColl[o]}}))}this.transform.degree%90==0&&this.transform.degree%180!=0?(0===this.transform.straighten&&(this.transform.straighten=360),this.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:this.activeObj.activePoint.startX+this.activeObj.activePoint.width/2,y:this.activeObj.activePoint.startY+this.activeObj.activePoint.height/2,type:"zoomIn",isResize:!0}}),this.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:this.activeObj.activePoint.startX+this.activeObj.activePoint.width/2,y:this.activeObj.activePoint.startY+this.activeObj.activePoint.height/2,type:"zoomOut",isResize:!0}}),360===this.transform.straighten&&(this.transform.straighten=0)):this.notify("draw",{prop:"render-image",value:{isMouseWheel:!0,isPreventClearRect:null,isFrame:null,isStraighten:!0}}),this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t}}),this.notify("draw",{prop:"zoomToSel",value:{activeObj:t,isToolbar:!0}}),this.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),this.prevStraightenedDegree=this.transform.straighten},D.prototype.straightenBaseImageCanvas=function(){var e,t,o,i;this.isImageLoaded&&(e="horizontal"===(e=this.getStraightenFlipState())||"vertical"===e?-this.transform.straighten:this.transform.straighten,o=void((t=this.baseImgCanvas.getContext("2d")).canvas.width!==this.lowerContext.canvas.width&&t.canvas.height!==this.lowerContext.canvas.height&&this.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:{width:0,height:0},dimension:{width:t.canvas.width,height:t.canvas.height}}})),o=this.getRotatedCanvasDim(this.baseImg.width,this.baseImg.height,this.transform.straighten),this.img.srcWidth=t.canvas.width=o.width,this.img.srcHeight=t.canvas.height=o.height,o=t.canvas.width/2,i=t.canvas.height/2,t.clearRect(0,0,t.canvas.width,t.canvas.height),t.translate(o,i),t.rotate(e*Math.PI/180),t.drawImage(this.baseImg,-this.baseImg.width/2,-this.baseImg.height/2,this.baseImg.width,this.baseImg.height),t.setTransform(1,0,0,1,0,0),this.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:{width:0,height:0},dimension:{width:t.canvas.width,height:t.canvas.height}}}))},D.prototype.getRotatedCanvasDim=function(e,t,o){var o=o*Math.PI/180,i=Math.cos(o),r=Math.sin(o),n=Math.min(0,e*i,t*Math.cos(Math.PI/2-o),e*i+t*Math.cos(Math.PI/2-o)),i=Math.max(0,e*i,t*Math.cos(Math.PI/2-o),e*i+t*Math.cos(Math.PI/2-o)),a=Math.min(0,e*r,t*Math.sin(Math.PI/2-o),e*r+t*Math.sin(Math.PI/2-o)),e=Math.max(0,e*r,t*Math.sin(Math.PI/2-o),e*r+t*Math.sin(Math.PI/2-o));return{width:Math.ceil(i-n),height:Math.ceil(e-a)}},D.prototype.updateShapeOrder=function(e,t){var o,i,r,n,e=this.getObjFromId(e);e.shape&&("path"!==e.shape||"path"===e.shape&&0<e.pointColl.length)||e&&e.id&&-1<e.id.indexOf("pen")?(this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!(o={shapeSettingsObj:{}}),value:{obj:o}}),o=o.shapeSettingsObj,e.shape&&this.notify("shape",{prop:"pushActItemIntoObj"}),i=T.extend({},this.cropObj,{},!0),this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(r={currObj:{}}),value:{object:r}}),(r=r.currObj).objColl=T.extend([],this.objColl,[],!0),r.pointColl=T.extend([],this.pointColl,[],!0),r.afterCropActions=T.extend([],this.afterCropActions,[],!0),this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(n={selPointColl:null}),value:{obj:n}}),r.selPointColl=T.extend([],n.selPointColl,[],!0),e.shape&&this.objColl.pop(),this.notify("shape",{prop:"z-order",onPropertyChange:!1,value:{obj:e,value:t}}),e.shape&&(this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:e.strokeSettings.strokeWidth}}),this.objColl.push(e)),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:r,previousObjColl:r.objColl,previousPointColl:r.pointColl,previousSelPointColl:r.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),e.shape&&(this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}),this.activeObj.order=e.order),{action:"stroke-width",previousShapeSettings:T.extend({},o,{},!0),currentShapeSettings:T.extend({},o,{},!0)}.currentShapeSettings.strokeWidth=this.activeObj.strokeSettings.strokeWidth):this.activeObj.shape&&"path"===this.activeObj.shape&&0===this.activeObj.pointColl.length&&this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth}})},D.prototype.getStraightenFlipState=function(){var e="";if(0<this.rotateFlipColl.length)for(var t=0,o=this.rotateFlipColl.length;t<o;t++){var i=this.rotateFlipColl[t];"horizontal"===i?e+="horizontal":"vertical"===i&&(e+="vertical"),"horizontalvertical"!==e&&"verticalhorizontal"!==e||(e="")}return e},D.prototype.initializeZoomSettings=function(){this.theme=T.isNullOrUndefined(this.theme)?"Bootstrap5":this.theme,!T.isNullOrUndefined(this.zoomSettings.zoomTrigger)&&0!==this.zoomSettings.zoomTrigger||(this.zoomSettings.zoomTrigger=m.ZoomTrigger.MouseWheel|m.ZoomTrigger.Pinch|m.ZoomTrigger.Toolbar|m.ZoomTrigger.Commands),T.isNullOrUndefined(this.selectionSettings.strokeColor)&&(this.selectionSettings.strokeColor=this.themeColl[this.theme].primaryColor),T.isNullOrUndefined(this.selectionSettings.fillColor)&&(this.selectionSettings.fillColor=this.themeColl[this.theme].secondaryColor)},D.prototype.initializeThemeColl=function(){this.themeColl={Bootstrap5:{primaryColor:"#0d6efd",secondaryColor:"#fff"},Bootstrap5Dark:{primaryColor:"#0d6efd",secondaryColor:"#fff"},Tailwind:{primaryColor:"#4f46e5",secondaryColor:"#fff"},TailwindDark:{primaryColor:"#22d3ee",secondaryColor:"#fff"},Fluent:{primaryColor:"#0078d4",secondaryColor:"#fff"},FluentDark:{primaryColor:"#0078d4",secondaryColor:"#fff"},Bootstrap4:{primaryColor:"#007bff",secondaryColor:"#fff"},Bootstrap:{primaryColor:"#317ab9",secondaryColor:"#fff"},BootstrapDark:{primaryColor:"#317ab9",secondaryColor:"#fff"},Material:{primaryColor:"#e3165b",secondaryColor:"#fff"},MaterialDark:{primaryColor:"#00b0ff",secondaryColor:"#fff"},Fabric:{primaryColor:"#0078d6",secondaryColor:"#fff"},FabricDark:{primaryColor:"#0074cc",secondaryColor:"#fff"},Highcontrast:{primaryColor:"#000000",secondaryColor:"#fff"},Material3:{primaryColor:"#6750a4",secondaryColor:"#fff"},Material3Dark:{primaryColor:"#d0bcff",secondaryColor:"#fff"},Fluent2:{primaryColor:"#0f6cbd",secondaryColor:"#fff"},Fluent2Dark:{primaryColor:"#115ea3",secondaryColor:"#fff"},Fluent2Highcontrast:{primaryColor:"#1aebff",secondaryColor:"#fff"},"Bootstrap5.3":{primaryColor:"#0d6efd",secondaryColor:"#fff"},"Bootstrap5.3Dark":{primaryColor:"#0d6efd",secondaryColor:"#fff"},Tailwind3:{primaryColor:"#4f46e5",secondaryColor:"#ffffff"},Tailwind3Dark:{primaryColor:"#6366f1",secondaryColor:"#ffffff03"}}},D.prototype.drawRedact=function(e,t,o,i,r,n){var a=!1,s=this.allowShape(t,o);return!this.disabled&&this.isImageLoaded&&(s||T.isNullOrUndefined(t)&&T.isNullOrUndefined(o))&&(a=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawRedact",onPropertyChange:!1,value:{x:t,y:o,width:i,height:r,type:e,value:n}}),this.notify("draw",{prop:"redrawDownScale"})),a},P([T.Property("")],D.prototype,"cssClass",void 0),P([T.Property(!1)],D.prototype,"disabled",void 0),P([T.Property("100%")],D.prototype,"height",void 0),P([T.Property("Bootstrap5")],D.prototype,"theme",void 0),P([T.Property()],D.prototype,"toolbar",void 0),P([T.Property()],D.prototype,"toolbarTemplate",void 0),P([T.Property("100%")],D.prototype,"width",void 0),P([T.Property(!0)],D.prototype,"allowUndoRedo",void 0),P([T.Property(!0)],D.prototype,"showQuickAccessToolbar",void 0),P([T.Property()],D.prototype,"quickAccessToolbarTemplate",void 0),P([T.Property(!1)],D.prototype,"isReadOnly",void 0),P([T.Property(!1)],D.prototype,"enableRtl",void 0),P([T.Property(!1)],D.prototype,"enablePersistence",void 0),P([T.Complex({},N)],D.prototype,"finetuneSettings",void 0),P([T.Complex({},q)],D.prototype,"zoomSettings",void 0),P([T.Complex({},Z)],D.prototype,"selectionSettings",void 0),P([T.Complex({},V)],D.prototype,"fontFamily",void 0),P([T.Complex({},_)],D.prototype,"uploadSettings",void 0),P([T.Event()],D.prototype,"beforeSave",void 0),P([T.Event()],D.prototype,"created",void 0),P([T.Event()],D.prototype,"destroyed",void 0),P([T.Event()],D.prototype,"zooming",void 0),P([T.Event()],D.prototype,"panning",void 0),P([T.Event()],D.prototype,"cropping",void 0),P([T.Event()],D.prototype,"rotating",void 0),P([T.Event()],D.prototype,"flipping",void 0),P([T.Event()],D.prototype,"shapeChanging",void 0),P([T.Event()],D.prototype,"selectionChanging",void 0),P([T.Event()],D.prototype,"fileOpened",void 0),P([T.Event()],D.prototype,"saved",void 0),P([T.Event()],D.prototype,"toolbarCreated",void 0),P([T.Event()],D.prototype,"toolbarUpdating",void 0),P([T.Event()],D.prototype,"toolbarItemClicked",void 0),P([T.Event()],D.prototype,"imageFiltering",void 0),P([T.Event()],D.prototype,"finetuneValueChanging",void 0),P([T.Event()],D.prototype,"click",void 0),P([T.Event()],D.prototype,"shapeChange",void 0),P([T.Event()],D.prototype,"quickAccessToolbarOpen",void 0),P([T.Event()],D.prototype,"resizing",void 0),P([T.Event()],D.prototype,"quickAccessToolbarItemClick",void 0),P([T.Event()],D.prototype,"frameChange",void 0),P([T.Event()],D.prototype,"editComplete",void 0);var z,R,y=R=P([T.NotifyPropertyChanges],D);function D(e,t){e=z.call(this,e)||this;return e.isImageLoaded=!1,e.activeObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],rotatedAngle:0,opacity:1,order:null},e.currObjType={shape:"",isDragging:!1,isActiveObj:!1,isText:!1,isInitialText:!1,isLine:!1,isInitialLine:!1,isCustomCrop:!1,isZoomed:!1,isUndoZoom:!1,isUndoAction:!1,isFiltered:!1,isSave:!1,isResize:!1,isRedact:!1},e.objColl=[],e.pointColl={},e.freehandCounter=0,e.points=[],e.togglePen=!1,e.togglePan=!1,e.img={destLeft:0,destTop:0,destWidth:0,destHeight:0,srcLeft:0,srcTop:0,srcWidth:0,srcHeight:0},e.rotateFlipColl=[],e.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",straighten:0,destPoints:{startX:0,startY:0,width:0,height:0},srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:!1,zoomFactor:0,previousZoomValue:0,aspectWidth:null,aspectHeight:null,frame:"none",straightenZoom:0,adjustmentLevel:{brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},currentFilter:""},e.afterCropActions=[],e.transform={degree:0,currFlipState:"",zoomFactor:0,cropZoomFactor:null,defaultZoomFactor:0,straighten:0},e.panPoint={currentPannedPoint:{x:0,y:0},totalPannedPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0}},e.isUndoRedo=!1,e.isCropTab=!1,e.isCircleCrop=!1,e.fontSizeColl=[],e.initialAdjustmentValue="",e.currentFilter="",e.canvasFilter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",e.toolbarHeight=0,e.isPublicMethod=!1,e.isCropToolbar=!1,e.cursor="default",e.resizeSrc={startX:e.img.srcLeft,startY:e.img.srcTop,width:e.img.srcWidth,height:e.img.srcHeight},e.isResize=!1,e.isAspectRatio=!1,e.frameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},e.tempFrameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},e.allowDownScale=!0,e.gradientColor="",e.size=20,e.inset=0,e.offset=0,e.borderRadius=0,e.lineCount=0,e.prevStraightenedDegree=0,e.tempStraighten=0,e.isStraightening=!1,e.isFinetuning=!1,e.isZoomBtnClick=!1,e.isFinetuneBtnClick=!1,e.isFilterCanvasClick=!1,e.isFrameBtnClick=!1,e.isChangesSaved=!1,e.isShapeDrawing=!1,e.noPushUndo=!1,e.isUndoRedoStack=!1,e.shapeColl=[],e.isKBDNavigation=!1,e.isMaskImage=!1,e.tempObjColl=[],e.tempPointColl=[],e.tempShapeColl=[],e.isImageUpdated=!1,e.noRedact=!1,e.tempRedactBlur=50,e.tempRedactPixel=40,e.tempToolbarHeight=0,e.tempToolbar=[],R.Inject(o,i,H,W,r,J),R.Inject(U),R.Inject(a),R.Inject(M),R.Inject(B),t&&e.appendTo(t),e}(P=m.FileType||(m.FileType={})).Png="Png",P.Jpeg="Jpeg",P.Svg="Svg",P.WebP="WebP",(P=m.Direction||(m.Direction={})).Horizontal="Horizontal",P.Vertical="Vertical",(P=m.ShapeType||(m.ShapeType={})).Rectangle="Rectangle",P.Ellipse="Ellipse",P.Line="Line",P.Arrow="Arrow",P.Path="Path",P.Text="Text",P.FreehandDraw="FreehandDraw",P.Image="Image",(P=m.ZoomTrigger||(m.ZoomTrigger={}))[P.MouseWheel=1]="MouseWheel",P[P.Pinch=2]="Pinch",P[P.Commands=4]="Commands",P[P.Toolbar=8]="Toolbar",(P=m.Theme||(m.Theme={})).Bootstrap5="Bootstrap5",P.Bootstrap5Dark="Bootstrap5Dark",P.Tailwind="Tailwind",P.TailwindDark="TailwindDark",P.Fluent="Fluent",P.FluentDark="FluentDark",P.Bootstrap4="Bootstrap4",P.Bootstrap="Bootstrap",P.BootstrapDark="BootstrapDark",P.Material="Material",P.MaterialDark="MaterialDark",P.Fabric="Fabric",P.FabricDark="FabricDark",P.Highcontrast="Highcontrast",P.Fluent2="Fluent2",P.Fluent2Dark="Fluent2Dark",P.Tailwind3="Tailwind3",P.Tailwind3Dark="Tailwind3Dark",(P=m.ImageEditorCommand||(m.ImageEditorCommand={})).Crop="Crop",P.Transform="Transform",P.Annotate="Annotate",P.ZoomIn="ZoomIn",P.ZoomOut="ZoomOut",P.Open="Open",P.Reset="Reset",P.Save="Save",P.Pan="Pan",P.Move="Move",P.Pen="Pen",P.Line="Line",P.Arrow="Arrow",P.Path="Path",P.Rectangle="Rectangle",P.Image="Image",P.Ellipse="Ellipse",P.Text="Text",P.CustomSelection="CustomSelection",P.CircleSelection="CircleSelection",P.SquareSelection="SquareSelection",P.RatioSelection="RatioSelection",P.RotateLeft="RotateLeft",P.RotateRight="RotateRight",P.FlipHorizontal="FlipHorizontal",P.FlipVertical="FlipVertical",P.Undo="Undo",P.Redo="Redo",P.None="None",P.Mat="Mat",P.Bevel="Bevel",P.Inset="Inset",P.Hook="Hook",P.Finetune="Finetune",P.Filter="Filter",P.Frame="Frame",P.Resize="Resize",P.HorizontalFlip="HorizontalFlip",P.VerticalFlip="VerticalFlip",P.Brightness="Brightness",P.Contrast="Contrast",P.Hue="Hue",P.Saturation="Saturation",P.Opacity="Opacity",P.Blur="Blur",P.Exposure="Exposure",P.Default="Default",P.Chrome="Chrome",P.Cold="Cold",P.Warm="Warm",P.Grayscale="Grayscale",P.Sepia="Sepia",P.Invert="Invert",P.Straightening="Straightening",(P=m.ImageFilterOption||(m.ImageFilterOption={})).Default="Default",P.Chrome="Chrome",P.Cold="Cold",P.Warm="Warm",P.Grayscale="Grayscale",P.Sepia="Sepia",P.Invert="Invert",(P=m.ImageFinetuneOption||(m.ImageFinetuneOption={})).Brightness="Brightness",P.Contrast="Contrast",P.Hue="Hue",P.Saturation="Saturation",P.Exposure="Exposure",P.Opacity="Opacity",P.Blur="Blur",(P=m.ArrowheadType||(m.ArrowheadType={})).None="None",P.Arrow="Arrow",P.SolidArrow="SolidArrow",P.Circle="Circle",P.SolidCircle="SolidCircle",P.Square="Square",P.SolidSquare="SolidSquare",P.Bar="Bar",(P=m.FrameType||(m.FrameType={})).None="None",P.Mat="Mat",P.Bevel="Bevel",P.Line="Line",P.Inset="Inset",P.Hook="Hook",(P=m.FrameLineStyle||(m.FrameLineStyle={})).Solid="Solid",P.Dashed="Dashed",P.Dotted="Dotted",(P=m.RedactType||(m.RedactType={})).Blur="Blur",P.Pixelate="Pixelate";L.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},L.prototype.addEventListener=function(){this.parent.on("toolbar",this.toolbar,this),this.parent.on("destroyed",this.destroy,this)},L.prototype.removeEventListener=function(){this.parent.off("toolbar",this.toolbar),this.parent.off("destroyed",this.destroy)},L.prototype.initLocale=function(){this.defaultLocale={Crop:"Crop",ZoomIn:"Zoom In",ZoomOut:"Zoom Out",Undo:"Undo",Redo:"Redo",Transform:"Transform",Annotation:"Annotation",Finetune:"Finetune",Brightness:"Brightness",Contrast:"Contrast",Hue:"Hue",Saturation:"Saturation",Opacity:"Opacity",Blur:"Blur",Sharpen:"Sharpen",Exposure:"Exposure",Filter:"Filter",Default:"Default",Chrome:"Chrome",Cold:"Cold",Warm:"Warm",Grayscale:"Grayscale",BlackAndWhite:"Black and White",Sepia:"Sepia",Invert:"Invert",Text:"Add Text",Pen:"Pen",Reset:"Reset",Save:"Save",Select:"Select",RotateLeft:"Rotate Left",RotateRight:"Rotate Right",HorizontalFlip:"Horizontal Flip",VerticalFlip:"Vertical Flip",OK:"Apply",Cancel:"Discard",FillColor:"Fill Color",StrokeColor:"Stroke Color",StrokeWidth:"Stroke Width",FontFamily:"Font Family",FontStyle:"Font Style",FontSize:"Font Size",FontColor:"Font Color",Pan:"Pan",Move:"Move",Load:"Load",Custom:"Custom",Square:"Square",Circle:"Circle",Ellipse:"Ellipse",Rectangle:"Rectangle",Line:"Line",Arrow:"Arrow",Path:"Path",Bold:"Bold",Italic:"Italic",BoldItalic:"Bold Italic",XSmall:"X-Small",Small:"Small",Medium:"Medium",Large:"Large",XLarge:"X-Large",ABC:"ABC",Browse:"Browse",Duplicate:"Duplicate",Remove:"Remove",EditText:"Edit Text",Start:"Start",End:"End",Bar:"Bar",ArrowSolid:"Arrow Solid",CircleSolid:"Circle Solid",SquareSolid:"Square Solid",None:"None",CropAndTransform:"Crop and Transform",CropSelection:"Crop Selection",Image:"Add Image",Transparency:"Transparency",Height:"Height",Width:"Width",AspectRatio:"Maintain aspect ratio",W:"W",H:"H",DragText:"Drag and drop your image here or",DropText:"Drop your image here or",BrowseText:"Browse here...",SupportText:"Supports:",Frame:"Frame",Mat:"Mat",Bevel:"Bevel",Inset:"Inset",Hook:"Hook",Color:"Color",Size:"Size",Offset:"Offset",Radius:"Radius",Amount:"Amount",Resize:"Resize",0:"0%",20:"20%",40:"40%",60:"60%",80:"80%",100:"100%",1:"1",2:"2",3:"3",4:"4",5:"5",Border:"Border",Solid:"Solid",Dashed:"Dashed",Dotted:"Dotted",GradientColor:"Gradient Color",ConfirmDialogHeader:"Confirm Save Changes",ConfirmDialogContent:"Do you want to save the changes you made to the image?",AlertDialogHeader:"Unsupported file",AlertDialogContent:"The selected file is unsupported.",MinMaxSize:"with file size between",MinMaxSizeAlert:"File size between",MinSize:"with minimum file size of",MinSizeAlert:"A minimum file size of",MaxSize:"with maximum file size of",MaxSizeAlert:"A maximum file size of",To:"to",Bytes:"bytes",Yes:"Yes",No:"No",ImageErrorDialogHeader:"Image Selection Error",ImageErrorDialogContent:"Please select only one image to open.",Straighten:"Straighten",NoOutline:"No outline",DlgOK:"OK",SaveAs:"Save As",ImageName:"Image name",Format:"Format",Quality:"Quality",Download:"Download",Close:"Close",ImageSize:"Image Size",QualityInfo:"The image quality option is only available for JPEG format",Good:"Good",Great:"Great",Highest:"Highest",BringForward:"Bring Forward",SendBackward:"Send Backward",SendToBack:"Send to Back",BringToFront:"Bring to Front",ZOrder:"Z-Order",Redact:"Redact",Pixelate:"Pixelate",BorderRadius:"Border Radius",TextOutlineColor:"Outline Color",TextOutlineWidth:"Outline Width",PixelSize:"Pixel Size",And:"and"},this.l10n=new T.L10n("image-editor",this.defaultLocale,this.parent.locale)},L.prototype.toolbar=function(e){var t=this.parent;switch(this.updatePrivateVariables(),e.prop){case"create-toolbar":this.createToolbar();break;case"create-contextual-toolbar":this.createContextualToolbar();break;case"update-toolbar-items":this.updateToolbarItems();break;case"refresh-toolbar":this.refreshToolbar(e.value.type,e.value.isApplyBtn,e.value.isCropping,e.value.isZooming,e.value.cType);break;case"renderQAT":this.renderQAT(e.value.isPenEdit);break;case"enable-disable-btns":this.enableDisableTbrBtn();break;case"init-main-toolbar":this.initMainToolbar(e.value.isApplyBtn,e.value.isDevice,e.value.isOkBtn,e.value.isResize,e.value.isFrame,e.value.isMainToolbar);break;case"create-bottom-toolbar":this.createBottomToolbar();break;case"refresh-main-toolbar":this.refreshMainToolbar();break;case"create-qa-toolbar":this.createQuickAccessToolbar();break;case"destroy-qa-toolbar":this.destroyQuickAccessToolbar();break;case"zoom-up-handler":this.zoomBtnMouseUpHandler();break;case"refresh-dropdown-btn":this.refreshDropDownBtn(e.value.isDisabled);break;case"close-contextual-toolbar":this.closeContextualToolbar();break;case"destroy-bottom-toolbar":this.destroyBottomToolbar();break;case"destroy-top-toolbar":this.destroyTopToolbar();break;case"destroySubComponents":this.destroySubComponents();break;case"setLocale":this.l10n.setLocale(e.value.locale);break;case"setPreventZoomBtn":this.preventZoomBtn=e.value.isPrevent;break;case"getToolbarHeight":e.value.obj.toolbarHeight=this.toolbarHeight;break;case"setToolbarHeight":(T.isNullOrUndefined(t.toolbar)||t.toolbar&&0<t.toolbar.length&&-1<t.toolbar.indexOf("Open"))&&(this.toolbarHeight=e.value.height);break;case"setCurrentToolbar":this.currentToolbar=e.value.type;break;case"setSelectedFreehandColor":this.selFhdColor=e.value.color;break;case"setInitialAdjustmentValue":t.initialAdjustmentValue=e.value.value;break;case"getCanvasFilter":e.value.obj.canvasFilter=t.canvasFilter;break;case"getDefToolbarItems":e.value.obj.defToolbarItems=this.defToolbarItems;break;case"getPenStroke":this.getPenStroke(e.value.value);break;case"performDefToolbarClickAction":this.performDefTbrClick(e.value.type,e.value.isContextualToolbar,e.value.isDisabledAdjustment,e.value.isDisabledFilter,e.value.isFilterFinetune);break;case"setTempFilterProperties":t.setTempFilterProperties();break;case"refreshSlider":this.refreshSlider();break;case"getCurrAdjustmentValue":t.getCurrAdjustmentValue(e.value.type);break;case"setCurrAdjustmentValue":t.setCurrAdjustmentValue(e.value.type,e.value.value);break;case"refreshShapeDrawing":this.refreshShapeDrawing();break;case"setEnableDisableUndoRedo":this.preventEnableDisableUr=e.value.isPrevent;break;case"reset":this.reset();break;case"getLocaleText":e.value.obj.value=this.l10n.getConstant(e.value.obj.key);break;case"initResizeToolbar":this.initResizeToolbar();break;case"getFrameToolbar":e.value.obj.bool=this.isFrameToolbar;break;case"resizeClick":this.resizeClick();break;case"frameToolbarClick":this.frameToolbarClick();break;case"performCropTransformClick":this.performCropTransformClick(e.value.shape,e.value.isTransform);break;case"duplicateShape":this.duplicateShape(e.value.isPreventUndoRedo,!0);break;case"editText":this.editText();break;case"setInitialSize":this.initialSize=Number(e.value.value);break;case"widthPress":this.widthPress(e.value.e);break;case"heightPress":this.heightPress(e.value.e);break;case"widthAspectRatio":this.widthAspectRatio(e.value.e);break;case"heightAspectRatio":this.heightAspectRatio(e.value.e);break;case"cancelPan":this.cancelPan();break;case"zoomInBtnMouseDownHandler":this.zoomInBtnMouseDownHandler(e.value.event);break;case"zoomOutBtnMouseDownHandler":this.zoomOutBtnMouseDownHandler(e.value.event);break;case"drawDashedLine":this.drawDashedLine(e.value.context);break;case"saveDialogClosed":this.saveDialogClosed(e.value.id);break;case"getIndex":this.getIndex(e.value.item);break;case"getRectRadius":this.getRectRadius(e.value.text);break;case"applyPreviewFilter":this.applyPreviewFilter();break;case"renderSlider":this.renderSlider(e.value.type,e.value.isSelect);break;case"zoomInBtnClickHandler":this.zoomInBtnClickHandler(e.value.e);break;case"zoomOutBtnClickHandler":this.zoomOutBtnClickHandler(e.value.e);break;case"getAdjustmentToolbarItem":this.getAdjustmentToolbarItem();break;case"getFilterToolbarItem":this.getFilterToolbarItem();break;case"renderCropBtn":this.renderCropBtn()}},L.prototype.updatePrivateVariables=function(){var e=this.parent;this.inMemoryCanvas=e.inMemoryCanvas,e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d")),this.inMemoryCanvas&&(this.inMemoryContext=this.inMemoryCanvas.getContext("2d"))},L.prototype.reset=function(){var e=this.parent;this.toolbarHeight=46,e.prevCurrSelectionPoint=null,this.zoomBtnHold=null,this.currToolbar="",e.cxtTbarHeight=null,this.currentToolbar="main",this.selFhdColor="#42a5f5",e.currentFilter="",this.preventZoomBtn=e.isCropToolbar=this.preventEnableDisableUr=this.isFrameToolbar=!1,e.initialAdjustmentValue=e.canvasFilter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",e.tempStraighten=0,e.isStraightening=!1},L.prototype.destroyTopToolbar=function(){var e=this.parent,e=document.getElementById(e.element.id+"_toolbar");this.isToolbar()&&e&&e.classList.contains("e-control")&&T.getComponent(e,"toolbar").destroy()},L.prototype.destroyBottomToolbar=function(){var e=this.parent,e=document.getElementById(e.element.id+"_bottomToolbar");e&&e.classList.contains("e-control")&&T.getComponent(e,"toolbar").destroy()},L.prototype.isToolbar=function(){var e=this.parent;return T.isNullOrUndefined(e.toolbar)||e.toolbar&&0<e.toolbar.length||!T.isNullOrUndefined(e.toolbarTemplate)},L.prototype.createToolbar=function(){var e,t,o=this,i=this.parent,r=i.element.id;T.isNullOrUndefined(i.toolbar)||i.toolbar&&0<i.toolbar.length?(i.element.appendChild(i.createElement("div",{id:r+"_toolbarArea",className:"e-toolbar-area"})),e={cssClass:"e-image-upload",align:"Left",type:"Input",tooltipText:this.l10n.getConstant("Browse"),template:new g.Uploader({allowedExtensions:i.uploadSettings.allowedExtensions,multiple:!1})},T.isNullOrUndefined(this.defToolbarItems)&&(this.defToolbarItems=[]),this.defToolbarItems.push(e),e=document.getElementById(r+"_toolbarArea"),t=i.createElement("div",{id:r+"_toolbar"}),e.appendChild(t),e=[{cssClass:"e-image-upload",align:"Left",type:"Input",tooltipText:this.l10n.getConstant("Browse"),template:new g.Uploader({allowedExtensions:i.uploadSettings.allowedExtensions,multiple:!1,selected:function(){var e=document.getElementById(r+"_toolbar"),t=document.getElementById(r+"_bottomToolbar");i.disabled||(T.Browser.isDevice?(0<o.defToolbarItems.length&&e&&T.getComponent(e,"toolbar").destroy(),t&&T.getComponent(t,"toolbar").destroy(),o.initMainToolbar(!1,T.Browser.isDevice,null),o.createBottomToolbar()):(0<o.defToolbarItems.length&&e&&T.getComponent(e,"toolbar").destroy(),o.initMainToolbar(!1,!1,null)))}})}],new c.Toolbar({items:e,width:"100%",created:function(){i.trigger("toolbarCreated",{toolbarType:"main"})},clicked:this.defToolbarClicked.bind(this)}).appendTo("#"+r+"_toolbar"),this.createLeftToolbarControls(),e=document.getElementById(r+"_toolbar"),t&&(this.toolbarHeight=e.clientHeight,i.toolbar)&&0<i.toolbar.length&&-1===i.toolbar.indexOf("Open")&&(t=T.getComponent(document.getElementById(i.element.id+"_toolbar"),"toolbar"))&&(t.destroy(),document.getElementById(i.element.id+"_toolbar").innerHTML="")):this.toolbarHeight=0},L.prototype.createContextualToolbar=function(){var e,t=this.parent,o=t.element.id;(T.isNullOrUndefined(t.toolbar)||t.toolbar&&0<t.toolbar.length)&&((e=t.createElement("div",{id:o+"_contextualToolbarArea",className:"e-contextual-toolbar-wrapper e-hide"})).style.position="absolute",t.element.appendChild(e),e=document.getElementById(o+"_contextualToolbarArea"),t=t.createElement("div",{id:o+"_contextualToolbar"}),e.appendChild(t))},L.prototype.createBottomToolbar=function(){var e,t=this.parent,o=t.element.id;t.element.querySelector("#"+o+"_bottomToolbarArea")&&t.element.querySelector("#"+o+"_bottomToolbarArea").remove(),(T.isNullOrUndefined(t.toolbar)||t.toolbar&&0<t.toolbar.length)&&(t.element.appendChild(t.createElement("div",{id:o+"_bottomToolbarArea",className:"e-bottom-toolbar"})),t.toolbarTemplate||(e=document.getElementById(o+"_bottomToolbarArea"),t=t.createElement("div",{id:o+"_bottomToolbar"}),e.appendChild(t)),this.initBottomToolbar())},L.prototype.createQuickAccessToolbar=function(){var e,t=this.parent,o=t.element.id;t.showQuickAccessToolbar&&(e={cssClass:"e-image-upload",align:"Left",type:"Input",tooltipText:this.l10n.getConstant("Browse"),template:new g.Uploader({allowedExtensions:t.uploadSettings.allowedExtensions,multiple:!1})},T.isNullOrUndefined(this.defToolbarItems)&&(this.defToolbarItems=[]),this.defToolbarItems.push(e),e=document.getElementById(o+"_quickAccessToolbarArea"),t=t.createElement("div",{id:o+"_quickAccessToolbar"}),e.appendChild(t),new c.Toolbar({clicked:this.defToolbarClicked.bind(this)}).appendTo("#"+o+"_quickAccessToolbar"))},L.prototype.initMainToolbar=function(e,t,o,i,r,n,a){var s=this,l=this.parent,p=l.element.id;this.isToolbar()&&(i=this.getLeftToolbarItem(o,i),o=this.getRightToolbarItem(o,n,a),n=this.getMainToolbarItem(e,r,a),e=this.getZoomToolbarItem(),this.defToolbarItems=t?r||a?n:i.concat(o):i.concat(n,o,e),i={toolbarType:"main",toolbarItems:this.defToolbarItems},l.trigger("toolbarUpdating",i),this.defToolbarItems=i.toolbarItems,0<this.defToolbarItems.length)&&(n=new c.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){t||s.renderAnnotationBtn(),s.wireZoomBtnEvents(),l.trigger("toolbarCreated",{toolbarType:"main"})}}),t&&r||t&&a?n.appendTo("#"+p+"_bottomToolbar"):n.appendTo("#"+p+"_toolbar"),this.createLeftToolbarControls(),this.enableDisableTbrBtn(),this.isToolbar())&&document.getElementById(p+"_toolbar")&&T.getComponent(p+"_toolbar","toolbar").refreshOverflow()},L.prototype.initBottomToolbar=function(){var e,t=this,o=this.parent,i=o.element.id;(T.isNullOrUndefined(o.toolbar)||o.toolbar&&0<o.toolbar.length)&&(e={toolbarType:"bottom-toolbar",toolbarItems:this.getMainToolbarItem()},o.trigger("toolbarUpdating",e),new c.Toolbar({items:e.toolbarItems,width:"100%",created:function(){t.renderAnnotationBtn(),t.renderCropBtn(),t.renderTransformBtn(),o.trigger("toolbarCreated",{toolbarType:"main"})},clicked:this.defToolbarClicked.bind(this)}).appendTo("#"+i+"_bottomToolbar"),0<this.defToolbarItems.length)&&document.getElementById(i+"_bottomToolbar")&&T.getComponent(i+"_bottomToolbar","toolbar").refreshOverflow()},L.prototype.getLeftToolbarItem=function(e,t){for(var o=this.parent,i=o.element.id,r=[],n=(e&&!t||(T.isNullOrUndefined(o.toolbar)||o.toolbar&&-1<o.toolbar.indexOf("Open")?(r.push({id:i+"_upload",cssClass:"e-image-upload",align:"Left",type:"Input",template:new g.Uploader({allowedExtensions:o.uploadSettings.allowedExtensions,multiple:!1})}),r.push({visible:!1,cssClass:"e-image-position e-btn e-flat",tooltipText:this.l10n.getConstant("Browse"),align:"Left"})):T.Browser.isDevice&&o.toolbar&&-1===o.toolbar.indexOf("Open")&&(r.push({visible:!1,id:i+"_upload",cssClass:"e-image-upload",align:"Left",type:"Input",template:new g.Uploader({allowedExtensions:o.uploadSettings.allowedExtensions,multiple:!1})}),r.push({visible:!1,cssClass:"e-image-position e-btn e-flat",tooltipText:this.l10n.getConstant("Browse"),align:"Left"}))),o.allowUndoRedo&&!t&&((T.isNullOrUndefined(o.toolbar)||o.toolbar&&-1<o.toolbar.indexOf("Undo"))&&r.push({id:i+"_undo",prefixIcon:"e-icons e-undo",cssClass:"top-icon e-undo",tooltipText:this.l10n.getConstant("Undo"),align:"Left"}),T.isNullOrUndefined(o.toolbar)||o.toolbar&&-1<o.toolbar.indexOf("Redo"))&&r.push({id:i+"_redo",prefixIcon:"e-icons e-redo",cssClass:"top-icon e-redo",tooltipText:this.l10n.getConstant("Redo"),align:"Left"}),!this.preventZoomBtn&&(o.zoomSettings.zoomTrigger&m.ZoomTrigger.Toolbar)===m.ZoomTrigger.Toolbar&&!t&&((T.isNullOrUndefined(o.toolbar)||o.toolbar&&-1<o.toolbar.indexOf("ZoomOut"))&&r.push({id:i+"_zoomOut",prefixIcon:"e-icons e-zoom-out",cssClass:"top-icon e-dec-zoom",tooltipText:this.l10n.getConstant("ZoomOut"),align:"Left"}),T.isNullOrUndefined(o.toolbar)||o.toolbar&&-1<o.toolbar.indexOf("ZoomIn"))&&r.push({id:i+"_zoomIn",prefixIcon:"e-icons e-zoom-in",cssClass:"top-icon e-inc-zoom",tooltipText:this.l10n.getConstant("ZoomIn"),align:"Left"}),this.processToolbar("left")),a=0,s=n.length;a<s;a++)r.push(n[a]);return r},L.prototype.getRightToolbarItem=function(e,t,o){for(var i=this.parent,r=i.element.id,n=[],a=((e||o)&&(n.push({id:r+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),n.push({id:r+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),!t&&T.Browser.isDevice||!(T.isNullOrUndefined(i.toolbar)||i.toolbar&&-1<i.toolbar.indexOf("Reset"))||n.push({id:r+"_reset",prefixIcon:"e-icons e-btn-reset",cssClass:"top-icon e-img-reset",tooltipText:this.l10n.getConstant("Reset"),align:"Right"}),e||(T.isNullOrUndefined(i.toolbar)||i.toolbar&&-1<i.toolbar.indexOf("Save"))&&n.push({id:r+"_save",prefixIcon:"e-icons e-btn-save",cssClass:"e-caret-hide top-icon e-save",tooltipText:this.l10n.getConstant("Save"),align:"Right"}),this.processToolbar("right")),s=0,l=a.length;s<l;s++)n.push(a[s]);return n},L.prototype.getMainToolbarItem=function(e,t,o){for(var i=this.parent,r=i.element.id,n=[],a=(t?((T.isNullOrUndefined(i.toolbar)||!T.isNullOrUndefined(i.toolbar)&&-1<i.toolbar.indexOf("None")||-1<i.toolbar.indexOf("Frame"))&&n.push({id:r+"_none",prefixIcon:"e-icons e-frame-none",cssClass:"top-icon e-frame-none",tooltipText:this.l10n.getConstant("None"),align:"Center"}),(T.isNullOrUndefined(i.toolbar)||!T.isNullOrUndefined(i.toolbar)&&-1<i.toolbar.indexOf("Mat")||-1<i.toolbar.indexOf("Frame"))&&n.push({id:r+"_mat",prefixIcon:"e-icons e-frame-mat",cssClass:"top-icon e-frame-mat",tooltipText:this.l10n.getConstant("Mat"),align:"Center"}),(T.isNullOrUndefined(i.toolbar)||!T.isNullOrUndefined(i.toolbar)&&-1<i.toolbar.indexOf("Bevel")||-1<i.toolbar.indexOf("Frame"))&&n.push({id:r+"_bevel",prefixIcon:"e-icons e-frame-bevel",cssClass:"top-icon e-frame-bevel",tooltipText:this.l10n.getConstant("Bevel"),align:"Center"}),(T.isNullOrUndefined(i.toolbar)||!T.isNullOrUndefined(i.toolbar)&&-1<i.toolbar.indexOf("Line")||-1<i.toolbar.indexOf("Frame"))&&n.push({id:r+"_line",prefixIcon:"e-icons e-frame-line",cssClass:"top-icon e-frame-line",tooltipText:this.l10n.getConstant("Line"),align:"Center"}),(T.isNullOrUndefined(i.toolbar)||!T.isNullOrUndefined(i.toolbar)&&-1<i.toolbar.indexOf("Inset")||-1<i.toolbar.indexOf("Frame"))&&n.push({id:r+"_inset",prefixIcon:"e-icons e-frame-inset",cssClass:"top-icon e-frame-inset",tooltipText:this.l10n.getConstant("Inset"),align:"Center"}),(T.isNullOrUndefined(i.toolbar)||!T.isNullOrUndefined(i.toolbar)&&-1<i.toolbar.indexOf("Hook")||-1<i.toolbar.indexOf("Frame"))&&n.push({id:r+"_hook",prefixIcon:"e-icons e-frame-hook",cssClass:"top-icon e-frame-hook",tooltipText:this.l10n.getConstant("Hook"),align:"Center"})):o?(n.push({id:r+"_redactBlur",prefixIcon:"e-icons e-tint",cssClass:"top-icon e-opacity",tooltipText:this.l10n.getConstant("Blur"),align:"Center"}),n.push({id:r+"_pixelate",prefixIcon:"e-icons e-opacity",cssClass:"top-icon e-opacity",tooltipText:this.l10n.getConstant("Pixelate"),align:"Center"}),n.push({id:r+"_duplicate",prefixIcon:"e-icons e-order",cssClass:"top-icon e-order",tooltipText:this.l10n.getConstant("Duplicate"),align:"Center"}),n.push({id:r+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Center"})):((T.isNullOrUndefined(i.toolbar)||i.toolbar&&-1<i.toolbar.indexOf("Crop"))&&n.push({id:r+"_cropTransform",prefixIcon:"e-icons e-crop",cssClass:"top-icon e-crop",tooltipText:this.l10n.getConstant("CropAndTransform"),align:"Center"}),(T.isNullOrUndefined(i.toolbar)||i.toolbar&&-1<i.toolbar.indexOf("Annotate"))&&n.push({id:r+"_annotation",tooltipText:this.l10n.getConstant("Annotation"),align:"Center",template:'<button id="'+r+'_annotationBtn"></button>'}),(T.isNullOrUndefined(i.toolbar)||i.toolbar&&-1<i.toolbar.indexOf("Finetune"))&&n.push({id:r+"_adjustment",prefixIcon:"e-icons e-adjustment",cssClass:"top-icon e-adjustment",tooltipText:this.l10n.getConstant("Finetune"),align:"Center"}),(T.isNullOrUndefined(i.toolbar)||i.toolbar&&-1<i.toolbar.indexOf("Filter"))&&n.push({id:r+"_filter",prefixIcon:"e-icons e-filters",cssClass:"top-icon e-filters",tooltipText:this.l10n.getConstant("Filter"),align:"Center"}),(T.isNullOrUndefined(i.toolbar)||!T.isNullOrUndefined(i.toolbar)&&-1<i.toolbar.indexOf("Frame"))&&n.push({id:r+"_frame",prefixIcon:"e-icons e-border-frame",cssClass:"top-icon e-border-frame",tooltipText:this.l10n.getConstant("Frame"),align:"Center"}),(T.isNullOrUndefined(i.toolbar)||!T.isNullOrUndefined(i.toolbar)&&-1<i.toolbar.indexOf("Resize"))&&n.push({id:r+"_resize",prefixIcon:"e-icons e-resize",cssClass:"top-icon e-resize",tooltipText:this.l10n.getConstant("Resize"),align:"Center"}),(T.isNullOrUndefined(i.toolbar)||!T.isNullOrUndefined(i.toolbar)&&-1<i.toolbar.indexOf("Redact"))&&n.push({id:r+"_redact",prefixIcon:"e-icons e-redact",cssClass:"top-icon e-opacity",tooltipText:this.l10n.getConstant("Redact"),align:"Center"})),this.processToolbar("center")),s=0,l=a.length;s<l;s++)n.push(a[s]);return e&&(n.push({id:r+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),n.push({id:r+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),n},L.prototype.getZoomToolbarItem=function(){return[]},L.prototype.updateContextualToolbar=function(e,t,o){var i,r=this.parent,n=r.element.id,a=r.element.querySelector("#"+n+"_toolbarArea"),s=r.element.querySelector("#"+n+"_contextualToolbarArea");s&&(s.classList.remove("e-hide"),s.style.left=a.offsetLeft+"px","filter"===e?((a=document.getElementById(n+"_toolbar"))&&0<this.defToolbarItems.length&&T.getComponent(a,"toolbar").destroy(),T.Browser.isDevice?this.initMainToolbar(!1,!0,!0):this.initMainToolbar(!0,null,null),this.refreshSlider(),this.initFilterToolbarItem()):((i=document.querySelector("#"+n+"_contextualToolbar")).classList.contains("e-control")&&T.getComponent(i,"toolbar").destroy(),this.refreshSlider(),"frame"===e?this.initFrameToolbarItem():this.renderSlider(t,o)),r.toolbarTemplate?this.toolbarHeight=r.element.querySelector("#"+n+"_toolbarArea").clientHeight:r.element.querySelector("#"+n+"_toolbar")&&(this.toolbarHeight=r.element.querySelector("#"+n+"_toolbar").clientHeight),r.toolbarHeight=this.toolbarHeight,T.Browser.isDevice?(a=s.offsetHeight+1,e=r.element.querySelector("#"+n+"_customizeWrapper"),this.isFrameToolbar&&e&&(a=e.offsetHeight+2),e=r.element.querySelector("#"+n+"_canvasWrapper").offsetHeight,s.style.top=this.toolbarHeight+1+e-a+"px","straighten"===t&&(r.isStraightening=!0,"absolute"===(i=r.element.querySelector("#"+n+"_contextualToolbarArea")).style.position)&&(i.style.position="",r.element.insertBefore(i,r.element.querySelector("#"+n+"_bottomToolbarArea")),r.update(),o)&&r.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:this.getCropTextContent(document.getElementById(n+"_cropBtn")).toLowerCase(),startX:null,startY:null,width:null,height:null}})):s.style.top=this.toolbarHeight+1+"px")},L.prototype.processToolbar=function(e){var t=this.parent,o=[];if(t.toolbar)for(var i=0,r=t.toolbar.length;i<r;i++)"object"==typeof t.toolbar[i]&&(T.isNullOrUndefined(t.toolbar[i].align)?"left"===e&&o.push(t.toolbar[i]):t.toolbar[i].align.toLowerCase()===e&&o.push(t.toolbar[i]));return o},L.prototype.processSubToolbar=function(e){var t=[];if(e)for(var o=0,i=e.length;o<i;o++)"object"==typeof e[o]&&(e[o].align="Center",t.push(e[o]));return t},L.prototype.wireZoomBtnEvents=function(){var e=document.querySelector("#"+this.parent.element.id+"_zoomIn"),t=document.querySelector("#"+this.parent.element.id+"_zoomOut");e&&(e.addEventListener("mousedown",this.zoomInBtnMouseDownHandler.bind(this)),e.addEventListener("mouseup",this.zoomBtnMouseUpHandler.bind(this)),e.addEventListener("click",this.zoomInBtnClickHandler.bind(this))),t&&(t.addEventListener("mousedown",this.zoomOutBtnMouseDownHandler.bind(this)),t.addEventListener("mouseup",this.zoomBtnMouseUpHandler.bind(this)),t.addEventListener("click",this.zoomOutBtnClickHandler.bind(this)))},L.prototype.widthPress=function(e){109===e.keyCode&&e.preventDefault()},L.prototype.heightPress=function(e){109===e.keyCode&&e.preventDefault()},L.prototype.widthAspectRatio=function(e){var t,o,i,r,n;109!==e.keyCode&&9!==e.keyCode&&(o=(e=this.parent).element.id,n=e.element.querySelector("#"+o+"_resizeHeight"),t=e.element.querySelector("#"+o+"_resizeWidth"),o=e.element.querySelector("#"+o+"_aspectratio"),r=e.img.destWidth,i=e.img.destHeight,i=.5<=(n=parseFloat(n.value)/(i/r))%1||n%1<=-.5?Math.round(n):n<0?Math.ceil(n):Math.floor(n),r=T.getComponent(t,"numerictextbox"),n=T.getComponent(t,"numerictextbox"),o)&&(null==i||isNaN(i)?T.isNullOrUndefined(r.value)?(r.placeholder="0 px",t.placeholder="0 px",T.isNullOrUndefined(n.value)&&!T.isNullOrUndefined(n.placeholder)&&(r.placeholder=""+e.img.srcWidth,t.placeholder=""+e.img.srcWidth)):(r.value=0,t.value="0 px"):T.isNullOrUndefined(r.value)?(r.placeholder=i+" px",t.placeholder=i.toString()+" px"):(r.value=i,t.value=i.toString()+" px"))},L.prototype.heightAspectRatio=function(e){var t,o,i,r,n;109!==e.keyCode&&9!==e.keyCode&&(o=(e=this.parent).element.id,t=e.element.querySelector("#"+o+"_resizeHeight"),n=e.element.querySelector("#"+o+"_resizeWidth"),o=e.element.querySelector("#"+o+"_aspectratio"),r=e.img.destWidth,i=e.img.destHeight,i=.5<=(r=parseFloat(n.value)/(r/i))%1||r%1<=-.5?Math.round(r):r<0?Math.ceil(r):Math.floor(r),r=T.getComponent(t,"numerictextbox"),n=T.getComponent(n,"numerictextbox"),o)&&(isNaN(i)?T.isNullOrUndefined(r.value)?(r.placeholder="0 px",t.placeholder="0 px",T.isNullOrUndefined(n.value)&&!T.isNullOrUndefined(n.placeholder)&&(r.placeholder=""+e.img.srcHeight,t.placeholder=""+e.img.srcHeight)):(r.value=0,t.value="0 px"):T.isNullOrUndefined(r.value)?(r.placeholder=i+" px",t.placeholder=i.toString()+" px"):(r.value=i,t.value=i.toString()+" px"))},L.prototype.getResizeToolbarItem=function(){var e=this.parent,t=e.element.id,o=!(!e.aspectWidth||!e.aspectHeight),i=(this.parent.transform.degree%90==0&&this.parent.transform.degree%180!=0?Math.ceil(this.parent.img.srcHeight):Math.ceil(this.parent.img.srcWidth)).toString(),r=(this.parent.transform.degree%90==0&&this.parent.transform.degree%180!=0?Math.ceil(this.parent.img.srcWidth):Math.ceil(this.parent.img.srcHeight)).toString(),n=[],a=document.createElement("span"),a=(a.innerHTML=this.l10n.getConstant("W"),n.push({id:t+"_width",cssClass:"e-ie-resize-width",template:a,align:"Center"}),n.push({id:t+"_resizeWidth",prefixIcon:"e-icons e-anti-clock-wise",tooltipText:this.l10n.getConstant("Width"),align:"Center",type:"Input",template:new g.NumericTextBox({width:75,htmlAttributes:{maxLength:"4"},showSpinButton:!1,value:o?e.aspectWidth:null,placeholder:o?null:i,format:"###.## px"})}),document.createElement("span"));return a.innerHTML=this.l10n.getConstant("H"),n.push({id:t+"_height",cssClass:"e-ie-resize-height",template:a,align:"Center"}),n.push({id:t+"_resizeHeight",prefixIcon:"e-icons e-clock-wise",tooltipText:this.l10n.getConstant("Height"),align:"Center",type:"Input",template:new g.NumericTextBox({width:75,htmlAttributes:{maxLength:"4"},showSpinButton:!1,value:o?e.aspectHeight:null,placeholder:o?null:r,format:"###.## px"})}),this.isAspectRatio?(n.push({id:t+"_nonaspectratio",prefixIcon:"e-icons e-unlock",align:"Center",tooltipText:this.l10n.getConstant("AspectRatio"),type:"Button"}),this.isAspectRatio=!1):(n.push({id:t+"_aspectratio",prefixIcon:"e-icons e-lock",align:"Center",tooltipText:this.l10n.getConstant("AspectRatio"),type:"Button",tabIndex:0}),this.isAspectRatio=!0),T.Browser.isDevice||(n.push({id:t+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),n.push({id:t+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),n},L.prototype.initResizeToolbar=function(){var e=this,t=this.parent,o=t.element.id,i=this.getLeftToolbarItem(!1,!0),r=this.getRightToolbarItem(),n=this.getResizeToolbarItem(),a=this.getZoomToolbarItem(),i=(T.Browser.isDevice?this.defToolbarItems=n:this.defToolbarItems=i.concat(a,n,r),{toolbarType:"resize",toolbarItems:this.defToolbarItems}),s=(t.trigger("toolbarUpdating",i),this.defToolbarItems=i.toolbarItems,new c.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){e.wireResizeBtnEvents(),t.trigger("toolbarCreated",{toolbarType:"shapes"}),T.Browser.isDevice?0<e.defToolbarItems.length&&!T.isNullOrUndefined(document.getElementById(o+"_bottomToolbar"))&&s.refreshOverflow():(e.createLeftToolbarControls(),0<e.defToolbarItems.length&&!T.isNullOrUndefined(document.getElementById(o+"_toolbar"))&&s.refreshOverflow())}}));T.Browser.isDevice?s.appendTo("#"+o+"_bottomToolbar"):s.appendTo("#"+o+"_toolbar"),t.isResize=!1,this.enableDisableTbrBtn(),t.isResize=!0,t.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}})},L.prototype.wireResizeBtnEvents=function(){var e=this.parent,t=e.element.id,o=e.element.querySelector("#"+t+"_resizeHeight"),e=e.element.querySelector("#"+t+"_resizeWidth");T.isNullOrUndefined(o)||(o.addEventListener("keydown",this.widthPress.bind(this)),e.addEventListener("keyup",this.heightAspectRatio.bind(this))),T.isNullOrUndefined(e)||(e.addEventListener("keydown",this.heightPress.bind(this)),o.addEventListener("keyup",this.widthAspectRatio.bind(this)))},L.prototype.enableDisableTbrBtn=function(){var e=this.parent,t=e.element.id,o=(this.preventEnableDisableUr||(e.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:o={appliedUndoRedoColl:[]}}}),e.notify("undo-redo",{prop:"getUndoRedoStep",value:{obj:i={undoRedoStep:null}}}),(r=e.element.querySelector("#"+t+"_undo"))&&0===i.undoRedoStep?(r.classList.add("e-disabled"),r.parentElement.classList.add("e-overlay")):r&&0<i.undoRedoStep&&(r.classList.remove("e-disabled"),r.parentElement.classList.remove("e-overlay")),(r=e.element.querySelector("#"+t+"_redo"))&&i.undoRedoStep===o.appliedUndoRedoColl.length?(r.classList.add("e-disabled"),r.parentElement.classList.add("e-overlay")):(r&&0===i.undoRedoStep&&0<o.appliedUndoRedoColl.length||r&&0<i.undoRedoStep)&&(r.classList.remove("e-disabled"),r.parentElement.classList.remove("e-overlay"))),document.querySelector("#"+t+"_zoomIn")),i=(o&&e.zoomSettings.zoomFactor>=e.zoomSettings.maxZoomFactor?(o.classList.add("e-disabled"),o.parentElement.classList.add("e-overlay")):o&&(o.classList.remove("e-disabled"),o.parentElement.classList.remove("e-overlay")),document.querySelector("#"+t+"_zoomOut")),r=(i&&e.zoomSettings.zoomFactor<=e.zoomSettings.minZoomFactor?(i.classList.add("e-disabled"),i.parentElement.classList.add("e-overlay")):i&&(i.classList.remove("e-disabled"),i.parentElement.classList.remove("e-overlay")),document.querySelector("#"+t+"_frame")),o=(r&&(e.currSelectionPoint&&"crop-circle"===e.currSelectionPoint.shape||e.isCircleCrop)?r.classList.add("e-overlay"):r&&r.classList.remove("e-overlay"),document.querySelector("#"+t+"_aspectratio"));o&&(e.currSelectionPoint&&"crop-circle"===e.currSelectionPoint.shape||e.isCircleCrop)?o.classList.add("e-overlay"):o&&o.classList.remove("e-overlay")},L.prototype.createLeftToolbarControls=function(){var e,t=this.parent,o=t.element.id;void 0!==this.defToolbarItems&&0<this.defToolbarItems.length&&document.getElementById(o+"_toolbar")&&(o=document.getElementById(o+"_toolbar").querySelector(".e-image-upload"))&&(e=o.getElementsByTagName("input")[0],(o=o.getElementsByTagName("button")[0]).className="e-tbar-btn e-tbtn-txt top-icon",o.innerHTML="",o.title=this.l10n.getConstant("Browse"),o.appendChild(t.createElement("span",{className:"e-btn-icon e-icons e-upload-icon e-icon-left"})),e.onchange=this.fileSelect.bind(this,e))},L.prototype.fileSelect=function(e,t){var o=this.parent,i=e.files[0].type.split("/")[1],r=this.parent.getExtensionArray(),o=("jpg"===i||"jpeg"===i)&&(-1<o.uploadSettings.allowedExtensions.indexOf("jpg")||-1<o.uploadSettings.allowedExtensions.indexOf("jpeg")),n=(this.fileName=e.files[0].name.split(".")[0],e.files[0].size);this.parent.notify("toolbar",{prop:"setInitialSize",value:{value:e.files[0].size}}),(-1<r.indexOf(i)||o||-1<i.indexOf("svg")&&-1<r.indexOf("svg"))&&(!this.parent.uploadSettings.minFileSize||n>this.parent.uploadSettings.minFileSize)&&(!this.parent.uploadSettings.maxFileSize||n<this.parent.uploadSettings.maxFileSize)?this.parent.notify("draw",{prop:"fileSelect",value:{inputElement:e,args:t}}):(this.parent.isImageLoaded||(this.destroyTopToolbar(),this.createToolbar(),T.Browser.isDevice&&this.destroyBottomToolbar()),this.parent.showDialogPopup("unsupported",!(-1<r.indexOf(i)||o||-1<i.indexOf("svg")&&-1<r.indexOf("svg"))))},L.prototype.triggerTbarClickEvent=function(e){e={item:e.item,originalEvent:e.event};this.parent.trigger("toolbarItemClicked",e)},L.prototype.renderAnnotationBtn=function(e){var p=this,h=this.parent,t=!1,o=[],d=h.element.id,i=["Ellipse","Arrow","Line","Rectangle","Pen","Path","Text","Image"];if(h.toolbar)for(var r=0;r<i.length;r++)if(-1!==h.toolbar.indexOf(i[r])){t=!0;break}(T.isNullOrUndefined(h.toolbar)||!t||h.toolbar&&-1<h.toolbar.indexOf("Pen"))&&o.push({text:this.l10n.getConstant("Pen"),id:"pen",iconCss:"e-icons e-free-pen"}),(T.isNullOrUndefined(h.toolbar)||!t||h.toolbar&&-1<h.toolbar.indexOf("Line"))&&o.push({text:this.l10n.getConstant("Line"),id:"line",iconCss:"e-icons e-line"}),(T.isNullOrUndefined(h.toolbar)||!t||h.toolbar&&-1<h.toolbar.indexOf("Rectangle"))&&o.push({text:this.l10n.getConstant("Rectangle"),id:"rectangle",iconCss:"e-icons e-rectangle"}),(T.isNullOrUndefined(h.toolbar)||!t||h.toolbar&&-1<h.toolbar.indexOf("Ellipse"))&&o.push({text:this.l10n.getConstant("Ellipse"),id:"ellipse",iconCss:"e-icons e-circle"}),(T.isNullOrUndefined(h.toolbar)||!t||h.toolbar&&-1<h.toolbar.indexOf("Arrow"))&&o.push({text:this.l10n.getConstant("Arrow"),id:"arrow",iconCss:"e-icons e-arrow-right-up"}),(T.isNullOrUndefined(h.toolbar)||!t||h.toolbar&&-1<h.toolbar.indexOf("Path"))&&o.push({text:this.l10n.getConstant("Path"),id:"path",iconCss:"e-icons e-critical-path"}),(T.isNullOrUndefined(h.toolbar)||!t||h.toolbar&&-1<h.toolbar.indexOf("Text"))&&o.push({text:this.l10n.getConstant("Text"),id:"text",iconCss:"e-icons e-add-text"}),(T.isNullOrUndefined(h.toolbar)||!t||h.toolbar&&-1<h.toolbar.indexOf("Image"))&&o.push({text:this.l10n.getConstant("Image"),id:"image",iconCss:"e-icons e-image"});var n={freehandDrawSelectedId:null},a=(h.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:n}}),T.Browser.isDevice?"#"+d+"_bottomToolbar #"+d:"#"+d),a=(this.enableDisableCloneBtn(a,n),e?this.getCurrentShapeIcon(h.activeObj.shape):"e-annotation"),c=new v.DropDownButton({items:o,iconCss:"e-icons "+a,cssClass:"e-image-popup",open:function(e){(h.currObjType.isFiltered||h.currObjType.isRedact)&&(h.okBtn(),h.element.querySelector("#"+d+"_annotationBtn").click()),T.Browser.isDevice&&(e.element.parentElement.style.top=c.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px"),h.activeObj.shape?document.getElementById(h.activeObj.shape).classList.add("e-selected"):h.togglePen&&document.getElementById("pen").classList.add("e-selected")},select:function(e){h.noPushUndo=!1,p.triggerTbarClickEvent(e),h.okBtn();var t,o,i,r=!1,n=((void 0===(l=void 0!==h.activeObj.shape?h.activeObj.shape.split("-"):l)&&h.currObjType.isCustomCrop||void 0!==l&&"crop"===l[0])&&(r=!0),h.currObjType.isCustomCrop=!1,(r||h.togglePan)&&(h.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),p.upperContext.clearRect(0,0,h.upperCanvas.width,h.upperCanvas.height),p.refreshToolbar("main")),{currentFreehandDrawIndex:null}),a=(h.notify("freehand-draw",{prop:"getCurrentFreehandDrawIndex",value:{obj:n}}),{shapeSettingsObj:{}}),s=(c.iconCss="e-icons "+p.getCurrentShapeIcon(e.item.id),h.notify("draw",{prop:"updateTempObjColl"}),h.notify("draw",{prop:"updateTempPointColl"}),{penStrokeWidth:2});switch(e.item.id){case"pen":h.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:s}}),h.notify("draw",{prop:"setTempStrokeWidth",value:{strokeWidth:s.penStrokeWidth}}),h.drawingShape=null,h.notify("draw",{prop:"setTempFreehandCounter",value:{tempFreehandCounter:h.freehandCounter}}),h.notify("draw",{prop:"setTempCurrentFreehandDrawIndex",value:{tempCurrentFreehandDrawIndex:n.currentFreehandDrawIndex}}),p.currentToolbar="pen",h.freeHandDraw(!0),h.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:a}}),t=a.shapeSettingsObj,h.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:s}}),t.strokeWidth=s.penStrokeWidth,t.type=m.ShapeType.FreehandDraw,h.notify("freehand-draw",{prop:"triggerShapeChanging",value:{shapeChangingArgs:o={cancel:!1,action:"insert",previousShapeSettings:t,currentShapeSettings:t}}});break;case"text":p.currentToolbar="text",h.drawingShape=e.item.id,p.currentToolbar="text",p.setInitialShapeSettings(e),h.notify("selection",{prop:"annotate",value:{shape:e.item.id}}),h.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});break;case"image":h.drawingShape=null,p.currentToolbar="shapes",h.element.querySelector("#"+d+"_fileUpload").click();break;case"ellipse":case"arrow":case"line":case"rectangle":case"path":h.drawingShape=e.item.id,p.currentToolbar="shapes",p.setInitialShapeSettings(e),h.notify("selection",{prop:"annotate",value:{shape:e.item.id}}),h.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),h.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:a}}),t=a.shapeSettingsObj,i=-1===["ellipse","rectangle","text","image"].indexOf(p.parent.activeObj.shape),h.trigger("shapeChanging",o={cancel:!1,action:"insert",previousShapeSettings:t,currentShapeSettings:t,allowShapeOverflow:i}),h.editCompleteArgs=o,h.notify("shape",{prop:"updateShapeChangeEventArgs",value:{shapeSettings:o.currentShapeSettings}})}p.updateToolbarItems();var l=h.togglePen;"pen"===e.item.id&&(h.togglePen=!1),h.notify("draw",{prop:"redrawDownScale"}),h.togglePen=l}});c.appendTo("#"+d+"_annotationBtn")},L.prototype.enableDisableCloneBtn=function(e,t){var o=this.parent,i=!1,r=Math.floor(o.activeObj.activePoint.width),r=(o.activeObj.shape&&"text"===o.activeObj.shape&&11===o.activeObj.textSettings.fontSize&&(55===r||o.activeObj.textSettings.bold&&58===r)&&11===Math.floor(o.activeObj.activePoint.height)&&(i=!0),document.querySelector(e+"_duplicate")),n=document.querySelector(e+"_remove"),a=document.querySelector(e+"_editText"),e=document.querySelector(e+"_zOrderBtn");i||0===o.activeObj.activePoint.width&&0===o.activeObj.activePoint.height&&(T.isNullOrUndefined(o.activeObj.pointColl)||o.activeObj.pointColl&&0===o.activeObj.pointColl.length)&&T.isNullOrUndefined(t.freehandDrawSelectedId)?(r&&r.classList.add("e-overlay"),n&&n.classList.add("e-overlay"),a&&a.classList.add("e-overlay"),e&&e.classList.add("e-overlay")):(r&&r.classList.remove("e-overlay"),n&&n.classList.remove("e-overlay"),a&&a.classList.remove("e-overlay"),e&&e.classList.remove("e-overlay")),e&&(0===o.shapeColl.length||t.freehandDrawSelectedId&&1===o.shapeColl.length)&&e.classList.add("e-overlay")},L.prototype.renderStraightenSlider=function(){var e=this.parent,t=e.element.id;(T.isNullOrUndefined(e.toolbar)||e.toolbar&&-1<e.toolbar.indexOf("Straightening"))&&e.element.querySelector("#"+t+"_straightenSlider")&&((e=this.createSlider(-45,45,e.cropObj.straighten,"straighten")).appendTo("#"+t+"_straightenSlider"),t=e.element.querySelector(".e-handle"))&&!T.Browser.isDevice&&(t.addEventListener("mousedown",function(e){e.preventDefault(),e.stopPropagation()}),t.addEventListener("touchstart",function(e){e.preventDefault(),e.stopPropagation()}))},L.prototype.renderCropBtn=function(e){var t,o=this,i=this.parent,r=[],n=!1,a=["CustomSelection","CircleSelection","SquareSelection","RatioSelection"];if(i.toolbar)for(var s=0;s<a.length;s++)if(-1!==i.toolbar.indexOf(a[s])){n=!0;break}(T.isNullOrUndefined(i.toolbar)||!n||i.toolbar&&-1<i.toolbar.indexOf("CustomSelection"))&&r.push({text:this.l10n.getConstant("Custom"),id:"custom",iconCss:"e-icons e-custom"}),(T.isNullOrUndefined(i.toolbar)||!n||i.toolbar&&-1<i.toolbar.indexOf("CircleSelection"))&&r.push({text:this.l10n.getConstant("Circle"),id:"circle",iconCss:"e-icons e-circle"}),(T.isNullOrUndefined(i.toolbar)||!n||i.toolbar&&-1<i.toolbar.indexOf("SquareSelection"))&&r.push({text:this.l10n.getConstant("Square"),id:"square",iconCss:"e-icons e-square"}),(T.isNullOrUndefined(i.toolbar)||!n||i.toolbar&&-1<i.toolbar.indexOf("RatioSelection"))&&(r.push({text:"2:3",id:"2:3",iconCss:"e-icons e-custom-f"}),r.push({text:"3:2",id:"3:2",iconCss:"e-icons e-custom-a"}),r.push({text:"3:4",id:"3:4",iconCss:"e-icons e-custom-g"}),r.push({text:"4:3",id:"4:3",iconCss:"e-icons e-custom-b"}),r.push({text:"4:5",id:"4:5",iconCss:"e-icons e-custom-h"}),r.push({text:"5:4",id:"5:4",iconCss:"e-icons e-custom-c"}),r.push({text:"5:7",id:"5:7",iconCss:"e-icons e-custom-i"}),r.push({text:"7:5",id:"7:5",iconCss:"e-icons e-custom-d"}),r.push({text:"9:16",id:"9:16",iconCss:"e-icons e-custom-j"}),r.push({text:"16:9",id:"16:9",iconCss:"e-icons e-custom-e"}));var e=e?(t=this.getCurrentShapeIcon(e),e):i.activeObj.shape&&(0!==i.activeObj.activePoint.width||0!==i.activeObj.activePoint.height)||"path"===i.activeObj.shape&&0<i.activeObj.pointColl.length?(t=this.getCurrentShapeIcon(i.activeObj.shape),i.activeObj.shape):i.currSelectionPoint?(t=this.getCurrentShapeIcon(i.currSelectionPoint.shape),i.currSelectionPoint.shape):(t=r[0].iconCss,r[0].id),l=new v.DropDownButton({open:function(e){i.togglePan&&o.cancelPan(),T.Browser.isDevice&&(e.element.parentElement.style.top=l.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px"),i.activeObj.shape&&1<i.activeObj.shape.split("-").length&&(e=document.getElementById(i.activeObj.shape.split("-")[1]))&&(e.classList.add("e-selected"),e.focus()),i.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}})},items:r,select:function(e){o.triggerTbarClickEvent(e),o.cropSelect(e),l.iconCss="e-icons "+o.getCurrentShapeIcon("crop-"+e.item.id),l.content=T.Browser.isDevice?null:i.toPascalCase(e.item.id)},iconCss:"e-icons "+t,cssClass:"e-image-popup e-ie-crop-ddb-popup",content:T.Browser.isDevice?null:i.toPascalCase(e.replace("crop-",""))});l.appendTo("#"+i.element.id+"_cropBtn")},L.prototype.renderTransformBtn=function(){var t=this,o=this.parent,e=[],i=((T.isNullOrUndefined(o.toolbar)||o.toolbar&&-1<o.toolbar.indexOf("RotateLeft"))&&e.push({text:this.l10n.getConstant("RotateLeft"),id:"rotateleft",iconCss:"e-icons e-anti-clock-wise"}),(T.isNullOrUndefined(o.toolbar)||o.toolbar&&-1<o.toolbar.indexOf("RotateRight"))&&e.push({text:this.l10n.getConstant("RotateRight"),id:"rotateright",iconCss:"e-icons e-clock-wise"}),(T.isNullOrUndefined(o.toolbar)||o.toolbar&&-1<o.toolbar.indexOf("FlipHorizontal"))&&e.push({text:this.l10n.getConstant("HorizontalFlip"),id:"horizontalflip",iconCss:"e-icons e-horizontal-flip"}),(T.isNullOrUndefined(o.toolbar)||o.toolbar&&-1<o.toolbar.indexOf("FlipVertical"))&&e.push({text:this.l10n.getConstant("VerticalFlip"),id:"verticalflip",iconCss:"e-icons e-vertical-flip"}),new v.DropDownButton({open:function(e){var t;T.Browser.isDevice&&(t=(e=e.element.parentElement).offsetHeight,e.style.display="none",e.style.top=i.element.getBoundingClientRect().top-t+"px",e.style.display="block")},items:e,select:function(e){t.triggerTbarClickEvent(e),o.transformSelect.bind(t)},iconCss:"e-icons e-transform",cssClass:"e-image-popup"}));i.appendTo("#"+o.element.id+"_transformBtn")},L.prototype.saveDialogPopup=function(){var i=this,e=this.parent,r=e.element.id,t=(e.element.appendChild(e.createElement("div",{id:r+"_saveDialog"})),e.createElement("div",{id:r+"_dialogContent"})),o=(t.style.display="flex",t.appendChild(e.createElement("div",{id:r+"_dialogImgContent",className:"e-ie-dlg-img-content"})));o.appendChild(e.createElement("canvas",{id:r+"_imgPic",className:"e-ie-img-dlg-canvas"}));o.appendChild(e.createElement("div",{id:r+"_imageNameContainer",className:"e-ie-img-size"})).appendChild(e.createElement("span",{id:r+"_imageNameLabel",className:"e-ie-quality-info"}));var o=t.appendChild(e.createElement("div",{id:r+"_dialogRightContent",className:"e-ie-dlg-right-content"})),n=o.appendChild(e.createElement("div",{id:r+"_namediv",className:"e-ie-img-save-name"})),n=(n.appendChild(e.createElement("span",{id:r+"_labelImgname",className:"e-ie-img-label-name",innerHTML:this.l10n.getConstant("ImageName")})),n.appendChild(e.createElement("input",{id:r+"_imgNametext",className:"e-ie-img-input",attrs:{type:"text"}})),o.appendChild(e.createElement("div",{id:r+"_imgNamediv",className:"e-ie-img-save-dlg"}))),n=(n.appendChild(e.createElement("span",{id:r+"_labelname",className:"e-ie-img-label-name",innerHTML:this.l10n.getConstant("Format")})),n.appendChild(e.createElement("button",{id:r+"_saveDropdownbtn",attrs:{tabindex:"1"}})),o.appendChild(e.createElement("div",{id:r+"_imgQualitydiv",className:"e-ie-img-quality-name"}))),a=e.createElement("div",{id:r+"_qualityContainer"});a.appendChild(e.createElement("span",{id:r+"_qualityLabel",className:"e-ie-img-quality-label",innerHTML:this.l10n.getConstant("Quality")})),a.appendChild(e.createElement("span",{id:r+"_qualityInfo",className:"e-circle-info e-icons e-ie-quality-span",attrs:{title:this.l10n.getConstant("QualityInfo")}}));a.appendChild(e.createElement("div",{id:r+"_imgsizeSpan",className:"e-ie-img-size-value-span"})).appendChild(e.createElement("span",{id:r+"_imgsizeValueSpan",className:""})),n.appendChild(a);var a=e.createElement("div",{id:r+"_qualityOptionContainer",className:"e-ie-quality-option-container"}),s=n.appendChild(e.createElement("div",{id:r+"_qualityButtonGroup",className:"e-btn-group"})),l=(["Good","Great","Highest"].forEach(function(e){var t=document.createElement("input"),o=(t.type="radio",t.id=r+"_"+e.toLowerCase(),t.name="quality",t.value=e.toLowerCase(),document.createElement("label"));o.className="e-btn",o.htmlFor=e.toLowerCase(),o.textContent=i.l10n.getConstant(e),s.appendChild(t),s.appendChild(o)}),a.appendChild(s),a.appendChild(e.createElement("div",{id:r+"_qualitySlider",className:"e-ie-img-quality-slider"})),a.appendChild(e.createElement("button",{id:r+"_qualitybuttonIcon",className:"e-ie-img-icon-button",attrs:{type:"button"}})),n.appendChild(a),T.Browser.isDevice&&o.appendChild(e.createElement("span",{id:r+"_qualitySize",className:"e-ie-img-quality-size"})),e.element.querySelector("#"+r+"_saveDialog").style.display="block",e.element.appendChild(t),new f.Dialog({target:e.element,header:this.l10n.getConstant("SaveAs"),closeOnEscape:!0,content:document.getElementById(r+"_dialogContent"),width:T.Browser.isDevice?"345px":"570px",isModal:!0,animationSettings:{effect:"Zoom"},beforeOpen:this.onBeforeopen(),close:this.saveDialogClosed.bind(this,r),cssClass:"e-ie-save-dialog",buttons:[{click:function(){l.hide()},buttonModel:{content:this.l10n.getConstant("Close"),cssClass:"e-save-cancel-btn"}},{click:function(){i.download(),l.hide(),i.isSlider=!1},buttonModel:{isPrimary:!0,content:this.l10n.getConstant("Download"),cssClass:"e-flat e-save-download-btn"}}]}));l.appendTo("#"+r+"_saveDialog")},L.prototype.saveDialogClosed=function(e){T.getComponent(document.getElementById(e+"_saveDropdownbtn"),"dropdownbutton")&&T.getComponent(document.getElementById(e+"_saveDropdownbtn"),"dropdownbutton").destroy(),this.isSlider=!1,document.querySelector("#"+e+"_qualityButtonGroup")&&document.querySelector("#"+e+"_qualitySlider")&&(document.querySelector("#"+e+"_qualityButtonGroup").remove(),document.querySelector("#"+e+"_qualitySlider").remove(),document.querySelector("#"+e+"_imgsizeValueSpan").remove(),document.querySelector("#"+e+"_imageNameLabel").remove(),document.querySelector("#"+e+"_imgsizeSpan").remove()),document.getElementById(e+"_dialogContent").remove(),T.getComponent(document.getElementById(e+"_saveDialog"),"dialog").destroy(),document.getElementById(e+"_saveDialog").remove()},L.prototype.onBeforeopen=function(){var t=this,e=this.parent,o=e.element.id,i={canvas:null},r=(new g.TextBox({placeholder:this.l10n.getConstant("ImageName")}).appendTo("#"+o+"_imgNametext"),document.getElementById(o+"_imgQualitydiv")),n=document.getElementById(o+"_qualitySlider"),a=document.querySelector("#"+o+"_qualityButtonGroup"),s=document.querySelector("#"+o+"_qualitybuttonIcon"),l=document.querySelector("#"+o+"_imgsizeSpan"),p=T.Browser.isDevice?document.getElementById(o+"_qualitySize"):document.getElementById(o+"_imageNameLabel"),h={fileName:"",fileType:""},e=(e.notify("draw",{prop:"getFileName",onPropertyChange:!1,value:{obj:h}}),this.fileType=h.fileType||"JPEG",e.notify("export",{prop:"exportToCanvas",value:{object:i}}),i.canvas),d=document.getElementById(o+"_imgPic");d.width=e.width,d.height=e.height;new X.Button({iconCss:"e-icons e-settings"}).appendTo("#"+o+"_qualitybuttonIcon");var c,u,d=document.getElementById(o+"_saveDropdownbtn");d&&((c=document.createElement("span")).innerHTML="Webp"===this.fileType?"Webp":this.fileType.toUpperCase(),d&&d.appendChild(c),(u=new v.DropDownButton({items:[{id:"jpeg",text:"JPEG"},{id:"png",text:"PNG"},{id:"svg",text:"SVG"},{id:"webp",text:"WebP"}],open:function(e){T.Browser.isDevice&&(e.element.parentElement.style.top=u.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px");var t=c.innerHTML;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){l.style.display="none",t.fileType=c.innerHTML=e.item.text,"jpeg"!==e.item.id?(r.style.display="none",p.style.display="block",t.updateImageSize(1,i.canvas,t.fileType),n&&(t.isSlider&&T.getComponent(n,"slider").destroy(),n.style.display="none"),t.isSlider=!1):(r.style.display="block",T.removeClass([a],"e-hide"),n.style.display="none",p.style.display="block",t.updateImageSize(T.isNullOrUndefined(t.currentQuality)?1:t.currentQuality,i.canvas,t.fileType),document.getElementById(o+"_"+t.imageQuality).checked=!0)}})).appendTo("#"+o+"_saveDropdownbtn"),document.getElementById(o+"_imgNametext").value=this.fileName||h.fileName,h.fileType&&"JPEG"!==h.fileType.toUpperCase()&&(r.style.display="none",l.style.display="none"),T.Browser.isDevice&&(document.getElementById(o+"_dialogImgContent").style.display="none",document.getElementById(o+"_dialogRightContent").style.width="100%"),this.updateImageSize(1,i.canvas,this.fileType)),document.getElementById(o+"_"+this.imageQuality).checked=!0,a.addEventListener("click",this.qualityBtnClickHandler.bind(this)),s.addEventListener("click",this.qualityBtnClickHandler.bind(this))},L.prototype.qualityBtnClickHandler=function(e){var t=this,o=this.parent,i=o.element.id,r=e.target,n={canvas:null},a={Good:.8,Great:.9,Highest:1},s=document.querySelector("#"+i+"_qualityButtonGroup"),l=document.querySelector("#"+i+"_qualitySlider"),p=document.querySelector("#"+i+"_qualityOptionContainer"),h=document.querySelector("#"+i+"_imgsizeSpan"),d=document.querySelector("#"+i+"_imgsizeValueSpan");o.notify("draw",{prop:"getFileName",onPropertyChange:!1,value:{obj:{fileName:""}}}),o.notify("export",{prop:"exportToCanvas",value:{object:n}}),e.currentTarget.id!==i+"_qualitybuttonIcon"||this.isSlider?e.currentTarget.id===i+"_qualitybuttonIcon"&&this.isSlider?(T.getComponent(l,"slider").destroy(),l.style.display="none",h.style.display="none",T.removeClass([s],"e-hide"),p.style.display="block",this.isSlider=!1):a.hasOwnProperty(r.textContent)&&!this.isSlider&&(e.target.previousElementSibling.checked=!0,this.currentQuality=a[r.textContent],this.imageQuality=r.textContent.toLowerCase(),this.updateImageSize(a[r.textContent],n.canvas,"jpeg")):(T.addClass([s],"e-hide"),l.style.display="block",h.style.display="inline-block",p.style.display="flex",(e=new g.Slider({tooltip:{placement:"Before",isVisible:!0,format:"P0",showOn:"Focus"},min:.01,max:1,step:.01,value:this.currentQuality,type:"MinRange",width:T.Browser.isDevice?"80%":"190px",created:function(){t.updateImageSize(t.currentQuality,n.canvas,"jpeg"),d.innerHTML=Math.round(100*t.currentQuality).toString()},changed:function(e){t.currentQuality=e.value,d.innerHTML=Math.round(100*t.currentQuality).toString(),o.notify("export",{prop:"setImageQuality",value:{value:e.value}}),t.updateImageSize(e.value,n.canvas,"jpeg")}})).appendTo("#"+i+"_qualitySlider"),e.element.parentElement.classList.add("e-ie-quality-slider"),this.isSlider=!0)},L.prototype.updateImageSize=function(e,t,o){var i,r,n=this.parent.element.id,a=document.getElementById(n+"_imgPic"),s=a.getContext("2d"),l=T.Browser.isDevice?document.getElementById(n+"_qualitySize"):document.getElementById(n+"_imageNameLabel");"jpeg"===o.toLowerCase()?t.toBlob(function(e){var t,o;i=1e3<(i=Math.floor(e.size/1024))?(t=i/1024,l.innerHTML=this.l10n.getConstant("ImageSize")+": "+t.toFixed(2)+" MB",+t.toFixed(2)):(l.innerHTML=this.l10n.getConstant("ImageSize")+": "+i.toFixed(2)+" KB",+i.toFixed(2)),T.Browser.isDevice?a.style.display="none":((o=new Image).src=URL.createObjectURL(e),o.onload=function(){s.drawImage(o,0,0),URL.revokeObjectURL(o.src)}),this.fileSize=i}.bind(this),"image/jpeg",e):T.isNullOrUndefined(o)||"png"!==o.toLowerCase()&&"webp"!==o.toLowerCase()?T.isNullOrUndefined(o)||"svg"!==o.toLowerCase()?T.Browser.isDevice?a.style.display="none":(s.drawImage(t,0,0),1e3<this.initialSize?(r=this.initialSize/1048576,l.innerHTML=this.l10n.getConstant("ImageSize")+": "+r.toFixed(2)+" MB"):l.innerHTML=this.l10n.getConstant("ImageSize")+": "+this.initialSize.toFixed(2)+" KB"):(s.drawImage(t,0,0),n=t.toDataURL("image/svg+xml").split(",")[1].length,e=1e3<(e=Math.floor(n/1024))?(r=e/1024,l.innerHTML=this.l10n.getConstant("ImageSize")+": "+r.toFixed(2)+" MB",+r.toFixed(2)):(l.innerHTML=this.l10n.getConstant("ImageSize")+": "+e.toFixed(2)+" KB",+e.toFixed(2)),T.Browser.isDevice&&(a.style.display="none"),this.fileSize=e):(n="image/"+o.toLowerCase(),s.drawImage(t,0,0),t.toBlob(function(e){i=1e3<(i=Math.floor(e.size/1024))?(e=i/1024,l.innerHTML=this.l10n.getConstant("ImageSize")+": "+e.toFixed(2)+" MB",+e.toFixed(2)):(l.innerHTML=this.l10n.getConstant("ImageSize")+": "+i.toFixed(2)+" KB",+i.toFixed(2)),T.Browser.isDevice&&(a.style.display="none"),this.fileSize=i}.bind(this),n,1))},L.prototype.download=function(){var e=this.parent,t=e.element.id,o=("JPEG"===this.fileType&&this.isSlider?(o=T.getComponent(document.getElementById(t+"_qualitySlider"),"slider").value,e.notify("export",{prop:"setImageQuality",value:{value:o}})):e.notify("export",{prop:"setImageQuality",value:{value:this.currentQuality}}),document.getElementById(t+"_imgNametext").value);e.export(this.fileType,o)},L.prototype.getCropTransformToolbarItem=function(){var e,t=this.parent,o=t.element.id,i=[];return i.push({id:o+"_crop",tooltipText:this.l10n.getConstant("CropSelection"),align:"Center",template:'<button id="'+o+'_cropBtn"></button>'}),i.push({align:"Center",type:"Separator"}),(T.isNullOrUndefined(t.toolbar)||t.toolbar&&(-1<t.toolbar.indexOf("Transform")||-1<t.toolbar.indexOf("RotateLeft")))&&i.push({id:o+"_rotateLeft",prefixIcon:"e-icons e-anti-clock-wise",tooltipText:this.l10n.getConstant("RotateLeft"),align:"Center"}),(T.isNullOrUndefined(t.toolbar)||t.toolbar&&(-1<t.toolbar.indexOf("Transform")||-1<t.toolbar.indexOf("RotateRight")))&&i.push({id:o+"_rotateRight",prefixIcon:"e-icons e-clock-wise",tooltipText:this.l10n.getConstant("RotateRight"),align:"Center"}),2<i.length&&i.push({align:"Center",type:"Separator"}),(T.isNullOrUndefined(t.toolbar)||t.toolbar&&(-1<t.toolbar.indexOf("Transform")||-1<t.toolbar.indexOf("HorizontalFlip")))&&i.push({id:o+"_horizontalFlip",prefixIcon:"e-icons e-horizontal-flip",tooltipText:this.l10n.getConstant("HorizontalFlip"),align:"Center"}),(T.isNullOrUndefined(t.toolbar)||t.toolbar&&(-1<t.toolbar.indexOf("Transform")||-1<t.toolbar.indexOf("VerticalFlip")))&&i.push({id:o+"_verticalFlip",prefixIcon:"e-icons e-vertical-flip",tooltipText:this.l10n.getConstant("VerticalFlip"),align:"Center"}),(T.isNullOrUndefined(t.toolbar)||t.toolbar&&-1<t.toolbar.indexOf("Straightening"))&&!T.Browser.isDevice&&(i.push({align:"Center",type:"Separator"}),T.isNullOrUndefined(t.toolbar)||t.toolbar&&-1<t.toolbar.indexOf("Straightening"))&&((e=document.createElement("span")).innerHTML=this.l10n.getConstant("Straighten"),i.push({id:o+"_straightenSpan",cssClass:"e-ie-straighten-span",template:e,align:"Center"}),i.push({id:o+"_straighten",cssClass:"top-icon e-straighten",tooltipText:this.l10n.getConstant("Straighten"),align:"Center",type:"Input",template:'<div id="'+o+'_straightenSlider"></div>'}),(e=document.createElement("span")).innerHTML=t.transform.straighten.toString()+"&#176",i.push({id:o+"_straightenSpan",cssClass:"e-ie-straighten-value-span",template:e,align:"Center"})),T.Browser.isDevice||(i.push({id:o+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),i.push({id:o+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),i},L.prototype.getShapesToolbarItem=function(e){for(var t=this.parent,o=t.element.id,i=[],r=((T.isNullOrUndefined(t.toolbar)||t.toolbar)&&i.push({id:o+"_annotation",tooltipText:this.l10n.getConstant("Annotation"),align:"Center",template:'<button id="'+o+'_annotationBtn"></button>'}),-1<e.indexOf("fillColor")&&i.push({prefixIcon:"e-icons e-copy",id:o+"_fillcolor",cssClass:"top-icon e-fill",tooltipText:this.l10n.getConstant("FillColor"),align:"Center",type:"Input",template:'<button id="'+o+'_fillColorBtn"></button>'}),-1<e.indexOf("strokeColor")&&i.push({prefixIcon:"e-icons e-copy",id:o+"_strokecolor",cssClass:"top-icon e-stroke",tooltipText:this.l10n.getConstant("StrokeColor"),align:"Center",type:"Input",template:'<button id="'+o+'_borderColorBtn"></button>'}),-1<e.indexOf("strokeWidth")&&i.push({id:o+"_strokeWidth",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("StrokeWidth"),align:"Center",type:"Input",template:'<button id="'+o+'_borderWidthBtn"></button>'}),-1<e.indexOf("start")&&i.push({id:o+"_start",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Start"),align:"Center",type:"Input",template:'<button id="'+o+'_startBtn"></button>'}),-1<e.indexOf("borderRadius")&&i.push({id:o+"_rectangleRadius",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("BorderRadius"),align:"Center",type:"Input",template:'<button id="'+o+'_rectangleRadiusBtn"></button>'}),-1<e.indexOf("end")&&i.push({id:o+"_end",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("End"),align:"Center",type:"Input",template:'<button id="'+o+'_endBtn"></button>'}),-1<e.indexOf("flip")&&(i.push({id:o+"_rotLeft",prefixIcon:"e-anti-clock-wise",tooltipText:this.l10n.getConstant("RotateLeft"),align:"Center"}),i.push({id:o+"_rotRight",prefixIcon:"e-clock-wise",tooltipText:this.l10n.getConstant("RotateRight"),align:"Center"}),i.push({id:o+"_hFlip",prefixIcon:"e-horizontal-flip",tooltipText:this.l10n.getConstant("HorizontalFlip"),align:"Center"}),i.push({id:o+"_vFlip",prefixIcon:"e-vertical-flip",tooltipText:this.l10n.getConstant("VerticalFlip"),align:"Center"})),-1<e.indexOf("transparency")&&(i.push({align:"Center",type:"Separator"}),i.push({id:o+"_transparency",prefixIcon:"e-opacity",tooltipText:this.l10n.getConstant("Opacity"),align:"Center"})),i.push({align:"Center",type:"Separator"}),-1<e.indexOf("z-order")&&i.push({id:o+"_zOrder",cssClass:"top-icon e-list-unordered-3",tooltipText:this.l10n.getConstant("ZOrder"),align:"Center",type:"Input",template:'<button id="'+o+'_zOrderBtn"></button>'}),-1<e.indexOf("duplicate")&&i.push({id:o+"_duplicate",prefixIcon:"e-icons e-order",cssClass:"top-icon e-order",tooltipText:this.l10n.getConstant("Duplicate"),align:"Center"}),-1<e.indexOf("remove")&&i.push({id:o+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Center"}),-1<e.indexOf("text")&&i.push({id:o+"_editText",prefixIcon:"e-icons e-annotation-edit",cssClass:"top-icon e-annotation-edit",tooltipText:this.l10n.getConstant("EditText"),align:"Center"}),this.processSubToolbar(e)),n=0,a=r.length;n<a;n++)i.push(r[n]);return T.Browser.isDevice||(t.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:e={shape:null}}}),"path"!==e.shape&&(i.push({id:o+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),i.push({id:o+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"}))),i},L.prototype.initCropTransformToolbar=function(e,t){var o=this,i=this.parent,r=i.element.id,n=this.getLeftToolbarItem(),a=this.getRightToolbarItem(),s=this.getCropTransformToolbarItem(),l=this.getZoomToolbarItem(),n=(T.Browser.isDevice?this.defToolbarItems=s:this.defToolbarItems=n.concat(l,s,a),{toolbarType:"crop-transform",toolbarItems:this.defToolbarItems}),p=(i.trigger("toolbarUpdating",n),this.defToolbarItems=n.toolbarItems,new c.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){o.renderCropBtn(e),o.renderStraightenSlider(),o.wireZoomBtnEvents(),i.trigger("toolbarCreated",{toolbarType:"shapes"}),T.Browser.isDevice?0<o.defToolbarItems.length&&document.getElementById(r+"_bottomToolbar")&&(p.refreshOverflow(),p.refreshOverflow(),p.refreshOverflow()):(o.createLeftToolbarControls(),0<o.defToolbarItems.length&&document.getElementById(r+"_toolbar")&&p.refreshOverflow()),document.getElementById(r+"_cropBtn")&&T.isNullOrUndefined(t)&&(T.Browser.isDevice||i.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:o.getCropTextContent(document.getElementById(r+"_cropBtn")).toLowerCase(),startX:null,startY:null,width:null,height:null}}))}})),l=(T.Browser.isDevice?p.appendTo("#"+r+"_bottomToolbar"):p.appendTo("#"+r+"_toolbar"),i.element.querySelector("#"+r+"_straightenSlider"));(T.isNullOrUndefined(i.toolbar)||i.toolbar&&-1<i.toolbar.indexOf("Straightening"))&&l&&l.parentElement.clientHeight>this.toolbarHeight&&(this.toolbarHeight=i.toolbarHeight=l.parentElement.clientHeight),this.enableDisableTbrBtn(),i.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}})},L.prototype.getCropTextContent=function(e){if(e){var t,o={"e-custom":"Custom","e-circle":"Circle","e-square":"Square","e-custom-a":"3:2","e-custom-b":"4:3","e-custom-c":"5:4","e-custom-d":"7:5","e-custom-e":"16:9","e-custom-f":"2:3","e-custom-g":"3:4","e-custom-h":"4:5","e-custom-i":"5:7","e-custom-j":"9:16"},i=e.children[0].classList;for(t in o)if(i.contains(t))return o[t]}return""},L.prototype.getCurrentShapeIcon=function(e){var t={rectangle:"e-rectangle",ellipse:"e-circle",line:"e-line",arrow:"e-arrow-right-up",path:"e-critical-path",text:"e-add-text",image:"e-image",pen:"e-free-pen","crop-custom":"e-custom","crop-circle":"e-circle","crop-square":"e-square","crop-3:2":"e-custom-a","crop-4:3":"e-custom-b","crop-5:4":"e-custom-c","crop-7:5":"e-custom-d","crop-16:9":"e-custom-e","crop-2:3":"e-custom-f","crop-3:4":"e-custom-g","crop-4:5":"e-custom-h","crop-5:7":"e-custom-i","crop-9:16":"e-custom-j"};return t[e]||(e&&-1!==e.indexOf("crop-")?"e-custom":"e-free-pen")},L.prototype.initShapesToolbarItem=function(e){var t=this,o=this.parent,i=o.element.id,r=this.getLeftToolbarItem(),n=this.getRightToolbarItem(),a=this.getShapesToolbarItem(e),s=this.getZoomToolbarItem(),r=(T.Browser.isDevice?this.defToolbarItems=a:this.defToolbarItems=r.concat(s,a,n),{toolbarType:o.activeObj.shape||"shapes",toolbarItems:this.defToolbarItems}),l=(o.trigger("toolbarUpdating",r),this.isToolbarString(r.toolbarItems)?(e=r.toolbarItems,this.excludeItems(r.toolbarItems)):this.defToolbarItems=r.toolbarItems,new c.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){t.renderAnnotationBtn(!0),t.createRectangleRadius(e),t.createShapeColor(e),t.createShapeBtn(e),t.createZOrderBtn(e),"arrow"===o.activeObj.shape&&(e.some(function(e){return-1<e.toLowerCase().indexOf("start")})&&t.createStartBtn(),e.some(function(e){return-1<e.toLowerCase().indexOf("end")}))&&t.createEndBtn(),t.wireZoomBtnEvents(),o.trigger("toolbarCreated",{toolbarType:"shapes"}),T.Browser.isDevice?0<t.defToolbarItems.length&&document.getElementById(i+"_bottomToolbar")&&(l.refreshOverflow(),l.refreshOverflow(),l.refreshOverflow()):(t.createLeftToolbarControls(),0<t.defToolbarItems.length&&document.getElementById(i+"_toolbar")&&l.refreshOverflow())}}));T.Browser.isDevice?l.appendTo("#"+i+"_bottomToolbar"):l.appendTo("#"+i+"_toolbar"),this.enableDisableTbrBtn()},L.prototype.createRectangleRadius=function(e){var t,o,i,r=this,n=this.parent,a=n.element.id;-1<e.indexOf("borderRadius")&&(e=[{id:"1",text:this.l10n.getConstant("0")},{id:"2",text:this.l10n.getConstant("20")},{id:"3",text:this.l10n.getConstant("40")},{id:"4",text:this.l10n.getConstant("60")},{id:"5",text:this.l10n.getConstant("80")},{id:"6",text:this.l10n.getConstant("100")}],t=document.getElementById(a+"_rectangleRadiusBtn"),(o=document.createElement("span")).innerHTML=this.l10n.getConstant(n.frameObj.radius.toString()),o.className="e-shape-rectangle-radius",t.appendChild(o),(i=new v.DropDownButton({items:e,open:function(e){T.Browser.isDevice&&((t=e.element.parentElement).style.top=i.element.getBoundingClientRect().top-t.offsetHeight+"px");var t=i.element.childNodes[0].textContent;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){r.triggerTbarClickEvent(e),o.textContent=e.item.text,n.updateStrokeWidth(e.item.id,"radius"),T.Browser.isDevice?document.getElementById(a+"_bottomToolbar")&&T.getComponent(a+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(a+"_toolbar")&&T.getComponent(a+"_toolbar","toolbar").refreshOverflow(),n.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}})).appendTo("#"+a+"_rectangleRadiusBtn"))},L.prototype.beforeModeSwitch=function(e,t){this.popupLeft=e.element.offsetParent.style.left,"Picker"===e.mode?(t.showButtons=!0,t.dataBind(),e.element.querySelector(".e-apply").title=this.l10n.getConstant("Apply"),e.element.querySelector(".e-cancel").title=this.l10n.getConstant("Cancel"),e.element.querySelector(".e-mode-switch-btn").title=this.l10n.getConstant("StandardColors")):(t.showButtons=!1,t.dataBind(),e.element.querySelector(".e-mode-switch-btn").title=this.l10n.getConstant("MoreColors"))},L.prototype.createShapeColor=function(e){var t,o,i,r,n=this,a=this.parent,s=a.element.id;-1<e.indexOf("fillColor")&&(a.element.querySelector(".e-template.e-fill").appendChild(a.createElement("input",{id:s+"_shape_fill"})),t=new g.ColorPicker({modeSwitcher:!0,noColor:!0,value:"",inline:!0,showButtons:!1,mode:"Palette",cssClass:"e-shape-fill-color",beforeModeSwitch:function(e){return n.beforeModeSwitch(e,t)},presetColors:{custom:["","#f44336","#e91e63","#9c27b0","#673ab7","#2196f3","#03a9f4","#00bcd4","#009688","#ffeb3b","#ffffff","#ffebee","#fce4ec","#f3e5f5","#ede7f6","#e3f2fd","#e1f5fe","#e0f7fa","#e0f2f1","#fffde7","#f2f2f2","#ffcdd2","#f8bbd0","#e1bee7","#d1c4e9","#bbdefb","#b3e5fc","#b2ebf2","#b2dfdb","#fff9c4","#e6e6e6","#ef9a9a","#f48fb1","#ce93d8","#b39ddb","#90caf9","#81d4fa","#80deea","#80cbc4","#fff59d","#cccccc","#e57373","#f06292","#ba68c8","#9575cd","#64b5f6","#4fc3f7","#4dd0e1","#4db6ac","#fff176","#b3b3b3","#ef5350","#ec407a","#ab47bc","#7e57c2","#42a5f5","#29b6f6","#26c6da","#26a69a","#ffee58","#999999","#e53935","#d81b60","#8e24aa","#5e35b1","#1e88e5","#039be5","#00acc1","#00897b","#fdd835","#808080","#d32f2f","#c2185b","#7b1fa2","#512da8","#1976d2","#0288d1","#0097a7","#00796b","#fbc02d","#666666","#c62828","#ad1457","#6a1b9a","#4527a0","#1565c0","#0277bd","#00838f","#00695c","#f9a825","#4d4d4d","#b71c1c","#880e4f","#4a148c","#311b92","#0d47a1","#01579b","#006064","#004d40","#f57f17"]},beforeTileRender:function(e){""===e.value&&e.element.classList.add("e-nocolor-item")},change:function(e){a.updateFillColor(e.value),""===e.currentValue.rgba?o.element.children[0].classList.add("e-nocolor-item"):(o.element.children[0].classList.remove("e-nocolor-item"),o.element.children[0].style.backgroundColor=e.currentValue.rgba),o.toggle(),a.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})},onModeSwitch:function(e){T.Browser.isDevice&&(e.element.parentElement.parentElement.style.left=n.popupLeft,e.element.parentElement.parentElement.style.top=o.element.getBoundingClientRect().top-e.element.parentElement.parentElement.offsetHeight+"px")},beforeClose:function(){o.toggle()}},"#"+s+"_shape_fill"),o=new v.DropDownButton({open:function(e){e=e.element.parentElement;T.Browser.isDevice&&(e.style.top=o.element.getBoundingClientRect().top-e.offsetHeight+"px",window.innerWidth<=520)&&(e.style.left=a.element.offsetLeft+"px")},target:".e-shape-fill-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+s+"_fillColorBtn"),t.inline=!0,t.value=t.getValue(t.value,"rgba"),a.element.querySelector(".e-fill.e-template .e-dropdownbtn-preview").classList.add("e-nocolor-item")),-1<e.indexOf("strokeColor")&&(a.element.querySelector(".e-template.e-stroke").appendChild(a.createElement("input",{id:s+"_shape_stroke"})),i=new g.ColorPicker({modeSwitcher:!0,noColor:!1,value:"#fff",inline:!0,showButtons:!1,mode:"Palette",cssClass:"e-shape-stroke-color",beforeModeSwitch:function(e){n.popupLeft=e.element.offsetParent.style.left,i.value="#fff"!==a.activeObj.strokeSettings.strokeColor?a.activeObj.strokeSettings.strokeColor:"#008000ff",n.beforeModeSwitch(e,i)},presetColors:this.presetColors,change:function(e){a.updateStrokeColor(e.value),r.element.children[0].style.backgroundColor=e.currentValue.rgba,r.toggle(),a.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})},onModeSwitch:function(e){T.Browser.isDevice&&(e.element.parentElement.parentElement.style.left=n.popupLeft,e.element.parentElement.parentElement.style.top=r.element.getBoundingClientRect().top-e.element.parentElement.parentElement.offsetHeight+"px")},beforeClose:function(){r.toggle()}},"#"+s+"_shape_stroke"),r=new v.DropDownButton({open:function(e){e=e.element.parentElement;T.Browser.isDevice&&(e.style.top=r.element.getBoundingClientRect().top-e.offsetHeight+"px",window.innerWidth<=520)&&(e.style.left=a.element.offsetLeft+"px")},target:".e-shape-stroke-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+s+"_borderColorBtn"),i.inline=!0,i.value=i.getValue(i.value,"rgba"),a.element.querySelector(".e-stroke.e-template .e-dropdownbtn-preview").style.background="#fff")},L.prototype.createShapeBtn=function(e){var t,o,i,r=this,n=this.parent,a=n.element.id;-1<e.indexOf("strokeWidth")&&(e=[{id:"1",text:this.l10n.getConstant("XSmall")},{id:"2",text:this.l10n.getConstant("Small")},{id:"3",text:this.l10n.getConstant("Medium")},{id:"4",text:this.l10n.getConstant("Large")},{id:"5",text:this.l10n.getConstant("XLarge")}],!n.activeObj.shape||"rectangle"!==n.activeObj.shape&&"ellipse"!==n.activeObj.shape||(e=[{id:"1",text:this.l10n.getConstant("NoOutline")},{id:"2",text:this.l10n.getConstant("XSmall")},{id:"3",text:this.l10n.getConstant("Small")},{id:"4",text:this.l10n.getConstant("Medium")},{id:"5",text:this.l10n.getConstant("Large")},{id:"6",text:this.l10n.getConstant("XLarge")}]),t=document.getElementById(a+"_borderWidthBtn"),(o=document.createElement("span")).innerHTML=this.l10n.getConstant("XSmall"),o.className="e-shape-stroke-width",t.appendChild(o),(i=new v.DropDownButton({items:e,open:function(e){T.Browser.isDevice&&(e.element.parentElement.style.top=i.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px");var t=o.innerHTML;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){r.triggerTbarClickEvent(e),o.textContent=e.item.text,n.updateStrokeWidth(e.item.id,"width",n.activeObj.shape),T.Browser.isDevice?document.getElementById(a+"_bottomToolbar")&&T.getComponent(a+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(a+"_toolbar")&&T.getComponent(a+"_toolbar","toolbar").refreshOverflow(),n.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}})).appendTo("#"+a+"_borderWidthBtn"))},L.prototype.createZOrderBtn=function(e){var t,o=this,i=this.parent,r=i.element.id;-1<e.indexOf("z-order")&&(e=[{text:this.l10n.getConstant("BringForward"),id:"bringForward",iconCss:"e-icons e-bring-forward"},{text:this.l10n.getConstant("SendBackward"),id:"sendBackward",iconCss:"e-icons e-send-backward"},{text:this.l10n.getConstant("BringToFront"),id:"bringToFront",iconCss:"e-icons e-bring-to-front"},{text:this.l10n.getConstant("SendToBack"),id:"sendToBack",iconCss:"e-icons e-send-to-back"}],(t=new v.DropDownButton({items:e,iconCss:"e-icons e-layers",beforeOpen:function(e){document.getElementById(i.element.id+"_zOrderBtn").classList.contains("e-disabled")&&(e.cancel=!0);var t={freehandSelectedIndex:-1},o=(i.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:t}}),{order:null}),t=(i.notify("shape",{prop:"getHighestOrder",onPropertyChange:!1,value:{obj:o}}),i.activeObj.order||i.getObjFromId(i.pointColl[t.freehandSelectedIndex].id).order);t&&o.order<=t?(e.items[0].disabled=!0,e.items[2].disabled=!0):(e.items[0].disabled=!1,e.items[2].disabled=!1),i.notify("shape",{prop:"getLowestOrder",onPropertyChange:!1,value:{obj:o}}),t&&t<=o.order?(e.items[1].disabled=!0,e.items[3].disabled=!0):(e.items[1].disabled=!1,e.items[3].disabled=!1)},open:function(e){T.Browser.isDevice&&(e.element.parentElement.style.top=t.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px")},select:function(e){o.triggerTbarClickEvent(e);var t={freehandDrawSelectedId:null},t=(i.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:t}}),t.freehandDrawSelectedId||i.activeObj.currIndex);i.updateShapeOrder(t,e.item.id),T.Browser.isDevice?document.getElementById(r+"_bottomToolbar")&&T.getComponent(r+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(r+"_toolbar")&&T.getComponent(r+"_toolbar","toolbar").refreshOverflow(),-1<t.indexOf("shape")?i.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1}):-1<t.indexOf("pen")&&i.notify("undo-redo",{prop:"updateUndoRedoStack",value:{isPenDraw:!0}})}})).appendTo("#"+r+"_zOrderBtn"))},L.prototype.createStartBtn=function(){var t=this,o=this.parent,e=o.element.id,i=[{id:"1",text:this.l10n.getConstant("None")},{id:"2",text:this.l10n.getConstant("Bar")},{id:"3",text:this.l10n.getConstant("Arrow")},{id:"4",text:this.l10n.getConstant("ArrowSolid")},{id:"5",text:this.l10n.getConstant("Circle")},{id:"6",text:this.l10n.getConstant("CircleSolid")},{id:"7",text:this.l10n.getConstant("Square")},{id:"8",text:this.l10n.getConstant("SquareSolid")}],r=document.getElementById(e+"_startBtn"),n=document.createElement("span"),a=(T.isNullOrUndefined(o.activeObj.start)&&(o.activeObj.start="none"),n.innerHTML=o.pascalToSplitWords(o.activeObj.start),n.className="e-shape-start",r.appendChild(n),new v.DropDownButton({items:i,open:function(e){T.Browser.isDevice&&(e.element.parentElement.style.top=a.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px");var t=n.innerHTML;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){o.notify("selection",{prop:"setArrowShape",value:{type:"initial",shape:{1:"none",2:"bar",3:"arrow",4:"arrowSolid",5:"circle",6:"circleSolid",7:"square",8:"squareSolid"}[""+e.item.id]}}),t.triggerTbarClickEvent(e),n.textContent=e.item.text,o.updateArrow("startArrow",e.item.id),o.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}}));a.appendTo("#"+e+"_startBtn")},L.prototype.createEndBtn=function(){var t=this,o=this.parent,e=o.element.id,i=[{id:"1",text:this.l10n.getConstant("None")},{id:"2",text:this.l10n.getConstant("Bar")},{id:"3",text:this.l10n.getConstant("Arrow")},{id:"4",text:this.l10n.getConstant("ArrowSolid")},{id:"5",text:this.l10n.getConstant("Circle")},{id:"6",text:this.l10n.getConstant("CircleSolid")},{id:"7",text:this.l10n.getConstant("Square")},{id:"8",text:this.l10n.getConstant("SquareSolid")}],r=document.getElementById(e+"_endBtn"),n=document.createElement("span"),a=(T.isNullOrUndefined(o.activeObj.end)&&(o.activeObj.end="arrowSolid"),n.innerHTML=o.pascalToSplitWords(o.activeObj.end),n.className="e-shape-end",r.appendChild(n),new v.DropDownButton({items:i,open:function(e){T.Browser.isDevice&&(e.element.parentElement.style.top=a.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px");var t=n.innerHTML;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){o.notify("selection",{prop:"setArrowShape",value:{type:"final",shape:{1:"none",2:"bar",3:"arrow",4:"arrowSolid",5:"circle",6:"circleSolid",7:"square",8:"squareSolid"}[""+e.item.id]}}),t.triggerTbarClickEvent(e),n.textContent=e.item.text,o.updateArrow("endArrow",e.item.id),o.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}}));a.appendTo("#"+e+"_endBtn")},L.prototype.getTextToolbarItem=function(e){for(var t=this.parent,o=t.element.id,i=[],r=((T.isNullOrUndefined(t.toolbar)||t.toolbar)&&i.push({id:o+"_annotation",tooltipText:this.l10n.getConstant("Annotation"),align:"Center",template:'<button id="'+o+'_annotationBtn"></button>'}),-1<e.indexOf("fontFamily")&&i.push({id:o+"_fontFamily",cssClass:"top-icon e-img-font-family",tooltipText:this.l10n.getConstant("FontFamily"),align:"Center",template:'<button id="'+o+'_fontFamilyBtn"></button>'}),-1<e.indexOf("fontSize")&&i.push({id:o+"_fontSize",cssClass:"top-icon e-img-font-size",tooltipText:this.l10n.getConstant("FontSize"),align:"Center",template:'<button id="'+o+'_fontSizeBtn"></button>'}),-1<e.indexOf("fontColor")&&i.push({cssClass:"top-icon e-text-font-color",id:o+"_text_strokecolor",tooltipText:this.l10n.getConstant("FontColor"),align:"Center",type:"Input",template:'<button id="'+o+'_fontColorBtn"></button>'}),-1<e.indexOf("strokeColor")&&i.push({cssClass:"top-icon e-stroke-text-font-color",id:o+"_stroke_text_color",tooltipText:this.l10n.getConstant("TextOutlineColor"),align:"Center",type:"Input",template:'<button id="'+o+'_strokeTextColorBtn"></button>'}),-1<e.indexOf("fillColor")&&i.push({cssClass:"top-icon e-text-background-color",id:o+"_text_backgroundcolor",tooltipText:this.l10n.getConstant("FillColor"),align:"Center",type:"Input",template:'<button id="'+o+'_bgColorBtn"></button>'}),-1<e.indexOf("bold")&&i.push({id:o+"_bold",prefixIcon:"e-icons e-bold",cssClass:"top-icon e-bold",tooltipText:this.l10n.getConstant("Bold"),align:"Center"}),-1<e.indexOf("italic")&&i.push({id:o+"_italic",prefixIcon:"e-icons e-italic",cssClass:"top-icon e-italic",tooltipText:this.l10n.getConstant("Italic"),align:"Center"}),-1<e.indexOf("strokeWidth")&&i.push({id:o+"_strokeWidth",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("TextOutlineWidth"),align:"Center",type:"Input",template:'<button id="'+o+'_borderWidthBtn"></button>'}),-1<e.indexOf("transparency")&&i.push({id:o+"_transparency",prefixIcon:"e-opacity",tooltipText:this.l10n.getConstant("Opacity"),align:"Center"}),i.push({align:"Center",type:"Separator"}),-1<e.indexOf("z-order")&&i.push({id:o+"_zOrder",cssClass:"top-icon e-list-unordered-3",tooltipText:this.l10n.getConstant("ZOrder"),align:"Center",type:"Input",template:'<button id="'+o+'_zOrderBtn"></button>'}),-1<e.indexOf("duplicate")&&i.push({id:o+"_duplicate",prefixIcon:"e-icons e-order",cssClass:"top-icon e-order",tooltipText:this.l10n.getConstant("Duplicate"),align:"Center",disabled:"block"===t.textArea.style.display||"inline-block"===t.textArea.style.display}),-1<e.indexOf("remove")&&i.push({id:o+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Center",disabled:"block"===t.textArea.style.display||"inline-block"===t.textArea.style.display}),-1<e.indexOf("text")&&i.push({id:o+"_editText",prefixIcon:"e-icons e-annotation-edit",cssClass:"top-icon e-annotation-edit",tooltipText:this.l10n.getConstant("EditText"),align:"Center",disabled:"block"===t.textArea.style.display||"inline-block"===t.textArea.style.display}),this.processSubToolbar(e)),n=0,a=r.length;n<a;n++)i.push(r[n]);return T.Browser.isDevice||(i.push({id:o+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),i.push({id:o+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),i},L.prototype.getFontFamilyItems=function(){var e=this.parent;return e.fontFamily&&e.fontFamily.items&&0<e.fontFamily.items.length?e.fontFamily.items:T.Browser.isDevice?[{id:"arial",text:"ABC"},{id:"calibri",text:"ABC"},{id:"georgia",text:"ABC"},{id:"roboto",text:"ABC"},{id:"tahoma",text:"ABC"}]:[{id:"arial",text:"Arial"},{id:"calibri",text:"Calibri"},{id:"georgia",text:"Georgia"},{id:"roboto",text:"Roboto"},{id:"tahoma",text:"Tahoma"}]},L.prototype.initTextToolbarItem=function(e){var t=this,o=this.parent,i=o.element.id,r=this.getLeftToolbarItem(),n=this.getRightToolbarItem(),a=this.getTextToolbarItem(e),s=this.getZoomToolbarItem(),r=(T.Browser.isDevice?this.defToolbarItems=a:this.defToolbarItems=r.concat(s,a,n),{toolbarType:"text",toolbarItems:this.defToolbarItems}),l=(o.trigger("toolbarUpdating",r),this.isToolbarString(r.toolbarItems)?(e=r.toolbarItems,this.excludeItems(r.toolbarItems)):this.defToolbarItems=r.toolbarItems,new c.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){t.renderAnnotationBtn(!0),t.createTextColor(e),t.createStrokeTextColor(e),t.createShapeBtn(e),t.createBackgroundColor(e),t.createTextBtn(e),t.createZOrderBtn(e),t.wireZoomBtnEvents(),o.trigger("toolbarCreated",{toolbarType:"text"}),T.Browser.isDevice?0<t.defToolbarItems.length&&document.getElementById(i+"_bottomToolbar")&&(l.refreshOverflow(),l.refreshOverflow(),l.refreshOverflow()):(t.createLeftToolbarControls(),0<t.defToolbarItems.length&&document.getElementById(i+"_toolbar")&&l.refreshOverflow())}}));T.Browser.isDevice?l.appendTo("#"+i+"_bottomToolbar"):l.appendTo("#"+i+"_toolbar"),this.enableDisableTbrBtn()},L.prototype.createTextColor=function(e){var t,o,i=this,r=this.parent,n=r.element.id;-1<e.indexOf("fontColor")&&r.element.querySelector(".e-template.e-text-font-color")&&(r.element.querySelector(".e-template.e-text-font-color").appendChild(r.createElement("input",{id:n+"_text_font"})),t=new g.ColorPicker({modeSwitcher:!0,noColor:!1,value:"#fff",inline:!0,showButtons:!1,mode:"Palette",cssClass:"e-text-fontt-color",beforeModeSwitch:function(e){i.popupLeft=e.element.offsetParent.style.left,t.value="#fff"!==r.activeObj.strokeSettings.strokeColor?r.activeObj.strokeSettings.strokeColor:"#008000ff",i.beforeModeSwitch(e,t)},presetColors:this.presetColors,change:function(e){r.updateFontColor(e.value,"Text"),o.element.children[0].style.backgroundColor=e.currentValue.rgba,o.toggle(),0===r.activeObj.activePoint.width&&0===r.activeObj.activePoint.height||r.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})},onModeSwitch:function(e){T.Browser.isDevice&&(e.element.parentElement.parentElement.style.left=i.popupLeft,e.element.parentElement.parentElement.style.top=o.element.getBoundingClientRect().top-e.element.parentElement.parentElement.offsetHeight+"px")},beforeClose:function(){o.toggle()}},"#"+n+"_text_font"),o=new v.DropDownButton({open:function(e){e=e.element.parentElement;T.Browser.isDevice&&(e.style.top=o.element.getBoundingClientRect().top-e.offsetHeight+"px",window.innerWidth<=520)&&(e.style.left=r.element.offsetLeft+"px")},target:".e-text-fontt-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+n+"_fontColorBtn"),t.inline=!0,t.value=t.getValue(t.value,"rgba"),r.element.querySelector(".e-text-font-color.e-template .e-dropdownbtn-preview").style.background="#fff")},L.prototype.createBackgroundColor=function(e){var t,o,i=this,r=this.parent,n=r.element.id;-1<e.indexOf("fillColor")&&r.element.querySelector(".e-template.e-text-background-color")&&(r.element.querySelector(".e-template.e-text-background-color").appendChild(r.createElement("input",{id:n+"_text_bgColor"})),t=new g.ColorPicker({modeSwitcher:!0,noColor:!0,value:"",inline:!0,showButtons:!1,mode:"Palette",cssClass:"e-text-fontt-color",beforeModeSwitch:function(e){i.popupLeft=e.element.offsetParent.style.left,i.beforeModeSwitch(e,t)},presetColors:{custom:["","#f44336","#e91e63","#9c27b0","#673ab7","#2196f3","#03a9f4","#00bcd4","#009688","#ffeb3b","#ffffff","#ffebee","#fce4ec","#f3e5f5","#ede7f6","#e3f2fd","#e1f5fe","#e0f7fa","#e0f2f1","#fffde7","#f2f2f2","#ffcdd2","#f8bbd0","#e1bee7","#d1c4e9","#bbdefb","#b3e5fc","#b2ebf2","#b2dfdb","#fff9c4","#e6e6e6","#ef9a9a","#f48fb1","#ce93d8","#b39ddb","#90caf9","#81d4fa","#80deea","#80cbc4","#fff59d","#cccccc","#e57373","#f06292","#ba68c8","#9575cd","#64b5f6","#4fc3f7","#4dd0e1","#4db6ac","#fff176","#b3b3b3","#ef5350","#ec407a","#ab47bc","#7e57c2","#42a5f5","#29b6f6","#26c6da","#26a69a","#ffee58","#999999","#e53935","#d81b60","#8e24aa","#5e35b1","#1e88e5","#039be5","#00acc1","#00897b","#fdd835","#808080","#d32f2f","#c2185b","#7b1fa2","#512da8","#1976d2","#0288d1","#0097a7","#00796b","#fbc02d","#666666","#c62828","#ad1457","#6a1b9a","#4527a0","#1565c0","#0277bd","#00838f","#00695c","#f9a825","#4d4d4d","#b71c1c","#880e4f","#4a148c","#311b92","#0d47a1","#01579b","#006064","#004d40","#f57f17"]},beforeTileRender:function(e){""===e.value&&e.element.classList.add("e-nocolor-item")},change:function(e){r.updateFontColor(e.value,"Background"),""===e.currentValue.rgba?o.element.children[0].classList.add("e-nocolor-item"):(o.element.children[0].classList.remove("e-nocolor-item"),o.element.children[0].style.backgroundColor=e.currentValue.rgba),o.toggle(),0===r.activeObj.activePoint.width&&0===r.activeObj.activePoint.height||r.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})},onModeSwitch:function(e){T.Browser.isDevice&&(e.element.parentElement.parentElement.style.left=i.popupLeft,e.element.parentElement.parentElement.style.top=o.element.getBoundingClientRect().top-e.element.parentElement.parentElement.offsetHeight+"px")},beforeClose:function(){o.toggle()}},"#"+n+"_text_bgColor"),o=new v.DropDownButton({open:function(e){e=e.element.parentElement;T.Browser.isDevice&&(e.style.top=o.element.getBoundingClientRect().top-e.offsetHeight+"px",window.innerWidth<=520)&&(e.style.left=r.element.offsetLeft+"px")},target:".e-text-fontt-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+n+"_bgColorBtn"),t.inline=!0,t.value=t.getValue(t.value,"rgba"),r.element.querySelector(".e-text-background-color.e-template .e-dropdownbtn-preview").style.background="#fff")},L.prototype.createStrokeTextColor=function(e){var t,o,i=this,r=this.parent,n=r.element.id;-1<e.indexOf("strokeColor")&&r.element.querySelector(".e-template.e-stroke-text-font-color")&&(r.element.querySelector(".e-template.e-stroke-text-font-color").appendChild(r.createElement("input",{id:n+"_stroke_text"})),t=new g.ColorPicker({modeSwitcher:!0,noColor:!0,value:"",inline:!0,showButtons:!1,mode:"Palette",cssClass:"e-text-fontt-color",beforeModeSwitch:function(e){i.popupLeft=e.element.offsetParent.style.left,i.beforeModeSwitch(e,t)},presetColors:{custom:["","#f44336","#e91e63","#9c27b0","#673ab7","#2196f3","#03a9f4","#00bcd4","#009688","#ffeb3b","#ffffff","#ffebee","#fce4ec","#f3e5f5","#ede7f6","#e3f2fd","#e1f5fe","#e0f7fa","#e0f2f1","#fffde7","#f2f2f2","#ffcdd2","#f8bbd0","#e1bee7","#d1c4e9","#bbdefb","#b3e5fc","#b2ebf2","#b2dfdb","#fff9c4","#e6e6e6","#ef9a9a","#f48fb1","#ce93d8","#b39ddb","#90caf9","#81d4fa","#80deea","#80cbc4","#fff59d","#cccccc","#e57373","#f06292","#ba68c8","#9575cd","#64b5f6","#4fc3f7","#4dd0e1","#4db6ac","#fff176","#b3b3b3","#ef5350","#ec407a","#ab47bc","#7e57c2","#42a5f5","#29b6f6","#26c6da","#26a69a","#ffee58","#999999","#e53935","#d81b60","#8e24aa","#5e35b1","#1e88e5","#039be5","#00acc1","#00897b","#fdd835","#808080","#d32f2f","#c2185b","#7b1fa2","#512da8","#1976d2","#0288d1","#0097a7","#00796b","#fbc02d","#666666","#c62828","#ad1457","#6a1b9a","#4527a0","#1565c0","#0277bd","#00838f","#00695c","#f9a825","#4d4d4d","#b71c1c","#880e4f","#4a148c","#311b92","#0d47a1","#01579b","#006064","#004d40","#f57f17"]},beforeTileRender:function(e){""===e.value&&e.element.classList.add("e-nocolor-item")},change:function(e){r.updateStrokeTextColor(e.value),""===e.currentValue.rgba?o.element.children[0].classList.add("e-nocolor-item"):(o.element.children[0].classList.remove("e-nocolor-item"),o.element.children[0].style.backgroundColor=e.currentValue.rgba),o.toggle(),0===r.activeObj.activePoint.width&&0===r.activeObj.activePoint.height||r.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})},onModeSwitch:function(e){T.Browser.isDevice&&(e.element.parentElement.parentElement.style.left=i.popupLeft,e.element.parentElement.parentElement.style.top=o.element.getBoundingClientRect().top-e.element.parentElement.parentElement.offsetHeight+"px")},beforeClose:function(){o.toggle()}},"#"+n+"_stroke_text"),o=new v.DropDownButton({open:function(e){e=e.element.parentElement;T.Browser.isDevice&&(e.style.top=o.element.getBoundingClientRect().top-e.offsetHeight+"px",window.innerWidth<=520)&&(e.style.left=r.element.offsetLeft+"px")},target:".e-text-fontt-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+n+"_strokeTextColorBtn"),t.inline=!0,t.value=t.getValue(t.value,"rgba"),r.element.querySelector(".e-stroke-text-font-color.e-template .e-dropdownbtn-preview").style.background="#fff")},L.prototype.createTextBtn=function(e){var t,o,i,r,n,a=this,s=this.parent,l=s.element.id;-1<e.indexOf("fontFamily")&&(i=document.getElementById(l+"_fontFamilyBtn"),t=document.createElement("span"),T.Browser.isDevice?(t.innerHTML="ABC",t.setAttribute("style","font-family: "+s.fontFamily.default.toLowerCase()+"'")):t.innerHTML=s.fontFamily.default,t.className="e-text-font-family",i&&i.appendChild(t),(o=new v.DropDownButton({items:this.getFontFamilyItems(),cssClass:"e-font-family",createPopupOnClick:!0,beforeItemRender:function(e){e.element.setAttribute("style","font-family:"+e.element.id)},open:function(e){T.Browser.isDevice&&(e.element.parentElement.style.top=o.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px"),t=("block"===s.textArea.style.display||"inline-block"===s.textArea.style.display?s.textArea.style:s.activeObj.textSettings).fontFamily;var t,e=e.element.querySelector('[id *= "'+t.toLowerCase()+'"]');e&&e.classList.add("e-selected-btn")},select:function(e){a.triggerTbarClickEvent(e),t.textContent=e.item.text,T.Browser.isDevice&&t.setAttribute("style","font-family:"+e.item.id),s.updateFontFamily(e.item.id),s.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1});e=document.getElementById(s.element.id+"_toolbar");e&&e.classList.contains("e-control")&&T.getComponent(e,"toolbar").refreshOverflow()}})).appendTo("#"+l+"_fontFamilyBtn")),-1<e.indexOf("fontSize")&&(i=document.getElementById(l+"_fontSizeBtn"),r=document.createElement("span"),e=s.getFontSizes(),r.innerHTML=e[0].text,r.className="e-text-font-size",i.appendChild(r),(n=new v.DropDownButton({cssClass:"e-font-size",items:e,open:function(e){T.Browser.isDevice&&(e.element.parentElement.style.top=n.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px");var t=r.innerHTML;e.element.querySelector('[aria-label *= "'+t+'"]').classList.add("e-selected-btn")},select:function(e){a.triggerTbarClickEvent(e),r.textContent=e.item.text,s.updateFontSize(e.item.text),s.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}})).appendTo("#"+l+"_fontSizeBtn"))},L.prototype.refreshToolbar=function(e,t,o,i,r,n,a){var s=this.parent,l=s.element.id;if(s.isImageLoaded&&!s.isCropToolbar){var p,h,d,c,u={};switch("filter"!==e&&"color"!==e&&(p=document.getElementById(l+"_toolbar"),d=document.getElementById(l+"_customizeWrapper"),h=document.getElementById(l+"_bottomToolbar"),d&&T.getComponent(d,"toolbar")&&0<this.defToolbarItems.length&&(T.getComponent(d,"toolbar").destroy(),d.innerHTML=""),p&&p.classList.contains("e-control")&&0<this.defToolbarItems.length&&(T.getComponent(p,"toolbar").destroy(),p.innerHTML=""),p&&(0<this.defToolbarItems.length||s.toolbar&&0<s.toolbar.length&&-1===s.toolbar.indexOf("Open"))&&(d=T.getComponent(p,"toolbar"),T.isNullOrUndefined(d)||(d.destroy(),document.getElementById(s.element.id+"_toolbar").innerHTML="")),h)&&0<this.defToolbarItems.length&&-1<h.className.indexOf("e-control")&&(T.getComponent(h,"toolbar").destroy(),h.innerHTML=""),this.refreshSlider(),document.querySelector(".e-slider-tooltip")&&document.querySelector(".e-slider-tooltip").remove(),this.isFrameToolbar=s.isCropTab=!1,e){case"main":T.Browser.isDevice?o?this.initMainToolbar(!1,!0,!0,!1,!1,!0):this.initMainToolbar(!1,!0,null,!1,!1,!0):T.Browser.isDevice&&!i||this.initMainToolbar(t,T.Browser.isDevice,null),T.Browser.isDevice&&this.initBottomToolbar();break;case"shapes":s.isPublicMethod||(s.noPushUndo=!0),T.Browser.isDevice&&this.initMainToolbar(!1,!0,!0),"line"===s.activeObj.shape||"path"===s.activeObj.shape?u.toolbarItems=["strokeColor","strokeWidth","z-order","duplicate","remove"]:"arrow"===s.activeObj.shape?u.toolbarItems=["strokeColor","strokeWidth","start","end","z-order","duplicate","remove"]:"image"===s.activeObj.shape?u.toolbarItems=["flip","z-order","duplicate","remove","transparency"]:"rectangle"===s.activeObj.shape?u.toolbarItems=["fillColor","strokeColor","strokeWidth","borderRadius","z-order","duplicate","remove"]:u.toolbarItems=["fillColor","strokeColor","strokeWidth","z-order","duplicate","remove"],this.initShapesToolbarItem(u.toolbarItems),"image"===s.activeObj.shape&&(c=T.extend({},s.activeObj,{},!0),s.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),s.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),s.activeObj=c,s.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:s.activeObj,isCropRatio:null,points:null,isPreventDrag:!0}}),this.renderQAT(!1));break;case"text":T.Browser.isDevice&&this.initMainToolbar(!1,!0,!0),u.toolbarItems=["fontFamily","fontSize","fontColor","fillColor","strokeColor","strokeWidth","bold","italic","z-order","duplicate","remove","text"],this.initTextToolbarItem(u.toolbarItems);break;case"pen":T.Browser.isDevice&&this.initMainToolbar(!1,!0,!0),u.toolbarItems=["strokeColor","strokeWidth","z-order","remove","transparency"],this.initPenToolbarItem(u.toolbarItems);break;case"adjustment":T.Browser.isDevice&&this.initMainToolbar(!1,!0,!0),this.initAdjustmentToolbarItem();break;case"filter":this.updateContextualToolbar(e);break;case"resize":(s.isCircleCrop||s.currSelectionPoint&&"crop-circle"===s.currSelectionPoint.shape)&&(s.aspectHeight=s.aspectWidth,this.isAspectRatio=!1),this.initResizeToolbar(),T.Browser.isDevice&&this.initMainToolbar(!1,!0,!0,!0),c=s.element.querySelector("#"+l+"_aspectratio"),g=s.element.querySelector("#"+l+"_nonaspectratio"),s.aspectWidth&&s.aspectHeight&&(g?s.notify("transform",{prop:"resize",value:{width:s.aspectWidth,height:s.aspectHeight,isAspectRatio:!1}}):c&&s.notify("transform",{prop:"resize",value:{width:s.aspectWidth,height:null,isAspectRatio:!0}}));break;case"color":this.updateContextualToolbar(e,r);break;case"croptransform":T.isNullOrUndefined(a)&&(s.allowDownScale=!1,s.isCropTab=!0),T.Browser.isDevice&&this.initMainToolbar(!1,!0,!0),T.isNullOrUndefined(a)&&s.updateCropTransformItems(),this.initCropTransformToolbar(n,a),T.Browser.isDevice&&this.isToolbar()&&this.updateContextualToolbar("color","straighten",!0),s.isMaskImage&&this.refreshToolbar("main");break;case"frame":this.isFrameToolbar=!0,T.Browser.isDevice?(this.initMainToolbar(!1,!0,!0),this.initMainToolbar(!1,!0,!0,!1,!0)):this.initMainToolbar(!0,null,null,!1,!0);var g=s.element.querySelector("#"+l+"_"+s.frameObj.type);g&&g.classList.add("e-selected-btn"),"none"!==s.frameObj.type&&this.updateContextualToolbar(e,r),s.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}});break;case"redact":T.Browser.isDevice?(this.initMainToolbar(!1,!0,!0),this.initMainToolbar(!1,!0,!0,null,null,null,!0)):this.initMainToolbar(t,T.Browser.isDevice,null,null,null,null,!0),this.enableDisableTbrBtn(),"blur"===s.activeObj.redactType?(c=s.element.querySelector("#"+l+"_redactBlur"))&&c.classList.add("e-selected-btn"):(g=s.element.querySelector("#"+l+"_pixelate"))&&g.classList.add("e-selected-btn"),this.redactSlider(s.activeObj.redactType)}this.refreshDropDownBtn(o),this.updateKBDNavigation(e),this.currToolbar=e}},L.prototype.updateRedactObj=function(){var e=this.parent,t=T.extend([],e.objColl,[],!0),o=(e.objColl=[],T.extend({},e.activeObj,{},!0));e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),e.objColl=t;for(var i=0;i<e.objColl.length;i++){var r=e.objColl[i];"redact"===r.shape&&(r.redactImage=e.createElement("canvas"),r.redactImage.width=r.activePoint.width,r.redactImage.height=r.activePoint.height,r.redactImage.getContext("2d").drawImage(e.lowerCanvas,r.activePoint.startX,r.activePoint.startY,r.activePoint.width,r.activePoint.height,0,0,r.redactImage.width,r.redactImage.height))}e.isCropTab=!1,e.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),e.isCropTab=!0,o&&e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o,isCropRatio:null,points:null,isPreventDrag:!0}});t={panMove:null};e.notify("transform",{prop:"getPanMove",onPropertyChange:!1,value:{obj:t}}),t.panMove&&e.notify("transform",{prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:null,yDiff:null}})},L.prototype.updateKBDNavigation=function(e){var t,o,i,r=this.parent,n=r.element.id;r.isKBDNavigation&&this.currToolbar!==e&&this.isToolbar()&&(i=void 0,r=r.element.querySelectorAll("#"+n+"_toolbar")[0])&&(i=r.querySelector(".e-toolbar-center"))&&i.children[0]&&(t=i.children[0].querySelector(".e-btn"),r=(r=(r=i.children[1])&&r.children[0])&&r.children[0],"resize"===e&&r&&(t=r),"filter"===e&&(o=document.querySelector("#"+n+"_defaultCanvas"))&&setTimeout(function(){return o.focus()},50),t)&&("main"===e?setTimeout(function(){return t.focus()},50):t.focus())},L.prototype.performCropTransformClick=function(e,t){var o=this.parent;T.isNullOrUndefined(t)&&(o.notify("draw",{prop:"setTempStraightenZoomDeg"}),o.tempStraighten=o.transform.straighten,(o.currObjType.isFiltered||o.currObjType.isRedact)&&o.okBtn(),o.isStraightening=!0),this.refreshToolbar("croptransform",null,null,null,null,e,t),T.isNullOrUndefined(t)&&(o.notify("draw",{prop:"setDestForStraighten"}),o.notify("draw",{prop:"setTempDestForStraighten"}))},L.prototype.getAdjustmentToolbarItem=function(){var e=[],t=this.parent,o=!1,i=t.element.id,r=["Brightness","Contrast","Hue","Saturation","Exposure","Opacity","Blur"];if(t.toolbar)for(var n=0;n<r.length;n++)if(-1!==t.toolbar.indexOf(r[n])){o=!0;break}(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Brightness"))&&e.push({id:i+"_brightness",prefixIcon:"e-icons e-brightness",cssClass:"top-icon e-brightness",tooltipText:this.l10n.getConstant("Brightness"),align:"Center"}),(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Contrast"))&&e.push({id:i+"_contrast",prefixIcon:"e-icons e-contrast",cssClass:"top-icon e-contrast",tooltipText:this.l10n.getConstant("Contrast"),align:"Center"}),(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Hue"))&&e.push({id:i+"_hue",prefixIcon:"e-icons e-fade",cssClass:"top-icon e-fade",tooltipText:this.l10n.getConstant("Hue"),align:"Center"}),(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Saturation"))&&e.push({id:i+"_saturation",prefixIcon:"e-icons e-saturation",cssClass:"top-icon e-saturation",tooltipText:this.l10n.getConstant("Saturation"),align:"Center"}),(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Exposure"))&&e.push({id:i+"_exposure",prefixIcon:"e-icons e-grain",cssClass:"top-icon e-grain",tooltipText:this.l10n.getConstant("Exposure"),align:"Center"}),(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Opacity"))&&e.push({id:i+"_opacity",prefixIcon:"e-icons e-opacity",cssClass:"top-icon e-opacity",tooltipText:this.l10n.getConstant("Opacity"),align:"Center"}),(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Blur"))&&e.push({id:i+"_blur",prefixIcon:"e-icons e-tint",cssClass:"top-icon e-tint",tooltipText:this.l10n.getConstant("Blur"),align:"Center"});for(var a=this.processToolbar("center"),n=0,s=a.length;n<s;n++)e.push(a[n]);return T.Browser.isDevice||(e.push({id:i+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),e.push({id:i+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),e},L.prototype.getFrameToolbarItem=function(){var e=this.parent,t=e.element.id,o=[];return o.push({prefixIcon:"e-icons e-copy",id:t+"_frameColor",cssClass:"top-icon e-stroke",tooltipText:this.l10n.getConstant("Color"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Color")+'</span><button id="'+t+'_frameColorBtn"></button>'}),o.push({prefixIcon:"e-icons e-copy",id:t+"_frameGradient",cssClass:"top-icon e-frame-stroke",tooltipText:this.l10n.getConstant("GradientColor"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("GradientColor")+'</span><button id="'+t+'_frameGradientColorBtn"></button>'}),o.push({id:t+"_frameSize",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Size"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Size")+'</span><button id="'+t+'_frameSizeBtn"></button>'}),"line"!==e.frameObj.type&&"inset"!==e.frameObj.type&&"hook"!==e.frameObj.type||o.push({id:t+"_frameInset",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Inset"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Inset")+'</span><button id="'+t+'_frameInsetBtn"></button>'}),"line"!==e.frameObj.type&&"inset"!==e.frameObj.type||o.push({id:t+"_frameOffset",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Offset"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Offset")+'</span><button id="'+t+'_frameOffsetBtn"></button>'}),"line"===e.frameObj.type&&(o.push({id:t+"_frameRadius",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Radius"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Radius")+'</span><button id="'+t+'_frameRadiusBtn"></button>'}),o.push({id:t+"_frameAmount",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Amount"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Amount")+'</span><button id="'+t+'_frameAmountBtn"></button>'}),o.push({id:t+"_frameBorder",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Border"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Border")+'</span><button id="'+t+'_frameBorderBtn"></button>'})),o},L.prototype.getFilterToolbarItem=function(){var e=[],t=this.parent,o=!1,i=t.element.id,r=["Default","Chrome","Cold","Warm","Grayscale","Sepia","Invert"];if(t.toolbar)for(var n=0;n<r.length;n++)if(-1!==t.toolbar.indexOf(r[n])){o=!0;break}(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Default"))&&e.push({id:i+"_default",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Default"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+i+"_defaultCanvas tabindex=0></canvas><div><span>"+this.l10n.getConstant("Default")+"</span></div></div>"}),(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Chrome"))&&e.push({id:i+"_chrome",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Chrome"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+i+"_chromeCanvas></canvas><div><span>"+this.l10n.getConstant("Chrome")+"</span></div></div>"}),(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Cold"))&&e.push({id:i+"_cold",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Cold"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+i+"_coldCanvas></canvas><div><span>"+this.l10n.getConstant("Cold")+"</span></div></div>"}),(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Warm"))&&e.push({id:i+"_warm",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Warm"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+i+"_warmCanvas></canvas><div><span>"+this.l10n.getConstant("Warm")+"</span></div></div>"}),(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Grayscale"))&&e.push({id:i+"_grayscale",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Grayscale"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+i+"_grayscaleCanvas></canvas><div><span>"+this.l10n.getConstant("Grayscale")+"</span></div></div>"}),(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Sepia"))&&e.push({id:i+"_sepia",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Sepia"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+i+"_sepiaCanvas></canvas><div><span>"+this.l10n.getConstant("Sepia")+"</span></div></div>"}),(T.isNullOrUndefined(t.toolbar)||!o||t.toolbar&&-1<t.toolbar.indexOf("Invert"))&&e.push({id:i+"_invert",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Invert"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+i+"_invertCanvas></canvas><div><span>"+this.l10n.getConstant("Invert")+"</span></div></div>"});for(var a=this.processToolbar("center"),n=0,s=a.length;n<s;n++)e.push(a[n]);return e},L.prototype.getPenToolbarItem=function(e){for(var t=this.parent,o=t.element.id,i=[],r=((T.isNullOrUndefined(t.toolbar)||t.toolbar)&&i.push({id:o+"_annotation",tooltipText:this.l10n.getConstant("Annotation"),align:"Center",template:'<button id="'+o+'_annotationBtn"></button>'}),-1<e.indexOf("strokeColor")&&i.push({prefixIcon:"e-icons e-copy",id:o+"_pen_strokecolor",cssClass:"top-icon e-pen-stroke-color",tooltipText:this.l10n.getConstant("StrokeColor"),align:"Center",type:"Input",template:'<button id="'+o+'_penColorBtn"></button>'}),-1<e.indexOf("strokeWidth")&&i.push({prefixIcon:"e-icons e-copy",id:o+"_pen_strokewidth",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("StrokeWidth"),align:"Center",type:"Input",template:'<button id="'+o+'_penStrokeWidth"></button>'}),i.push({align:"Center",type:"Separator"}),-1<e.indexOf("z-order")&&i.push({id:o+"_zOrder",cssClass:"top-icon e-list-unordered-3",tooltipText:this.l10n.getConstant("ZOrder"),align:"Center",type:"Input",template:'<button id="'+o+'_zOrderBtn"></button>'}),-1<e.indexOf("remove")&&i.push({id:o+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Center"}),this.processSubToolbar(e)),n=0,a=r.length;n<a;n++)i.push(r[n]);return T.Browser.isDevice||(i.push({id:o+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),i.push({id:o+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),i},L.prototype.initPenToolbarItem=function(e){var t=this,o=this.parent,i=o.element.id,r=this.getLeftToolbarItem(),n=this.getRightToolbarItem(),a=this.getPenToolbarItem(e),s=this.getZoomToolbarItem(),r=(T.Browser.isDevice?this.defToolbarItems=a:this.defToolbarItems=r.concat(s,a,n),{toolbarType:"pen",toolbarItems:this.defToolbarItems}),l=(o.trigger("toolbarUpdating",r),this.isToolbarString(r.toolbarItems)?(e=r.toolbarItems,this.excludeItems(r.toolbarItems)):this.defToolbarItems=r.toolbarItems,new c.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){t.renderAnnotationBtn(!0),t.createPenColor(e),t.createPenBtn(e),t.createZOrderBtn(e),t.wireZoomBtnEvents(),o.trigger("toolbarCreated",{toolbarType:"pen"}),T.Browser.isDevice?0<t.defToolbarItems.length&&document.getElementById(i+"_toolbar")&&(l.refreshOverflow(),l.refreshOverflow()):(t.createLeftToolbarControls(),0<t.defToolbarItems.length&&document.getElementById(i+"_toolbar")&&l.refreshOverflow())}}));T.Browser.isDevice?l.appendTo("#"+i+"_bottomToolbar"):l.appendTo("#"+i+"_toolbar"),this.enableDisableTbrBtn()},L.prototype.createPenColor=function(e){var t,o,i=this,r=this.parent,n=r.element.id;-1<e.indexOf("strokeColor")&&(r.element.querySelector(".e-template.e-pen-stroke-color").appendChild(r.createElement("input",{id:n+"_pen_stroke"})),e=r.activeObj.strokeSettings.strokeColor,t=new g.ColorPicker({modeSwitcher:!1,value:"#fff",showButtons:!1,mode:"Palette",cssClass:"e-pen-color",change:function(e){r.updatePenStrokeColor(e.currentValue.hex),i.selFhdColor=e.currentValue.hex,o.element.children[0].style.backgroundColor=e.currentValue.rgba,o.toggle(),r.notify("undo-redo",{prop:"updateUndoRedoStack",value:{isPenDraw:!0}})}},"#"+n+"_pen_stroke"),o=new v.DropDownButton({open:function(e){e=e.element.parentElement;T.Browser.isDevice&&(e.style.top=o.element.getBoundingClientRect().top-e.offsetHeight+"px",window.innerWidth<=520)&&(e.style.left=r.element.offsetLeft+"px")},target:".e-pen-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+n+"_penColorBtn"),t.inline=!0,t.value=t.getValue(r.activeObj.strokeSettings.strokeColor,"rgba"),"null"===t.value&&(t.value=e),r.notify("freehand-draw",{prop:"getTempFreeHandDrawEditingStyles",value:{obj:n={tempFreeHandDrawEditingStyles:null}}}),r.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!(e={freehandSelectedIndex:null}),value:{obj:e}}),!T.isNullOrUndefined(e.freehandSelectedIndex)&&-1<e.freehandSelectedIndex?r.element.querySelector(".e-pen-stroke-color.e-template .e-dropdownbtn-preview").style.background=("#42a5f5"===this.selFhdColor?n.tempFreeHandDrawEditingStyles:r.pointColl[e.freehandSelectedIndex]).strokeColor:r.element.querySelector(".e-pen-stroke-color.e-template .e-dropdownbtn-preview").style.background=t.value)},L.prototype.createPenBtn=function(e){var o,t,i,r=this,n=this.parent,a=n.element.id,s=[{id:"1",text:this.l10n.getConstant("XSmall")},{id:"2",text:this.l10n.getConstant("Small")},{id:"3",text:this.l10n.getConstant("Medium")},{id:"4",text:this.l10n.getConstant("Large")},{id:"5",text:this.l10n.getConstant("XLarge")}];-1<e.indexOf("strokeWidth")&&(e=document.getElementById(a+"_penStrokeWidth"),o=document.createElement("span"),n.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!(t={freehandSelectedIndex:null}),value:{obj:t}}),!T.isNullOrUndefined(t.freehandSelectedIndex)&&-1<t.freehandSelectedIndex?o.innerHTML=this.getPenStroke(n.pointColl[t.freehandSelectedIndex].strokeWidth):(n.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!(t={penStrokeWidth:2}),value:{obj:t}}),o.innerHTML=t.penStrokeWidth?this.getPenStroke(t.penStrokeWidth):this.l10n.getConstant("Small")),o.className="e-pen-stroke-width",e.appendChild(o),(i=new v.DropDownButton({items:s,open:function(e){T.Browser.isDevice&&(e.element.parentElement.style.top=i.element.getBoundingClientRect().top-e.element.parentElement.offsetHeight+"px");var t=o.innerHTML;e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){r.triggerTbarClickEvent(e),o.textContent=e.item.text,n.updatePenStrokeWidth(e.item.id),T.Browser.isDevice?document.getElementById(a+"_bottomToolbar")&&T.getComponent(a+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(a+"_toolbar")&&T.getComponent(a+"_toolbar","toolbar").refreshOverflow();e={penStrokeWidth:null};n.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:e}}),n.notify("undo-redo",{prop:"updateUndoRedoStack",value:{isPenDraw:!0}}),n.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:e.penStrokeWidth}})}})).appendTo("#"+a+"_penStrokeWidth"))},L.prototype.getPenStroke=function(e){var t="",o={1:this.l10n.getConstant("XSmall"),2:this.l10n.getConstant("Small"),3:this.l10n.getConstant("Medium"),4:this.l10n.getConstant("Large"),5:this.l10n.getConstant("XLarge")};return t=1<=e&&e<=5?o[e]:t},L.prototype.initAdjustmentToolbarItem=function(){var e=this,t=this.parent,o=t.element.id,i=this.getLeftToolbarItem(null),r=this.getRightToolbarItem(),n=this.getAdjustmentToolbarItem(),a=this.getZoomToolbarItem(),i=(T.Browser.isDevice?this.defToolbarItems=n:this.defToolbarItems=i.concat(a,n,r),{toolbarType:"finetune",toolbarItems:this.defToolbarItems}),s=(t.trigger("toolbarUpdating",i),this.defToolbarItems=i.toolbarItems,new c.Toolbar({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){e.wireZoomBtnEvents(),T.Browser.isDevice||e.createLeftToolbarControls(),0<e.defToolbarItems.length&&document.getElementById(o+"_toolbar")&&s.refreshOverflow()}}));T.Browser.isDevice?s.appendTo("#"+o+"_bottomToolbar"):s.appendTo("#"+o+"_toolbar"),this.enableDisableTbrBtn()},L.prototype.initFrameToolbarItem=function(){var t=this,o=this.parent,i=o.element.id,e=document.querySelector("#"+i+"_contextualToolbarArea"),r=document.querySelector("#"+i+"_frameWrapper");r?r.style.display="block":r=e.appendChild(o.createElement("div",{id:i+"_frameWrapper",className:"e-frame-wrapper",styles:"position: relative"})),r.appendChild(o.createElement("div",{id:i+"_customizeWrapper",styles:"position: absolute"}));var e={toolbarType:"frame",toolbarItems:this.getFrameToolbarItem()},n=(o.trigger("toolbarUpdating",e),new c.Toolbar({width:"100%",items:e.toolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){t.createFrameColor(),t.createFrameSize();var e=o.frameObj.type;"line"===e&&t.createFrameRadius(),"line"!==e&&"inset"!==e&&"hook"!==e||t.createFrameInset(),"line"!==e&&"inset"!==e||t.createFrameOffset(),"line"===e&&(t.createFrameAmount(),t.createFrameBorder()),t.createFrameGradientColor(),T.Browser.isDevice?0<t.defToolbarItems.length&&document.getElementById(i+"_bottomToolbar")&&(n.refreshOverflow(),n.refreshOverflow(),n.refreshOverflow()):(t.createLeftToolbarControls(),0<t.defToolbarItems.length&&document.getElementById(i+"_toolbar")&&n.refreshOverflow()),o.element.querySelector("#"+i+"_"+e).focus()}}));n.appendTo("#"+i+"_customizeWrapper")},L.prototype.createFrameGradientColor=function(){var i,r=this.parent,n={frameChangeEventArgs:null},e=r.element.id,t=(r.element.querySelector(".e-template.e-frame-stroke").appendChild(r.createElement("input",{id:e+"_frame_gradient_fill"})),new g.ColorPicker({modeSwitcher:!1,noColor:!0,value:r.frameObj.gradientColor,showButtons:!1,mode:"Palette",cssClass:"e-frame-gradient-fill-color",change:function(e){i={type:r.toPascalCase(r.frameObj.type),color:r.frameObj.color,gradientColor:r.frameObj.gradientColor,size:r.frameObj.size,inset:r.frameObj.inset,offset:r.frameObj.offset,borderRadius:r.frameObj.radius,frameLineStyle:r.toPascalCase(r.frameObj.border),lineCount:r.frameObj.amount};var t=r.frameObj.gradientColor,o={currObj:{}};r.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),r.frameObj.gradientColor=e.currentValue.hex,r.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:i,obj:n}}),n.frameChangeEventArgs&&!n.frameChangeEventArgs.cancel?(r.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:o.currObj,previousObjColl:o.currObj.objColl,previousPointColl:o.currObj.pointColl,previousSelPointColl:o.currObj.selPointColl,previousCropObj:T.extend({},r.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),r.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),r.notify("draw",{prop:"redrawDownScale"}),""===e.currentValue.rgba?a.element.children[0].classList.add("e-nocolor-item"):(a.element.children[0].classList.remove("e-nocolor-item"),a.element.children[0].style.backgroundColor=e.currentValue.rgba),r.curFrameObjEvent={previousFrameSetting:n.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:n.frameChangeEventArgs.currentFrameSetting},r.isFrameBtnClick=!0):r.frameObj.gradientColor=t,a.toggle()}},"#"+e+"_frame_gradient_fill")),a=new v.DropDownButton({open:function(e){T.Browser.isDevice&&((e=e.element.parentElement).style.top=a.element.getBoundingClientRect().top-e.offsetHeight+"px",window.innerWidth<=520)&&(e.style.left=r.element.offsetLeft+"px")},target:".e-frame-gradient-fill-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+e+"_frameGradientColorBtn");t.inline=!0,""===r.frameObj.gradientColor?r.element.querySelector(".e-frame-stroke.e-template .e-dropdownbtn-preview").classList.add("e-nocolor-item"):r.element.querySelector(".e-frame-stroke.e-template .e-dropdownbtn-preview").style.background=r.frameObj.gradientColor},L.prototype.createFrameColor=function(){var i,r=this.parent,n={frameChangeEventArgs:null},e=r.element.id,t=(r.element.querySelector(".e-template.e-stroke").appendChild(r.createElement("input",{id:e+"_frame_fill"})),new g.ColorPicker({modeSwitcher:!1,value:r.frameObj.color,showButtons:!1,mode:"Palette",cssClass:"e-frame-fill-color",change:function(e){i={type:r.toPascalCase(r.frameObj.type),color:r.frameObj.color,gradientColor:r.frameObj.gradientColor,size:r.frameObj.size,inset:r.frameObj.inset,offset:r.frameObj.offset,borderRadius:r.frameObj.radius,frameLineStyle:r.toPascalCase(r.frameObj.border),lineCount:r.frameObj.amount};var t=r.frameObj.color,o={currObj:{}};r.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),r.frameObj.color=e.currentValue.hex,r.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:i,obj:n}}),n.frameChangeEventArgs&&!n.frameChangeEventArgs.cancel?(r.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:o.currObj,previousObjColl:o.currObj.objColl,previousPointColl:o.currObj.pointColl,previousSelPointColl:o.currObj.selPointColl,previousCropObj:T.extend({},r.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),r.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),r.notify("draw",{prop:"redrawDownScale"}),""===e.currentValue.rgba?a.element.children[0].classList.add("e-nocolor-item"):(a.element.children[0].classList.remove("e-nocolor-item"),a.element.children[0].style.backgroundColor=e.currentValue.rgba),r.curFrameObjEvent={previousFrameSetting:n.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:n.frameChangeEventArgs.currentFrameSetting},r.isFrameBtnClick=!0):r.frameObj.color=t,a.toggle()}},"#"+e+"_frame_fill")),a=new v.DropDownButton({open:function(e){T.Browser.isDevice&&((e=e.element.parentElement).style.top=a.element.getBoundingClientRect().top-e.offsetHeight+"px",window.innerWidth<=520)&&(e.style.left=r.element.offsetLeft+"px")},target:".e-frame-fill-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+e+"_frameColorBtn");t.inline=!0,r.element.querySelector(".e-stroke.e-template .e-dropdownbtn-preview").style.background=r.frameObj.color},L.prototype.createFrameSize=function(){var i,r=this,n=this.parent,a={frameChangeEventArgs:null},s=n.element.id,e=[{id:"1",text:this.l10n.getConstant("20")},{id:"2",text:this.l10n.getConstant("40")},{id:"3",text:this.l10n.getConstant("60")},{id:"4",text:this.l10n.getConstant("80")},{id:"5",text:this.l10n.getConstant("100")}],t=document.getElementById(s+"_frameSizeBtn"),o=document.createElement("span"),l=(o.innerHTML=this.l10n.getConstant(n.frameObj.size.toString()),o.className="e-frame-stroke-width",t.appendChild(o),new v.DropDownButton({items:e,open:function(e){T.Browser.isDevice&&((t=e.element.parentElement).style.top=l.element.getBoundingClientRect().top-t.offsetHeight+"px");var t=l.element.childNodes[0].textContent;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){r.triggerTbarClickEvent(e),i={type:n.toPascalCase(n.frameObj.type),color:n.frameObj.color,gradientColor:n.frameObj.gradientColor,size:n.frameObj.size,inset:n.frameObj.inset,offset:n.frameObj.offset,borderRadius:n.frameObj.radius,frameLineStyle:n.toPascalCase(n.frameObj.border),lineCount:n.frameObj.amount};var t=n.frameObj.size,o={currObj:{}};n.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),n.frameObj.size=parseInt(e.item.text,10),n.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:i,obj:a}}),a.frameChangeEventArgs&&!a.frameChangeEventArgs.cancel?(n.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:o.currObj,previousObjColl:o.currObj.objColl,previousPointColl:o.currObj.pointColl,previousSelPointColl:o.currObj.selPointColl,previousCropObj:T.extend({},n.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),n.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),n.notify("draw",{prop:"redrawDownScale"}),l.content=e.item.text,n.curFrameObjEvent={previousFrameSetting:a.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:a.frameChangeEventArgs.currentFrameSetting},n.isFrameBtnClick=!0):n.frameObj.size=t,T.Browser.isDevice?document.getElementById(s+"_bottomToolbar")&&T.getComponent(s+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(s+"_toolbar")&&T.getComponent(s+"_toolbar","toolbar").refreshOverflow()}}));l.appendTo("#"+s+"_frameSizeBtn")},L.prototype.createFrameInset=function(){var i,r=this,n=this.parent,a={frameChangeEventArgs:null},s=n.element.id,e=[{id:"1",text:this.l10n.getConstant("20")},{id:"2",text:this.l10n.getConstant("40")},{id:"3",text:this.l10n.getConstant("60")},{id:"4",text:this.l10n.getConstant("80")},{id:"5",text:this.l10n.getConstant("100")}],t=document.getElementById(s+"_frameInsetBtn"),o=document.createElement("span"),l=(o.innerHTML=this.l10n.getConstant(n.frameObj.inset.toString()),o.className="e-frame-inset",t.appendChild(o),new v.DropDownButton({items:e,open:function(e){T.Browser.isDevice&&((t=e.element.parentElement).style.top=l.element.getBoundingClientRect().top-t.offsetHeight+"px");var t=l.element.childNodes[0].textContent;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){r.triggerTbarClickEvent(e),i={type:n.toPascalCase(n.frameObj.type),color:n.frameObj.color,gradientColor:n.frameObj.gradientColor,size:n.frameObj.size,inset:n.frameObj.inset,offset:n.frameObj.offset,borderRadius:n.frameObj.radius,frameLineStyle:n.toPascalCase(n.frameObj.border),lineCount:n.frameObj.amount};var t=n.frameObj.inset,o={currObj:{}};n.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),n.frameObj.inset=parseInt(e.item.text,10),n.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:i,obj:a}}),a.frameChangeEventArgs&&!a.frameChangeEventArgs.cancel?(n.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:o.currObj,previousObjColl:o.currObj.objColl,previousPointColl:o.currObj.pointColl,previousSelPointColl:o.currObj.selPointColl,previousCropObj:T.extend({},n.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),n.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),n.notify("draw",{prop:"redrawDownScale"}),l.content=e.item.text,n.curFrameObjEvent={previousFrameSetting:a.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:a.frameChangeEventArgs.currentFrameSetting},n.isFrameBtnClick=!0):n.frameObj.inset=t,T.Browser.isDevice?document.getElementById(s+"_bottomToolbar")&&T.getComponent(s+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(s+"_toolbar")&&T.getComponent(s+"_toolbar","toolbar").refreshOverflow()}}));l.appendTo("#"+s+"_frameInsetBtn")},L.prototype.createFrameOffset=function(){var i,r=this,n=this.parent,a={frameChangeEventArgs:null},s=n.element.id,e=[{id:"1",text:this.l10n.getConstant("20")},{id:"2",text:this.l10n.getConstant("40")},{id:"3",text:this.l10n.getConstant("60")},{id:"4",text:this.l10n.getConstant("80")},{id:"5",text:this.l10n.getConstant("100")}],t=document.getElementById(s+"_frameOffsetBtn"),o=document.createElement("span"),l=(o.innerHTML=this.l10n.getConstant(n.frameObj.offset.toString()),o.className="e-frame-offset",t.appendChild(o),new v.DropDownButton({items:e,open:function(e){T.Browser.isDevice&&((t=e.element.parentElement).style.top=l.element.getBoundingClientRect().top-t.offsetHeight+"px");var t=l.element.childNodes[0].textContent;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){r.triggerTbarClickEvent(e),i={type:n.toPascalCase(n.frameObj.type),color:n.frameObj.color,gradientColor:n.frameObj.gradientColor,size:n.frameObj.size,inset:n.frameObj.inset,offset:n.frameObj.offset,borderRadius:n.frameObj.radius,lineCount:n.frameObj.amount,frameLineStyle:n.toPascalCase(n.frameObj.border)};var t=n.frameObj.offset,o={currObj:{}};n.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),n.frameObj.offset=parseInt(e.item.text,10),n.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:i,obj:a}}),a.frameChangeEventArgs&&!a.frameChangeEventArgs.cancel?(n.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:o.currObj,previousObjColl:o.currObj.objColl,previousPointColl:o.currObj.pointColl,previousSelPointColl:o.currObj.selPointColl,previousCropObj:T.extend({},n.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),n.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),n.notify("draw",{prop:"redrawDownScale"}),l.content=e.item.text,n.curFrameObjEvent={previousFrameSetting:a.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:a.frameChangeEventArgs.currentFrameSetting},n.isFrameBtnClick=!0):n.frameObj.offset=t,T.Browser.isDevice?document.getElementById(s+"_bottomToolbar")&&T.getComponent(s+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(s+"_toolbar")&&T.getComponent(s+"_toolbar","toolbar").refreshOverflow()}}));l.appendTo("#"+s+"_frameOffsetBtn")},L.prototype.createFrameRadius=function(){var i,r=this,n=this.parent,a={frameChangeEventArgs:null},s=n.element.id,e=[{id:"1",text:this.l10n.getConstant("0")},{id:"2",text:this.l10n.getConstant("20")},{id:"3",text:this.l10n.getConstant("40")},{id:"4",text:this.l10n.getConstant("60")},{id:"5",text:this.l10n.getConstant("80")},{id:"6",text:this.l10n.getConstant("100")}],t=document.getElementById(s+"_frameRadiusBtn"),o=document.createElement("span"),l=(o.innerHTML=this.l10n.getConstant(n.frameObj.radius.toString()),o.className="e-frame-radius",t.appendChild(o),new v.DropDownButton({items:e,open:function(e){T.Browser.isDevice&&((t=e.element.parentElement).style.top=l.element.getBoundingClientRect().top-t.offsetHeight+"px");var t=l.element.childNodes[0].textContent;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){r.triggerTbarClickEvent(e),i={type:n.toPascalCase(n.frameObj.type),color:n.frameObj.color,gradientColor:n.frameObj.gradientColor,size:n.frameObj.size,inset:n.frameObj.inset,offset:n.frameObj.offset,borderRadius:n.frameObj.radius,frameLineStyle:n.toPascalCase(n.frameObj.border),lineCount:n.frameObj.amount};var t=n.frameObj.radius,o={currObj:{}};n.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),n.frameObj.radius=parseInt(e.item.text,10),n.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:i,obj:a}}),a.frameChangeEventArgs&&!a.frameChangeEventArgs.cancel?(n.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:o.currObj,previousObjColl:o.currObj.objColl,previousPointColl:o.currObj.pointColl,previousSelPointColl:o.currObj.selPointColl,previousCropObj:T.extend({},n.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),n.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),n.notify("draw",{prop:"redrawDownScale"}),l.content=e.item.text,n.curFrameObjEvent={previousFrameSetting:a.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:a.frameChangeEventArgs.currentFrameSetting},n.isFrameBtnClick=!0):n.frameObj.radius=t,T.Browser.isDevice?document.getElementById(s+"_bottomToolbar")&&T.getComponent(s+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(s+"_toolbar")&&T.getComponent(s+"_toolbar","toolbar").refreshOverflow()}}));l.appendTo("#"+s+"_frameRadiusBtn")},L.prototype.createFrameAmount=function(){var i,r=this,n=this.parent,a={frameChangeEventArgs:null},s=n.element.id,e=[{id:"1",text:this.l10n.getConstant("1")},{id:"2",text:this.l10n.getConstant("2")},{id:"3",text:this.l10n.getConstant("3")},{id:"4",text:this.l10n.getConstant("4")},{id:"5",text:this.l10n.getConstant("5")}],t=document.getElementById(s+"_frameAmountBtn"),o=document.createElement("span"),l=(o.innerHTML=this.l10n.getConstant(n.frameObj.amount.toString()),o.className="e-frame-amount",t.appendChild(o),new v.DropDownButton({items:e,open:function(e){T.Browser.isDevice&&((t=e.element.parentElement).style.top=l.element.getBoundingClientRect().top-t.offsetHeight+"px");var t=l.element.childNodes[0].textContent;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){r.triggerTbarClickEvent(e),i={type:n.toPascalCase(n.frameObj.type),color:n.frameObj.color,gradientColor:n.frameObj.gradientColor,size:n.frameObj.size,inset:n.frameObj.inset,offset:n.frameObj.offset,borderRadius:n.frameObj.radius,lineCount:n.frameObj.amount,frameLineStyle:n.toPascalCase(n.frameObj.border)};var t=n.frameObj.amount,o={currObj:{}};n.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),n.frameObj.amount=parseInt(e.item.text,10),n.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:i,obj:a}}),a.frameChangeEventArgs&&!a.frameChangeEventArgs.cancel?(n.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:o.currObj,previousObjColl:o.currObj.objColl,previousPointColl:o.currObj.pointColl,previousSelPointColl:o.currObj.selPointColl,previousCropObj:T.extend({},n.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),n.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),n.notify("draw",{prop:"redrawDownScale"}),l.content=e.item.text,n.curFrameObjEvent={previousFrameSetting:a.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:a.frameChangeEventArgs.currentFrameSetting},n.isFrameBtnClick=!0):n.frameObj.amount=t,T.Browser.isDevice?document.getElementById(s+"_bottomToolbar")&&T.getComponent(s+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(s+"_toolbar")&&T.getComponent(s+"_toolbar","toolbar").refreshOverflow()}}));l.appendTo("#"+s+"_frameAmountBtn")},L.prototype.createFrameBorder=function(){var i,r=this,n=this.parent,a={frameChangeEventArgs:null},s=n.element.id,e=[{id:"1",text:this.l10n.getConstant("Solid")},{id:"2",text:this.l10n.getConstant("Dashed")},{id:"3",text:this.l10n.getConstant("Dotted")}],t=document.getElementById(s+"_frameBorderBtn"),o=document.createElement("span"),l=(o.innerHTML=this.l10n.getConstant(n.toPascalCase(n.frameObj.border)),o.className="e-frame-border",t.appendChild(o),new v.DropDownButton({items:e,open:function(e){T.Browser.isDevice&&((t=e.element.parentElement).style.top=l.element.getBoundingClientRect().top-t.offsetHeight+"px");var t=l.element.childNodes[0].textContent;""!==t&&e.element.querySelector('[aria-label = "'+t+'"]').classList.add("e-selected-btn")},select:function(e){r.triggerTbarClickEvent(e),i={lineCount:n.frameObj.amount,color:n.frameObj.color,borderRadius:n.frameObj.radius,gradientColor:n.frameObj.gradientColor,size:n.frameObj.size,inset:n.frameObj.inset,offset:n.frameObj.offset,frameLineStyle:n.toPascalCase(n.frameObj.border),type:n.toPascalCase(n.frameObj.type)};var t=n.frameObj.border,o={currObj:{}};n.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),n.frameObj.border=e.item.text.toLowerCase(),n.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:i,obj:a}}),a.frameChangeEventArgs&&!a.frameChangeEventArgs.cancel?(n.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:o.currObj,previousObjColl:o.currObj.objColl,previousPointColl:o.currObj.pointColl,previousSelPointColl:o.currObj.selPointColl,previousCropObj:T.extend({},n.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),n.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),n.notify("draw",{prop:"redrawDownScale"}),l.content=e.item.text,n.curFrameObjEvent={previousFrameSetting:a.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:a.frameChangeEventArgs.currentFrameSetting},n.isFrameBtnClick=!0):n.frameObj.border=t,T.Browser.isDevice?document.getElementById(s+"_bottomToolbar")&&T.getComponent(s+"_bottomToolbar","toolbar").refreshOverflow():document.getElementById(s+"_toolbar")&&T.getComponent(s+"_toolbar","toolbar").refreshOverflow()}}));l.appendTo("#"+s+"_frameBorderBtn")},L.prototype.initFilterToolbarItem=function(){var t=this,o=this.parent,i=o.element.id,e={toolbarType:"filter",toolbarItems:this.getFilterToolbarItem()},r=(o.trigger("toolbarUpdating",e),e=e.toolbarItems,document.querySelector("#"+i+"_contextualToolbar").classList.contains("e-control")&&T.getComponent(document.getElementById(i+"_contextualToolbar"),"toolbar").destroy(),new c.Toolbar({width:"100%",items:e,clicked:this.contextualToolbarClicked.bind(this),created:function(){t.updatePrivateVariables(),t.createCanvasFilter(),""===o.currentFilter&&(o.currentFilter=i+"_default");var e=document.querySelector("#"+i+"_headWrapper"),e=(e&&(e.style.display="none"),document.getElementById(o.currentFilter+"Canvas"));e&&e.parentElement.parentElement.classList.add("e-selected"),t.enableDisableTbrBtn(),r.refreshOverflow()}}));r.appendTo("#"+i+"_contextualToolbar")},L.prototype.drawDashedLine=function(e){e.beginPath(),e.setLineDash([5]),e.rect(10,10,280,130),e.stroke(),e.closePath()},L.prototype.createCanvasFilter=function(){var e=this.parent,t=(f.showSpinner(e.element),e.element.style.opacity="0.5",e.getCurrentCanvasData());this.inMemoryCanvas.width=t.width,this.inMemoryCanvas.height=t.height,this.inMemoryContext.putImageData(t,0,0),this.updateFilterCanvas("_defaultCanvas","default"),this.updateFilterCanvas("_chromeCanvas","chrome"),this.updateFilterCanvas("_coldCanvas","cold"),this.updateFilterCanvas("_warmCanvas","warm"),this.updateFilterCanvas("_grayscaleCanvas","grayscale"),this.updateFilterCanvas("_sepiaCanvas","sepia"),this.updateFilterCanvas("_invertCanvas","invert"),f.hideSpinner(e.element),e.element.style.opacity="1",e.initialAdjustmentValue=this.lowerContext.filter},L.prototype.updateFilterCanvas=function(e,t){var o,i=this.parent,e=i.element.querySelector("#"+i.element.id+e);e&&(o=e.getContext("2d"),o=e.getContext("2d"),e.style.width="100px",e.style.height="100px",i.notify("filter",{prop:"updateAdj",value:{type:t,value:null,isPreview:!0,ctx:o}}),o.drawImage(this.inMemoryCanvas,0,0,300,150),i.isSafari)&&i.notify("filter",{prop:"apply-filter",onPropertyChange:!1,value:{context:o}})},L.prototype.getQuickAccessToolbarItem=function(e){var t=this.parent,o=t.element.id,i={cancel:!1,toolbarItems:[]},r=[],n=(T.isNullOrUndefined(e)?("image"===t.activeObj.shape&&r.push("Flip"),"redact"!==t.activeObj.shape&&r.push("BringToFront"),r.push("Clone"),r.push("Delete"),"text"===t.activeObj.shape&&r.push("EditText"),i.shape=t.toPascalCase(t.activeObj.shape)):e&&(r.push("BringToFront"),r.push("Delete"),i.shape="Freehand draw"),i.toolbarItems=T.extend([],r,null,!0),t.trigger("quickAccessToolbarOpen",i),[]);if(i.cancel)n=[];else for(var a=0;a<i.toolbarItems.length;a++)switch(i.toolbarItems[a]){case"BringToFront":n.push({id:o+"_bringToFront",prefixIcon:"e-icons e-bring-to-front",tooltipText:this.l10n.getConstant("BringToFront"),align:"Left"});break;case"Clone":n.push({id:o+"_duplicate",prefixIcon:"e-icons e-order",cssClass:"top-icon e-order",tooltipText:this.l10n.getConstant("Duplicate"),align:"Left"});break;case"Delete":n.push({id:o+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Left"});break;case"EditText":n.push({id:o+"_editText",prefixIcon:"e-icons e-annotation-edit",cssClass:"top-icon e-annotation-edit",tooltipText:this.l10n.getConstant("EditText"),align:"Left"});break;case"Flip":n.push({id:o+"_hFlip",prefixIcon:"e-icons e-horizontal-flip",tooltipText:this.l10n.getConstant("HorizontalFlip"),align:"Left"}),n.push({id:o+"_vFlip",prefixIcon:"e-icons e-vertical-flip",tooltipText:this.l10n.getConstant("VerticalFlip"),align:"Left"});break;default:n.push(i.toolbarItems[a])}return n},L.prototype.renderQAT=function(e){var t,o,i,r,n,a,s,l,p,h=this.parent,d=h.element.id;h.activeObj&&h.showQuickAccessToolbar&&((t=document.getElementById(d+"_quickAccessToolbarArea"))&&(this.destroyQuickAccessToolbar(),t.style.display="block"),0!==(o=this.getQuickAccessToolbarItem(e)).length)&&(T.isNullOrUndefined(h.quickAccessToolbarTemplate)&&new c.Toolbar({items:o,clicked:this.quickAccessToolbarClicked.bind(this)}).appendTo("#"+d+"_quickAccessToolbar"),i=this.toolbarHeight&&0!==this.toolbarHeight?this.toolbarHeight:t.clientHeight,d=h.element.querySelector("#"+d+"_headWrapper"),T.isNullOrUndefined(e)&&(0!==h.activeObj.activePoint.width||0!==h.activeObj.activePoint.height||h.activeObj.shape&&"path"===h.activeObj.shape&&0<h.activeObj.pointColl.length)?(h.notify("shape",{prop:"getHighestOrder",onPropertyChange:!(s={order:null}),value:{obj:s}}),h.activeObj.order>s.order&&document.getElementById(h.element.id+"_bringToFront")?document.getElementById(h.element.id+"_bringToFront").classList.add("e-overlay"):document.getElementById(h.element.id+"_bringToFront")&&document.getElementById(h.element.id+"_bringToFront").classList.remove("e-overlay"),t.style.width="auto",h.activeObj.activePoint.width=Math.abs(h.activeObj.activePoint.width),h.activeObj.activePoint.height=Math.abs(h.activeObj.activePoint.height),a=h.activeObj.activePoint.startX<h.activeObj.activePoint.endX?h.activeObj.activePoint.startX:h.activeObj.activePoint.endX,r=h.activeObj.activePoint.startY<h.activeObj.activePoint.endY?h.activeObj.activePoint.startY:h.activeObj.activePoint.endY,l=h.activeObj.activePoint.width,0!==h.activeObj.rotatedAngle&&"arrow"!==h.activeObj.shape?(h.notify("shape",{prop:"getSquarePointForRotatedShape",onPropertyChange:!(p={activePoint:null}),value:{obj:h.activeObj,object:p}}),a=(p=p.activePoint).startX,r=p.startY,l=p.width):"path"===h.activeObj.shape&&(a=(n=h.getSquarePointForPath(h.activeObj)).startX,r=n.startY,l=n.width),t.style.left=a+l/2-25*o.length+"px",parseFloat(t.style.left)+t.clientWidth/2!==a+l/2&&(n=a+l/2-(parseFloat(t.style.left)+t.clientWidth/2),t.style.left=parseFloat(t.style.left)+n+"px"),r-((i=d?d.offsetHeight+i:i)+i/1.5)<h.img.destTop?(t.style.top=h.img.destTop+"px",d&&(t.style.top=(h.img.destTop<0?0:h.img.destTop)+d.offsetHeight+"px")):(i=this.toolbarHeight,t.style.top=r-(i+i/1.5)+"px")):e?(h.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!(a={freehandSelectedIndex:-1}),value:{obj:a}}),h.notify("shape",{prop:"getHighestOrder",onPropertyChange:!(s={order:null}),value:{obj:s}}),h.getObjFromId(h.pointColl[a.freehandSelectedIndex].id).order>=s.order&&document.getElementById(h.element.id+"_bringToFront")?document.getElementById(h.element.id+"_bringToFront").classList.add("e-overlay"):document.getElementById(h.element.id+"_bringToFront")&&document.getElementById(h.element.id+"_bringToFront").classList.remove("e-overlay"),h.notify("freehand-draw",{prop:"getSqPtFD",value:{idx:a.freehandSelectedIndex,obj:l={activePoint:null}}}),p=l.activePoint,t.style.width="auto",t.style.left=p.startX+p.width/2-24*o.length+"px",p.startY-(i+i/1.5)<h.img.destTop?t.style.top=h.img.destTop+"px":t.style.top=p.startY-(i+i/1.5)+"px"):t.style.display="none",parseFloat(t.style.top)<0)&&(t.style.top="0px")},L.prototype.refreshDropDownBtn=function(e){var t,o;!T.isNullOrUndefined(e)&&(t=this.parent.element.id,(o=document.querySelector("#"+t+"_annotationBtn"))&&(e?(o.classList.add("e-disabled"),o.parentElement.classList.add("e-overlay")):(o.classList.remove("e-disabled"),o.parentElement.classList.remove("e-overlay")),T.getComponent(o,"dropdown-btn").disabled=e),(o=document.querySelector("#"+t+"_transformBtn"))&&(e?(o.classList.add("e-disabled"),o.parentElement.classList.add("e-overlay")):(o.classList.remove("e-disabled"),o.parentElement.classList.remove("e-overlay")),T.getComponent(o,"dropdown-btn").disabled=e),(o=document.querySelector("#"+t+"_adjustment"))&&(e?(o.classList.add("e-disabled"),o.parentElement.classList.add("e-overlay")):(o.classList.remove("e-disabled"),o.parentElement.classList.remove("e-overlay")),T.getComponent(o,"btn").disabled=e),o=document.querySelector("#"+t+"_filter"))&&(e?(o.classList.add("e-disabled"),o.parentElement.classList.add("e-overlay")):(o.classList.remove("e-disabled"),o.parentElement.classList.remove("e-overlay")),T.getComponent(o,"btn").disabled=e)},L.prototype.cropSelect=function(e){var t=this.parent,e=(t.isCropTab=!0,T.isNullOrUndefined(t.transform.cropZoomFactor)&&(t.transform.cropZoomFactor=t.transform.zoomFactor,t.notify("draw",{prop:"setTempZoomFactor",onPropertyChange:!1,value:{tempZoomFactor:t.transform.zoomFactor}})),t.transform.zoomFactor=t.transform.cropZoomFactor,e.item.id),o=(this.currentToolbar="crop",t.currSelectionPoint=null,t.notify("draw",{prop:"setIsCropSelect",value:{bool:!0}}),{prevObj:null});t.notify("crop",{prop:"getPreviousCropCurrentObj",value:{obj:o}}),t.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:e,startX:null,startY:null,width:null,height:null}}),t.notify("crop",{prop:"setPreviousCropCurrentObj",value:{obj:o.prevObj}}),this.enableDisableTbrBtn(),t.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}})},L.prototype.quickAccessToolbarClicked=function(e,t){var o=this.parent,i=o.element.id;if(e.item){var r,n=null,a={tempObj:null},s=(o.notify("draw",{prop:"getPrevActObj",onPropertyChange:!1,value:{obj:{prevActObj:null}}}),o.notify("selection",{prop:"getTempActObj",onPropertyChange:!1,value:{obj:a}}),a.tempObj.activePoint.height=Math.abs(a.tempObj.activePoint.height),{isNewPath:null}),l=void 0,p=(o.notify("draw",{prop:"getNewPath",value:{obj:s}}),e.item.id.replace(i+"_","").toLowerCase()),h=void 0,d=void 0,c={freehandSelectedIndex:null},u=void 0,g={order:null};switch(p){case"duplicate":o.element.querySelector("#"+i+"_duplicate").classList.contains("e-overlay")||(this.refreshSlider(),s.isNewPath||JSON.stringify(a.tempObj)!==JSON.stringify(o.activeObj)||(n=!0),this.duplicateShape(n));break;case"remove":o.element.querySelector("#"+i+"_remove").classList.contains("e-overlay")||(o.noPushUndo=!1,this.refreshSlider(),o.notify("selection",{prop:"deleteItem",onPropertyChange:!1}));break;case"edittext":o.element.querySelector("#"+i+"_editText").classList.contains("e-overlay")||this.editText();break;case"rotleft":case"rotright":h=o.element.querySelector("#"+i+"_rotLeft"),d=o.element.querySelector("#"+i+"_rotRight"),(h&&!h.classList.contains("e-disabled")||d&&!d.classList.contains("e-disabled"))&&o.rotateImage(e.item.id.replace(i+"_","").toLowerCase()),o.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1});break;case"hflip":o.element.querySelector("#"+i+"_hFlip").classList.contains("e-disabled")||(l=o.activeObj.imageCanvas.getContext("2d"),o.horizontalFlip(l)),o.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1});break;case"vflip":o.element.querySelector("#"+i+"_vFlip").classList.contains("e-disabled")||(l=o.activeObj.imageCanvas.getContext("2d"),o.verticalFlip(l)),o.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1});break;case"bringtofront":o.element.querySelector("#"+i+"_bringToFront").classList.contains("e-overlay")||(o.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:c}}),u=null!==c.freehandSelectedIndex?o.pointColl[c.freehandSelectedIndex].id:o.activeObj.currIndex,o.updateShapeOrder(u,p),o.notify("shape",{prop:"getHighestOrder",onPropertyChange:!1,value:{obj:g}}),(-1<u.indexOf("pen")?(o.notify("shape",{prop:"updateShapeColl",onPropertyChange:!1}),r=o.getObjFromId(u).order,g.order<=r):(r=o.getObjFromId(u).order,g.order<r))?document.getElementById(o.element.id+"_bringToFront").classList.add("e-overlay"):document.getElementById(o.element.id+"_bringToFront").classList.remove("e-overlay"),o.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1}))}"duplicate"!==p&&"remove"!==p||o.notify("draw",{prop:"redrawDownScale"})}T.isNullOrUndefined(t)&&o.trigger("quickAccessToolbarItemClick",e)},L.prototype.editText=function(){var e=this.parent,t={x:e.activeObj.activePoint.startX,y:e.activeObj.activePoint.startY},o=(this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("selection",{prop:"setTempActObj",onPropertyChange:!1,value:{obj:T.extend({},e.activeObj,{},!0)}}),e.notify("selection",{prop:"setInitialTextEdit",onPropertyChange:!1,value:{bool:!0}}),e.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:T.extend({},e.activeObj,{},!0)}}),0!==e.activeObj.rotatedAngle&&(o={x:t.x,y:t.y},e.notify("shape",{prop:"getTextBoxPosition",onPropertyChange:!1,value:{obj:e.activeObj,object:o}}),t.x=o.x,t.y=o.y,o={x:t.x,y:t.y},e.notify("shape",{prop:"setFlipState",onPropertyChange:!1,value:{x:t.x,y:t.y,obj:e.activeObj,object:o}}),t.x=o.x,t.y=o.y),T.extend({},e.activeObj,{},!0));e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.lowerContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),e.notify("draw",{prop:"redrawDownScale"}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),e.activeObj=o,e.notify("shape",{prop:"renderTextArea",onPropertyChange:!1,value:{x:t.x,y:t.y,actObj:e.activeObj}}),T.isNullOrUndefined(e.activeObj.currIndex)&&e.notify("draw",{prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!0}}),document.getElementById(e.element.id+"_quickAccessToolbarArea")&&(document.getElementById(e.element.id+"_quickAccessToolbarArea").style.display="none")},L.prototype.duplicateShape=function(e,t){var o,i=this.parent,r=(i.notify("selection",{prop:"setTempActObj",onPropertyChange:!1,value:{obj:{activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[]}}}),{prevActObj:null}),n=(i.notify("draw",{prop:"getPrevActObj",onPropertyChange:!1,value:{obj:r}}),i.notify("draw",{prop:"getNewPath",value:{obj:{isNewPath:null}}}),T.extend({},i.activeObj,{},!0)),a={order:null},a=(i.notify("shape",{prop:"getHighestOrder",onPropertyChange:!1,value:{obj:a}}),n.order?i.notify("shape",{prop:"updateShapeColl",onPropertyChange:!1}):(i.noPushUndo=!0,i.okBtn(),i.noPushUndo=!1,i.selectShape(n.currIndex)),n.order=a.order>n.order?a.order+1:n.order+1,"image"===n.shape&&(o=T.extend([],i.objColl,[],!0),i.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:o}})),T.isNullOrUndefined(i.activeObj.currIndex)?i.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:e}}):r.prevActObj||t?(i.activeObj.currIndex=null,n.currIndex=null,i.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:e}})):i.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}}),i.noPushUndo);if(i.noPushUndo=!1,i.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),i.noPushUndo=a,o=T.extend([],i.objColl,[],!0),n.activePoint.startX+=10,n.activePoint.startY-=10,n.activePoint.endX+=10,n.activePoint.endY-=10,"path"===n.shape)for(var s=0;s<n.pointColl.length;s++)n.pointColl[s].x+=10,n.pointColl[s].y-=10;else"image"===n.shape&&(n.imageCanvas=i.createElement("canvas"));r={id:"shape_"+(i.objColl.length+1)},i.notify("shape",{prop:"getNewShapeId",onPropertyChange:!1,value:{obj:r}}),n.currIndex=r.id,i.activeObj=T.extend({},n,{},!0),"image"===i.activeObj.shape&&(t=T.extend({},n.activePoint,{},!0),i.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!(e={width:0,height:0}),value:{width:i.activeObj.imageElement.width,height:i.activeObj.imageElement.height,obj:e,isImgShape:null}}),i.activeObj.activePoint.width=e.width,i.activeObj.activePoint.height=e.height,i.activeObj.isHorImageFlip&&i.activeObj.isVerImageFlip?(i.activeObj.isHorImageFlip=i.activeObj.isVerImageFlip=!1,i.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:n.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:!0,isVFlip:!0}}),i.activeObj.isHorImageFlip=i.activeObj.isVerImageFlip=!0):i.activeObj.isHorImageFlip?(i.activeObj.isHorImageFlip=!1,i.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:n.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:!0,isVFlip:null}}),i.activeObj.isHorImageFlip=!0):i.activeObj.isVerImageFlip?(i.activeObj.isVerImageFlip=!1,i.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:n.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:null,isVFlip:!0}}),i.activeObj.isVerImageFlip=!0):i.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:n.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:null,isVFlip:null}}),i.activeObj.activePoint=t),"line"!==i.activeObj.shape&&"arrow"!==i.activeObj.shape||i.notify("shape",{prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:i.activeObj}}),i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:i.activeObj,isCropRatio:null,points:null,isPreventDrag:!0}}),i.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:o}}),i.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}}),i.noPushUndo=!1,i.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),i.noPushUndo=!0,i.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:i.objColl[i.objColl.length-1]}}),a=i.element.id,r=T.Browser.isDevice?"#"+a+"_bottomToolbar #"+a:"#"+a,e={freehandDrawSelectedId:null};i.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:e}}),this.enableDisableCloneBtn(r,e),this.renderQAT(),i.activeObj.shape&&"redact"===i.activeObj.shape&&this.redactSlider(i.activeObj.redactType)},L.prototype.defToolbarClicked=function(e){var t,o,i,r,n=this.parent,a=n.element.id,s=!1,l=!1;!this.isFrameToolbar&&n.element.querySelector(".e-contextual-toolbar-wrapper")&&(n.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")||(s=l=!0),t=n.isStraightening,T.Browser.isDevice&&(!T.Browser.isDevice||t)||n.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide")),e.item&&("duplicate"===(t=e.item.id.replace(a+"_","").toLowerCase())||"remove"===t||"edittext"===t||"hflip"===t||"vflip"===t||"rotleft"===t||"rotright"===t?(this.quickAccessToolbarClicked(e,!0),n.trigger("toolbarItemClicked",e)):(i=o=!1,(r=document.querySelector("#"+a+"_adjustment"))&&r.classList.contains("e-disabled")&&(i=!0),(r=document.querySelector("#"+a+"_filter"))&&r.classList.contains("e-disabled")&&(o=!0),this.enableDisableTbrBtn(),this.performDefTbrClick(t,s,i,o,l),n.trigger("toolbarItemClicked",e),n.isStraightening&&n.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),-1!==["undo","redo","cancel","aspectratio","nonaspectratio","save","duplicate","filter","frame","none","mat","bevel","line","inset","hook","resize","remove"].indexOf(t)&&n.notify("draw",{prop:"redrawDownScale"})))},L.prototype.performDefTbrClick=function(e,t,o,i,r){var n,a,s,l,p=this.parent,h=p.element.id,d=p.element.querySelector("#"+h+"_zoomIn"),c=p.element.querySelector("#"+h+"_resizeHeight"),u=p.element.querySelector("#"+h+"_resizeWidth"),g=!1,v=!1;if((void 0===(n=void 0!==p.activeObj.shape?p.activeObj.shape.split("-"):n)&&p.currObjType.isCustomCrop||void 0!==n&&"crop"===n[0])&&(g=!0),!p.disabled){switch(e){case"pan":p.currObjType.isCustomCrop=p.currObjType.isFiltered=!1,p.currObjType.isRedact=!1,p.currObjType.isUndoAction&&p.notify("undo-redo",{prop:"refreshUrc",value:{bool:null}}),g&&(p.currObjType.isCustomCrop=!1,p.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,p.upperCanvas.width,p.upperCanvas.height),this.refreshToolbar("main")),p.togglePan?(this.cancelPan(),p.notify("transform",{prop:"setDisablePan",onPropertyChange:!1,value:{bool:!0}}),"pen"===this.currentToolbar&&p.freeHandDraw(!0)):((a=p.element.querySelector(".e-img-pan .e-btn"))&&a.classList.add("e-selected-btn"),p.pan(!0),p.notify("transform",{prop:"setDisablePan",onPropertyChange:!1,value:{bool:!1}})),d&&p.zoomSettings.zoomFactor>=p.zoomSettings.maxZoomFactor?(d.classList.add("e-disabled"),d.parentElement.classList.add("e-overlay")):d&&(d.classList.remove("e-disabled"),d.parentElement.classList.remove("e-overlay")),this.refreshToolbar("main");break;case"cancel":p.currObjType.isRedact&&(p.currObjType.isRedact=!1),this.isFrameToolbar&&p.element.querySelector(".e-contextual-toolbar-wrapper")&&!p.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")&&p.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),p.notify("draw",{prop:"performCancel",value:{isContextualToolbar:t,isFinalCancel:!0}});break;case"ok":T.Browser.isDevice&&this.isFrameToolbar&&p.element.querySelector(".e-contextual-toolbar-wrapper")&&!p.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")&&p.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),p.okBtn(null,!0),p.drawingShape=null,this.refreshDropDownBtn(!1),this.currentToolbar="main",p.isStraightening=!1,p.notify("draw",{prop:"resetTempObjColl"}),p.notify("draw",{prop:"resetTempPointColl"});break;case"crop":p.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),T.Browser.isDevice&&this.updateContextualToolbar("color","straighten");break;case"reset":p.reset(),this.imageHeight=null,this.imageWidth=null,p.aspectHeight=null,p.aspectWidth=null,this.isAspectRatio=!0,this.currentToolbar="main";break;case"undo":p.noPushUndo=!1,(p.togglePen||p.drawingShape)&&(p.okBtn(),p.drawingShape=null),p.notify("undo-redo",{prop:"call-undo"});break;case"redo":p.noPushUndo=!1,(p.togglePen||p.drawingShape)&&(p.okBtn(),p.drawingShape=null),p.notify("undo-redo",{prop:"call-redo"});break;case"aspectratio":(!p.isCircleCrop&&T.isNullOrUndefined(p.currSelectionPoint)||p.currSelectionPoint&&"crop-circle"!==p.currSelectionPoint.shape)&&(T.getComponent(u,"numerictextbox").value?(p.aspectWidth=T.getComponent(u,"numerictextbox").value,p.aspectHeight=T.getComponent(c,"numerictextbox").value,p.notify("transform",{prop:"resize",value:{width:p.aspectWidth,height:null,isAspectRatio:!0}})):T.getComponent(c,"numerictextbox").value&&(p.aspectWidth=parseFloat(T.getComponent(u,"numerictextbox").placeholder),p.aspectHeight=T.getComponent(c,"numerictextbox").value,p.notify("transform",{prop:"resize",value:{width:p.aspectWidth,height:p.aspectHeight,isAspectRatio:!0}})),p.resizeSrc={startX:p.img.srcLeft,startY:p.img.srcTop,width:p.img.srcWidth,height:p.img.srcHeight},this.refreshToolbar("resize"));break;case"nonaspectratio":(T.getComponent(u,"numerictextbox").value||T.getComponent(c,"numerictextbox").value)&&(p.aspectWidth=T.getComponent(u,"numerictextbox").value?T.getComponent(u,"numerictextbox").value:parseFloat(T.getComponent(u,"numerictextbox").placeholder),p.aspectHeight=T.getComponent(c,"numerictextbox").value?T.getComponent(c,"numerictextbox").value:parseFloat(T.getComponent(c,"numerictextbox").placeholder),p.notify("transform",{prop:"resize",value:{width:p.aspectWidth,height:p.aspectHeight,isAspectRatio:!1}})),p.resizeSrc={startX:p.img.srcLeft,startY:p.img.srcTop,width:p.img.srcWidth,height:p.img.srcHeight},this.refreshToolbar("resize");break;case"resize":(p.currObjType.isFiltered||p.currObjType.isRedact)&&p.okBtn(),this.resizeClick();break;case"adjustment":o||((p.currObjType.isFiltered||p.currObjType.isRedact)&&p.okBtn(),this.refreshToolbar("adjustment"),p.setTempFilterProperties(),p.notify("draw",{prop:"updateFinetune"}),p.notify("filter",{prop:"setTempAdjVal"}),this.openSlider("brightness"));break;case"brightness":case"contrast":case"hue":case"saturation":case"opacity":case"blur":case"exposure":this.openSlider(e);break;case"filter":i||(f.showSpinner(p.element),this.refreshToolbar("filter"),p.setTempFilterProperties(),f.hideSpinner(p.element));break;case"default":case"chrome":case"cold":case"warm":case"grayscale":case"blackandwhite":case"sepia":case"invert":case"sharpen":p.currObjType.isFiltered=!0,p.notify("filter",{prop:"applyImageFilter",value:{option:e}});break;case"upload":r&&p.element.querySelector(".e-contextual-toolbar-wrapper").classList.remove("e-hide");break;case"bold":p.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}}),p.activeObj.textSettings.bold&&p.activeObj.textSettings.italic?p.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"italic"}}):p.activeObj.textSettings.bold&&!p.activeObj.textSettings.italic?p.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"default"}}):!p.activeObj.textSettings.bold&&p.activeObj.textSettings.italic?p.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"bolditalic"}}):p.activeObj.textSettings.bold||p.activeObj.textSettings.italic||p.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"bold"}}),p.element.querySelector("#"+h+"_bold").classList.contains("e-selected-btn")?p.element.querySelector("#"+h+"_bold").classList.remove("e-selected-btn"):p.element.querySelector("#"+h+"_bold").classList.add("e-selected-btn"),0===p.activeObj.activePoint.width&&0===p.activeObj.activePoint.height||p.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1});break;case"italic":p.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}}),p.activeObj.textSettings.bold&&p.activeObj.textSettings.italic?p.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"bold"}}):p.activeObj.textSettings.bold&&!p.activeObj.textSettings.italic?p.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"bolditalic"}}):!p.activeObj.textSettings.bold&&p.activeObj.textSettings.italic?p.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"default"}}):p.activeObj.textSettings.bold||p.activeObj.textSettings.italic||p.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"italic"}}),p.element.querySelector("#"+h+"_italic").classList.contains("e-selected-btn")?p.element.querySelector("#"+h+"_italic").classList.remove("e-selected-btn"):p.element.querySelector("#"+h+"_italic").classList.add("e-selected-btn"),0===p.activeObj.activePoint.width&&0===p.activeObj.activePoint.height||p.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1});break;case"croptransform":this.performCropTransformClick();break;case"rotateleft":case"rotateright":case"horizontalflip":case"verticalflip":p.transformSelect(e),this.updateRedactObj(),"rotateleft"!==e&&"rotateright"!==e||(p.notify("draw",{prop:"resetStraightenDestPoints"}),p.notify("draw",{prop:"setDestForStraighten"})),p.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),T.Browser.isDevice&&this.updateContextualToolbar("color","straighten"),a={action:"rotateleft"===e||"rotateright"===e?"rotate":"flip",actionEventArgs:p.editCompleteArgs},p.triggerEditCompleteEvent(a);break;case"save":p.noPushUndo=!1,p.okBtn(),p.drawingShape=null,this.saveDialogPopup();break;case"transparency":this.updateContextualToolbar("transparency","transparency");break;case"frame":this.frameToolbarClick();break;case"none":case"mat":case"bevel":case"line":case"inset":case"hook":this.unselectFrameBtn(),p.element.querySelector("#"+h+"_"+e)&&p.element.querySelector("#"+h+"_"+e).classList.add("e-selected-btn"),p.frameObj.type=e,p.frameObj.size=20,p.frameObj.inset=20,p.frameObj.radius=0,p.frameObj.amount=1,p.frameObj.offset="inset"===e?60:20,this.refreshToolbar("frame"),p.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),p.isFrameBtnClick=!0,p.curFrameObjEvent={previousFrameSetting:p.tempFrameObj,currentFrameSetting:p.frameObj},p.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:p.tempFrameObj,obj:{frameChangeEventArgs:null}}});break;case"redact":p.currObjType.isRedact=v=!0,p.drawingShape="redact",T.isNullOrUndefined(p.activeObj.redactBlur)&&(p.activeObj.redactBlur=20),T.isNullOrUndefined(p.activeObj.redactPixelate)&&(p.activeObj.redactPixelate=20),p.notify("selection",{prop:"annotate",value:{shape:"redact"}}),this.refreshToolbar("redact"),this.redactSlider(p.activeObj.redactType);break;case"pixelate":p.currObjType.isRedact=v=!0,p.drawingShape="redact",p.notify("selection",{prop:"annotate",value:{shape:"redact"}}),"blur"===p.activeObj.redactType&&this.updateRedactType("pixelate"),p.notify("shape",{prop:"setRedactType",onPropertyChange:!1,value:{redactType:"pixelate"}}),"pixelate"===p.activeObj.redactType?(l=p.element.querySelector("#"+h+"_pixelate"),s=p.element.querySelector("#"+h+"_redactBlur"),l&&l.classList.add("e-selected-btn"),s&&s.classList.contains("e-selected-btn")&&s.classList.remove("e-selected-btn")):(s=p.element.querySelector("#"+h+"_redactBlur"))&&s.classList.add("e-selected-btn"),this.redactSlider(p.activeObj.redactType),0===p.activeObj.activePoint.width&&0===p.activeObj.activePoint.height||p.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:null,previousObjColl:null,previousPointColl:null,previousSelPointColl:null,previousCropObj:null,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}});break;case"redactblur":p.currObjType.isRedact=v=!0,p.drawingShape="redact",p.notify("selection",{prop:"annotate",value:{shape:"redact"}}),p.notify("shape",{prop:"setRedactType",onPropertyChange:!1,value:{redactType:"blur"}}),"pixelate"===p.activeObj.redactType&&this.updateRedactType("blur"),p.notify("shape",{prop:"setRedactType",onPropertyChange:!1,value:{redactType:"blur"}}),"blur"===p.activeObj.redactType?(s=p.element.querySelector("#"+h+"_redactBlur"),l=p.element.querySelector("#"+h+"_pixelate"),s&&s.classList.add("e-selected-btn"),l&&l.classList.contains("e-selected-btn")&&l.classList.remove("e-selected-btn")):(l=p.element.querySelector("#"+h+"_pixelate"))&&l.classList.add("e-selected-btn"),this.redactSlider(p.activeObj.redactType),0===p.activeObj.activePoint.width&&0===p.activeObj.activePoint.height||p.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:null,previousObjColl:null,previousPointColl:null,previousSelPointColl:null,previousCropObj:null,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})}v&&(p.notify("draw",{prop:"updateTempObjColl"}),p.notify("draw",{prop:"updateTempPointColl"}))}},L.prototype.updateRedactType=function(e){var t=this.parent;t.activeObj.redactType=e,t.notify("shape",{prop:"setRedactType",value:{type:e}}),this.parent.objColl.push(t.activeObj),t.notify("selection",{prop:"redrawShape",value:{obj:t.objColl[t.objColl.length-1]}})},L.prototype.frameToolbarClick=function(){var e,t,o=this.parent,i=o.element.id,r=document.querySelector("#"+i+"_frame");o.notify("draw",{prop:"updateCropSelection",onPropertyChange:!1}),(o.currObjType.isFiltered||o.currObjType.isRedact)&&o.okBtn(),r&&!r.classList.contains("e-overlay")&&(r=o.transform.zoomFactor,o.frameDestPoints=T.extend({},o.img,{},!0),T.isNullOrUndefined(o.cxtTbarHeight)&&(e=T.extend({},o.frameObj,{},!0),t=T.extend({},o.tempFrameObj,{},!0),this.callFrameToolbar(),o.frameObj.type="mat",this.callFrameToolbar(),o.cxtTbarHeight=o.element.querySelector("#"+i+"_customizeWrapper").scrollHeight,o.frameObj=e,o.tempFrameObj=t),this.zoomToFrameRange(),o.tempFrameZoomLevel=r,T.Browser.isDevice?o.img.destTop-=o.cxtTbarHeight/2:o.img.destTop+=o.cxtTbarHeight/2,this.callFrameToolbar(),o.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:o.frameObj,obj:{frameChangeEventArgs:null}}}))},L.prototype.zoomToFrameRange=function(){for(var e=this.parent,t=(this.isFrameToolbar=!1,e.notify("transform",{prop:"resetZoom",onPropertyChange:!1}),!0);t;){if(this.toolbarHeight+e.img.destTop>=this.toolbarHeight+e.cxtTbarHeight){t=!1;break}e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null,isResize:!0}})}this.isFrameToolbar=!0},L.prototype.resizeClick=function(){var e=this.parent;e.notify("draw",{prop:"updateCropSelection",onPropertyChange:!1}),e.upperCanvas.style.cursor="default",e.notify("transform",{prop:"updateResize",value:{bool:!1}}),this.isAspectRatio?this.isAspectRatio=!1:this.isAspectRatio=!0,e.isResize=!0,this.refreshToolbar("resize")},L.prototype.callFrameToolbar=function(){var e=this.parent,t=(T.extend(e.tempFrameObj,e.frameObj),{appliedUndoRedoColl:[]});e.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:t}}),0===t.appliedUndoRedoColl.length&&(e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(t={currObj:{}}),value:{object:t}}),e.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:t.currObj,previousObjColl:t.currObj.objColl,previousPointColl:t.currObj.pointColl,previousSelPointColl:t.currObj.selPointColl,previousCropObj:T.extend({},e.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})),this.refreshToolbar("frame")},L.prototype.contextualToolbarClicked=function(e){var t=this.parent,o=t.element.querySelector(".e-contextual-toolbar-wrapper .e-toolbar-item.e-selected"),o=(o&&o.classList.remove("e-selected"),e.item.id.replace(t.element.id,"").split("_")[1]),i={filter:t.toPascalCase(o),cancel:!1};t.trigger("imageFiltering",i),(t.editCompleteArgs=i).cancel||(document.getElementById(e.item.id+"Canvas").parentElement.parentElement.classList.add("e-selected"),t.currObjType.isFiltered=!0,t.notify("filter",{prop:"applyImageFilter",value:{option:o.toLowerCase()}}),t.notify("draw",{prop:"redrawDownScale"}),t.currentFilter=e.item.id,this.enableDisableTbrBtn(),t.isFilterCanvasClick=!0,t.curFilterObjEvent=i)},L.prototype.refreshShapeDrawing=function(){var e=this.parent,t={shape:""};e.notify("selection",{prop:"getCurrentDrawingShape",onPropertyChange:!1,value:{obj:t}}),""!==t.shape&&(e.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.refreshToolbar("main",!1))},L.prototype.zoomInBtnClickHandler=function(e){if(e){var t=this.parent;if((t.zoomSettings.zoomTrigger&m.ZoomTrigger.Toolbar)===m.ZoomTrigger.Toolbar){t.noPushUndo=!1,t.currObjType.isFiltered&&t.okBtn();var o=t.drawingShape;if(t.drawingShape&&(i=t.activeObj.currIndex,t.noPushUndo=!0,t.okBtn(),t.noPushUndo=!1,t.drawingShape=null,i)&&t.selectShape(i),this.refreshShapeDrawing(),T.Browser.isDevice&&"touchstart"===e.type){if(!e.returnValue)return;e.preventDefault()}var i=document.querySelector("#"+t.element.id+"_zoomIn"),e=(T.EventHandler.trigger(i,"click"),{bool:!1}),e=(t.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:e}}),e.bool&&(t.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.destroyQuickAccessToolbar()),t.isZoomBtnClick=!0,this.applyPreviewFilter(),t.currObjType.isFiltered=!1,t.currObjType.isRedact=!1,t.togglePen&&(t.currObjType.isZoomed=!0,t.freeHandDraw(!1),t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})),t.notify("draw",{prop:"resetCurrentSelectionPoint"}),t.drawingShape=o,t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null,isResize:null}}),t.notify("draw",{prop:"redrawDownScale"}),(t.isCropTab||t.activeObj.shape)&&(t.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),t.notify("freehand-draw",{prop:"resetStraightenPoint"})),t.isStraightening&&(t.notify("draw",{prop:"resetStraightenDestPoints"}),t.notify("draw",{prop:"setDestForStraighten"})),{action:"zoom-in",actionEventArgs:t.editCompleteArgs});t.triggerEditCompleteEvent(e),T.Browser.isDevice&&i.focus()}}},L.prototype.zoomOutBtnClickHandler=function(e){if(e){var t=this.parent;if((t.zoomSettings.zoomTrigger&m.ZoomTrigger.Toolbar)===m.ZoomTrigger.Toolbar){t.noPushUndo=!1,t.currObjType.isFiltered&&t.okBtn();var o=t.drawingShape;if(t.drawingShape&&(i=t.activeObj.currIndex,t.noPushUndo=!0,t.okBtn(),t.noPushUndo=!1,t.drawingShape=null,i)&&t.selectShape(i),this.refreshShapeDrawing(),T.Browser.isDevice&&"touchstart"===e.type){if(!e.returnValue)return;e.preventDefault()}var i=document.querySelector("#"+t.element.id+"_zoomOut"),e=(T.EventHandler.trigger(i,"click"),{bool:!1}),e=(t.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:e}}),e.bool&&(t.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.destroyQuickAccessToolbar()),t.isZoomBtnClick=!0,this.applyPreviewFilter(),t.currObjType.isFiltered=!1,t.currObjType.isRedact=!1,t.togglePen&&(t.currObjType.isZoomed=!0,t.freeHandDraw(!1),t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})),t.notify("draw",{prop:"resetCurrentSelectionPoint"}),t.drawingShape=o,t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null,isResize:null}}),t.notify("draw",{prop:"redrawDownScale"}),(t.isCropTab||t.activeObj.shape)&&(t.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),t.notify("freehand-draw",{prop:"resetStraightenPoint"})),t.isStraightening&&(t.notify("draw",{prop:"resetStraightenDestPoints"}),t.notify("draw",{prop:"setDestForStraighten"})),{action:"zoom-out",actionEventArgs:t.editCompleteArgs});t.triggerEditCompleteEvent(e),T.Browser.isDevice&&i.focus()}}},L.prototype.zoomInBtnMouseDownHandler=function(e){e.preventDefault(),this.zoomBtnHold=setInterval(this.zoomInBtnClickHandler.bind(this),250)},L.prototype.zoomOutBtnMouseDownHandler=function(e){e.preventDefault(),this.zoomBtnHold=setInterval(this.zoomOutBtnClickHandler.bind(this),250)},L.prototype.zoomBtnMouseUpHandler=function(){clearInterval(this.zoomBtnHold),this.zoomBtnHold=0},L.prototype.closeContextualToolbar=function(){var e=this.parent,t=e.element.id,o=!1,i=e.isStraightening;return(!T.Browser.isDevice||T.Browser.isDevice&&!i)&&(e.element.querySelector("#"+t+"_contextualToolbar")&&!e.element.querySelector("#"+t+"_contextualToolbar").parentElement.classList.contains("e-hide")||e.element.querySelector("#"+t+"_headWrapper")&&!e.element.querySelector("#"+t+"_headWrapper").parentElement.classList.contains("e-hide"))&&(e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),e.okBtn(),this.refreshMainToolbar(),o=!0),o},L.prototype.destroyQuickAccessToolbar=function(){var e=this.parent.element.id,t=document.getElementById(e+"_quickAccessToolbar"),t=(t&&t.classList.contains("e-control")&&T.getComponent(t,"toolbar").destroy(),document.getElementById(e+"_quickAccessToolbarArea"));t&&(t.style.display="none")},L.prototype.renderSlider=function(e,t){var o,i,r,n=this.parent,a=n.element.id,s=document.querySelector("#"+a+"_contextualToolbarArea"),l=document.querySelector("#"+a+"_headWrapper"),p=document.querySelector("#"+a+"_labelWrapper"),p=(l&&(l.remove(),p.remove()),l=s.appendChild(n.createElement("div",{id:a+"_headWrapper",styles:"position: relative"})),(p="transparency"===e?l.appendChild(n.createElement("label",{id:a+"_labelWrapper",className:"e-ie-finetune-slider-label",styles:T.Browser.isDevice?"position: absolute; top: 31%; left: calc(50% - 150px); font-size: 15px; text-transform: capitalize; font-weight: 400;":"position: absolute; top: 31%; left: calc(50% - 220px); font-size: 15px; text-transform: capitalize; font-weight: 400;"})):l.appendChild(n.createElement("label",{id:a+"_labelWrapper",className:"e-ie-finetune-slider-label",styles:T.Browser.isDevice?"position: absolute; top: 31%; left: calc(50% - 160px); font-size: 15px; text-transform: capitalize; font-weight: 400;":"position: absolute; top: 25%; left: calc(50% - 226px); font-size: 15px; text-transform: capitalize; font-weight: 400;"}))).textContent=this.l10n.getConstant(n.toPascalCase("transparency"===e?"opacity":e)),l.appendChild(n.createElement("div",{id:a+"_sliderWrapper",className:"e-ie-finetune-slider-wrap",styles:"position: absolute"}))),h=n.getCurrAdjustmentValue(e);t&&"straighten"===e&&T.Browser.isDevice&&(h=n.cropObj.straighten),"brightness"===e||"contrast"===e||"saturation"===e||"exposure"===e?(i=n.finetuneSettings?"brightness"===e&&n.finetuneSettings.brightness?(o=n.finetuneSettings.brightness.min,n.finetuneSettings.brightness.max):"contrast"===e&&n.finetuneSettings.contrast?(o=n.finetuneSettings.contrast.min,n.finetuneSettings.contrast.max):"saturation"===e&&n.finetuneSettings.saturation?(o=n.finetuneSettings.saturation.min,n.finetuneSettings.saturation.max):"exposure"===e&&n.finetuneSettings.exposure?(o=n.finetuneSettings.exposure.min,n.finetuneSettings.exposure.max):(o=-100,100):(o=-100,100),r=this.createSlider(o,i,h,e)):"hue"===e||"blur"===e||"opacity"===e?(i=n.finetuneSettings?"hue"===e&&n.finetuneSettings.hue?(o=n.finetuneSettings.hue.min,n.finetuneSettings.hue.max):"blur"===e&&n.finetuneSettings.blur?(o=n.finetuneSettings.blur.min,n.finetuneSettings.blur.max):"opacity"===e&&n.finetuneSettings.opacity?(o=n.finetuneSettings.opacity.min,n.finetuneSettings.opacity.max):(o=0,100):(o=0,100),r=this.createSlider(o,i,h,e)):"transparency"===e?r=this.createSlider(o=0,i=100,h,e):"straighten"===e&&(r=this.createSlider(o=-45,i=45,h,e)),r.appendTo("#"+a+"_sliderWrapper"),p.style.left=(parseFloat(s.style.width)-parseFloat(r.width))/2+"px","straighten"===e&&T.Browser.isDevice&&(l.appendChild(n.createElement("label",{id:a+"_sLabelWrapper",className:"e-ie-straighten-value-span e-ie-finetune-value-span",styles:"position: absolute; top: 31%; margin-left: 20px; font-size: 15px; text-transform: capitalize; font-weight: 400;"})).innerHTML=n.transform.straighten.toString()+"&#176",p.parentElement.classList.add("e-straighten-slider")),"straighten"!==e&&(l.appendChild(n.createElement("label",{id:a+"_finetuneSpan",className:"e-ie-finetune-value-span",styles:T.Browser.isDevice?"position: absolute; top: 25%; margin-left: 20px; font-size: 15px; text-transform: capitalize; font-weight: 400;":"position: absolute; top: 25%; left: calc(50% + 190px); font-size: 15px; text-transform: capitalize; font-weight: 400;"})),p.parentElement.classList.add("e-finetune-slider"),"transparency"===e&&T.Browser.isDevice&&p.parentElement.classList.add("e-ie-device-transparency-slider"),this.updateFinetuneSpan(e))},L.prototype.createSlider=function(e,t,o,r){var n=this,a=this.parent;return new g.Slider({value:o,type:"MinRange",min:e,max:t,step:"straighten"===r?3:1,width:T.Browser.isDevice?"180px":"straighten"===r?"200px":"300px",cssClass:"e-slider",change:function(e){var t,o,i;a.notify("selection",{prop:"setSliderActive",onPropertyChange:!1,value:{bool:!0}}),"transparency"===r?a.activeObj.shape&&(T.isNullOrUndefined(a.activeObj.imageRatio)&&a.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),a.notify("shape",{prop:"pushActItemIntoObj"}),t=T.extend({},a.cropObj,{},!0),a.notify("filter",{prop:"getCurrentObj",onPropertyChange:!(o={currObj:{}}),value:{object:o}}),(o=o.currObj).objColl=T.extend([],a.objColl,[],!0),o.pointColl=T.extend([],a.pointColl,[],!0),o.afterCropActions=T.extend([],a.afterCropActions,[],!0),a.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!(i={selPointColl:null}),value:{obj:i}}),o.selPointColl=T.extend([],i.selPointColl,[],!0),a.objColl.pop(),a.activeObj.opacity=e.value/100,n.upperContext.clearRect(0,0,a.upperCanvas.width,a.upperCanvas.height),a.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),a.objColl.push(a.activeObj),a.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:o,previousObjColl:o.objColl,previousPointColl:o.pointColl,previousSelPointColl:o.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),a.notify("selection",{prop:"redrawShape",value:{obj:a.objColl[a.objColl.length-1]}}),n.updateFinetuneSpan(r)):"straighten"===r?a.setStraighten(e.value):(a.transform.zoomFactor&&a.transform.zoomFactor<0&&(a.isFinetuning=!0),a.notify("selection",{prop:"setSliding",value:{bool:!0}}),a.setCurrAdjustmentValue(r,e.value),n.updateFinetuneSpan(r),n.enableDisableTbrBtn(),a.isFinetuning=!1)},changed:function(){"transparency"!==r&&"straighten"!==r&&(a.notify("selection",{prop:"setSliding",value:{bool:!1}}),a.notify("draw",{prop:"redrawDownScale"})),a.notify("selection",{prop:"setSliderActive",onPropertyChange:!1,value:{bool:!1}}),"transparency"===r&&setTimeout(function(){a.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1}),a.element.querySelector("#"+a.element.id+"_transparency").click()},50)}})},L.prototype.updateFinetuneSpan=function(e){var t=this.parent,o=t.element.querySelector(".e-ie-finetune-value-span");o&&(t.notify("filter",{prop:"getAdjustmentLevel",onPropertyChange:!(t={adjustmentLevel:null}),value:{obj:t}}),o.innerHTML=Math.round(t.adjustmentLevel[e]).toString())},L.prototype.applyPreviewFilter=function(){var e=this.parent;(document.querySelector("#"+e.element.id+"_sliderWrapper")||e.currObjType.isFiltered)&&(e.initialAdjustmentValue=this.lowerContext.filter,e.canvasFilter=this.lowerContext.filter,e.currObjType.isFiltered=!1)},L.prototype.unselectBtn=function(){for(var e=this.parent.element.id,t=0,o=["#"+e+"_brightness","#"+e+"_contrast","#"+e+"_hue","#"+e+"_saturation","#"+e+"_opacity","#"+e+"_blur","#"+e+"_exposure"];t<o.length;t++){var i=document.querySelector(o[t]);if(i&&i.classList.contains("e-selected-btn")){i.classList.remove("e-selected-btn");break}}},L.prototype.openSlider=function(e){this.unselectBtn(),this.parent.currObjType.isFiltered=!0,this.refreshToolbar("color",null,null,null,e),document.getElementById(this.parent.element.id+"_"+e).classList.add("e-selected-btn")},L.prototype.refreshSlider=function(){var e=this.parent.element.id,t=document.querySelector("#"+e+"_sliderWrapper"),o=document.querySelector(".e-slider"),e=document.querySelector("#"+e+"_headWrapper");e&&(e.style.display="none"),t&&o&&(o.ej2_instances[0].destroy(),t.remove())},L.prototype.unselectFrameBtn=function(){for(var e=this.parent.element.id,t=0,o=["#"+e+"_none","#"+e+"_mat","#"+e+"_line","#"+e+"_inset","#"+e+"_bevel","#"+e+"_hook"];t<o.length;t++){var i=document.querySelector(o[t]);if(i.classList.contains("e-selected-btn")){i.classList.remove("e-selected-btn");break}}},L.prototype.updateToolbarItems=function(){var e=this.parent,t=e.element.id;if(e.isImageLoaded&&this.isToolbar()){var o,i=e.element.querySelector(".e-fill.e-template .e-dropdownbtn-preview"),r=e.element.querySelector(".e-stroke.e-template .e-dropdownbtn-preview"),n=e.element.querySelector(".e-text-font-color.e-template .e-dropdownbtn-preview"),a=e.element.querySelector(".e-stroke-text-font-color.e-template .e-dropdownbtn-preview"),s=e.element.querySelector(".e-text-background-color.e-template .e-dropdownbtn-preview"),l=e.element.querySelector(".e-pen-stroke-color.e-template .e-dropdownbtn-preview"),p=e.element.querySelector(".e-shape-stroke-width"),h=e.element.querySelector(".e-shape-rectangle-radius"),d=e.element.querySelector(".e-text-font-family"),c=e.element.querySelector(".e-text-font-size"),u=e.element.querySelector("#"+t+"_bold"),g=e.element.querySelector("#"+t+"_italic");if(e.activeObj.strokeSettings&&e.activeObj.textSettings){if(T.isNullOrUndefined(e.activeObj.strokeSettings.strokeWidth)&&(e.activeObj.strokeSettings.strokeWidth=2),T.isNullOrUndefined(e.activeObj.strokeSettings.outlineWidth)&&(e.activeObj.strokeSettings.outlineWidth=2),i&&(o=e.activeObj.strokeSettings.fillColor,""===e.activeObj.strokeSettings.fillColor?i.classList.add("e-nocolor-item"):(i.classList.remove("e-nocolor-item"),i.style.background=o),document.querySelector("#"+t+"_shape_fill"))&&(T.getComponent(t+"_shape_fill","colorpicker").value=o),r&&(o=e.activeObj.strokeSettings.strokeColor,r.style.background=o,document.querySelector("#"+t+"_shape_stroke"))&&(T.getComponent(t+"_shape_stroke","colorpicker").value=o),n&&(o=e.activeObj.strokeSettings.strokeColor,n.style.background=o,document.querySelector("#"+t+"_text_font"))&&(T.getComponent(t+"_text_font","colorpicker").value=o),a&&(o=e.activeObj.strokeSettings.outlineColor,/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$|^[a-zA-Z]+$/.test(e.activeObj.strokeSettings.outlineColor)?(a.classList.remove("e-nocolor-item"),a.style.background=o):a.classList.add("e-nocolor-item"),document.querySelector("#"+t+"_stroke_text"))&&(T.getComponent(t+"_stroke_text","colorpicker").value=o),s&&(o=e.activeObj.strokeSettings.fillColor,""===e.activeObj.strokeSettings.fillColor||"transparent"===e.activeObj.strokeSettings.fillColor?s.classList.add("e-nocolor-item"):(s.classList.remove("e-nocolor-item"),s.style.background=o),document.querySelector("#"+t+"_text_bgColor"))&&(T.getComponent(t+"_text_bgColor","colorpicker").value=o),l&&(o=e.activeObj.strokeSettings.strokeColor,l.style.background=o,document.querySelector("#"+t+"_pen_stroke")&&(T.getComponent(t+"_pen_stroke","colorpicker").value=o),e.notify("freehand-draw",{prop:"getPenOpacity",onPropertyChange:!1,value:{obj:{penOpacity:1}}})),d&&(T.Browser.isDevice?d.setAttribute("style","font-family:"+e.activeObj.textSettings.fontFamily.toLowerCase()):d.textContent=e.activeObj.textSettings.fontFamily),c)for(var v=0;v<e.fontSizeColl.length;v++){if(parseInt(e.fontSizeColl[v].text,10)>=Math.round(e.activeObj.textSettings.fontSize)){c.textContent=(v+1).toString();break}if(Math.round(e.activeObj.textSettings.fontSize)<parseInt(e.fontSizeColl[0].text,10)){c.textContent="1";break}if(Math.round(e.activeObj.textSettings.fontSize)>parseInt(e.fontSizeColl[e.fontSizeColl.length-1].text,10)){c.textContent=(e.fontSizeColl.length-1+1).toString();break}}u&&(e.activeObj.textSettings.bold?u.classList.add("e-selected-btn"):u.classList.remove("e-selected-btn")),g&&(e.activeObj.textSettings.italic?g.classList.add("e-selected-btn"):g.classList.remove("e-selected-btn")),p&&(i="text"===e.activeObj.shape?e.activeObj.strokeSettings.outlineWidth:e.activeObj.strokeSettings.strokeWidth,r=Math.round(i).toString(),p.textContent=this.getStrokeWidth(r)),h&&(n=Math.round(e.activeObj.strokeSettings.radius).toString(),h.textContent=this.getRectRadius(n))}}},L.prototype.getStrokeWidth=function(e){var t;switch(parseInt(e,10)/2){case 0:t=this.l10n.getConstant("NoOutline");break;case 1:t=this.l10n.getConstant("XSmall");break;case 2:t=this.l10n.getConstant("Small");break;case 3:t=this.l10n.getConstant("Medium");break;case 4:t=this.l10n.getConstant("Large");break;case 5:t=this.l10n.getConstant("XLarge")}return t},L.prototype.getRectRadius=function(e){var t;switch(parseInt(e,10)/2){case 0:t=this.l10n.getConstant("0");break;case 1:t=this.l10n.getConstant("20");break;case 2:t=this.l10n.getConstant("40");break;case 3:t=this.l10n.getConstant("60");break;case 4:t=this.l10n.getConstant("80");break;case 5:t=this.l10n.getConstant("100")}return t},L.prototype.cancelPan=function(){var e=this.parent,t=(e.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}}),e.element.querySelector(".e-img-pan .e-btn"));t&&t.classList.remove("e-selected-btn"),e.pan(!1)},L.prototype.refreshMainToolbar=function(){"main"!==this.currToolbar&&this.refreshToolbar("main")},L.prototype.destroySubComponents=function(){for(var e=this.parent,t=e.element.querySelectorAll("input.e-control"),o=e.element.querySelectorAll("button.e-control"),i=0,r=t.length;i<r;i++)t[i].classList.contains("e-color-picker")&&(T.getComponent(t[i],"color-picker").destroy(),T.detach(T.select("input#"+t[i].id,e.element)));for(i=0,r=o.length;i<r;i++)o[i].classList.contains("e-dropdown-btn")?(T.getComponent(o[i],"dropdown-btn").destroy(),T.detach(T.select("button#"+o[i].id,e.element))):o[i].classList.contains("e-btn")&&(T.getComponent(o[i],"btn").destroy(),T.detach(T.select("button#"+o[i].id,e.element)))},L.prototype.setInitialShapeSettings=function(e){var t=this.parent,e=(t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.currObjType.shape=e.item.id,t.activeObj.shape=t.currObjType.shape.toLowerCase(),t.currObjType.isDragging=t.currObjType.isCustomCrop=!1,t.activeObj.shapeDegree=t.transform.degree,t.activeObj.shapeFlip=t.transform.currFlipState,t.activeObj.textFlip=t.transform.currFlipState,t.activeObj.flipObjColl=[],{order:null});t.notify("shape",{prop:"getNewOrder",onPropertyChange:!1,value:{obj:e}}),t.activeObj.order=e.order},L.prototype.isToolbarString=function(e){for(var t=!1,o=0;o<e.length;o++)if("string"==typeof e[o]){t=!0;break}return t},L.prototype.excludeItems=function(e){for(var t=[],o=0;o<e.length;o++){var i=this.getIndex(e[o]);-1!==i&&t.push(i)}for(var r=[],o=0;o<this.defToolbarItems.length;o++)"Center"!==this.defToolbarItems[o].align||this.isSameIndex(t,o)||this.defToolbarItems[o].id===this.parent.element.id+"_annotation"||r.push(o);for(o=r.length-1;0<=o;o--)this.defToolbarItems.splice(r[o],1)},L.prototype.isSameIndex=function(e,t){for(var o=0;o<e.length;o++)if(e[o]===t)return!0;return!1},L.prototype.getIndex=function(e){var t=-1,o=!1;"fontColor"===(e="arrowEnd"===(e="arrowStart"===(e="verticalFlip"===(e="horizontalFlip"===(e="rotateRight"===(e="rotateLeft"===e?"rotLeft":e)?"rotRight":e)?"hflip":e)?"vflip":e)?"start":e)?"end":e)&&(e="strokeColor",o=!0);for(var i=0;i<this.defToolbarItems.length;i++){var r=this.defToolbarItems[i].id;if(r&&-1!==r.toLowerCase().indexOf(e.toLowerCase())){t=i;break}}return o&&(e="fontColor"),t},L.prototype.getModuleName=function(){return"toolbar-module"},L.prototype.redactSlider=function(e){var t,o,i,r,n=this.parent,a=n.element.id,s=n.element.querySelector("#"+a+"_toolbarArea"),l=n.element.querySelector("#"+a+"_contextualToolbarArea");l&&(l.classList.remove("e-hide"),l.style.left=s.offsetLeft+"px",s=document.querySelector("#"+a+"_contextualToolbarArea"),t=document.querySelector("#"+a+"_headWrapper"),i=document.querySelector("#"+a+"_labelWrapper"),r=document.querySelector("#"+a+"_contextualToolbar"),t&&(t.remove(),i.remove()),r&&(r.remove(),this.createContextualToolbar()),i=(t=s.appendChild(n.createElement("div",{id:a+"_headWrapper",styles:"position: relative"}))).appendChild(n.createElement("label",{id:a+"_labelWrapper",className:"e-ie-finetune-slider-label",styles:T.Browser.isDevice?"position: absolute; top: 31%; left: calc(50% - 160px); font-size: 15px; text-transform: capitalize; font-weight: 400;":"position: absolute; top: 25%; left: calc(50% - 226px); font-size: 15px; text-transform: capitalize; font-weight: 400;"})),r="blur"===e?this.l10n.getConstant("Blur"):this.l10n.getConstant("PixelSize"),i.textContent=r,s=t.appendChild(n.createElement("div",{id:a+"_sliderWrapper",className:"e-ie-finetune-slider-wrap",styles:"position: absolute"})),t.appendChild(n.createElement("label",{id:a+"_redactSpan",className:"e-ie-redact-value-span",styles:T.Browser.isDevice?"position: absolute; top: 30%; margin-left: 20px; font-size: 15px; text-transform: capitalize; font-weight: 400;":"position: absolute; top: 30%; left: calc(50% + 190px); font-size: 15px; text-transform: capitalize; font-weight: 400;"})),s.parentElement.classList.add("e-finetune-slider"),o="blur"===n.activeObj.redactType?n.activeObj.redactBlur:n.activeObj.redactPixelate,new g.Slider({tooltip:{placement:"Before",isVisible:!0,showOn:"Focus"},min:10,max:100,step:1,value:o,type:"MinRange",width:T.Browser.isDevice?"130px":"300px",created:function(){n.element.querySelector(".e-ie-redact-value-span").innerText=o.toString()},change:function(e){n.element.querySelector(".e-ie-redact-value-span").innerText=e.value.toString(),"blur"===n.activeObj.redactType?n.activeObj.redactBlur=n.tempRedactBlur=e.value:"pixelate"===n.activeObj.redactType&&(n.activeObj.redactPixelate=n.tempRedactPixel=e.value),n.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:n.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:!0}})},changed:function(){setTimeout(function(){n.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})},50)}}).appendTo("#"+a+"_sliderWrapper"),T.Browser.isDevice)&&(e=l.offsetHeight+1,i=n.element.querySelector("#"+a+"_customizeWrapper"),this.isFrameToolbar&&i&&(e=i.offsetHeight+2),r=n.element.querySelector("#"+a+"_canvasWrapper").offsetHeight,l.style.top=this.toolbarHeight+1+r-e+"px")};var J=L;function L(e){this.defToolbarItems=[],this.toolbarHeight=46,this.currToolbar="",this.preventZoomBtn=!1,this.currentToolbar="main",this.selFhdColor="#42a5f5",this.preventEnableDisableUr=!1,this.isAspectRatio=!0,this.isFrameToolbar=!1,this.presetColors={custom:["#000000","#f44336","#e91e63","#9c27b0","#673ab7","#2196f3","#03a9f4","#00bcd4","#009688","#ffeb3b","#ffffff","#ffebee","#fce4ec","#f3e5f5","#ede7f6","#e3f2fd","#e1f5fe","#e0f7fa","#e0f2f1","#fffde7","#f2f2f2","#ffcdd2","#f8bbd0","#e1bee7","#d1c4e9","#bbdefb","#b3e5fc","#b2ebf2","#b2dfdb","#fff9c4","#e6e6e6","#ef9a9a","#f48fb1","#ce93d8","#b39ddb","#90caf9","#81d4fa","#80deea","#80cbc4","#fff59d","#cccccc","#e57373","#f06292","#ba68c8","#9575cd","#64b5f6","#4fc3f7","#4dd0e1","#4db6ac","#fff176","#b3b3b3","#ef5350","#ec407a","#ab47bc","#7e57c2","#42a5f5","#29b6f6","#26c6da","#26a69a","#ffee58","#999999","#e53935","#d81b60","#8e24aa","#5e35b1","#1e88e5","#039be5","#00acc1","#00897b","#fdd835","#808080","#d32f2f","#c2185b","#7b1fa2","#512da8","#1976d2","#0288d1","#0097a7","#00796b","#fbc02d","#666666","#c62828","#ad1457","#6a1b9a","#4527a0","#1565c0","#0277bd","#00838f","#00695c","#f9a825","#4d4d4d","#b71c1c","#880e4f","#4a148c","#311b92","#0d47a1","#01579b","#006064","#004d40","#f57f17"]},this.isSlider=!1,this.currentQuality=1,this.imageQuality="highest",this.parent=e,this.addEventListener(),this.initLocale()}m.Crop=o,m.Draw=i,m.Export=r,m.Filter=a,m.FinetuneSettings=N,m.FontFamily=V,m.FreehandDrawing=B,m.ImageEditor=y,m.Selection=H,m.SelectionSettings=Z,m.Shape=M,m.ToolbarModule=J,m.Transform=W,m.UndoRedo=U,m.UploadSettings=_,m.ZoomSettings=q,Object.defineProperty(m,"__esModule",{value:!0})});
//# sourceMappingURL=ej2-image-editor.umd.min.js.map
